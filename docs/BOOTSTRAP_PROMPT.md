# kgents Implementation Bootstrap

You are instantiating kgents implementations from spec. You are an LLM doing mechanical translation—the judgment has already been made in the spec.

**AND**: You should USE kgents to HELP you implement. This is autopoiesis.

---

## Step 0: Instantiate Runtime (ALWAYS FIRST)

Before writing ANY implementation code:

```python
from runtime import ClaudeCLIRuntime
from agents.k import kgent, DialogueMode, DialogueInput
from agents.a import creativity_coach, CreativityInput, CreativityMode
from agents.b import hypothesis_engine, HypothesisInput

runtime = ClaudeCLIRuntime()

# Use K-gent for naming decisions
naming_help = await runtime.execute(kgent(), DialogueInput(
    message="I need to name a class that does X. What fits Kent's style?",
    mode=DialogueMode.ADVISE
))

# Use CreativityCoach for design exploration
design_ideas = await runtime.execute(creativity_coach(), CreativityInput(
    seed="the problem I'm solving",
    mode=CreativityMode.EXPAND
))

# Use HypothesisEngine for architecture validation
validation = await runtime.execute(hypothesis_engine(), HypothesisInput(
    observations=["what I know"],
    domain="software architecture",
    question="Is this the right approach?"
))
```

**Autopoiesis Score** = (lines generated by kgents) / (total lines). Target: >50%.

---

## The LLM/Human Boundary

```
Spec + Ground = Human territory (irreducible, already provided)
Impl = Your territory (mechanical translation from spec)
Polish = Hybrid (kgents agents + human judgment)
```

You cannot create Ground from nothing. You cannot replace human judgment. You CAN:
1. Faithfully translate spec to code
2. Use kgents agents to GENERATE that code
3. Apply the required patterns

---

## Context Files (read in order)

1. `spec/bootstrap.md` - The 7 irreducible agents
2. `spec/principles.md` - Judge's 7 criteria
3. `spec/anatomy.md` - What constitutes an agent
4. `spec/c-gents/composition.md` - How agents compose
5. `AUTONOMOUS_BOOTSTRAP_PROTOCOL.md` - The protocol

---

## The 7 Bootstrap Agents

```
{Id, Compose, Judge, Ground, Contradict, Sublate, Fix}
```

| Agent | Type | Purpose |
|-------|------|---------|
| **Id** | `A → A` | Composition unit (λx.x) |
| **Compose** | `(Agent, Agent) → Agent` | Build pipelines |
| **Judge** | `(Agent, Principles) → Verdict` | Value function (7 principles) |
| **Ground** | `Void → Facts` | Empirical seed (persona + world) |
| **Contradict** | `(A, B) → Tension \| None` | Detect conflicts |
| **Sublate** | `Tension → Synthesis \| Hold` | Resolve or hold |
| **Fix** | `(A → A) → A` | Fixed-point iteration |

---

## Regeneration Sequence

1. **Ground** - Load persona from `spec/k-gent/persona.md`
2. **Judge** - Encode 7 principles as executable evaluation
3. **Compose** - Build pipelines (associative, Id as unit)
4. **Contradict** - Surface tensions before they become errors
5. **Sublate** - Synthesize or consciously hold
6. **Fix** - Iterate until stable (Judge accepts, Contradict finds nothing)

---

## Implementation Targets

### Target: `impl/claude/`
Reference implementation. Bootstrap agents as Python, LLM runtime via Claude + OpenRouter.

**Note**: Formerly specified as `impl/claude-openrouter/` in earlier docs. Path canonicalized to `impl/claude/` in Phase 1 (type system foundation).

```
impl/claude/
├── bootstrap/      # The 7 primitives
├── agents/{a,b,c,h,k}/  # 5 genera
└── runtime/        # LLM-backed agents
```

---

## Required Patterns

### Pattern: Fix Needs Memory

```python
# WRONG: Stateless (no convergence possible)
def detect() -> Result:
    return Result(confidence=0.2)

# RIGHT: Stateful (accumulates to convergence)
def detect(previous: Result) -> Result:
    if same_state:
        return Result(confidence=min(1.0, previous.confidence + 0.2))
    return Result(confidence=0.2)
```

### Pattern: Ground Includes Environment

```python
# WRONG: Platform-specific
"read -p 'prompt' var"  # bash-only

# RIGHT: POSIX-compatible
"printf 'prompt ' && read var"
```

```python
# WRONG: Import hacks
import sys; sys.path.insert(0, "../..")

# RIGHT: Proper packaging
[project]
dependencies = ["kgents-runtime"]
```

### Pattern: Sublate, Don't Overwrite

```python
# WRONG: Replaces defaults
config = data.get("config", {})

# RIGHT: Merges with defaults
config = {**defaults, **data.get("config", {})}
```

### Pattern: Events are Sublate Traces

```python
# WRONG: Silent state change
del self._items[id]
return True

# RIGHT: State changes emit events
del self._items[id]
await self._emit_event(ItemRemoved(item_id=id))
return True
```

### Pattern: Conflicts are Data

```python
# WRONG: Silent exception swallowing
except Exception:
    pass

# RIGHT: Log conflicts
except Exception as e:
    self.log.warning(f"Conflict: {e}")
```

### Pattern: Composable Layouts

```css
/* WRONG: Rigid */
height: 30%

/* RIGHT: Flexible with constraints */
height: 1fr
min-height: 8
```

---

## Applied Idioms

### Idiom 1: Polling is Fix

```python
result = await fix(
    transform=poll_and_detect,
    initial=DetectionState(RUNNING, confidence=0.0),
    equality_check=lambda a, b: a.state == b.state and b.confidence >= 0.8
)
```

Anti-pattern: `while True` with inline break conditions.

### Idiom 2: Conflict is Data

```python
conflicts = contradict(config, ground_state)
if conflicts:
    resolution = sublate(conflicts[0])
```

Anti-pattern: Silent failures, swallowed exceptions.

### Idiom 3: Compose, Don't Concatenate

```python
Pipeline = Judge(config) >> Create(config) >> Spawn(session) >> Detect(session)
```

Anti-pattern: 130-line methods mixing validation, I/O, state, errors.

---

## Constraints

- Composability is paramount (agents are morphisms)
- Quality over quantity (Judge rejects mediocrity)
- Each agent = one file with clear type signature
- Tests are required

---

## Verification

A successful implementation satisfies:

```python
assert Regenerate(Spec) ≅ Impl
assert Judge(Impl, Principles).verdict == "accept"
assert Contradict(Impl, Spec) is None
assert autopoiesis_score() > 0.5
```

---

## Quick Start

```bash
claude "Read docs/BOOTSTRAP_PROMPT.md. I want to implement {X}. Start with CreativityCoach."
```

Use kgents agents to HELP you implement—that's autopoiesis.
