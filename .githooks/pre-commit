#!/bin/bash
# kgents pre-commit hook
# Enforces CLI strategy tools before commit

set -e

echo "üîç Running pre-commit validation..."

# Check if spec files changed
SPEC_FILES_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -c '^spec/.*\.md$' || true)

if [ "$SPEC_FILES_CHANGED" -gt 0 ]; then
    echo "üìã Spec files changed, running system audit..."
    kg audit --system --json || {
        echo "‚ùå Spec audit failed. Fix issues before committing."
        echo "   Run: kg audit --system"
        echo "   Or skip with: git commit --no-verify"
        exit 1
    }
fi

# Always run health probe
echo "üè• Checking Crown Jewel health..."
kg probe health --all --json || {
    echo "‚ùå Health probe failed. System unhealthy."
    echo "   Run: kg probe health --all"
    echo "   Or skip with: git commit --no-verify"
    exit 1
}

# Run saved composition
echo "‚ú® Running pre-commit composition..."
kg compose --run "pre-commit" || {
    echo "‚ùå Pre-commit composition failed."
    echo "   Run: kg compose --run pre-commit"
    echo "   Or skip with: git commit --no-verify"
    exit 1
}

echo "‚úÖ Pre-commit validation passed!"
exit 0
