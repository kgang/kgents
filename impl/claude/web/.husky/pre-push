#!/bin/sh
# =============================================================================
# PRE-PUSH HOOK (Unified: Python + JS)
# =============================================================================
#
# Runs both:
#   1. Python checks (heavy tests) via scripts/hooks/pre-push
#   2. JS/TS checks (typecheck, unit tests, build) on web directory
#   3. E2E tests (optional, controlled by KGENTS_E2E_TESTS env var)
#
# Environment variables:
#   KGENTS_E2E_TESTS=1     - Run E2E Playwright tests (slower, requires browser)
#   KGENTS_SKIP_E2E=1      - Explicitly skip E2E tests even if KGENTS_E2E_TESTS is set
#   KGENTS_E2E_HEADLESS=1  - Run E2E tests in headless mode (default)
#
# =============================================================================

# Get repo root (using git to be reliable regardless of how hook is invoked)
REPO_ROOT="$(git rev-parse --show-toplevel)"

# -----------------------------------------------------------------------------
# 1. Run Python pre-push hook
# -----------------------------------------------------------------------------
PYTHON_HOOK="$REPO_ROOT/scripts/hooks/pre-push"
if [ -f "$PYTHON_HOOK" ]; then
    echo "=== Python checks ==="
    "$PYTHON_HOOK" "$@"
    PYTHON_EXIT=$?
    if [ $PYTHON_EXIT -ne 0 ]; then
        exit $PYTHON_EXIT
    fi
    echo ""
fi

# -----------------------------------------------------------------------------
# 2. Run JS/TS pre-push checks
# -----------------------------------------------------------------------------
echo "=== JS/TS checks ==="

# Change to web directory
cd "$REPO_ROOT/impl/claude/web" || exit 1

FAILED=0

# Type check
echo "TypeScript type check..."
npm run typecheck --silent
if [ $? -ne 0 ]; then
    echo "Type check failed."
    FAILED=1
else
    echo "Type check passed."
fi

# Unit tests
echo ""
echo "Unit tests..."
npm test -- --run --reporter=basic
if [ $? -ne 0 ]; then
    echo "Unit tests failed."
    FAILED=1
else
    echo "Unit tests passed."
fi

# Build (only if other checks pass)
if [ $FAILED -eq 0 ]; then
    echo ""
    echo "Build verification..."
    npm run build --silent
    if [ $? -ne 0 ]; then
        echo "Build failed."
        FAILED=1
    else
        echo "Build passed."
    fi
fi

# -----------------------------------------------------------------------------
# 3. E2E Tests (Optional - controlled by KGENTS_E2E_TESTS env var)
# -----------------------------------------------------------------------------
if [ "$KGENTS_E2E_TESTS" = "1" ] && [ "$KGENTS_SKIP_E2E" != "1" ] && [ $FAILED -eq 0 ]; then
    echo ""
    echo "=== E2E Tests (Playwright) ==="

    # Check if Playwright browsers are installed
    if ! npx playwright --version > /dev/null 2>&1; then
        echo "Playwright not found. Skipping E2E tests."
        echo "Run 'npx playwright install' to enable E2E tests."
    else
        # Quick check for browser installation (chromium)
        CHROMIUM_PATH=$(npx playwright show 2>/dev/null | grep chromium | head -1 || true)
        if [ -z "$CHROMIUM_PATH" ]; then
            echo "Playwright browsers not installed. Skipping E2E tests."
            echo "Run 'npx playwright install chromium' to enable E2E tests."
        else
            echo "Running E2E tests..."
            # Run Playwright tests (headless by default)
            npx playwright test --reporter=list
            if [ $? -ne 0 ]; then
                echo "E2E tests failed."
                FAILED=1
            else
                echo "E2E tests passed."
            fi
        fi
    fi
elif [ "$KGENTS_E2E_TESTS" = "1" ] && [ "$KGENTS_SKIP_E2E" = "1" ]; then
    echo ""
    echo "E2E tests skipped (KGENTS_SKIP_E2E=1)"
elif [ "$KGENTS_E2E_TESTS" != "1" ]; then
    echo ""
    echo "E2E tests skipped (set KGENTS_E2E_TESTS=1 to enable)"
fi

# -----------------------------------------------------------------------------
# Summary
# -----------------------------------------------------------------------------
if [ $FAILED -ne 0 ]; then
    echo ""
    echo "JS/TS pre-push checks failed."
    echo "To bypass (not recommended): git push --no-verify"
    exit 1
fi

echo ""
echo "All checks passed."
