#!/bin/sh
# =============================================================================
# PRE-PUSH HOOK (Unified: Python + JS)
# =============================================================================
#
# Runs both:
#   1. Python checks (heavy tests) via scripts/hooks/pre-push
#   2. JS/TS checks (typecheck, tests, build) on web directory
#
# =============================================================================

# Get repo root (using git to be reliable regardless of how hook is invoked)
REPO_ROOT="$(git rev-parse --show-toplevel)"

# -----------------------------------------------------------------------------
# 1. Run Python pre-push hook
# -----------------------------------------------------------------------------
PYTHON_HOOK="$REPO_ROOT/scripts/hooks/pre-push"
if [ -f "$PYTHON_HOOK" ]; then
    echo "=== Python checks ==="
    "$PYTHON_HOOK" "$@"
    PYTHON_EXIT=$?
    if [ $PYTHON_EXIT -ne 0 ]; then
        exit $PYTHON_EXIT
    fi
    echo ""
fi

# -----------------------------------------------------------------------------
# 2. Run JS/TS pre-push checks
# -----------------------------------------------------------------------------
echo "=== JS/TS checks ==="

# Change to web directory
cd "$REPO_ROOT/impl/claude/web" || exit 1

FAILED=0

# Type check
echo "TypeScript type check..."
npm run typecheck --silent
if [ $? -ne 0 ]; then
    echo "Type check failed."
    FAILED=1
else
    echo "Type check passed."
fi

# Unit tests
echo ""
echo "Unit tests..."
npm test -- --run --reporter=basic
if [ $? -ne 0 ]; then
    echo "Unit tests failed."
    FAILED=1
else
    echo "Unit tests passed."
fi

# Build (only if other checks pass)
if [ $FAILED -eq 0 ]; then
    echo ""
    echo "Build verification..."
    npm run build --silent
    if [ $? -ne 0 ]; then
        echo "Build failed."
        FAILED=1
    else
        echo "Build passed."
    fi
fi

if [ $FAILED -ne 0 ]; then
    echo ""
    echo "JS/TS pre-push checks failed."
    echo "To bypass (not recommended): git push --no-verify"
    exit 1
fi

echo ""
echo "All checks passed."
