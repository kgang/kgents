#!/bin/sh
# =============================================================================
# PRE-PUSH HOOK (Unified: Python + JS) - PARALLEL OPTIMIZED
# =============================================================================
#
# Architecture: Heterarchical parallel execution with proper error aggregation.
# Philosophy: Resources flow where needed, not allocated top-down.
#
# Performance optimizations:
#   1. Python and JS/TS tracks run in PARALLEL (2-4x speedup)
#   2. Intelligent build skipping (only build if src/ changed)
#   3. Fail-fast within tracks, aggregate across tracks
#   4. Proper cleanup and signal handling
#
# Runs:
#   [PARALLEL]
#   ├── Python Track: Ruff → Mypy → Pytest
#   └── JS/TS Track:  TypeCheck → Tests → Build (conditional)
#
# Environment variables:
#   KGENTS_E2E_TESTS=1       - Run E2E Playwright tests
#   KGENTS_SKIP_E2E=1        - Skip E2E tests
#   KGENTS_SKIP_BUILD=1      - Skip build verification
#   KGENTS_SEQUENTIAL=1      - Force sequential execution (debugging)
#   KGENTS_SKIP_HEAVY=1      - Skip Python heavy checks entirely
#
# =============================================================================

set -e

# Get repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Temp files for parallel execution output
PYTHON_LOG=$(mktemp)
JS_LOG=$(mktemp)

# Cleanup function
cleanup() {
    rm -f "$PYTHON_LOG" "$JS_LOG" 2>/dev/null || true
    # Kill any background processes we started
    jobs -p 2>/dev/null | xargs -r kill 2>/dev/null || true
}
trap cleanup EXIT INT TERM

# -----------------------------------------------------------------------------
# Helper: Print with timestamp
# -----------------------------------------------------------------------------
log() {
    echo "[$(date +%H:%M:%S)] $1"
}

log_track() {
    local track="$1"
    local msg="$2"
    local color="$3"
    echo -e "${color}[${track}]${NC} ${msg}"
}

# -----------------------------------------------------------------------------
# Detect what files changed (for intelligent skipping)
# -----------------------------------------------------------------------------
get_changed_files() {
    # Get files changed compared to what we're pushing to
    local base_branch="${1:-origin/main}"
    git diff --name-only "$base_branch" HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD 2>/dev/null || echo ""
}

has_python_changes() {
    local changed="$1"
    echo "$changed" | grep -qE '\.(py)$' || echo "$changed" | grep -qE '^impl/claude/'
}

has_frontend_changes() {
    local changed="$1"
    echo "$changed" | grep -qE '^impl/claude/web/' || echo "$changed" | grep -qE '\.(ts|tsx|js|jsx)$'
}

has_src_changes() {
    local changed="$1"
    echo "$changed" | grep -qE '^impl/claude/web/src/'
}

# -----------------------------------------------------------------------------
# Python Track (runs in background)
# -----------------------------------------------------------------------------
run_python_track() {
    local log_file="$1"
    local exit_code=0

    {
        echo "=== Python Track Started ==="

        PYTHON_HOOK="$REPO_ROOT/scripts/hooks/pre-push"
        if [ -f "$PYTHON_HOOK" ]; then
            if "$PYTHON_HOOK" "$@"; then
                echo "=== Python Track PASSED ==="
            else
                echo "=== Python Track FAILED ==="
                exit_code=1
            fi
        else
            echo "Python hook not found: $PYTHON_HOOK"
            exit_code=1
        fi

        exit $exit_code
    } > "$log_file" 2>&1

    return $?
}

# -----------------------------------------------------------------------------
# JS/TS Track (runs in background)
# -----------------------------------------------------------------------------
run_js_track() {
    local log_file="$1"
    local skip_build="$2"
    local exit_code=0

    {
        echo "=== JS/TS Track Started ==="

        cd "$REPO_ROOT/impl/claude/web" || exit 1

        # Type check
        echo "[1/3] TypeScript type check..."
        if npm run typecheck --silent 2>&1; then
            echo "✓ TypeScript passed"
        else
            echo "✗ TypeScript failed"
            exit 1
        fi

        # Unit tests
        echo "[2/3] Unit tests..."
        if npm test -- --run --reporter=basic 2>&1; then
            echo "✓ Unit tests passed"
        else
            echo "✗ Unit tests failed"
            exit 1
        fi

        # Build (conditional)
        if [ "$skip_build" = "1" ]; then
            echo "[3/3] Build skipped (no src/ changes)"
        else
            echo "[3/3] Build verification..."
            if npm run build --silent 2>&1; then
                echo "✓ Build passed"
            else
                echo "✗ Build failed"
                exit 1
            fi
        fi

        # E2E tests (optional)
        if [ "$KGENTS_E2E_TESTS" = "1" ] && [ "$KGENTS_SKIP_E2E" != "1" ]; then
            echo "[E2E] Running Playwright tests..."
            if npx playwright test --reporter=list 2>&1; then
                echo "✓ E2E tests passed"
            else
                echo "✗ E2E tests failed"
                exit 1
            fi
        fi

        echo "=== JS/TS Track PASSED ==="

    } > "$log_file" 2>&1

    return $?
}

# -----------------------------------------------------------------------------
# Main Execution
# -----------------------------------------------------------------------------
echo -e "${BOLD}pre-push${NC} ${CYAN}(parallel verification)${NC}"
echo ""

# Detect changed files for intelligent skipping
CHANGED_FILES=$(get_changed_files)

# Determine if we should skip build
SKIP_BUILD=0
if [ "$KGENTS_SKIP_BUILD" = "1" ]; then
    SKIP_BUILD=1
elif ! has_src_changes "$CHANGED_FILES"; then
    SKIP_BUILD=1
    log_track "BUILD" "Skipping (no src/ changes detected)" "$YELLOW"
fi

# Check for skip flags
if [ "${KGENTS_SKIP_HEAVY:-0}" = "1" ]; then
    log_track "PYTHON" "Skipping heavy checks (KGENTS_SKIP_HEAVY=1)" "$YELLOW"
    SKIP_PYTHON=1
else
    SKIP_PYTHON=0
fi

# -----------------------------------------------------------------------------
# Sequential mode (for debugging)
# -----------------------------------------------------------------------------
if [ "${KGENTS_SEQUENTIAL:-0}" = "1" ]; then
    echo -e "${YELLOW}Running in sequential mode (KGENTS_SEQUENTIAL=1)${NC}"
    echo ""

    if [ "$SKIP_PYTHON" != "1" ]; then
        echo "=== Python Track ==="
        PYTHON_HOOK="$REPO_ROOT/scripts/hooks/pre-push"
        if [ -f "$PYTHON_HOOK" ]; then
            "$PYTHON_HOOK" "$@" || exit 1
        fi
    fi

    echo ""
    echo "=== JS/TS Track ==="
    cd "$REPO_ROOT/impl/claude/web" || exit 1
    npm run typecheck --silent || exit 1
    npm test -- --run --reporter=basic || exit 1
    [ "$SKIP_BUILD" != "1" ] && npm run build --silent || true

    echo ""
    echo -e "${GREEN}${BOLD}All checks passed!${NC}"
    exit 0
fi

# -----------------------------------------------------------------------------
# Parallel execution
# -----------------------------------------------------------------------------
PYTHON_PID=""
JS_PID=""
PYTHON_EXIT=0
JS_EXIT=0

# Start Python track in background (if not skipped)
if [ "$SKIP_PYTHON" != "1" ]; then
    log_track "PYTHON" "Starting..." "$CYAN"
    run_python_track "$PYTHON_LOG" "$@" &
    PYTHON_PID=$!
else
    echo "PYTHON SKIPPED" > "$PYTHON_LOG"
fi

# Start JS/TS track in background
log_track "JS/TS" "Starting..." "$CYAN"
run_js_track "$JS_LOG" "$SKIP_BUILD" &
JS_PID=$!

# Wait for both tracks
echo ""
log "Waiting for parallel tracks..."
echo ""

# Wait for Python track
if [ -n "$PYTHON_PID" ]; then
    wait $PYTHON_PID 2>/dev/null || PYTHON_EXIT=$?
fi

# Wait for JS track
if [ -n "$JS_PID" ]; then
    wait $JS_PID 2>/dev/null || JS_EXIT=$?
fi

# -----------------------------------------------------------------------------
# Report results
# -----------------------------------------------------------------------------
echo "═══════════════════════════════════════════════════════════════════"
echo ""

# Python results
if [ "$SKIP_PYTHON" != "1" ]; then
    if [ $PYTHON_EXIT -eq 0 ]; then
        log_track "PYTHON" "${GREEN}PASSED${NC}" "$GREEN"
    else
        log_track "PYTHON" "${RED}FAILED${NC}" "$RED"
        echo ""
        echo "--- Python Track Output ---"
        cat "$PYTHON_LOG"
        echo "--- End Python Track ---"
        echo ""
    fi
else
    log_track "PYTHON" "${YELLOW}SKIPPED${NC}" "$YELLOW"
fi

# JS results
if [ $JS_EXIT -eq 0 ]; then
    log_track "JS/TS" "${GREEN}PASSED${NC}" "$GREEN"
else
    log_track "JS/TS" "${RED}FAILED${NC}" "$RED"
    echo ""
    echo "--- JS/TS Track Output ---"
    cat "$JS_LOG"
    echo "--- End JS/TS Track ---"
    echo ""
fi

echo ""
echo "═══════════════════════════════════════════════════════════════════"

# Final verdict
if [ $PYTHON_EXIT -ne 0 ] || [ $JS_EXIT -ne 0 ]; then
    echo -e "${RED}${BOLD}pre-push FAILED${NC}"
    echo ""
    echo "To bypass (not recommended): git push --no-verify"
    echo "To debug: KGENTS_SEQUENTIAL=1 git push"
    exit 1
fi

echo -e "${GREEN}${BOLD}pre-push PASSED${NC}"
exit 0
