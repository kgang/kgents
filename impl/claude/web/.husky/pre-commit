#!/bin/sh
# =============================================================================
# PRE-COMMIT HOOK (Unified: Python + JS)
# =============================================================================
#
# Runs both:
#   1. Python checks (ruff, mypy) via scripts/hooks/pre-commit
#   2. JS/TS checks (eslint, prettier) via lint-staged
#
# =============================================================================

# Get repo root (using git to be reliable regardless of how hook is invoked)
REPO_ROOT="$(git rev-parse --show-toplevel)"

# -----------------------------------------------------------------------------
# 1. Run Python pre-commit hook
# -----------------------------------------------------------------------------
PYTHON_HOOK="$REPO_ROOT/scripts/hooks/pre-commit"
if [ -f "$PYTHON_HOOK" ]; then
    echo "=== Python checks ==="
    "$PYTHON_HOOK"
    PYTHON_EXIT=$?
    if [ $PYTHON_EXIT -ne 0 ]; then
        exit $PYTHON_EXIT
    fi
    echo ""
fi

# -----------------------------------------------------------------------------
# 2. Run JS/TS pre-commit hook (lint-staged)
# -----------------------------------------------------------------------------
# Check if there are any staged web files
STAGED_WEB=$(git diff --cached --name-only --diff-filter=ACMR | grep "^impl/claude/web/" || true)

if [ -z "$STAGED_WEB" ]; then
    echo "=== JS/TS checks ==="
    echo "No web files staged. Skipping."
    exit 0
fi

echo "=== JS/TS checks ==="

# Change to web directory
cd "$REPO_ROOT/impl/claude/web" || exit 1

# Run lint-staged
npx lint-staged --concurrent false

if [ $? -ne 0 ]; then
    echo ""
    echo "JS/TS checks failed."
    echo "To bypass (not recommended): git commit --no-verify"
    exit 1
fi

echo "JS/TS checks passed."
