{/* @jsxImportSource react */}
import { Meta, Canvas, Story, Source } from '@storybook/blocks';

<Meta title="Journeys/4. Meta Reflection - Watching Yourself Grow" />

# Journey 4: Meta Reflection

> "Marks are observations. Crystals are insights."

The Meta Reflection journey is about stepping back—watching your coherence
evolve over time, seeing patterns emerge, and understanding your own growth.

## Philosophy

Most productivity tools show you what you did. kgents shows you **who you're becoming**.

Meta reflection transforms raw witness marks into compressed insights (crystals),
then visualizes coherence over time. This is Journey 5 from the roadmap:
the moment you watch yourself watching yourself.

---

## The Crystal Hierarchy

Experience crystallizes at multiple temporal scales:

```
SESSION → DAY → WEEK → EPOCH
   ↓        ↓       ↓       ↓
Minutes   Hours   Days   Months
```

### SESSION Crystals (L0)

Created from marks within a single session:

```typescript
{
  level: 'SESSION',
  insight: "Focused deeply on contradiction resolution primitives",
  significance: "First coherent design for surfacing tensions",
  confidence: 0.85,
  sourceMarkIds: ['m1', 'm2', 'm3', ...],
  compressionRatio: 12.5  // 12.5 marks compressed to 1 crystal
}
```

**Trigger**: `:crystallize` command in Hypergraph Editor

### DAY Crystals (L1)

Created from session crystals within 24 hours:

```typescript
{
  level: 'DAY',
  insight: "Progressed on three fronts: UI, API, and philosophy",
  significance: "Integration day—connecting pieces that were separate",
  sourceCrystalIds: ['c1', 'c2', 'c3'],
  compressionRatio: 3.0  // 3 session crystals → 1 day crystal
}
```

**Trigger**: Automatic at end of day (or manual)

### WEEK Crystals (L2)

Created from day crystals over a week:

```typescript
{
  level: 'WEEK',
  insight: "Theme emerged: making the implicit explicit",
  significance: "Constitutional primitives are the through-line",
  sourceCrystalIds: ['d1', 'd2', 'd3', 'd4', 'd5'],
}
```

**Trigger**: Weekly review session

### EPOCH Crystals (L3)

Major insights spanning months or project phases:

```typescript
{
  level: 'EPOCH',
  insight: "The categorical foundation was worth the investment",
  significance: "PolyAgent + Operad + Sheaf enables everything else",
  periodStart: '2025-09-01',
  periodEnd: '2025-12-25',
}
```

**Trigger**: Major milestones or retrospectives

---

## The Crystal Primitives

### MoodIndicator

7-dimensional affective signature visualization:

```tsx
import { MoodIndicator } from '@/primitives/Crystal';

<MoodIndicator
  mood={{
    warmth: 0.7,      // Cold/clinical ↔ Warm/engaging
    weight: 0.4,      // Light/playful ↔ Heavy/serious
    tempo: 0.8,       // Slow/deliberate ↔ Fast/urgent
    texture: 0.3,     // Smooth/flowing ↔ Rough/struggling
    brightness: 0.9,  // Dim/frustrated ↔ Bright/joyful
    saturation: 0.6,  // Muted/routine ↔ Vivid/intense
    complexity: 0.5,  // Simple/focused ↔ Complex/branching
  }}
  variant="dots"
  size="medium"
/>
```

**Design Notes**:
- Dots variant: 7 colored dots in a row
- Bars variant: 7 horizontal bars
- Color intensity maps to dimension value

### CrystalCard

Single crystal display with expandable details:

```tsx
import { CrystalCard } from '@/primitives/Crystal';

<CrystalCard
  crystal={{
    id: 'c123',
    level: 'SESSION',
    insight: "Contradiction primitives reached design coherence",
    significance: "First complete primitive family",
    confidence: 0.85,
    mood: { ... },
    sourceMarkIds: ['m1', 'm2', ...],
    principles: ['composable', 'generative'],
    topics: ['ui', 'primitives', 'contradiction'],
    crystallizedAt: '2025-12-25T14:30:00Z',
  }}
  expandable={true}
  onExpand={(crystal) => showDetails(crystal)}
/>
```

**Design Notes**:
- Level badge (SESSION/DAY/WEEK/EPOCH) with tier colors
- Insight as primary content
- Significance as secondary
- Confidence ring (circular progress)
- Expand reveals: principles, topics, mood, sources

### CrystalHierarchy

Full hierarchy visualization:

```tsx
import { CrystalHierarchy } from '@/primitives/Crystal';

<CrystalHierarchy
  crystals={allCrystals}
  onCrystalSelect={(crystal) => navigateTo(crystal)}
  initialCollapsed={['SESSION']}  // Start with sessions collapsed
  variant="timeline"
/>
```

**Variants**:
- `timeline`: Chronological with level grouping
- `tree`: Hierarchical with parent-child links

---

## Coherence Timeline

The `CoherenceTimeline` component visualizes coherence evolution:

```tsx
import { CoherenceTimeline } from '@/primitives/Meta';

<CoherenceTimeline
  points={[
    {
      timestamp: new Date('2024-12-01'),
      score: 0.65,
      commitId: 'abc123f',
      layerDistribution: { 0: 10, 1: 5, 2: 2 },
    },
    {
      timestamp: new Date('2024-12-15'),
      score: 0.82,
      commitId: 'def456a',
      breakthrough: true,  // Significant jump detected
      layerDistribution: { 0: 8, 1: 7, 2: 3, 3: 1 },
    },
    // ... more points
  ]}
  width={800}
  height={400}
/>
```

### Features

**Line Graph**: SVG-based timeline showing coherence score (0-1) over time

**Breakthrough Detection**:
- Auto-detected when score jumps > 2x average delta
- Marked with trophy badge icon
- Amber glow for emphasis

**Layer Distribution**:
- Pie chart view showing K-Block distribution by layer
- Click to toggle between timeline and distribution

**Export**:
- Export MD: Markdown report with summary
- Export SVG: Current view as vector graphic

---

## STARK BIOME Aesthetics

### Crystal Colors by Level

| Level | Color | CSS Variable |
|-------|-------|--------------|
| SESSION | Steel-300 | `--color-steel-300` |
| DAY | Life-sage | `--color-life-sage` |
| WEEK | Glow-lichen | `--color-glow-lichen` |
| EPOCH | Glow-amber | `--color-glow-amber` |

### Timeline Colors

- Line: `--color-life-sage` (moss/sage green)
- Normal points: `--color-life-sage`
- Breakthrough points: `--color-glow-amber` (earned glow!)
- Grid: `--surface-3`
- Tooltip: `--surface-2` with `--color-glow-spore` border

### Animation

- Breakthrough badges: 4-7-8 breathing pulse
- Hover states: `--transition-fast` (120ms)
- Tooltip: Gentle ease-out appearance

---

## The Crystal Laws

1. **Mark Immutability**: Marks are never deleted—crystals are a lens
2. **Provenance Chain**: Every crystal references its sources
3. **Level Consistency**: Level N crystals only source from level N-1
4. **Temporal Containment**: Crystal time_range contains all sources
5. **Compression Monotonicity**: Higher levels are always denser

---

## Creating Crystals

### Via Hypergraph Editor

```
:crystallize "Completed the UI primitive consolidation"
```

Creates a SESSION crystal from current session marks.

### Via CLI

```bash
# Crystallize current session
kg witness crystallize --session

# Crystallize with notes
kg witness crystallize --notes "Major refactor complete"

# Day-level crystallization (from session crystals)
kg witness crystallize --day

# Week-level crystallization
kg witness crystallize --week
```

### Automatic Crystallization

The system can auto-crystallize based on:
- Session end detection
- Mark count threshold
- Time elapsed
- Coherence change threshold

---

## The Meta View

The Meta page (`/meta`) provides the full reflection interface:

```tsx
// MetaPage.tsx structure
<MetaPage>
  <CoherenceTimeline points={coherenceHistory} />

  <CrystalHierarchy
    crystals={allCrystals}
    onCrystalSelect={navigateToCrystal}
  />

  <ConstitutionalRadar
    scores={currentScores}
    interactive={true}
  />
</MetaPage>
```

### Key Insights Available

1. **Coherence Trend**: Is coherence improving over time?
2. **Breakthrough Moments**: When did major jumps occur?
3. **Layer Balance**: Are you building at all levels?
4. **Principle Alignment**: Which principles are strongest/weakest?
5. **Mood Patterns**: What's your typical working state?

---

## Constitutional Integration

Crystals are tagged with constitutional principles:

```typescript
{
  insight: "Categorical foundation enables everything",
  principles: ['composable', 'generative', 'heterarchical'],
}
```

The ConstitutionalRadar shows aggregate alignment:

```tsx
<ConstitutionalRadar
  scores={{
    tasteful: 0.85,
    curated: 0.90,
    ethical: 0.95,
    joyInducing: 0.75,
    composable: 0.92,
    heterarchical: 0.80,
    generative: 0.88,
  }}
  interactive={true}
  onPrincipleClick={(p) => filterByPrinciple(p)}
/>
```

---

## The Deeper Meaning

Meta reflection closes the loop:

```
Action → Mark → Crystal → Insight → Action
```

This is not just analytics—it's **self-knowledge**:

1. **See your patterns**: What do you focus on? What do you avoid?
2. **Recognize growth**: Coherence improving = genuine development
3. **Identify gaps**: Which principles need attention?
4. **Celebrate breakthroughs**: Major jumps deserve recognition

---

## Example: A Week of Reflection

```
Monday:
  - 15 marks created
  - Session crystal: "Setup and scaffolding"
  - Mood: {warmth: 0.5, tempo: 0.9} — rushed but neutral

Tuesday-Thursday:
  - 42 marks created
  - 3 session crystals → 1 day crystal
  - Day insight: "Deep implementation work"
  - Mood: {weight: 0.7, brightness: 0.8} — serious but bright

Friday:
  - 8 marks created
  - Session crystal: "Integration and polish"
  - Coherence jumped from 0.72 to 0.85 (BREAKTHROUGH!)

Week Crystal:
  insight: "The frame is humble. The content glows."
  significance: "STARK BIOME aesthetic fully realized"
  principles: ['tasteful', 'joy-inducing']
```

---

## Future Enhancements

From the Meta README:
- Zoom/pan for long timelines
- Brush selection for time ranges
- Click point to navigate to commit
- Layer distribution stacked area chart
- Comparison mode (two timelines)
- Crystal graph visualization (provenance DAG)

---

*"The unexamined agent is not worth deploying."*

Watch yourself grow. See the patterns. Celebrate the breakthroughs.
