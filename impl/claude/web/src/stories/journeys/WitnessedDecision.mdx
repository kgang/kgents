{/* @jsxImportSource react */}
import { Meta, Canvas, Story, Source } from '@storybook/blocks';

<Meta title="Journeys/2. Witnessed Decision - Making Marks" />

# Journey 2: Witnessed Decision

> "The proof IS the decision. The mark IS the witness."

The Witnessed Decision journey covers how users create marks—atomic units
of witnessed experience that accumulate into trust and coherence.

## Philosophy

Traditional systems capture data. kgents captures **decisions**.

A mark is not a log entry. It is a witnessed moment where:
- An action was taken
- A reason was recorded
- The system observed

This creates an **evidence trail** that transforms reflexes into agency.

---

## What is a Mark?

A mark is the fundamental unit of witnessed experience:

```typescript
interface WitnessMark {
  id: string;
  action: string;           // What happened
  reasoning?: string;       // Why it happened
  timestamp: string;        // When it happened
  context?: MarkContext;    // Session, location, etc.
  confidence: number;       // How certain (0-1)
  tags?: string[];          // Constitutional principles
}
```

**Key Properties**:
- **Immutable**: Once witnessed, marks cannot be altered
- **Causal**: Marks can reference other marks (provenance)
- **Constitutional**: Marks are tagged with relevant principles

---

## Creating Marks

### CLI Interface (`kg decide`)

The primary way to create marks is through the CLI:

```bash
# Quick decision (fast mode)
kg decide --fast "Use PostgreSQL" --reasoning "Team familiar, good ecosystem"

# Full dialectic (Kent vs Claude disagreement)
kg decide \
  --kent "Use LangChain" --kent-reasoning "Scale, resources, production" \
  --claude "Build kgents" --claude-reasoning "Novel contribution, joy" \
  --synthesis "Build minimal kernel, validate, then decide" \
  --why "Avoids both risks: philosophy without validation AND untested abandon"
```

### Hypergraph Editor (`:w` command)

From within the editor, type `:w` to create a mark:

```
:w "Completed the extinction audit"
```

This creates a session-scoped mark with automatic context.

---

## The Witness Primitive

The `Witness` component displays evidence with confidence tiers:

```tsx
import { Witness } from '@/primitives/Witness';

// Confident tier (green): P > 0.80
// Uncertain tier (yellow): P 0.50-0.80
// Speculative tier (red): P < 0.50

<Witness
  evidence={{
    tier: 'confident',
    items: [
      {
        id: 'e1',
        content: 'PostgreSQL decision recorded',
        confidence: 0.95,
        source: 'CLI',
      },
    ],
    causalGraph: [],
  }}
  showCausal={false}
/>
```

**Design Principles**:
- Tier colors match health indicators (green/yellow/red)
- High-influence causal edges get breathing animation
- Compact mode shows just badge + count

---

## Trust Accumulation

Marks don't just record—they accumulate into trust:

```
Session Marks → Session Trust Score
       ↓
Daily Crystals → Weekly Coherence
       ↓
Constitutional Alignment
```

### The Trust Formula

```typescript
// Simplified trust calculation
const trustScore = marks.reduce((trust, mark) => {
  const weight = mark.confidence * getConstitutionalAlignment(mark.tags);
  return trust + weight;
}, 0) / marks.length;
```

Trust is earned through:
1. **Consistency**: Making marks regularly
2. **Reasoning**: Providing justifications
3. **Alignment**: Tagging with constitutional principles

---

## The `kg decide` Flow

### Step 1: Topic Identification

The user identifies what needs deciding:
- Architectural choice
- Design trade-off
- Implementation direction

### Step 2: Capture Perspectives

For significant decisions, capture the dialectic:

| Perspective | Question |
|-------------|----------|
| Kent's View | What does Kent think? Why? |
| Claude's View | What does Claude suggest? Why? |
| Synthesis | What's the resolution? |
| Why | Why this synthesis over alternatives? |

### Step 3: Witness and Store

The decision is:
1. Validated against schema
2. Stored in witness store
3. Tagged with principles
4. Available for crystal compression

---

## Component Architecture

```
WitnessEvent.tsx        — Single mark display
    |
WitnessTrail.tsx        — Chronological mark history
    |
WitnessMark.tsx         — Interactive mark component
    |
WithWitness.tsx         — HOC for adding witness overlay
```

### Key Files

- `primitives/Witness/Witness.tsx` — Evidence display
- `primitives/Witness/WitnessTrail.tsx` — Trail visualization
- `services/witness/mark.py` — Backend mark service
- `services/witness/store.py` — Mark persistence

---

## STARK BIOME Aesthetics

The Witness components follow the biome rules:

**Steel Foundation**:
- Background: `--surface-1`
- Borders: `--surface-3`
- Text: `--text-secondary`

**Earned Glow**:
- Confident tier: `--health-healthy` (green border)
- High-influence edges: Breathing animation
- Click interactions: Subtle scale transform

**Typography**:
- Evidence content: `--font-mono`
- Confidence scores: `P=0.95` format

---

## Constitutional Alignment

Each mark can be tagged with constitutional principles:

| Principle | When to Tag |
|-----------|-------------|
| Tasteful | Decision about scope/focus |
| Curated | Decision about inclusion/exclusion |
| Ethical | Decision about user impact |
| Joy-Inducing | Decision about UX/personality |
| Composable | Decision about architecture |
| Heterarchical | Decision about power dynamics |
| Generative | Decision about spec vs impl |

Tags influence:
- Crystal compression (grouped by principle)
- Trust scoring (aligned decisions score higher)
- Meta reflection (coherence over time)

---

## Example: Full Decision Flow

```bash
# 1. User considers database choice
kg decide

# 2. Interactive prompts
Topic: Database for witness storage
Kent's View: Use SQLite (simple, embedded)
Kent's Reasoning: Local-first, no ops overhead
Claude's View: Use PostgreSQL (scalable)
Claude's Reasoning: Better for concurrent access, JSON support
Synthesis: Start SQLite, migrate path to Postgres
Why: Local-first development speed, production-ready migration

# 3. Mark created
{
  "id": "mark_abc123",
  "action": "Decided: Database for witness storage",
  "reasoning": "Start SQLite, migrate path to Postgres...",
  "timestamp": "2025-12-25T10:30:00Z",
  "confidence": 0.9,
  "tags": ["composable", "generative"]
}

# 4. Mark visible in session trail
kg witness show --today
```

---

## Integration with Crystals

Marks are the raw material for crystals:

```
Marks (many, atomic)
    ↓ crystallize
Crystals (few, compressed)
```

The crystallization process:
1. Groups marks by session/day/week
2. Extracts semantic patterns
3. Derives mood vector from mark emotions
4. Creates compressed insight

See Journey 4 (Meta Reflection) for the full crystal hierarchy.

---

## The Deeper Meaning

Witnessed decisions transform how we work:

1. **Reflexes become agency**: Writing down "why" forces clarity
2. **Trust is earned**: Each mark contributes to coherence
3. **History is navigable**: Decisions can be traced and reviewed
4. **Synthesis is valued**: Dialectic resolution is captured, not lost

---

*"Decisions without traces are reflexes. Decisions with traces are agency."*

The mark is the witness. The witness is the proof.
