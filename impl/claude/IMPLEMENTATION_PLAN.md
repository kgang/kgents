# Implementation Plan for 10 Critical Fixes

Generated by kgents HypothesisEngine on 2025-12-08

## Executive Summary

**Confidence:** 72% for main strategy
**Approach:** 4-5 phase dependency-driven implementation
**Duration Estimate:** 3-4 weeks for critical path, 6-8 weeks for complete

---

## Phase 0: Security Hotfix (Immediate)

**Issue #9: Parallel Resource Limits (parallel.py)**
- **Priority:** CRITICAL - DoS vulnerability
- **Impact:** Security
- **Dependencies:** None
- **Breaking:** No
- **Effort:** 4-8 hours

### Implementation:
```python
# Add to parallel.py
@dataclass
class ParallelConfig:
    max_concurrent: int = 10
    timeout_per_agent: float = 30.0
    semaphore: Optional[asyncio.Semaphore] = None
```

### Test:
Deploy to staging, attempt resource exhaustion attack

---

## Phase 1: Type System Foundation (Week 1)

**Must go first - affects all composition**

### Issue #1: Fix Type Signature (types.py)
```python
# BEFORE
class Fix(Generic[A, B], Agent[A, B])

# AFTER
class Fix(Generic[A], Agent[A, A])  # Fixed points map A → A
```
- **Effort:** 2-4 hours
- **Breaking:** Potentially - audit all Fix usages
- **Test:** Type checker + Fix pattern tests

### Issue #2: FixComposedAgent Signature (compose.py)
```python
# BEFORE
class FixComposedAgent(Agent[A, C])

# AFTER
class FixComposedAgent(Agent[A, B])  # Composition law compliance
```
- **Effort:** 2-4 hours
- **Breaking:** No (internal type only)
- **Test:** Composition law property tests

---

## Phase 2: Architecture Refactors (Week 2-3, Parallel)

**Can proceed after Phase 1, in parallel**

### Issue #5: EvolutionAgent Composition (evolution.py)
- **Goal:** Decompose into composable morphisms
- **Effort:** 16-24 hours
- **Breaking:** Possibly
- **Dependencies:** Phase 1 complete

```python
# Current: Orchestration
class EvolutionAgent:
    def invoke(self, input):
        # lots of orchestration logic

# Target: Composition
confidence_tracker = ConfidenceTracker()
detector = ContradictionDetector()
applier = ChangeApplier()

evolution = confidence_tracker >> detector >> applier
```

### Issue #10: Contradict Protocol Pattern (contradict.py)
- **Goal:** Extract strategy pattern for extensibility
- **Effort:** 8-12 hours
- **Breaking:** No (additive)

```python
class TensionDetector(Protocol[A, B]):
    async def detect(self, a: A, b: B) -> Optional[Tension]: ...

class Contradict:
    def __init__(self, detectors: list[TensionDetector]): ...
```

---

## Phase 3: Infrastructure (Week 3-4, Parallel)

### Issue #4: Runtime Retry Logic (claude.py, openrouter.py)
- **Goal:** Add exponential backoff using Fix pattern
- **Effort:** 12-16 hours
- **Dependencies:** May need Phase 1 (Fix type)

```python
# Use Fix pattern for retries
retry_config = FixConfig(
    max_iterations=3,
    check_convergence=lambda a, b: isinstance(b, Success),
    transform=lambda failure: retry_with_backoff(failure)
)

runtime_with_retry = Fix(runtime, retry_config)
```

### Issue #6: Error Handling Transparency (base.py)
- **Goal:** Replace implicit control flow with Result/Either
- **Effort:** 16-24 hours
- **Breaking:** High risk
- **Dependencies:** None

```python
# Add to base.py or agents/c/
@dataclass
class Result(Generic[A, E]):
    value: Optional[A] = None
    error: Optional[E] = None

    @property
    def is_success(self) -> bool: ...
```

---

## Phase 4-5: Features & Observability (Weeks 5-8, Lower Priority)

**Can be deferred as technical debt**

### Issue #3: Judge Decomposition (judge.py)
- **Impact:** Breaking change
- **Effort:** 24-32 hours
- **Priority:** Medium (principle violation but non-critical)

```python
# Current: Primitive obsession
def _check_tasteful(agent, principles) -> bool: ...

# Target: Composable judges
tasteful_judge = JudgeTasteful()
curated_judge = JudgeCurated()
# ... 7 sub-judges

judge = tasteful_judge >> curated_judge >> ... >> final_verdict
```

### Issue #7: Hegel Observability (hegel.py)
- **Impact:** Additive
- **Effort:** 8-12 hours
- **Priority:** Low (nice-to-have)

```python
@dataclass
class DialecticOutput:
    synthesis: str
    lineage: list[DialecticStep]  # NEW: track full chain
    metadata: dict[str, Any]      # NEW: observability
```

### Issue #8: Robin Fallback Mode (robin.py)
- **Impact:** Additive
- **Effort:** 12-16 hours
- **Priority:** Medium (testing/resilience)

```python
class RobinAgent:
    def __init__(self, runtime: Optional[Runtime] = None,
                 fallback_mode: bool = True):
        # Add deterministic mode when runtime unavailable
```

---

## Testing Strategy

### Phase 1 Validation:
```bash
# Must pass before proceeding
mypy impl/claude-openrouter --strict
pytest tests/bootstrap/test_types.py
pytest tests/bootstrap/test_compose.py
```

### Phase 2-3 Validation:
- Each fix on separate branch
- Merge to integration branch
- Full test suite must pass
- No cascading refactors

### Phase 4-5:
- Breaking changes need migration guide
- Deprecation warnings before removal

---

## Risk Mitigation

1. **Type fixes first** - catches composition errors early
2. **Feature branches** - parallel work without conflicts
3. **Integration testing** - catch interaction bugs
4. **Gradual rollout** - defer non-critical items

---

## Success Criteria

- All 104 hypotheses from evolve.py addressed
- Zero type safety violations (mypy strict mode)
- Zero composition law violations
- Production robustness (retry, limits, error handling)
- Maintained backward compatibility where possible

---

## Falsifiability Tests

From HypothesisEngine output:

1. **Phase 1 Test:** If >5 modules break after type fixes → validation
2. **Phase 2 Test:** If parallel branches have clean merge → success
3. **Phase 3 Test:** If #7 not needed for debugging #5 → deferrable
4. **Phase 0 Test:** If #9 deploys as hotfix cleanly → security elevation justified

---

## Next Steps

1. Create feature branch `fix/phase-1-types`
2. Implement #1 and #2
3. Run full test suite
4. If <5 modules break, proceed to Phase 2
5. Open PR for Phase 1 with migration notes
