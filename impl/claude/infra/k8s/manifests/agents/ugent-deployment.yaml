# U-gent Deployment
#
# Deploys the U-gent server with:
# - K-gent Soul imported as library (in-process)
# - Morpheus Gateway integration via MORPHEUS_URL
# - Claude auth secret mount (optional, for CLI fallback)
# - D-gent sidecar for persistent state
#
# The U-gent uses Soul as a library, NOT via RPC. This means:
# - Soul runs in the same process as U-gent
# - No network calls for conscience checks
# - LLM calls route through Morpheus Gateway
#
# D-gent Sidecar:
# - State operations via localhost:8081
# - Shared volume for checkpoint persistence
# - Version-controlled state for optimistic concurrency
#
# AGENTESE: world.ugent.deployment.manifest
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ugent
  namespace: kgents
  labels:
    app.kubernetes.io/name: ugent
    app.kubernetes.io/part-of: kgents
    app.kubernetes.io/component: tool-execution
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ugent
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ugent
        app.kubernetes.io/part-of: kgents
        app.kubernetes.io/component: tool-execution
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: ugent
      containers:
        - name: ugent
          image: kgents/ugent:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: UGENT_PORT
              value: "8080"
            - name: UGENT_HOST
              value: "0.0.0.0"
            # Morpheus Gateway for LLM operations
            # Soul will auto-detect this and use Morpheus for LLM calls
            - name: MORPHEUS_URL
              value: "http://morpheus-gateway.kgents.svc.cluster.local:8080/v1"
            # D-gent sidecar for state operations (same pod, localhost)
            - name: DGENT_URL
              value: "http://localhost:8081"
            # Optional: Point Claude CLI to mounted secrets (for fallback)
            - name: CLAUDE_CONFIG_DIR
              value: "/var/run/secrets/claude"
            - name: LOG_LEVEL
              value: "INFO"
          volumeMounts:
            - name: claude-auth
              mountPath: /var/run/secrets/claude
              readOnly: true
          resources:
            limits:
              cpu: "500m"
              memory: "512Mi"
            requests:
              cpu: "100m"
              memory: "256Mi"
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            readOnlyRootFilesystem: false
            allowPrivilegeEscalation: false

        # D-gent Sidecar: State management for session continuity
        - name: dgent-sidecar
          image: kgents/dgent:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: state
              containerPort: 8081
              protocol: TCP
          env:
            - name: DGENT_PORT
              value: "8081"
            - name: DGENT_HOST
              value: "0.0.0.0"
            # Enable checkpoint persistence
            - name: DGENT_CHECKPOINT_DIR
              value: "/data/state"
            - name: LOG_LEVEL
              value: "INFO"
          volumeMounts:
            - name: agent-state
              mountPath: /data/state
          resources:
            limits:
              cpu: "100m"
              memory: "128Mi"
            requests:
              cpu: "50m"
              memory: "64Mi"
          livenessProbe:
            httpGet:
              path: /health
              port: state
            initialDelaySeconds: 5
            periodSeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: state
            initialDelaySeconds: 3
            periodSeconds: 10
            timeoutSeconds: 5
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            readOnlyRootFilesystem: false
            allowPrivilegeEscalation: false

      volumes:
        - name: claude-auth
          secret:
            secretName: claude-auth
            optional: true  # U-gent can work without CLI auth (uses Morpheus)
            defaultMode: 0400
        # Persistent state volume for D-gent checkpoints
        # Uses PVC for durability across pod restarts/rescheduling
        - name: agent-state
          persistentVolumeClaim:
            claimName: ugent-state
      # Prefer scheduling near Morpheus for low-latency LLM calls
      affinity:
        podAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 50
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: morpheus-gateway
                topologyKey: kubernetes.io/hostname
