# Network Policy for Town Service
#
# Restricts egress to only required services:
# - Morpheus Gateway (LLM)
# - Redis (budget store)
# - NATS (event streaming)
# - OTel Collector (telemetry)
#
# See: plans/velvety-mapping-puddle.md Phase 5
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: town-service-egress
  namespace: kgents-triad
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: town-service
  policyTypes:
    - Egress

  egress:
    # Allow Morpheus Gateway (LLM)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kgents
          podSelector:
            matchLabels:
              app.kubernetes.io/name: morpheus-gateway
      ports:
        - protocol: TCP
          port: 8080

    # Allow Redis
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kgents-triad
          podSelector:
            matchLabels:
              app.kubernetes.io/name: triad-redis
      ports:
        - protocol: TCP
          port: 6379

    # Allow NATS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kgents-agents
          podSelector:
            matchLabels:
              app.kubernetes.io/name: nats
      ports:
        - protocol: TCP
          port: 4222

    # Allow OTel Collector
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kgents-observability
      ports:
        - protocol: TCP
          port: 4317

    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
