# L-Gent PostgreSQL + pgvector
# StatefulSet for persistent storage with vector similarity search
#
# This is the "hard part first" - stateful workloads in K8s.
# Expected pain points:
#   - PVC won't bind → learn StorageClasses
#   - Pod stuck Pending → learn resource limits
#   - Connection refused → learn Service discovery
---
apiVersion: v1
kind: Secret
metadata:
  name: l-gent-postgres
  namespace: kgents-agents
  labels:
    app.kubernetes.io/name: l-gent-postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: kgents
type: Opaque
stringData:
  POSTGRES_USER: lgent
  POSTGRES_PASSWORD: lgent-dev-password  # rotated in prod via sealed-secrets
  POSTGRES_DB: lgent

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: l-gent-postgres
  namespace: kgents-agents
  labels:
    app.kubernetes.io/name: l-gent-postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: kgents
spec:
  serviceName: l-gent-postgres
  replicas: 1
  selector:
    matchLabels:
      app: l-gent-postgres
  template:
    metadata:
      labels:
        app: l-gent-postgres
        app.kubernetes.io/name: l-gent-postgres
        app.kubernetes.io/component: database
    spec:
      containers:
      - name: postgres
        image: pgvector/pgvector:pg16
        ports:
        - containerPort: 5432
          name: postgres
        envFrom:
        - secretRef:
            name: l-gent-postgres
        env:
        # pgvector extension auto-loads, but we ensure it in init
        - name: POSTGRES_INITDB_ARGS
          value: "--encoding=UTF8"
        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql/data
        - name: init-scripts
          mountPath: /docker-entrypoint-initdb.d
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        readinessProbe:
          exec:
            command: ["pg_isready", "-U", "lgent", "-d", "lgent"]
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
        livenessProbe:
          exec:
            command: ["pg_isready", "-U", "lgent", "-d", "lgent"]
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
      volumes:
      - name: init-scripts
        configMap:
          name: l-gent-postgres-init
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 1Gi
      # storageClassName: standard  # Uncomment for explicit class

---
apiVersion: v1
kind: Service
metadata:
  name: l-gent-postgres
  namespace: kgents-agents
  labels:
    app.kubernetes.io/name: l-gent-postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: kgents
spec:
  type: ClusterIP
  ports:
  - port: 5432
    targetPort: 5432
    name: postgres
  selector:
    app: l-gent-postgres

---
# Headless service for StatefulSet DNS
# Allows: l-gent-postgres-0.l-gent-postgres.kgents-agents.svc.cluster.local
apiVersion: v1
kind: Service
metadata:
  name: l-gent-postgres-headless
  namespace: kgents-agents
  labels:
    app.kubernetes.io/name: l-gent-postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: kgents
spec:
  type: ClusterIP
  clusterIP: None  # Headless
  ports:
  - port: 5432
    targetPort: 5432
    name: postgres
  selector:
    app: l-gent-postgres

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: l-gent-postgres-init
  namespace: kgents-agents
  labels:
    app.kubernetes.io/name: l-gent-postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: kgents
data:
  01-extensions.sql: |
    -- Enable pgvector for semantic search
    CREATE EXTENSION IF NOT EXISTS vector;

    -- Enable pg_trgm for fuzzy text search
    CREATE EXTENSION IF NOT EXISTS pg_trgm;

  02-schema.sql: |
    -- L-Gent Catalog Schema
    -- Core table for artifact registry

    CREATE TABLE IF NOT EXISTS catalog_entries (
        id TEXT PRIMARY KEY,
        name TEXT NOT NULL,
        entity_type TEXT NOT NULL,
        status TEXT NOT NULL DEFAULT 'active',
        description TEXT,
        version TEXT,
        input_type TEXT,
        output_type TEXT,
        embedding vector(1536),  -- OpenAI ada-002 dimensions
        metadata JSONB DEFAULT '{}',
        created_at TIMESTAMPTZ DEFAULT NOW(),
        updated_at TIMESTAMPTZ DEFAULT NOW()
    );

    -- Index for semantic search (IVFFlat for speed on large datasets)
    CREATE INDEX IF NOT EXISTS idx_catalog_embedding
        ON catalog_entries
        USING ivfflat (embedding vector_cosine_ops)
        WITH (lists = 100);

    -- Index for entity type filtering
    CREATE INDEX IF NOT EXISTS idx_catalog_entity_type
        ON catalog_entries(entity_type);

    -- Index for status filtering
    CREATE INDEX IF NOT EXISTS idx_catalog_status
        ON catalog_entries(status);

    -- Trigram index for fuzzy name search
    CREATE INDEX IF NOT EXISTS idx_catalog_name_trgm
        ON catalog_entries
        USING gin (name gin_trgm_ops);

    -- Lineage table for tracking artifact relationships
    CREATE TABLE IF NOT EXISTS catalog_lineage (
        id SERIAL PRIMARY KEY,
        parent_id TEXT NOT NULL REFERENCES catalog_entries(id) ON DELETE CASCADE,
        child_id TEXT NOT NULL REFERENCES catalog_entries(id) ON DELETE CASCADE,
        relationship TEXT NOT NULL,  -- 'derived_from', 'depends_on', 'generates'
        created_at TIMESTAMPTZ DEFAULT NOW(),
        UNIQUE(parent_id, child_id, relationship)
    );

    CREATE INDEX IF NOT EXISTS idx_lineage_parent ON catalog_lineage(parent_id);
    CREATE INDEX IF NOT EXISTS idx_lineage_child ON catalog_lineage(child_id);

    -- Function to auto-update updated_at
    CREATE OR REPLACE FUNCTION update_updated_at()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- Trigger for auto-updating updated_at
    DROP TRIGGER IF EXISTS catalog_entries_updated_at ON catalog_entries;
    CREATE TRIGGER catalog_entries_updated_at
        BEFORE UPDATE ON catalog_entries
        FOR EACH ROW
        EXECUTE FUNCTION update_updated_at();
