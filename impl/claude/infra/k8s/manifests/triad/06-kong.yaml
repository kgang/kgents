# Kong API Gateway for kgents SaaS
# Production-grade API Gateway with JWT auth, rate limiting, and tenant routing
#
# AGENTESE: world.gateway.kong
#
# Features:
# 1. JWT validation (RS256/HS256)
# 2. API Key authentication
# 3. Rate limiting (per tenant, per key)
# 4. Request/response transformation
# 5. Prometheus metrics
# 6. Health checks
#
# Architecture:
# - Kong Gateway (DB-less mode with declarative config)
# - Redis for rate limiting counters
# - Upstream services in cluster
#
---
apiVersion: v1
kind: Namespace
metadata:
  name: kgents-gateway
  labels:
    app.kubernetes.io/name: kong
    app.kubernetes.io/part-of: kgents
    kgents.io/saas-component: api-gateway

---
# Kong ConfigMap with declarative configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: kgents-gateway
  labels:
    app.kubernetes.io/name: kong
    app.kubernetes.io/component: config
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    # ============================================================
    # SERVICES: Backend API endpoints
    # ============================================================
    services:
      # K-Gent API Service
      - name: kgent-api
        url: http://kgent-api.kgents-triad.svc.cluster.local:8000
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 120000  # LLM responses can be slow
        retries: 2
        routes:
          - name: kgent-sessions
            paths:
              - /v1/kgent
            strip_path: false
            protocols:
              - http
              - https

      # AGENTESE API Service
      - name: agentese-api
        url: http://agentese-api.kgents-triad.svc.cluster.local:8000
        connect_timeout: 30000
        write_timeout: 30000
        read_timeout: 60000
        routes:
          - name: agentese-invoke
            paths:
              - /v1/agentese
            strip_path: false
            protocols:
              - http
              - https

      # Auth API Service
      - name: auth-api
        url: http://auth-api.kgents-triad.svc.cluster.local:8000
        routes:
          - name: auth-routes
            paths:
              - /v1/auth
            strip_path: false
            protocols:
              - http
              - https

      # Billing API Service
      - name: billing-api
        url: http://billing-api.kgents-triad.svc.cluster.local:8000
        routes:
          - name: billing-routes
            paths:
              - /v1/billing
            strip_path: false
            protocols:
              - http
              - https

      # Health Check Service (unauthenticated)
      - name: health-service
        url: http://health-api.kgents-triad.svc.cluster.local:8000
        routes:
          - name: health-check
            paths:
              - /health
              - /ready
              - /live
            strip_path: false
            protocols:
              - http
              - https

    # ============================================================
    # CONSUMERS: API key consumers (created dynamically)
    # ============================================================
    consumers:
      # Development consumers (match existing auth.py keys)
      - username: dev_alice
        custom_id: "00000000-0000-0000-0000-000000000001"
        keyauth_credentials:
          - key: kg_dev_alice
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              policy: redis
              redis_host: triad-redis.kgents-triad.svc.cluster.local

      - username: dev_bob
        custom_id: "00000000-0000-0000-0000-000000000002"
        keyauth_credentials:
          - key: kg_dev_bob
        plugins:
          - name: rate-limiting
            config:
              minute: 1000
              policy: redis
              redis_host: triad-redis.kgents-triad.svc.cluster.local

      - username: dev_carol
        custom_id: "00000000-0000-0000-0000-000000000003"
        keyauth_credentials:
          - key: kg_dev_carol
        plugins:
          - name: rate-limiting
            config:
              minute: 10000
              policy: redis
              redis_host: triad-redis.kgents-triad.svc.cluster.local

    # ============================================================
    # PLUGINS: Global and service-specific plugins
    # ============================================================
    plugins:
      # Global: CORS for browser access
      - name: cors
        config:
          origins:
            - "*"  # Restrict in production
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Authorization
            - Content-Length
            - Content-Type
            - X-API-Key
            - X-Request-ID
            - X-Tenant-ID
          exposed_headers:
            - X-Request-ID
            - X-RateLimit-Limit-Minute
            - X-RateLimit-Remaining-Minute
          credentials: true
          max_age: 3600

      # Global: Request ID injection
      - name: correlation-id
        config:
          header_name: X-Request-ID
          generator: uuid
          echo_downstream: true

      # Global: Prometheus metrics
      - name: prometheus
        config:
          per_consumer: true
          status_code_metrics: true
          latency_metrics: true
          bandwidth_metrics: true

      # Global: Request size limit
      - name: request-size-limiting
        config:
          allowed_payload_size: 10  # 10 MB
          size_unit: megabytes

      # Global: Response transformer (add security headers)
      - name: response-transformer
        config:
          add:
            headers:
              - "X-Content-Type-Options: nosniff"
              - "X-Frame-Options: DENY"
              - "X-XSS-Protection: 1; mode=block"

      # Service-specific: API Key auth for main services
      - name: key-auth
        service: kgent-api
        config:
          key_names:
            - X-API-Key
            - apikey
          key_in_header: true
          key_in_query: true
          hide_credentials: true

      - name: key-auth
        service: agentese-api
        config:
          key_names:
            - X-API-Key
            - apikey
          key_in_header: true
          key_in_query: true
          hide_credentials: true

      - name: key-auth
        service: billing-api
        config:
          key_names:
            - X-API-Key
            - apikey
          key_in_header: true
          key_in_query: true
          hide_credentials: true

      # Global: Default rate limiting (overridden per consumer)
      - name: rate-limiting
        config:
          minute: 60  # Default for unauthenticated
          policy: redis
          redis_host: triad-redis.kgents-triad.svc.cluster.local
          redis_port: 6379
          fault_tolerant: true
          hide_client_headers: false
          redis_timeout: 2000

      # Service-specific: Request transformer to add tenant context
      - name: request-transformer
        service: kgent-api
        config:
          add:
            headers:
              - "X-Kong-Consumer-Custom-ID:$(headers.x-consumer-custom-id)"
              - "X-Authenticated:true"

      - name: request-transformer
        service: agentese-api
        config:
          add:
            headers:
              - "X-Kong-Consumer-Custom-ID:$(headers.x-consumer-custom-id)"
              - "X-Authenticated:true"

---
# Kong Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kong
  namespace: kgents-gateway
  labels:
    app.kubernetes.io/name: kong
    app.kubernetes.io/component: gateway
    app.kubernetes.io/part-of: kgents
spec:
  replicas: 2
  selector:
    matchLabels:
      app: kong
  template:
    metadata:
      labels:
        app: kong
        app.kubernetes.io/name: kong
        app.kubernetes.io/component: gateway
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8100"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: kong
        image: kong:3.8
        env:
        - name: KONG_DATABASE
          value: "off"  # DB-less mode
        - name: KONG_DECLARATIVE_CONFIG
          value: /kong/declarative/kong.yml
        - name: KONG_PROXY_ACCESS_LOG
          value: /dev/stdout
        - name: KONG_ADMIN_ACCESS_LOG
          value: /dev/stdout
        - name: KONG_PROXY_ERROR_LOG
          value: /dev/stderr
        - name: KONG_ADMIN_ERROR_LOG
          value: /dev/stderr
        - name: KONG_PROXY_LISTEN
          value: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
        - name: KONG_ADMIN_LISTEN
          value: "127.0.0.1:8001"
        - name: KONG_STATUS_LISTEN
          value: "0.0.0.0:8100"
        - name: KONG_NGINX_WORKER_PROCESSES
          value: "2"
        - name: KONG_PLUGINS
          value: "bundled"
        ports:
        - name: proxy
          containerPort: 8000
          protocol: TCP
        - name: proxy-ssl
          containerPort: 8443
          protocol: TCP
        - name: status
          containerPort: 8100
          protocol: TCP
        volumeMounts:
        - name: kong-config
          mountPath: /kong/declarative
          readOnly: true
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "1000m"
        readinessProbe:
          httpGet:
            path: /status
            port: 8100
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            path: /status
            port: 8100
          initialDelaySeconds: 15
          periodSeconds: 20
          timeoutSeconds: 5
      volumes:
      - name: kong-config
        configMap:
          name: kong-config

---
# Kong Service (for external access)
apiVersion: v1
kind: Service
metadata:
  name: kong-proxy
  namespace: kgents-gateway
  labels:
    app.kubernetes.io/name: kong
    app.kubernetes.io/component: proxy
    app.kubernetes.io/part-of: kgents
spec:
  type: NodePort
  ports:
  - name: http
    port: 80
    targetPort: 8000
    nodePort: 30080
    protocol: TCP
  - name: https
    port: 443
    targetPort: 8443
    nodePort: 30443
    protocol: TCP
  selector:
    app: kong

---
# Kong Status Service (for metrics)
apiVersion: v1
kind: Service
metadata:
  name: kong-status
  namespace: kgents-gateway
  labels:
    app.kubernetes.io/name: kong
    app.kubernetes.io/component: status
spec:
  type: ClusterIP
  ports:
  - name: status
    port: 8100
    targetPort: 8100
  selector:
    app: kong

---
# ServiceMonitor for Prometheus (if using prometheus-operator)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kong
  namespace: kgents-gateway
  labels:
    app.kubernetes.io/name: kong
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: kong
      app.kubernetes.io/component: status
  endpoints:
  - port: status
    path: /metrics
    interval: 30s

---
# NetworkPolicy: Allow traffic to Kong from anywhere
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kong-ingress
  namespace: kgents-gateway
spec:
  podSelector:
    matchLabels:
      app: kong
  policyTypes:
  - Ingress
  ingress:
  - ports:
    - protocol: TCP
      port: 8000
    - protocol: TCP
      port: 8443
    - protocol: TCP
      port: 8100

---
# NetworkPolicy: Kong can access backend services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kong-egress
  namespace: kgents-gateway
spec:
  podSelector:
    matchLabels:
      app: kong
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kgents-triad
    ports:
    - protocol: TCP
      port: 8000
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kgents-triad
    ports:
    - protocol: TCP
      port: 6379  # Redis
