# Database Triad Synapse
# CDC processor - the morphism between Postgres and Qdrant
#
# The Synapse is a FluxAgent that maintains coherency:
# - Polls outbox for change events
# - Computes embeddings
# - Upserts to Qdrant
# - Reports metrics to AGENTESE self.vitals.*
#
# Categorical Guarantee:
#   Synapse(id_A) = id_{Synapse(A)}  -- No change → no change
#   Synapse(g ∘ f) = Synapse(g) ∘ Synapse(f)  -- Changes compose
---
apiVersion: v1
kind: Secret
metadata:
  name: synapse-credentials
  namespace: kgents-triad
  labels:
    app.kubernetes.io/name: synapse
    app.kubernetes.io/component: cdc-processor
    app.kubernetes.io/part-of: kgents
type: Opaque
stringData:
  # OpenAI API key for embeddings (replace with your key)
  OPENAI_API_KEY: sk-placeholder-replace-with-real-key
  # Database URL (auto-constructed in configmap, but can override)
  # DATABASE_URL: postgresql://triad:triad-dev-password@triad-postgres:5432/triad

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: synapse-config
  namespace: kgents-triad
  labels:
    app.kubernetes.io/name: synapse
    app.kubernetes.io/component: cdc-processor
    app.kubernetes.io/part-of: kgents
data:
  # Synapse configuration
  SYNAPSE_COLLECTION: memories
  SYNAPSE_TEXT_FIELD: content
  SYNAPSE_BATCH_SIZE: "100"
  SYNAPSE_POLL_INTERVAL_MS: "1000"
  SYNAPSE_MAX_RETRIES: "5"
  SYNAPSE_USE_CIRCUIT_BREAKER: "true"
  SYNAPSE_USE_DLQ: "true"
  # Infrastructure
  POSTGRES_HOST: triad-postgres
  POSTGRES_PORT: "5432"
  POSTGRES_DB: triad
  POSTGRES_USER: triad
  QDRANT_HOST: triad-qdrant
  QDRANT_PORT: "6333"
  REDIS_HOST: triad-redis
  REDIS_PORT: "6379"
  # Embedding provider
  EMBEDDING_PROVIDER: openai
  EMBEDDING_MODEL: text-embedding-ada-002
  EMBEDDING_DIMENSION: "1536"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: synapse
  namespace: kgents-triad
  labels:
    app.kubernetes.io/name: synapse
    app.kubernetes.io/component: cdc-processor

---
# CronJob runs every minute
# For continuous processing, consider a Deployment with leader election
apiVersion: batch/v1
kind: CronJob
metadata:
  name: synapse-cdc
  namespace: kgents-triad
  labels:
    app.kubernetes.io/name: synapse
    app.kubernetes.io/component: cdc-processor
    app.kubernetes.io/part-of: kgents
spec:
  # Run every minute
  schedule: "* * * * *"
  # Don't run concurrent jobs
  concurrencyPolicy: Forbid
  # Keep history
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  jobTemplate:
    metadata:
      labels:
        app: synapse
        app.kubernetes.io/name: synapse
        app.kubernetes.io/component: cdc-processor
    spec:
      # Job timeout: 55 seconds (before next cron)
      activeDeadlineSeconds: 55
      # Retry on failure
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: synapse
            app.kubernetes.io/name: synapse
        spec:
          serviceAccountName: synapse
          restartPolicy: OnFailure
          containers:
          - name: synapse
            image: kgents/synapse:latest
            imagePullPolicy: IfNotPresent
            command:
            - python
            - -m
            - agents.flux.synapse_runner
            envFrom:
            - configMapRef:
                name: synapse-config
            - secretRef:
                name: synapse-credentials
            - secretRef:
                name: triad-postgres
            env:
            # Construct DATABASE_URL from components
            - name: DATABASE_URL
              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(POSTGRES_HOST):$(POSTGRES_PORT)/$(POSTGRES_DB)"
            - name: QDRANT_URL
              value: "http://$(QDRANT_HOST):$(QDRANT_PORT)"
            - name: REDIS_URL
              value: "redis://$(REDIS_HOST):$(REDIS_PORT)"
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "500m"

---
# For continuous processing (alternative to CronJob)
# Uncomment for production use with leader election
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: synapse-continuous
#   namespace: kgents-triad
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: synapse-continuous
#   template:
#     spec:
#       containers:
#       - name: synapse
#         image: kgents/synapse:latest
#         command: ["python", "-m", "agents.flux.synapse_runner", "--continuous"]
