# Agent CRD - The Computational Cell
#
# Agents are the computational units of kgents:
#   - Each agent has a genus (L, M, B, etc.) determining its capabilities
#   - Agents run in pods with D-gent sidecars for memory
#   - Agents perceive through Umwelts and coordinate through Pheromones
#
# Architecture:
#   Agent CR → AgentOperator → Deployment + Service + NetworkPolicy + Memory CR
#
# Principle alignment:
#   - Composable: Agents are morphisms (C-gents)
#   - Ethical: Health checks include cognitive probes, not just HTTP
#   - Tasteful: Placeholder mode prevents CrashLoopBackOff during dev
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: agents.kgents.io
  labels:
    app.kubernetes.io/part-of: kgents
    app.kubernetes.io/component: compute
spec:
  group: kgents.io
  scope: Namespaced
  names:
    plural: agents
    singular: agent
    kind: Agent
    shortNames:
      - ag
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - genus
              properties:
                genus:
                  type: string
                  description: "Agent genus (letter) - determines capabilities"
                  enum:
                    - A   # Abstract architectures + Art/Creativity
                    - B   # Bio/Scientific discovery + Economics
                    - C   # Category Theory (composability)
                    - D   # Data (state, memory, persistence)
                    - E   # Evolution (teleological thermodynamics)
                    - F   # Forge (refinement)
                    - G   # Grammar/Generation
                    - H   # Health/Healing
                    - I   # Interface (TUI/visualization)
                    - J   # JSON/Judgment
                    - K   # Kent simulacra (persona)
                    - L   # Lattice/Library (semantic registry)
                    - M   # Memory/Map (holographic cartography)
                    - N   # Narrative (witness/trace)
                    - O   # Observation (panopticon)
                    - P   # Parsing/Probabilistic
                    - Q   # Query/Question
                    - R   # Refinery (refinement)
                    - S   # Search/Similarity
                    - T   # Testing (algebraic reliability)
                    - U   # Utility (tool use, MCP)
                    - V   # Validation/Voting
                    - W   # Watch/Wire (event bus)
                    - X   # eXperimental
                    - Y   # Y-Combinator (cognitive topology)
                    - Z   # Zero/Zen (ambiguity surfacing)
                    - PSI # Psychopomp (metaphor engine)
                    - OMEGA # Somatic Orchestrator
                image:
                  type: string
                  description: "Container image for the agent"
                  default: "python:3.12-slim"
                replicas:
                  type: integer
                  description: "Number of agent replicas"
                  minimum: 0
                  maximum: 10
                  default: 1
                entrypoint:
                  type: string
                  description: "Python module entrypoint (e.g., 'agents.l.main')"
                deployMode:
                  type: string
                  description: "Deployment mode - PLACEHOLDER for infra testing"
                  enum:
                    - FULL        # Real agent with code
                    - PLACEHOLDER # Sleep container for testing
                    - DRY_RUN     # Don't actually deploy
                  default: "PLACEHOLDER"
                resources:
                  type: object
                  description: "Resource limits and requests"
                  properties:
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: "500m"
                        memory:
                          type: string
                          default: "512Mi"
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: "100m"
                        memory:
                          type: string
                          default: "256Mi"
                symbiont:
                  type: object
                  description: "Symbiont configuration (sidecars)"
                  properties:
                    memory:
                      type: object
                      description: "D-gent memory sidecar config"
                      properties:
                        enabled:
                          type: boolean
                          default: true
                        type:
                          type: string
                          description: "Memory type for auto-created Memory CR"
                          enum:
                            - RELATIONAL
                            - VECTOR
                            - BICAMERAL
                            - EPHEMERAL
                          default: "BICAMERAL"
                        size:
                          type: string
                          description: "Memory size"
                          default: "256Mi"
                        retentionPolicy:
                          type: string
                          description: "What happens to memory when agent deleted"
                          enum:
                            - DELETE
                            - RETAIN
                            - COMPOST
                          default: "COMPOST"
                    identity:
                      type: object
                      description: "SPIFFE identity config"
                      properties:
                        enabled:
                          type: boolean
                          default: true
                        spiffeId:
                          type: string
                          description: "SPIFFE ID (auto-generated if not set)"
                health:
                  type: object
                  description: "Health check configuration"
                  properties:
                    type:
                      type: string
                      description: "Health check type"
                      enum:
                        - HTTP           # Standard K8s liveness probe
                        - COGNITIVE_PROBE # SCU - Standard Cognitive Unit
                      default: "HTTP"
                    probeInterval:
                      type: string
                      description: "Interval between health checks"
                      default: "30s"
                    unhealthyThreshold:
                      type: integer
                      description: "Failures before marking unhealthy"
                      default: 3
                    degradeToSafemode:
                      type: boolean
                      description: "Degrade instead of restart on cognitive failure"
                      default: true
                networkPolicy:
                  type: object
                  description: "Network restrictions"
                  properties:
                    allowedPeers:
                      type: array
                      description: "Agent genera this agent can communicate with"
                      items:
                        type: string
                    allowEgress:
                      type: boolean
                      description: "Allow external network access"
                      default: false
                umwelt:
                  type: string
                  description: "Name of Umwelt CR to use (auto-created if not set)"
                config:
                  type: object
                  description: "Agent-specific configuration (injected as env vars)"
                  x-kubernetes-preserve-unknown-fields: true
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: "Current lifecycle phase"
                  enum:
                    - Pending
                    - Running
                    - Degraded
                    - Failed
                    - Terminating
                observedGeneration:
                  type: integer
                  description: "Generation observed by operator"
                deployment:
                  type: string
                  description: "Name of managed Deployment"
                service:
                  type: string
                  description: "Name of managed Service"
                memory:
                  type: string
                  description: "Name of managed Memory CR"
                umwelt:
                  type: string
                  description: "Name of associated Umwelt CR"
                readyReplicas:
                  type: integer
                  description: "Number of ready replicas"
                cognitiveHealth:
                  type: string
                  description: "Result of last cognitive probe"
                  enum:
                    - HEALTHY
                    - DEGRADED
                    - UNRESPONSIVE
                    - UNKNOWN
                lastProbeTime:
                  type: string
                  format: date-time
                  description: "Time of last cognitive probe"
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
      subresources:
        status: {}
        scale:
          specReplicasPath: .spec.replicas
          statusReplicasPath: .status.readyReplicas
      additionalPrinterColumns:
        - name: Genus
          type: string
          jsonPath: .spec.genus
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Replicas
          type: integer
          jsonPath: .status.readyReplicas
        - name: Cognitive
          type: string
          jsonPath: .status.cognitiveHealth
          priority: 1
        - name: Mode
          type: string
          jsonPath: .spec.deployMode
          priority: 1
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
