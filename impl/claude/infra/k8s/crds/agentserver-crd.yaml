# AgentServer CRD - The Terrarium Gateway
#
# AgentServer deploys a Terrarium instance for agent observability:
#   - WebSocket gateway for real-time observation (The Mirror)
#   - REST bridge for agent invocation (The Beam)
#   - Metrics aggregation for I-gent widgets
#   - Semaphore/Purgatory visibility (Phase 5)
#
# Architecture:
#   AgentServer CR → AgentServerOperator → Deployment + Service + ConfigMap
#
# The Mirror Protocol:
#   - /observe/{agent_id} - Zero entropy, read-only (The Reflection)
#   - /perturb/{agent_id} - High entropy, requires auth (The Beam)
#   - Agent emits ONCE to buffer, buffer broadcasts to N clients
#   - Slow observers don't slow agents
#
# Principle alignment:
#   - Tasteful: Single CR deploys complete observability stack
#   - Ethical: Observation respects agent metabolism (no slowdown)
#   - Joy-inducing: Real-time DensityField visualization
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: agentservers.kgents.io
  labels:
    app.kubernetes.io/part-of: kgents
    app.kubernetes.io/component: observability
spec:
  group: kgents.io
  scope: Namespaced
  names:
    plural: agentservers
    singular: agentserver
    kind: AgentServer
    shortNames:
      - as
      - terrarium
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              properties:
                # Gateway Configuration
                gateway:
                  type: object
                  description: "Terrarium gateway configuration"
                  properties:
                    image:
                      type: string
                      description: "Container image for the gateway"
                      default: "kgents/terrarium:latest"
                    replicas:
                      type: integer
                      description: "Number of gateway replicas"
                      minimum: 1
                      maximum: 10
                      default: 1
                    port:
                      type: integer
                      description: "Gateway port"
                      minimum: 1024
                      maximum: 65535
                      default: 8080
                    resources:
                      type: object
                      description: "Resource limits"
                      properties:
                        limits:
                          type: object
                          properties:
                            cpu:
                              type: string
                              default: "500m"
                            memory:
                              type: string
                              default: "512Mi"
                        requests:
                          type: object
                          properties:
                            cpu:
                              type: string
                              default: "100m"
                            memory:
                              type: string
                              default: "256Mi"

                # Mirror Protocol Configuration
                mirror:
                  type: object
                  description: "HolographicBuffer configuration"
                  properties:
                    maxHistory:
                      type: integer
                      description: "Maximum events in history (for late joiners)"
                      minimum: 10
                      maximum: 10000
                      default: 100
                    broadcastTimeout:
                      type: string
                      description: "Timeout for broadcasting to observers"
                      default: "100ms"
                    bufferSize:
                      type: integer
                      description: "Event buffer size per agent"
                      minimum: 10
                      maximum: 1000
                      default: 100

                # Agent Registry
                agents:
                  type: object
                  description: "Agent registration configuration"
                  properties:
                    autoDiscover:
                      type: boolean
                      description: "Auto-discover agents via Agent CR watch"
                      default: true
                    namespaceSelector:
                      type: object
                      description: "Namespace selector for agent discovery"
                      properties:
                        matchLabels:
                          type: object
                          additionalProperties:
                            type: string
                        matchExpressions:
                          type: array
                          items:
                            type: object
                            properties:
                              key:
                                type: string
                              operator:
                                type: string
                              values:
                                type: array
                                items:
                                  type: string
                    genusFilter:
                      type: array
                      description: "Only include these genera (empty = all)"
                      items:
                        type: string
                    staticAgents:
                      type: array
                      description: "Statically configured agents"
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          namespace:
                            type: string
                          genus:
                            type: string
                          endpoint:
                            type: string

                # I-gent Widget Server
                widgets:
                  type: object
                  description: "I-gent widget server configuration"
                  properties:
                    enabled:
                      type: boolean
                      description: "Enable widget server"
                      default: true
                    staticPath:
                      type: string
                      description: "Path to static widget files"
                      default: "/app/widgets"
                    densityField:
                      type: object
                      description: "DensityField widget config"
                      properties:
                        enabled:
                          type: boolean
                          default: true
                        refreshInterval:
                          type: string
                          description: "Refresh interval for density calculation"
                          default: "1s"

                # Pheromone Monitoring
                pheromones:
                  type: object
                  description: "Pheromone signal monitoring"
                  properties:
                    enabled:
                      type: boolean
                      description: "Enable pheromone watching"
                      default: true
                    decayPollingInterval:
                      type: string
                      description: "Interval for recalculating decay"
                      default: "5s"
                    forwardToMirror:
                      type: boolean
                      description: "Forward pheromone events to observers"
                      default: true

                # Semaphore/Purgatory Integration (Phase 5)
                semaphores:
                  type: object
                  description: "Semaphore system configuration"
                  properties:
                    enabled:
                      type: boolean
                      description: "Enable semaphore visibility"
                      default: true
                    purgatoryEndpoint:
                      type: boolean
                      description: "Expose /api/purgatory endpoints"
                      default: true
                    webhookNotifications:
                      type: object
                      description: "Webhook for semaphore notifications"
                      properties:
                        enabled:
                          type: boolean
                          default: false
                        url:
                          type: string
                          description: "Webhook URL for notifications"
                        events:
                          type: array
                          description: "Events to send"
                          items:
                            type: string
                            enum:
                              - ejected
                              - resolved
                              - cancelled
                              - voided

                # Authentication
                auth:
                  type: object
                  description: "Authentication configuration"
                  properties:
                    observeRequiresAuth:
                      type: boolean
                      description: "Require auth for /observe endpoints"
                      default: false
                    perturbRequiresAuth:
                      type: boolean
                      description: "Require auth for /perturb endpoints"
                      default: true
                    apiKeySecret:
                      type: string
                      description: "Secret containing API key"
                    rbacIntegration:
                      type: boolean
                      description: "Use K8s RBAC via Umwelt"
                      default: true

                # Service Exposure
                service:
                  type: object
                  description: "Service exposure configuration"
                  properties:
                    type:
                      type: string
                      description: "Service type"
                      enum:
                        - ClusterIP
                        - LoadBalancer
                        - NodePort
                      default: "ClusterIP"
                    annotations:
                      type: object
                      description: "Service annotations"
                      additionalProperties:
                        type: string
                    loadBalancerSourceRanges:
                      type: array
                      description: "Source ranges for LoadBalancer"
                      items:
                        type: string

                # Metrics
                metrics:
                  type: object
                  description: "Metrics configuration"
                  properties:
                    enabled:
                      type: boolean
                      description: "Enable Prometheus metrics"
                      default: true
                    port:
                      type: integer
                      description: "Metrics port"
                      default: 9090
                    path:
                      type: string
                      description: "Metrics path"
                      default: "/metrics"

            status:
              type: object
              properties:
                phase:
                  type: string
                  description: "Current phase"
                  enum:
                    - Pending
                    - Deploying
                    - Running
                    - Degraded
                    - Failed
                observedGeneration:
                  type: integer
                  description: "Generation observed by operator"
                deployment:
                  type: string
                  description: "Name of managed Deployment"
                service:
                  type: string
                  description: "Name of managed Service"
                endpoint:
                  type: string
                  description: "Service endpoint URL"
                readyReplicas:
                  type: integer
                  description: "Number of ready replicas"
                registeredAgents:
                  type: integer
                  description: "Number of registered agents"
                activeObservers:
                  type: integer
                  description: "Number of active WebSocket observers"
                pendingSemaphores:
                  type: integer
                  description: "Number of semaphores in Purgatory"
                lastHeartbeat:
                  type: string
                  format: date-time
                  description: "Last successful heartbeat"
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
      subresources:
        status: {}
        scale:
          specReplicasPath: .spec.gateway.replicas
          statusReplicasPath: .status.readyReplicas
      additionalPrinterColumns:
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Replicas
          type: integer
          jsonPath: .status.readyReplicas
        - name: Agents
          type: integer
          jsonPath: .status.registeredAgents
        - name: Observers
          type: integer
          jsonPath: .status.activeObservers
          priority: 1
        - name: Semaphores
          type: integer
          jsonPath: .status.pendingSemaphores
          priority: 1
        - name: Endpoint
          type: string
          jsonPath: .status.endpoint
          priority: 1
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
