# Proposal CRD - Cumulative Risk-Aware Change Governance
#
# Proposals are the governance mechanism for kgents changes:
#   - Track cumulative risk across changes (velocity + magnitude penalties)
#   - Auto-merge low-risk changes, escalate high-risk
#   - Integrate with T-gents for test validation via pheromones
#
# Risk Model (from fiscal constitution):
#   - base_risk: Inherent risk of the change type (0.0-1.0)
#   - velocity_penalty: Penalty for rapid successive changes (compounding)
#   - magnitude: Scope multiplier (lines changed, files touched)
#   - cumulative_risk = base_risk * (1 + velocity_penalty) * magnitude_factor
#
# This makes change governance VISIBLE:
#   kubectl get proposals --watch
#
# Principle alignment:
#   - T-gent (Algebraic Reliability): Changes are type-checked operations
#   - B-gent (Economics): Risk budget is a fiscal constraint
#   - Composable: Proposals compose (batch proposals)
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: proposals.kgents.io
  labels:
    app.kubernetes.io/part-of: kgents
    app.kubernetes.io/component: governance
spec:
  group: kgents.io
  scope: Namespaced
  names:
    plural: proposals
    singular: proposal
    kind: Proposal
    shortNames:
      - prop
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - changeType
                - target
                - proposer
              properties:
                changeType:
                  type: string
                  description: "Type of change being proposed"
                  enum:
                    # Code changes
                    - CODE_PATCH        # Small code fix (base_risk: 0.1)
                    - CODE_FEATURE      # New feature (base_risk: 0.3)
                    - CODE_REFACTOR     # Refactoring (base_risk: 0.4)
                    - CODE_DELETE       # Code deletion (base_risk: 0.5)
                    # Config changes
                    - CONFIG_UPDATE     # Config modification (base_risk: 0.2)
                    - CONFIG_SECRET     # Secret rotation (base_risk: 0.6)
                    # Agent changes
                    - AGENT_DEPLOY      # Deploy new agent (base_risk: 0.3)
                    - AGENT_SCALE       # Scale agent replicas (base_risk: 0.1)
                    - AGENT_DELETE      # Delete agent (base_risk: 0.7)
                    - AGENT_UPGRADE     # Upgrade agent version (base_risk: 0.4)
                    # Memory changes
                    - MEMORY_MIGRATE    # Migrate memory backend (base_risk: 0.6)
                    - MEMORY_COMPACT    # Compact/GC memory (base_risk: 0.3)
                    - MEMORY_DELETE     # Delete memory (base_risk: 0.8)
                    # Governance changes
                    - POLICY_UPDATE     # Update governance policy (base_risk: 0.5)
                    - RISK_OVERRIDE     # Override risk threshold (base_risk: 0.9)
                target:
                  type: object
                  description: "What is being changed"
                  required:
                    - kind
                    - name
                  properties:
                    kind:
                      type: string
                      description: "Resource kind"
                      enum:
                        - Agent
                        - Memory
                        - Umwelt
                        - Pheromone
                        - Proposal
                        - ConfigMap
                        - Secret
                        - File
                    name:
                      type: string
                      description: "Resource name or file path"
                    namespace:
                      type: string
                      description: "Resource namespace (for K8s resources)"
                proposer:
                  type: string
                  description: "Agent or user proposing the change"
                description:
                  type: string
                  description: "Human-readable description of the change"
                rationale:
                  type: string
                  description: "Why this change is needed"
                magnitude:
                  type: object
                  description: "Scope of the change (affects risk calculation)"
                  properties:
                    linesAdded:
                      type: integer
                      description: "Lines of code added"
                      minimum: 0
                    linesRemoved:
                      type: integer
                      description: "Lines of code removed"
                      minimum: 0
                    filesChanged:
                      type: integer
                      description: "Number of files changed"
                      minimum: 0
                    testsAdded:
                      type: integer
                      description: "Number of tests added (reduces risk)"
                      minimum: 0
                    testsRemoved:
                      type: integer
                      description: "Number of tests removed (increases risk)"
                      minimum: 0
                reviewRequirements:
                  type: object
                  description: "What review is needed"
                  properties:
                    autoMerge:
                      type: boolean
                      description: "Allow auto-merge if risk is below threshold"
                      default: true
                    requiredApprovers:
                      type: integer
                      description: "Minimum approvers required"
                      minimum: 0
                      default: 0
                    requiredReviewers:
                      type: array
                      description: "Specific reviewers required (agent genera or usernames)"
                      items:
                        type: string
                    tGentValidation:
                      type: boolean
                      description: "Require T-gent test validation"
                      default: true
                riskBudget:
                  type: object
                  description: "Risk budget constraints"
                  properties:
                    maxCumulativeRisk:
                      type: number
                      description: "Maximum cumulative risk allowed"
                      minimum: 0
                      maximum: 1
                      default: 0.3
                    velocityWindow:
                      type: string
                      description: "Time window for velocity calculation"
                      default: "1h"
                    resetOnApproval:
                      type: boolean
                      description: "Reset velocity penalty on human approval"
                      default: true
                ttlSeconds:
                  type: integer
                  description: "Auto-expire proposal after this many seconds"
                  minimum: 60
                  default: 86400
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: "Current proposal phase"
                  enum:
                    - Pending       # Awaiting risk calculation
                    - Reviewing     # Under review (human or T-gent)
                    - Approved      # Approved, awaiting execution
                    - Rejected      # Rejected (risk too high or review failed)
                    - Merged        # Successfully applied
                    - Expired       # TTL expired
                    - Superseded    # Replaced by another proposal
                riskAssessment:
                  type: object
                  description: "Calculated risk metrics"
                  properties:
                    baseRisk:
                      type: number
                      description: "Inherent risk of change type (0.0-1.0)"
                    velocityPenalty:
                      type: number
                      description: "Penalty from recent changes (0.0+)"
                    magnitudeFactor:
                      type: number
                      description: "Scope multiplier (1.0+)"
                    testCoverage:
                      type: number
                      description: "Test coverage factor (0.5-1.0)"
                    cumulativeRisk:
                      type: number
                      description: "Final calculated risk"
                    riskLevel:
                      type: string
                      description: "Human-readable risk level"
                      enum:
                        - LOW        # 0.0-0.2: auto-merge eligible
                        - MEDIUM     # 0.2-0.5: needs one approval
                        - HIGH       # 0.5-0.8: needs multiple approvals
                        - CRITICAL   # 0.8-1.0: needs human override
                    calculatedAt:
                      type: string
                      format: date-time
                      description: "When risk was calculated"
                approvals:
                  type: array
                  description: "Approval history"
                  items:
                    type: object
                    properties:
                      approver:
                        type: string
                        description: "Who approved (agent or user)"
                      approvedAt:
                        type: string
                        format: date-time
                      comment:
                        type: string
                        description: "Optional approval comment"
                rejections:
                  type: array
                  description: "Rejection history"
                  items:
                    type: object
                    properties:
                      rejector:
                        type: string
                        description: "Who rejected"
                      rejectedAt:
                        type: string
                        format: date-time
                      reason:
                        type: string
                        description: "Rejection reason"
                tGentValidation:
                  type: object
                  description: "T-gent test validation results"
                  properties:
                    requested:
                      type: boolean
                      description: "Was T-gent validation requested"
                    pheromoneEmitted:
                      type: string
                      description: "Name of REVIEW_REQUEST pheromone"
                    result:
                      type: string
                      description: "Validation result"
                      enum:
                        - PENDING
                        - PASSED
                        - FAILED
                        - SKIPPED
                    testsPassed:
                      type: integer
                      description: "Number of tests passed"
                    testsFailed:
                      type: integer
                      description: "Number of tests failed"
                    validatedAt:
                      type: string
                      format: date-time
                    report:
                      type: string
                      description: "T-gent validation report"
                executionResult:
                  type: object
                  description: "Result of executing the change"
                  properties:
                    success:
                      type: boolean
                    executedAt:
                      type: string
                      format: date-time
                    executedBy:
                      type: string
                      description: "Agent that executed the change"
                    output:
                      type: string
                      description: "Execution output/logs"
                    rollbackAvailable:
                      type: boolean
                      description: "Can this change be rolled back"
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Type
          type: string
          jsonPath: .spec.changeType
        - name: Target
          type: string
          jsonPath: .spec.target.name
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Risk
          type: number
          jsonPath: .status.riskAssessment.cumulativeRisk
          priority: 0
        - name: Level
          type: string
          jsonPath: .status.riskAssessment.riskLevel
        - name: Proposer
          type: string
          jsonPath: .spec.proposer
          priority: 1
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
