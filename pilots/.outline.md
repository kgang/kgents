# WASM Survivors — Run 028 Architecture Outline

**Run**: 028 | **Refactor Target**: Enemy Pattern System
**Updated**: 2025-12-27T19:56:00 | **Phase**: BUILD

---

## Design Decisions (DREAM Phase Complete)

| DD | Title | Status |
|----|-------|--------|
| DD-21 | Pattern-Based Enemy Behaviors | ✅ Locked |
| DD-22 | Telegraph Visual System | ✅ Locked |
| DD-23 | Attack Timing Constants | ✅ Locked |
| DD-24 | Spitter Enemy Type | ✅ Locked |

---

## Enemy Type Specifications

### Shambler (Basic)
- **Behavior**: Chase → LUNGE when within 30px
- **Telegraph**: Red glow + scale 1.2x for 300ms
- **Attack**: Dash 50px toward player
- **Recovery**: 500ms pause
- **Skill Check**: Sidestep during wind-up

### Rusher (Fast)
- **Behavior**: Chase → CHARGE when within 150px
- **Telegraph**: Wind-up 400ms + orange line indicator
- **Attack**: Dash 200px at 3x speed
- **Recovery**: 800ms stun if miss, 300ms if hit
- **Skill Check**: Perpendicular dodge

### Spitter (NEW)
- **Behavior**: Keep distance (100-150px) → AIM → FIRE
- **Telegraph**: Red aim laser for 500ms
- **Attack**: Purple projectile at 350px/s, destroyable
- **Recovery**: 2000ms cooldown
- **Skill Check**: Strafe during aim, or shoot projectile

### Tank
- **Behavior**: Chase → STOMP when within 50px
- **Telegraph**: Raise up 600ms + ground circle
- **Attack**: AoE 60px radius, 20 damage
- **Recovery**: 1000ms vulnerability
- **Skill Check**: Exit radius during wind-up

### Boss
- **Behavior**: COMBO PATTERN (3 phases)
- Phase 1: CHARGE (250px)
- Phase 2: STOMP (80px radius)
- Phase 3: BARRAGE (5 projectiles)
- **Skill Check**: Full pattern mastery

---

## State Machine Architecture

```
         ┌──────────┐
         │  CHASE   │ ◄─────────────────────────────┐
         └────┬─────┘                               │
              │ in attack range                     │
              ▼                                     │
         ┌──────────┐                               │
         │TELEGRAPH │ (300-800ms based on type)     │
         └────┬─────┘                               │
              │ timer expires                       │
              ▼                                     │
         ┌──────────┐                               │
         │  ATTACK  │ (execute attack)              │
         └────┬─────┘                               │
              │ attack complete                     │
              ▼                                     │
         ┌──────────┐                               │
         │ RECOVERY │ (500-2000ms vulnerability) ───┘
         └──────────┘

Special: Spitter can enter FLEE state if player too close
```

---

## Timing Constants (DD-23)

```typescript
const ENEMY_PATTERNS = {
  basic: {
    attackRange: 30,
    telegraphMs: 300,
    attackMs: 100,
    recoveryMs: 500,
    attackType: 'lunge',
    lungeDistance: 50,
  },
  fast: {
    attackRange: 150,
    telegraphMs: 400,
    attackMs: 300,
    recoveryMs: 800,
    attackType: 'charge',
    chargeDistance: 200,
    chargeSpeedMultiplier: 3,
  },
  spitter: {
    preferredRange: { min: 100, max: 150 },
    telegraphMs: 500,
    attackMs: 50,
    recoveryMs: 2000,
    attackType: 'projectile',
    projectileSpeed: 350,
    projectileDamage: 8,
  },
  tank: {
    attackRange: 50,
    telegraphMs: 600,
    attackMs: 200,
    recoveryMs: 1000,
    attackType: 'stomp',
    stompRadius: 60,
    stompDamage: 20,
  },
  boss: {
    attackRange: 80,
    telegraphMs: 800,
    recoveryMs: 500,
    attackType: 'combo',
    comboPhases: ['charge', 'stomp', 'barrage'],
  },
};
```

---

## Telegraph Visual System (DD-22)

| Attack Type | Visual | Color |
|-------------|--------|-------|
| Lunge | Enemy glows + scales 1.2x | #FF3366 (red) |
| Charge | Line from enemy to target | #FF8800 (orange) |
| Stomp | Ground circle marker | #FF3366 (red) |
| Projectile | Aim laser | #8844FF (purple) |

---

## Implementation Files

### NEW: systems/enemies.ts
```typescript
// Enemy behavior state machine
export interface EnemyBehavior {
  state: 'chase' | 'flee' | 'telegraph' | 'attack' | 'recovery';
  stateTimer: number;
  attackData: AttackData | null;
}

export interface AttackData {
  type: 'lunge' | 'charge' | 'stomp' | 'projectile';
  direction?: Vector2;
  targetPosition?: Vector2;
  radius?: number;
  progress?: number;  // 0-1 for animation
}

export function updateEnemyBehavior(
  enemy: Enemy,
  player: Player,
  deltaTime: number
): Enemy;

export function getEnemyTelegraph(enemy: Enemy): TelegraphVisual | null;

export function processEnemyAttack(
  enemy: Enemy,
  player: Player
): { damage: number; position: Vector2 } | null;
```

### UPDATE: spawn.ts
- Add 'spitter' to EnemyType union
- Initialize behavior state on createEnemy()
- Add Spitter to wave configuration

### UPDATE: physics.ts
- Call updateEnemyBehavior() in physics loop
- Handle charge/lunge movement in attack state
- Separate attack damage from contact damage

### UPDATE: GameCanvas.tsx
- Add renderTelegraphs() function
- Draw ground markers, aim lasers, charge lines
- Progress-based animation

### UPDATE: useGameLoop.ts
- Process enemy attacks as damage events
- Add attack collision detection

---

## Build Phase Progress

| Iteration | Focus | Status |
|-----------|-------|--------|
| 4 | Core state machine + behavior | ⏳ Starting |
| 5 | Attack implementation | ⏳ Pending |
| 6 | Visual polish + sound | ⏳ Pending |
| 7 | Integration + .build.ready | ⏳ Pending |

---

## Success Criteria

1. **Death Attribution**: Player names the attack that killed them
2. **Pattern Learning**: Same enemy = same pattern every time
3. **Skill Expression**: Dodging telegraphed attacks feels rewarding
4. **Visual Clarity**: Telegraphs visible in chaos

---

*"Every enemy is a question. Skilled players know the answers."*
