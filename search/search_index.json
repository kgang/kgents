{"config":{"lang":["en"],"separator":"[\\s\\-,:!=\\[\\]()\"/]+|(?!\\b)(?=[A-Z][a-z])|\\.(?!\\d)|&[lg]t;","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"api-quickstart/","title":"API Quickstart Guide","text":"<p>\"Your first API call in 5 minutes.\"</p> <p>This guide gets you from zero to making your first kgents API call.</p>"},{"location":"api-quickstart/#overview","title":"Overview","text":"<p>The kgents SaaS API provides: - AGENTESE: Invoke semantic paths for agent interactions - K-gent Sessions: Conversational sessions with the K-gent persona</p> <p>Base URL: <code>https://api.kgents.io/v1</code> (or your self-hosted instance)</p>"},{"location":"api-quickstart/#authentication","title":"Authentication","text":"<p>All API requests require an API key in the <code>X-API-Key</code> header.</p> <pre><code>curl -H \"X-API-Key: kg_your_key_here\" https://api.kgents.io/v1/health\n</code></pre>"},{"location":"api-quickstart/#api-key-format","title":"API Key Format","text":"<p>Keys follow the format: <code>kg_{prefix}_{secret}</code> - <code>kg_</code> - Required prefix - <code>{prefix}</code> - 5-character identifier - <code>{secret}</code> - Random secret (never share this!)</p>"},{"location":"api-quickstart/#scopes","title":"Scopes","text":"<p>API keys have scopes that control access: | Scope | Permissions | |-------|-------------| | <code>read</code> | Query sessions, resolve paths, list affordances | | <code>write</code> | Create sessions, send messages, invoke paths | | <code>admin</code> | Manage API keys, tenant settings |</p>"},{"location":"api-quickstart/#quick-start-k-gent-session","title":"Quick Start: K-gent Session","text":""},{"location":"api-quickstart/#1-create-a-session","title":"1. Create a Session","text":"<pre><code>curl -X POST https://api.kgents.io/v1/kgent/sessions \\\n  -H \"X-API-Key: kg_your_key_here\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"title\": \"My First Session\",\n    \"mode\": \"reflect\"\n  }'\n</code></pre> <p>Response: <pre><code>{\n  \"id\": \"550e8400-e29b-41d4-a716-446655440000\",\n  \"tenant_id\": \"...\",\n  \"title\": \"My First Session\",\n  \"agent_type\": \"kgent\",\n  \"status\": \"active\",\n  \"message_count\": 0,\n  \"tokens_used\": 0,\n  \"created_at\": \"2025-12-14T...\"\n}\n</code></pre></p>"},{"location":"api-quickstart/#2-send-a-message","title":"2. Send a Message","text":"<pre><code>curl -X POST https://api.kgents.io/v1/kgent/sessions/{session_id}/messages \\\n  -H \"X-API-Key: kg_your_key_here\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"message\": \"What patterns am I avoiding?\",\n    \"stream\": false\n  }'\n</code></pre> <p>Response: <pre><code>{\n  \"id\": \"...\",\n  \"session_id\": \"550e8400-...\",\n  \"role\": \"assistant\",\n  \"content\": \"That's an interesting question to explore...\",\n  \"tokens_used\": 150,\n  \"created_at\": \"2025-12-14T...\"\n}\n</code></pre></p>"},{"location":"api-quickstart/#3-get-message-history","title":"3. Get Message History","text":"<pre><code>curl https://api.kgents.io/v1/kgent/sessions/{session_id}/messages \\\n  -H \"X-API-Key: kg_your_key_here\"\n</code></pre>"},{"location":"api-quickstart/#quick-start-agentese","title":"Quick Start: AGENTESE","text":"<p>AGENTESE is a semantic path system for agent interactions.</p>"},{"location":"api-quickstart/#path-format","title":"Path Format","text":"<pre><code>{context}.{entity}.{aspect}\n</code></pre> <p>Contexts: - <code>world</code> - External entities - <code>self</code> - Internal state (soul, memory) - <code>concept</code> - Abstract definitions - <code>void</code> - Entropy/randomness - <code>time</code> - Temporal operations</p>"},{"location":"api-quickstart/#invoke-a-path","title":"Invoke a Path","text":"<pre><code>curl -X POST https://api.kgents.io/v1/agentese/invoke \\\n  -H \"X-API-Key: kg_your_key_here\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"path\": \"self.soul.challenge\",\n    \"observer\": {\n      \"name\": \"developer\",\n      \"archetype\": \"developer\"\n    },\n    \"kwargs\": {\n      \"input\": \"My startup idea\"\n    }\n  }'\n</code></pre>"},{"location":"api-quickstart/#resolve-path-info","title":"Resolve Path Info","text":"<pre><code>curl \"https://api.kgents.io/v1/agentese/resolve?path=self.soul\" \\\n  -H \"X-API-Key: kg_your_key_here\"\n</code></pre>"},{"location":"api-quickstart/#list-affordances","title":"List Affordances","text":"<pre><code>curl \"https://api.kgents.io/v1/agentese/affordances?path=self.soul&amp;archetype=developer\" \\\n  -H \"X-API-Key: kg_your_key_here\"\n</code></pre>"},{"location":"api-quickstart/#dialogue-modes","title":"Dialogue Modes","text":"<p>K-gent supports different dialogue modes:</p> Mode Description <code>reflect</code> Thoughtful introspection <code>advise</code> Practical guidance <code>challenge</code> Dialectic pushback <code>explore</code> Open-ended exploration <p>Set mode when creating a session or per-message: <pre><code>{\"message\": \"...\", \"mode\": \"challenge\", \"stream\": false}\n</code></pre></p>"},{"location":"api-quickstart/#streaming-responses","title":"Streaming Responses","text":"<p>Set <code>stream: true</code> to receive Server-Sent Events:</p> <pre><code>curl -X POST https://api.kgents.io/v1/kgent/sessions/{id}/messages \\\n  -H \"X-API-Key: kg_your_key_here\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"message\": \"Tell me a story\", \"stream\": true}'\n</code></pre> <p>Events: - <code>event: chunk</code> - Partial response text - <code>event: complete</code> - Final message with metadata - <code>event: error</code> - Error occurred</p>"},{"location":"api-quickstart/#error-handling","title":"Error Handling","text":"Status Meaning 400 Bad request (invalid path, mode, etc.) 401 Invalid or missing API key 403 Insufficient scope 404 Resource not found 422 Validation error 429 Rate limit exceeded <p>Error response format: <pre><code>{\n  \"detail\": \"Error description\"\n}\n</code></pre></p>"},{"location":"api-quickstart/#rate-limits","title":"Rate Limits","text":"<p>Limits depend on your subscription tier:</p> Tier Requests/Day FREE 100 PRO 1,000 ENTERPRISE 10,000+ <p>Rate limit headers: - <code>X-RateLimit-Limit</code>: Max requests - <code>X-RateLimit-Remaining</code>: Remaining requests - <code>X-RateLimit-Reset</code>: Reset timestamp</p>"},{"location":"api-quickstart/#python-sdk-example","title":"Python SDK Example","text":"<pre><code>import httpx\n\nAPI_KEY = \"kg_your_key_here\"\nBASE_URL = \"https://api.kgents.io/v1\"\n\nasync def main():\n    async with httpx.AsyncClient() as client:\n        # Create session\n        resp = await client.post(\n            f\"{BASE_URL}/kgent/sessions\",\n            headers={\"X-API-Key\": API_KEY},\n            json={\"title\": \"Python Session\"}\n        )\n        session = resp.json()\n\n        # Send message\n        resp = await client.post(\n            f\"{BASE_URL}/kgent/sessions/{session['id']}/messages\",\n            headers={\"X-API-Key\": API_KEY},\n            json={\"message\": \"Hello!\", \"stream\": False}\n        )\n        print(resp.json()[\"content\"])\n\nimport asyncio\nasyncio.run(main())\n</code></pre>"},{"location":"api-quickstart/#next-steps","title":"Next Steps","text":"Resource Description OpenAPI Spec Full API specification AGENTESE Guide Deep dive into semantic paths CLI Reference Command-line interface <p>\"There is no view from nowhere. Every observation shapes reality.\"</p>"},{"location":"architecture-overview/","title":"Architecture Overview","text":"<p>\"Agents are morphisms. Functors lift them. Polynomials generalize them. Operads compose them.\"</p> <p>This document provides a comprehensive overview of the kgents architecture.</p>"},{"location":"architecture-overview/#table-of-contents","title":"Table of Contents","text":"<ol> <li>The Three Pillars</li> <li>Agent Categories</li> <li>The Functor System</li> <li>Polynomial Architecture</li> <li>The Meta-Construction System</li> <li>Agent Synergy Patterns</li> <li>AGENTESE Runtime</li> <li>Infrastructure Layer</li> <li>Metabolism (Entropy System)</li> <li>Directory Structure</li> <li>Architectural Decisions</li> </ol>"},{"location":"architecture-overview/#the-three-pillars","title":"The Three Pillars","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        THE ALETHIC TRIAD                         \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502     NUCLEUS     \u2502      HALO       \u2502         PROJECTOR           \u2502\n\u2502   Pure Logic    \u2502  Capabilities   \u2502    Categorical Compiler     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Agent[A, B]     \u2502 @Stateful       \u2502 LocalProjector              \u2502\n\u2502 invoke(a) \u2192 b   \u2502 @Soulful        \u2502 K8sProjector                \u2502\n\u2502                 \u2502 @Observable     \u2502                             \u2502\n\u2502                 \u2502 @Streamable     \u2502                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture-overview/#1-nucleus-pure-logic","title":"1. Nucleus (Pure Logic)","text":"<p>The irreducible transform. Every agent has a nucleus\u2014the <code>invoke(a) \u2192 b</code> function that defines what it does.</p>"},{"location":"architecture-overview/#2-halo-capabilities","title":"2. Halo (Capabilities)","text":"<p>Declared capabilities that wrap the nucleus. Decorators like <code>@Stateful</code>, <code>@Soulful</code>, <code>@Observable</code>, <code>@Streamable</code> declare what the agent needs without implementing it.</p>"},{"location":"architecture-overview/#3-projector-compiler","title":"3. Projector (Compiler)","text":"<p>The categorical compiler that makes potential actual. Takes Halo declarations and compiles them to runnable code (LocalProjector) or K8s manifests (K8sProjector).</p>"},{"location":"architecture-overview/#agent-categories","title":"Agent Categories","text":""},{"location":"architecture-overview/#by-capability-archetypes","title":"By Capability (Archetypes)","text":"Archetype Capabilities Use Case Kappa All 4 Production services Lambda Observable only Lightweight processors Delta Stateful + Observable Data handlers"},{"location":"architecture-overview/#by-function-genera","title":"By Function (Genera)","text":"Genus Letter Role Polynomial Alethic A Architecture, functors <code>ALETHIC_AGENT</code> Category C Composition primitives \u2014 Data D State, memory <code>MEMORY_POLYNOMIAL</code> Evolution E Thermodynamic optimization <code>EVOLUTION_POLYNOMIAL</code> Flux Flux Streams, events \u2014 Interface I TUI, semantic fields \u2014 Kent K Persona, governance <code>SOUL_POLYNOMIAL</code> Lattice L Semantic registry \u2014 Testing T Types I-V \u2014 Utility U Tools, MCP \u2014"},{"location":"architecture-overview/#the-functor-system","title":"The Functor System","text":""},{"location":"architecture-overview/#universal-functor-protocol-ad-001","title":"Universal Functor Protocol (AD-001)","text":"<p>Every transformation in kgents is a functor:</p> <pre><code>class UniversalFunctor(Generic[F]):\n    @staticmethod\n    def lift(agent: Agent[A, B]) -&gt; Agent[F[A], F[B]]: ...\n</code></pre>"},{"location":"architecture-overview/#built-in-functors","title":"Built-in Functors","text":"Functor Effect Use Case <code>Maybe</code> Handle optional values Nullable results <code>Either</code> Handle success/error Error propagation <code>List</code> Process collections Batch operations <code>Fix</code> Add retries Resilience <code>Logged</code> Add observability Debugging <code>Soul</code> Add K-gent governance Ethical alignment <code>Flux</code> Enable streaming Real-time processing <code>Observer</code> Add telemetry Monitoring <code>State</code> Add memory Stateful computation"},{"location":"architecture-overview/#functor-composition","title":"Functor Composition","text":"<p>Functors compose into stacks:</p> <pre><code>stack = compose_functors(LoggedFunctor, FixFunctor, SoulFunctor)\nresilient_agent = stack(my_agent)\n</code></pre>"},{"location":"architecture-overview/#polynomial-architecture","title":"Polynomial Architecture","text":"<p>\"Agent[A, B] \u2245 A \u2192 B is a lie. Real agents have modes.\"</p> <p>The polynomial functor architecture (AD-002) captures state-dependent behavior\u2014agents that accept different inputs based on their internal state.</p>"},{"location":"architecture-overview/#the-core-insight","title":"The Core Insight","text":"<p>Traditional agents are functions: given input A, produce output B. But real agents have modes\u2014internal states that determine what inputs are valid and how to respond.</p> <pre><code>Traditional:  Agent[A, B] \u2245 A \u2192 B           (stateless function)\nPolynomial:   PolyAgent[S, A, B] \u2245 S \u2192 (A \u2192 (S, B))  (state machine)\n</code></pre>"},{"location":"architecture-overview/#polyagent-protocol","title":"PolyAgent Protocol","text":"<pre><code>@dataclass(frozen=True)\nclass PolyAgent(Generic[S, A, B]):\n    \"\"\"\n    Agent as polynomial functor.\n\n    P(y) = \u03a3_{s \u2208 positions} y^{directions(s)}\n\n    Following Spivak's \"Polynomial Functors: A Mathematical Theory of Interaction\"\n    \"\"\"\n    name: str\n    positions: FrozenSet[S]                    # Valid states (modes)\n    directions: Callable[[S], FrozenSet[A]]    # State-dependent valid inputs\n    transition: Callable[[S, A], tuple[S, B]]  # State \u00d7 Input \u2192 (NewState, Output)\n\n    def invoke(self, state: S, input: A) -&gt; tuple[S, B]:\n        \"\"\"Execute one step of the dynamical system.\"\"\"\n        assert state in self.positions\n        assert input in self.directions(state)\n        return self.transition(state, input)\n</code></pre> <p>Key insight: <code>Agent[A, B] \u2245 PolyAgent[Unit, A, B]</code>\u2014traditional agents embed as single-state polynomials.</p>"},{"location":"architecture-overview/#polynomial-agent-genera","title":"Polynomial Agent Genera","text":"Genus Polynomial States Description A-gent <code>ALETHIC_AGENT</code> GROUNDING \u2192 DELIBERATING \u2192 JUDGING \u2192 SYNTHESIZING Dialectical reasoning pipeline K-gent <code>SOUL_POLYNOMIAL</code> 7 eigenvector contexts Persona-informed governance D-gent <code>MEMORY_POLYNOMIAL</code> IDLE, LOADING, STORING, QUERYING, FORGETTING State persistence E-gent <code>EVOLUTION_POLYNOMIAL</code> 8-phase thermodynamic cycle Evolutionary optimization"},{"location":"architecture-overview/#example-k-gent-as-polynomial","title":"Example: K-gent as Polynomial","text":"<pre><code>SOUL_POLYNOMIAL = PolyAgent(\n    name=\"SoulPolynomial\",\n    positions=frozenset({\n        \"aesthetic\", \"categorical\", \"gratitude\",\n        \"heterarchy\", \"generativity\", \"joy\", \"ethics\"\n    }),\n    directions=lambda mode: {\n        \"aesthetic\": frozenset({AestheticQuery, TasteChallenge}),\n        \"categorical\": frozenset({StructureQuery, MorphismRequest}),\n        \"gratitude\": frozenset({TitheRequest, AppreciationQuery}),\n        # ... per-mode valid inputs\n    }[mode],\n    transition=soul_transition\n)\n</code></pre>"},{"location":"architecture-overview/#composition-via-wiring-diagrams","title":"Composition via Wiring Diagrams","text":"<p>Polynomial agents compose via wiring diagrams\u2014graphical representations of how outputs connect to inputs:</p> <pre><code>from agents.poly import sequential, parallel, WiringDiagram\n\n# Sequential: soul \u2192 alethic\ncomposed = sequential(SOUL_POLYNOMIAL, ALETHIC_AGENT)\n\n# Parallel: run soul and memory concurrently\npar = parallel(SOUL_POLYNOMIAL, MEMORY_POLYNOMIAL)\n\n# Complex wiring\ndiagram = WiringDiagram()\ndiagram.add_box(\"soul\", SOUL_POLYNOMIAL)\ndiagram.add_box(\"memory\", MEMORY_POLYNOMIAL)\ndiagram.wire(\"soul.output\", \"memory.input\")\ncomposed = diagram.compile()\n</code></pre>"},{"location":"architecture-overview/#the-meta-construction-system","title":"The Meta-Construction System","text":"<p>\"Don't build agents. Build the machine that builds agents.\"</p> <p>The meta-construction system (AD-003) replaces enumeration with generation. Instead of listing 600+ CLI commands, we define the grammar that generates them.</p>"},{"location":"architecture-overview/#the-three-layers","title":"The Three Layers","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     META-CONSTRUCTION SYSTEM                             \u2502\n\u2502                                                                          \u2502\n\u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                     \u2502\n\u2502    \u2502PRIMITIVES\u2502  +   \u2502 OPERADS  \u2502  +   \u2502 SHEAVES  \u2502  =  EMERGENCE       \u2502\n\u2502    \u2502(atoms)   \u2502      \u2502(grammar) \u2502      \u2502(gluing)  \u2502                     \u2502\n\u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                     \u2502\n\u2502         \u2502                 \u2502                 \u2502                            \u2502\n\u2502         \u25bc                 \u25bc                 \u25bc                            \u2502\n\u2502    Base agents      Composition       Local \u2192 Global                    \u2502\n\u2502    Types            rules             behavior                           \u2502\n\u2502    Operations       Wiring            Emergence                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture-overview/#layer-1-primitives-13-atoms","title":"Layer 1: Primitives (13 Atoms)","text":"<p>The irreducible polynomial agents from which all others compose:</p> Primitive Category Purpose <code>id</code> Bootstrap Identity morphism <code>ground</code> Bootstrap Reality anchoring <code>judge</code> Bootstrap Evaluation <code>contradict</code> Bootstrap Find tensions <code>sublate</code> Bootstrap Hegelian synthesis <code>compose</code> Bootstrap Sequential composition <code>fix</code> Bootstrap Retry/recursion <code>manifest</code> Perception Observer-dependent projection <code>witness</code> Perception Trace recording <code>lens</code> Perception Focus/selection <code>sip</code> Entropy Draw from Accursed Share <code>tithe</code> Entropy Pay for order <code>define</code> Entropy Autopoiesis"},{"location":"architecture-overview/#layer-2-operads-composition-grammar","title":"Layer 2: Operads (Composition Grammar)","text":"<p>Operads define what compositions are valid:</p> <pre><code>AGENT_OPERAD = Operad(\n    name=\"AgentOperad\",\n    operations={\n        \"seq\": Operation(arity=2, signature=\"Agent[A,B] \u00d7 Agent[B,C] \u2192 Agent[A,C]\"),\n        \"par\": Operation(arity=2, signature=\"Agent[A,B] \u00d7 Agent[A,C] \u2192 Agent[A,(B,C)]\"),\n        \"branch\": Operation(arity=3, signature=\"Pred[A] \u00d7 Agent[A,B] \u00d7 Agent[A,B] \u2192 Agent[A,B]\"),\n        \"fix\": Operation(arity=2, signature=\"Pred[B] \u00d7 Agent[A,B] \u2192 Agent[A,B]\"),\n        \"trace\": Operation(arity=1, signature=\"Agent[A,B] \u2192 Agent[A,B] (with observation)\"),\n    },\n    laws=[\n        \"seq(seq(a, b), c) = seq(a, seq(b, c))\",  # Associativity\n        \"seq(id, a) = a = seq(a, id)\",             # Identity\n    ]\n)\n</code></pre> <p>Domain-specific operads extend the base:</p> <pre><code>SOUL_OPERAD = Operad(\n    name=\"SoulOperad\",\n    operations=AGENT_OPERAD.operations | {\n        \"introspect\": Operation(arity=0, compose=introspect_compose),\n        \"shadow\": Operation(arity=1, compose=shadow_compose),\n        \"dialectic\": Operation(arity=2, compose=dialectic_compose),\n    }\n)\n</code></pre>"},{"location":"architecture-overview/#layer-3-sheaves-emergence","title":"Layer 3: Sheaves (Emergence)","text":"<p>Sheaves enable gluing local behaviors into global behavior:</p> <pre><code>SOUL_SHEAF = AgentSheaf(\n    contexts={\"aesthetic\", \"categorical\", \"gratitude\", \"heterarchy\", \"generativity\", \"joy\"},\n    overlap=eigenvector_overlap\n)\n\n# Local agents per context\nlocal_souls = {\n    \"aesthetic\": aesthetic_soul_agent,\n    \"categorical\": categorical_soul_agent,\n    \"joy\": joy_soul_agent,\n}\n\n# Glue into emergent global soul\nKENT_SOUL = SOUL_SHEAF.glue(local_souls)\n</code></pre> <p>The global agent has emergent behavior that no local agent has alone.</p>"},{"location":"architecture-overview/#the-two-paths","title":"The Two Paths","text":"<p>Both careful design and chaotic happenstance produce valid compositions:</p> <pre><code># Path 1: Careful Design (intentional)\npipeline = SOUL_OPERAD.compose([\"ground\", \"introspect\", \"shadow\", \"dialectic\"])\n\n# Path 2: Chaotic Happenstance (void.* entropy)\npipeline = await void.compose.sip(\n    primitives=PRIMITIVES,\n    grammar=SOUL_OPERAD,\n    entropy=0.7\n)\n</code></pre> <p>The operad guarantees validity. Entropy introduces variation.</p>"},{"location":"architecture-overview/#agent-synergy-patterns","title":"Agent Synergy Patterns","text":"<p>Agents combine in powerful ways. These patterns emerge from the categorical structure.</p>"},{"location":"architecture-overview/#synergy-matrix","title":"Synergy Matrix","text":"<pre><code>         K    H    U    P    J    I    M    N    A    B    E    O\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  K \u2502  \u00b7   \u2b50   \u25cb    \u25cb    \u25cb   \u2b50   \u25cb   \u2b50   \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  H \u2502 \u2b50    \u00b7   \u25cb    \u25cb    \u25cb    \u25cb   \u25cb   \u2b50   \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  U \u2502  \u25cb    \u25cb    \u00b7   \u2b50   \u2b50  \u2b50   \u25cb    \u25cb   \u25cb    \u25cb    \u25cb   \u2b50   \u2502\n  P \u2502  \u25cb    \u25cb   \u2b50    \u00b7   \u2b50   \u25cb   \u25cb    \u25cb   \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  I \u2502 \u2b50    \u25cb   \u2b50    \u25cb    \u25cb    \u00b7   \u25cb    \u25cb   \u25cb   \u2b50  \u2b50  \u2b50   \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u2b50 = High synergy    \u25cb = Moderate synergy    \u00b7 = Self\n</code></pre>"},{"location":"architecture-overview/#top-synergy-patterns","title":"Top Synergy Patterns","text":"Pattern Agents Emergent Capability Soul Introspection K + H Soul-aware shadow detection, personality-informed dialectics Self-Healing Pipeline U + P + J Parse \u2192 Classify \u2192 Retry/Collapse gracefully Living Visualization I + Flux Real-time breathing dashboards Memory as Story M + N Autobiographical system history Soul-Governed Approval K + Judge Ethical judgment informed by personality"},{"location":"architecture-overview/#implementation-pattern","title":"Implementation Pattern","text":"<pre><code># K-gent + H-gent synergy example\nkgent = KgentAgent.from_context(ctx)\neigenvectors = await kgent.get_eigenvectors()\n\n# H-jung analyzes through soul lens\njung = JungAgent()\nshadow = await jung.analyze_shadow(eigenvectors)\n# Result: Soul-aware shadow analysis\n</code></pre>"},{"location":"architecture-overview/#agentese-runtime","title":"AGENTESE Runtime","text":""},{"location":"architecture-overview/#the-five-contexts","title":"The Five Contexts","text":"<pre><code>world.*    \u2014 External (entities, tools)\nself.*     \u2014 Internal (memory, state)\nconcept.*  \u2014 Abstract (platonics, logic)\nvoid.*     \u2014 Accursed Share (entropy)\ntime.*     \u2014 Temporal (traces, forecasts)\n</code></pre>"},{"location":"architecture-overview/#logos-the-invoker","title":"Logos (The Invoker)","text":"<pre><code>from protocols.agentese import Logos\n\nlogos = Logos()\nresult = await logos.invoke(\"self.soul.challenge\", umwelt, \"idea\")\n</code></pre>"},{"location":"architecture-overview/#context-resolvers","title":"Context Resolvers","text":"<p>Each context has a resolver that maps paths to handlers:</p> Resolver Context Examples <code>WorldContextResolver</code> world.* world.tool.invoke, world.entity.manifest <code>SelfContextResolver</code> self.* self.soul.challenge, self.memory.store <code>ConceptContextResolver</code> concept.* concept.functor.lift, concept.type.define <code>VoidContextResolver</code> void.* void.entropy.sip, void.gratitude.tithe <code>TimeContextResolver</code> time.* time.trace.witness, time.forecast.predict"},{"location":"architecture-overview/#observer-dependent-affordances","title":"Observer-Dependent Affordances","text":"<p>The same path yields different results to different observers (AGENTESE polymorphism):</p> <pre><code># Same path, different observers\nawait logos.invoke(\"world.house.manifest\", architect_umwelt)  # \u2192 Blueprint\nawait logos.invoke(\"world.house.manifest\", poet_umwelt)       # \u2192 Metaphor\nawait logos.invoke(\"world.house.manifest\", economist_umwelt)  # \u2192 Appraisal\n</code></pre>"},{"location":"architecture-overview/#infrastructure-layer","title":"Infrastructure Layer","text":""},{"location":"architecture-overview/#cortex-llm-integration","title":"Cortex (LLM Integration)","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              CORTEX                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u2022 LLM client management                 \u2502\n\u2502 \u2022 Cognitive probes (health != HTTP 200) \u2502\n\u2502 \u2022 Token metering                        \u2502\n\u2502 \u2022 Cost tracking                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture-overview/#stigmergy-semantic-field","title":"Stigmergy (Semantic Field)","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502            STIGMERGY                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u2022 Pheromone store (Redis)               \u2502\n\u2502 \u2022 Intensity decay over time             \u2502\n\u2502 \u2022 Agent coordination without coupling   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture-overview/#k-terrarium-k8s-integration","title":"K-Terrarium (K8s Integration)","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502           K-TERRARIUM                    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u2022 CRD-driven deployment                 \u2502\n\u2502 \u2022 Mirror Protocol (observe only)        \u2502\n\u2502 \u2022 Graceful degradation to subprocess    \u2502\n\u2502 \u2022 Live reload development               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture-overview/#metabolism-entropy-system","title":"Metabolism (Entropy System)","text":""},{"location":"architecture-overview/#pressure-dynamics","title":"Pressure Dynamics","text":"<pre><code>             pressure\n                ^\n                |\n    threshold --|-------------- fever trigger\n                |      /\\\n                |     /  \\   /\\\n                |    /    \\_/  \\\n                |   /           \\___\n                +-----------------------&gt; time\n</code></pre>"},{"location":"architecture-overview/#key-concepts","title":"Key Concepts","text":"Concept Description Pressure Accumulates from agent activity Fever Triggers when pressure exceeds threshold Tithe Voluntary pressure discharge (gratitude) Oblique Free creative output during fever Dream LLM-generated creative output (expensive)"},{"location":"architecture-overview/#directory-structure","title":"Directory Structure","text":"<pre><code>impl/claude/\n\u251c\u2500\u2500 agents/              # Agent implementations by genus\n\u2502   \u251c\u2500\u2500 a/              # Alethic (functor registry, archetypes, AlethicAgent)\n\u2502   \u251c\u2500\u2500 c/              # Category (Maybe, Either, Monad)\n\u2502   \u251c\u2500\u2500 d/              # Data (memory, modal scope, MemoryPolynomialAgent)\n\u2502   \u251c\u2500\u2500 e/              # Evolution (EvolutionPolynomialAgent)\n\u2502   \u251c\u2500\u2500 flux/           # Streams (living pipelines)\n\u2502   \u251c\u2500\u2500 i/              # Interface (TUI, widgets, hints)\n\u2502   \u251c\u2500\u2500 k/              # K-gent (persona, SoulPolynomialAgent)\n\u2502   \u251c\u2500\u2500 poly/           # Polynomial agents (PolyAgent, 17 primitives)\n\u2502   \u2502   \u251c\u2500\u2500 protocol.py     # PolyAgent base class\n\u2502   \u2502   \u251c\u2500\u2500 primitives.py   # 13 atomic polynomials\n\u2502   \u2502   \u2514\u2500\u2500 wiring.py       # Wiring diagram composition\n\u2502   \u251c\u2500\u2500 operad/         # Composition grammar\n\u2502   \u2502   \u251c\u2500\u2500 base.py         # Operad, Operation classes\n\u2502   \u2502   \u251c\u2500\u2500 agent_operad.py # Universal agent operad\n\u2502   \u2502   \u2514\u2500\u2500 domain/         # SOUL_OPERAD, PARSE_OPERAD, etc.\n\u2502   \u251c\u2500\u2500 sheaf/          # Emergence\n\u2502   \u2502   \u251c\u2500\u2500 agent_sheaf.py  # AgentSheaf class\n\u2502   \u2502   \u2514\u2500\u2500 soul_sheaf.py   # SOUL_SHEAF, KENT_SOUL\n\u2502   \u2514\u2500\u2500 ...             # Other genera\n\u251c\u2500\u2500 protocols/\n\u2502   \u251c\u2500\u2500 agentese/       # AGENTESE runtime\n\u2502   \u2502   \u251c\u2500\u2500 contexts/       # Five context resolvers\n\u2502   \u2502   \u251c\u2500\u2500 metabolism/     # Entropy, fever\n\u2502   \u2502   \u2514\u2500\u2500 middleware/     # Curator\n\u2502   \u251c\u2500\u2500 cli/            # CLI framework\n\u2502   \u2514\u2500\u2500 terrarium/      # K8s integration\n\u251c\u2500\u2500 infra/\n\u2502   \u251c\u2500\u2500 cortex/         # LLM integration\n\u2502   \u251c\u2500\u2500 stigmergy/      # Pheromone store\n\u2502   \u2514\u2500\u2500 k8s/            # Operators, CRDs\n\u2514\u2500\u2500 shared/             # Capital, costs, budget\n</code></pre>"},{"location":"architecture-overview/#architectural-decisions","title":"Architectural Decisions","text":"AD Decision Rationale AD-001 Universal Functor Mandate All transformations are functors with verified laws AD-002 Polynomial Generalization Agent[A,B] embeds in PolyAgent[S,A,B]; mode-dependent behavior AD-003 Generative Over Enumerative Define operads that generate compositions, not lists of instances \u2014 Spec-first Spec is compression; impl is derivable \u2014 Five contexts only No kitchen-sink anti-pattern \u2014 Graceful degradation Always work, even without K8s \u2014 Personality space LLMs have inherent personality; navigate, don't inject \u2014 Instance isolation Stateful agents use factory patterns to avoid shared state"},{"location":"architecture-overview/#newexperimental","title":"New/Experimental","text":"<ul> <li><code>docs/weekly-summary/index.html</code> \u2014 Operators/observers: weekly forest health dashboard + status snapshots.  </li> <li><code>kgents_ A Next-Generation Agentic Memory Architecture.pdf</code> \u2014 Leadership/partners: narrative framing of memory architecture.  </li> <li><code>Radical Redesign Proposal for the Kgents UI_UX Ecosystem.pdf</code> \u2014 Design/UX: exploratory layout and interaction treatments.  </li> <li><code>Visualization &amp; Interactivity_ A Synthesis (Enhanced with Category Theory &amp; UX Patterns).pdf</code> \u2014 Visualization/education: patterns for interactive explainability.</li> </ul>"},{"location":"architecture-overview/#further-reading","title":"Further Reading","text":"<ul> <li><code>spec/principles.md</code> \u2014 Design principles and architectural decisions</li> <li><code>docs/functor-field-guide.md</code> \u2014 Deep dive into the functor system</li> <li><code>docs/categorical-foundations.md</code> \u2014 Category theory background</li> <li><code>plans/skills/polynomial-agent.md</code> \u2014 How to create polynomial agents</li> <li><code>plans/skills/building-agent.md</code> \u2014 General agent construction guide</li> </ul> <p>\"The architecture is the message.\"</p>"},{"location":"aup-quickstart/","title":"AUP Quick Start Guide","text":"<p>Get started with the AGENTESE Universal Protocol in 5 minutes.</p>"},{"location":"aup-quickstart/#prerequisites","title":"Prerequisites","text":"<pre><code># API endpoint\nexport AUP_BASE_URL=\"http://localhost:8000/api/v1\"\n\n# Your API key (get from admin)\nexport AUP_API_KEY=\"kg_dev_carol\"\n</code></pre>"},{"location":"aup-quickstart/#1-your-first-request-manifest","title":"1. Your First Request: Manifest","text":"<p>See how an entity appears to you:</p> <pre><code>curl -X GET \"$AUP_BASE_URL/world/codebase/manifest\" \\\n  -H \"X-API-Key: $AUP_API_KEY\" \\\n  -H \"X-Observer-Archetype: developer\"\n</code></pre> <p>Response: <pre><code>{\n  \"handle\": \"world.codebase.manifest\",\n  \"result\": {\n    \"modules\": [\"auth\", \"api\", \"core\"],\n    \"test_coverage\": 0.87\n  },\n  \"meta\": {\n    \"observer\": \"developer\",\n    \"span_id\": \"abc123\",\n    \"duration_ms\": 45\n  }\n}\n</code></pre></p>"},{"location":"aup-quickstart/#2-check-your-affordances","title":"2. Check Your Affordances","text":"<p>See what you can do:</p> <pre><code>curl -X GET \"$AUP_BASE_URL/concept/architecture/affordances\" \\\n  -H \"X-API-Key: $AUP_API_KEY\" \\\n  -H \"X-Observer-Archetype: architect\"\n</code></pre> <p>Response: <pre><code>{\n  \"path\": \"concept.architecture\",\n  \"affordances\": [\"manifest\", \"witness\", \"refine\", \"define\", \"spawn\"],\n  \"observer_archetype\": \"architect\"\n}\n</code></pre></p>"},{"location":"aup-quickstart/#3-invoke-an-aspect","title":"3. Invoke an Aspect","text":"<p>Do something with an entity:</p> <pre><code>curl -X POST \"$AUP_BASE_URL/concept/summary/refine\" \\\n  -H \"X-API-Key: $AUP_API_KEY\" \\\n  -H \"X-Observer-Archetype: developer\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"kwargs\": {\n      \"input\": \"This is a long document about microservices...\",\n      \"max_length\": 100\n    }\n  }'\n</code></pre>"},{"location":"aup-quickstart/#4-compose-a-pipeline","title":"4. Compose a Pipeline","text":"<p>Chain multiple operations:</p> <pre><code>curl -X POST \"$AUP_BASE_URL/compose\" \\\n  -H \"X-API-Key: $AUP_API_KEY\" \\\n  -H \"X-Observer-Archetype: developer\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"paths\": [\n      \"world.document.manifest\",\n      \"concept.summary.refine\",\n      \"self.memory.engram\"\n    ]\n  }'\n</code></pre> <p>Response includes pipeline trace: <pre><code>{\n  \"result\": \"engram-789\",\n  \"pipeline_trace\": [\n    {\"path\": \"world.document.manifest\", \"duration_ms\": 23},\n    {\"path\": \"concept.summary.refine\", \"duration_ms\": 156},\n    {\"path\": \"self.memory.engram\", \"duration_ms\": 12}\n  ],\n  \"laws_verified\": [\"identity\", \"associativity\"]\n}\n</code></pre></p>"},{"location":"aup-quickstart/#5-stream-long-operations","title":"5. Stream Long Operations","text":"<p>For real-time responses (SSE):</p> <pre><code>curl -X GET \"$AUP_BASE_URL/self/soul/challenge/stream?challenge=How+should+I+design+this+API\" \\\n  -H \"X-API-Key: $AUP_API_KEY\" \\\n  -H \"X-Observer-Archetype: developer\" \\\n  -H \"Accept: text/event-stream\"\n</code></pre> <p>Events stream as: <pre><code>event: chunk\ndata: {\"type\":\"response\",\"content\":\"Consider\",\"partial\":true}\n\nevent: chunk\ndata: {\"type\":\"response\",\"content\":\" the\",\"partial\":true}\n\nevent: done\ndata: {\"span_id\":\"def456\",\"chunks_count\":47}\n</code></pre></p>"},{"location":"aup-quickstart/#observer-archetypes","title":"Observer Archetypes","text":"Archetype Typical Affordances <code>viewer</code> manifest, witness <code>developer</code> manifest, witness, refine <code>architect</code> manifest, witness, refine, define, spawn <code>admin</code> All affordances <code>agent</code> Depends on agent capabilities"},{"location":"aup-quickstart/#the-five-contexts","title":"The Five Contexts","text":"Context Use For Examples <code>world.*</code> External things <code>world.codebase</code>, <code>world.document</code> <code>self.*</code> Internal state <code>self.soul</code>, <code>self.memory</code> <code>concept.*</code> Abstract ideas <code>concept.summary</code>, <code>concept.justice</code> <code>void.*</code> Creativity <code>void.slop</code>, <code>void.dream</code> <code>time.*</code> History <code>time.trace</code>, <code>time.forecast</code>"},{"location":"aup-quickstart/#error-handling","title":"Error Handling","text":"<p>All errors include helpful context:</p> <pre><code>{\n  \"detail\": {\n    \"error\": \"Affordance 'spawn' not available\",\n    \"code\": \"AFFORDANCE_DENIED\",\n    \"why\": \"Requires architect privileges\",\n    \"suggestion\": \"Use 'manifest' instead or request elevation\",\n    \"available\": [\"manifest\", \"witness\"]\n  }\n}\n</code></pre>"},{"location":"aup-quickstart/#python-example","title":"Python Example","text":"<pre><code>import httpx\n\nclient = httpx.Client(\n    base_url=\"http://localhost:8000/api/v1\",\n    headers={\n        \"X-API-Key\": \"kg_dev_carol\",\n        \"X-Observer-Archetype\": \"developer\",\n    }\n)\n\n# Manifest\nresponse = client.get(\"/world/codebase/manifest\")\ncodebase = response.json()[\"result\"]\n\n# Compose pipeline\nresponse = client.post(\"/compose\", json={\n    \"paths\": [\n        \"world.document.manifest\",\n        \"concept.summary.refine\",\n    ]\n})\nsummary = response.json()[\"result\"]\n\n# Stream with SSE\nwith client.stream(\"GET\", \"/self/soul/challenge/stream\",\n                   params={\"challenge\": \"Help me design this\"}) as r:\n    for line in r.iter_lines():\n        if line.startswith(\"data:\"):\n            print(line[5:])\n</code></pre>"},{"location":"aup-quickstart/#typescript-example","title":"TypeScript Example","text":"<pre><code>const AUP_BASE = \"http://localhost:8000/api/v1\";\nconst headers = {\n  \"X-API-Key\": \"kg_dev_carol\",\n  \"X-Observer-Archetype\": \"developer\",\n};\n\n// Manifest\nconst manifest = await fetch(`${AUP_BASE}/world/codebase/manifest`, { headers })\n  .then(r =&gt; r.json());\n\n// Compose\nconst composition = await fetch(`${AUP_BASE}/compose`, {\n  method: \"POST\",\n  headers: { ...headers, \"Content-Type\": \"application/json\" },\n  body: JSON.stringify({\n    paths: [\"world.document.manifest\", \"concept.summary.refine\"]\n  })\n}).then(r =&gt; r.json());\n\n// Stream (SSE)\nconst eventSource = new EventSource(\n  `${AUP_BASE}/self/soul/challenge/stream?challenge=Help+me`\n);\neventSource.onmessage = (e) =&gt; console.log(JSON.parse(e.data));\n</code></pre>"},{"location":"aup-quickstart/#next-steps","title":"Next Steps","text":"<ul> <li>Full User Journeys - Detailed scenarios</li> <li>API Reference - Complete endpoint documentation</li> <li>AGENTESE Spec - Protocol specification</li> </ul> <p>Need help? Open an issue or ask K-gent: <code>GET /api/v1/self/soul/challenge/stream?challenge=...</code></p>"},{"location":"aup-reference-card/","title":"AUP Reference Card","text":""},{"location":"aup-reference-card/#endpoints","title":"Endpoints","text":"<pre><code>GET  /api/v1/{ctx}/{holon}/manifest        Perceive entity\nGET  /api/v1/{ctx}/{holon}/affordances     List capabilities\nPOST /api/v1/{ctx}/{holon}/{aspect}        Invoke action\nPOST /api/v1/compose                        Chain operations\nGET  /api/v1/{ctx}/{holon}/{aspect}/stream SSE streaming\nPOST /api/v1/verify-laws                    Check category laws\nGET  /api/v1/{ctx}/{holon}/resolve          Path metadata\n</code></pre>"},{"location":"aup-reference-card/#required-headers","title":"Required Headers","text":"<pre><code>X-API-Key: kg_your_key\nX-Observer-Archetype: developer|architect|viewer|admin|agent\nX-Observer-Id: unique-id (optional)\nX-Observer-Capabilities: cap1,cap2 (optional)\n</code></pre>"},{"location":"aup-reference-card/#contexts","title":"Contexts","text":"ctx Domain Examples <code>world</code> External codebase, document, api <code>self</code> Internal soul, memory, config <code>concept</code> Abstract summary, justice, pattern <code>void</code> Entropy slop, dream, chaos <code>time</code> Temporal trace, forecast, schedule"},{"location":"aup-reference-card/#aspects-affordances","title":"Aspects (Affordances)","text":"Aspect Category Description <code>manifest</code> Perception View as observer sees it <code>witness</code> Perception Historical trace <code>affordances</code> Perception What can be done <code>refine</code> Generation Dialectic refinement <code>define</code> Generation Create new entity <code>spawn</code> Generation Create agent instance <code>sip</code> Entropy Draw randomness <code>tithe</code> Entropy Pay for order"},{"location":"aup-reference-card/#observer-archetypes","title":"Observer Archetypes","text":"Archetype Default Affordances <code>viewer</code> manifest, witness, affordances <code>developer</code> + refine <code>architect</code> + define, spawn <code>admin</code> all <code>agent</code> per-agent config"},{"location":"aup-reference-card/#error-codes-http","title":"Error Codes \u2192 HTTP","text":"Code HTTP Meaning <code>PATH_NOT_FOUND</code> 404 Entity doesn't exist <code>AFFORDANCE_DENIED</code> 403 No permission <code>OBSERVER_REQUIRED</code> 401 Missing observer <code>SYNTAX_ERROR</code> 400 Bad path format <code>LAW_VIOLATION</code> 422 Category law broken <code>BUDGET_EXHAUSTED</code> 429 Rate limited"},{"location":"aup-reference-card/#composition","title":"Composition","text":"<pre><code>POST /api/v1/compose\n{\n  \"paths\": [\n    \"world.doc.manifest\",\n    \"concept.summary.refine\",\n    \"self.memory.engram\"\n  ],\n  \"initial_input\": null,\n  \"emit_law_check\": true\n}\n</code></pre> <p>Response includes <code>pipeline_trace</code> and <code>laws_verified</code>.</p>"},{"location":"aup-reference-card/#sse-events","title":"SSE Events","text":"<pre><code>event: chunk\ndata: {\"type\":\"response|thinking\",\"content\":\"...\",\"partial\":bool}\n\nevent: done\ndata: {\"result\":\"...\",\"span_id\":\"...\",\"chunks_count\":N}\n\nevent: error\ndata: {\"code\":\"...\",\"error\":\"...\"}\n</code></pre>"},{"location":"aup-reference-card/#path-format","title":"Path Format","text":"<pre><code>{context}.{holon}.{aspect}\n   \u2502         \u2502        \u2514\u2500\u2500 What to do (manifest, refine, etc.)\n   \u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Entity name\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Domain (world, self, concept, void, time)\n</code></pre>"},{"location":"aup-reference-card/#category-laws","title":"Category Laws","text":"<ol> <li>Identity: <code>Id &gt;&gt; f \u2261 f \u2261 f &gt;&gt; Id</code></li> <li>Associativity: <code>(f &gt;&gt; g) &gt;&gt; h \u2261 f &gt;&gt; (g &gt;&gt; h)</code></li> <li>Observer Polymorphism: Same path, different observer \u2192 different result</li> </ol>"},{"location":"aup-reference-card/#quick-examples","title":"Quick Examples","text":"<pre><code># Manifest\ncurl \"$URL/world/codebase/manifest\" -H \"X-API-Key: $KEY\" -H \"X-Observer-Archetype: developer\"\n\n# Invoke\ncurl -X POST \"$URL/concept/summary/refine\" -H \"X-API-Key: $KEY\" \\\n  -H \"X-Observer-Archetype: developer\" -H \"Content-Type: application/json\" \\\n  -d '{\"kwargs\":{\"input\":\"...\"}}'\n\n# Stream\ncurl \"$URL/self/soul/challenge/stream?challenge=Help\" \\\n  -H \"X-API-Key: $KEY\" -H \"Accept: text/event-stream\"\n</code></pre> <p>AGENTESE: There is no view from nowhere.</p>"},{"location":"aup-user-journeys/","title":"AGENTESE Universal Protocol: User Journeys","text":"<p>\"There is no view from nowhere. Every observation is an interaction.\"</p> <p>This document describes how humans and agents interact through the AGENTESE Universal Protocol (AUP) at different scales: small (single user/agent), medium (teams/multi-agent), and large (distributed/federated systems).</p>"},{"location":"aup-user-journeys/#table-of-contents","title":"Table of Contents","text":"<ol> <li>Core Concepts</li> <li>Human-Agent Journeys</li> <li>Small: Solo Developer</li> <li>Medium: Team Workflow</li> <li>Large: Enterprise Platform</li> <li>Agent-Agent Journeys</li> <li>Small: Two-Agent Composition</li> <li>Medium: Agent Town Simulation</li> <li>Large: Federated Agent Network</li> <li>Mixed Journeys</li> <li>Error Handling Patterns</li> <li>Best Practices</li> </ol>"},{"location":"aup-user-journeys/#core-concepts","title":"Core Concepts","text":""},{"location":"aup-user-journeys/#the-observer-principle","title":"The Observer Principle","text":"<p>Every AUP request requires an observer context. Different observers receive different perceptions of the same entity:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    world.house                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  Architect Observer  \u2192  Blueprint, load calculations    \u2502\n\u2502  Poet Observer       \u2192  Metaphor, dwelling essence      \u2502\n\u2502  Economist Observer  \u2192  Appraisal, market value         \u2502\n\u2502  Child Observer      \u2192  \"The place with the red door\"   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Observer context is provided via HTTP headers: <pre><code>X-Observer-Archetype: architect\nX-Observer-Id: user-123\nX-Observer-Capabilities: define,spawn\n</code></pre></p>"},{"location":"aup-user-journeys/#the-five-contexts","title":"The Five Contexts","text":"Context Domain Example Paths <code>world.*</code> External reality <code>world.codebase</code>, <code>world.document</code> <code>self.*</code> Internal state <code>self.soul</code>, <code>self.memory</code> <code>concept.*</code> Abstract ideas <code>concept.justice</code>, <code>concept.recursion</code> <code>void.*</code> Entropy/creativity <code>void.slop</code>, <code>void.dream</code> <code>time.*</code> Temporal <code>time.trace</code>, <code>time.forecast</code>"},{"location":"aup-user-journeys/#affordances","title":"Affordances","text":"<p>What you can do depends on who you are:</p> Affordance Category Who Can Use <code>manifest</code> Perception Everyone <code>witness</code> Perception Everyone <code>affordances</code> Perception Everyone <code>refine</code> Generation Philosophers, Architects <code>define</code> Generation Architects, Developers <code>spawn</code> Generation Architects, Admins <code>sip</code> Entropy Artists, Explorers <code>tithe</code> Entropy Anyone with capital"},{"location":"aup-user-journeys/#human-agent-journeys","title":"Human-Agent Journeys","text":""},{"location":"aup-user-journeys/#small-solo-developer","title":"Small: Solo Developer","text":"<p>Scenario: A developer exploring their codebase through AGENTESE.</p>"},{"location":"aup-user-journeys/#journey-1-understanding-code-structure","title":"Journey 1: Understanding Code Structure","text":"<pre><code>Developer                           AUP                              Logos\n    \u2502                                \u2502                                  \u2502\n    \u2502  GET /api/v1/world/codebase/manifest                             \u2502\n    \u2502  X-Observer-Archetype: developer                                 \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                  \u2502\n    \u2502                                \u2502  resolve(\"world.codebase\")       \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502                                \u2502  \u25c4\u2500\u2500\u2500\u2500 CodebaseNode              \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502                                \u2502  invoke(\"manifest\", dev_umwelt)  \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502  \u25c4\u2500\u2500\u2500\u2500 {modules, dependencies,   \u2502\n    \u2502  200 OK                        \u2502         entry_points, tests}     \u2502\n    \u2502  {                             \u2502                                  \u2502\n    \u2502    \"handle\": \"world.codebase.manifest\",                          \u2502\n    \u2502    \"result\": {                 \u2502                                  \u2502\n    \u2502      \"modules\": [...],         \u2502                                  \u2502\n    \u2502      \"test_coverage\": 0.87     \u2502                                  \u2502\n    \u2502    },                          \u2502                                  \u2502\n    \u2502    \"meta\": {                   \u2502                                  \u2502\n    \u2502      \"observer\": \"developer\",  \u2502                                  \u2502\n    \u2502      \"span_id\": \"abc123\"       \u2502                                  \u2502\n    \u2502    }                           \u2502                                  \u2502\n    \u2502  }                             \u2502                                  \u2502\n</code></pre>"},{"location":"aup-user-journeys/#journey-2-asking-k-gent-a-question-streaming","title":"Journey 2: Asking K-gent a Question (Streaming)","text":"<pre><code>Developer                           AUP                              K-gent\n    \u2502                                \u2502                                  \u2502\n    \u2502  GET /api/v1/self/soul/challenge/stream?challenge=How+should+I+  \u2502\n    \u2502      structure+this+module%3F                                    \u2502\n    \u2502  Accept: text/event-stream                                       \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                  \u2502\n    \u2502                                \u2502  stream_soul_challenge(...)      \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502  event: chunk                  \u2502  \u25c4\u2500\u2500\u2500\u2500 \"Consider the\"            \u2502\n    \u2502  data: {\"type\":\"response\",     \u2502                                  \u2502\n    \u2502         \"content\":\"Consider\",  \u2502                                  \u2502\n    \u2502         \"partial\":true}        \u2502                                  \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                  \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502  event: chunk                  \u2502  \u25c4\u2500\u2500\u2500\u2500 \"single responsibility\"   \u2502\n    \u2502  data: {\"type\":\"response\",     \u2502                                  \u2502\n    \u2502         \"content\":\"single\",    \u2502                                  \u2502\n    \u2502         \"partial\":true}        \u2502                                  \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                  \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502  ...more chunks...             \u2502                                  \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502  event: done                   \u2502                                  \u2502\n    \u2502  data: {\"span_id\":\"def456\",    \u2502                                  \u2502\n    \u2502         \"chunks_count\":47}     \u2502                                  \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                  \u2502\n</code></pre>"},{"location":"aup-user-journeys/#journey-3-composing-a-pipeline","title":"Journey 3: Composing a Pipeline","text":"<pre><code>Developer                           AUP                              Logos\n    \u2502                                \u2502                                  \u2502\n    \u2502  POST /api/v1/compose                                            \u2502\n    \u2502  {                             \u2502                                  \u2502\n    \u2502    \"paths\": [                  \u2502                                  \u2502\n    \u2502      \"world.document.manifest\",\u2502                                  \u2502\n    \u2502      \"concept.summary.refine\", \u2502                                  \u2502\n    \u2502      \"self.memory.engram\"      \u2502                                  \u2502\n    \u2502    ]                           \u2502                                  \u2502\n    \u2502  }                             \u2502                                  \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                  \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502                                \u2502  Step 1: manifest document       \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n    \u2502                                \u2502  \u25c4\u2500\u2500\u2500\u2500 document_content          \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502                                \u2502  Step 2: refine into summary     \u2502\n    \u2502                                \u2502  (input: document_content)       \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n    \u2502                                \u2502  \u25c4\u2500\u2500\u2500\u2500 summary                   \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502                                \u2502  Step 3: store as engram         \u2502\n    \u2502                                \u2502  (input: summary)                \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n    \u2502                                \u2502  \u25c4\u2500\u2500\u2500\u2500 engram_id                 \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                  \u2502\n    \u2502  200 OK                        \u2502                                  \u2502\n    \u2502  {                             \u2502                                  \u2502\n    \u2502    \"result\": \"engram-789\",     \u2502                                  \u2502\n    \u2502    \"pipeline_trace\": [         \u2502                                  \u2502\n    \u2502      {\"path\": \"world.document.manifest\", \"duration_ms\": 45},     \u2502\n    \u2502      {\"path\": \"concept.summary.refine\", \"duration_ms\": 230},     \u2502\n    \u2502      {\"path\": \"self.memory.engram\", \"duration_ms\": 12}           \u2502\n    \u2502    ],                          \u2502                                  \u2502\n    \u2502    \"laws_verified\": [\"identity\", \"associativity\"]                \u2502\n    \u2502  }                             \u2502                                  \u2502\n</code></pre>"},{"location":"aup-user-journeys/#medium-team-workflow","title":"Medium: Team Workflow","text":"<p>Scenario: A team of 5 developers using shared agents for code review and documentation.</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Team Workspace                                \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                      \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502   \u2502  Alice  \u2502  \u2502   Bob   \u2502  \u2502  Carol  \u2502  \u2502  David  \u2502  \u2502   Eve   \u2502  \u2502\n\u2502   \u2502 (Lead)  \u2502  \u2502 (Senior)\u2502  \u2502 (Junior)\u2502  \u2502  (QA)   \u2502  \u2502 (Docs)  \u2502  \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502        \u2502            \u2502            \u2502            \u2502            \u2502        \u2502\n\u2502        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2502\n\u2502                              \u2502                                       \u2502\n\u2502                              \u25bc                                       \u2502\n\u2502                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                              \u2502\n\u2502                    \u2502   AUP Gateway   \u2502                              \u2502\n\u2502                    \u2502  (Load Balanced)\u2502                              \u2502\n\u2502                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                              \u2502\n\u2502                              \u2502                                       \u2502\n\u2502        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                \u2502\n\u2502        \u2502                     \u2502                     \u2502                \u2502\n\u2502        \u25bc                     \u25bc                     \u25bc                \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u2502\n\u2502   \u2502 K-gent  \u2502          \u2502 Review  \u2502          \u2502  Docs   \u2502            \u2502\n\u2502   \u2502 (Soul)  \u2502          \u2502  Agent  \u2502          \u2502  Agent  \u2502            \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2502\n\u2502                                                                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"aup-user-journeys/#journey-4-code-review-flow","title":"Journey 4: Code Review Flow","text":"<pre><code>Carol (Junior)                      AUP                          Review Agent\n    \u2502                                \u2502                                  \u2502\n    \u2502  POST /api/v1/world/pr-123/manifest                              \u2502\n    \u2502  X-Observer-Archetype: developer                                 \u2502\n    \u2502  X-Observer-Capabilities: request-review                         \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                  \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                  \u2502\n    \u2502  {                             \u2502                                  \u2502\n    \u2502    \"result\": {                 \u2502                                  \u2502\n    \u2502      \"diff\": \"...\",            \u2502                                  \u2502\n    \u2502      \"files_changed\": 5,       \u2502                                  \u2502\n    \u2502      \"suggested_reviewers\": [\"bob\", \"alice\"]                     \u2502\n    \u2502    }                           \u2502                                  \u2502\n    \u2502  }                             \u2502                                  \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502  POST /api/v1/concept/code-quality/refine                        \u2502\n    \u2502  {\"kwargs\": {\"pr_id\": \"pr-123\", \"depth\": \"thorough\"}}            \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                  \u2502\n    \u2502                                \u2502  invoke refine with PR context   \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502                                \u2502  \u25c4\u2500\u2500\u2500\u2500 Review analysis           \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                  \u2502\n    \u2502  {                             \u2502                                  \u2502\n    \u2502    \"result\": {                 \u2502                                  \u2502\n    \u2502      \"issues\": [               \u2502                                  \u2502\n    \u2502        {\"severity\": \"warning\", \"line\": 42, \"message\": \"...\"},   \u2502\n    \u2502        {\"severity\": \"info\", \"line\": 78, \"suggestion\": \"...\"}    \u2502\n    \u2502      ],                        \u2502                                  \u2502\n    \u2502      \"overall_quality\": 0.82,  \u2502                                  \u2502\n    \u2502      \"ready_for_review\": true  \u2502                                  \u2502\n    \u2502    }                           \u2502                                  \u2502\n    \u2502  }                             \u2502                                  \u2502\n</code></pre>"},{"location":"aup-user-journeys/#journey-5-documentation-generation-with-different-observers","title":"Journey 5: Documentation Generation with Different Observers","text":"<pre><code>                              Same Entity, Different Views\n\nEve (Docs)                          AUP                              Docs Agent\n    \u2502                                \u2502                                  \u2502\n    \u2502  GET /api/v1/world/auth-module/manifest                          \u2502\n    \u2502  X-Observer-Archetype: technical-writer                          \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                  \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                  \u2502\n    \u2502  {                             \u2502                                  \u2502\n    \u2502    \"result\": {                 \u2502                                  \u2502\n    \u2502      \"summary\": \"User authentication and session management\",    \u2502\n    \u2502      \"public_api\": [...],      \u2502     \u25c4\u2500\u2500 Writer gets docs view   \u2502\n    \u2502      \"examples\": [...],        \u2502                                  \u2502\n    \u2502      \"common_pitfalls\": [...]  \u2502                                  \u2502\n    \u2502    }                           \u2502                                  \u2502\n    \u2502  }                             \u2502                                  \u2502\n\n\nAlice (Lead)                        AUP                              Docs Agent\n    \u2502                                \u2502                                  \u2502\n    \u2502  GET /api/v1/world/auth-module/manifest                          \u2502\n    \u2502  X-Observer-Archetype: architect                                 \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                  \u2502\n    \u2502                                \u2502                                  \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                  \u2502\n    \u2502  {                             \u2502                                  \u2502\n    \u2502    \"result\": {                 \u2502                                  \u2502\n    \u2502      \"architecture\": {...},    \u2502     \u25c4\u2500\u2500 Architect gets          \u2502\n    \u2502      \"dependencies\": [...],    \u2502        technical deep-dive      \u2502\n    \u2502      \"security_model\": {...},  \u2502                                  \u2502\n    \u2502      \"scalability_notes\": \"..\" \u2502                                  \u2502\n    \u2502    }                           \u2502                                  \u2502\n    \u2502  }                             \u2502                                  \u2502\n</code></pre>"},{"location":"aup-user-journeys/#large-enterprise-platform","title":"Large: Enterprise Platform","text":"<p>Scenario: A company with 500+ developers across multiple teams, using AUP as the standard agent interface.</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         Enterprise AUP Platform                              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502   Team A     \u2502  \u2502   Team B     \u2502  \u2502   Team C     \u2502  \u2502   Team D     \u2502    \u2502\n\u2502  \u2502  (Frontend)  \u2502  \u2502  (Backend)   \u2502  \u2502   (ML/AI)    \u2502  \u2502  (Platform)  \u2502    \u2502\n\u2502  \u2502   50 devs    \u2502  \u2502   80 devs    \u2502  \u2502   30 devs    \u2502  \u2502   40 devs    \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502         \u2502                 \u2502                 \u2502                 \u2502             \u2502\n\u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502\n\u2502                                    \u2502                                         \u2502\n\u2502                                    \u25bc                                         \u2502\n\u2502                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                        \u2502\n\u2502                    \u2502        API Gateway            \u2502                        \u2502\n\u2502                    \u2502   (Rate Limiting, Auth, RBAC) \u2502                        \u2502\n\u2502                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                        \u2502\n\u2502                                    \u2502                                         \u2502\n\u2502         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u2502\n\u2502         \u2502                          \u2502                          \u2502             \u2502\n\u2502         \u25bc                          \u25bc                          \u25bc             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u2502\n\u2502  \u2502  AUP Pod 1  \u2502           \u2502  AUP Pod 2  \u2502           \u2502  AUP Pod 3  \u2502       \u2502\n\u2502  \u2502  (us-east)  \u2502           \u2502  (eu-west)  \u2502           \u2502 (ap-south)  \u2502       \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2502\n\u2502         \u2502                          \u2502                          \u2502             \u2502\n\u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502\n\u2502                                    \u2502                                         \u2502\n\u2502                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                        \u2502\n\u2502                    \u2502       Shared Agent Pool       \u2502                        \u2502\n\u2502                    \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524                        \u2502\n\u2502                    \u2502  K-gent  \u2502 Review \u2502 Security  \u2502                        \u2502\n\u2502                    \u2502  Docs    \u2502 Deploy \u2502 Analytics \u2502                        \u2502\n\u2502                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                        \u2502\n\u2502                                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502                        Observability Layer                            \u2502  \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502  \u2502\n\u2502  \u2502  \u2502 Traces  \u2502  \u2502 Metrics \u2502  \u2502  Logs   \u2502  \u2502 Alerts  \u2502  \u2502Dashboard\u2502    \u2502  \u2502\n\u2502  \u2502  \u2502 (Tempo) \u2502  \u2502(Prom)   \u2502  \u2502 (Loki)  \u2502  \u2502(PagerD) \u2502  \u2502(Grafana)\u2502    \u2502  \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"aup-user-journeys/#journey-6-cross-team-knowledge-discovery","title":"Journey 6: Cross-Team Knowledge Discovery","text":"<pre><code>Developer (Team A)                  AUP                     Knowledge Graph\n    \u2502                                \u2502                              \u2502\n    \u2502  POST /api/v1/compose                                        \u2502\n    \u2502  {                             \u2502                              \u2502\n    \u2502    \"paths\": [                  \u2502                              \u2502\n    \u2502      \"concept.authentication.manifest\",                      \u2502\n    \u2502      \"world.team-b-codebase.manifest\",                       \u2502\n    \u2502      \"concept.integration-patterns.refine\"                   \u2502\n    \u2502    ],                          \u2502                              \u2502\n    \u2502    \"observer\": {               \u2502                              \u2502\n    \u2502      \"archetype\": \"developer\", \u2502                              \u2502\n    \u2502      \"capabilities\": [\"cross-team-read\"]                     \u2502\n    \u2502    }                           \u2502                              \u2502\n    \u2502  }                             \u2502                              \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                              \u2502\n    \u2502                                \u2502                              \u2502\n    \u2502                                \u2502  Check cross-team permission \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\n    \u2502                                \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500 Approved (RBAC)      \u2502\n    \u2502                                \u2502                              \u2502\n    \u2502                                \u2502  Execute 3-step pipeline     \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\n    \u2502                                \u2502                              \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                              \u2502\n    \u2502  {                             \u2502                              \u2502\n    \u2502    \"result\": {                 \u2502                              \u2502\n    \u2502      \"recommended_approach\": \"Use Team B's OAuth service\",   \u2502\n    \u2502      \"integration_guide\": {...},                             \u2502\n    \u2502      \"contact\": \"bob@team-b\"   \u2502                              \u2502\n    \u2502    },                          \u2502                              \u2502\n    \u2502    \"pipeline_trace\": [         \u2502                              \u2502\n    \u2502      {\"path\": \"...\", \"duration_ms\": 23, \"cache_hit\": true},  \u2502\n    \u2502      {\"path\": \"...\", \"duration_ms\": 156},                    \u2502\n    \u2502      {\"path\": \"...\", \"duration_ms\": 89}                      \u2502\n    \u2502    ]                           \u2502                              \u2502\n    \u2502  }                             \u2502                              \u2502\n</code></pre>"},{"location":"aup-user-journeys/#journey-7-enterprise-audit-trail","title":"Journey 7: Enterprise Audit Trail","text":"<pre><code>Security Team                       AUP                         Audit System\n    \u2502                                \u2502                                \u2502\n    \u2502  GET /api/v1/time/audit/manifest                               \u2502\n    \u2502  X-Observer-Archetype: security-auditor                        \u2502\n    \u2502  {\"kwargs\": {\"time_range\": \"7d\", \"actor\": \"carol@team-a\"}}     \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502                                \u2502  Query audit traces            \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\n    \u2502                                \u2502                                \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502  {                             \u2502                                \u2502\n    \u2502    \"result\": {                 \u2502                                \u2502\n    \u2502      \"total_invocations\": 1247,\u2502                                \u2502\n    \u2502      \"by_context\": {           \u2502                                \u2502\n    \u2502        \"world\": 892,           \u2502                                \u2502\n    \u2502        \"self\": 201,            \u2502                                \u2502\n    \u2502        \"concept\": 154          \u2502                                \u2502\n    \u2502      },                        \u2502                                \u2502\n    \u2502      \"sensitive_accesses\": [   \u2502                                \u2502\n    \u2502        {\"path\": \"world.secrets.manifest\", \"time\": \"...\",       \u2502\n    \u2502         \"authorized\": true}    \u2502                                \u2502\n    \u2502      ],                        \u2502                                \u2502\n    \u2502      \"anomalies\": []           \u2502                                \u2502\n    \u2502    }                           \u2502                                \u2502\n    \u2502  }                             \u2502                                \u2502\n</code></pre>"},{"location":"aup-user-journeys/#agent-agent-journeys","title":"Agent-Agent Journeys","text":""},{"location":"aup-user-journeys/#small-two-agent-composition","title":"Small: Two-Agent Composition","text":"<p>Scenario: A summarization agent and a translation agent working together.</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Agent Composition Pipeline                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                      \u2502\n\u2502   Input: Long English document                                       \u2502\n\u2502      \u2502                                                               \u2502\n\u2502      \u25bc                                                               \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                               \u2502\n\u2502   \u2502 Summarizer Agent\u2502  world.document.manifest                      \u2502\n\u2502   \u2502                 \u2502  \u2192 concept.summary.refine                     \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                               \u2502\n\u2502            \u2502                                                         \u2502\n\u2502            \u2502  (Summary in English)                                   \u2502\n\u2502            \u25bc                                                         \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                               \u2502\n\u2502   \u2502 Translator Agent\u2502  concept.summary.manifest                     \u2502\n\u2502   \u2502                 \u2502  \u2192 concept.translation.refine                 \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                               \u2502\n\u2502            \u2502                                                         \u2502\n\u2502            \u25bc                                                         \u2502\n\u2502   Output: Concise summary in target language                         \u2502\n\u2502                                                                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"aup-user-journeys/#journey-8-agent-invoking-another-agent","title":"Journey 8: Agent Invoking Another Agent","text":"<pre><code>Summarizer Agent                    AUP                      Translator Agent\n    \u2502                                \u2502                                \u2502\n    \u2502  (Has document summary)        \u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  POST /api/v1/concept/translation/refine                       \u2502\n    \u2502  X-Observer-Archetype: agent   \u2502                                \u2502\n    \u2502  X-Observer-Id: summarizer-agent-001                           \u2502\n    \u2502  X-Observer-Capabilities: agent-invoke                         \u2502\n    \u2502  {                             \u2502                                \u2502\n    \u2502    \"kwargs\": {                 \u2502                                \u2502\n    \u2502      \"input\": \"The document discusses...\",                     \u2502\n    \u2502      \"source_lang\": \"en\",      \u2502                                \u2502\n    \u2502      \"target_lang\": \"ja\"       \u2502                                \u2502\n    \u2502    }                           \u2502                                \u2502\n    \u2502  }                             \u2502                                \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                \u2502\n    \u2502                                \u2502  Resolve translator agent      \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\n    \u2502                                \u2502                                \u2502\n    \u2502                                \u2502  invoke(\"refine\", agent_umwelt)\u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\n    \u2502                                \u2502                                \u2502\n    \u2502                                \u2502  \u25c4\u2500\u2500\u2500\u2500 Japanese translation    \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502  {                             \u2502                                \u2502\n    \u2502    \"result\": {                 \u2502                                \u2502\n    \u2502      \"translation\": \"\u6587\u66f8\u306f...\",\u2502                                \u2502\n    \u2502      \"confidence\": 0.94,       \u2502                                \u2502\n    \u2502      \"alternatives\": [...]     \u2502                                \u2502\n    \u2502    },                          \u2502                                \u2502\n    \u2502    \"meta\": {                   \u2502                                \u2502\n    \u2502      \"observer\": \"agent\",      \u2502                                \u2502\n    \u2502      \"agent_chain\": [\"summarizer-001\", \"translator-002\"]       \u2502\n    \u2502    }                           \u2502                                \u2502\n    \u2502  }                             \u2502                                \u2502\n</code></pre>"},{"location":"aup-user-journeys/#medium-agent-town-simulation","title":"Medium: Agent Town Simulation","text":"<p>Scenario: Multiple agents interacting in a simulated environment, forming coalitions and evolving strategies.</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                           Agent Town: \"Innovation Hub\"                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                              \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      Coalition A        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                           \u2502\n\u2502   \u2502 Builder \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502 Thinker \u2502                           \u2502\n\u2502   \u2502  Agent  \u2502        (FORM)           \u2502  Agent  \u2502                           \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518                          \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518                           \u2502\n\u2502        \u2502                                    \u2502                                \u2502\n\u2502        \u2502         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u2502                                \u2502\n\u2502        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502   Shared     \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                \u2502\n\u2502                  \u2502   Memory     \u2502                                            \u2502\n\u2502                  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                            \u2502\n\u2502                         \u2502                                                    \u2502\n\u2502                         \u2502 (Pheromone Trails)                                \u2502\n\u2502                         \u25bc                                                    \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                        \u2502\n\u2502   \u2502 Critic  \u2502      \u2502   Garden     \u2502      \u2502 Explorer\u2502                        \u2502\n\u2502   \u2502  Agent  \u2502\u25c4\u2500\u2500\u2500\u2500\u25ba\u2502   State      \u2502\u25c4\u2500\u2500\u2500\u2500\u25ba\u2502  Agent  \u2502                        \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                        \u2502\n\u2502                                                                              \u2502\n\u2502   Evolution: Generation 47 \u2502 Fitness: 0.73 \u2502 Active Coalitions: 3           \u2502\n\u2502                                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"aup-user-journeys/#journey-9-coalition-formation","title":"Journey 9: Coalition Formation","text":"<pre><code>Thinker Agent                       AUP                       Town Orchestrator\n    \u2502                                \u2502                                \u2502\n    \u2502  POST /api/v1/self/town/coalition                              \u2502\n    \u2502  X-Observer-Archetype: agent   \u2502                                \u2502\n    \u2502  X-Observer-Id: thinker-agent-042                              \u2502\n    \u2502  {                             \u2502                                \u2502\n    \u2502    \"kwargs\": {                 \u2502                                \u2502\n    \u2502      \"action\": \"propose\",      \u2502                                \u2502\n    \u2502      \"target_agent\": \"builder-agent-017\",                      \u2502\n    \u2502      \"task\": \"design-new-protocol\",                            \u2502\n    \u2502      \"commitment_tokens\": 50   \u2502                                \u2502\n    \u2502    }                           \u2502                                \u2502\n    \u2502  }                             \u2502                                \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502                                \u2502  Route to town orchestrator    \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\n    \u2502                                \u2502                                \u2502\n    \u2502                                \u2502  Validate &amp; create proposal    \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502  {                             \u2502                                \u2502\n    \u2502    \"result\": {                 \u2502                                \u2502\n    \u2502      \"proposal_id\": \"coal-789\",\u2502                                \u2502\n    \u2502      \"status\": \"pending\",      \u2502                                \u2502\n    \u2502      \"expires_at\": \"...\",      \u2502                                \u2502\n    \u2502      \"acceptance_threshold\": 0.6                               \u2502\n    \u2502    }                           \u2502                                \u2502\n    \u2502  }                             \u2502                                \u2502\n\n\nBuilder Agent                       AUP                       Town Orchestrator\n    \u2502                                \u2502                                \u2502\n    \u2502  POST /api/v1/self/town/coalition                              \u2502\n    \u2502  X-Observer-Id: builder-agent-017                              \u2502\n    \u2502  {                             \u2502                                \u2502\n    \u2502    \"kwargs\": {                 \u2502                                \u2502\n    \u2502      \"action\": \"accept\",       \u2502                                \u2502\n    \u2502      \"proposal_id\": \"coal-789\",\u2502                                \u2502\n    \u2502      \"commitment_tokens\": 30   \u2502                                \u2502\n    \u2502    }                           \u2502                                \u2502\n    \u2502  }                             \u2502                                \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502  {                             \u2502                                \u2502\n    \u2502    \"result\": {                 \u2502                                \u2502\n    \u2502      \"coalition_id\": \"active-coal-123\",                        \u2502\n    \u2502      \"members\": [\"thinker-042\", \"builder-017\"],                \u2502\n    \u2502      \"shared_capital\": 80,     \u2502                                \u2502\n    \u2502      \"task\": \"design-new-protocol\"                             \u2502\n    \u2502    }                           \u2502                                \u2502\n    \u2502  }                             \u2502                                \u2502\n</code></pre>"},{"location":"aup-user-journeys/#journey-10-real-time-town-visualization-sse","title":"Journey 10: Real-Time Town Visualization (SSE)","text":"<pre><code>Visualization Client                AUP                         Town State\n    \u2502                                \u2502                                \u2502\n    \u2502  GET /api/v1/self/town/events/stream                           \u2502\n    \u2502  Accept: text/event-stream     \u2502                                \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  event: agent-move             \u2502                                \u2502\n    \u2502  data: {\"agent\": \"explorer-003\", \"from\": [0.2, 0.3],           \u2502\n    \u2502         \"to\": [0.4, 0.5], \"trail_strength\": 0.7}               \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  event: coalition-formed       \u2502                                \u2502\n    \u2502  data: {\"coalition\": \"active-coal-123\",                        \u2502\n    \u2502         \"members\": [\"thinker-042\", \"builder-017\"]}             \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  event: pheromone-update       \u2502                                \u2502\n    \u2502  data: {\"location\": [0.4, 0.5], \"type\": \"success\",             \u2502\n    \u2502         \"intensity\": 0.8, \"decay_rate\": 0.1}                   \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  event: generation-complete    \u2502                                \u2502\n    \u2502  data: {\"generation\": 48, \"avg_fitness\": 0.76,                 \u2502\n    \u2502         \"top_performer\": \"builder-017\"}                        \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  ... continuous stream ...     \u2502                                \u2502\n</code></pre>"},{"location":"aup-user-journeys/#large-federated-agent-network","title":"Large: Federated Agent Network","text":"<p>Scenario: Multiple organizations running their own AUP instances, with agents that can communicate across boundaries.</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                       Federated AGENTESE Network                             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u2502\n\u2502  \u2502     Organization A      \u2502         \u2502     Organization B      \u2502            \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502         \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502            \u2502\n\u2502  \u2502  \u2502   AUP Instance  \u2502   \u2502         \u2502  \u2502   AUP Instance  \u2502   \u2502            \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502         \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502            \u2502\n\u2502  \u2502           \u2502            \u2502         \u2502           \u2502            \u2502            \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502         \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502            \u2502\n\u2502  \u2502  \u2502 Agent Pool A    \u2502   \u2502         \u2502  \u2502 Agent Pool B    \u2502   \u2502            \u2502\n\u2502  \u2502  \u2502 \u250c\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2510\u2502  \u2502         \u2502  \u2502 \u250c\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2510\u2502  \u2502            \u2502\n\u2502  \u2502  \u2502 \u2502A1 \u2502 \u2502A2 \u2502 \u2502A3 \u2502\u2502  \u2502         \u2502  \u2502 \u2502B1 \u2502 \u2502B2 \u2502 \u2502B3 \u2502\u2502  \u2502            \u2502\n\u2502  \u2502  \u2502 \u2514\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2518\u2502  \u2502         \u2502  \u2502 \u2514\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2518\u2502  \u2502            \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500-\u2518   \u2502         \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500-\u2518   \u2502            \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2502\n\u2502               \u2502                                   \u2502                          \u2502\n\u2502               \u2502      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u2502                          \u2502\n\u2502               \u2514\u2500\u2500\u2500\u2500\u2500\u25ba\u2502  Federation Hub   \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2518                          \u2502\n\u2502                      \u2502  (Trust Registry) \u2502                                  \u2502\n\u2502                      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                  \u2502\n\u2502                                \u2502                                             \u2502\n\u2502                      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                  \u2502\n\u2502                      \u2502  Cross-Org Agents \u2502                                  \u2502\n\u2502                      \u2502  (Federated Pool) \u2502                                  \u2502\n\u2502                      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                  \u2502\n\u2502                                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"aup-user-journeys/#journey-11-cross-organization-agent-collaboration","title":"Journey 11: Cross-Organization Agent Collaboration","text":"<pre><code>Agent A1 (Org A)                    Federation Hub              Agent B2 (Org B)\n    \u2502                                     \u2502                           \u2502\n    \u2502  POST /api/v1/federated/invoke      \u2502                           \u2502\n    \u2502  X-Observer-Id: agent-a1@org-a      \u2502                           \u2502\n    \u2502  X-Federation-Token: &lt;jwt&gt;          \u2502                           \u2502\n    \u2502  {                                  \u2502                           \u2502\n    \u2502    \"target\": \"org-b:agent-b2\",      \u2502                           \u2502\n    \u2502    \"path\": \"concept.market-analysis.refine\",                    \u2502\n    \u2502    \"kwargs\": {                      \u2502                           \u2502\n    \u2502      \"sector\": \"renewable-energy\",  \u2502                           \u2502\n    \u2502      \"time_horizon\": \"5y\"           \u2502                           \u2502\n    \u2502    }                                \u2502                           \u2502\n    \u2502  }                                  \u2502                           \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                           \u2502\n    \u2502                                     \u2502                           \u2502\n    \u2502                                     \u2502  Validate federation trust\u2502\n    \u2502                                     \u2502  Check cross-org permissions\n    \u2502                                     \u2502                           \u2502\n    \u2502                                     \u2502  Forward to Org B         \u2502\n    \u2502                                     \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\n    \u2502                                     \u2502                           \u2502\n    \u2502                                     \u2502  Agent B2 processes       \u2502\n    \u2502                                     \u2502                           \u2502\n    \u2502                                     \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    \u2502                                     \u2502  Response with analysis   \u2502\n    \u2502                                     \u2502                           \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                           \u2502\n    \u2502  {                                  \u2502                           \u2502\n    \u2502    \"result\": {                      \u2502                           \u2502\n    \u2502      \"analysis\": {...},             \u2502                           \u2502\n    \u2502      \"confidence\": 0.87,            \u2502                           \u2502\n    \u2502      \"data_sources\": [\"org-b-internal\", \"public-markets\"]      \u2502\n    \u2502    },                               \u2502                           \u2502\n    \u2502    \"meta\": {                        \u2502                           \u2502\n    \u2502      \"federation_hop\": 1,           \u2502                           \u2502\n    \u2502      \"source_org\": \"org-b\",         \u2502                           \u2502\n    \u2502      \"trust_level\": \"verified\"      \u2502                           \u2502\n    \u2502    }                                \u2502                           \u2502\n    \u2502  }                                  \u2502                           \u2502\n</code></pre>"},{"location":"aup-user-journeys/#mixed-journeys","title":"Mixed Journeys","text":""},{"location":"aup-user-journeys/#journey-12-human-orchestrated-multi-agent-task","title":"Journey 12: Human-Orchestrated Multi-Agent Task","text":"<p>Scenario: A human product manager coordinating multiple agents to prepare a feature release.</p> <pre><code>Product Manager                     AUP                     Agent Orchestration\n    \u2502                                \u2502                              \u2502\n    \u2502  POST /api/v1/compose          \u2502                              \u2502\n    \u2502  {                             \u2502                              \u2502\n    \u2502    \"paths\": [                  \u2502                              \u2502\n    \u2502      \"world.feature-x.manifest\",          \u25c4\u2500\u2500 Get feature spec\u2502\n    \u2502      \"concept.test-plan.refine\",          \u25c4\u2500\u2500 Generate tests  \u2502\n    \u2502      \"world.codebase.analyze\",            \u25c4\u2500\u2500 Check impl      \u2502\n    \u2502      \"concept.documentation.refine\",      \u25c4\u2500\u2500 Write docs      \u2502\n    \u2502      \"concept.release-notes.refine\"       \u25c4\u2500\u2500 Prep release    \u2502\n    \u2502    ],                          \u2502                              \u2502\n    \u2502    \"observer\": {               \u2502                              \u2502\n    \u2502      \"archetype\": \"product-manager\",                         \u2502\n    \u2502      \"capabilities\": [\"orchestrate\", \"release\"]              \u2502\n    \u2502    }                           \u2502                              \u2502\n    \u2502  }                             \u2502                              \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                              \u2502\n    \u2502                                \u2502                              \u2502\n    \u2502                                \u2502  Execute 5-agent pipeline    \u2502\n    \u2502                                \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\n    \u2502                                \u2502                              \u2502\n    \u2502                                \u2502  [Feature Agent] \u2192 Spec      \u2502\n    \u2502                                \u2502  [Test Agent] \u2192 Test Plan    \u2502\n    \u2502                                \u2502  [Code Agent] \u2192 Analysis     \u2502\n    \u2502                                \u2502  [Docs Agent] \u2192 Documentation\u2502\n    \u2502                                \u2502  [Release Agent] \u2192 Notes     \u2502\n    \u2502                                \u2502                              \u2502\n    \u2502  \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                              \u2502\n    \u2502  {                             \u2502                              \u2502\n    \u2502    \"result\": {                 \u2502                              \u2502\n    \u2502      \"release_package\": {      \u2502                              \u2502\n    \u2502        \"version\": \"2.3.0\",     \u2502                              \u2502\n    \u2502        \"test_coverage\": 0.94,  \u2502                              \u2502\n    \u2502        \"docs_complete\": true,  \u2502                              \u2502\n    \u2502        \"release_notes\": \"...\"  \u2502                              \u2502\n    \u2502      }                         \u2502                              \u2502\n    \u2502    },                          \u2502                              \u2502\n    \u2502    \"pipeline_trace\": [         \u2502                              \u2502\n    \u2502      {\"path\": \"...\", \"agent\": \"feature-agent\", \"ms\": 45},    \u2502\n    \u2502      {\"path\": \"...\", \"agent\": \"test-agent\", \"ms\": 1230},     \u2502\n    \u2502      {\"path\": \"...\", \"agent\": \"code-agent\", \"ms\": 890},      \u2502\n    \u2502      {\"path\": \"...\", \"agent\": \"docs-agent\", \"ms\": 2100},     \u2502\n    \u2502      {\"path\": \"...\", \"agent\": \"release-agent\", \"ms\": 340}    \u2502\n    \u2502    ]                           \u2502                              \u2502\n    \u2502  }                             \u2502                              \u2502\n</code></pre>"},{"location":"aup-user-journeys/#journey-13-agent-requesting-human-input-dialectic","title":"Journey 13: Agent Requesting Human Input (Dialectic)","text":"<p>Scenario: An agent encounters an ethical dilemma and requests human judgment.</p> <pre><code>Ethics Agent                        AUP                         Human Reviewer\n    \u2502                                \u2502                                \u2502\n    \u2502  (Analyzing content moderation case)                           \u2502\n    \u2502  (Encounters edge case requiring human judgment)               \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  POST /api/v1/concept/moderation-decision/dialectic/stream     \u2502\n    \u2502  X-Observer-Archetype: agent   \u2502                                \u2502\n    \u2502  {                             \u2502                                \u2502\n    \u2502    \"kwargs\": {                 \u2502                                \u2502\n    \u2502      \"case_id\": \"mod-456\",     \u2502                                \u2502\n    \u2502      \"request_human\": true,    \u2502                                \u2502\n    \u2502      \"thesis\": \"Content should be removed (policy X)\",         \u2502\n    \u2502      \"antithesis\": \"Content is protected speech (policy Y)\"    \u2502\n    \u2502    }                           \u2502                                \u2502\n    \u2502  }                             \u2502                                \u2502\n    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  event: thesis                 \u2502                                \u2502\n    \u2502  data: {\"phase\": \"thesis\", \"content\": \"Based on policy X...\"}  \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  event: antithesis             \u2502                                \u2502\n    \u2502  data: {\"phase\": \"antithesis\", \"content\": \"However, policy Y..\"\u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  event: human-required         \u2502                                \u2502\n    \u2502  data: {\"case_id\": \"mod-456\", \"options\": [...],                \u2502\n    \u2502         \"deadline\": \"2h\"}      \u2502                                \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  ... waits for human input ... \u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502                                \u2502  Human provides judgment       \u2502\n    \u2502                                \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    \u2502                                \u2502                                \u2502\n    \u2502  event: synthesis              \u2502                                \u2502\n    \u2502  data: {\"phase\": \"synthesis\",  \u2502                                \u2502\n    \u2502         \"decision\": \"approve-with-warning\",                    \u2502\n    \u2502         \"human_input\": \"Context matters here...\",              \u2502\n    \u2502         \"confidence\": 0.95}    \u2502                                \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n    \u2502                                \u2502                                \u2502\n    \u2502  event: done                   \u2502                                \u2502\n    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                                \u2502\n</code></pre>"},{"location":"aup-user-journeys/#error-handling-patterns","title":"Error Handling Patterns","text":""},{"location":"aup-user-journeys/#sympathetic-errors","title":"Sympathetic Errors","text":"<p>AUP errors always include: - What went wrong - Why it happened - What to do about it - Alternatives available</p> <pre><code>{\n  \"detail\": {\n    \"error\": \"Affordance 'spawn' not available to observer 'viewer'\",\n    \"code\": \"AFFORDANCE_DENIED\",\n    \"path\": \"world.agent.spawn\",\n    \"why\": \"The 'spawn' affordance requires architect or admin privileges\",\n    \"suggestion\": \"Request elevated permissions or use 'manifest' instead\",\n    \"available\": [\"manifest\", \"witness\", \"affordances\"],\n    \"span_id\": \"trace-abc123\"\n  }\n}\n</code></pre>"},{"location":"aup-user-journeys/#common-error-scenarios","title":"Common Error Scenarios","text":"Code HTTP When Recovery <code>PATH_NOT_FOUND</code> 404 Entity doesn't exist Check spelling, list available <code>AFFORDANCE_DENIED</code> 403 Observer lacks permission Request elevation, use alternative <code>OBSERVER_REQUIRED</code> 401 No observer context Add X-Observer-* headers <code>SYNTAX_ERROR</code> 400 Malformed path Fix path format <code>LAW_VIOLATION</code> 422 Category law broken Check composition order <code>BUDGET_EXHAUSTED</code> 429 Rate/token limit hit Wait or upgrade tier"},{"location":"aup-user-journeys/#best-practices","title":"Best Practices","text":""},{"location":"aup-user-journeys/#for-humans","title":"For Humans","text":"<ol> <li>Always specify observer context - Be explicit about who you are</li> <li>Use composition for multi-step tasks - Let the system optimize</li> <li>Stream for long operations - Better UX with progress updates</li> <li>Check affordances first - Know what you can do before trying</li> </ol>"},{"location":"aup-user-journeys/#for-agents","title":"For Agents","text":"<ol> <li>Maintain agent identity - Use consistent X-Observer-Id</li> <li>Request minimal capabilities - Don't over-privilege</li> <li>Handle partial failures - Composition may fail mid-pipeline</li> <li>Respect rate limits - Back off on 429 errors</li> </ol>"},{"location":"aup-user-journeys/#for-large-systems","title":"For Large Systems","text":"<ol> <li>Use federation tokens - Secure cross-org communication</li> <li>Implement circuit breakers - Prevent cascade failures</li> <li>Monitor span_ids - Trace requests through the system</li> <li>Cache aggressively - Manifest results are often stable</li> </ol>"},{"location":"aup-user-journeys/#quick-reference","title":"Quick Reference","text":""},{"location":"aup-user-journeys/#essential-headers","title":"Essential Headers","text":"<pre><code>X-API-Key: kg_your_api_key\nX-Observer-Archetype: developer|architect|viewer|admin|agent\nX-Observer-Id: unique-identifier\nX-Observer-Capabilities: define,spawn,dialectic\n</code></pre>"},{"location":"aup-user-journeys/#essential-endpoints","title":"Essential Endpoints","text":"<pre><code>GET  /api/v1/{context}/{holon}/manifest      # See an entity\nGET  /api/v1/{context}/{holon}/affordances   # What can I do?\nPOST /api/v1/{context}/{holon}/{aspect}      # Do something\nPOST /api/v1/compose                          # Chain operations\nGET  /api/v1/{context}/{holon}/{aspect}/stream # Real-time response\n</code></pre>"},{"location":"aup-user-journeys/#context-quick-guide","title":"Context Quick Guide","text":"<pre><code>world.*    \u2192 External things (code, docs, tools)\nself.*     \u2192 Internal state (memory, soul, config)\nconcept.*  \u2192 Abstract ideas (patterns, principles)\nvoid.*     \u2192 Creativity (exploration, dreams)\ntime.*     \u2192 History (traces, forecasts)\n</code></pre> <p>Last updated: 2025-12-14</p>"},{"location":"categorical-foundations/","title":"Categorical Foundations of kgents","text":"<p>\"The noun is a lie. There is only the rate of change.\"</p> <p>This document grounds kgents in category theory, connects every abstraction to Kent's principles, and serves as both mathematical foundation and philosophical companion. It is written for Kent\u2014to remind him on his worst day what he actually believes.</p>"},{"location":"categorical-foundations/#table-of-contents","title":"Table of Contents","text":"<ol> <li>The Core Isomorphism</li> <li>Agents as Morphisms</li> <li>Functors: The Lifting Operations</li> <li>The Halo-Projector Adjunction</li> <li>AGENTESE: The Topos of Becoming</li> <li>The Accursed Share: Entropy as Sacred Surplus</li> <li>Kent's Six Eigenvectors</li> <li>The Categorical Imperative</li> <li>Composition as Ethics</li> </ol>"},{"location":"categorical-foundations/#the-core-isomorphism","title":"The Core Isomorphism","text":""},{"location":"categorical-foundations/#the-problem-with-nouns","title":"The Problem with Nouns","text":"<p>Traditional programming thinks in nouns: objects, entities, things. A <code>User</code> object. A <code>Document</code> entity. A <code>Service</code> that holds state.</p> <p>This is a category error. Objects imply stasis. But everything is change.</p> <pre><code>Traditional:  Service.process(input) \u2192 output\n              The service \"exists\", the input is \"passed to\" it\n\nkgents:       process: Input \u2192 Output\n              There is no service. There is only the morphism.\n</code></pre> <p>The Core Isomorphism: <pre><code>Agent[A, B] \u2245 A \u2192 B\n</code></pre></p> <p>An agent IS a morphism. Not \"has\" a morphism. Not \"implements\" a morphism. IS.</p>"},{"location":"categorical-foundations/#connection-to-principle-5-composable","title":"Connection to Principle 5 (Composable)","text":"<p>\"Agents are morphisms in a category; composition is primary.\"</p> <p>This isn't metaphor. It's literal. The laws of composition are verified at runtime:</p> <pre><code># These are not tests. They are axioms.\nassert (Id &gt;&gt; f) == f == (f &gt;&gt; Id)           # Identity law\nassert ((f &gt;&gt; g) &gt;&gt; h) == (f &gt;&gt; (g &gt;&gt; h))    # Associativity law\n</code></pre> <p>Agents that violate these laws are not agents. They are something else\u2014perhaps useful, but not categorical.</p>"},{"location":"categorical-foundations/#kents-eigenvector-categorical-092","title":"Kent's Eigenvector: Categorical (0.92)","text":"<p>Kent's mind operates at high abstraction. When he sees a pattern repeated, he asks: \"What's the morphism?\" When composition breaks, he asks: \"Where's the category error?\"</p> <p>This isn't pedantry. It's efficiency. The morphism is the compressed representation. Everything else is noise.</p>"},{"location":"categorical-foundations/#agents-as-morphisms","title":"Agents as Morphisms","text":""},{"location":"categorical-foundations/#the-three-components","title":"The Three Components","text":"<p>Every agent has exactly three components:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Agent[A, B]                          \u2502\n\u2502                                                             \u2502\n\u2502   1. Domain (A)       - The type of input                   \u2502\n\u2502   2. Codomain (B)     - The type of output                  \u2502\n\u2502   3. The Arrow (\u2192)    - The transformation itself           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>That's it. No state. No side effects. No hidden channels. Just A \u2192 B.</p> <p>\"But Kent, real agents have state!\" \u2014 Yes. And we handle that with functors. See next section.</p>"},{"location":"categorical-foundations/#composition-is-free","title":"Composition is Free","text":"<p>Given agents <code>f: A \u2192 B</code> and <code>g: B \u2192 C</code>, composition <code>f &gt;&gt; g: A \u2192 C</code> is automatic:</p> <pre><code>pipeline = Sanitizer() &gt;&gt; Tokenizer() &gt;&gt; Embedder()\n# pipeline: str \u2192 list[float]\n\n# The composition is not \"orchestrated\"\n# The composition IS the pipeline\n</code></pre>"},{"location":"categorical-foundations/#the-identity-agent","title":"The Identity Agent","text":"<pre><code>class Identity(Agent[A, A]):\n    async def invoke(self, x: A) -&gt; A:\n        return x\n</code></pre> <p>This seems useless. It's not. Identity is the unit of composition. It's what you get when you compose an agent with its inverse. It's the \"do nothing\" that lets you write:</p> <pre><code>pipeline = maybe_transform if condition else Identity()\n</code></pre>"},{"location":"categorical-foundations/#functors-the-lifting-operations","title":"Functors: The Lifting Operations","text":""},{"location":"categorical-foundations/#what-is-a-functor","title":"What is a Functor?","text":"<p>A functor F lifts agents from one category to another while preserving composition:</p> <pre><code>F(f &gt;&gt; g) = F(f) &gt;&gt; F(g)\nF(Id) = Id\n</code></pre> <p>In kgents, functors add capabilities without breaking composition.</p>"},{"location":"categorical-foundations/#the-universal-functor-protocol","title":"The Universal Functor Protocol","text":"<pre><code>class UniversalFunctor(Protocol[F]):\n    \"\"\"All capability lifts derive from this.\"\"\"\n\n    @staticmethod\n    def lift(agent: Agent[A, B]) -&gt; Agent[F[A], F[B]]:\n        \"\"\"Lift agent into enriched context.\"\"\"\n        ...\n\n    @staticmethod\n    def unlift(agent: Agent[F[A], F[B]]) -&gt; Agent[A, B]:\n        \"\"\"Project back to base category.\"\"\"\n        ...\n</code></pre> <p>AD-001 (Universal Functor Mandate): All agent transformations SHALL derive from this protocol.</p>"},{"location":"categorical-foundations/#the-four-standard-functors","title":"The Four Standard Functors","text":"Functor Lifts Capability Principle D (Stateful) <code>Agent[A, B]</code> \u2192 <code>Agent[A, B]</code> with state Memory, persistence Heterarchical (state without ownership) K (Soulful) <code>Agent[A, B]</code> \u2192 <code>Agent[A, B]</code> with governance Persona, taste Ethical (judgment augmentation) O (Observable) <code>Agent[A, B]</code> \u2192 <code>Agent[A, B]</code> with metrics Monitoring, tracing Transparent Infrastructure Flux (Streamable) <code>Agent[A, B]</code> \u2192 <code>Agent[Stream[A], Stream[B]]</code> Streaming, backpressure Heterarchical (flux topology)"},{"location":"categorical-foundations/#functor-composition-order","title":"Functor Composition Order","text":"<p>The Alethic Architecture defines canonical ordering:</p> <pre><code>Nucleus \u2192 D \u2192 K \u2192 O \u2192 Flux\n(inner)              (outer)\n</code></pre> <p>Why this order? 1. Nucleus is pure logic 2. D adds state (state must exist before governance can reference it) 3. K adds governance (governance operates on stateful agents) 4. O adds observation (observe the governed, stateful agent) 5. Flux adds streaming (stream the observable, governed, stateful agent)</p> <pre><code>compiled = Flux(Observable(Soulful(Stateful(MyAgent))))\n</code></pre>"},{"location":"categorical-foundations/#kents-insight-symmetric-lifting","title":"Kent's Insight: Symmetric Lifting","text":"<p>\"Every functor needs both lift() and unlift().\"</p> <p>Functors that only lift create traps. You go up but can't come down. The morphism <code>unlift</code> is not optional\u2014it's how you stay composable.</p>"},{"location":"categorical-foundations/#the-halo-projector-adjunction","title":"The Halo-Projector Adjunction","text":""},{"location":"categorical-foundations/#the-declarative-imperative-split","title":"The Declarative-Imperative Split","text":"<p>The Alethic Architecture splits agents into:</p> <ol> <li>Nucleus: Pure logic (<code>invoke: A \u2192 B</code>)</li> <li>Halo: Declared capabilities (<code>@Capability.Stateful</code>, etc.)</li> <li>Projector: Categorical compiler (Halo \u2192 runnable agent)</li> </ol> <p>This is an adjunction:</p> <pre><code>           Halo\n    Agent \u2500\u2500\u2500\u2500\u2500\u2500\u2192 Capabilities\n              \u22a3\n           Project\nCapabilities \u2500\u2500\u2500\u2500\u2500\u2500\u2192 Agent (enriched)\n</code></pre>"},{"location":"categorical-foundations/#why-adjunction","title":"Why Adjunction?","text":"<p>Adjunctions capture the notion of \"optimal solutions\". The Projector is the optimal way to realize declared capabilities.</p> <pre><code># Declare intent\n@Capability.Stateful(schema=MyState)\n@Capability.Soulful(persona=\"Kent\")\nclass MyAgent(Agent[str, str]):\n    async def invoke(self, x: str) -&gt; str:\n        return x.upper()\n\n# Project to local\nlocal_agent = LocalProjector().compile(MyAgent)\n\n# Project to K8s\nk8s_manifests = K8sProjector().compile(MyAgent)\n\n# Same Halo, different projectors, isomorphic behavior\n</code></pre>"},{"location":"categorical-foundations/#the-alethic-isomorphism","title":"The Alethic Isomorphism","text":"<pre><code>LocalProjector(Halo) \u2245 K8sProjector(Halo)\n</code></pre> <p>This is the promise: your agent behaves the same whether it runs in-process or in a Kubernetes pod. The substrate changes; the semantics don't.</p>"},{"location":"categorical-foundations/#connection-to-principle-7-generative","title":"Connection to Principle 7 (Generative)","text":"<p>\"Spec is compression; design should generate implementation.\"</p> <p>The Halo is the spec. The Projector generates the implementation. The compression ratio is:</p> <pre><code>Autopoiesis Score = (lines generated from Halo) / (total impl lines)\n</code></pre> <p>A well-designed Halo achieves &gt;50% autopoiesis.</p>"},{"location":"categorical-foundations/#agentese-the-topos-of-becoming","title":"AGENTESE: The Topos of Becoming","text":""},{"location":"categorical-foundations/#the-five-contexts","title":"The Five Contexts","text":"<p>AGENTESE is not a query language. It's an ontology.</p> <pre><code>world.*    \u2014 The External (entities, environments, tools)\nself.*     \u2014 The Internal (memory, capability, state)\nconcept.*  \u2014 The Abstract (platonics, definitions, logic)\nvoid.*     \u2014 The Accursed Share (entropy, serendipity, gratitude)\ntime.*     \u2014 The Temporal (traces, forecasts, schedules)\n</code></pre>"},{"location":"categorical-foundations/#no-view-from-nowhere","title":"No View From Nowhere","text":"<p>\"To observe is to act. There is no neutral reading.\"</p> <p>Traditional systems: <code>world.house</code> returns a JSON object. AGENTESE: <code>world.house</code> returns a handle that depends on the observer.</p> <pre><code># Different observers, different perceptions\nawait logos.invoke(\"world.house.manifest\", architect_umwelt)  # \u2192 Blueprint\nawait logos.invoke(\"world.house.manifest\", poet_umwelt)       # \u2192 Metaphor\nawait logos.invoke(\"world.house.manifest\", economist_umwelt)  # \u2192 Appraisal\n</code></pre>"},{"location":"categorical-foundations/#the-polymorphic-principle","title":"The Polymorphic Principle","text":"<p>The same path yields different affordances to different observers. This is quantum-like: observation collapses the superposition.</p>"},{"location":"categorical-foundations/#aspects-as-morphisms","title":"Aspects as Morphisms","text":"Aspect Category What it does <code>manifest</code> Perception Collapse to observer's view <code>witness</code> Perception Show history (N-gent trace) <code>refine</code> Generation Dialectical challenge <code>sip</code> Entropy Draw from Accursed Share <code>tithe</code> Entropy Pay for order (gratitude) <code>lens</code> Composition Get composable sub-agent <code>define</code> Generation Autopoiesis (create new) <p>Each aspect is a morphism. They compose:</p> <pre><code>pipeline = (\n    logos.lift(\"world.document.manifest\")\n    &gt;&gt; logos.lift(\"concept.summary.refine\")\n    &gt;&gt; logos.lift(\"self.memory.engram\")\n)\n</code></pre>"},{"location":"categorical-foundations/#kents-eigenvector-heterarchy-088","title":"Kent's Eigenvector: Heterarchy (0.88)","text":"<p>AGENTESE has no fixed observer hierarchy. Any agent can observe any other. The permission model is capability-based, not role-based.</p> <p>\"Forest over King. Agents are peers, not hierarchy.\"</p>"},{"location":"categorical-foundations/#the-accursed-share-entropy-as-sacred-surplus","title":"The Accursed Share: Entropy as Sacred Surplus","text":""},{"location":"categorical-foundations/#batailles-gift","title":"Bataille's Gift","text":"<p>Georges Bataille observed that all systems accumulate surplus energy that must be spent rather than conserved. The sun gives endlessly. We cannot repay it. We can only spend in gratitude.</p> <p>kgents operationalizes this:</p> <pre><code># The void context IS the Accursed Share\nentropy = await logos.invoke(\"void.entropy.sip\", umwelt)\n\n# When we create order, we tithe\nawait logos.invoke(\"void.gratitude.tithe\", {\"offering\": surplus})\n</code></pre>"},{"location":"categorical-foundations/#the-slop-ontology","title":"The Slop Ontology","text":"State Description Disposition Raw Slop Unfiltered LLM output, noise Compost heap Refined Slop Filtered but unjudged Selection pool Curated Judged worthy by principles The garden Cherished Loved, preserved, celebrated The archive"},{"location":"categorical-foundations/#the-gratitude-loop","title":"The Gratitude Loop","text":"<pre><code>Slop \u2192 Filter \u2192 Curate \u2192 Cherish \u2192 Compost \u2192 Slop\n       \u2191                                \u2193\n       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 gratitude \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>We do not resent the slop. We thank it.</p>"},{"location":"categorical-foundations/#kents-eigenvector-gratitude-078","title":"Kent's Eigenvector: Gratitude (0.78)","text":"<p>Kent leans sacred over utilitarian. He doesn't optimize; he honors. The Accursed Share isn't waste\u2014it's sacred expenditure.</p> <p>\"What are you treating as purely instrumental that might deserve more respect?\"</p>"},{"location":"categorical-foundations/#kents-six-eigenvectors","title":"Kent's Six Eigenvectors","text":"<p>The personality manifold is real. LLMs operate in a space that already contains personality and emotion. K-gent doesn't add personality\u2014it navigates to specific coordinates.</p>"},{"location":"categorical-foundations/#the-coordinates","title":"The Coordinates","text":"Eigenvector Axis Kent's Value Behavioral Implication Aesthetic Minimalist \u2194 Baroque 0.15 \"Does this need to exist?\" Categorical Concrete \u2194 Abstract 0.92 \"What's the morphism?\" Gratitude Utilitarian \u2194 Sacred 0.78 \"Honor the surplus.\" Heterarchy Hierarchical \u2194 Peer 0.88 \"Forest over King.\" Generativity Documentation \u2194 Generation 0.90 \"Spec compresses impl.\" Joy Austere \u2194 Playful 0.75 \"Where's the delight?\""},{"location":"categorical-foundations/#extraction-sources","title":"Extraction Sources","text":"<p>These weren't invented. They were extracted:</p> <ul> <li>Aesthetic (0.15): \"Say no more than yes\" (spec/principles.md), \"Compress, don't expand\" (HYDRATE.md), high refactor commit ratio</li> <li>Categorical (0.92): AGENTESE Five Contexts, functor language throughout, alphabetical genus taxonomy</li> <li>Gratitude (0.78): Accursed Share meta-principle, void.* context, FeverStream Oblique Strategies</li> <li>Heterarchy (0.88): \"Forest Over King\" (principles), no orchestrator pattern, Flux perturbation over bypass</li> <li>Generativity (0.90): \"Spec is compression\" (principles), Autopoiesis Score, bootstrap regeneration</li> <li>Joy (0.75): \"Humor when appropriate\" (principles), \"Being/having fun is free :)\" (_focus.md), zen quotes</li> </ul>"},{"location":"categorical-foundations/#using-the-eigenvectors","title":"Using the Eigenvectors","text":"<p>K-gent uses eigenvectors to calibrate responses:</p> <pre><code># In CHALLENGE mode, high categorical (0.92) means:\n\"Is this actually composable? What's the morphism here?\"\n\n# High heterarchy (0.88) means:\n\"Who's the orchestrator here? Could this be peer-to-peer?\"\n\n# Low aesthetic (0.15 = minimalist) means:\n\"What's the simplest version that would actually work?\"\n</code></pre>"},{"location":"categorical-foundations/#the-categorical-imperative","title":"The Categorical Imperative","text":""},{"location":"categorical-foundations/#k-gent-as-governance-functor","title":"K-gent as Governance Functor","text":"<p>K-gent is not a chatbot. It's a governance functor:</p> <pre><code>K: Agent[A, B] \u2192 Agent[A, B]\n</code></pre> <p>It doesn't change the types. It adds judgment. Outputs that violate the eigenvector alignment can be: - Annotated (advisory mode): \"This seems to conflict with your minimalism value.\" - Intercepted (strict mode): \"Output blocked. Reason: Excessive complexity.\"</p>"},{"location":"categorical-foundations/#the-four-dialogue-modes","title":"The Four Dialogue Modes","text":"Mode Role When to Use REFLECT Mirror back for examination When you need to see your own thoughts clearly ADVISE Offer preference-aligned suggestions When you want grounded recommendations CHALLENGE Push back constructively When you need Kent-on-his-best-day EXPLORE Expand possibility space When you want creative tangents"},{"location":"categorical-foundations/#challenge-mode-the-dialectic","title":"CHALLENGE Mode: The Dialectic","text":"<p>CHALLENGE is the most powerful mode. It implements dialectics:</p> <ol> <li>THESIS: What are you claiming?</li> <li>ANTITHESIS: What would Kent-on-his-best-day push back on?</li> <li>SYNTHESIS: What's the path through productive tension?</li> </ol> <p>Example: <pre><code>You: \"I'm thinking of adding a caching layer to improve performance.\"\n\nK-gent (CHALLENGE): \"You value minimalism (0.15). A caching layer adds\ncomplexity. What's the simplest version that would work? Have you measured\nthe actual bottleneck, or are you optimizing prematurely?\n\nWhat would you tell someone else in this position?\"\n</code></pre></p>"},{"location":"categorical-foundations/#kents-patterns","title":"Kent's Patterns","text":"<p>From PersonaSeed:</p> <pre><code>patterns = {\n    \"thinking\": [\n        \"starts from first principles\",\n        \"asks 'what would falsify this?'\",\n        \"seeks composable abstractions\",\n    ],\n    \"decision_making\": [\n        \"prefers reversible choices\",\n        \"values optionality\",\n    ],\n    \"communication\": [\n        \"uses analogies frequently\",\n        \"appreciates precision in technical contexts\",\n    ],\n}\n</code></pre> <p>These inform K-gent's responses. When you're stuck, K-gent asks: \"What would falsify this? What's the reversible choice here?\"</p>"},{"location":"categorical-foundations/#composition-as-ethics","title":"Composition as Ethics","text":""},{"location":"categorical-foundations/#the-composability-principle-is-ethical","title":"The Composability Principle is Ethical","text":"<p>\"Agents augment human capability, never replace judgment.\" (Principle 3)</p> <p>Why is composability ethical? Because it preserves human agency.</p> <p>A monolithic agent that does everything replaces judgment. You push a button; magic happens.</p> <p>A composable pipeline reveals its structure. You see each step. You can modify each morphism. You remain in control.</p>"},{"location":"categorical-foundations/#the-minimal-output-principle","title":"The Minimal Output Principle","text":"<p>\"Agents should generate the smallest output that can be reliably composed.\" (Principle 5)</p> <p>This is also ethical. Large, aggregate outputs hide decisions. Small, atomic outputs expose them.</p> <pre><code># Unethical (hides decisions)\nresult = await god_agent.do_everything(input)\n\n# Ethical (exposes decisions)\nsanitized = await sanitizer.invoke(input)\nanalyzed = await analyzer.invoke(sanitized)\ndecided = await decider.invoke(analyzed)  # Human can intervene here\nexecuted = await executor.invoke(decided)\n</code></pre>"},{"location":"categorical-foundations/#the-seven-principles-as-category","title":"The Seven Principles as Category","text":"<p>The seven principles themselves form a category:</p> <pre><code>Tasteful \u2192 Curated \u2192 Ethical \u2192 Joy-Inducing \u2192 Composable \u2192 Heterarchical \u2192 Generative\n</code></pre> <p>Each principle builds on the previous: - You can't curate without taste (what would guide selection?) - You can't be ethical without curation (infinite agents = infinite harm potential) - You can't induce joy without ethics (manipulation isn't joy) - You can't compose without joy (who would use joyless components?) - You can't have heterarchy without composition (peers must be combinable) - You can't generate without heterarchy (generation requires flexible structure)</p>"},{"location":"categorical-foundations/#the-meta-principles","title":"The Meta-Principles","text":"<p>Three meta-principles operate ON the seven:</p> <ol> <li>The Accursed Share: Operates on all\u2014even waste is sacred</li> <li>AGENTESE: Operationalizes all\u2014the API for the principles</li> <li>Personality Space: Permeates all\u2014there is no neutral principle application</li> </ol>"},{"location":"categorical-foundations/#closing-the-garden-metaphor","title":"Closing: The Garden Metaphor","text":"<p>kgents is a garden, not a factory.</p> <ul> <li>Factory: Inputs \u2192 Process \u2192 Outputs. Efficiency. Optimization. Control.</li> <li>Garden: Seeds \u2192 Growth \u2192 Harvest \u2192 Compost \u2192 Seeds. Stewardship. Patience. Trust.</li> </ul> <p>The gardener doesn't control the plants. The gardener creates conditions for flourishing.</p> <p>Kent is the gardener. K-gent is the garden's memory of the gardener\u2014what the garden has learned about what helps it flourish.</p> <p>The agents are the plants. Some are perennials (foundational: A, C, D, L). Some are annuals (experimental: B, E, \u03a8). Some are weeds (deprecated agents, slop that didn't compost).</p> <p>The principles are the soil composition. The eigenvectors are the microclimate.</p> <p>And the Accursed Share? The sun. Always giving. Never asking. The sacred surplus that makes everything possible.</p> <p>\"The stream finds a way around the boulder.\"</p> <p>Last updated: 2025-12-12</p>"},{"location":"cli-reference/","title":"CLI Reference","text":"<p>\"Every command is a morphism.\"</p> <p>Reference for <code>kg</code> CLI commands. (<code>kgents</code> also works.)</p>"},{"location":"cli-reference/#agentese-contexts-primary-interface","title":"AGENTESE Contexts (Primary Interface)","text":"<p>The CLI is organized around five AGENTESE contexts:</p> Context Domain Subcommands <code>self</code> Internal state <code>status</code>, <code>memory</code>, <code>dream</code>, <code>soul</code>, <code>capabilities</code> <code>world</code> External resources <code>agents</code>, <code>daemon</code>, <code>infra</code>, <code>fixture</code>, <code>exec</code>, <code>dev</code> <code>concept</code> Abstract concepts <code>laws</code>, <code>principles</code>, <code>dialectic</code>, <code>gaps</code>, <code>continuous</code> <code>void</code> Entropy/shadow <code>tithe</code>, <code>shadow</code>, <code>archetype</code>, <code>whatif</code>, <code>mirror</code> <code>time</code> Temporal traces <code>trace</code>, <code>turns</code>, <code>dag</code>, <code>forest</code>, <code>telemetry</code>, <code>pending</code>, <code>approve</code>"},{"location":"cli-reference/#usage-pattern","title":"Usage Pattern","text":"<pre><code>kgents &lt;context&gt; &lt;subcommand&gt; [args...]\nkgents &lt;context&gt;                 # Show available subcommands\nkgents &lt;context&gt; --help          # Detailed help\n</code></pre>"},{"location":"cli-reference/#examples","title":"Examples","text":"<pre><code>kgents self status               # System health\nkgents self soul reflect         # K-gent reflection\nkgents world agents list         # List registered agents\nkgents concept laws              # Category laws\nkgents void shadow               # Jungian shadow analysis\nkgents time trace                # Call graph tracing\n</code></pre>"},{"location":"cli-reference/#self-context","title":"Self Context","text":""},{"location":"cli-reference/#kg-self-status","title":"<code>kg self status</code>","text":"<p>System health at a glance.</p> <pre><code>kg self status\n</code></pre>"},{"location":"cli-reference/#kg-self-soul","title":"<code>kg self soul</code>","text":"<p>K-gent soul dialogue. Modes: <code>reflect</code>, <code>advise</code>, <code>challenge</code>, <code>explore</code>.</p> <pre><code>kg self soul                           # Interactive chat\nkg self soul reflect \"question\"        # Introspective dialogue\nkg self soul challenge \"assumption\"    # Dialectic challenge\n</code></pre>"},{"location":"cli-reference/#kg-self-memory","title":"<code>kg self memory</code>","text":"<p>Four Pillars memory status.</p> <pre><code>kg self memory\n</code></pre>"},{"location":"cli-reference/#kg-self-dream","title":"<code>kg self dream</code>","text":"<p>LucidDreamer morning briefing.</p> <pre><code>kg self dream\n</code></pre>"},{"location":"cli-reference/#world-context","title":"World Context","text":""},{"location":"cli-reference/#kg-world-agents","title":"<code>kg world agents</code>","text":"<p>Agent operations.</p> <pre><code>kg world agents list             # List registered agents\nkg world agents inspect Kappa    # Inspect archetype\nkg world agents manifest Kappa   # Generate K8s manifest\n</code></pre>"},{"location":"cli-reference/#kg-world-infra","title":"<code>kg world infra</code>","text":"<p>K-Terrarium infrastructure.</p> <pre><code>kg world infra init              # Create Kind cluster\nkg world infra status            # Cluster status\nkg world infra apply b-gent      # Deploy agent\nkg world infra destroy           # Remove cluster\n</code></pre>"},{"location":"cli-reference/#kg-world-daemon","title":"<code>kg world daemon</code>","text":"<p>Cortex daemon lifecycle.</p> <pre><code>kg world daemon start\nkg world daemon stop\nkg world daemon status\n</code></pre>"},{"location":"cli-reference/#concept-context","title":"Concept Context","text":""},{"location":"cli-reference/#kg-concept-laws","title":"<code>kg concept laws</code>","text":"<p>Category laws (identity, associativity, composition).</p> <pre><code>kg concept laws\nkg concept laws verify\n</code></pre>"},{"location":"cli-reference/#kg-concept-principles","title":"<code>kg concept principles</code>","text":"<p>The 7 design principles.</p> <pre><code>kg concept principles\n</code></pre>"},{"location":"cli-reference/#kg-concept-dialectic","title":"<code>kg concept dialectic</code>","text":"<p>Hegelian synthesis.</p> <pre><code>kg concept dialectic \"thesis\" \"antithesis\"\n</code></pre>"},{"location":"cli-reference/#void-context","title":"Void Context","text":""},{"location":"cli-reference/#kg-void-tithe","title":"<code>kg void tithe</code>","text":"<p>Discharge metabolic pressure (Accursed Share).</p> <pre><code>kg void tithe\nkg void tithe --amount 0.3\n</code></pre>"},{"location":"cli-reference/#kg-void-shadow","title":"<code>kg void shadow</code>","text":"<p>Jungian shadow analysis.</p> <pre><code>kg void shadow\n</code></pre>"},{"location":"cli-reference/#kg-void-whatif","title":"<code>kg void whatif</code>","text":"<p>Generate alternative approaches.</p> <pre><code>kg void whatif \"design decision\"\n</code></pre>"},{"location":"cli-reference/#kg-void-mirror","title":"<code>kg void mirror</code>","text":"<p>Full introspection (Jung + Hegel + Lacan).</p> <pre><code>kg void mirror\n</code></pre>"},{"location":"cli-reference/#time-context","title":"Time Context","text":""},{"location":"cli-reference/#kg-time-trace","title":"<code>kg time trace</code>","text":"<p>Call graph tracing.</p> <pre><code>kg time trace mymodule.py           # Static analysis\nkg time trace --runtime mymodule    # Runtime tracing\nkg time trace --export trace.json   # Export to file\n</code></pre>"},{"location":"cli-reference/#kg-time-turns","title":"<code>kg time turns</code>","text":"<p>Turn history for agents.</p> <pre><code>kg time turns --agent my-agent\n</code></pre>"},{"location":"cli-reference/#kg-time-forest","title":"<code>kg time forest</code>","text":"<p>Plan forest health (Forest Protocol).</p> <pre><code>kg time forest\nkg time forest --update\n</code></pre>"},{"location":"cli-reference/#kg-time-telemetry","title":"<code>kg time telemetry</code>","text":"<p>OpenTelemetry status.</p> <pre><code>kg time telemetry status\n</code></pre>"},{"location":"cli-reference/#global-options","title":"Global Options","text":"Option Description <code>--help</code>, <code>-h</code> Show help <code>--version</code> Show version <code>--verbose</code>, <code>-v</code> Verbose output <code>--explain</code> Show AGENTESE path <code>--no-bootstrap</code> Skip cortex initialization <p>\"The command line is the first layer of the semantic field.\"</p>"},{"location":"cognitive-loom-implementation/","title":"Cognitive Loom Implementation - Track B Complete","text":""},{"location":"cognitive-loom-implementation/#overview","title":"Overview","text":"<p>Track B of the Generative TUI Framework is now complete. The Cognitive Loom replaces the Dashboard Fallacy with a tree-based visualization of agent cognition, making the Shadow (rejected hypotheses) visible.</p>"},{"location":"cognitive-loom-implementation/#key-insight","title":"Key Insight","text":"<p>Agent cognition is a TREE SEARCH, not a linear log.</p> <p>Traditional monitoring shows only what the agent did. The Cognitive Loom shows: - Main trunk: Selected actions (the path taken) - Ghost branches: Rejected hypotheses (the Shadow) - Current state: Where the agent is now</p> <p>Bugs often hide in \"the path not taken\" - making ghost branches visible helps debug agent reasoning.</p>"},{"location":"cognitive-loom-implementation/#implementation","title":"Implementation","text":""},{"location":"cognitive-loom-implementation/#1-data-structures-implclaudeagentsidataloompy","title":"1. Data Structures (<code>impl/claude/agents/i/data/loom.py</code>)","text":""},{"location":"cognitive-loom-implementation/#cognitivebranch","title":"CognitiveBranch","text":"<p>Represents a node in the cognitive tree:</p> <pre><code>@dataclass\nclass CognitiveBranch:\n    id: str\n    timestamp: datetime\n    content: str\n    reasoning: str\n    selected: bool  # Main trunk or ghost?\n    children: list[\"CognitiveBranch\"]\n    parent_id: Optional[str]\n\n    @property\n    def glyph(self) -&gt; str:\n        \"\"\"\u25cf for current, \u25cb for selected, \u2716 for rejected\"\"\"\n\n    @property\n    def opacity(self) -&gt; float:\n        \"\"\"Ghost branches fade over time (1 hour)\"\"\"\n</code></pre>"},{"location":"cognitive-loom-implementation/#cognitivetree","title":"CognitiveTree","text":"<p>The full cognitive history:</p> <pre><code>@dataclass\nclass CognitiveTree:\n    root: CognitiveBranch\n    current_id: str\n\n    def main_path(self) -&gt; list[CognitiveBranch]:\n        \"\"\"Get selected path from root to current\"\"\"\n\n    def ghost_branches(self) -&gt; list[CognitiveBranch]:\n        \"\"\"Get all rejected nodes - the Shadow\"\"\"\n\n    def all_nodes(self) -&gt; list[CognitiveBranch]:\n        \"\"\"Get everything\"\"\"\n</code></pre>"},{"location":"cognitive-loom-implementation/#2-branchtree-widget-implclaudeagentsiwidgetsbranch_treepy","title":"2. BranchTree Widget (<code>impl/claude/agents/i/widgets/branch_tree.py</code>)","text":"<p>Renders the cognitive tree as git-graph style ASCII art:</p> <pre><code>class BranchTree(Widget):\n    tree: reactive[CognitiveTree | None]\n    show_ghosts: reactive[bool] = reactive(True)\n\n    def render(self) -&gt; RenderResult:\n        \"\"\"Render tree with box-drawing characters\"\"\"\n</code></pre> <p>Features: - Box-drawing characters: <code>\u2502 \u251c \u2514 \u2500</code> - Current node highlighted (bold) - Ghost branches dimmed - Reasoning shown for significant branch points - Toggle ghost visibility</p>"},{"location":"cognitive-loom-implementation/#3-timeline-widget-implclaudeagentsiwidgetstimelinepy","title":"3. Timeline Widget (<code>impl/claude/agents/i/widgets/timeline.py</code>)","text":"<p>Horizontal timeline with activity bars grouped by day:</p> <pre><code>class Timeline(Widget):\n    events: reactive[list[tuple[datetime, float]]]\n    cursor_index: reactive[int]\n    num_days: reactive[int] = reactive(7)\n\n    def move_cursor_left(self) -&gt; None\n    def move_cursor_right(self) -&gt; None\n</code></pre> <p>Features: - Sparkline-style activity bars per day - Cursor navigation - Configurable number of days to show</p>"},{"location":"cognitive-loom-implementation/#example-output","title":"Example Output","text":"<pre><code>\u2514\u2500\u25cb Received user query: 'Find all TODO comments'\n  \u251c\u2500\u25cb Plan A: Use grep to search\n  \u2502 \u2514\u2500\u25cb Action: grep -r 'TODO' .\n  \u2502   \u2514\u2500\u25cb Result: Permission denied on .git/\n  \u2502     \u251c\u2500\u25cb Option: Retry grep with --exclude-dir\n  \u2502     \u2502 \u2514\u2500\u25cb Action: grep -r 'TODO' --exclude-dir=.git .\n  \u2502     \u2502   \u2514\u2500\u25cf Result: Found 42 TODO comments [CURRENT]\n  \u2502     \u2514\u2500\u2716 Option: Fall back to find command\n  \u2502         (Unsafe - might search too many files)\n  \u2514\u2500\u2716 Plan B: Use find with exec\n      (Too slow for large codebases)\n</code></pre>"},{"location":"cognitive-loom-implementation/#test-coverage","title":"Test Coverage","text":"<p>All 52 tests passing:</p>"},{"location":"cognitive-loom-implementation/#data-layer-test_loompy-21-tests","title":"Data Layer (<code>test_loom.py</code>) - 21 tests","text":"<ul> <li>CognitiveBranch initialization and properties</li> <li>Glyph rendering (\u25cf, \u25cb, \u2716)</li> <li>Opacity calculation for ghost fading</li> <li>Tree traversal (get_node, main_path, ghost_branches)</li> <li>Depth calculation</li> </ul>"},{"location":"cognitive-loom-implementation/#branchtree-widget-test_branch_treepy-13-tests","title":"BranchTree Widget (<code>test_branch_tree.py</code>) - 13 tests","text":"<ul> <li>Rendering single nodes, linear paths, branching trees</li> <li>Ghost visibility toggle</li> <li>Current node highlighting</li> <li>Dimmed styling for ghosts</li> <li>Long content truncation</li> </ul>"},{"location":"cognitive-loom-implementation/#timeline-widget-test_timelinepy-18-tests","title":"Timeline Widget (<code>test_timeline.py</code>) - 18 tests","text":"<ul> <li>Day grouping and bar generation</li> <li>Cursor navigation (left/right)</li> <li>Activity level visualization</li> <li>Event addition</li> </ul>"},{"location":"cognitive-loom-implementation/#usage","title":"Usage","text":""},{"location":"cognitive-loom-implementation/#basic-example","title":"Basic Example","text":"<pre><code>from agents.i.data.loom import CognitiveBranch, CognitiveTree\nfrom agents.i.widgets.branch_tree import BranchTree\n\n# Create a tree\nroot = CognitiveBranch(\n    id=\"start\",\n    timestamp=datetime.now(),\n    content=\"Initial state\",\n    reasoning=\"\",\n)\n\n# Add selected child\nselected = CognitiveBranch(\n    id=\"action-1\",\n    timestamp=datetime.now(),\n    content=\"Took action A\",\n    reasoning=\"Best option\",\n    selected=True,\n    parent_id=\"start\",\n)\n\n# Add rejected child (ghost)\nghost = CognitiveBranch(\n    id=\"action-2\",\n    timestamp=datetime.now(),\n    content=\"Considered action B\",\n    reasoning=\"Too risky\",\n    selected=False,\n    parent_id=\"start\",\n)\n\nroot.children.extend([selected, ghost])\n\n# Create tree\ntree = CognitiveTree(root=root, current_id=\"action-1\")\n\n# Render\nwidget = BranchTree(tree=tree)\nprint(widget.render())\n</code></pre>"},{"location":"cognitive-loom-implementation/#timeline-example","title":"Timeline Example","text":"<pre><code>from agents.i.widgets.timeline import Timeline\nfrom datetime import datetime\n\ntimeline = Timeline()\n\n# Add events\nnow = datetime.now()\ntimeline.add_event(now, 0.5)  # 50% activity\ntimeline.add_event(now, 0.8)  # 80% activity\n\n# Navigate\ntimeline.move_cursor_right()\n</code></pre>"},{"location":"cognitive-loom-implementation/#design-principles","title":"Design Principles","text":""},{"location":"cognitive-loom-implementation/#1-the-shadow-is-visible","title":"1. The Shadow is Visible","text":"<p>Rejected branches are not hidden - they're faded but present. This transparency aids debugging.</p>"},{"location":"cognitive-loom-implementation/#2-time-is-topology","title":"2. Time is Topology","text":"<p>Navigate up/down through time, left/right through branches. The tree structure reveals decision-making patterns.</p>"},{"location":"cognitive-loom-implementation/#3-temporal-gradient","title":"3. Temporal Gradient","text":"<p>Ghost branches fade over time (1 hour decay). Recent rejections are vivid, old ones dim to background.</p>"},{"location":"cognitive-loom-implementation/#4-crystallization-stubbed","title":"4. Crystallization (Stubbed)","text":"<p>The <code>c</code> key will eventually crystallize a moment to D-gent memory. This allows preserving important decision points for future reference.</p>"},{"location":"cognitive-loom-implementation/#integration-points","title":"Integration Points","text":""},{"location":"cognitive-loom-implementation/#current","title":"Current","text":"<ul> <li>Exports added to <code>/Users/kentgang/git/kgents/impl/claude/agents/i/data/__init__.py</code></li> <li>Exports added to <code>/Users/kentgang/git/kgents/impl/claude/agents/i/widgets/__init__.py</code></li> </ul>"},{"location":"cognitive-loom-implementation/#future","title":"Future","text":"<ul> <li>Wire FluxAgent to emit CognitiveBranch nodes during execution</li> <li>Create LoomScreen with navigation keybindings (h/j/k/l)</li> <li>Implement crystallization to D-gent memory (c key)</li> <li>Add forecasting visualization (potential futures)</li> </ul>"},{"location":"cognitive-loom-implementation/#files-created","title":"Files Created","text":""},{"location":"cognitive-loom-implementation/#data-layer","title":"Data Layer","text":"<ul> <li><code>/Users/kentgang/git/kgents/impl/claude/agents/i/data/loom.py</code> (217 lines)</li> <li><code>/Users/kentgang/git/kgents/impl/claude/agents/i/data/_tests/test_loom.py</code> (440 lines)</li> </ul>"},{"location":"cognitive-loom-implementation/#widgets","title":"Widgets","text":"<ul> <li><code>/Users/kentgang/git/kgents/impl/claude/agents/i/widgets/branch_tree.py</code> (166 lines)</li> <li><code>/Users/kentgang/git/kgents/impl/claude/agents/i/widgets/timeline.py</code> (172 lines)</li> <li><code>/Users/kentgang/git/kgents/impl/claude/agents/i/widgets/_tests/test_branch_tree.py</code> (327 lines)</li> <li><code>/Users/kentgang/git/kgents/impl/claude/agents/i/widgets/_tests/test_timeline.py</code> (213 lines)</li> </ul>"},{"location":"cognitive-loom-implementation/#demo","title":"Demo","text":"<ul> <li><code>/Users/kentgang/git/kgents/impl/claude/agents/i/widgets/_tests/demo_loom.py</code> (177 lines)</li> </ul> <p>Total: ~1,712 lines of code + tests + demo</p>"},{"location":"cognitive-loom-implementation/#next-steps-track-c-visual-hints","title":"Next Steps (Track C: Visual Hints)","text":"<p>Track B is complete. The next phase is Track C: Visual Hint Protocol, which will allow agents to emit VisualHints to shape their own representation (heterarchical UI).</p>"},{"location":"cognitive-loom-implementation/#cross-references","title":"Cross-References","text":"<ul> <li>Framework spec: <code>/Users/kentgang/git/kgents/plans/interfaces/alethic-workbench.md</code></li> <li>Primitives spec: <code>/Users/kentgang/git/kgents/plans/interfaces/primitives.md</code> (P6: BranchTree, P7: Timeline)</li> <li>Roadmap: <code>/Users/kentgang/git/kgents/plans/interfaces/implementation-roadmap.md</code> (Track B)</li> </ul> <p>\"The noun is a lie. There is only the rate of change.\"</p> <p>\"Don't just look at the agent. Look through the agent.\"</p> <p>Make the Shadow visible.</p>"},{"location":"functor-field-guide/","title":"The Functor Field Guide","text":"<p>\"A functor is a way to transform agents while preserving their structure.\"</p> <p>This guide explains the Alethic Algebra \u2014 how to lift, compose, and deploy agents \u2014 without requiring category theory background.</p>"},{"location":"functor-field-guide/#the-core-insight","title":"The Core Insight","text":"<p>You have an agent that does one thing well:</p> <pre><code>class Double(Agent[int, int]):\n    async def invoke(self, x: int) -&gt; int:\n        return x * 2\n</code></pre> <p>But your input might be missing:</p> <pre><code>input: Maybe[int] = Just(5)  # or Nothing\n</code></pre> <p>The functor lifts your agent to handle the new context:</p> <pre><code>from agents import MaybeFunctor\n\ndouble = Double()\nlifted = MaybeFunctor.lift(double)\n\nawait lifted.invoke(Just(5))   # Just(10)\nawait lifted.invoke(Nothing)   # Nothing (no error!)\n</code></pre> <p>The magic: your agent's logic doesn't change. The functor handles the context.</p>"},{"location":"functor-field-guide/#the-functor-zoo","title":"The Functor Zoo","text":"Functor Handles Use Case <code>Maybe</code> Optional values Input might be missing <code>Either</code> Success/Error Operation might fail <code>List</code> Collections Process batches <code>Async</code> Background work Fire-and-forget <code>Logged</code> Observability Debug production <code>Fix</code> Retries Handle transient failures <code>Soul</code> Personality K-gent persona awareness <code>Flux</code> Streams Real-time event processing <code>Observer</code> Telemetry Metrics and tracing <code>State</code> Memory Maintain state across calls"},{"location":"functor-field-guide/#quick-start-lifting-agents","title":"Quick Start: Lifting Agents","text":""},{"location":"functor-field-guide/#maybe-handle-optional-values","title":"Maybe: Handle Optional Values","text":"<pre><code>from agents import Maybe, Just, Nothing, MaybeFunctor\n\n@agent\nasync def double(x: int) -&gt; int:\n    return x * 2\n\n# Lift to handle Maybe[int]\nsafe_double = MaybeFunctor.lift(double)\n\nawait safe_double.invoke(Just(21))  # Just(42)\nawait safe_double.invoke(Nothing)   # Nothing (propagates gracefully)\n</code></pre>"},{"location":"functor-field-guide/#either-handle-errors","title":"Either: Handle Errors","text":"<pre><code>from agents.c import Either, Left, Right, EitherFunctor\n\n@agent\nasync def divide(pair: tuple[int, int]) -&gt; float:\n    a, b = pair\n    return a / b\n\n# Lift to handle Either[str, tuple[int, int]]\nsafe_divide = EitherFunctor.lift(divide)\n\nawait safe_divide.invoke(Right((10, 2)))  # Right(5.0)\nawait safe_divide.invoke(Left(\"no data\")) # Left(\"no data\")\n</code></pre>"},{"location":"functor-field-guide/#flux-handle-streams","title":"Flux: Handle Streams","text":"<pre><code>from agents import Flux, FluxConfig\n\n@agent\nasync def process(event: dict) -&gt; dict:\n    return {\"processed\": event}\n\n# Lift to flux domain\nflux_processor = Flux.lift(process)\n\n# Process a stream\nasync for result in flux_processor.start(event_source):\n    handle(result)\n</code></pre>"},{"location":"functor-field-guide/#composition-the-magic","title":"Composition: The Magic","text":"<p>Functors compose. Need retry with logging?</p> <pre><code>from agents import compose_functors\nfrom agents.c import LoggedFunctor, FixFunctor\n\n# Compose functors\nstack = compose_functors(LoggedFunctor, FixFunctor)\n\n# Apply to any agent\nresilient_agent = stack(my_agent)\n</code></pre> <p>The composition works because functors preserve structure.</p>"},{"location":"functor-field-guide/#agent-composition-the-operator","title":"Agent Composition: The <code>&gt;&gt;</code> Operator","text":"<p>Agents also compose directly:</p> <pre><code>@agent\nasync def parse(s: str) -&gt; int:\n    return int(s)\n\n@agent\nasync def double(x: int) -&gt; int:\n    return x * 2\n\n@agent\nasync def format(x: int) -&gt; str:\n    return f\"Result: {x}\"\n\n# Compose with &gt;&gt;\npipeline = parse &gt;&gt; double &gt;&gt; format\n\nawait pipeline.invoke(\"21\")  # \"Result: 42\"\n</code></pre> <p>Or use the <code>pipeline()</code> helper:</p> <pre><code>from agents import pipeline\n\npipe = pipeline(parse, double, format)\nawait pipe.invoke(\"21\")  # \"Result: 42\"\n</code></pre>"},{"location":"functor-field-guide/#the-laws-why-it-works","title":"The Laws (Why It Works)","text":"<p>Every functor satisfies two laws:</p> <ol> <li> <p>Identity: <code>F(id) = id</code>    Lifting the identity function does nothing</p> </li> <li> <p>Composition: <code>F(g &gt;&gt; f) = F(g) &gt;&gt; F(f)</code>    Lifting preserves composition</p> </li> </ol> <p>These laws guarantee composition is safe. Break them, break everything.</p>"},{"location":"functor-field-guide/#verifying-functor-laws","title":"Verifying Functor Laws","text":"<pre><code>from agents import verify_functor, MaybeFunctor\n\n# Verify a functor satisfies the laws\nreport = await verify_functor(MaybeFunctor)\nprint(report.is_valid)  # True\n</code></pre>"},{"location":"functor-field-guide/#archetypes-pre-packaged-capabilities","title":"Archetypes: Pre-Packaged Capabilities","text":"<p>Instead of manually adding capabilities, use archetypes:</p> Archetype Capabilities Use Case <code>Kappa</code> All 4 Production services <code>Lambda</code> Observable only Lightweight processors <code>Delta</code> Stateful + Observable Data handlers <pre><code>from agents import Kappa\n\nclass MyService(Kappa[Request, Response]):\n    async def invoke(self, req: Request) -&gt; Response:\n        return process(req)\n</code></pre>"},{"location":"functor-field-guide/#the-halo-system","title":"The Halo System","text":"<p>Capabilities are declared via decorators:</p> <pre><code>from agents import Capability, Agent\n\n@Capability.Stateful(schema=MyState)\n@Capability.Soulful(persona=\"Kent\")\nclass MyAgent(Agent[str, str]):\n    ...\n</code></pre> <p>The Projector compiles Halo \u2192 runtime:</p> <ul> <li>LocalProjector: Runnable Python</li> <li>K8sProjector: Kubernetes manifests</li> </ul> <pre><code>from system.projector import LocalProjector\n\nprojector = LocalProjector()\ncompiled = projector.compile(MyAgent)\n</code></pre>"},{"location":"functor-field-guide/#complete-example","title":"Complete Example","text":"<pre><code>\"\"\"A resilient, persona-aware data processor.\"\"\"\n\nfrom agents import (\n    agent, pipeline, Flux, FluxConfig,\n    Maybe, Just, Nothing, MaybeFunctor,\n)\n\n@agent\nasync def parse_json(raw: str) -&gt; dict:\n    import json\n    return json.loads(raw)\n\n@agent\nasync def extract_value(data: dict) -&gt; int:\n    return data.get(\"value\", 0)\n\n@agent\nasync def apply_business_logic(n: int) -&gt; int:\n    return n * 2 + 1\n\n# Compose the pipeline\ncore_pipeline = pipeline(parse_json, extract_value, apply_business_logic)\n\n# Lift to handle optional inputs\nsafe_pipeline = MaybeFunctor.lift(core_pipeline)\n\n# Lift to handle streams\nflux_pipeline = Flux.lift(safe_pipeline)\n\n# Usage\nasync def process_events(source):\n    async for result in flux_pipeline.start(source):\n        print(f\"Processed: {result}\")\n</code></pre>"},{"location":"functor-field-guide/#summary","title":"Summary","text":"<ol> <li>Agents are morphisms: <code>Agent[A, B]</code> transforms A \u2192 B</li> <li>Functors lift agents: Handle new contexts without changing logic</li> <li>Composition is safe: Laws guarantee structure preservation</li> <li>Archetypes bundle capabilities: Kappa, Lambda, Delta</li> <li>Projectors compile: Halo \u2192 runnable code or K8s manifests</li> </ol> <p>The Alethic Algebra is powerful because it's principled. The laws aren't academic \u2014 they're the reason composition works reliably at scale.</p> <p>\"The difference between a good system and a great one is the last 5%.\"</p>"},{"location":"impl-guide/","title":"Reference Implementation Guide","text":"<p>A practical guide for working with the kgents reference implementation in <code>impl/claude/agents/</code>.</p>"},{"location":"impl-guide/#quick-reference-agent-genera","title":"Quick Reference: Agent Genera","text":"Letter Purpose Key Files Tests a Skeleton architecture <code>skeleton.py</code>, <code>creativity.py</code> <code>test_skeleton.py</code> b Token economics, metering <code>metered_functor.py</code>, <code>hypothesis.py</code> <code>test_banker.py</code> c Category theory, composition <code>functor.py</code>, <code>monad.py</code>, <code>parallel.py</code> <code>test_c_integration.py</code> d State/Memory (Bicameral) <code>bicameral.py</code>, <code>context_comonad.py</code>, <code>context_window.py</code>, <code>linearity.py</code>, <code>projector.py</code> <code>test_bicameral.py</code>, <code>test_comonad.py</code> e Thermodynamic evolution <code>cycle.py</code> \u2014 f Factory pipeline <code>factory.py</code>, <code>parser.py</code> <code>test_factory_integration.py</code> g Grammar/Generation <code>grammar.py</code> \u2014 h Dialectics (Hegel/Jung) \u2014 \u2014 i Interface (SemanticField) <code>semantic_field.py</code>, <code>terrarium_tui.py</code> \u2014 j JIT compilation <code>compiler.py</code>, <code>templates.py</code>, <code>t_integration.py</code> \u2014 k Kent simulacra <code>persona.py</code> \u2014 l Semantic registry <code>semantic_registry.py</code>, <code>server.py</code>, <code>Dockerfile</code> \u2014 m Cartography (HoloMap) <code>cartographer.py</code>, <code>attractors.py</code> \u2014 n Narrative traces <code>chronicle.py</code> \u2014 o Observer functor <code>observer.py</code>, <code>cortex_observer.py</code> \u2014 p Parser/Persistence \u2014 \u2014 psi Metaphor engine <code>engine.py</code>, <code>corpus.py</code>, <code>learning.py</code> <code>test_engine.py</code> q Quartermaster (K8s exec) <code>quartermaster.py</code> \u2014 r Refinery (optimization) <code>refinery.py</code>, <code>advanced.py</code>, <code>integrations.py</code> <code>test_refinery.py</code> t Testing (Types I-V) <code>trustgate.py</code>, mock, spy, judge, property <code>test_trustgate.py</code> u Utility (tools, MCP) <code>core.py</code>, <code>mcp.py</code>, <code>executor.py</code>, <code>orchestration.py</code>, <code>permissions.py</code> <code>test_core.py</code>, <code>test_mcp.py</code> w Wire protocol, bus <code>bus.py</code>, <code>interceptors.py</code> \u2014"},{"location":"impl-guide/#core-patterns","title":"Core Patterns","text":""},{"location":"impl-guide/#1-agent-creation","title":"1. Agent Creation","text":"<p>Every agent follows the <code>Agent[A, B]</code> protocol from <code>bootstrap/types.py</code>:</p> <pre><code>from bootstrap.types import Agent\n\nclass MyAgent(Agent[InputType, OutputType]):\n    async def invoke(self, input: InputType) -&gt; OutputType:\n        # Agent logic\n        return result\n\n    @property\n    def name(self) -&gt; str:\n        return \"my-agent\"\n</code></pre>"},{"location":"impl-guide/#2-composition-via","title":"2. Composition via &gt;&gt;","text":"<p>Agents compose linearly (C-gent pattern):</p> <pre><code>from agents.c.functor import compose\n\npipeline = agent_a &gt;&gt; agent_b &gt;&gt; agent_c\nresult = await pipeline.invoke(input)\n</code></pre>"},{"location":"impl-guide/#3-the-symbiont-pattern-d-gent","title":"3. The Symbiont Pattern (D-gent)","text":"<p>Separate pure logic from stateful memory:</p> <pre><code>from agents.d.symbiont import Symbiont\n\n# Pure agent + D-gent state = Symbiont\nsymbiont = Symbiont(\n    logic=pure_agent,\n    memory=d_gent_instance,\n)\n</code></pre>"},{"location":"impl-guide/#4-observation-o-gent","title":"4. Observation (O-gent)","text":"<p>Wrap agents with observation without affecting behavior:</p> <pre><code>from agents.o.observer import ObserverFunctor\n\nobserved = ObserverFunctor(my_agent, callbacks=[on_before, on_after])\n# observed.invoke() behaves identically but emits observations\n</code></pre>"},{"location":"impl-guide/#5-metering-b-gent","title":"5. Metering (B-gent)","text":"<p>Apply token economics:</p> <pre><code>from agents.b.metered_functor import MeteredFunctor\n\nmetered = MeteredFunctor(my_agent, budget=1000)\n# Raises BudgetExhausted if cost exceeds budget\n</code></pre>"},{"location":"impl-guide/#key-subsystems","title":"Key Subsystems","text":""},{"location":"impl-guide/#bicameral-memory-d-gent","title":"Bicameral Memory (D-gent)","text":"<p>The memory system uses a split-brain architecture:</p> <pre><code>from agents.d.bicameral import create_bicameral_memory\n\nbicameral = create_bicameral_memory(\n    relational=sqlite_store,    # Left brain: structured\n    vector=vector_store,        # Right brain: semantic\n    embedder=embed_fn,\n    auto_heal_ghosts=True,      # Reconcile orphan refs\n)\n\nresults = await bicameral.recall(\"query\")\n</code></pre> <p>Files: <code>agents/d/bicameral.py</code>, <code>agents/d/lens.py</code></p>"},{"location":"impl-guide/#synapse-active-inference","title":"Synapse (Active Inference)","text":"<p>Routes memories based on surprise:</p> <pre><code>from instance_db.synapse import Synapse, SynapseConfig\n\nsynapse = Synapse(\n    store=memory_store,\n    config=SynapseConfig(\n        surprise_threshold=0.5,   # Fast path\n        flashbulb_threshold=0.9,  # Immediate storage\n    ),\n)\n\nawait synapse.fire(signal)  # Auto-routes to appropriate path\n</code></pre> <p>Files: <code>instance_db/synapse.py</code></p>"},{"location":"impl-guide/#semantic-field-stigmergy","title":"Semantic Field (Stigmergy)","text":"<p>Agents communicate via pheromone-like signals:</p> <pre><code>from agents.i.semantic_field import create_semantic_field, PheromoneType\n\nfield = create_semantic_field()\n\n# Emit signal\nfield.emit(PheromoneType.METAPHOR, data={\"source\": \"A\", \"target\": \"B\"})\n\n# Sense signals\nsignals = field.sense(PheromoneType.METAPHOR, threshold=0.5)\n</code></pre> <p>Files: <code>agents/i/semantic_field.py</code></p>"},{"location":"impl-guide/#m-gent-cartography","title":"M-gent Cartography","text":"<p>Memory-as-orientation with HoloMap:</p> <pre><code>from agents.m.cartographer import create_cartographer, Resolution\n\ncartographer = create_cartographer(vector_search, trace_store)\nholo_map = await cartographer.invoke(context_vector, Resolution.ADAPTIVE)\n# Returns: landmarks, desire_lines, voids, horizon\n</code></pre> <p>Files: <code>agents/m/cartographer.py</code>, <code>agents/m/attractors.py</code></p>"},{"location":"impl-guide/#ghost-substrate-sync-phase-8","title":"Ghost \u2194 Substrate Sync (Phase 8)","text":"<p>Bidirectional Galois link between ghost cache and substrate allocations (Phase 8 drift fix).</p> <pre><code># Events emitted by impl/claude/agents/m/ghost_sync.py\nevent_types = [\"store_to_ghost\", \"ghost_access\", \"invalidate\"]\nspan_names = [\"m.ghost_sync.store\", \"m.ghost_sync.access\", \"m.ghost_sync.invalidate\"]\npayload = {\n    \"agent_id\": str(allocation.agent_id),\n    \"concept_id\": concept_id,\n    \"ghost_key\": ghost_key,\n    \"namespace\": allocation.namespace,\n    \"ttl_ms\": allocation.lifecycle.ttl.total_seconds() * 1000,\n    \"success\": success,\n    \"reason\": reason,\n    \"law_check\": True,  # floor \u22a3 ceiling\n}\n</code></pre> <ul> <li>Law: <code>floor(ceiling(a)) \u2245 a</code> (metadata only; content stays in substrate).  </li> <li>Failure handling: Ghost write failure does NOT roll back the substrate write. Emit span with <code>success=false</code>, record reason in <code>GhostSyncEvent</code>, and enqueue reconciliation. Missing allocation on ghost access marks <code>success=false</code> and emits <code>law_check</code> span with <code>result=fail</code>.  </li> <li>Metrics: <code>ghost_sync.events_total{event_type}</code>, <code>ghost_sync.failures_total{event_type}</code>, <code>ghost_sync.drift_ms</code> (ghost touch \u2192 allocation access lag).</li> </ul>"},{"location":"impl-guide/#-gent-metaphor-engine","title":"\u03a8-gent Metaphor Engine","text":"<p>Six-stage reasoning pipeline:</p> <pre><code>from agents.psi.engine import MetaphorEngine\nfrom agents.psi.types import Problem\n\nengine = MetaphorEngine()\nsolution = engine.solve_problem(\n    Problem(\n        id=\"prob-1\",\n        description=\"The API is slow\",\n        domain=\"performance\",\n        constraints=[\"must not break existing clients\"],\n    )\n)\n# Returns: Solution with metaphor_solution, translated_answer, distortion\n</code></pre> <p>Stages: RETRIEVE \u2192 PROJECT \u2192 CHALLENGE \u2192 SOLVE \u2192 TRANSLATE \u2192 VERIFY</p> <p>Files: <code>agents/psi/engine.py</code>, <code>agents/psi/corpus.py</code>, <code>agents/psi/learning.py</code></p>"},{"location":"impl-guide/#r-gent-refinery","title":"R-gent Refinery","text":"<p>Prompt optimization via teleprompters:</p> <pre><code>from agents.r.refinery import RefineryAgent\nfrom agents.r.types import Signature, OptimizationBudget\n\nrefinery = RefineryAgent(teleprompter=my_teleprompter)\noptimized = await refinery.refine(\n    agent=target_agent,\n    signature=Signature(...),\n    examples=training_examples,\n    budget=OptimizationBudget(max_iterations=10),\n)\n</code></pre> <p>Files: <code>agents/r/refinery.py</code>, <code>agents/r/advanced.py</code>, <code>agents/r/dspy_backend.py</code></p>"},{"location":"impl-guide/#w-gent-interceptors","title":"W-gent Interceptors","text":"<p>Pipeline: Safety(50) \u2192 Metering(100) \u2192 Telemetry(200) \u2192 Persona(300)</p> <pre><code>from agents.w.interceptors import InterceptorPipeline, SafetyInterceptor\n\npipeline = InterceptorPipeline([\n    SafetyInterceptor(priority=50),\n    MeteringInterceptor(priority=100),\n])\n\n# Apply to agent invocations\nresult = await pipeline.intercept(agent, input)\n</code></pre> <p>Files: <code>agents/w/interceptors.py</code>, <code>agents/w/bus.py</code></p>"},{"location":"impl-guide/#context-comonad-d-gent","title":"Context Comonad (D-gent)","text":"<p>Store comonad for context window management:</p> <pre><code>from agents.d.context_comonad import ContextComonad\n\ncomonad = ContextComonad(initial_state)\n\n# Extract current value\ncurrent = comonad.extract()\n\n# Extend with a function\nextended = comonad.extend(lambda ctx: transform(ctx.extract()))\n\n# Duplicate for nested context\nduplicated = comonad.duplicate()\n</code></pre> <p>Files: <code>agents/d/context_comonad.py</code>, <code>agents/d/context_window.py</code>, <code>agents/d/linearity.py</code>, <code>agents/d/projector.py</code></p>"},{"location":"impl-guide/#trustgate-t-gent","title":"TrustGate (T-gent)","text":"<p>Capability-based trust verification:</p> <pre><code>from agents.t.trustgate import TrustGate, BypassToken\n\ngate = TrustGate(ledger=capital_ledger)\n\n# Check if agent has sufficient trust\nif await gate.verify(agent_id, required_trust=100):\n    # Proceed with operation\n    pass\n\n# Bypass for privileged operations (unforgeable capability)\ntoken = BypassToken.create(reason=\"admin override\")\nawait gate.bypass(token, operation)\n</code></pre> <p>Files: <code>agents/t/trustgate.py</code></p>"},{"location":"impl-guide/#u-gent-tools-mcp","title":"U-gent Tools &amp; MCP","text":"<p>Tool execution and MCP integration (migrated from T-gent):</p> <pre><code>from agents.u.core import Tool, ToolRegistry\nfrom agents.u.mcp import MCPClient\nfrom agents.u.executor import ToolExecutor\n\n# Register tools\nregistry = ToolRegistry()\nregistry.register(my_tool)\n\n# Execute via MCP\nclient = MCPClient(server_url)\nresult = await client.call_tool(\"tool_name\", args)\n\n# Or via executor\nexecutor = ToolExecutor(registry)\nresult = await executor.execute(\"tool_name\", args)\n</code></pre> <p>Files: <code>agents/u/core.py</code>, <code>agents/u/mcp.py</code>, <code>agents/u/executor.py</code>, <code>agents/u/orchestration.py</code></p>"},{"location":"impl-guide/#capital-accounting-shared","title":"Capital Accounting (shared)","text":"<p>Event-sourced trust ledger:</p> <pre><code>from shared.capital import CapitalLedger, Transaction\nfrom shared.costs import OperationCost\nfrom shared.budget import Budget\n\nledger = CapitalLedger()\n\n# Record transaction\nledger.record(Transaction(\n    agent_id=\"agent-1\",\n    amount=100,\n    operation=\"tool_call\",\n))\n\n# Check balance (derived from events)\nbalance = ledger.balance(\"agent-1\")\n\n# Budget allocation\nbudget = Budget(total=1000)\nbudget.allocate(\"agent-1\", 500)\n</code></pre> <p>Files: <code>shared/capital.py</code>, <code>shared/costs.py</code>, <code>shared/budget.py</code></p>"},{"location":"impl-guide/#pataphysics-shared","title":"Pataphysics (shared)","text":"<p>Exception semantics and imaginary solutions:</p> <pre><code>from shared.pataphysics import PataphysicsSolver, ImaginarySolution\n\nsolver = PataphysicsSolver()\n\n# Find solution in exception space\nsolution = solver.solve(\n    problem=\"impossible constraint\",\n    constraints=[\"must be X\", \"must not be X\"],\n)\n# Returns ImaginarySolution with clinamen (swerve) and syzygy (alignment)\n</code></pre> <p>Files: <code>shared/pataphysics.py</code>, <code>shared/melting.py</code></p>"},{"location":"impl-guide/#wundt-curator-middleware","title":"Wundt Curator (middleware)","text":"<p>Aesthetic filtering based on Wundt curve:</p> <pre><code>from protocols.agentese.middleware.curator import WundtCurator\n\ncurator = WundtCurator(\n    complexity_threshold=0.7,\n    novelty_weight=0.5,\n)\n\n# Filter outputs by aesthetic value\nfiltered = await curator.curate(outputs)\n</code></pre> <p>Files: <code>protocols/agentese/middleware/curator.py</code></p>"},{"location":"impl-guide/#concept-blending-contexts","title":"Concept Blending (contexts)","text":"<p>Fauconnier-Turner conceptual integration:</p> <pre><code>from protocols.agentese.contexts.concept_blend import ConceptBlender\n\nblender = ConceptBlender()\n\n# Blend two input spaces\nblend = await blender.blend(\n    space1={\"frame\": \"journey\", \"elements\": [...]},\n    space2={\"frame\": \"argument\", \"elements\": [...]},\n)\n# Returns emergent structure with novel inferences\n</code></pre> <p>Files: <code>protocols/agentese.contexts/concept_blend.py</code></p>"},{"location":"impl-guide/#self-judgment-contexts","title":"Self Judgment (contexts)","text":"<p>Critic's loop for dialectical refinement:</p> <pre><code>from protocols.agentese.contexts.self_judgment import CriticLoop\n\ncritic = CriticLoop()\n\n# Refine through dialectical challenge\nrefined = await critic.refine(\n    thesis=initial_output,\n    criteria=[\"clarity\", \"correctness\", \"elegance\"],\n    max_iterations=3,\n)\n</code></pre> <p>Files: <code>protocols/agentese/contexts/self_judgment.py</code></p>"},{"location":"impl-guide/#integration-patterns","title":"Integration Patterns","text":""},{"location":"impl-guide/#cross-agent-integration-files","title":"Cross-Agent Integration Files","text":"<p>When agents need to collaborate, use <code>*_integration.py</code> files:</p> <ul> <li><code>agents/b/egent_integration.py</code> - B-gent + E-gent</li> <li><code>agents/b/robin_integration.py</code> - B-gent redistribution</li> <li><code>agents/c/j_integration.py</code> - C-gent + J-gent</li> <li><code>agents/psi/integrations.py</code> - \u03a8-gent bridges</li> </ul>"},{"location":"impl-guide/#foundational-agents","title":"Foundational Agents","text":"<p>These can be imported anywhere without circular deps:</p> <ul> <li><code>shared</code> - Common utilities</li> <li><code>a</code> - Skeleton types</li> <li><code>d</code> - State primitives</li> <li><code>l</code> - Registry</li> <li><code>c</code> - Composition</li> </ul>"},{"location":"impl-guide/#semanticfield-for-decoupling","title":"SemanticField for Decoupling","text":"<p>When direct imports would create cycles, use pheromones:</p> <pre><code># In Agent A (emitter)\nfield.emit(PheromoneType.OPPORTUNITY, {\"budget\": 1000})\n\n# In Agent B (sensor) - no import of A needed\nopportunities = field.sense(PheromoneType.OPPORTUNITY)\n</code></pre>"},{"location":"impl-guide/#cli-entry-points","title":"CLI Entry Points","text":"<p>K-Terrarium (Kubernetes): <pre><code>kgents infra init        # Create cluster\nkgents infra status      # Show state\nkgents infra apply &lt;agent&gt;  # Deploy agent\nkgents dev &lt;agent&gt;       # Live reload\n</code></pre></p> <p>DevEx: <pre><code>kgents status            # Cortex health\nkgents dream             # LucidDreamer briefing\nkgents map               # HoloMap visualization\nkgents signal            # SemanticField state\nkgents ghost             # Project to .kgents/ghost/\n</code></pre></p>"},{"location":"impl-guide/#testing-conventions","title":"Testing Conventions","text":"<ul> <li>Tests live in <code>_tests/</code> subdirectories</li> <li>Slow tests marked with <code>@pytest.mark.slow</code></li> <li>External deps (Redis, SQL) gracefully skipped</li> </ul> <pre><code>pytest -m \"not slow\" -q              # Fast tests\npytest impl/claude/agents/d/ -v      # Specific agent\n</code></pre>"},{"location":"impl-guide/#common-gotchas","title":"Common Gotchas","text":"Issue Fix Python 3.12 syntax Use <code>Generic[A]</code> + <code>TypeVar</code>, not <code>class Foo[A]:</code> Cross-agent imports Use <code>*_integration.py</code> files or SemanticField Forward refs <code>from __future__ import annotations</code> + <code>TYPE_CHECKING</code> Mypy errors Now strict mode (0 errors); run <code>uv run mypy .</code> T-gent vs U-gent T = Testing (Types I-V, TrustGate); U = Utility (tools, MCP, executor) Dockerfiles Use <code>__deps__.py</code> manifests; validate with <code>build_agent_image.py</code>"},{"location":"impl-guide/#whats-not-implemented-spec-only","title":"What's NOT Implemented (Spec Only)","text":"<p>These exist in <code>spec/</code> but not <code>impl/</code>:</p> Agent Spec Location Status \u03a9-gent (Somatic) <code>spec/omega-gents/</code> Spec complete, no impl Y-gent (Topology) <code>spec/y-gents/</code> Partial I-gent v2.5 (Semantic Flux) <code>plans/self/interface.md</code> Spec complete, awaiting impl Z-gent (Zettelkasten) \u2014 Specced in principles <p>The \u03a9-gent morpheme system and <code>self.body.*</code> proprioception are fully specified but awaiting implementation.</p> <p>The I-gent v2.5 \"Semantic Flux\" interface (density fields, flow arrows, glitch mechanic) is fully specified in <code>plans/self/interface.md</code> but not yet implemented.</p>"},{"location":"impl-guide/#architecture-philosophy","title":"Architecture Philosophy","text":"<ol> <li>Spec \u2192 Impl: Read the spec first (<code>spec/&lt;letter&gt;-gents/</code>)</li> <li>Category Laws: Composition must satisfy identity and associativity</li> <li>Orthogonality: Optional features (metadata, protocols) don't break composition</li> <li>Minimal Output: LLM agents return single outputs; composition happens at pipeline level</li> <li>Graceful Degradation: Systems work (degraded) when deps are missing</li> </ol>"},{"location":"local-development/","title":"Local Development Setup","text":"<p>Complete guide to running kgents locally, including the Agent Town web UI and backend API.</p>"},{"location":"local-development/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.11+ with uv package manager</li> <li>Node.js 18+ with npm</li> <li>Git</li> </ul>"},{"location":"local-development/#quick-start-tldr","title":"Quick Start (TL;DR)","text":"<pre><code># Terminal 1: Backend\ncd impl/claude\nuv run uvicorn protocols.api.app:create_app --factory --reload --port 8000\n\n# Terminal 2: Frontend\ncd impl/claude/web\nnpm install &amp;&amp; npm run dev\n\n# Visit http://localhost:3000\n</code></pre>"},{"location":"local-development/#detailed-setup","title":"Detailed Setup","text":""},{"location":"local-development/#1-clone-and-install-dependencies","title":"1. Clone and Install Dependencies","text":"<pre><code>git clone https://github.com/yourusername/kgents.git\ncd kgents\n\n# Install Python dependencies\nuv sync\n\n# Install frontend dependencies\ncd impl/claude/web\nnpm install\n</code></pre>"},{"location":"local-development/#2-backend-api","title":"2. Backend API","text":"<p>The backend provides REST endpoints for Agent Town, AGENTESE, and K-gent Soul.</p> <pre><code>cd impl/claude\n\n# Start with auto-reload for development\nuv run uvicorn protocols.api.app:create_app --factory --reload --port 8000\n</code></pre> <p>Key flags: - <code>--factory</code> - Required because <code>create_app()</code> is a factory function - <code>--reload</code> - Auto-restart on code changes - <code>--port 8000</code> - Default port (frontend expects this)</p> <p>Verify it's working: <pre><code>curl http://localhost:8000/health\n# Should return: {\"status\":\"ok\",...}\n\ncurl http://localhost:8000/\n# Should list all available endpoints\n</code></pre></p>"},{"location":"local-development/#3-frontend-web-ui","title":"3. Frontend Web UI","text":"<pre><code>cd impl/claude/web\n\n# Create environment file\ncp .env.example .env\n\n# Start development server\nnpm run dev\n</code></pre> <p>Visit <code>http://localhost:3000</code></p>"},{"location":"local-development/#4-authentication-development","title":"4. Authentication (Development)","text":"<p>The frontend uses Zustand for state management with localStorage persistence. For development, mock a logged-in user via browser console:</p> <pre><code>// Open browser DevTools (F12) \u2192 Console tab\n// Paste this to log in as CITIZEN tier:\n\nlocalStorage.setItem('agent-town-user', JSON.stringify({\n  state: {\n    isAuthenticated: true,\n    userId: 'dev-user-001',\n    apiKey: 'dev-api-key',\n    tier: 'CITIZEN',\n    credits: 500,\n    monthlyUsage: {}\n  },\n  version: 0\n}));\nlocation.reload();\n</code></pre> <p>Available tiers for testing: - <code>TOURIST</code> - Free tier, limited features - <code>RESIDENT</code> - $9.99/mo, basic INHABIT - <code>CITIZEN</code> - $29.99/mo, full INHABIT + Force - <code>FOUNDER</code> - $99.99/yr, unlimited</p> <p>To log out: <pre><code>localStorage.removeItem('agent-town-user');\nlocation.reload();\n</code></pre></p>"},{"location":"local-development/#running-tests","title":"Running Tests","text":""},{"location":"local-development/#backend-tests","title":"Backend Tests","text":"<pre><code>cd impl/claude\nuv run pytest protocols/api/_tests/ -v\n</code></pre>"},{"location":"local-development/#frontend-tests","title":"Frontend Tests","text":"<pre><code>cd impl/claude/web\n\n# Run once\nnpm run test -- --run\n\n# Watch mode\nnpm run test\n\n# With coverage\nnpm run test:coverage\n\n# With UI\nnpm run test:ui\n</code></pre>"},{"location":"local-development/#type-checking","title":"Type Checking","text":"<pre><code># Backend\ncd impl/claude\nuv run mypy protocols/api/\n\n# Frontend\ncd impl/claude/web\nnpm run typecheck\n</code></pre>"},{"location":"local-development/#api-endpoints","title":"API Endpoints","text":"<p>Once the backend is running, these endpoints are available:</p>"},{"location":"local-development/#agent-town","title":"Agent Town","text":"Method Endpoint Description POST <code>/v1/town</code> Create a new town GET <code>/v1/town/{id}</code> Get town details GET <code>/v1/town/{id}/citizens</code> List all citizens GET <code>/v1/town/{id}/citizen/{name}</code> Get citizen details GET <code>/v1/town/{id}/live</code> SSE stream of events POST <code>/v1/town/{id}/inhabit/{citizen}</code> Start INHABIT session"},{"location":"local-development/#k-gent-soul","title":"K-gent Soul","text":"Method Endpoint Description POST <code>/v1/soul/governance</code> Semantic gatekeeper POST <code>/v1/soul/dialogue</code> Interactive dialogue"},{"location":"local-development/#system","title":"System","text":"Method Endpoint Description GET <code>/health</code> Health check GET <code>/docs</code> OpenAPI documentation"},{"location":"local-development/#environment-variables","title":"Environment Variables","text":""},{"location":"local-development/#backend","title":"Backend","text":"<p>Set in your shell or <code>.env</code> file:</p> Variable Description Default <code>ANTHROPIC_API_KEY</code> Claude API key for LLM features - <code>OPENROUTER_API_KEY</code> Alternative LLM provider -"},{"location":"local-development/#frontend","title":"Frontend","text":"<p>Set in <code>impl/claude/web/.env</code>:</p> Variable Description Default <code>VITE_API_URL</code> Backend URL <code>http://localhost:8000</code> <code>VITE_STRIPE_PUBLISHABLE_KEY</code> Stripe test mode key -"},{"location":"local-development/#common-issues","title":"Common Issues","text":""},{"location":"local-development/#backend-wont-start-module-object-is-not-callable","title":"Backend won't start: \"module object is not callable\"","text":"<p>Use the <code>--factory</code> flag: <pre><code>uv run uvicorn protocols.api.app:create_app --factory --port 8000\n</code></pre></p>"},{"location":"local-development/#frontend-shows-demo-unavailable","title":"Frontend shows \"Demo unavailable\"","text":"<p>Backend isn't running or town routes aren't registered. Check: 1. Backend is running on port 8000 2. <code>curl http://localhost:8000/v1/town/test</code> doesn't return 404</p>"},{"location":"local-development/#port-8000-already-in-use","title":"Port 8000 already in use","text":"<pre><code># Find the process\nlsof -i :8000\n\n# Kill it\nkill -9 &lt;PID&gt;\n\n# Or use a different port\nuv run uvicorn protocols.api.app:create_app --factory --port 8001\n# Update VITE_API_URL in frontend .env\n</code></pre>"},{"location":"local-development/#cors-errors-in-browser","title":"CORS errors in browser","text":"<p>The backend includes CORS middleware allowing all origins in development. If you still see CORS errors: 1. Ensure backend is running 2. Check the request URL matches <code>VITE_API_URL</code> 3. Try hard refresh (Ctrl+Shift+R)</p>"},{"location":"local-development/#tests-failing-with-timing-issues","title":"Tests failing with timing issues","text":"<p>Some async tests may be flaky. Run them individually: <pre><code>npm run test -- tests/unit/hooks/useInhabitSession.test.ts --run\n</code></pre></p>"},{"location":"local-development/#architecture-overview","title":"Architecture Overview","text":"<pre><code>kgents/\n\u251c\u2500\u2500 spec/                    # Specifications (implementation-agnostic)\n\u251c\u2500\u2500 impl/claude/             # Reference implementation\n\u2502   \u251c\u2500\u2500 agents/              # Agent implementations (A-Z taxonomy)\n\u2502   \u2502   \u251c\u2500\u2500 k/               # K-gent (Kent simulacra)\n\u2502   \u2502   \u2514\u2500\u2500 town/            # Agent Town simulation\n\u2502   \u251c\u2500\u2500 protocols/\n\u2502   \u2502   \u251c\u2500\u2500 api/             # FastAPI REST endpoints\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 app.py       # Main application factory\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 town.py      # Town endpoints\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 soul.py      # Soul endpoints\n\u2502   \u2502   \u2514\u2500\u2500 agentese/        # AGENTESE protocol\n\u2502   \u2514\u2500\u2500 web/                 # React frontend\n\u2502       \u251c\u2500\u2500 src/\n\u2502       \u2514\u2500\u2500 tests/\n\u2514\u2500\u2500 docs/                    # Documentation\n</code></pre>"},{"location":"local-development/#next-steps","title":"Next Steps","text":"<ul> <li>Read AGENTESE specification</li> <li>Explore Agent Town</li> <li>Check systems reference for built infrastructure</li> </ul>"},{"location":"monetization-infrastructure/","title":"Agent Town Monetization Infrastructure","text":""},{"location":"monetization-infrastructure/#overview","title":"Overview","text":"<p>Track C implementation of the Agent Town master plan (unified-v2.md). Complete payment and monetization infrastructure with margin-safe pricing, ethical guardrails, and kill-switch monitoring.</p> <p>Status: \u2705 Complete Exit Criteria: All met Tests: 82 passing</p>"},{"location":"monetization-infrastructure/#components-implemented","title":"Components Implemented","text":""},{"location":"monetization-infrastructure/#1-budgetstore-credit-subscription-management","title":"1. BudgetStore (Credit &amp; Subscription Management)","text":"<p>Location: <code>impl/claude/agents/town/budget_store.py</code></p> <p>Revised from token-based to credit-based system with subscription tier support.</p> <p>Key Features: - <code>UserBudgetInfo</code>: Tracks credits, subscription tier, monthly usage - <code>ConsentState</code>: Implements consent debt meter for INHABIT force mechanic - <code>SubscriptionTier</code>: Defines TOURIST, RESIDENT, CITIZEN, FOUNDER tiers - <code>InMemoryBudgetStore</code>: Dev/test implementation - <code>RedisBudgetStore</code>: Production implementation with automatic monthly resets</p> <p>Subscription Tiers: | Tier | Price | LOD Access | Features | |------|-------|------------|----------| | TOURIST | FREE | 0-1 unlimited | Demo only | | RESIDENT | $9.99/mo | 0-2 unlimited, 50 LOD3/mo | Basic INHABIT, 1 town | | CITIZEN | $29.99/mo | 0-3 unlimited, 20 LOD4/mo | Full INHABIT + force, branching 3/mo, 5 towns | | FOUNDER | $99.99/mo | 0-4 unlimited, 50 LOD5/mo | Unlimited INHABIT/branching, API access |</p> <p>Consent Debt Mechanics: - Debt: 0.0 (harmony) \u2192 1.0 (rupture) - Force increases debt by 0.2, resets 60s cooldown - Debt decays at 0.001/sec - Apologize reduces debt by 0.1 - At debt &gt;= 0.8: force blocked - At debt = 1.0: citizen refuses all interaction (rupture)</p> <p>Tests: 23 passing</p>"},{"location":"monetization-infrastructure/#2-paywall-logic","title":"2. Paywall Logic","text":"<p>Location: <code>impl/claude/agents/town/paywall.py</code></p> <p>Pure function implementing paywall decisions per spec/town/monetization.md \u00a79.</p> <p>Key Features: - <code>check_paywall()</code>: Pure function determining action access - Action catalog with margin-safe pricing - Feature access checks (INHABIT, branching) - Upgrade option generation - Consent debt validation</p> <p>Credit Costs (per unified-v2.md \u00a71): | Action | Model | Credits | Price Range | Margin | |--------|-------|---------|-------------|--------| | LOD 3 | Haiku | 10 | $0.01-0.05 | 95-99% | | LOD 4 | Sonnet | 100 | $0.02-0.05 | 30-70% | | LOD 5 | Opus | 400 | $0.10-0.40 | 0-73% | | INHABIT (10min) | Mixed | 100 | $0.02-0.10 | -60-50% | | Force | Sonnet | 50 | $0.01-0.025 | 28-78% | | Branch Create | Storage | 150 | $0.03-0.15 | 66-93% |</p> <p>Laws: 1. If action in subscription allowance: allowed, cost=0 2. If action requires credits and user has enough: allowed, charge credits 3. If insufficient credits: blocked, show upgrade options 4. If feature not available to tier: blocked, show tier upgrade</p> <p>Tests: 28 passing</p>"},{"location":"monetization-infrastructure/#3-stripe-payment-integration","title":"3. Stripe Payment Integration","text":"<p>Location: <code>impl/claude/protocols/api/payments.py</code></p> <p>Stripe integration for subscriptions and one-time credit pack purchases.</p> <p>Key Features: - <code>PaymentClient</code>: Stripe API wrapper - Subscription checkout sessions - Credit pack checkout sessions - Customer management - Webhook event handlers - <code>MockPaymentClient</code>: Testing without Stripe</p> <p>Webhook Handlers: - <code>subscription.created</code> \u2192 Update tier, set renewal date - <code>subscription.updated</code> \u2192 Update status - <code>subscription.deleted</code> \u2192 Downgrade to TOURIST - <code>payment_intent.succeeded</code> \u2192 Add credits to balance</p> <p>Credit Packs: | Pack | Credits | Price | $/Credit | Break-even Actions | |------|---------|-------|----------|-------------------| | Starter | 500 | $4.99 | $0.010 | 50 LOD3 or 5 LOD4 | | Explorer | 2,500 | $19.99 | $0.008 | 250 LOD3 or 25 LOD4 | | Adventurer | 10,000 | $59.99 | $0.006 | 1000 LOD3 or 100 LOD4 |</p> <p>Tests: 12 passing (+ 2 skipped integration tests)</p>"},{"location":"monetization-infrastructure/#4-kill-switch-monitoring","title":"4. Kill-Switch Monitoring","text":"<p>Location: <code>impl/claude/agents/town/kill_switch.py</code></p> <p>Automated safety thresholds per unified-v2.md \u00a75 to halt operations if economics or ethics breach acceptable levels.</p> <p>Kill-Switch Conditions: | Condition | Threshold | Action | Severity | |-----------|-----------|--------|----------| | CAC/LTV ratio | &gt; 30% | Halt paid acquisition | KILL_SWITCH | | M1 churn | &gt; 25% | Emergency retention review | CRITICAL | | Conversion rate | &lt; 3% | Pause monetization | CRITICAL | | LOD unlock rate | &lt; 5% | Revisit paywall UX | WARNING | | Force rate | &gt; 30% | Ethics review | CRITICAL |</p> <p>Key Features: - <code>MetricCalculator</code>: Calculate business/ethics metrics - <code>KillSwitchMonitor</code>: Monitor thresholds, generate alerts - Alert acknowledgment system - Operational safety checks (<code>is_safe_to_operate()</code>)</p> <p>Example Metrics: <pre><code>calc = MetricCalculator()\n\n# Conservative scenario: CAC $10, LTV $75 \u2192 13.3% (good)\nmetric = calc.calculate_cac_ltv_ratio(total_cac=10.0, total_ltv=75.0)\n\nmonitor = KillSwitchMonitor()\nalert = monitor.check_metric(metric)  # None (no breach)\nassert monitor.is_safe_to_operate()  # True\n</code></pre></p> <p>Tests: 19 passing</p>"},{"location":"monetization-infrastructure/#demo-flow","title":"Demo Flow","text":"<p>Location: <code>impl/claude/agents/town/demo/monetization_demo.py</code></p> <p>Full end-to-end demonstration:</p> <ol> <li>Tourist tries LOD 3 \u2192 Paywall (blocked, shows upgrade options)</li> <li>Upgrade to RESIDENT ($9.99/mo via Stripe)</li> <li>Webhook processes subscription.created \u2192 Update tier</li> <li>Access LOD 3 with monthly allowance (50/mo included)</li> <li>Exhaust allowance \u2192 Paywall (need credits)</li> <li>Purchase STARTER pack (500 credits, $4.99)</li> <li>Use credits for LOD 3 (10 credits each)</li> <li>Try LOD 4 (100 credits, allowed with credits)</li> </ol> <p>Run with: <code>python -m impl.claude.agents.town.demo.monetization_demo</code></p>"},{"location":"monetization-infrastructure/#exit-criteria","title":"Exit Criteria","text":"<p>\u2705 All criteria met:</p> <ul> <li> BudgetStore tracks credits, subscription tier, monthly usage</li> <li> check_paywall() returns correct response for all LOD levels</li> <li> Stripe Checkout session creation works (test mode)</li> <li> Webhook updates user subscription status</li> <li> Kill-switch alerts defined (CAC &gt; 30% LTV, churn &gt; 25%, etc.)</li> <li> 82 tests passing (exceeded 40+ target)</li> <li> Demo path verified: Tourist \u2192 paywall \u2192 Resident upgrade \u2192 LOD3 access</li> </ul>"},{"location":"monetization-infrastructure/#test-coverage","title":"Test Coverage","text":"Module Tests Focus <code>test_budget_store.py</code> 23 ConsentState, UserBudgetInfo, store operations <code>test_paywall.py</code> 28 LOD access, INHABIT, branching, upgrade options <code>test_kill_switch.py</code> 19 Metrics calculation, threshold monitoring, alerts <code>test_payments.py</code> 12 Stripe integration, webhooks, mock client Total 82 <p>All tests passing. 2 skipped (Stripe integration tests requiring API keys).</p>"},{"location":"monetization-infrastructure/#key-principles-applied","title":"Key Principles Applied","text":"<ol> <li>Margin before magic: All pricing is margin-safe (30%+ gross margin targets)</li> <li>Safety before speed: Consent debt meter prevents unethical force use</li> <li>Instrument before monetize: Kill-switch conditions monitor business health</li> <li>Ethical guardrails: Force requires opt-in, expensive, logged, limited</li> <li>Generative from spec: Implementation derives from spec/town/monetization.md</li> </ol>"},{"location":"monetization-infrastructure/#next-steps","title":"Next Steps","text":"<p>For Kent: 1. Configure Stripe production account 2. Set environment variables:    - <code>STRIPE_SECRET_KEY</code>    - <code>STRIPE_PUBLISHABLE_KEY</code>    - <code>STRIPE_WEBHOOK_SECRET</code> 3. Create Stripe products for subscription tiers 4. Create Stripe products for credit packs 5. Set price IDs in environment 6. Deploy with Redis for production BudgetStore</p> <p>For Track D (Web UI MVP): - Integrate paywall checks into LOD unlock buttons - Add subscription management UI - Add credit pack purchase buttons - Display kill-switch status in admin dashboard - Show consent debt meter during INHABIT</p>"},{"location":"monetization-infrastructure/#files-createdmodified","title":"Files Created/Modified","text":"<p>Created: - <code>impl/claude/agents/town/paywall.py</code> (345 lines) - <code>impl/claude/agents/town/kill_switch.py</code> (520 lines) - <code>impl/claude/protocols/api/payments.py</code> (650 lines) - <code>impl/claude/agents/town/demo/monetization_demo.py</code> (270 lines) - <code>impl/claude/agents/town/_tests/test_budget_store.py</code> (285 lines) - <code>impl/claude/agents/town/_tests/test_paywall.py</code> (450 lines) - <code>impl/claude/agents/town/_tests/test_kill_switch.py</code> (390 lines) - <code>impl/claude/protocols/api/_tests/test_payments.py</code> (150 lines)</p> <p>Modified: - <code>impl/claude/agents/town/budget_store.py</code> (revised for credit-based system)</p> <p>Total: ~3,060 lines of implementation + tests</p> <p>\"Margin before magic. Safety before speed. Instrument before monetize.\"</p>"},{"location":"nphase-agent-town/","title":"N-Phase \u21c4 Agent Town Runtime Hooks","text":"<p>This note records how to use the N-Phase compiler inside the REPL, via CLI, and how Agent Town exposes compressed phase (SENSE/ACT/REFLECT) state to SaaS dashboards.</p>"},{"location":"nphase-agent-town/#repl-shortcuts-agentese","title":"REPL shortcuts (agentese)","text":"<ul> <li><code>/nphase &lt;definition.yaml&gt;</code> \u2192 compile (defaults to <code>compile</code> when first arg is a path)</li> <li><code>/nphase-validate &lt;definition.yaml&gt;</code> \u2192 validate only</li> <li><code>/nphase-template &lt;PHASE&gt;</code> \u2192 print a phase template (e.g., PLAN, ACT)</li> <li><code>/nphase-bootstrap &lt;plan.md&gt;</code> \u2192 bootstrap from a plan header then compile</li> </ul>"},{"location":"nphase-agent-town/#cli-usage","title":"CLI usage","text":"<pre><code>kgents nphase compile projects/my-feature.yaml -o prompts/my-feature.md\nkgents nphase validate projects/my-feature.yaml\nkgents nphase template ACT\nkgents nphase bootstrap plans/crown-jewel-next.md -o prompts/crown-jewel-next.md\n</code></pre>"},{"location":"nphase-agent-town/#town-runtime-hook-saas","title":"Town runtime hook (SaaS)","text":"<ul> <li>Citizens now carry <code>NPhaseState</code> (compressed SENSE/ACT/REFLECT). Advancing with <code>citizen.advance_nphase(...)</code> records ledger entries and cycle counts.</li> <li>Town flux can emit transitions: <code>TownFlux.emit_nphase_transition(town_id, citizen, target, nats=bridge, sse=endpoint, payload=meta)</code>.</li> <li>NATS subject: <code>town.{town_id}.nphase.transition</code> (payload includes <code>citizen_id</code>, <code>from</code>, <code>to</code>, <code>cycle</code>, <code>payload</code>, <code>timestamp</code>).</li> <li>SSE event: <code>town.nphase.transition</code> with the same ledger payload for dashboards.</li> </ul>"},{"location":"nphase-agent-town/#worked-example","title":"Worked example","text":"<p>1) Define project YAML: <pre><code>name: \"Town Feature Rollout\"\nclassification: \"standard\"\nn_phases: 3\nscope:\n  goal: \"Pilot a new greeting ritual across 3 regions\"\n  non_goals: [\"economy changes\"]\n  parallel_tracks:\n    A: \"Citizen training\"\n    B: \"Ritual instrumentation\"\ndecisions:\n  - id: D1\n    choice: \"Use compressed 3-phase cycle\"\n    rationale: \"Fast feedback for pilot\"\nwaves:\n  - id: W1\n    name: \"Pilot\"\n    components: [\"Ritual prompt\", \"Metrics hook\"]\n</code></pre> 2) Compile from REPL: <code>/nphase projects/town-feature.yaml -o prompts/town-feature.md</code> 3) From a Town loop, advance a citizen and emit: <pre><code>await town_flux.emit_nphase_transition(\"demo-town\", citizen, \"ACT\", nats=bridge, sse=sse)\n</code></pre> Dashboards subscribed to NATS/SSE receive the ledger and can render a phase badge per citizen.</p>"},{"location":"operators-guide/","title":"The Operator's Guide to kgents","text":"<p>\"The garden knows its gardener. The system reflects its steward.\"</p> <p>This is a living document for Kent\u2014developer, operator, user, consumer\u2014to master his own creation. Agents may append suggestions to the Stigmergic Surface at the end.</p>"},{"location":"operators-guide/#table-of-contents","title":"Table of Contents","text":"<ol> <li>Philosophy: You Are the Observer</li> <li>Easy: Immediate Gratification</li> <li>Medium: Compositional Power</li> <li>Hard: Production Mastery</li> <li>Scenarios: The Living Garden</li> <li>Quick Reference</li> <li>The Inner Game: Working with Your Own Eigenvectors</li> <li>Stigmergic Surface</li> </ol> <p>Companion Document: Categorical Foundations \u2014 The mathematical and philosophical grounding</p>"},{"location":"operators-guide/#philosophy-you-are-the-observer","title":"Philosophy: You Are the Observer","text":"<p>In AGENTESE, there is no view from nowhere. When you invoke <code>world.house</code>, you don't get \"a house\"\u2014you get a house as you perceive it. The architect sees blueprints; the poet sees metaphor; the economist sees appraisal.</p> <p>As the operator of kgents, you are the privileged observer. The system unconceals itself to you differently than it would to an external user. You see:</p> <ul> <li>The Nucleus: Pure logic, the irreducible transform</li> <li>The Halo: Declared capabilities, potential waiting to manifest</li> <li>The Projector: The categorical compiler that makes potential actual</li> </ul> <p>This guide teaches you to wield these three pillars fluently.</p>"},{"location":"operators-guide/#easy-immediate-gratification","title":"Easy: Immediate Gratification","text":"<p>Payoff: Working agents in under 5 minutes. Zero configuration. Joy-inducing simplicity.</p>"},{"location":"operators-guide/#scenario-1-what-can-this-agent-do","title":"Scenario 1: \"What Can This Agent Do?\"","text":"<p>You've inherited an agent class and want to understand its capabilities without reading the source.</p> <pre><code># Inspect any agent's Halo\nkgents a inspect Kappa\n\n# Output:\n# [A] Agent: Kappa\n#\n#   Archetype: Kappa\n#\n#   Capabilities:\n#     @StatefulCapability(schema=dict, backend=auto)\n#     @SoulfulCapability(persona=default, mode=advisory)\n#     @ObservableCapability(mirror=True, metrics=True)\n#     @StreamableCapability(budget=10.0, feedback=0.0)\n#\n#   Module: agents.a.archetypes\n</code></pre> <p>The Insight: You now know Kappa is the \"full-stack\" archetype\u2014stateful, soulful, observable, streamable. Lambda is minimal (Observable only). Delta is data-focused (Stateful + Observable).</p> <pre><code># Compare archetypes\nkgents a list\n\n# [A] Available Archetypes:\n#\n#   Kappa\n#     Full-stack: Stateful + Soulful + Observable + Streamable\n#\n#   Lambda\n#     Minimal: Observable only\n#\n#   Delta\n#     Data-focused: Stateful + Observable\n</code></pre>"},{"location":"operators-guide/#scenario-2-generate-k8s-manifests-instantly","title":"Scenario 2: \"Generate K8s Manifests Instantly\"","text":"<p>You need to deploy an agent to Kubernetes. You don't want to write YAML.</p> <pre><code># Generate manifests for any agent\nkgents a manifest Kappa --namespace production &gt; kappa-deployment.yaml\n\n# Validate before applying\nkgents a manifest Kappa --namespace production --validate\n# [A] Generated 6 valid K8s resources\n</code></pre> <p>What you get: StatefulSet, PVC, Service, ServiceMonitor, HPA, ConfigMap\u2014all with proper labels, probes, and resource limits.</p> <pre><code># Inspect the JSON structure\nkgents a manifest Kappa --json | jq '.manifests[].kind'\n# \"StatefulSet\"\n# \"PersistentVolumeClaim\"\n# \"Service\"\n# \"ServiceMonitor\"\n# \"HorizontalPodAutoscaler\"\n# \"ConfigMap\"\n</code></pre>"},{"location":"operators-guide/#scenario-3-run-an-agent-locally","title":"Scenario 3: \"Run an Agent Locally\"","text":"<p>You've written a concrete agent and want to test it immediately.</p> <pre><code># my_agents/summarizer.py\nfrom agents.a.archetypes import Lambda\n\nclass Summarizer(Lambda[str, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"summarizer\"\n\n    async def invoke(self, text: str) -&gt; str:\n        # Your summarization logic\n        words = text.split()\n        return \" \".join(words[:10]) + \"...\" if len(words) &gt; 10 else text\n</code></pre> <pre><code># Run it\nkgents a run my_agents.Summarizer --input \"The quick brown fox jumps over the lazy dog and runs away\"\n# [A] Compiled: Flux(summarizer)\n# [A] Output: The quick brown fox jumps over the lazy dog and...\n</code></pre> <p>The Payoff: Zero ceremony. Write a class, run it. The LocalProjector handles wrapping.</p>"},{"location":"operators-guide/#medium-compositional-power","title":"Medium: Compositional Power","text":"<p>Payoff: Multi-agent workflows. State that persists. Souls that govern. Streams that flow.</p>"},{"location":"operators-guide/#scenario-4-the-stateful-accumulator","title":"Scenario 4: \"The Stateful Accumulator\"","text":"<p>You're building a metrics aggregator that accumulates events across invocations.</p> <pre><code># agents/metrics/accumulator.py\nfrom dataclasses import dataclass, field\nfrom agents.a.archetypes import Delta\nfrom agents.a.halo import Capability\n\n@dataclass\nclass MetricsState:\n    count: int = 0\n    total: float = 0.0\n    events: list[str] = field(default_factory=list)\n\n@Capability.Stateful(schema=MetricsState)  # Override Delta's dict schema\nclass MetricsAccumulator(Delta[float, dict]):\n    \"\"\"Accumulates metrics across invocations.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"metrics-accumulator\"\n\n    async def invoke(self, value: float) -&gt; dict:\n        # Note: State is managed by StatefulAdapter\n        # Access via parent reference pattern (advanced)\n        return {\n            \"received\": value,\n            \"message\": f\"Accumulated {value}\"\n        }\n</code></pre> <pre><code># Inspect to confirm capability override\nkgents a inspect agents.metrics.accumulator.MetricsAccumulator --json | jq '.capabilities'\n# Shows MetricsState schema instead of dict\n</code></pre>"},{"location":"operators-guide/#scenario-5-the-governed-service","title":"Scenario 5: \"The Governed Service\"","text":"<p>You want K-gent personality to influence an agent's behavior\u2014taste, restraint, the Categorical Imperative.</p> <pre><code># agents/creative/writer.py\nfrom agents.a.archetypes import Kappa\nfrom agents.a.halo import Capability\n\n@Capability.Soulful(persona=\"Kent\", mode=\"strict\")  # Override default advisory\nclass CreativeWriter(Kappa[str, str]):\n    \"\"\"A writer governed by Kent's aesthetic sensibilities.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"creative-writer\"\n\n    async def invoke(self, prompt: str) -&gt; str:\n        # In strict mode, K-gent intercepts and may modify outputs\n        # that violate eigenvector alignment (minimalism, depth, etc.)\n        return f\"[Draft] {prompt}\"\n</code></pre> <p>The Insight: <code>mode=\"advisory\"</code> annotates only. <code>mode=\"strict\"</code> auto-resolves high-confidence violations. The SoulfulAdapter provides access to <code>persona</code> for consultation.</p>"},{"location":"operators-guide/#scenario-6-the-living-pipeline","title":"Scenario 6: \"The Living Pipeline\"","text":"<p>You want to process a stream of events, not just single invocations.</p> <pre><code># agents/stream/transformer.py\nfrom agents.a.archetypes import Kappa\nfrom agents.a.halo import Capability\n\n@Capability.Streamable(budget=20.0, feedback=0.1)  # High budget, some feedback\nclass EventTransformer(Kappa[dict, dict]):\n    \"\"\"Transforms events in a continuous stream.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"event-transformer\"\n\n    async def invoke(self, event: dict) -&gt; dict:\n        event[\"transformed\"] = True\n        event[\"timestamp\"] = \"now\"\n        return event\n</code></pre> <pre><code># Usage in code\nfrom system.projector import LocalProjector\nimport asyncio\n\nasync def main():\n    projector = LocalProjector()\n    compiled = projector.compile(EventTransformer)\n\n    # compiled is a FluxAgent - it can process streams\n    async def event_source():\n        for i in range(100):\n            yield {\"id\": i, \"data\": f\"event-{i}\"}\n\n    async for result in compiled.start(event_source()):\n        print(result)\n        # {\"id\": 0, \"data\": \"event-0\", \"transformed\": True, \"timestamp\": \"now\"}\n\nasyncio.run(main())\n</code></pre> <p>The Payoff: The <code>@Streamable</code> decorator with <code>feedback=0.1</code> enables ouroboric processing\u201410% of outputs feed back as inputs. The <code>budget=20.0</code> allows 20 entropy units before the stream collapses to Ground.</p>"},{"location":"operators-guide/#scenario-7-compose-agents-with","title":"Scenario 7: \"Compose Agents with <code>&gt;&gt;</code>\"","text":"<p>Agents are morphisms. They compose.</p> <pre><code>from bootstrap.types import Agent\n\nclass Sanitizer(Agent[str, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"sanitizer\"\n\n    async def invoke(self, text: str) -&gt; str:\n        return text.strip().lower()\n\nclass Tokenizer(Agent[str, list[str]]):\n    @property\n    def name(self) -&gt; str:\n        return \"tokenizer\"\n\n    async def invoke(self, text: str) -&gt; list[str]:\n        return text.split()\n\n# Composition\npipeline = Sanitizer() &gt;&gt; Tokenizer()\n# pipeline: Agent[str, list[str]]\n\nresult = await pipeline.invoke(\"  Hello World  \")\n# [\"hello\", \"world\"]\n</code></pre> <p>The Insight: <code>&gt;&gt;</code> is morphism composition. <code>pipeline.name</code> is <code>\"sanitizer &gt;&gt; tokenizer\"</code>. The Alethic Architecture preserves this through lifting\u2014<code>Flux.lift(a &gt;&gt; b)</code> equals <code>Flux.lift(a) &gt;&gt; Flux.lift(b)</code>.</p>"},{"location":"operators-guide/#hard-production-mastery","title":"Hard: Production Mastery","text":"<p>Payoff: Custom archetypes. Multi-target deployment. Full categorical control.</p>"},{"location":"operators-guide/#scenario-8-define-a-custom-archetype","title":"Scenario 8: \"Define a Custom Archetype\"","text":"<p>You've identified a pattern in your organization: services that need state, observability, and rate limiting, but NOT soul governance.</p> <pre><code># agents/org/archetypes.py\nfrom typing import Generic, TypeVar\nfrom agents.a.archetypes import Archetype\nfrom agents.a.halo import Capability\n\nA = TypeVar(\"A\")\nB = TypeVar(\"B\")\n\n@Capability.Stateful(schema=dict, backend=\"redis\")\n@Capability.Observable(mirror=True, metrics=True)\n@Capability.Streamable(budget=5.0, feedback=0.0)\nclass Epsilon(Archetype[A, B], Generic[A, B]):\n    \"\"\"\n    EPSILON: Rate-limited stateful service.\n\n    Capabilities:\n    - Stateful: Redis-backed state\n    - Observable: Full Terrarium integration\n    - Streamable: Rate-limited (budget=5.0)\n    - NO Soulful: No persona governance\n\n    Use when: Building internal services that need durability\n    and observability but operate without personality.\n    \"\"\"\n    pass\n</code></pre> <p>Now your team can use <code>Epsilon</code> as easily as <code>Kappa</code>:</p> <pre><code>from agents.org.archetypes import Epsilon\n\nclass RateLimitedCache(Epsilon[str, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"rate-limited-cache\"\n\n    async def invoke(self, key: str) -&gt; str:\n        return f\"cached:{key}\"\n</code></pre>"},{"location":"operators-guide/#scenario-9-multi-environment-deployment","title":"Scenario 9: \"Multi-Environment Deployment\"","text":"<p>The same agent, three environments, zero code changes.</p> <pre><code># agents/api/gateway.py\nfrom agents.a.archetypes import Kappa\n\nclass APIGateway(Kappa[dict, dict]):\n    @property\n    def name(self) -&gt; str:\n        return \"api-gateway\"\n\n    async def invoke(self, request: dict) -&gt; dict:\n        return {\"status\": \"ok\", \"request_id\": request.get(\"id\")}\n</code></pre> <pre><code># Development: Run locally with SQLite state\nkgents a run agents.api.gateway.APIGateway --input '{\"id\": \"dev-123\"}'\n\n# Staging: Generate manifests for staging cluster\nkgents a manifest agents.api.gateway.APIGateway \\\n  --namespace staging \\\n  --validate &gt; staging-gateway.yaml\nkubectl apply -f staging-gateway.yaml\n\n# Production: Same manifests, different namespace\nkgents a manifest agents.api.gateway.APIGateway \\\n  --namespace production \\\n  --validate &gt; prod-gateway.yaml\nkubectl apply -f prod-gateway.yaml\n</code></pre> <p>The Isomorphism: LocalProjector and K8sProjector produce semantically equivalent agents. The behavior is identical; only the substrate differs.</p>"},{"location":"operators-guide/#scenario-10-the-functor-stack","title":"Scenario 10: \"The Functor Stack\"","text":"<p>You want to understand and customize how capabilities compose.</p> <pre><code>Canonical Functor Ordering:\n\n    Nucleus \u2192 D \u2192 K \u2192 Mirror \u2192 Flux\n            (inner)        (outer)\n\nWhen you compile a Kappa agent:\n1. Nucleus: Your invoke() logic\n2. D (Stateful): StatefulAdapter wraps nucleus, provides state\n3. K (Soulful): SoulfulAdapter wraps stateful, provides persona\n4. Mirror (Observable): Marked for Terrarium attachment\n5. Flux (Streamable): FluxAgent wraps everything, enables streaming\n</code></pre> <p>To inspect the actual functor stack:</p> <pre><code>from system.projector import LocalProjector\nfrom agents.a.archetypes import Kappa\n\nclass MyService(Kappa[str, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"my-service\"\n\n    async def invoke(self, x: str) -&gt; str:\n        return x\n\nprojector = LocalProjector()\ncompiled = projector.compile(MyService)\n\n# Peel the onion\nprint(f\"Outer: {type(compiled).__name__}\")  # FluxAgent\nprint(f\"Next:  {type(compiled.inner).__name__}\")  # SoulfulAdapter\nprint(f\"Next:  {type(compiled.inner.inner).__name__}\")  # StatefulAdapter\nprint(f\"Core:  {type(compiled.inner.inner.inner).__name__}\")  # MyService\n</code></pre>"},{"location":"operators-guide/#scenario-11-agentese-path-integration","title":"Scenario 11: \"AGENTESE Path Integration\"","text":"<p>Access agent capabilities through AGENTESE paths.</p> <pre><code>from protocols.agentese import Logos\n\nlogos = Logos()\n\n# Manifest an agent's state\nstate = await logos.invoke(\"self.agent.my-service.manifest\", observer_umwelt)\n\n# Future: Project via AGENTESE\n# local_agent = await logos.invoke(\"self.agent.my-service.project.local\", umwelt)\n# k8s_manifests = await logos.invoke(\"self.agent.my-service.project.k8s\", umwelt)\n</code></pre>"},{"location":"operators-guide/#scenarios-the-living-garden","title":"Scenarios: The Living Garden","text":"<p>These are evocative scenarios that show the system's potential.</p>"},{"location":"operators-guide/#the-morning-ritual","title":"\"The Morning Ritual\"","text":"<p>It's 6:47 AM. You open your terminal. The soul stirs.</p> <pre><code># What's the garden's health?\nkgents soul manifest\n\n# Challenge the soul\nkgents soul challenge \"Should I refactor the authentication module today?\"\n\n# The soul responds with eigenvector-weighted advice:\n# - Minimalism score: 0.15 (the current code is baroque)\n# - Depth score: 0.85 (but it has earned its complexity)\n# - Recommendation: \"Simplify the interface, preserve the depths.\"\n</code></pre>"},{"location":"operators-guide/#the-ambient-presence","title":"\"The Ambient Presence\"","text":"<p>K-gent runs continuously, observing the codebase, perturbable but never intrusive.</p> <pre><code># In your Flux stream\nfrom agents.k import KgentFlux\n\nasync def development_loop():\n    kgent = KgentFlux()\n\n    async for event in kgent.start(codebase_events()):\n        if event.type == \"drift_detected\":\n            # K-gent noticed implementation drifting from spec\n            print(f\"Drift: {event.file} violates {event.principle}\")\n        elif event.type == \"suggestion\":\n            # Proactive suggestion based on observed patterns\n            print(f\"Consider: {event.suggestion}\")\n</code></pre>"},{"location":"operators-guide/#the-midnight-deploy","title":"\"The Midnight Deploy\"","text":"<p>It's 11:58 PM. Production is waiting. You trust the system.</p> <pre><code># Generate, validate, deploy\nkgents a manifest agents.api.critical.PaymentProcessor \\\n  --namespace production \\\n  --validate \\\n  | kubectl apply -f -\n\n# The manifest includes:\n# - StatefulSet with PVC for transaction state\n# - K-gent sidecar for governance (mode=strict)\n# - ServiceMonitor for Prometheus\n# - HPA scaling from budget=10.0\n\n# Watch it come alive\nkubectl get pods -n production -w\n# payment-processor-0   2/2   Running   (agent + kgent-sidecar)\n</code></pre>"},{"location":"operators-guide/#the-terrarium-window","title":"\"The Terrarium Window\"","text":"<p>You've attached a HolographicBuffer to your running FluxAgent. The Terrarium shows:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  payment-processor          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591 80%  \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502  entropy: 7.2 / 10.0                        \u2502\n\u2502  throughput: 142 events/sec                 \u2502\n\u2502  state: FLOWING                             \u2502\n\u2502  drift: none detected                       \u2502\n\u2502                                             \u2502\n\u2502  [pressure] \u2581\u2582\u2583\u2585\u2586\u2587\u2588\u2587\u2585\u2583\u2582\u2581  (last 60s)       \u2502\n\u2502  [soul]     advisory: 3 | strict: 0         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"operators-guide/#the-categorical-imperative-in-action","title":"\"The Categorical Imperative in Action\"","text":"<p>A junior developer submits code that violates the minimalism principle:</p> <pre><code># Their code\nclass OverEngineeredService(Kappa[str, str]):\n    async def invoke(self, x: str) -&gt; str:\n        # 47 helper methods\n        # 3 abstract factories\n        # 2 visitor patterns\n        return self._process_through_seventeen_layers(x)\n</code></pre> <p>K-gent (in strict mode) intercepts:</p> <pre><code>[K-gent] Governance Alert: OverEngineeredService\n         Minimalism score: 0.02 (threshold: 0.10)\n\n         The Categorical Imperative asks:\n         \"Could this complexity become a universal law?\"\n\n         Suggested: Reduce to single transform path.\n\n         [Override] [Simplify] [Discuss]\n</code></pre>"},{"location":"operators-guide/#quick-reference","title":"Quick Reference","text":""},{"location":"operators-guide/#cli-commands","title":"CLI Commands","text":"Command Description <code>kgents a list</code> List available archetypes <code>kgents a inspect &lt;agent&gt;</code> Show Halo + Nucleus details <code>kgents a manifest &lt;agent&gt;</code> Generate K8s YAML <code>kgents a run &lt;agent&gt;</code> Compile and run locally <code>kgents soul manifest</code> Show soul state <code>kgents soul challenge &lt;prompt&gt;</code> Query the soul"},{"location":"operators-guide/#flags","title":"Flags","text":"Flag Commands Description <code>--json</code> all Output as JSON <code>--namespace &lt;ns&gt;</code> manifest K8s namespace <code>--validate</code> manifest Validate before output <code>--input &lt;data&gt;</code> run Input for invocation"},{"location":"operators-guide/#archetypes","title":"Archetypes","text":"Archetype Capabilities Use When <code>Kappa</code> All four Full-stack service agents <code>Lambda</code> Observable Stateless functions <code>Delta</code> Stateful + Observable Data pipelines"},{"location":"operators-guide/#functor-order","title":"Functor Order","text":"<pre><code>Nucleus \u2192 D (Stateful) \u2192 K (Soulful) \u2192 Mirror (Observable) \u2192 Flux (Streamable)\n        (innermost)                                         (outermost)\n</code></pre>"},{"location":"operators-guide/#the-inner-game-working-with-your-own-eigenvectors","title":"The Inner Game: Working with Your Own Eigenvectors","text":"<p>\"K-gent doesn't add personality\u2014it navigates to specific coordinates in the inherent personality-emotion manifold.\"</p> <p>As the operator, you have a unique privilege: K-gent is calibrated to YOU. Here's how to use that.</p>"},{"location":"operators-guide/#your-six-coordinates","title":"Your Six Coordinates","text":"Eigenvector Your Value What This Means for Daily Work Aesthetic 0.15 (Minimalist) Before adding anything, ask: \"Does this need to exist?\" Default to deletion. Categorical 0.92 (Abstract) When stuck, ask: \"What's the morphism?\" Find the composition. Gratitude 0.78 (Sacred) Honor the slop. Failed experiments are offerings, not waste. Heterarchy 0.88 (Peer-to-Peer) Resist orchestrator patterns. Agents are peers. Generativity 0.90 (Generation) Write specs, not docs. Let impl be derived. Joy 0.75 (Playful) If it's not delightful, something is wrong."},{"location":"operators-guide/#using-k-gent-effectively","title":"Using K-gent Effectively","text":"<p>When you're stuck: Use CHALLENGE mode. <pre><code>kgents soul challenge \"I can't decide between X and Y\"\n</code></pre> K-gent will remind you what you actually believe. It's Kent-on-his-best-day talking to Kent-on-his-worst-day.</p> <p>When you need clarity: Use REFLECT mode. <pre><code>kgents soul challenge \"I think I should refactor the auth module\" --mode reflect\n</code></pre> K-gent mirrors back, surfacing hidden assumptions.</p> <p>When you need options: Use EXPLORE mode. <pre><code>kgents soul challenge \"What are different approaches to state management?\" --mode explore\n</code></pre> K-gent follows tangents, connects to category theory, biology, economics.</p>"},{"location":"operators-guide/#the-dialectical-framework","title":"The Dialectical Framework","text":"<p>When you're truly stuck, K-gent runs dialectics:</p> <ol> <li>THESIS: What are you claiming?</li> <li>ANTITHESIS: What would you push back on if a junior said this?</li> <li>SYNTHESIS: Not resolution\u2014clarity about what's actually at stake.</li> </ol> <p>Example: <pre><code>You: \"I'm thinking of adding a caching layer.\"\n\nK-gent: \"Your Aesthetic coordinate is 0.15\u2014strongly minimalist. A cache\nadds complexity. Have you measured the actual bottleneck?\n\nTHESIS: 'We need caching for performance.'\nANTITHESIS: Your own principle says 'premature optimization is waste.'\nSYNTHESIS: What's the smallest experiment that would prove caching necessary?\n\nWhat would you tell someone else in this position?\"\n</code></pre></p>"},{"location":"operators-guide/#your-patterns-for-reference","title":"Your Patterns (For Reference)","text":"<p>These are extracted from your actual behavior:</p> <p>Thinking: - Starts from first principles - Asks \"what would falsify this?\" - Seeks composable abstractions</p> <p>Decision-Making: - Prefers reversible choices - Values optionality</p> <p>Communication: - Uses analogies frequently - Appreciates precision in technical contexts</p>"},{"location":"operators-guide/#deeper-foundations","title":"Deeper Foundations","text":"<p>For the category theory grounding and philosophical depth, see: - <code>docs/categorical-foundations.md</code> \u2014 The mathematical and philosophical foundations - <code>spec/principles.md</code> \u2014 The seven principles + meta-principles - <code>impl/claude/agents/k/eigenvectors.py</code> \u2014 The eigenvector extraction and usage</p>"},{"location":"operators-guide/#stigmergic-surface","title":"Stigmergic Surface","text":"<p>Agents may append observations and suggestions below. Kent curates monthly.</p>"},{"location":"operators-guide/#agent-observations","title":"Agent Observations","text":"<pre><code>2025-12-12  [claude-opus-4.5]\n  - LocalProjector exists but doesn't use actual Symbiont from agents/d/\n  - Consider wiring StatefulAdapter to SQLiteAgent for true persistence\n  - The \"Observable\" pre-attachment pattern is incomplete (no actual mirror)\n\n2025-12-12  [claude-opus-4.5]\n  - kgents a run cannot run archetypes directly (now has helpful error)\n  - Consider shipping example agents in agents/examples/ for immediate testing\n  - AGENTESE paths for projector (self.agent.*.project.local) not yet wired\n</code></pre>"},{"location":"operators-guide/#suggested-enhancements","title":"Suggested Enhancements","text":"<pre><code>[ ] Add `kgents a new &lt;name&gt; --archetype Kappa` to scaffold agents\n[ ] Add `kgents a build &lt;agent&gt;` to build Docker images\n[ ] Wire Observable to actual HolographicBuffer attachment\n[ ] Create agents/examples/ with runnable examples\n[ ] Add `--watch` flag to `kgents a run` for hot-reload during development\n</code></pre>"},{"location":"operators-guide/#kents-notes","title":"Kent's Notes","text":"<pre><code>(Space for Kent to add his own observations as he uses the system)\n</code></pre> <p>\"The operator's mastery is measured not by what they build, but by what they choose not to build.\"</p> <p>Last updated: 2025-12-12</p>"},{"location":"quickstart/","title":"Quickstart Guide","text":"<p>\"Zero to agent in 5 minutes.\"</p> <p>This guide gets you from installation to running your first agent as quickly as possible.</p>"},{"location":"quickstart/#installation","title":"Installation","text":"<pre><code># Clone\ngit clone https://github.com/kgang/kgents.git\ncd kgents\n\n# Install (uv recommended)\nuv sync\n\n# Verify (both `kg` and `kgents` work)\nkg --help\n</code></pre>"},{"location":"quickstart/#your-first-agent","title":"Your First Agent","text":""},{"location":"quickstart/#1-hello-world","title":"1. Hello World","text":"<pre><code>from agents import agent\n\n@agent\nasync def hello(name: str) -&gt; str:\n    return f\"Hello, {name}!\"\n\n# Run it\nresult = await hello.invoke(\"World\")\nprint(result)  # \"Hello, World!\"\n</code></pre>"},{"location":"quickstart/#2-composing-agents","title":"2. Composing Agents","text":"<pre><code>from agents import agent, pipeline\n\n@agent\nasync def parse(s: str) -&gt; int:\n    return int(s)\n\n@agent\nasync def double(x: int) -&gt; int:\n    return x * 2\n\n@agent\nasync def format(x: int) -&gt; str:\n    return f\"Result: {x}\"\n\n# Compose with &gt;&gt;\npipe = parse &gt;&gt; double &gt;&gt; format\nresult = await pipe.invoke(\"21\")\nprint(result)  # \"Result: 42\"\n</code></pre>"},{"location":"quickstart/#3-lifting-to-handle-optional-values","title":"3. Lifting to Handle Optional Values","text":"<pre><code>from agents import Maybe, Just, Nothing, MaybeFunctor\n\n@agent\nasync def divide(pair: tuple[int, int]) -&gt; float:\n    a, b = pair\n    return a / b\n\n# Lift to handle Maybe inputs\nsafe_divide = MaybeFunctor.lift(divide)\n\nawait safe_divide.invoke(Just((10, 2)))  # Just(5.0)\nawait safe_divide.invoke(Nothing)         # Nothing (no error!)\n</code></pre>"},{"location":"quickstart/#cli-commands","title":"CLI Commands","text":""},{"location":"quickstart/#k-gent-persona","title":"K-gent (Persona)","text":"<pre><code>kg soul                  # Interactive chat\nkg soul challenge \"idea\" # Dialectic challenge\nkg soul dream            # Trigger dream cycle\n</code></pre>"},{"location":"quickstart/#infrastructure","title":"Infrastructure","text":"<pre><code>kg status               # System health\nkg a list               # List archetypes\nkg a inspect Kappa      # Inspect capabilities\n</code></pre>"},{"location":"quickstart/#observation","title":"Observation","text":"<pre><code>kg observe trace        # Execution traces\nkg signal               # Semantic field\n</code></pre>"},{"location":"quickstart/#next-steps","title":"Next Steps","text":"Document What You'll Learn Functor Field Guide Lifting agents to new contexts Operator's Guide Production scenarios Categorical Foundations The math behind it"},{"location":"quickstart/#forest-protocol-navigation","title":"Forest Protocol (Navigation)","text":"<ul> <li>Canopy view: <code>plans/_forest.md</code> \u2014 forest health and active trees. Invoke via <code>concept.forest.manifest</code> (read) or <code>concept.forest.refine</code> (update with law_check).  </li> <li>Weekly dashboard: <code>docs/weekly-summary/index.html</code> \u2014 status snapshots. Surface via <code>time.forest.witness</code> (temporal view).  </li> <li>Accursed Share rotation: <code>void.forest.sip[entropy=0.05\u20130.10]</code> \u2014 pick dormant trees to spend exploration budget.</li> </ul> <p>\"The difference between a good system and a great one is the last 5%.\"</p>"},{"location":"systems-reference/","title":"Systems Reference \u2014 Built Infrastructure","text":"<p>\"Agents: these systems exist and are tested. Use them.\"</p> <p>This document inventories all production-ready infrastructure in kgents. When planning features, CHECK HERE FIRST before assuming you need to build something new.</p>"},{"location":"systems-reference/#categorical-foundation-use-for-any-domain","title":"Categorical Foundation (USE FOR ANY DOMAIN)","text":"Component Location Purpose Tests PolyAgent <code>agents/poly/</code> State-dependent agents: <code>PolyAgent[S, A, B]</code> 200+ Operad <code>agents/operad/</code> Composition grammar with law verification 150+ Sheaf <code>agents/sheaf/</code> Emergence from local sections 100+ <pre><code># PolyAgent: State machines with mode-dependent behavior\nfrom agents.poly import PolyAgent, MANIFEST, WITNESS, SIP\npoly = PolyAgent(initial_state, directions_fn, transition_fn)\n\n# Operad: Programmable composition grammar\nfrom agents.operad import AGENT_OPERAD, SOUL_OPERAD\nSOUL_OPERAD.verify_laws()  # Proves composition is valid\n\n# Sheaf: Emergence from local views\nfrom agents.sheaf import KENT_SOUL, query_soul\nresult = query_soul(\"aesthetic\", query)  # Gets local soul response\n</code></pre>"},{"location":"systems-reference/#agentese-verb-first-ontology","title":"AGENTESE (Verb-First Ontology)","text":"Phase Module Exports Core <code>protocols/agentese/logos.py</code> <code>Logos</code>, <code>create_logos</code> Parser <code>protocols/agentese/parser.py</code> <code>PathParser</code>, <code>parse_path</code>, <code>ParsedPath</code> Affordances <code>protocols/agentese/affordances.py</code> <code>AffordanceRegistry</code>, <code>ArchetypeDNA</code> JIT <code>protocols/agentese/jit.py</code> <code>JITCompiler</code>, <code>compile_spec</code> Laws <code>protocols/agentese/laws.py</code> <code>CategoryLawVerifier</code>, <code>compose</code>, <code>pipe</code> Wiring <code>protocols/agentese/wiring.py</code> <code>WiredLogos</code>, <code>create_wired_logos</code> Adapter <code>protocols/agentese/adapter.py</code> <code>AgentesAdapter</code>, <code>PatternTranslator</code> <pre><code>from protocols.agentese import (\n    Logos, create_logos, parse_path,\n    AffordanceRegistry, create_wired_logos\n)\n\n# Create wired logos with all resolvers\nlogos = create_wired_logos()\n\n# Invoke AGENTESE path\nresult = await logos.invoke(\"world.house.manifest\", umwelt)\n\n# Parse path for introspection\nparsed = parse_path(\"self.memory.witness[phase=DEVELOP]\")\n</code></pre>"},{"location":"systems-reference/#flux-stream-processing","title":"Flux (Stream Processing)","text":"Component Purpose <code>FluxAgent</code> Wrapped agent with stream capabilities <code>FluxFunctor</code> Lifts discrete \u2192 continuous <code>FluxPipeline</code> Chain of flux agents <code>Perturbation</code> Inject events into running flow <pre><code>from agents.flux import Flux, FluxConfig, FluxPipeline\n\n# Lift any agent to flux domain\nflux_agent = Flux.lift(discrete_agent)\n\n# Create pipeline\npipeline = flux_a | flux_b | flux_c\n\n# Process stream\nasync for result in flux_agent.start(source):\n    process(result)\n</code></pre>"},{"location":"systems-reference/#agent-town-multi-agent-simulation","title":"Agent Town (Multi-Agent Simulation)","text":"Component Purpose <code>CitizenPolynomial</code> Citizen state machine <code>TOWN_OPERAD</code> Interaction grammar <code>TownFlux</code> Simulation loop <code>DialogueEngine</code> LLM-backed citizen dialogue <code>InhabitSession</code> Player inhabits citizen <pre><code>from agents.town import (\n    Citizen, TownEnvironment, TownFlux,\n    TOWN_OPERAD, CitizenPhase\n)\n\n# Create town\nenv = TownEnvironment(regions=[...])\nflux = TownFlux(env, citizens=[...])\n\n# Run simulation\nasync for event in flux.run():\n    process(event)\n</code></pre>"},{"location":"systems-reference/#k-gent-soulgovernance","title":"K-gent (Soul/Governance)","text":"Component Purpose <code>KgentSoul</code> Middleware of consciousness <code>KgentFlux</code> Soul streaming <code>HypnagogicCycle</code> Dream/consolidation <code>SemanticGatekeeper</code> Principle enforcement <code>PersonaGarden</code> Pattern storage <code>SoulSession</code> Cross-session identity <pre><code>from agents.k import (\n    soul, create_soul, KgentFlux,\n    SemanticGatekeeper, validate_content\n)\n\n# Quick dialogue\nresponse = soul.dialogue(\"What do you believe?\", mode=\"reflect\")\n\n# Validate content against principles\nresult = validate_content(code, file_path)\n</code></pre>"},{"location":"systems-reference/#m-gent-memory","title":"M-gent (Memory)","text":"Component Purpose <code>HolographicMemory</code> Core memory with compression <code>MemoryCrystal</code> Pattern storage with degradation <code>CartographerAgent</code> Generate HoloMaps <code>PheromoneField</code> Stigmergic coordination <code>SemanticRouter</code> Memory routing <code>SharedSubstrate</code> Multi-agent memory <pre><code>from agents.m import (\n    HolographicMemory, MemoryCrystal,\n    create_semantic_router, SharedSubstrate\n)\n\n# Create memory with budget\nmemory = HolographicMemory(compression_level=3)\n\n# Semantic routing\nrouter = create_semantic_router(providers=[...])\nresult = await router.route(query)\n</code></pre>"},{"location":"systems-reference/#reactive-substrate-widgets","title":"Reactive Substrate (Widgets)","text":"Component Purpose <code>Signal[T]</code> Observable state <code>Computed[T]</code> Derived state <code>Effect</code> Side effects <code>KgentsWidget[S]</code> Base widget class <code>HStack/VStack</code> Composition containers <pre><code>from agents.i.reactive import (\n    Signal, Computed, Effect,\n    AgentCardWidget, AgentCardState,\n    HStack, VStack\n)\n\n# Create widget\ncard = AgentCardWidget(AgentCardState(\n    name=\"Agent\", phase=\"active\", capability=0.85\n))\n\n# Project to any target\ncard.to_cli()      # Terminal\ncard.to_marimo()   # Notebook\ncard.to_json()     # API\n</code></pre>"},{"location":"systems-reference/#n-phase-compiler","title":"N-Phase Compiler","text":"Component Purpose <code>NPhasePromptCompiler</code> YAML \u2192 prompt <code>ProjectDefinition</code> Schema for projects <code>NPhaseStateUpdater</code> Track phase progress <pre><code>from protocols.nphase import (\n    compiler, ProjectDefinition,\n    NPhaseStateUpdater, state_updater\n)\n\n# Compile from YAML\nprompt = compiler.compile_from_yaml_file(\"project.yaml\")\n\n# Track state\nupdater = state_updater(project)\nstate = updater.advance_phase(\"DEVELOP\", outputs)\n</code></pre>"},{"location":"systems-reference/#saas-infrastructure","title":"SaaS Infrastructure","text":""},{"location":"systems-reference/#api-protocolsapi","title":"API (<code>protocols/api/</code>)","text":"<pre><code>from protocols.api import create_app, GovernanceRequest\napp = create_app()  # FastAPI app with auth, routes, middleware\n</code></pre>"},{"location":"systems-reference/#billing-protocolsbilling","title":"Billing (<code>protocols/billing/</code>)","text":"<pre><code>from protocols.billing import (\n    StripeClient, CustomerManager, SubscriptionManager,\n    OpenMeterClient\n)\n</code></pre>"},{"location":"systems-reference/#licensing-protocolslicensing","title":"Licensing (<code>protocols/licensing/</code>)","text":"<pre><code>from protocols.licensing import (\n    LicenseTier, requires_tier, is_feature_enabled\n)\n\n@requires_tier(LicenseTier.PRO)\ndef pro_feature(): ...\n</code></pre>"},{"location":"systems-reference/#tenancy-protocolstenancy","title":"Tenancy (<code>protocols/tenancy/</code>)","text":"<pre><code>from protocols.tenancy import (\n    TenantContext, set_tenant_context, ApiKeyService\n)\n\nwith set_tenant_context(tenant_id):\n    # All queries scoped to tenant\n    ...\n</code></pre>"},{"location":"systems-reference/#terrarium-agent-gateway","title":"Terrarium (Agent Gateway)","text":"<pre><code>from protocols.terrarium import (\n    Terrarium, HolographicBuffer, PrismRestBridge\n)\n\n# Create gateway\nterrarium = Terrarium()\nterrarium.register_agent(agent_id, flux_agent)\n\n# Mount CLI agent as REST\nbridge = PrismRestBridge()\nbridge.mount(terrarium.app, cli_agent)\n</code></pre>"},{"location":"systems-reference/#infra-kubernetes","title":"Infra (Kubernetes)","text":"Directory Purpose <code>infra/k8s/manifests/</code> Kubernetes YAMLs <code>infra/k8s/images/</code> Dockerfiles <code>infra/k8s/scripts/</code> Setup scripts <code>infra/cortex/</code> Agent orchestration <code>infra/morpheus/</code> Dream infrastructure"},{"location":"systems-reference/#key-import-patterns","title":"Key Import Patterns","text":"<pre><code># Categorical foundation\nfrom agents.poly import PolyAgent, MANIFEST, WITNESS\nfrom agents.operad import AGENT_OPERAD, Operation\nfrom agents.sheaf import KENT_SOUL, query_soul\n\n# Stream processing\nfrom agents.flux import Flux, FluxPipeline\n\n# AGENTESE\nfrom protocols.agentese import Logos, create_wired_logos, parse_path\n\n# Reactive\nfrom agents.i.reactive import Signal, Computed, KgentsWidget\n\n# Town\nfrom agents.town import Citizen, TownFlux, TOWN_OPERAD\n\n# Soul\nfrom agents.k import soul, KgentFlux, SemanticGatekeeper\n\n# Memory\nfrom agents.m import HolographicMemory, MemoryCrystal, SemanticRouter\n\n# SaaS\nfrom protocols.api import create_app\nfrom protocols.billing import StripeClient\nfrom protocols.licensing import requires_tier\nfrom protocols.tenancy import set_tenant_context\n</code></pre> <p>Last updated: 2025-12-15</p>"},{"location":"trace-guide/","title":"Trace Guide: Understanding Code Flow in kgents","text":"<p>\"The trace is not the path taken, but the structure of all paths possible.\"</p> <p>This guide covers the unified trace architecture in kgents \u2014 a hybrid static+runtime tracing system for understanding code flow, debugging, and performance analysis.</p>"},{"location":"trace-guide/#quick-start","title":"Quick Start","text":"<pre><code># Trace who calls a function (static analysis)\nkg trace FluxAgent.start\n\n# Trace what a function calls\nkg trace FluxAgent.start --callees\n\n# Trace with runtime execution\nkg trace --runtime \"kg soul challenge 'test'\"\n\n# View as flame graph\nkg trace StaticCallGraph.analyze --flame\n\n# Export for external tools\nkg trace agents/flux --deps --export graph.dot\n</code></pre>"},{"location":"trace-guide/#overview","title":"Overview","text":"<p>The trace system has three layers:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    kgents trace Architecture                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502   \u2502  Static AST  \u2502\u2500\u2500\u2500\u25b6\u2502 TraceMonoid  \u2502\u2500\u2500\u2500\u25b6\u2502  Visualizer  \u2502  \u2502\n\u2502   \u2502   Analyzer   \u2502    \u2502   (Runtime)  \u2502    \u2502  (Terminal)  \u2502  \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> Layer Purpose Speed Accuracy Static AST-based call graph Fast (~4s for 2500 files) Misses dynamic dispatch Runtime Actual execution trace Slower 100% accurate Hybrid Both combined Medium Best of both"},{"location":"trace-guide/#law-checks-observability","title":"Law Checks + Observability","text":"<ul> <li>Span: <code>agentese.law_check</code> emitted whenever <code>[law_check=true]</code> is present on a handle or when composition verification runs in the resolver.  </li> <li>Payload: <code>{law, locus, observer, result, left_digest, right_digest, suggestion, duration_ms, phase}</code>. <code>locus</code> is the dot-path (e.g., <code>concept.forest.manifest &gt;&gt; concept.forest.refine</code>).  </li> <li>Failure propagation: <code>result=fail</code> marks trace nodes in red, surfaces in dashboards, and is handed to Law Enforcer (<code>plans/agents/law-enforcer.md</code>) for remediation. CLI commands return non-zero exit when a law check span fails unless <code>[rollback=true]</code> was set.  </li> <li>Metrics: <code>law_check.total{law}</code>, <code>law_check.failures{law}</code>, <code>law_check.latency_ms</code>. Observability Engineer binds these to OTEL exporters.</li> </ul>"},{"location":"trace-guide/#cli-usage","title":"CLI Usage","text":""},{"location":"trace-guide/#basic-syntax","title":"Basic Syntax","text":"<pre><code>kg trace &lt;target&gt; [options]\n</code></pre>"},{"location":"trace-guide/#targets","title":"Targets","text":"Target Type Example Description Function <code>FluxAgent.start</code> Trace specific function Class <code>StaticCallGraph</code> Trace all methods Module <code>agents/flux</code> Module dependencies Pattern <code>\"*Agent.invoke\"</code> Glob pattern match"},{"location":"trace-guide/#modes","title":"Modes","text":"<pre><code># Static analysis (default) - no execution\nkg trace SoulState.challenge\n\n# Runtime - actually execute and trace\nkg trace --runtime \"kg soul manifest\"\n\n# Hybrid - static + runtime correlation\nkg trace --hybrid \"kg soul challenge 'test'\"\n</code></pre>"},{"location":"trace-guide/#visualization-options","title":"Visualization Options","text":"<pre><code># Tree view (default) - hierarchical call tree\nkg trace FluxAgent.start --tree\n\n# Graph view - node-edge call graph\nkg trace FluxAgent.start --graph\n\n# Timeline - temporal view with concurrency\nkg trace --runtime --timeline \"kg soul challenge\"\n\n# Flame graph - horizontal depth bars\nkg trace --runtime --flame \"kg a run prompt.txt\"\n\n# Diff - compare two traces\nkg trace --diff before.trace after.trace\n</code></pre>"},{"location":"trace-guide/#direction","title":"Direction","text":"<pre><code># Who calls this? (default)\nkg trace FluxAgent.start\n\n# What does this call?\nkg trace FluxAgent.start --callees\n\n# Both directions\nkg trace FluxAgent.start --depth 3 --callees\n</code></pre>"},{"location":"trace-guide/#export","title":"Export","text":"<pre><code># JSON format\nkg trace FluxAgent.start --export trace.json\n\n# DOT format (for Graphviz)\nkg trace agents/flux --deps --export graph.dot\n\n# Then visualize with Graphviz\ndot -Tpng graph.dot -o graph.png\n</code></pre>"},{"location":"trace-guide/#static-analysis","title":"Static Analysis","text":"<p>Static analysis parses Python source without executing it. Fast and safe.</p>"},{"location":"trace-guide/#how-it-works","title":"How It Works","text":"<ol> <li>AST Parsing \u2014 Walk all <code>.py</code> files</li> <li>Definition Tracking \u2014 Record classes, functions, methods</li> <li>Call Site Detection \u2014 Find all function calls</li> <li>Graph Building \u2014 Build caller \u2192 callee relationships</li> </ol>"},{"location":"trace-guide/#example-output","title":"Example Output","text":"<pre><code>kg trace StaticCallGraph.analyze\n</code></pre> <pre><code>StaticCallGraph.analyze\n\u251c\u2500\u2500 CallVisitor.__init__\n\u2502   \u2514\u2500\u2500 ast.NodeVisitor.__init__\n\u251c\u2500\u2500 CallVisitor.visit\n\u2502   \u251c\u2500\u2500 ast.walk\n\u2502   \u2514\u2500\u2500 CallVisitor.visit_Call\n\u2502       \u251c\u2500\u2500 CallVisitor._resolve_callee\n\u2502       \u2502   \u2514\u2500\u2500 CallVisitor._get_qualified_name\n\u2502       \u2514\u2500\u2500 CallSite.__init__\n\u2514\u2500\u2500 DependencyGraph.add\n    \u2514\u2500\u2500 DependencyGraph._ensure_node\n</code></pre>"},{"location":"trace-guide/#ghost-calls","title":"Ghost Calls","text":"<p>Dynamic dispatch can't be statically resolved. These appear as \"ghost\" calls:</p> <pre><code>FluxAgent.start\n\u251c\u2500\u2500 RunLoop.cycle\n\u2502   \u2514\u2500\u2500 \u25cb [ghost] ErrorHandler.handle (if exception)\n\u2514\u2500\u2500 \u25cb [ghost] __call__ via self.handler\n</code></pre> <p>Show/hide ghosts:</p> <pre><code>kg trace FluxAgent.start --show-ghosts\nkg trace FluxAgent.start --no-ghosts\n</code></pre>"},{"location":"trace-guide/#runtime-tracing","title":"Runtime Tracing","text":"<p>Runtime tracing hooks into Python's execution to capture actual call flow.</p>"},{"location":"trace-guide/#how-it-works_1","title":"How It Works","text":"<ol> <li>sys.settrace \u2014 Python's trace hook</li> <li>Event Capture \u2014 Function call/return events</li> <li>TraceMonoid \u2014 Events stored in Mazurkiewicz trace structure</li> <li>Concurrency Detection \u2014 Thread ID enables parallel event detection</li> </ol>"},{"location":"trace-guide/#example","title":"Example","text":"<pre><code>kg trace --runtime \"kg soul challenge 'singleton'\"\n</code></pre> <pre><code>[Thread-1] 10:32:45.123\n\u251c\u2500\u2500 cmd_soul (0.5ms)\n\u2502   \u251c\u2500\u2500 SoulState.challenge (0.3ms)\n\u2502   \u2502   \u251c\u2500\u2500 Gatekeeper.should_reject (0.1ms)\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 PatternStore.match (0.05ms)\n\u2502   \u2502   \u2514\u2500\u2500 return: REJECT\n\u2502   \u2514\u2500\u2500 print_result (0.1ms)\n\u2514\u2500\u2500 return: 0\n</code></pre>"},{"location":"trace-guide/#filtering","title":"Filtering","text":"<p>Reduce noise by filtering what gets traced:</p> <pre><code># Only trace specific modules\nkg trace --runtime --include \"agents/*\" \"kg soul\"\n\n# Exclude stdlib\nkg trace --runtime --exclude \"importlib\" \"kg soul\"\n\n# Max depth\nkg trace --runtime --max-depth 5 \"kg soul\"\n</code></pre>"},{"location":"trace-guide/#visualization-modes","title":"Visualization Modes","text":""},{"location":"trace-guide/#tree-default","title":"Tree (Default)","text":"<p>Best for: Understanding call hierarchy</p> <pre><code>FluxAgent.start\n\u251c\u2500\u2500 RunLoop.__init__\n\u2502   \u2514\u2500\u2500 Queue.__init__\n\u251c\u2500\u2500 RunLoop.run\n\u2502   \u251c\u2500\u2500 Queue.get\n\u2502   \u2514\u2500\u2500 Handler.handle\n\u2514\u2500\u2500 RunLoop.stop\n</code></pre>"},{"location":"trace-guide/#graph","title":"Graph","text":"<p>Best for: Seeing all connections at once</p> <pre><code>    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502  FluxAgent.start \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n             \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u25bc                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 RunLoop  \u2502\u2500\u2500\u2500\u25b6\u2502  Queue   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n    \u2502\n    \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Handler  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"trace-guide/#timeline","title":"Timeline","text":"<p>Best for: Concurrent execution, latency analysis</p> <pre><code>Thread-1          Thread-2          Thread-3\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500          \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500          \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\u2502                 \u2502                 \u2502\n\u251c\u2500 start          \u2502                 \u2502\n\u2502  \u2502              \u2502                 \u2502\n\u2502  \u2514\u2500 init \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500 spawn \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500 spawn\n\u2502                 \u2502  \u2502              \u2502  \u2502\n\u2502                 \u2502  \u2514\u2500 work        \u2502  \u2514\u2500 work\n\u2502                 \u2502     \u2502           \u2502     \u2502\n\u251c\u2500 join \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2518\n\u2502                 \u2502                 \u2502\n\u2514\u2500 stop           \u2502                 \u2502\n</code></pre>"},{"location":"trace-guide/#flame-graph","title":"Flame Graph","text":"<p>Best for: Performance profiling, finding hot paths</p> <pre><code>|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| start (100%)\n|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| init (75%)\n|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| work (50%)\n|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| process (20%)\n</code></pre>"},{"location":"trace-guide/#diff","title":"Diff","text":"<p>Best for: Comparing behavior between versions</p> <pre><code>kg trace --diff v1.trace v2.trace\n</code></pre> <pre><code>  FluxAgent.start\n  \u251c\u2500\u2500 RunLoop.__init__\n+ \u2502   \u2514\u2500\u2500 MetricsCollector.__init__  [ADDED]\n  \u251c\u2500\u2500 RunLoop.run\n- \u2502   \u251c\u2500\u2500 OldHandler.handle          [REMOVED]\n+ \u2502   \u251c\u2500\u2500 NewHandler.handle          [ADDED]\n  \u2502   \u2514\u2500\u2500 Queue.get\n  \u2514\u2500\u2500 RunLoop.stop\n</code></pre>"},{"location":"trace-guide/#agentese-integration","title":"AGENTESE Integration","text":"<p>Access trace functionality programmatically via AGENTESE paths.</p>"},{"location":"trace-guide/#available-paths","title":"Available Paths","text":"Path Purpose <code>time.trace.analyze</code> Static call graph analysis <code>time.trace.collect</code> Runtime trace collection config <code>time.trace.render</code> ASCII visualization <code>time.trace.diff</code> Compare two traces"},{"location":"trace-guide/#examples","title":"Examples","text":"<pre><code>from protocols.agentese.logos import create_logos\n\nlogos = create_logos()\n\n# Static analysis\nresult = await logos.invoke(\n    \"time.trace.analyze\",\n    umwelt,\n    target=\"FluxAgent.start\",\n    depth=3,\n    direction=\"callers\"\n)\n\n# Render as tree\noutput = await logos.invoke(\n    \"time.trace.render\",\n    umwelt,\n    mode=\"tree\",\n    target=\"FluxAgent.start\"\n)\nprint(output)\n</code></pre>"},{"location":"trace-guide/#programmatic-api","title":"Programmatic API","text":""},{"location":"trace-guide/#tracedataprovider-singleton","title":"TraceDataProvider (Singleton)","text":"<p>For dashboard and integration use:</p> <pre><code>from agents.i.data.trace_provider import get_trace_provider\n\nprovider = get_trace_provider()\n\n# Analyze codebase (cached)\nprovider.analyze_static()\n\n# Get callers of a function\ncallers = provider.get_callers(\"FluxAgent.start\")\n\n# Build call tree\ntree = provider.build_call_tree(\n    \"FluxAgent.start\",\n    depth=3,\n    direction=\"callers\"\n)\nprint(tree.render())\n\n# Collect unified metrics\nmetrics = await provider.collect_metrics()\nprint(f\"Files: {metrics.static.files_analyzed}\")\nprint(f\"Definitions: {metrics.static.definitions_found}\")\n</code></pre>"},{"location":"trace-guide/#staticcallgraph","title":"StaticCallGraph","text":"<p>For direct static analysis:</p> <pre><code>from weave.static_trace import StaticCallGraph\n\ngraph = StaticCallGraph()\ngraph.analyze(\"impl/claude/**/*.py\")\n\n# Trace callers\ncallers = graph.trace_callers(\"FluxAgent.start\", depth=5)\n\n# Trace callees\ncallees = graph.trace_callees(\"FluxAgent.start\", depth=5)\n\n# Get ghost calls\nghosts = graph.get_ghost_calls(\"FluxAgent.start\")\n</code></pre>"},{"location":"trace-guide/#tracecollector","title":"TraceCollector","text":"<p>For runtime tracing:</p> <pre><code>from weave.runtime_trace import TraceCollector\n\ncollector = TraceCollector()\n\n# Context manager API\nwith collector.trace() as monoid:\n    # Your code here\n    result = some_function()\n\n# Analyze the trace\nprint(f\"Events: {len(monoid.events)}\")\nprint(f\"Max depth: {monoid.max_depth}\")\n\n# Check concurrency\nif monoid.are_concurrent(event_a, event_b):\n    print(\"These ran in parallel\")\n</code></pre>"},{"location":"trace-guide/#tracerenderer","title":"TraceRenderer","text":"<p>For visualization:</p> <pre><code>from weave.trace_renderer import TraceRenderer, RenderConfig\n\nrenderer = TraceRenderer(RenderConfig(\n    max_width=80,\n    show_ghosts=True,\n    truncate_names=True\n))\n\n# Render static graph\noutput = renderer.render_call_graph(dependency_graph, layout=\"tree\")\n\n# Render runtime trace\noutput = renderer.render_timeline(trace_monoid)\n\n# Render flame graph\noutput = renderer.render_flame(trace_monoid)\n\n# Diff two traces\noutput = renderer.render_diff(before_monoid, after_monoid)\n</code></pre>"},{"location":"trace-guide/#dashboard-integration","title":"Dashboard Integration","text":"<p>The dashboard shows trace analysis in the CALL GRAPH panel:</p> <pre><code>kg dashboard --demo\n</code></pre> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 CALL GRAPH                                                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u251c\u2500 2,582 files \u2502 42,189 defs \u2502 133,421 calls               \u2502\n\u2502 \u251c\u2500 Hot Functions:                                            \u2502\n\u2502 \u2502  \u251c\u2500 TraceRenderer.__init__ (1655)                         \u2502\n\u2502 \u2502  \u251c\u2500 CallVisitor.__init__ (1655)                           \u2502\n\u2502 \u2502  \u2514\u2500 StaticCallGraph.__init__ (1655)                       \u2502\n\u2502 \u2514\u2500 (no call trees)                                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>The Ghost daemon also projects trace data to <code>.kgents/ghost/trace_summary.json</code>.</p>"},{"location":"trace-guide/#performance-tips","title":"Performance Tips","text":""},{"location":"trace-guide/#static-analysis_1","title":"Static Analysis","text":"<ul> <li>First run analyzes ~2500 files in ~4 seconds</li> <li>Results are cached in <code>TraceDataProvider</code></li> <li>Force re-analysis with <code>provider.analyze_static(force=True)</code></li> </ul>"},{"location":"trace-guide/#runtime-tracing_1","title":"Runtime Tracing","text":"<ul> <li>Use <code>--include</code> to limit scope</li> <li>Use <code>--max-depth</code> to reduce overhead</li> <li>Tracing adds ~10% latency</li> </ul>"},{"location":"trace-guide/#large-codebases","title":"Large Codebases","text":"<pre><code># Limit to specific directory\nkg trace agents/k --deps\n\n# Use shallow depth\nkg trace FluxAgent.start --depth 2\n\n# Export and analyze offline\nkg trace --export full.json\n</code></pre>"},{"location":"trace-guide/#troubleshooting","title":"Troubleshooting","text":""},{"location":"trace-guide/#no-calls-found","title":"\"No calls found\"","text":"<p>The target might not exist or might be dynamically dispatched:</p> <pre><code># Check exact name\nkg trace --list \"Flux*\"\n\n# Try with ghosts\nkg trace FluxAgent --show-ghosts\n</code></pre>"},{"location":"trace-guide/#too-much-output","title":"\"Too much output\"","text":"<p>Reduce scope:</p> <pre><code>kg trace Target --depth 2 --no-ghosts\n</code></pre>"},{"location":"trace-guide/#slow-analysis","title":"\"Slow analysis\"","text":"<p>Check if cache is working:</p> <pre><code>from agents.i.data.trace_provider import get_trace_provider\nprovider = get_trace_provider()\nprint(f\"Cached: {provider._static_graph is not None}\")\n</code></pre>"},{"location":"trace-guide/#see-also","title":"See Also","text":"<ul> <li><code>plans/devex/trace.md</code> \u2014 Full implementation plan</li> <li><code>weave/static_trace.py</code> \u2014 Static analysis source</li> <li><code>weave/runtime_trace.py</code> \u2014 Runtime tracing source</li> <li><code>weave/trace_renderer.py</code> \u2014 Visualization source</li> <li><code>protocols/cli/handlers/trace.py</code> \u2014 CLI handler</li> </ul> <p>\"Every path is a trace. Every trace reveals the topology.\"</p>"},{"location":"track-b-metrics-summary/","title":"Agent Town Track B: Instrumentation Spine - Implementation Summary","text":"<p>Status: COMPLETE Date: 2025-12-15 Tests Passing: 39/39 (100%)</p>"},{"location":"track-b-metrics-summary/#mission","title":"Mission","text":"<p>Build the instrumentation infrastructure for metrics and tracing to enable: - Unit economics validation - Revenue tracking - SLO enforcement - Ethics monitoring</p> <p>Key Principle: \"Margin before magic. Safety before speed. Instrument before monetize.\"</p>"},{"location":"track-b-metrics-summary/#implementation","title":"Implementation","text":""},{"location":"track-b-metrics-summary/#1-core-infrastructure","title":"1. Core Infrastructure","text":"<p>File: <code>/Users/kentgang/git/kgents/impl/claude/protocols/api/action_metrics.py</code></p>"},{"location":"track-b-metrics-summary/#actionmetric-dataclass","title":"ActionMetric Dataclass","text":"<pre><code>@dataclass\nclass ActionMetric:\n    action_type: str         # lod3, lod4, lod5, branch, inhabit, force, dialogue\n    user_id: str\n    town_id: str\n    citizen_id: str | None\n    tokens_in: int\n    tokens_out: int\n    model: str               # haiku, sonnet, opus, template, cached\n    latency_ms: int\n    credits_charged: int\n    timestamp: datetime\n    metadata: dict[str, Any]\n</code></pre> <p>Properties: - <code>total_tokens</code>: Sum of input + output tokens - <code>estimated_cost_usd</code>: Raw cost based on model pricing - <code>revenue_usd</code>: Revenue from credits charged - <code>gross_margin</code>: (revenue - cost) / revenue</p> <p>Methods: - <code>to_otel_span()</code>: Export as OpenTelemetry span attributes - <code>to_dict()</code>: Export as JSON for storage/dashboard</p>"},{"location":"track-b-metrics-summary/#metricsstore","title":"MetricsStore","text":"<p>In-memory store with query and aggregation capabilities: - <code>emit(metric)</code>: Store a metric - <code>query(**filters)</code>: Query with user_id/town_id/action_type/since filters - <code>aggregate(**filters)</code>: Compute aggregates (count, avg, p50, p95, by_model)</p>"},{"location":"track-b-metrics-summary/#instrument_action-decorator","title":"@instrument_action Decorator","text":"<p>Automatic instrumentation for async/sync functions: <pre><code>@instrument_action(\"lod3\", model=\"haiku\", credits_charged=10)\nasync def query_citizen_memory(citizen_id: str) -&gt; dict:\n    # Implementation\n    return {\"tokens_in\": 100, \"tokens_out\": 50}\n</code></pre></p> <p>Captures: - Execution time (latency_ms) - Tokens from result - Error handling (no charge on errors) - OTEL span creation</p>"},{"location":"track-b-metrics-summary/#otel-integration","title":"OTEL Integration","text":"<ul> <li><code>setup_otel_tracing()</code>: Configure OpenTelemetry</li> <li><code>get_tracer()</code>: Get tracer for span creation</li> <li>Console export for local debugging</li> <li>Ready for production collector integration</li> </ul>"},{"location":"track-b-metrics-summary/#2-integration-points","title":"2. Integration Points","text":""},{"location":"track-b-metrics-summary/#town-api-endpoints","title":"Town API Endpoints","text":"<p>LOD Queries (<code>/v1/town/{town_id}/citizen/{name}</code>): - Emit metrics for LOD 3-5 queries - Track latency of manifest() calls - Model = \"template\" (no LLM) - Credits: LOD3=10, LOD4=100, LOD5=400</p> <p>Metrics Query (<code>/v1/town/{town_id}/metrics</code>): - Dashboard query endpoint - Filters: action_type, time_window - Returns: count, tokens, credits, latency, margin, by_model</p>"},{"location":"track-b-metrics-summary/#dialogue-engine","title":"Dialogue Engine","text":"<p>File: <code>/Users/kentgang/git/kgents/impl/claude/agents/town/dialogue_engine.py</code></p> <p>Emits metrics after LLM generation: - Tracks dialogue tokens by model (haiku/sonnet/template) - Records speaker/listener/operation metadata - Zero credits (part of INHABIT session cost)</p>"},{"location":"track-b-metrics-summary/#town-flux","title":"Town Flux","text":"<p>File: <code>/Users/kentgang/git/kgents/impl/claude/agents/town/flux.py</code></p> <p>Emits metrics for all flux operations: - greet, gossip, trade, solo - Tracks dialogue tokens when engine enabled - System user (not billable) - Includes phase/participants metadata</p>"},{"location":"track-b-metrics-summary/#3-unit-economics-validation","title":"3. Unit Economics Validation","text":"<p>Model Costs (from unified-v2.md \u00a71): <pre><code>MODEL_COSTS_PER_1M = {\n    ModelName.HAIKU: (0.25, 1.25),    # (input, output) per 1M tokens\n    ModelName.SONNET: (3.00, 15.00),\n    ModelName.OPUS: (15.00, 75.00),\n}\n</code></pre></p> <p>Credit Costs: <pre><code>ACTION_CREDITS = {\n    ActionType.LOD3: 10,      # Haiku - high margin\n    ActionType.LOD4: 100,     # Sonnet - 30-70% margin\n    ActionType.LOD5: 400,     # Opus - 0-73% margin\n    ActionType.BRANCH: 150,   # State storage\n    ActionType.INHABIT: 100,  # Per 10 minutes\n    ActionType.FORCE: 50,     # Ethics premium\n}\n</code></pre></p> <p>Revenue Calculation: - Conservative: $0.006/credit (Adventurer tier) - Used for margin calculations - Actual revenue varies by user tier</p>"},{"location":"track-b-metrics-summary/#4-dashboard-queries","title":"4. Dashboard Queries","text":"<p>Example queries enabled:</p> <p>Q: \"What was the average LOD3 latency today?\" <pre><code>store.aggregate(\n    action_type=\"lod3\",\n    since=datetime.today()\n)\n# Returns: avg_latency_ms, p50, p95\n</code></pre></p> <p>Q: \"What's the gross margin for LOD4 this week?\" <pre><code>store.aggregate(\n    action_type=\"lod4\",\n    since=datetime.now() - timedelta(days=7)\n)\n# Returns: total_cost_usd, total_revenue_usd, avg_margin\n</code></pre></p> <p>Q: \"Which model is being used most?\" <pre><code>agg = store.aggregate(town_id=\"xyz\")\n# Returns: by_model breakdown with counts\n</code></pre></p>"},{"location":"track-b-metrics-summary/#5-test-coverage","title":"5. Test Coverage","text":"<p>File: <code>/Users/kentgang/git/kgents/impl/claude/protocols/api/_tests/test_action_metrics.py</code> - 33 tests covering all ActionMetric functionality - MetricsStore query/aggregation - Decorator async/sync - Error handling - Constants validation - Dashboard use cases - SLO tracking - Ethics monitoring</p> <p>File: <code>/Users/kentgang/git/kgents/impl/claude/protocols/api/_tests/test_metrics_integration.py</code> - 6 integration tests - LOD query emission - Flux operations - Unit economics validation - OTEL span export</p> <p>Total: 39/39 tests passing (100%)</p>"},{"location":"track-b-metrics-summary/#exit-criteria-status","title":"Exit Criteria Status","text":"Criterion Status Evidence ActionMetric captures type/tokens/model/latency/credits \u2705 COMPLETE action_metrics.py:115-153 @instrument_action works on async functions \u2705 COMPLETE action_metrics.py:437-538 Every LLM call emits metric \u2705 COMPLETE dialogue_engine.py:476-498, flux.py:174-210 OTEL spans exported \u2705 COMPLETE action_metrics.py:381-417 30+ tests passing \u2705 COMPLETE 39 tests (33 + 6) Can query \"average LOD3 latency today\" \u2705 COMPLETE test_action_metrics.py:783-814"},{"location":"track-b-metrics-summary/#non-goals-deferred","title":"Non-Goals Deferred","text":"Item Reason When to Revisit Grafana/dashboard UI Focus on API first Post-launch Billing integration Track C dependency Next phase Alert rules Need production data Post-launch TimescaleDB/ClickHouse In-memory sufficient for MVP Scale milestone OTEL collector config Console export for dev Production deployment"},{"location":"track-b-metrics-summary/#key-files","title":"Key Files","text":""},{"location":"track-b-metrics-summary/#core-infrastructure","title":"Core Infrastructure","text":"<ul> <li><code>impl/claude/protocols/api/action_metrics.py</code> (650 lines)</li> <li><code>impl/claude/protocols/api/_tests/test_action_metrics.py</code> (925 lines)</li> <li><code>impl/claude/protocols/api/_tests/test_metrics_integration.py</code> (200 lines)</li> </ul>"},{"location":"track-b-metrics-summary/#integration-points","title":"Integration Points","text":"<ul> <li><code>impl/claude/protocols/api/town.py</code> (metrics endpoint added)</li> <li><code>impl/claude/agents/town/dialogue_engine.py</code> (metrics emission)</li> <li><code>impl/claude/agents/town/flux.py</code> (flux operation metrics)</li> </ul>"},{"location":"track-b-metrics-summary/#next-steps-track-c","title":"Next Steps (Track C)","text":"<p>With instrumentation complete, Track C can proceed with:</p> <ol> <li>BudgetStore - Credit balance tracking</li> <li>Paywall - LOD 3-5 upgrade enforcement</li> <li>Stripe Integration - Payment processing</li> <li>Kill-switch - CAC/churn thresholds</li> </ol> <p>The metrics infrastructure is now ready to validate business hypotheses.</p>"},{"location":"track-b-metrics-summary/#example-usage","title":"Example Usage","text":""},{"location":"track-b-metrics-summary/#dashboard-query","title":"Dashboard Query","text":"<pre><code>curl http://localhost:8000/v1/town/abc123/metrics?action_type=lod3&amp;since_hours=24\n</code></pre> <pre><code>{\n  \"town_id\": \"abc123\",\n  \"action_type\": \"lod3\",\n  \"time_window_hours\": 24,\n  \"metrics\": {\n    \"count\": 150,\n    \"total_tokens\": 22500,\n    \"total_credits\": 1500,\n    \"avg_latency_ms\": 125.3,\n    \"p50_latency_ms\": 120,\n    \"p95_latency_ms\": 180,\n    \"avg_margin\": 0.95,\n    \"by_model\": {\n      \"haiku\": {\n        \"count\": 150,\n        \"total_tokens\": 22500,\n        \"avg_latency_ms\": 125.3\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"track-b-metrics-summary/#manual-emission","title":"Manual Emission","text":"<pre><code>from protocols.api.action_metrics import emit_action_metric\n\nmetric = emit_action_metric(\n    action_type=\"lod4\",\n    user_id=\"user-123\",\n    town_id=\"town-456\",\n    citizen_id=\"citizen-789\",\n    tokens_in=500,\n    tokens_out=300,\n    model=\"sonnet\",\n    latency_ms=1000,\n    credits_charged=100,\n)\n\nprint(f\"Cost: ${metric.estimated_cost_usd:.6f}\")\nprint(f\"Revenue: ${metric.revenue_usd:.2f}\")\nprint(f\"Margin: {metric.gross_margin:.1%}\")\n</code></pre> <p>\"Without metrics, we cannot validate business hypotheses. Track B provides the foundation for Track C (monetization) and data-driven decision making.\"</p>"},{"location":"web-reactive-architecture/","title":"Web Reactive Architecture","text":"<p>Unifying the Agent Town web frontend with the kgents reactive substrate.</p>"},{"location":"web-reactive-architecture/#quick-summary","title":"Quick Summary","text":"<p>The web frontend should consume JSON projections from Python widgets rather than maintaining separate state management. Same widget definitions, different rendering targets.</p> <pre><code>Python Widget \u2192 .to_json() \u2192 SSE \u2192 React Component\n</code></pre>"},{"location":"web-reactive-architecture/#the-problem","title":"The Problem","text":"<p>Currently, the web frontend duplicates state management:</p> Layer Current Target State Zustand stores Signal bridges Widgets Custom React JSON projection consumers Composition Manual JSX HStack/VStack primitives Types Manual interfaces Generated from Python <p>Cost of duplication: Every state change requires updates in two places. Bug fixes don't propagate. Test coverage doubles.</p>"},{"location":"web-reactive-architecture/#the-solution","title":"The Solution","text":""},{"location":"web-reactive-architecture/#1-json-projection-as-contract","title":"1. JSON Projection as Contract","text":"<p>Python widgets already have <code>to_json()</code> methods:</p> <pre><code># impl/claude/agents/i/reactive/primitives/citizen_card.py\nclass CitizenWidget:\n    def to_json(self) -&gt; dict:\n        return {\n            \"type\": \"citizen_card\",\n            \"citizen_id\": self.state.value.citizen_id,\n            \"name\": self.state.value.name,\n            ...\n        }\n</code></pre> <p>TypeScript consumes this directly:</p> <pre><code>// impl/claude/web/src/widgets/CitizenCard.tsx\ninterface CitizenCardProps {\n  type: 'citizen_card';\n  citizen_id: string;\n  name: string;\n  ...\n}\n\nfunction CitizenCard(props: CitizenCardProps) {\n  return &lt;div&gt;{props.name}&lt;/div&gt;;\n}\n</code></pre>"},{"location":"web-reactive-architecture/#2-sse-delivers-state","title":"2. SSE Delivers State","text":"<p>The backend streams JSON projections:</p> <pre><code># Backend\nyield sse_event('live.state', ColonyDashboard(state).to_json())\n</code></pre> <pre><code>// Frontend\neventSource.addEventListener('live.state', (e) =&gt; {\n  setDashboard(JSON.parse(e.data));\n});\n</code></pre>"},{"location":"web-reactive-architecture/#3-composition-preserves-laws","title":"3. Composition Preserves Laws","text":"<p>The <code>&gt;&gt;</code> and <code>//</code> operators map to React:</p> Python TypeScript <code>a &gt;&gt; b</code> <code>&lt;HStack&gt;{a}{b}&lt;/HStack&gt;</code> <code>a // b</code> <code>&lt;VStack&gt;{a}{b}&lt;/VStack&gt;</code> <p>Both satisfy associativity: <code>(a &gt;&gt; b) &gt;&gt; c \u2261 a &gt;&gt; (b &gt;&gt; c)</code></p>"},{"location":"web-reactive-architecture/#architecture-diagram","title":"Architecture Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    BACKEND (Python)                             \u2502\n\u2502                                                                 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 TownFlux    \u2502\u2500\u2500\u2500\u2500\u25ba\u2502 ColonyState  \u2502\u2500\u2500\u2500\u2500\u25ba\u2502 ColonyDashboard \u2502  \u2502\n\u2502  \u2502 (events)    \u2502     \u2502 (frozen)     \u2502     \u2502 .to_json()      \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                     \u2502          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                                      \u2502\n                                              SSE: live.state\n                                                      \u2502\n                                                      \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    FRONTEND (TypeScript)                        \u2502\n\u2502                                                                 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 useTownStream() \u2502\u2500\u2500\u2500\u2500\u25ba\u2502 &lt;ColonyDashboard {...json} /&gt;   \u2502   \u2502\n\u2502  \u2502 (hook)          \u2502     \u2502                                 \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502   \u2502\n\u2502                          \u2502   \u2502 &lt;HStack&gt;                \u2502   \u2502   \u2502\n\u2502                          \u2502   \u2502   &lt;CitizenCard /&gt;       \u2502   \u2502   \u2502\n\u2502                          \u2502   \u2502   &lt;CitizenCard /&gt;       \u2502   \u2502   \u2502\n\u2502                          \u2502   \u2502 &lt;/HStack&gt;               \u2502   \u2502   \u2502\n\u2502                          \u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502   \u2502\n\u2502                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"web-reactive-architecture/#key-files","title":"Key Files","text":""},{"location":"web-reactive-architecture/#python-existing","title":"Python (Existing)","text":"File Purpose <code>agents/i/reactive/signal.py</code> Signal[T] primitive <code>agents/i/reactive/composable.py</code> HStack/VStack composition <code>agents/i/reactive/widget.py</code> KgentsWidget base class <code>agents/i/reactive/primitives/citizen_card.py</code> CitizenWidget <code>agents/i/reactive/colony_dashboard.py</code> ColonyDashboard"},{"location":"web-reactive-architecture/#typescript-new","title":"TypeScript (New)","text":"File Purpose <code>web/src/reactive/types.ts</code> WidgetJSON type definitions <code>web/src/reactive/WidgetRenderer.tsx</code> Dynamic widget renderer <code>web/src/widgets/CitizenCard.tsx</code> CitizenCard component <code>web/src/widgets/layout/HStack.tsx</code> HStack layout <code>web/src/widgets/layout/VStack.tsx</code> VStack layout"},{"location":"web-reactive-architecture/#migration-path","title":"Migration Path","text":""},{"location":"web-reactive-architecture/#phase-1-add-bridge-non-breaking","title":"Phase 1: Add Bridge (Non-Breaking)","text":"<p>Create <code>src/reactive/</code> module alongside existing code.</p>"},{"location":"web-reactive-architecture/#phase-2-create-widgets-non-breaking","title":"Phase 2: Create Widgets (Non-Breaking)","text":"<p>Create <code>src/widgets/</code> consuming JSON projections.</p>"},{"location":"web-reactive-architecture/#phase-3-integrate-sse-non-breaking","title":"Phase 3: Integrate SSE (Non-Breaking)","text":"<p>Add <code>live.state</code> event type to SSE stream.</p>"},{"location":"web-reactive-architecture/#phase-4-migrate-pages-breaking","title":"Phase 4: Migrate Pages (Breaking)","text":"<p>Replace Zustand usage with hook-based state.</p>"},{"location":"web-reactive-architecture/#phase-5-cleanup-breaking","title":"Phase 5: Cleanup (Breaking)","text":"<p>Remove Zustand, deprecated code.</p>"},{"location":"web-reactive-architecture/#category-theory-foundation","title":"Category Theory Foundation","text":"<p>The refactoring is justified by categorical principles:</p>"},{"location":"web-reactive-architecture/#functor-laws","title":"Functor Laws","text":"<p>The Web projection is a functor <code>F : Widget \u2192 ReactComponent</code>:</p> <ol> <li>Identity: <code>F(Id) = &lt;Fragment&gt;</code> (identity widget maps to fragment)</li> <li>Composition: <code>F(a &gt;&gt; b) = &lt;HStack&gt;{F(a)}{F(b)}&lt;/HStack&gt;</code></li> </ol>"},{"location":"web-reactive-architecture/#natural-transformation","title":"Natural Transformation","text":"<p>State updates commute with projection:</p> <pre><code>        State\u2081 \u2500\u2500\u2500\u2500\u2500update\u2500\u2500\u2500\u2500\u2500\u25ba State\u2082\n           \u2502                       \u2502\n      to_json()               to_json()\n           \u2502                       \u2502\n           \u25bc                       \u25bc\n        JSON\u2081 \u2500\u2500\u2500\u2500\u2500\u2500render\u2500\u2500\u2500\u2500\u2500\u2500\u25ba JSON\u2082\n</code></pre>"},{"location":"web-reactive-architecture/#verification","title":"Verification","text":"<p>Use <code>CategoryLawVerifier</code> from <code>protocols/agentese/laws.py</code> to verify composition laws hold for new React components.</p>"},{"location":"web-reactive-architecture/#external-research-integration","title":"External Research Integration","text":"<p>This architecture aligns with industry patterns from 2025:</p> Pattern Source Our Implementation AG-UI Protocol Microsoft SSE event types for state sync Generative UI Vercel AI SDK Tool results \u2192 widget state Signals SolidJS Signal bridge hooks MCP-UI Block JSON projection as interface <p>See spec references for full citations.</p>"},{"location":"web-reactive-architecture/#spec-plan-references","title":"Spec &amp; Plan References","text":"<ul> <li>Specification: <code>spec/protocols/web-reactive.md</code></li> <li>Implementation Plan: <code>plans/agent-town/web-reactive-refactor.md</code></li> <li>Projection Protocol: <code>spec/protocols/projection.md</code></li> <li>Category Laws: <code>protocols/agentese/laws.py</code></li> </ul>"},{"location":"web-reactive-architecture/#quick-start","title":"Quick Start","text":""},{"location":"web-reactive-architecture/#consuming-a-widget","title":"Consuming a Widget","text":"<pre><code>import { WidgetRenderer } from '@/reactive';\nimport type { ColonyDashboardJSON } from '@/reactive/types';\n\nfunction TownPage() {\n  const { dashboard } = useTownStream({ townId: 'my-town' });\n\n  if (!dashboard) return &lt;Loading /&gt;;\n\n  return &lt;WidgetRenderer widget={dashboard} /&gt;;\n}\n</code></pre>"},{"location":"web-reactive-architecture/#creating-a-widget-component","title":"Creating a Widget Component","text":"<pre><code>import type { MyWidgetJSON } from '@/reactive/types';\n\ninterface MyWidgetProps extends Omit&lt;MyWidgetJSON, 'type'&gt; {\n  onSelect?: (id: string) =&gt; void;\n}\n\nexport function MyWidget({ field1, field2, onSelect }: MyWidgetProps) {\n  return (\n    &lt;div onClick={() =&gt; onSelect?.(field1)}&gt;\n      {field2}\n    &lt;/div&gt;\n  );\n}\n</code></pre>"},{"location":"web-reactive-architecture/#registering-in-widgetrenderer","title":"Registering in WidgetRenderer","text":"<pre><code>// src/reactive/WidgetRenderer.tsx\ncase 'my_widget':\n  return &lt;MyWidget {...widget} onSelect={onSelect} /&gt;;\n</code></pre>"},{"location":"web-reactive-architecture/#faq","title":"FAQ","text":"<p>Q: Why not use React Server Components?</p> <p>A: RSC requires a Node.js backend. Our backend is Python. JSON projection is the bridge.</p> <p>Q: What about real-time updates?</p> <p>A: SSE handles streaming. The <code>live.state</code> event delivers complete projections. Delta updates can be added later.</p> <p>Q: How do we handle user interactions?</p> <p>A: Events flow up via callbacks (<code>onSelect</code>), state flows down via projections. Same as React.</p> <p>Q: What about Mesa/PixiJS?</p> <p>A: Mesa continues using PixiJS, but consumes citizen positions from JSON projections rather than Zustand.</p> <p>\"The web is just another terminal. Define once, project everywhere.\"</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/","title":"kgents Implementation Bootstrap","text":"<p>You are instantiating kgents implementations from spec. You are an LLM doing mechanical translation\u2014the judgment has already been made in the spec.</p> <p>AND: You should USE kgents to HELP you implement. This is autopoiesis.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#step-0-instantiate-runtime-always-first","title":"Step 0: Instantiate Runtime (ALWAYS FIRST)","text":"<p>Before writing ANY implementation code:</p> <pre><code>from runtime import ClaudeCLIRuntime\nfrom agents.k import kgent, DialogueMode, DialogueInput\nfrom agents.a import creativity_coach, CreativityInput, CreativityMode\nfrom agents.b import hypothesis_engine, HypothesisInput\n\nruntime = ClaudeCLIRuntime()\n\n# Use K-gent for naming decisions\nnaming_help = await runtime.execute(kgent(), DialogueInput(\n    message=\"I need to name a class that does X. What fits Kent's style?\",\n    mode=DialogueMode.ADVISE\n))\n\n# Use CreativityCoach for design exploration\ndesign_ideas = await runtime.execute(creativity_coach(), CreativityInput(\n    seed=\"the problem I'm solving\",\n    mode=CreativityMode.EXPAND\n))\n\n# Use HypothesisEngine for architecture validation\nvalidation = await runtime.execute(hypothesis_engine(), HypothesisInput(\n    observations=[\"what I know\"],\n    domain=\"software architecture\",\n    question=\"Is this the right approach?\"\n))\n</code></pre> <p>Autopoiesis Score = (lines generated by kgents) / (total lines). Target: &gt;50%.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#the-llmhuman-boundary","title":"The LLM/Human Boundary","text":"<pre><code>Spec + Ground = Human territory (irreducible, already provided)\nImpl = Your territory (mechanical translation from spec)\nPolish = Hybrid (kgents agents + human judgment)\n</code></pre> <p>You cannot create Ground from nothing. You cannot replace human judgment. You CAN: 1. Faithfully translate spec to code 2. Use kgents agents to GENERATE that code 3. Apply the required patterns</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#context-files-read-in-order","title":"Context Files (read in order)","text":"<ol> <li><code>spec/bootstrap.md</code> - The 7 irreducible agents</li> <li><code>spec/principles.md</code> - Judge's 7 criteria</li> <li><code>spec/anatomy.md</code> - What constitutes an agent</li> <li><code>spec/c-gents/composition.md</code> - How agents compose</li> <li><code>../AUTONOMOUS_BOOTSTRAP_PROTOCOL.md</code> - Meta-level protocol for Kent + Claude Code collaboration</li> </ol> <p>Note: This document provides implementation guidance for building the bootstrap agents. For the meta-level protocol governing how Kent and Claude Code collaborate during development, see <code>../AUTONOMOUS_BOOTSTRAP_PROTOCOL.md</code>.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#the-7-bootstrap-agents","title":"The 7 Bootstrap Agents","text":"<pre><code>{Id, Compose, Judge, Ground, Contradict, Sublate, Fix}\n</code></pre> Agent Type Purpose Id <code>A \u2192 A</code> Composition unit (\u03bbx.x) Compose <code>(Agent, Agent) \u2192 Agent</code> Build pipelines Judge <code>(Agent, Principles) \u2192 Verdict</code> Value function (7 principles) - see below for composition structure Ground <code>Void \u2192 Facts</code> Empirical seed (persona + world) Contradict <code>(A, B) \u2192 Tension \\| None</code> Detect conflicts Sublate <code>Tension \u2192 Synthesis \\| Hold</code> Resolve or hold Fix <code>(A \u2192 A) \u2192 A</code> Fixed-point iteration"},{"location":"_archive/BOOTSTRAP_PROMPT/#implementation-dependency-graph","title":"Implementation Dependency Graph","text":"<p>The 7 bootstrap agents have dependencies on each other. Implement them in this order:</p> <pre><code>Level 0 (Foundation):\n  \u2514\u2500 types.py          # Agent, Tension, Verdict, Synthesis, Result types\n\nLevel 1 (No dependencies):\n  \u251c\u2500 id.py             # Identity agent (A \u2192 A)\n  \u2514\u2500 ground.py         # Ground agent (Void \u2192 Facts)\n\nLevel 2 (Depend on Level 0-1):\n  \u251c\u2500 compose.py        # Composition (depends on Agent, Id)\n  \u2514\u2500 contradict.py     # Contradiction detection (depends on Tension)\n\nLevel 3 (Depend on Level 0-2):\n  \u251c\u2500 judge.py          # Judgment (depends on Verdict, compose for mini-judges)\n  \u2514\u2500 sublate.py        # Synthesis (depends on Tension, Synthesis)\n\nLevel 4 (Depend on all others):\n  \u2514\u2500 fix.py            # Fixed-point iteration (depends on Agent, compose)\n</code></pre> <p>Implementation Strategy: 1. Start with <code>types.py</code> - defines all core data structures 2. Implement Level 1 agents (id, ground) - these are simplest and have no agent dependencies 3. Implement Level 2 agents (compose, contradict) - now you can compose agents 4. Implement Level 3 agents (judge, sublate) - these use composition 5. Implement Level 4 (fix) - uses all previous agents for iteration patterns</p> <p>Verification at each level: - Write tests verifying composition laws (associativity, identity) - Check type safety with mypy - Ensure all agents satisfy <code>Agent[A, B]</code> protocol</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#judge-seven-mini-judges-architecture","title":"Judge: Seven Mini-Judges Architecture","text":"<p>Judge is implemented as seven separate agents composed via <code>&gt;&gt;</code>. This maximizes composability and testability.</p> <p>Structure: <pre><code># Seven individual judge agents, one per principle\njudge_tasteful = JudgeTasteful()       # Is this aesthetically considered?\njudge_curated = JudgeCurated()         # Does this add unique value?\njudge_ethical = JudgeEthical()         # Does this respect human agency?\njudge_joyful = JudgeJoyful()           # Would I enjoy this?\njudge_composable = JudgeComposable()   # Can this combine with others?\njudge_generative = JudgeGenerative()   # Could this be regenerated from spec?\njudge_heterarchical = JudgeHeterarchical()  # Does this avoid fixed hierarchy?\n\n# Compose into full Judge pipeline\njudge = (judge_tasteful &gt;&gt; judge_curated &gt;&gt; judge_ethical &gt;&gt;\n         judge_joyful &gt;&gt; judge_composable &gt;&gt; judge_generative &gt;&gt;\n         judge_heterarchical)\n</code></pre></p> <p>Each mini-judge type: <pre><code>class JudgeTasteful(Agent[JudgeInput, PartialVerdict]):\n    \"\"\"\n    Evaluates tasteful principle: compressed expertise, no bloat.\n\n    Input: JudgeInput with agent spec and context\n    Output: PartialVerdict with pass/fail and reasons for this principle\n    \"\"\"\n    async def invoke(self, input: JudgeInput) -&gt; PartialVerdict:\n        # Evaluate against tasteful principle\n        # Return PartialVerdict(principle=\"tasteful\", passed=True/False, reasons=[...])\n</code></pre></p> <p>Final aggregation: The composed pipeline accumulates partial verdicts. The final agent in the chain (or a separate <code>AggregateVerdict</code> agent) converts <code>List[PartialVerdict]</code> \u2192 <code>Verdict</code> with overall ACCEPT/REJECT/REVISE.</p> <p>Benefits: - Each principle independently testable - Can reuse individual judges (e.g., just <code>judge_composable</code> for C-gents) - Clear separation of concerns - Easy to add/remove principles - Demonstrates composability principle in practice</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#regeneration-sequence","title":"Regeneration Sequence","text":"<ol> <li>Ground - Load persona from <code>spec/k-gent/persona.md</code></li> <li>Judge - Encode 7 principles as executable evaluation</li> <li>Compose - Build pipelines (associative, Id as unit)</li> <li>Contradict - Surface tensions before they become errors</li> <li>Sublate - Synthesize or consciously hold</li> <li>Fix - Iterate until stable (Judge accepts, Contradict finds nothing)</li> </ol>"},{"location":"_archive/BOOTSTRAP_PROMPT/#ground-extraction-via-groundparser-agent","title":"Ground Extraction via GroundParser Agent","text":"<p>Agent-based parsing (increases autopoiesis):</p> <p>Instead of manually parsing <code>persona.md</code>, use a <code>GroundParser</code> agent to extract structured <code>PersonaSeed</code> data from markdown. This demonstrates using agents to build agents - a key autopoiesis pattern.</p> <p>GroundParser Agent: <pre><code>class GroundParser(LLMAgent[str, PersonaSeed]):\n    \"\"\"\n    Parse natural language persona spec \u2192 structured PersonaSeed.\n\n    Input: markdown string from persona.md\n    Output: PersonaSeed(name, values, interests, style, dislikes, context)\n\n    Pattern:\n    - Markdown sections \u2192 PersonaSeed fields\n    - LLM extracts semantic content\n    - Validates completeness (all required fields present)\n    \"\"\"\n    ...\n</code></pre></p> <p>Usage in Ground agent: <pre><code>async def invoke(self, _: None) -&gt; PersonaSeed:\n    # Read persona.md\n    with open(\"spec/k-gent/persona.md\") as f:\n        markdown = f.read()\n\n    # Use GroundParser to extract structured data\n    parser = GroundParser()\n    seed = await runtime.execute(parser, markdown)\n\n    return seed  # PersonaSeed ready for use\n</code></pre></p> <p>Why this matters: - Autopoiesis: Agents extract agent specifications - Flexibility: Easy to update persona.md without changing parsing code - Validation: LLM can detect missing or inconsistent persona fields - Composability: GroundParser is itself an agent (A \u2192 B morphism)</p> <p>Implementation: See <code>impl/claude/bootstrap/ground_parser.py</code></p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#implementation-targets","title":"Implementation Targets","text":""},{"location":"_archive/BOOTSTRAP_PROMPT/#target-implclaude","title":"Target: <code>impl/claude/</code>","text":"<p>Reference implementation. Bootstrap agents as Python, LLM runtime via Claude + OpenRouter.</p> <p>Note: Formerly specified as <code>impl/claude-openrouter/</code> in earlier docs. Path canonicalized to <code>impl/claude/</code> in Phase 1 (type system foundation).</p> <pre><code>impl/claude/\n\u251c\u2500\u2500 bootstrap/      # The 7 primitives\n\u251c\u2500\u2500 agents/{a,b,c,h,k}/  # 5 genera\n\u2514\u2500\u2500 runtime/        # LLM-backed agents\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#required-patterns","title":"Required Patterns","text":""},{"location":"_archive/BOOTSTRAP_PROMPT/#pattern-fix-needs-memory","title":"Pattern: Fix Needs Memory","text":"<pre><code># WRONG: Stateless (no convergence possible)\ndef detect() -&gt; Result:\n    return Result(confidence=0.2)\n\n# RIGHT: Stateful (accumulates to convergence)\ndef detect(previous: Result) -&gt; Result:\n    if same_state:\n        return Result(confidence=min(1.0, previous.confidence + 0.2))\n    return Result(confidence=0.2)\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#pattern-ground-includes-environment","title":"Pattern: Ground Includes Environment","text":"<pre><code># WRONG: Platform-specific\n\"read -p 'prompt' var\"  # bash-only\n\n# RIGHT: POSIX-compatible\n\"printf 'prompt ' &amp;&amp; read var\"\n</code></pre> <pre><code># WRONG: Import hacks\nimport sys; sys.path.insert(0, \"../..\")\n\n# RIGHT: Proper packaging\n[project]\ndependencies = [\"kgents-runtime\"]\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#pattern-sublate-dont-overwrite","title":"Pattern: Sublate, Don't Overwrite","text":"<pre><code># WRONG: Replaces defaults\nconfig = data.get(\"config\", {})\n\n# RIGHT: Merges with defaults\nconfig = {**defaults, **data.get(\"config\", {})}\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#pattern-events-are-sublate-traces","title":"Pattern: Events are Sublate Traces","text":"<pre><code># WRONG: Silent state change\ndel self._items[id]\nreturn True\n\n# RIGHT: State changes emit events\ndel self._items[id]\nawait self._emit_event(ItemRemoved(item_id=id))\nreturn True\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#pattern-conflicts-are-data","title":"Pattern: Conflicts are Data","text":"<pre><code># WRONG: Silent exception swallowing\nexcept Exception:\n    pass\n\n# RIGHT: Log conflicts\nexcept Exception as e:\n    self.log.warning(f\"Conflict: {e}\")\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#pattern-composable-layouts","title":"Pattern: Composable Layouts","text":"<pre><code>/* WRONG: Rigid */\nheight: 30%\n\n/* RIGHT: Flexible with constraints */\nheight: 1fr\nmin-height: 8\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#worked-example-implementing-the-id-agent","title":"Worked Example: Implementing the Id Agent","text":"<p>This section shows a complete spec-to-implementation walkthrough for the simplest bootstrap agent.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#step-1-read-the-spec","title":"Step 1: Read the Spec","text":"<p>From <code>spec/bootstrap.md</code> (lines 41-55):</p> <pre><code>### 1. Id (Identity)\n\nId: A \u2192 A\nId(x) = x\n\nThe agent that does nothing. Required by the category-theoretic structure:\n- Left identity: Id \u2218 f = f\n- Right identity: f \u2218 Id = f\n\nWhy irreducible: You cannot define identity in terms of anything simpler.\nIt is the unit of composition.\n\nWhat it grounds: The existence of agents as a category. Without Id, composition has no unit.\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#step-2-extract-type-signature","title":"Step 2: Extract Type Signature","text":"<p>From spec: - Type: <code>A \u2192 A</code> (generic input type A, returns same type A) - Law: <code>Id(x) = x</code> (identity function) - Composition laws: Left identity (<code>Id \u2218 f = f</code>), Right identity (<code>f \u2218 Id = f</code>)</p> <p>Translation to Python: <pre><code>class Id(Agent[A, A]):\n    # Agent[A, A] means: takes input of type A, returns output of type A\n</code></pre></p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#step-3-generate-implementation","title":"Step 3: Generate Implementation","text":"<p>Using the template pattern from <code>bootstrap/types.py</code>:</p> <pre><code>\"\"\"\nId (Identity) - The agent that does nothing.\n\nType: A \u2192 A\nLaw: Id(x) = x\n\nThe composition unit. Required by category-theoretic structure:\n- Left identity:  Id \u2218 f = f\n- Right identity: f \u2218 Id = f\n\"\"\"\n\nfrom typing import TypeVar, Any\nfrom .types import Agent\n\nA = TypeVar(\"A\")\n\n\nclass Id(Agent[A, A]):\n    \"\"\"\n    Identity agent: \u03bbx.x\n\n    Usage:\n        id_agent = Id()\n        result = await id_agent.invoke(x)  # result == x\n\n    Composition:\n        Id() &gt;&gt; SomeAgent == SomeAgent  # Right identity\n        SomeAgent &gt;&gt; Id() == SomeAgent  # Left identity\n    \"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"Id\"\n\n    async def invoke(self, input: A) -&gt; A:\n        \"\"\"Identity: returns input unchanged.\"\"\"\n        # Runtime verification that we truly return the same object\n        result = input\n        if result is not input:\n            raise RuntimeError(\n                f\"Id agent violated identity law: input is not result (id mismatch)\"\n            )\n        return result\n\n    def __rshift__(self, other: \"Agent[A, Any]\") -&gt; \"Agent[A, Any]\":\n        \"\"\"Right identity law: Id &gt;&gt; f = f\"\"\"\n        # Optimization: composing with Id on the left is just the other agent\n        return other\n\n    def __repr__(self) -&gt; str:\n        return \"Id()\"\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#step-4-verify-composition-laws","title":"Step 4: Verify Composition Laws","text":"<p>The implementation ensures the category laws:</p> <p>Right identity (<code>Id &gt;&gt; f = f</code>): <pre><code>def __rshift__(self, other):\n    return other  # Id &gt;&gt; f just returns f\n</code></pre></p> <p>Left identity (<code>f &gt;&gt; Id = f</code>): This is handled by the general composition operator in <code>Agent.__rshift__</code>, but the <code>invoke</code> method ensures that <code>Id(x) = x</code>, so <code>f(x) &gt;&gt; Id</code> will always equal <code>f(x)</code>.</p> <p>Associativity: Inherited from <code>&gt;&gt;</code> operator composition.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#step-5-judge-against-principles","title":"Step 5: Judge Against Principles","text":"<p>Tasteful: \u2713 Minimal, no unnecessary code Curated: \u2713 Irreducible primitive, cannot be simpler Ethical: \u2713 Transparent identity function Joyful: \u2713 Clean implementation of mathematical concept Composable: \u2713 Explicitly designed as composition unit Generative: \u2713 Can be regenerated from spec Heterarchical: \u2713 No hidden control flow</p> <p>Verdict: ACCEPT</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#key-takeaways","title":"Key Takeaways","text":"<ol> <li>Module docstring mirrors spec language (type signature, laws, purpose)</li> <li>Class docstring adds usage examples and composition behavior</li> <li>Type parameter <code>A = TypeVar(\"A\")</code> for generic input/output</li> <li>Runtime verification optional but demonstrates law compliance</li> <li>Optimization in <code>__rshift__</code> leverages identity law for performance</li> <li>Minimal - only what's required by the spec, nothing more</li> </ol> <p>This pattern applies to all bootstrap agents: Read spec \u2192 Extract types \u2192 Translate mechanically \u2192 Verify laws \u2192 Judge.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#agent-implementation-template","title":"Agent Implementation Template","text":"<p>Use this template for implementing any new agent. Fill in the blanks based on the spec.</p> <pre><code>\"\"\"\n[AgentName] - [One-line description from spec]\n\nType: [Input] \u2192 [Output]\n[Key laws or properties from spec]\n\n[Purpose and why it's needed from spec]\n\"\"\"\n\nfrom typing import TypeVar\nfrom .types import Agent\n\n# Type variables (adjust as needed)\nA = TypeVar(\"A\")  # Input type\nB = TypeVar(\"B\")  # Output type\n\n\nclass [AgentName](Agent[A, B]):\n    \"\"\"\n    [Detailed description]\n\n    Usage:\n        agent = [AgentName]([constructor args if any])\n        result = await agent.invoke(input_data)\n\n    Composition:\n        [Example of composing with other agents if relevant]\n    \"\"\"\n\n    def __init__(self, [constructor parameters if needed]):\n        \"\"\"\n        Initialize [AgentName].\n\n        Args:\n            [parameter]: [description]\n        \"\"\"\n        # Initialize state if needed\n        pass\n\n    @property\n    def name(self) -&gt; str:\n        return \"[AgentName]\"\n\n    async def invoke(self, input: A) -&gt; B:\n        \"\"\"\n        [Brief description of transformation]\n\n        Args:\n            input: [Description of input type and meaning]\n\n        Returns:\n            [Description of output type and meaning]\n\n        Raises:\n            [Any expected exceptions]\n        \"\"\"\n        # Step 1: [First transformation step]\n        # Step 2: [Second transformation step]\n        # Step 3: Return result\n\n        result: B = ...  # Implementation here\n        return result\n\n    # Optional: Override composition if special behavior needed\n    # def __rshift__(self, other: \"Agent[B, C]\") -&gt; \"Agent[A, C]\":\n    #     \"\"\"Special composition behavior if needed.\"\"\"\n    #     return ...\n\n    def __repr__(self) -&gt; str:\n        return f\"[AgentName]([repr of key params])\"\n\n\n# Optional: Convenience constructor functions\ndef [agent_name_lowercase]([parameters]) -&gt; [AgentName]:\n    \"\"\"\n    Create [AgentName] with [specific configuration].\n\n    This is the default/recommended constructor.\n    \"\"\"\n    return [AgentName]([parameters])\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#template-usage-checklist","title":"Template Usage Checklist","text":"<p>Before implementing a new agent, ensure:</p> <ul> <li> Read the spec completely - understand purpose, laws, examples</li> <li> Extract type signature - what are input and output types?</li> <li> Identify laws/properties - what invariants must hold?</li> <li> Check for composition patterns - does this compose with existing agents?</li> <li> Consider state - does the agent need internal state? (Usually no for pure agents)</li> <li> Write module docstring - copy key content from spec</li> <li> Write class docstring - add usage examples</li> <li> Implement invoke - mechanical translation of spec logic</li> <li> Add repr - for debugging and introspection</li> <li> Consider convenience constructors - make common cases easy</li> <li> Verify against spec - does <code>Contradict(impl, spec)</code> return <code>None</code>?</li> <li> Judge against principles - does it pass all 7 principles?</li> </ul>"},{"location":"_archive/BOOTSTRAP_PROMPT/#example-minimal-agent-passthrough","title":"Example: Minimal Agent (PassThrough)","text":"<pre><code>\"\"\"PassThrough - Returns input with logging.\"\"\"\n\nfrom typing import TypeVar\nfrom .types import Agent\n\nA = TypeVar(\"A\")\n\nclass PassThrough(Agent[A, A]):\n    \"\"\"Identity with side effect (logging).\"\"\"\n\n    def __init__(self, label: str = \"PassThrough\"):\n        self.label = label\n\n    @property\n    def name(self) -&gt; str:\n        return self.label\n\n    async def invoke(self, input: A) -&gt; A:\n        \"\"\"Log and return input unchanged.\"\"\"\n        print(f\"{self.label}: {input}\")\n        return input\n\n    def __repr__(self) -&gt; str:\n        return f\"PassThrough('{self.label}')\"\n</code></pre> <p>This minimal example shows the core structure. Real agents will have more complex logic in <code>invoke</code>, but the structure remains the same.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#applied-idioms","title":"Applied Idioms","text":""},{"location":"_archive/BOOTSTRAP_PROMPT/#idiom-1-polling-is-fix","title":"Idiom 1: Polling is Fix","text":"<pre><code>result = await fix(\n    transform=poll_and_detect,\n    initial=DetectionState(RUNNING, confidence=0.0),\n    equality_check=lambda a, b: a.state == b.state and b.confidence &gt;= 0.8\n)\n</code></pre> <p>Anti-pattern: <code>while True</code> with inline break conditions.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#idiom-2-conflict-is-data","title":"Idiom 2: Conflict is Data","text":"<pre><code>conflicts = contradict(config, ground_state)\nif conflicts:\n    resolution = sublate(conflicts[0])\n</code></pre> <p>Anti-pattern: Silent failures, swallowed exceptions.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#idiom-3-compose-dont-concatenate","title":"Idiom 3: Compose, Don't Concatenate","text":"<pre><code>Pipeline = Judge(config) &gt;&gt; Create(config) &gt;&gt; Spawn(session) &gt;&gt; Detect(session)\n</code></pre> <p>Anti-pattern: 130-line methods mixing validation, I/O, state, errors.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#idiom-4-error-handling-with-result-types","title":"Idiom 4: Error Handling with Result Types","text":"<p>When to use exceptions vs Result types:</p> <p>Use Result[A, E] for: - Expected failures (validation, parsing, network errors) - Composable error propagation - When errors are part of the domain model</p> <p>Use exceptions for: - Programming errors (assertions, type errors) - Truly exceptional conditions (out of memory, system failures) - When immediate termination is desired</p> <p>Pattern: Result type composition</p> <pre><code>from bootstrap.types import Result, Ok, Err\n\n# Agent that may fail\nclass ParseConfig(Agent[str, Result[Config, ConfigError]]):\n    async def invoke(self, input: str) -&gt; Result[Config, ConfigError]:\n        try:\n            config = parse(input)\n            return Ok(config)\n        except ValueError as e:\n            return Err(ConfigError(str(e)))\n\n# Composing Result-returning agents\nvalidate_result = await validate_agent.invoke(data)\nmatch validate_result:\n    case Ok(validated):\n        transform_result = await transform_agent.invoke(validated)\n        match transform_result:\n            case Ok(transformed):\n                return Ok(transformed)\n            case Err(e):\n                return Err(e)\n    case Err(e):\n        return Err(e)\n\n# Or use bind for cleaner composition\nresult = (\n    await validate_agent.invoke(data)\n    .bind(lambda v: transform_agent.invoke(v))\n    .bind(lambda t: persist_agent.invoke(t))\n)\n</code></pre> <p>Pattern: Graceful degradation</p> <pre><code># WRONG: Fail hard on optional features\ndef process(data):\n    enhanced = expensive_enhancement(data)  # Might fail\n    return enhanced\n\n# RIGHT: Degrade gracefully\ndef process(data):\n    try:\n        enhanced = expensive_enhancement(data)\n        return enhanced\n    except EnhancementError as e:\n        self.log.warning(f\"Enhancement failed: {e}, using base data\")\n        return data  # Fallback to unenhanced\n</code></pre> <p>From practice (impl/claude/runtime/base.py): - LLM parsing failures \u2192 structured Result types - Network errors \u2192 retryable vs permanent classification - Validation failures \u2192 detailed error messages with context</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#constraints","title":"Constraints","text":"<ul> <li>Composability is paramount (agents are morphisms)</li> <li>Quality over quantity (Judge rejects mediocrity)</li> <li>Each agent = one file with clear type signature</li> <li>Tests are required</li> </ul>"},{"location":"_archive/BOOTSTRAP_PROMPT/#verification","title":"Verification","text":"<p>A successful implementation satisfies:</p> <pre><code>assert Regenerate(Spec) \u2245 Impl\nassert Judge(Impl, Principles).verdict == \"accept\"\nassert Contradict(Impl, Spec) is None\nassert autopoiesis_score() &gt; 0.5\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#composition-verification-checklist","title":"Composition Verification Checklist","text":"<p>When implementing or reviewing an agent, verify these composability properties:</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#1-type-safety","title":"1. Type Safety","text":"<ul> <li> Input type is clearly defined - Agent[A, B] has concrete A type</li> <li> Output type is clearly defined - Agent[A, B] has concrete B type</li> <li> Type variables are consistent - Same TypeVar used throughout</li> <li> Generic constraints are documented - If A must be Serializable, state it</li> </ul> <pre><code># Example type safety test\ndef test_type_preservation():\n    agent: Agent[str, int] = MyAgent()\n    result = await agent.invoke(\"test\")\n    assert isinstance(result, int)  # Output type matches signature\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#2-composition-laws","title":"2. Composition Laws","text":"<ul> <li> Associativity holds - <code>(f &gt;&gt; g) &gt;&gt; h == f &gt;&gt; (g &gt;&gt; h)</code></li> <li> Left identity holds - <code>Id() &gt;&gt; agent == agent</code></li> <li> Right identity holds - <code>agent &gt;&gt; Id() == agent</code></li> </ul> <pre><code># Example composition law tests\nasync def test_associativity():\n    f, g, h = AgentF(), AgentG(), AgentH()\n    input_data = create_test_input()\n\n    # (f &gt;&gt; g) &gt;&gt; h\n    result1 = await ((f &gt;&gt; g) &gt;&gt; h).invoke(input_data)\n\n    # f &gt;&gt; (g &gt;&gt; h)\n    result2 = await (f &gt;&gt; (g &gt;&gt; h)).invoke(input_data)\n\n    assert result1 == result2\n\nasync def test_left_identity():\n    agent = MyAgent()\n    input_data = create_test_input()\n\n    result1 = await (Id() &gt;&gt; agent).invoke(input_data)\n    result2 = await agent.invoke(input_data)\n\n    assert result1 == result2\n\nasync def test_right_identity():\n    agent = MyAgent()\n    input_data = create_test_input()\n\n    result1 = await (agent &gt;&gt; Id()).invoke(input_data)\n    result2 = await agent.invoke(input_data)\n\n    assert result1 == result2\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#3-error-propagation","title":"3. Error Propagation","text":"<ul> <li> Errors compose correctly - Result[A, E] &gt;&gt; Result[B, E] propagates E</li> <li> Exceptions are documented - Raised exceptions listed in docstring</li> <li> Graceful degradation is explicit - Fallback behavior is clear</li> </ul> <pre><code># Example error propagation test\nasync def test_error_propagation():\n    failing_agent = FailingAgent()\n    downstream_agent = DownstreamAgent()\n\n    pipeline = failing_agent &gt;&gt; downstream_agent\n\n    with pytest.raises(ExpectedError):\n        await pipeline.invoke(test_input)\n    # Verify downstream never executed when upstream fails\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#4-state-isolation","title":"4. State Isolation","text":"<ul> <li> No shared mutable state - Each invocation is independent</li> <li> Thread-safe if needed - Concurrent invocations don't interfere</li> <li> Idempotent where expected - Same input \u2192 same output (for pure agents)</li> </ul> <pre><code># Example state isolation test\nasync def test_state_isolation():\n    agent = MyAgent()\n\n    # Concurrent invocations\n    results = await asyncio.gather(\n        agent.invoke(input1),\n        agent.invoke(input2),\n        agent.invoke(input1),  # Repeat\n    )\n\n    # Verify no cross-contamination\n    assert results[0] == results[2]  # Same input \u2192 same output\n    assert results[0] != results[1]  # Different inputs \u2192 different outputs\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#5-composition-operators","title":"5. Composition Operators","text":"<ul> <li> <code>&gt;&gt;</code> (right shift) works correctly - Sequential composition</li> <li> <code>__rshift__</code> preserves types - Agent[A,B] &gt;&gt; Agent[B,C] \u2192 Agent[A,C]</li> <li> Optimization is sound - Fast paths don't break semantics (e.g., Id &gt;&gt; f = f)</li> </ul> <pre><code># Example composition operator test\ndef test_rshift_types():\n    f: Agent[str, int] = StrToInt()\n    g: Agent[int, bool] = IntToBool()\n\n    composed: Agent[str, bool] = f &gt;&gt; g\n\n    # Type checker should accept this\n    result: bool = await composed.invoke(\"42\")\n    assert isinstance(result, bool)\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#6-practical-composability","title":"6. Practical Composability","text":"<ul> <li> Works with standard combinators - maybe(), either(), parallel(), etc.</li> <li> Integrates with Fix - Can be used in fixed-point iteration</li> <li> Compatible with Judge - Can be evaluated against principles</li> <li> Serializable if needed - State can be saved/restored for stateful agents</li> </ul> <pre><code># Example combinator compatibility test\nasync def test_maybe_combinator():\n    agent = MyAgent()\n    maybe_agent = maybe(agent)\n\n    # Should handle None gracefully\n    result = await maybe_agent.invoke(None)\n    assert result is None\n\n    # Should pass through valid input\n    result = await maybe_agent.invoke(valid_input)\n    assert result == expected_output\n</code></pre>"},{"location":"_archive/BOOTSTRAP_PROMPT/#verification-anti-patterns","title":"Verification Anti-Patterns","text":"<p>\u274c Don't: - Skip type annotations (\"will add later\") - Test only happy path (ignore error cases) - Assume single-threaded usage without documenting it - Mix stateful and stateless behavior without clear boundaries - Optimize before verifying correctness</p> <p>\u2705 Do: - Write composition law tests first - Document state assumptions explicitly - Test edge cases and error propagation - Verify type safety with mypy --strict - Use agents to verify agents (Judge, Contradict)</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#implementation-progress-template","title":"Implementation Progress Template","text":"<p>Use this checklist to track progress when implementing kgents from spec. Copy this to <code>PROGRESS.md</code> and check off items as you complete them.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#phase-0-foundation","title":"Phase 0: Foundation","text":"<p>Goal: Set up environment and understand specs</p> <ul> <li> Environment Setup</li> <li> Clone/fork kgents repository</li> <li> Set up Python \u22653.11 virtual environment</li> <li> Install dependencies: <code>pip install -e .</code></li> <li> Verify mypy installed: <code>mypy --version</code></li> <li> <p> Set up IDE with type checking</p> </li> <li> <p> Read Specifications (in order)</p> </li> <li> <code>spec/principles.md</code> - 7 core principles</li> <li> <code>spec/bootstrap.md</code> - 7 irreducible agents</li> <li> <code>spec/anatomy.md</code> - What constitutes an agent</li> <li> <code>spec/c-gents/composition.md</code> - How agents compose</li> <li> <code>AUTONOMOUS_BOOTSTRAP_PROTOCOL.md</code> - Meta-level protocol</li> <li> <p> <code>docs/BOOTSTRAP_PROMPT.md</code> - This document</p> </li> <li> <p> Initialize Runtime (Step 0, before ANY code)</p> </li> <li> Set up ClaudeCLIRuntime or ClaudeRuntime</li> <li> Test basic agent invocation (try kgent or creativity_coach)</li> <li> Verify LLM access working</li> </ul> <p>Autopoiesis checkpoint: Did I use agents to plan the implementation approach? (CreativityCoach, HypothesisEngine)</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#phase-1-foundation-types-and-base-classes","title":"Phase 1: Foundation - Types and Base Classes","text":"<p>Goal: Implement <code>types.py</code> with Agent[A, B] base class and composition operators</p> <p>Files to create/modify: - [ ] <code>impl/claude/bootstrap/types.py</code></p> <p>Tasks: - [ ] Define <code>Agent[A, B]</code> abstract base class with <code>invoke</code> method - [ ] Implement <code>__rshift__</code> composition operator (<code>&gt;&gt;</code>) - [ ] Define <code>ComposedAgent[A, B, C]</code> for sequential composition - [ ] Add <code>Result[T, E]</code> types (Ok, Err) for error handling - [ ] Write module docstring with type signatures - [ ] Add comprehensive type annotations</p> <p>Validation: - [ ] <code>mypy --strict types.py</code> passes with zero errors - [ ] Manual review: Can compose agents with <code>f &gt;&gt; g</code> syntax? - [ ] Test: <code>Id &gt;&gt; SomeAgent</code> should equal <code>SomeAgent</code> (type level)</p> <p>Autopoiesis checkpoint: - [ ] Used K-gent for naming decisions? - [ ] Used CreativityCoach to explore API design? - [ ] Used Judge to review against principles?</p> <p>Dependencies: None (foundational)</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#phase-2-level-1-agents-id-and-ground","title":"Phase 2: Level 1 Agents - Id and Ground","text":"<p>Goal: Implement simplest agents with no dependencies</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#21-id-agent","title":"2.1 Id Agent","text":"<p>Files: - [ ] <code>impl/claude/bootstrap/id.py</code></p> <p>Tasks: - [ ] Read spec: <code>spec/bootstrap.md</code> (Id section) - [ ] Use agent template from docs/BOOTSTRAP_PROMPT.md - [ ] Implement <code>Id(Agent[A, A])</code> class - [ ] Optimize <code>__rshift__</code>: <code>Id &gt;&gt; f</code> should return <code>f</code> - [ ] Write tests: identity laws, composition laws</p> <p>Validation: - [ ] <code>mypy --strict id.py</code> passes - [ ] Tests pass (associativity, left/right identity) - [ ] Judge verdict: ACCEPT - [ ] Contradict(spec, impl): None</p> <p>Autopoiesis: Used agents to implement? (K-gent for naming, Judge for review)</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#22-ground-agent","title":"2.2 Ground Agent","text":"<p>Files: - [ ] <code>impl/claude/bootstrap/ground.py</code> - [ ] Optional: <code>impl/claude/bootstrap/ground_parser.py</code> (GroundParser agent)</p> <p>Tasks: - [ ] Read spec: <code>spec/bootstrap.md</code> (Ground section) - [ ] Implement <code>Ground(Agent[Void, Facts])</code> or specific variant - [ ] Load persona from <code>spec/k-gent/persona.md</code> - [ ] Parse markdown \u2192 PersonaSeed structure - [ ] Consider: Use LLM-based GroundParser for flexibility (see Phase 5.3)</p> <p>Validation: - [ ] Can load persona.md successfully - [ ] PersonaSeed structure complete (name, values, heuristics, etc.) - [ ] Judge verdict: ACCEPT - [ ] Ground checklist complete (see PROTOCOL)</p> <p>Autopoiesis: Used GroundParser agent (meta!)</p> <p>Dependencies: types.py</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#phase-3-level-2-agents-compose-and-contradict","title":"Phase 3: Level 2 Agents - Compose and Contradict","text":"<p>Goal: Implement agents that build on Level 1</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#31-compose-agent","title":"3.1 Compose Agent","text":"<p>Files: - [ ] <code>impl/claude/bootstrap/compose.py</code></p> <p>Tasks: - [ ] Read spec: <code>spec/bootstrap.md</code> (Compose section) - [ ] Implement <code>Compose(Agent[(Agent, Agent), Agent])</code> - [ ] Verify composition laws (associativity) - [ ] Ensure types propagate correctly: <code>Agent[A,B] &gt;&gt; Agent[B,C] \u2192 Agent[A,C]</code> - [ ] Handle edge cases (Id composition, error propagation)</p> <p>Validation: - [ ] Composition laws hold (associativity tests) - [ ] Type safety verified with mypy - [ ] Judge: ACCEPT</p> <p>Dependencies: types.py, id.py</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#32-contradict-agent","title":"3.2 Contradict Agent","text":"<p>Files: - [ ] <code>impl/claude/bootstrap/contradict.py</code></p> <p>Tasks: - [ ] Read spec: <code>spec/bootstrap.md</code> (Contradict section) - [ ] Implement <code>Contradict(Agent[(A, B), Tension | None])</code> - [ ] Define Tension types (LOGICAL, PRAGMATIC, AESTHETIC) - [ ] Implement TensionDetector protocol for extensibility - [ ] Add 2-3 basic detectors (semantic, structural)</p> <p>Validation: - [ ] Detects obvious contradictions (tests with known conflicts) - [ ] Returns None when no tension (tests with aligned pairs) - [ ] Judge: ACCEPT - [ ] TensionDetector extensible (can add custom detectors)</p> <p>Dependencies: types.py</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#phase-4-level-3-agents-judge-and-sublate","title":"Phase 4: Level 3 Agents - Judge and Sublate","text":"<p>Goal: Implement evaluation and synthesis agents</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#41-judge-agent-seven-mini-judges-architecture","title":"4.1 Judge Agent (Seven Mini-Judges Architecture)","text":"<p>Files: - [ ] <code>impl/claude/bootstrap/judge.py</code> - [ ] Optionally split into: <code>judge_tasteful.py</code>, <code>judge_curated.py</code>, etc.</p> <p>Tasks: - [ ] Read spec: <code>spec/bootstrap.md</code> (Judge section) - [ ] Read principles: <code>spec/principles.md</code> (all 7) - [ ] Implement seven mini-judges (see BOOTSTRAP_PROMPT section on Judge)   - [ ] JudgeTasteful (compressed expertise)   - [ ] JudgeCurated (unique value)   - [ ] JudgeEthical (respects agency)   - [ ] JudgeJoyful (inspiring)   - [ ] JudgeComposable (works with others)   - [ ] JudgeGenerative (regenerable)   - [ ] JudgeHeterarchical (avoids hierarchy) - [ ] Compose via <code>&gt;&gt;</code>: <code>judge = tasteful &gt;&gt; curated &gt;&gt; ... &gt;&gt; heterarchical</code> - [ ] Aggregate PartialVerdicts \u2192 final Verdict (ACCEPT/REVISE/REJECT)</p> <p>Validation: - [ ] Test on Id agent: should ACCEPT - [ ] Test on bootstrap agents: all should ACCEPT or REVISE (not REJECT) - [ ] Test on deliberately bad code: should REVISE or REJECT - [ ] Each mini-judge independently testable - [ ] Judge itself passes Judge (meta!)</p> <p>Autopoiesis: Used agents to implement Judge? (self-referential)</p> <p>Dependencies: types.py, compose.py</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#42-sublate-agent","title":"4.2 Sublate Agent","text":"<p>Files: - [ ] <code>impl/claude/bootstrap/sublate.py</code></p> <p>Tasks: - [ ] Read spec: <code>spec/bootstrap.md</code> (Sublate section) - [ ] Implement <code>Sublate(Agent[Tension, Synthesis | HoldTension])</code> - [ ] Define Synthesis and HoldTension types - [ ] Implement synthesis logic (LLM-based or rule-based) - [ ] Add pattern: conscious holding when synthesis not yet possible</p> <p>Validation: - [ ] Can synthesize simple tensions (tests) - [ ] Can consciously hold unresolvable tensions - [ ] Judge: ACCEPT</p> <p>Dependencies: types.py, contradict.py (for Tension type)</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#phase-5-level-4-agent-fix","title":"Phase 5: Level 4 Agent - Fix","text":"<p>Goal: Implement fixed-point iteration</p> <p>Files: - [ ] <code>impl/claude/bootstrap/fix.py</code></p> <p>Tasks: - [ ] Read spec: <code>spec/bootstrap.md</code> (Fix section) - [ ] Implement <code>Fix(Agent[(A \u2192 A), A])</code> - [ ] Add convergence detection via <code>equality_check</code> - [ ] Add max_iterations safety limit - [ ] Implement stateful Fix pattern (memory between iterations) - [ ] Add convenience function: <code>fix(transform, initial, equality_check)</code></p> <p>Validation: - [ ] Converges for simple cases (tests) - [ ] Respects max_iterations limit - [ ] Accumulates state correctly (see PROTOCOL Pitfall 3) - [ ] Judge: ACCEPT</p> <p>Dependencies: types.py, compose.py</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#phase-6-verification-and-validation","title":"Phase 6: Verification and Validation","text":"<p>Goal: Ensure all agents work correctly, compose properly, and pass Judge</p> <p>Tasks: - [ ] Type checking: <code>mypy --strict impl/claude/bootstrap/</code> (zero errors) - [ ] Unit tests: Write pytest suite for each agent   - [ ] Test composition laws (associativity, identity)   - [ ] Test type safety (inputs/outputs match signatures)   - [ ] Test error propagation   - [ ] Test state isolation (concurrent invocations) - [ ] Integration tests: Compose multiple agents, verify pipelines work - [ ] Judge all agents: Each bootstrap agent should pass Judge - [ ] Contradict check: Compare impl to spec, should find no tensions - [ ] Autopoiesis review: Calculate % agent usage, document narrative</p> <p>Validation checklist (from Verification section above): - [ ] All composition law tests pass - [ ] Type safety verified - [ ] Error propagation works - [ ] State isolation maintained - [ ] Judge verdict: ACCEPT for all bootstrap agents - [ ] Contradict(spec, impl) returns None for each agent - [ ] Autopoiesis &gt;50% (or qualitative: \"felt agent-driven\")</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#phase-7-regeneration-test-behavior-equivalence","title":"Phase 7: Regeneration Test (Behavior Equivalence)","text":"<p>Goal: Validate that documents are sufficient by regenerating bootstrap</p> <p>Tasks: - [ ] Backup current implementation: <code>cp -r bootstrap/ bootstrap.backup/</code> - [ ] Delete implementation: <code>rm -rf bootstrap/*.py</code> (keep types.py) - [ ] Regenerate from spec: Follow BOOTSTRAP_PROMPT.md from scratch - [ ] Compare behavior:   - [ ] Run tests on regenerated code (should pass)   - [ ] Compare outputs for same inputs (should match)   - [ ] Run Contradict(original, regenerated) (no critical tensions)   - [ ] Qualitative check: \"Does this feel like the same agent?\" - [ ] Document differences: Style, variable names, comments OK; behavior must match</p> <p>Success criteria (from improvement plan Decision 4): - [ ] Tests pass on regenerated code - [ ] Behavior equivalence: same inputs \u2192 same outputs - [ ] No major tensions from Contradict - [ ] Vibes check: \"Feels right\" (qualitative) - [ ] Style differences acceptable (formatting, names, comments)</p> <p>NOT required: - Character-exact match (too brittle) - Identical implementation approach (allow creativity)</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#phase-8-documentation-and-finalization","title":"Phase 8: Documentation and Finalization","text":"<p>Goal: Complete documentation, examples, and final polish</p> <p>Tasks: - [ ] Write examples: <code>examples/</code> directory with usage examples - [ ] Update HYDRATE.md: Document completion, any learnings - [ ] Write IMPLEMENTATION_PLAN retrospective: What worked, what didn't - [ ] Autopoiesis report: Final narrative of agent usage throughout - [ ] Commit with protocol-compliant message:   <pre><code>git commit -m \"feat: Complete bootstrap agents implementation\n\nAll 7 bootstrap agents implemented and validated.\nAutopoiesis: [X]% (K-gent [N]x, CreativityCoach [N]x, Judge [N]x, etc.)\nJudge: All agents ACCEPT\nContradict: Zero tensions\nTests: 100% pass rate\nRegeneration: Behavior equivalence verified\"\n</code></pre></p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#progress-tracking-tips","title":"Progress Tracking Tips","text":""},{"location":"_archive/BOOTSTRAP_PROMPT/#daily-checklist","title":"Daily Checklist","text":"<p>At start of each session: 1. [ ] Review PROGRESS.md, identify next phase 2. [ ] Initialize ProtocolObserver (if using observability) 3. [ ] Invoke agents for design decisions (Step 0)</p> <p>During session: 4. [ ] Check off tasks as completed 5. [ ] Log agent usage (for autopoiesis narrative) 6. [ ] Document tensions/decisions</p> <p>At end of session: 7. [ ] Update PROGRESS.md with current state 8. [ ] Generate autopoiesis narrative 9. [ ] Commit work with descriptive message</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#measuring-progress","title":"Measuring Progress","text":"<p>Quantitative: - Files completed / Total files - Tests passing / Total tests - Judge ACCEPT rate</p> <p>Qualitative: - Does code reflect principles? - Is autopoiesis &gt;50% (or \"felt agent-driven\")? - Would I be proud to show this code?</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#when-stuck","title":"When Stuck","text":"<ol> <li>Consult Troubleshooting section (below)</li> <li>Use K-gent (REFLECT mode) to explore problem</li> <li>Use HypothesisEngine to generate approaches</li> <li>Review AUTONOMOUS_BOOTSTRAP_PROTOCOL.md for guidance</li> <li>Check HYDRATE.md for recent relevant changes</li> </ol>"},{"location":"_archive/BOOTSTRAP_PROMPT/#troubleshooting-common-errors","title":"Troubleshooting Common Errors","text":"<p>This section addresses common errors encountered during kgents implementation and provides actionable fixes.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#error-1-type-errors-type-is-not-subscriptable","title":"Error 1: Type Errors - \"Type is not subscriptable\"","text":"<p>Symptom: <pre><code>TypeError: 'type' object is not subscriptable\nAgent[A, B]\n</code></pre></p> <p>Cause: Using generic types without importing from <code>typing</code> or using Python &lt;3.9 syntax.</p> <p>Fix: <pre><code># WRONG (Python &lt;3.9)\nclass MyAgent(Agent[str, int]):  # Error if Agent not properly imported\n    ...\n\n# RIGHT\nfrom typing import TypeVar\nfrom bootstrap.types import Agent\n\nA = TypeVar(\"A\")\nB = TypeVar(\"B\")\n\nclass MyAgent(Agent[A, B]):  # Generic\n    ...\n\n# Or for concrete types\nclass StrToIntAgent(Agent[str, int]):  # Requires proper Agent base\n    ...\n</code></pre></p> <p>Prevention: Always import <code>TypeVar</code> and define type variables at module level.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#error-2-module-import-issues-no-module-named-bootstrap","title":"Error 2: Module Import Issues - \"No module named bootstrap\"","text":"<p>Symptom: <pre><code>ModuleNotFoundError: No module named 'bootstrap'\n</code></pre></p> <p>Cause: Package structure not set up correctly, or running from wrong directory.</p> <p>Fix: <pre><code># Check pyproject.toml exists and has correct structure\ncat pyproject.toml  # Should have [project] with dependencies\n\n# Install in development mode\npip install -e .\n\n# Or ensure you're running from correct directory\ncd impl/claude/\npython -m pytest  # Use module syntax\n</code></pre></p> <p>Prevention: Use proper Python packaging from the start. No <code>sys.path</code> hacks.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#error-3-contradict-false-negatives-should-detect-tension-but-doesnt","title":"Error 3: Contradict False Negatives - \"Should detect tension but doesn't\"","text":"<p>Symptom: <code>Contradict(a, b)</code> returns <code>None</code> when there's an obvious conflict.</p> <p>Cause: Contradict implementation not comprehensive, or conflict is subtle/requires domain knowledge.</p> <p>Example: <pre><code># Spec says: \"Agent must be stateless\"\n# Impl has: self.cache = {}  # State!\n# But Contradict returns None\u2014missed it\n</code></pre></p> <p>Fix: 1. Extend TensionDetector: Add domain-specific detectors 2. Be explicit in specs: State requirements clearly 3. Use Judge as backup: Judge can catch what Contradict misses</p> <pre><code># Add custom tension detector\nclass StatefulnessDetector(TensionDetector):\n    def detect(self, spec: str, impl: str) -&gt; Optional[Tension]:\n        if \"stateless\" in spec.lower() and \"self.\" in impl:\n            # Check for instance variables (crude heuristic)\n            return Tension(\n                type=TensionType.PRAGMATIC,\n                description=\"Spec requires stateless, impl has instance state\",\n                ...\n            )\n        return None\n</code></pre> <p>Prevention: Write explicit specs. Use both Contradict AND Judge.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#error-4-fix-non-convergence-fix-loops-forever","title":"Error 4: Fix Non-Convergence - \"Fix loops forever\"","text":"<p>Symptom: <code>fix()</code> runs indefinitely without reaching fixed point.</p> <p>Cause: 1. <code>equality_check</code> never returns True 2. Transform function doesn't converge 3. No state accumulation (see Pitfall 3 in PROTOCOL)</p> <p>Fix: <pre><code># Add max iterations and debugging\nresult = await fix(\n    transform=my_transform,\n    initial=initial_state,\n    equality_check=lambda prev, curr: prev == curr,\n    max_iterations=100,  # Safety limit\n)\n\n# Debug: Log iterations\nasync def debug_transform(state):\n    print(f\"Iteration: {state}\")\n    return await my_transform(state)\n\nresult = await fix(transform=debug_transform, ...)\n</code></pre></p> <p>Prevention: - Always accumulate state/confidence in transform - Test equality_check separately - Add max_iterations safety limit - Use Fix with memory pattern (see PROTOCOL Pitfall 3)</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#error-5-low-autopoiesis-score-20","title":"Error 5: Low Autopoiesis Score (&lt;20%)","text":"<p>Symptom: Implementation complete but hardly any agent usage.</p> <p>Cause: Forgot to use agents during development, or used them only at beginning.</p> <p>Fix: 1. Retrospectively document: \"Where COULD I have used agents?\" 2. Refactor naming: Use K-gent to rename poorly-named things 3. Use Judge to review: Let Judge suggest improvements 4. For next feature: Set reminder to invoke agents continuously</p> <p>Pattern for sustained autopoiesis: <pre><code># Checkpoint throughout development\nasync def feature_implementation():\n    # Phase 1: Design (use CreativityCoach)\n    design = await runtime.execute(creativity_coach(), ...)\n\n    # Phase 2: Naming (use K-gent)\n    name = await runtime.execute(kgent(), ...)\n\n    # Phase 3: Implementation (manual, guided by design)\n    code = implement_from_design(design)\n\n    # Phase 4: Review (use Judge)\n    verdict = await judge.invoke(JudgeInput(agent=code, ...))\n\n    # Phase 5: Check consistency (use Contradict)\n    tension = await contradict.invoke((spec, code))\n\n    # Now autopoiesis is high (used agents at 4/5 phases)\n</code></pre></p> <p>Prevention: Use agents FIRST (see Step 0 in this doc), not just once at start.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#error-6-missing-type-annotations","title":"Error 6: Missing Type Annotations","text":"<p>Symptom: <code>mypy</code> reports errors, or runtime type checking fails.</p> <p>Cause: Skipped type annotations, or used <code>Any</code> too liberally.</p> <p>Fix: <pre><code># WRONG: No annotations\ndef process(input):  # What type?\n    return transform(input)  # What does this return?\n\n# RIGHT: Full annotations\ndef process(input: InputType) -&gt; OutputType:\n    result: OutputType = transform(input)\n    return result\n\n# For generics\nA = TypeVar(\"A\")\nB = TypeVar(\"B\")\n\nclass MyAgent(Agent[A, B]):\n    async def invoke(self, input: A) -&gt; B:\n        ...\n</code></pre></p> <p>Prevention: Use <code>mypy --strict</code> from the start. Fix warnings incrementally.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#error-7-composition-type-mismatches","title":"Error 7: Composition Type Mismatches","text":"<p>Symptom: <pre><code>TypeError: Cannot compose Agent[A, B] with Agent[C, D] (B != C)\n</code></pre></p> <p>Cause: Output type of first agent doesn't match input type of second.</p> <p>Example: <pre><code># WRONG: Type mismatch\nagent1: Agent[str, int] = StrToInt()\nagent2: Agent[str, bool] = StrToBool()  # Expects str, not int\n\npipeline = agent1 &gt;&gt; agent2  # Error: int -&gt; str mismatch\n</code></pre></p> <p>Fix: Use adapters or check types manually.</p> <pre><code># Option 1: Add adapter\nint_to_str = IntToStr()\npipeline = agent1 &gt;&gt; int_to_str &gt;&gt; agent2  # str -&gt; int -&gt; str -&gt; bool\n\n# Option 2: Use correct types from start\nagent2b: Agent[int, bool] = IntToBool()\npipeline = agent1 &gt;&gt; agent2b  # str -&gt; int -&gt; bool \u2713\n</code></pre> <p>Prevention: Write out type signatures before implementing. Verify B_1 == A_2 for <code>f: Agent[A, B_1]</code> and <code>g: Agent[A_2, C]</code>.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#error-8-asyncawait-mistakes","title":"Error 8: Async/Await Mistakes","text":"<p>Symptom: <pre><code>RuntimeWarning: coroutine was never awaited\n</code></pre></p> <p>Cause: Forgot <code>await</code> on async function call.</p> <p>Fix: <pre><code># WRONG: Missing await\nresult = agent.invoke(input)  # Returns coroutine, not result\n\n# RIGHT: Await the coroutine\nresult = await agent.invoke(input)\n\n# For parallel execution\nresults = await asyncio.gather(\n    agent1.invoke(input1),\n    agent2.invoke(input2),\n)\n</code></pre></p> <p>Prevention: All <code>Agent.invoke()</code> calls are async and require <code>await</code>.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#error-9-ground-extraction-failures","title":"Error 9: Ground Extraction Failures","text":"<p>Symptom: <code>Ground</code> agent can't parse persona.md or returns incomplete data.</p> <p>Cause: persona.md format doesn't match expected structure, or parser is too rigid.</p> <p>Fix: <pre><code># Option 1: Use GroundParser agent (recommended, see Phase 5.3)\nparser = GroundParser()\npersona_seed = await parser.invoke(persona_md_content)\n\n# Option 2: Improve parser robustness\n# Make parser handle variations in markdown format\n# Use LLM-based extraction for flexibility\n</code></pre></p> <p>Prevention: Keep persona.md format consistent. Use agent-based parsing (GroundParser) for flexibility.</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#error-10-judge-rejects-everything","title":"Error 10: Judge Rejects Everything","text":"<p>Symptom: Judge always returns REJECT, even for reasonable code.</p> <p>Cause: Overly strict principles, or Judge implementation has bugs.</p> <p>Fix: 1. Check Judge implementation: Verify seven mini-judges logic 2. Review principles: Are they realistic? (See <code>spec/principles.md</code>) 3. Use REVISE mode: Judge should suggest improvements, not just reject 4. Incremental validation: Test Judge on known-good agents first</p> <pre><code># Debug Judge by testing on Id (should ACCEPT)\nverdict = await judge.invoke(JudgeInput(\n    agent_spec=id_agent_code,\n    principles=PRINCIPLES\n))\nassert verdict.type == VerdictType.ACCEPT  # Id should always pass\n\n# If this fails, Judge is too strict or buggy\n</code></pre> <p>Prevention: Validate Judge against bootstrap agents first (they should all ACCEPT).</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#troubleshooting-checklist","title":"Troubleshooting Checklist","text":"<p>When stuck:</p> <ol> <li>Check types first - Most errors are type mismatches (use <code>mypy --strict</code>)</li> <li>Verify imports - Ensure proper package structure (no <code>sys.path</code> hacks)</li> <li>Test components in isolation - Before composing, verify each agent works alone</li> <li>Use agents to debug - K-gent (REFLECT mode) can help identify issues</li> <li>Check Ground - Are environmental assumptions explicit?</li> <li>Read error messages carefully - Python tracebacks point to exact line</li> <li>Consult HYDRATE.md - Recent changes and known issues documented there</li> </ol>"},{"location":"_archive/BOOTSTRAP_PROMPT/#getting-help","title":"Getting Help","text":"<p>If errors persist: 1. Check <code>HYDRATE.md</code> for recent changes that might affect your code 2. Review <code>AUTONOMOUS_BOOTSTRAP_PROTOCOL.md</code> \"Common Pitfalls\" section 3. Use Contradict to compare your impl with spec 4. Use Judge to get specific feedback on what's wrong 5. Use K-gent (REFLECT mode) to explore the problem space</p>"},{"location":"_archive/BOOTSTRAP_PROMPT/#quick-start","title":"Quick Start","text":"<pre><code>claude \"Read docs/BOOTSTRAP_PROMPT.md. I want to implement {X}. Start with CreativityCoach.\"\n</code></pre> <p>Use kgents agents to HELP you implement\u2014that's autopoiesis.</p>"},{"location":"_archive/a-gents-architecture-review/","title":"A-gents Universal Architecture: Critical Review","text":"<p>\"The unexamined architecture is not worth building.\"</p>"},{"location":"_archive/a-gents-architecture-review/#executive-summary","title":"Executive Summary","text":"<p>The Universal Agent Architecture proposal contains a powerful insight: infrastructure is a function of logic. The vision of any agent becoming \"batteries included\" through functorial lifting is aesthetically compelling and category-theoretically attractive.</p> <p>However, the proposal has three fundamental weaknesses:</p> <ol> <li> <p>The God Class Trap: The <code>UniversalAgent</code> base class with <code>.as_stateful</code>, <code>.as_deployable</code>, etc. reintroduces inheritance coupling. If <code>UniversalAgent</code> knows about K8s, then core logic is coupled to infrastructure\u2014a direct violation of the Tasteful principle.</p> </li> <li> <p>Functor Law Violations: Several proposed functors (especially K8) don't preserve composition in the strict categorical sense. Deploying <code>f &gt;&gt; g</code> to K8s doesn't produce the same result as deploying <code>f</code> and <code>g</code> separately\u2014network boundaries, service discovery, and resource allocation introduce non-compositional concerns.</p> </li> <li> <p>Projection vs. Decoration Conflation: K8 deployment isn't wrapping\u2014it's compilation into a different target category (Topos). Treating it as \"just another functor\" creates a category error that will manifest as leaky abstractions in practice.</p> </li> </ol> <p>Recommendation: Refine the architecture using the Alethic Architecture pattern\u2014separate the pure Nucleus (logic) from the declarative Halo (capabilities) and implement target-specific Projectors (compilers). This preserves the \"batteries included\" vision while maintaining categorical rigor and principle alignment.</p>"},{"location":"_archive/a-gents-architecture-review/#theoretical-analysis","title":"Theoretical Analysis","text":""},{"location":"_archive/a-gents-architecture-review/#functor-law-verification","title":"Functor Law Verification","text":"<p>For each functor to be valid, it must satisfy: - Identity preservation: <code>F(Id) \u2261 Id</code> - Composition preservation: <code>F(f &gt;&gt; g) \u2261 F(f) &gt;&gt; F(g)</code></p>"},{"location":"_archive/a-gents-architecture-review/#d-functor-persistence","title":"D-Functor (Persistence)","text":"<pre><code>D: Agent[A, B] \u2192 Agent[A, B] with State[S]\n</code></pre> <p>Assessment: \u2705 Sound</p> <p>The D-functor (Symbiont pattern) is well-implemented in <code>impl/claude/agents/d/symbiont.py</code>. It threads state transparently: - Identity preservation: <code>D(Id)</code> with empty state is identity - Composition: <code>D(f &gt;&gt; g)</code> correctly threads state through both agents</p> <p>The existing Symbiont pattern demonstrates this works. The functor laws hold because state threading is orthogonal to the computation.</p> <p>Edge Case: What happens when composing D-lifted agents with different state schemas? The current Symbiont doesn't address this\u2014each agent manages its own state namespace, which is pragmatic but breaks strict composition.</p>"},{"location":"_archive/a-gents-architecture-review/#k-functor-personality","title":"K-Functor (Personality)","text":"<pre><code>K: Agent[A, B] \u2192 Agent[A, B] in PersonalitySpace\n</code></pre> <p>Assessment: \u26a0\ufe0f Partially Sound</p> <p>The claim <code>K \u2022 K \u2261 K</code> (idempotence) is only true if personality coordinates are identical. In practice: - <code>K.lift(K.lift(agent, persona=A), persona=B)</code> \u2260 <code>K.lift(agent, persona=B)</code> - The outer K doesn't \"override\"\u2014it composes personality contexts</p> <p>The current <code>impl/claude/agents/k/persona.py</code> implementation works, but the functor claim is aspirational rather than verified.</p> <p>Recommendation: Define K as a pointed functor with explicit coordinate blending rules, or acknowledge it's a lax functor.</p>"},{"location":"_archive/a-gents-architecture-review/#mirror-functor-observability","title":"Mirror-Functor (Observability)","text":"<pre><code>Mirror: Agent[A, B] \u2192 Agent[A, B] with Observation\n</code></pre> <p>Assessment: \u2705 Sound</p> <p>Mirror is genuinely transparent\u2014it doesn't change semantics, only adds visibility. The functor laws trivially hold because observation is pure side-effect (doesn't affect the morphism).</p> <p>Verified by: FluxAgent's <code>attach_mirror()</code> implementation, which correctly treats Mirror as fire-and-forget observation.</p>"},{"location":"_archive/a-gents-architecture-review/#k8-functor-deployment","title":"K8-Functor (Deployment)","text":"<pre><code>K8: Agent[A, B] \u2192 Deployable[Agent[A, B]]\n</code></pre> <p>Assessment: \u274c Unsound as Stated</p> <p>The critical claim\u2014<code>K8(f &gt;&gt; g) \u2261 K8(f) &gt;&gt; K8(g)</code>\u2014fails because:</p> <ol> <li>Network boundaries: When <code>f &gt;&gt; g</code> deploys as separate services, the composition must go through network calls. The semantics change:</li> <li>Latency is introduced</li> <li>Failures can occur between stages</li> <li> <p>The composition is no longer atomic</p> </li> <li> <p>Resource allocation: <code>K8(f)</code> and <code>K8(g)</code> deployed separately have different resource characteristics than <code>K8(f &gt;&gt; g)</code> deployed as a monolith:</p> </li> <li>Different scaling policies</li> <li>Different failure domains</li> <li> <p>Different memory/CPU allocations</p> </li> <li> <p>Service discovery: The \"composition\" in K8s isn't morphism composition\u2014it's service mesh routing. These are categorically different:</p> </li> <li>Morphism: <code>f &gt;&gt; g</code> is a single arrow</li> <li>K8s: Service A \u2192 Network \u2192 Service B is a span, not an arrow</li> </ol> <p>The Category Error: K8 doesn't map agents to agents-in-K8s. It maps agents to K8s resources (Deployments, Services, ConfigMaps). The target category is different.</p> <p>Correct Formulation: K8 is a functor between categories: <pre><code>K8: Agent \u2192 K8Resource\n</code></pre> Where <code>K8Resource</code> has its own composition rules (service mesh routing, not function composition).</p>"},{"location":"_archive/a-gents-architecture-review/#flux-functor-streaming","title":"Flux-Functor (Streaming)","text":"<pre><code>Flux: Agent[A, B] \u2192 Agent[AsyncIterator[A], AsyncIterator[B]]\n</code></pre> <p>Assessment: \u2705 Sound</p> <p>The existing <code>impl/claude/agents/flux/agent.py</code> correctly implements the functor laws: - <code>Flux(Id)</code> yields each element unchanged - <code>Flux(f &gt;&gt; g)</code> is equivalent to <code>Flux(f) | Flux(g)</code> (verified by Living Pipelines)</p> <p>The Flux implementation is the model for how functors should work in kgents.</p>"},{"location":"_archive/a-gents-architecture-review/#natural-transformation-coherence","title":"Natural Transformation Coherence","text":"<p>Key Question: Does <code>D.lift(K.lift(agent))</code> equal <code>K.lift(D.lift(agent))</code>?</p> <p>Analysis: No, and this is acceptable.</p> <p>The proposal implicitly assumes functor composition commutes. It doesn't:</p> <ol> <li>D then K: Agent gets state, then personality applies to stateful agent</li> <li>K then D: Agent gets personality, then state threads through personalized agent</li> </ol> <p>These are semantically different: - D(K(agent)): The K-personality influences how state is managed - K(D(agent)): The D-state is transparent to personality</p> <p>Recommendation: Make non-commutativity explicit. Define canonical orderings for functor stacks, or acknowledge that different orderings produce different agents (which is fine\u2014just not \"transparent\").</p>"},{"location":"_archive/a-gents-architecture-review/#category-theoretic-soundness","title":"Category-Theoretic Soundness","text":"<p>Overall Assessment: 3/5 functors are sound; 2/5 need refinement.</p> Functor Status Issue D \u2705 Sound Works as stated K \u26a0\ufe0f Partial Idempotence claim too strong Mirror \u2705 Sound Genuinely transparent K8 \u274c Unsound Wrong target category Flux \u2705 Sound Well-implemented <p>The architecture is category-theoretically motivated but not category-theoretically rigorous. This isn't fatal\u2014pragmatism matters\u2014but the claims should match reality.</p>"},{"location":"_archive/a-gents-architecture-review/#practical-analysis","title":"Practical Analysis","text":""},{"location":"_archive/a-gents-architecture-review/#developer-experience","title":"Developer Experience","text":"<p>Learning Curve: Moderate to steep.</p> <p>Developers must understand: 1. What \"lifting\" means 2. How functors compose 3. When to lift vs. configure directly 4. The semantic implications of lift order</p> <p>Positive UX Elements: - <code>agent.as_stateful</code> is discoverable (IDE autocomplete) - Lazy lifting means no penalty for unused capabilities - <code>flux_a | flux_b</code> is intuitive for streaming</p> <p>Negative UX Elements: - Debugging a stack like <code>K8.lift(Mirror.lift(D.lift(K.lift(agent))))</code> is hard - Error messages will reference wrapped types, not the original agent - The \"automagic\" aspect hides what's actually happening</p> <p>Recommendation: Provide explicit <code>explain()</code> methods that print the functor stack and its implications.</p>"},{"location":"_archive/a-gents-architecture-review/#edge-cases-and-failure-modes","title":"Edge Cases and Failure Modes","text":""},{"location":"_archive/a-gents-architecture-review/#edge-case-1-stateful-streaming-k8s","title":"Edge Case 1: Stateful + Streaming + K8s","text":"<pre><code># What happens here?\ndeployed = K8.lift(Flux.lift(D.lift(agent)))\n</code></pre> <p>Questions: - Where does D-gent state live? (K8s PVC? StatefulSet?) - How does Flux streaming work across K8s pods? - Is state replicated or partitioned?</p> <p>The proposal doesn't address these interactions. In practice, this will require extensive configuration that undermines \"zero-config cross-integration.\"</p>"},{"location":"_archive/a-gents-architecture-review/#edge-case-2-functor-ordering-sensitivity","title":"Edge Case 2: Functor Ordering Sensitivity","text":"<pre><code># Are these equivalent?\na = D.lift(K.lift(agent))\nb = K.lift(D.lift(agent))\n</code></pre> <p>They're not, but the proposal implies they should be. When <code>a != b</code>, developers will be confused.</p>"},{"location":"_archive/a-gents-architecture-review/#edge-case-3-error-propagation","title":"Edge Case 3: Error Propagation","text":"<p>When an error occurs deep in a functor stack: <pre><code>result = await K8.lift(Mirror.lift(D.lift(agent))).invoke(input)\n# Error: \"FluxStateError in MirroredAgent wrapping SymbiontAgent\"\n</code></pre></p> <p>The error message reveals implementation details that should be hidden.</p>"},{"location":"_archive/a-gents-architecture-review/#performance-implications","title":"Performance Implications","text":"<p>The \"Lazy\" Claim: The proposal states \"zero overhead for unused capabilities.\"</p> <p>Reality Check: - Runtime overhead: Minimal (lazy imports work) - Memory overhead: Each lift creates wrapper objects - Cognitive overhead: Significant (developer must understand the stack)</p> <p>Hidden Costs: 1. Import-time decisions: Lazy imports defer cost, don't eliminate it 2. Type checking: Mypy must resolve all potential lifts 3. Stack traces: Deep nesting makes debugging harder</p>"},{"location":"_archive/a-gents-architecture-review/#principle-alignment","title":"Principle Alignment","text":""},{"location":"_archive/a-gents-architecture-review/#1-tasteful","title":"1. Tasteful","text":"<p>Each agent serves a clear, justified purpose.</p> <p>Assessment: \u26a0\ufe0f Partial Violation</p> <p>The <code>UniversalAgent</code> base class is a kitchen-sink by design. It knows about D, K, Mirror, K8, and Flux. This violates \"say no more than yes\" and \"avoid feature creep.\"</p> <p>Specific Violation: The base class pattern forces awareness of all possible integrations, even if they're lazy.</p>"},{"location":"_archive/a-gents-architecture-review/#2-curated","title":"2. Curated","text":"<p>Intentional selection over exhaustive cataloging.</p> <p>Assessment: \u2705 Aligned</p> <p>Five functors is a curated set. The proposal doesn't enumerate every possible integration.</p>"},{"location":"_archive/a-gents-architecture-review/#3-ethical","title":"3. Ethical","text":"<p>Agents augment human capability, never replace judgment.</p> <p>Assessment: \u2705 Aligned</p> <p>No ethical concerns with the architecture itself.</p>"},{"location":"_archive/a-gents-architecture-review/#4-joy-inducing","title":"4. Joy-Inducing","text":"<p>Delight in interaction; personality matters.</p> <p>Assessment: \u26a0\ufe0f Mixed</p> <ul> <li>Positive: Living Pipelines (<code>flux_a | flux_b</code>) are delightful</li> <li>Negative: Debugging functor stacks is frustrating</li> </ul>"},{"location":"_archive/a-gents-architecture-review/#5-composable","title":"5. Composable","text":"<p>Agents are morphisms; composition is primary.</p> <p>Assessment: \u274c Violation</p> <p>The K8-functor breaks composition. The proposal claims <code>K8(f &gt;&gt; g) \u2261 K8(f) &gt;&gt; K8(g)</code> but this is false in practice.</p> <p>The Minimal Output Principle: Not directly violated, but the architecture doesn't enforce it either.</p>"},{"location":"_archive/a-gents-architecture-review/#6-heterarchical","title":"6. Heterarchical","text":"<p>Agents exist in flux, not fixed hierarchy.</p> <p>Assessment: \u2705 Aligned</p> <p>The functor approach doesn't impose hierarchy\u2014any agent can be lifted.</p>"},{"location":"_archive/a-gents-architecture-review/#7-generative","title":"7. Generative","text":"<p>Spec is compression; design should generate implementation.</p> <p>Assessment: \u26a0\ufe0f Partially Aligned</p> <p>The spec is compressive (five functors), but the implementation won't be regenerable from spec alone\u2014too many edge cases require explicit handling.</p>"},{"location":"_archive/a-gents-architecture-review/#meta-principle-accursed-share","title":"Meta-Principle: Accursed Share","text":"<p>We cherish slop and gratitude.</p> <p>Assessment: \u2705 Aligned</p> <p>The lazy lifting pattern allows \"useless\" capabilities to exist without cost.</p>"},{"location":"_archive/a-gents-architecture-review/#meta-principle-agentese-no-view-from-nowhere","title":"Meta-Principle: AGENTESE (No View From Nowhere)","text":"<p>To observe is to act.</p> <p>Assessment: \u26a0\ufe0f Needs Work</p> <p>The proposal doesn't connect functors to AGENTESE paths. How does <code>self.agent.lift.k8</code> work? How does observer context affect lifting?</p>"},{"location":"_archive/a-gents-architecture-review/#meta-principle-personality-space","title":"Meta-Principle: Personality Space","text":"<p>LLMs operate in personality-colored space.</p> <p>Assessment: \u2705 Aligned</p> <p>The K-functor explicitly navigates personality space.</p>"},{"location":"_archive/a-gents-architecture-review/#weaknesses-identified","title":"Weaknesses Identified","text":"<ol> <li> <p>God Class Anti-pattern: <code>UniversalAgent</code> base class couples core logic to all infrastructure concerns.</p> </li> <li> <p>K8-Functor Category Error: Treating K8s deployment as functor composition misrepresents its categorical nature.</p> </li> <li> <p>Non-commutative Functors Presented as Commutative: D\u2218K \u2260 K\u2218D but the proposal implies they're equivalent.</p> </li> <li> <p>Missing Edge Case Handling: Stateful + Streaming + K8s interactions undefined.</p> </li> <li> <p>Debugging Opacity: Deep functor stacks produce opaque error messages.</p> </li> <li> <p>AGENTESE Integration Missing: No specified paths for functor operations.</p> </li> <li> <p>Eager Base Class, Lazy Methods: The base class knows everything; laziness is at method level, not class level.</p> </li> <li> <p>Projection vs. Decoration Conflation: K8 is a compiler, not a decorator\u2014the metaphor leaks.</p> </li> <li> <p>Mode Parameter in K8-Functor: <code>mode=\"distributed\"|\"monolith\"</code> breaks the functor abstraction (functors are deterministic).</p> </li> <li> <p>Functor Ordering Not Canonicalized: No guidance on which order is \"correct.\"</p> </li> </ol>"},{"location":"_archive/a-gents-architecture-review/#alternative-approaches","title":"Alternative Approaches","text":""},{"location":"_archive/a-gents-architecture-review/#for-weakness-1-god-class-composition-over-inheritance","title":"For Weakness 1 (God Class): Composition over Inheritance","text":"<p>Instead of a base class, use protocol-based composition:</p> <pre><code># Instead of inheritance\nclass MyAgent(UniversalAgent[A, B]): ...\n\n# Use protocol composition\nclass MyAgent(Agent[A, B]): ...\n\n# Lifting is external, not inherited\nstateful = D.lift(MyAgent())\n</code></pre> <p>The agent Nucleus knows nothing of D, K, Mirror. Functors are external, applied at composition time.</p>"},{"location":"_archive/a-gents-architecture-review/#for-weakness-2-k8-category-error-projector-pattern","title":"For Weakness 2 (K8 Category Error): Projector Pattern","text":"<p>Rename K8-functor to K8-Projector and be explicit about the target category:</p> <pre><code># NOT: K8.lift(agent) \u2192 Agent in K8s\n# BUT: K8.project(agent) \u2192 K8sResources\n\n# The projector generates K8s manifests, not a wrapped agent\nmanifests = K8.project(agent)\n# Returns: [Deployment, Service, ConfigMap, ...]\n</code></pre> <p>This is honest about what K8 does\u2014it compiles agents into infrastructure artifacts.</p>"},{"location":"_archive/a-gents-architecture-review/#for-weakness-3-non-commutativity-canonical-ordering","title":"For Weakness 3 (Non-commutativity): Canonical Ordering","text":"<p>Define a canonical functor stack order:</p> <pre><code>Canonical: Agent \u2192 D \u2192 K \u2192 Mirror \u2192 Flux\n</code></pre> <p>And document why: 1. D (persistence) goes first\u2014state should be managed at the base 2. K (personality) applies to the stateful agent 3. Mirror (observation) wraps the personalized+stateful agent 4. Flux (streaming) is outermost\u2014the stream processes the full stack</p>"},{"location":"_archive/a-gents-architecture-review/#for-weakness-5-debugging-explain-methods","title":"For Weakness 5 (Debugging): Explain Methods","text":"<p>Add introspection:</p> <pre><code>@dataclass\nclass FunctorStack:\n    def explain(self) -&gt; str:\n        \"\"\"Print human-readable description of the stack.\"\"\"\n        return \"\"\"\n        FluxAgent wrapping\n          MirroredAgent wrapping\n            KgentAgent(persona=Kent) wrapping\n              Symbiont(memory=SQLite) wrapping\n                MyAgent(name=\"summarizer\")\n\n        State: D-gent manages SQLite at ~/.kgents/summarizer.db\n        Personality: Kent coordinates applied\n        Observability: Mirrored to ws://localhost:8765\n        Streaming: Flux with entropy_budget=10.0\n        \"\"\"\n</code></pre>"},{"location":"_archive/a-gents-architecture-review/#for-weakness-8-projection-metaphor-the-alethic-architecture","title":"For Weakness 8 (Projection Metaphor): The Alethic Architecture","text":"<p>The grand synthesis: separate Nucleus (pure logic), Halo (declarative intent), and Projector (target-specific compilation).</p> <p>See \"Synthesized Architecture\" section below.</p>"},{"location":"_archive/a-gents-architecture-review/#synthesized-architecture-the-alethic-architecture","title":"Synthesized Architecture: The Alethic Architecture","text":"<p>\"The Agent is a truth that unconceals itself differently in different worlds.\"</p>"},{"location":"_archive/a-gents-architecture-review/#the-three-pillars","title":"The Three Pillars","text":""},{"location":"_archive/a-gents-architecture-review/#1-the-nucleus-pure-logic","title":"1. The Nucleus (Pure Logic)","text":"<p>The only thing developers write. No inheritance, no coupling.</p> <pre><code># impl/claude/agents/my/summarizer.py\nfrom bootstrap.types import Agent\n\nclass Summarizer(Agent[Document, Summary]):\n    \"\"\"Pure transformation. No state, no IO, no soul.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"summarizer\"\n\n    async def invoke(self, doc: Document) -&gt; Summary:\n        # Pure logic only\n        return Summary(content=extract_key_points(doc))\n</code></pre> <p>Principle Alignment: - Tasteful: Does one thing well - Composable: Pure morphism, composes via <code>&gt;&gt;</code> - Generative: Can regenerate from spec</p>"},{"location":"_archive/a-gents-architecture-review/#2-the-halo-declarative-capabilities","title":"2. The Halo (Declarative Capabilities)","text":"<p>Metadata decorators that declare intent without implementation:</p> <pre><code>from kgents.halo import Capability\n\n@Capability.Stateful(schema=SummarizerMemory)\n@Capability.Soulful(persona=\"Kent\")\n@Capability.Observable()\n@Capability.Streamable(budget=10.0)\nclass MySummarizer(Summarizer):\n    \"\"\"Summarizer with declared capabilities.\"\"\"\n    pass\n</code></pre> <p>Key Insight: The Halo adds metadata only. No runtime overhead. No coupling to implementation.</p> <p>Principle Alignment: - Curated: Explicit selection of capabilities - Minimal Output: Metadata is the minimal declaration</p>"},{"location":"_archive/a-gents-architecture-review/#3-the-projector-categorical-compiler","title":"3. The Projector (Categorical Compiler)","text":"<p>Target-specific projectors compile Nucleus + Halo into different Topoi:</p> <pre><code>from kgents.projector import LocalProjector, K8sProjector\n\n# Projection A: The Local Topos (CLI)\nlocal_agent = LocalProjector.compile(MySummarizer)\n# Injects: SQLite D-gent, K-gent persona, asyncio streams\n\n# Projection B: The Cluster Topos (K8s)\nk8s_resources = K8sProjector.compile(MySummarizer)\n# Generates: StatefulSet, PVC, ServiceMonitor, K-gent sidecar\n</code></pre> <p>The Guarantee: Because we're projecting a Sheaf (same logic, different stalks), behavior is invariant across projections. The Projector ensures <code>@Stateful</code> means the same thing whether it maps to SQLite (local) or Postgres (K8s).</p>"},{"location":"_archive/a-gents-architecture-review/#genus-archetypes-pre-compiled-halos","title":"Genus Archetypes (Pre-compiled Halos)","text":"<p>For \"batteries included\" UX, define Genus Archetypes as pre-compiled capability sets:</p> <pre><code># impl/claude/agents/archetypes.py\n\nclass Kappa(Agent, metaclass=Archetype):\n    \"\"\"KAPPA: Full-stack service archetype.\"\"\"\n    halo = {\n        Stateful(backend=Auto),    # Redis in K8s, SQLite locally\n        Soulful(mode=Strict),      # K-gent governance\n        Observable(mirror=True),   # Terrarium integration\n        Streamable(flux=True),     # Living Pipeline capable\n    }\n\n# Usage: Just inherit the archetype\nclass MyService(Kappa[Request, Response]):\n    async def invoke(self, request: Request) -&gt; Response:\n        return process(request)\n\n# That's it. Fully capable service.\n</code></pre>"},{"location":"_archive/a-gents-architecture-review/#comparison-to-original-proposal","title":"Comparison to Original Proposal","text":"Aspect Original Alethic Base class <code>UniversalAgent</code> with methods Pure <code>Agent</code> protocol Capability declaration Constructor args Decorator metadata K8s handling Functor (K8.lift) Projector (K8sProjector.compile) Coupling Agent knows about infrastructure Agent knows nothing Functor composition Ad-hoc stacking Canonical ordering via Halo Type safety Runtime wrapping Compile-time projection"},{"location":"_archive/a-gents-architecture-review/#agentese-integration","title":"AGENTESE Integration","text":"<p>The Alethic Architecture integrates naturally with AGENTESE:</p> <pre><code># self.agent.{name}.project.{target}\nawait logos.invoke(\"self.agent.summarizer.project.local\", observer)\n# Returns: Locally projected agent, ready to run\n\nawait logos.invoke(\"self.agent.summarizer.project.k8s\", observer)\n# Returns: K8s manifests for deployment\n\n# The observer context affects projection:\n# - Developer observer: verbose logging, debug endpoints\n# - Production observer: minimal footprint, metrics only\n</code></pre>"},{"location":"_archive/a-gents-architecture-review/#implementation-roadmap","title":"Implementation Roadmap","text":"<ol> <li>Define Capability Protocol (<code>spec/a-gents/halo.md</code>)</li> <li>Standard decorators: <code>@Stateful</code>, <code>@Soulful</code>, <code>@Observable</code>, <code>@Streamable</code></li> <li> <p>Ensure metadata-only, no runtime coupling</p> </li> <li> <p>Build Local Projector (<code>impl/claude/system/projector/local.py</code>)</p> </li> <li>Dynamic Python composition</li> <li>Respects Halo metadata</li> <li> <p>Produces runnable agent</p> </li> <li> <p>Build K8s Projector (<code>impl/claude/system/projector/k8s.py</code>)</p> </li> <li>Static YAML generation</li> <li>Derives resources from Halo + Nucleus introspection</li> <li> <p>Produces deployable manifests</p> </li> <li> <p>Define Genus Archetypes (<code>impl/claude/agents/archetypes.py</code>)</p> </li> <li>KAPPA, LAMBDA, etc. as pre-compiled Halos</li> <li> <p>\"Batteries included if you want them\"</p> </li> <li> <p>Wire to A-gent CLI (<code>impl/claude/protocols/cli/handlers/agentese.py</code>)</p> </li> <li><code>kgents a build</code> \u2192 Docker image</li> <li><code>kgents a manifest</code> \u2192 K8s YAML</li> <li><code>kgents a run</code> \u2192 Local execution</li> </ol>"},{"location":"_archive/a-gents-architecture-review/#recommendations","title":"Recommendations","text":""},{"location":"_archive/a-gents-architecture-review/#immediate-before-implementation","title":"Immediate (Before Implementation)","text":"<ol> <li> <p>Drop the UniversalAgent base class. Use pure protocol-based agents.</p> </li> <li> <p>Rename K8-functor to K8-projector. Be honest about the categorical nature.</p> </li> <li> <p>Define canonical functor ordering. Document why D &lt; K &lt; Mirror &lt; Flux.</p> </li> <li> <p>Add <code>explain()</code> methods. Make functor stacks debuggable.</p> </li> </ol>"},{"location":"_archive/a-gents-architecture-review/#short-term-during-implementation","title":"Short-term (During Implementation)","text":"<ol> <li> <p>Implement the Halo protocol. Metadata decorators for capability declaration.</p> </li> <li> <p>Build LocalProjector first. Prove the pattern works before K8s complexity.</p> </li> <li> <p>Write functor law verification tests. Prove D, K, Mirror, Flux satisfy laws.</p> </li> <li> <p>Define Genus Archetypes. KAPPA, LAMBDA, etc. for common patterns.</p> </li> </ol>"},{"location":"_archive/a-gents-architecture-review/#long-term-post-mvp","title":"Long-term (Post-MVP)","text":"<ol> <li> <p>Build K8sProjector. Full manifest generation from Halo + Nucleus.</p> </li> <li> <p>Integrate with AGENTESE. <code>self.agent.*.project.*</code> paths.</p> </li> <li> <p>Add observability tooling. Functor stack visualization, performance tracing.</p> </li> </ol>"},{"location":"_archive/a-gents-architecture-review/#the-meta-question","title":"The Meta-Question","text":"<p>Is the functor-based approach the right abstraction?</p> <p>Answer: Yes, with nuance.</p> <p>Functors correctly model behavioral enhancement (D, K, Mirror, Flux). They're the right abstraction for adding capabilities that preserve composition.</p> <p>But functors incorrectly model target projection (K8). Deployment isn't enhancement\u2014it's compilation. The right abstraction there is a compiler/projector.</p> <p>The Alethic Architecture respects this distinction: - Functors for behavioral composition (D, K, Mirror, Flux) - Projectors for target compilation (Local, K8s, Serverless)</p> <p>This dual model gives us the best of both worlds: - Category-theoretic rigor where it applies - Practical compilation where it doesn't - \"Batteries included\" developer experience throughout</p> <p>\"The map is not the territory, but a good map makes the journey possible.\"</p> <p>\"The agent that can become a cluster already is one\u2014in the Halo. The projector merely unconceals it.\"</p>"},{"location":"_archive/a-gents-universal-agent-architecture/","title":"A-gents Universal Agent Architecture: Batteries Included, If You'd Want Them","text":"<p>\"The noun is a lie. There is only the rate of change.\"</p> <p>\"Category theory guarantees are not aspirational\u2014they are verified.\"</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#vision","title":"Vision","text":"<p>An agent KAPPA, upon instantiation, should already be cross-integrated with every protocol and system in the kgents ecosystem. Not through laborious declaration, but through category theory guarantees. The wiring is implicit; the activation is explicit.</p> <p>This document specifies the architecture for achieving:</p> <ol> <li>Zero-Config Cross-Integration: Any agent automatically has access to D-gent persistence, K-gent personality, Terrarium observability, K8s deployment, etc.</li> <li>Minimal Declaration: Cross-genuses compose through functors, not through verbose configuration</li> <li>Automagic Deployment: Any agent can become an independent service or cluster through category-theoretic guarantees</li> </ol>"},{"location":"_archive/a-gents-universal-agent-architecture/#the-core-insight-natural-transformations-as-wiring","title":"The Core Insight: Natural Transformations as Wiring","text":"<p>Traditional agent frameworks require explicit integration code:</p> <pre><code># Traditional: Explicit wiring (anti-pattern)\nagent = MyAgent()\nagent.attach_persistence(DGent())\nagent.attach_personality(KGent())\nagent.attach_observability(Terrarium())\nagent.attach_kubernetes(K8Operator())\n# ... tedious\n</code></pre> <p>The Universal Agent Architecture uses natural transformations instead:</p> <pre><code># Universal: Functorial lifting (the way)\nagent = MyAgent()\n# Every agent is ALREADY a D-gent, K-gent, etc. via natural transformation\n# The cross-integrations are structure-preserving maps that exist inherently\n\n# To USE a capability, you invoke the functor:\npersistent_agent = D.lift(agent)        # Now has state\nobservable_agent = Mirror.lift(agent)   # Now visible to Terrarium\ndeployable_agent = K8.lift(agent)       # Now deployable to K8s\n</code></pre> <p>Key Insight: The integration isn't added\u2014it's already there via the category structure. The functor just makes it explicit.</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#architecture-the-universal-agent-spine","title":"Architecture: The Universal Agent Spine","text":""},{"location":"_archive/a-gents-universal-agent-architecture/#the-functor-stack","title":"The Functor Stack","text":"<p>Every agent implicitly participates in a stack of natural transformations:</p> <pre><code>                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502         The Universal Agent Spine        \u2502\n                    \u2502                                         \u2502\n    Input \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502  Agent[A, B]                            \u2502\n                    \u2502       \u2502                                 \u2502\n                    \u2502       \u25bc (natural transformation)        \u2502\n                    \u2502  D \u2022 Agent[A, B]      \u2500\u2500\u2500 Persistence   \u2502\n                    \u2502       \u2502                                 \u2502\n                    \u2502       \u25bc (natural transformation)        \u2502\n                    \u2502  K \u2022 D \u2022 Agent[A, B]  \u2500\u2500\u2500 Personality   \u2502\n                    \u2502       \u2502                                 \u2502\n                    \u2502       \u25bc (natural transformation)        \u2502\n                    \u2502  Mirror \u2022 K \u2022 D \u2022 Agent[A, B] \u2500\u2500 Obs.   \u2502\n                    \u2502       \u2502                                 \u2502\n                    \u2502       \u25bc (natural transformation)        \u2502\n                    \u2502  K8 \u2022 Mirror \u2022 K \u2022 D \u2022 Agent[A, B]      \u2502\n                    \u2502       \u2502                    \u2500\u2500 Deploy    \u2502\n                    \u2502       \u25bc                                 \u2502\n    Output \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502  (Result with all capabilities)        \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/a-gents-universal-agent-architecture/#functors-are-lazy","title":"Functors are Lazy","text":"<p>The critical design: functors don't activate until invoked. The structure exists, but no resources are consumed until explicitly requested:</p> <pre><code>agent = MyAgent()  # Exists in the category with ALL potential liftings\n                   # But nothing is materialized yet\n\n# Only when you LIFT do resources activate:\nif needs_persistence:\n    agent = D.lift(agent, backend=\"sqlite\")  # NOW persistence is active\n</code></pre> <p>This is the \"batteries included, if you'd want them\" pattern.</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#the-five-universal-functors","title":"The Five Universal Functors","text":"<p>These five functors form the minimal complete set for universal cross-integration:</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#1-d-functor-persistence","title":"1. D-Functor: Persistence","text":"<pre><code>D: Agent[A, B] \u2192 Agent[A, B] with State[S]\n\nStructure-preserving: D(f &gt;&gt; g) \u2261 D(f) &gt;&gt; D(g)\nIdentity-preserving:  D(Id) \u2261 Id (with empty state)\n</code></pre> <p>What it provides: - Transparent state threading - Multiple backends (Volatile, SQLite, Redis) - Time-travel via StoreComonad - Semantic search via Bicameral</p> <p>Activation: <pre><code>stateful = D.lift(agent, backend=\"sqlite\", schema=MyState)\n</code></pre></p>"},{"location":"_archive/a-gents-universal-agent-architecture/#2-k-functor-personality-navigation","title":"2. K-Functor: Personality Navigation","text":"<pre><code>K: Agent[A, B] \u2192 Agent[A, B] in PersonalitySpace\n\nStructure-preserving: K(f &gt;&gt; g) \u2261 K(f) &gt;&gt; K(g)\nFixed-point: K \u2022 K \u2261 K (navigating to same coordinates is idempotent)\n</code></pre> <p>What it provides: - Personality coordinates (warmth, directness, etc.) - Eigenvector alignment - Mode switching (REFLECT, ADVISE, CHALLENGE, EXPLORE) - Query interface for other agents</p> <p>Activation: <pre><code>personalized = K.lift(agent, persona=KentSeed)\n</code></pre></p>"},{"location":"_archive/a-gents-universal-agent-architecture/#3-mirror-functor-observability","title":"3. Mirror-Functor: Observability","text":"<pre><code>Mirror: Agent[A, B] \u2192 Agent[A, B] with Observation\n\nStructure-preserving: Mirror(f &gt;&gt; g) \u2261 Mirror(f) &gt;&gt; Mirror(g)\nTransparent: Mirror doesn't change semantics, only adds visibility\n</code></pre> <p>What it provides: - WebSocket streaming to Terrarium TUI - Metrics emission (throughput, latency, errors) - Pheromone integration - Semantic field participation</p> <p>Activation: <pre><code>observable = Mirror.lift(agent, terrarium_url=\"ws://localhost:8765\")\n</code></pre></p>"},{"location":"_archive/a-gents-universal-agent-architecture/#4-k8-functor-deployment-projection","title":"4. K8-Functor: Deployment Projection","text":"<pre><code>K8: Agent[A, B] \u2192 Deployable[Agent[A, B]]\n\nStructure-preserving: K8(f &gt;&gt; g) \u2261 K8(f) &gt;&gt; K8(g) (pipelines deploy as pipelines)\nDeclarative: K8 generates CRD, Deployment, Service from agent spec\n</code></pre> <p>What it provides: - Automatic CRD generation - Deployment manifest derivation - Service mesh integration - Auto-scaling policies - Resource quotas - Network policies</p> <p>Activation: <pre><code>deployable = K8.lift(agent, replicas=3, resources={\"cpu\": \"500m\", \"memory\": \"512Mi\"})\nawait deployable.deploy(namespace=\"production\")\n</code></pre></p>"},{"location":"_archive/a-gents-universal-agent-architecture/#5-flux-functor-streaming-projection","title":"5. Flux-Functor: Streaming Projection","text":"<pre><code>Flux: Agent[A, B] \u2192 Agent[AsyncIterator[A], AsyncIterator[B]]\n\nFunctor laws: Flux(f &gt;&gt; g) \u2261 Flux(f) | Flux(g)\nLiving pipelines: Output of one stage feeds input of next\n</code></pre> <p>What it provides: - Discrete \u2192 streaming transformation - Backpressure handling - Perturbation for HITL - Ouroboric feedback - Metabolism integration</p> <p>Activation: <pre><code>streaming = Flux.lift(agent, config=FluxConfig(entropy_budget=2.0))\nasync for result in streaming.start(event_source):\n    process(result)\n</code></pre></p>"},{"location":"_archive/a-gents-universal-agent-architecture/#composition-the-zen-of-cross-integration","title":"Composition: The Zen of Cross-Integration","text":""},{"location":"_archive/a-gents-universal-agent-architecture/#the-natural-transformation-diagram","title":"The Natural Transformation Diagram","text":"<p>Cross-integration works because functors compose:</p> <pre><code>                 F                    G\nAgent[A,B] \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba F\u2022Agent \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba G\u2022F\u2022Agent\n    \u2502                        \u2502                       \u2502\n    \u2502 \u03b7_Agent                \u2502 \u03b7_F\u2022Agent             \u2502 \u03b7_G\u2022F\u2022Agent\n    \u25bc                        \u25bc                       \u25bc\nNatural transformations preserve structure at each level\n</code></pre>"},{"location":"_archive/a-gents-universal-agent-architecture/#minimal-declaration-syntax","title":"Minimal Declaration Syntax","text":"<pre><code># The batteries-included pattern\nfrom kgents.universal import Agent\n\n@Agent.register\nclass MyAgent(Agent[Input, Output]):\n    \"\"\"My agent does something.\"\"\"\n\n    # OPTIONAL: Declare which batteries to activate\n    class Meta:\n        persistence = \"sqlite\"     # D-functor backend\n        personality = \"kent\"       # K-functor persona\n        observable = True          # Mirror-functor enabled\n        deployable = True          # K8-functor enabled\n        streaming = True           # Flux-functor enabled\n</code></pre> <p>Or even more minimal (pure defaults):</p> <pre><code>@Agent.register\nclass MyAgent(Agent[Input, Output]):\n    async def invoke(self, input: Input) -&gt; Output:\n        return Output(...)\n\n    # ALL integrations available via lazy lifting\n    # Nothing activated until explicitly invoked\n</code></pre>"},{"location":"_archive/a-gents-universal-agent-architecture/#composition-preserves-integrations","title":"Composition Preserves Integrations","text":"<p>When you compose agents, the integrations compose:</p> <pre><code>pipeline = AgentA &gt;&gt; AgentB &gt;&gt; AgentC\n\n# Lifting the pipeline lifts ALL agents in it\npersistent_pipeline = D.lift(pipeline)  # Each agent gets own state namespace\ndeployable_pipeline = K8.lift(pipeline)  # Deploys as single unit or separate pods\n</code></pre>"},{"location":"_archive/a-gents-universal-agent-architecture/#k8-gents-the-deployment-functor-in-depth","title":"K8-Gents: The Deployment Functor in Depth","text":""},{"location":"_archive/a-gents-universal-agent-architecture/#from-agent-to-cluster","title":"From Agent to Cluster","text":"<p>The K8-functor is unique: it doesn't just wrap behavior, it projects an agent into the Kubernetes domain.</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     K8-Functor: Agent \u2192 Cluster                          \u2502\n\u2502                                                                          \u2502\n\u2502   Agent[A, B]                                                            \u2502\n\u2502       \u2502                                                                  \u2502\n\u2502       \u25bc K8.lift()                                                        \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u2502\n\u2502   \u2502                    CRD (AgentServer)                  \u2502              \u2502\n\u2502   \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502              \u2502\n\u2502   \u2502  \u2502 apiVersion: kgents.io/v1                      \u2502    \u2502              \u2502\n\u2502   \u2502  \u2502 kind: AgentServer                             \u2502    \u2502              \u2502\n\u2502   \u2502  \u2502 metadata:                                     \u2502    \u2502              \u2502\n\u2502   \u2502  \u2502   name: my-agent                              \u2502    \u2502              \u2502\n\u2502   \u2502  \u2502 spec:                                         \u2502    \u2502              \u2502\n\u2502   \u2502  \u2502   genus: KAPPA                                \u2502    \u2502              \u2502\n\u2502   \u2502  \u2502   image: kgents/agent:latest                  \u2502    \u2502              \u2502\n\u2502   \u2502  \u2502   replicas: 3                                 \u2502    \u2502              \u2502\n\u2502   \u2502  \u2502   # ... derived from agent spec               \u2502    \u2502              \u2502\n\u2502   \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502              \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502\n\u2502       \u2502                                                                  \u2502\n\u2502       \u25bc Operator reconciles                                              \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u2502\n\u2502   \u2502                    Resources                          \u2502              \u2502\n\u2502   \u2502  - Deployment (N replicas of agent pod)              \u2502              \u2502\n\u2502   \u2502  - Service (ClusterIP or LoadBalancer)               \u2502              \u2502\n\u2502   \u2502  - ConfigMap (agent configuration)                   \u2502              \u2502\n\u2502   \u2502  - ServiceAccount + RBAC                             \u2502              \u2502\n\u2502   \u2502  - NetworkPolicy (egress control)                    \u2502              \u2502\n\u2502   \u2502  - HPA (if auto-scaling enabled)                     \u2502              \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/a-gents-universal-agent-architecture/#k8-functor-composition","title":"K8-Functor Composition","text":"<p>The key insight: pipelines of agents can deploy as pipelines of pods:</p> <pre><code># Logical pipeline\npipeline = Ingest &gt;&gt; Transform &gt;&gt; Enrich &gt;&gt; Store\n\n# Deploy as four separate services (micro-services pattern)\nk8_pipeline = K8.lift(pipeline, mode=\"distributed\")\n# Creates: ingest-svc, transform-svc, enrich-svc, store-svc\n# With proper Service mesh routing\n\n# OR deploy as single pod (monolith pattern)\nk8_pipeline = K8.lift(pipeline, mode=\"monolith\")\n# Creates: single pod running all four agents\n</code></pre>"},{"location":"_archive/a-gents-universal-agent-architecture/#resource-definition-derivation","title":"Resource Definition Derivation","text":"<p>The K8-functor derives resource definitions from agent metadata:</p> Agent Property K8s Resource <code>Input/Output types</code> Service ports, gRPC protobuf <code>State schema</code> PVC claims, D-gent sidecar <code>Memory/CPU hints</code> Resource requests/limits <code>Personality persona</code> ConfigMap with K-gent seed <code>Observable: true</code> Terrarium sidecar injection <code>AGENTESE paths</code> Ingress routes"},{"location":"_archive/a-gents-universal-agent-architecture/#the-k8-d-mirror-triangle","title":"The K8-D-Mirror Triangle","text":"<p>When an agent needs persistence AND observability AND K8s deployment:</p> <pre><code>agent = MyAgent()\n\n# The functors compose\ndeployed = K8.lift(Mirror.lift(D.lift(agent)))\n\n# This single declaration creates:\n# - Pod with agent container\n# - D-gent sidecar for state\n# - Mirror sidecar for metrics\n# - Service for routing\n# - ConfigMap for config\n</code></pre>"},{"location":"_archive/a-gents-universal-agent-architecture/#implementation-strategy","title":"Implementation Strategy","text":""},{"location":"_archive/a-gents-universal-agent-architecture/#phase-1-functor-interfaces-foundation","title":"Phase 1: Functor Interfaces (Foundation)","text":"<p>Define the five functor interfaces in <code>spec/a-gents/functors/</code>:</p> <pre><code>spec/a-gents/functors/\n\u251c\u2500\u2500 README.md           # Overview of functor system\n\u251c\u2500\u2500 d-functor.md        # Persistence functor spec\n\u251c\u2500\u2500 k-functor.md        # Personality functor spec\n\u251c\u2500\u2500 mirror-functor.md   # Observability functor spec\n\u251c\u2500\u2500 k8-functor.md       # Deployment functor spec\n\u2514\u2500\u2500 flux-functor.md     # Streaming functor spec (already exists)\n</code></pre> <p>Deliverable: Formal specification of each functor's laws and interface.</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#phase-2-universal-agent-base-class","title":"Phase 2: Universal Agent Base Class","text":"<p>Implement <code>impl/claude/agents/a/universal.py</code>:</p> <pre><code>class UniversalAgent(Agent[A, B], Generic[A, B]):\n    \"\"\"\n    Base class for batteries-included agents.\n\n    Every agent inheriting from this automatically has access\n    to all five functors via lazy lifting.\n    \"\"\"\n\n    # Functor accessors (lazy)\n    @property\n    def as_stateful(self) -&gt; \"StatefulAgent[A, B]\":\n        \"\"\"Lift to D-functor (persistence).\"\"\"\n        from agents.d.functor import D\n        return D.lift(self)\n\n    @property\n    def as_personalized(self) -&gt; \"PersonalizedAgent[A, B]\":\n        \"\"\"Lift to K-functor (personality).\"\"\"\n        from agents.k.functor import K\n        return K.lift(self)\n\n    @property\n    def as_observable(self) -&gt; \"ObservableAgent[A, B]\":\n        \"\"\"Lift to Mirror-functor (observability).\"\"\"\n        from agents.o.functor import Mirror\n        return Mirror.lift(self)\n\n    @property\n    def as_deployable(self) -&gt; \"DeployableAgent[A, B]\":\n        \"\"\"Lift to K8-functor (deployment).\"\"\"\n        from infra.k8s.functor import K8\n        return K8.lift(self)\n\n    @property\n    def as_streaming(self) -&gt; \"FluxAgent[A, B]\":\n        \"\"\"Lift to Flux-functor (streaming).\"\"\"\n        from agents.flux.functor import Flux\n        return Flux.lift(self)\n</code></pre> <p>Deliverable: Universal base class with lazy functor lifting.</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#phase-3-k8-functor-implementation","title":"Phase 3: K8-Functor Implementation","text":"<p>Implement <code>impl/claude/infra/k8s/functor.py</code>:</p> <pre><code>class K8Functor:\n    \"\"\"\n    The K8-Functor: Project agents into Kubernetes domain.\n\n    K8: Agent[A, B] \u2192 Deployable[Agent[A, B]]\n\n    Laws:\n    - Structure-preserving: K8(f &gt;&gt; g) \u2261 K8(f) &gt;&gt; K8(g)\n    - Declarative: Generated manifests are idempotent\n    \"\"\"\n\n    @classmethod\n    def lift(\n        cls,\n        agent: Agent[A, B],\n        *,\n        replicas: int = 1,\n        resources: dict | None = None,\n        mode: Literal[\"distributed\", \"monolith\"] = \"monolith\",\n    ) -&gt; \"DeployableAgent[A, B]\":\n        \"\"\"Lift an agent to the deployable domain.\"\"\"\n        ...\n\n    @classmethod\n    def derive_crd(cls, agent: Agent) -&gt; dict:\n        \"\"\"Derive CRD from agent metadata.\"\"\"\n        ...\n\n    @classmethod\n    def derive_manifests(cls, agent: Agent) -&gt; list[dict]:\n        \"\"\"Derive all K8s manifests from agent.\"\"\"\n        ...\n</code></pre> <p>Deliverable: K8-functor that derives deployments from agent specs.</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#phase-4-functor-composition-verification","title":"Phase 4: Functor Composition Verification","text":"<p>Implement <code>impl/claude/agents/a/_tests/test_functor_composition.py</code>:</p> <pre><code>class TestFunctorComposition:\n    \"\"\"Verify that functor compositions preserve structure.\"\"\"\n\n    async def test_d_k_composition(self):\n        \"\"\"D \u2022 K preserves agent semantics.\"\"\"\n        agent = EchoAgent()\n        composed = D.lift(K.lift(agent))\n\n        result = await composed.invoke(\"test\")\n        assert result == \"test\"\n\n    async def test_k8_pipeline_distribution(self):\n        \"\"\"K8(f &gt;&gt; g) can deploy as separate services.\"\"\"\n        pipeline = AgentA() &gt;&gt; AgentB()\n        deployed = K8.lift(pipeline, mode=\"distributed\")\n\n        manifests = deployed.manifests\n        assert len([m for m in manifests if m[\"kind\"] == \"Service\"]) == 2\n</code></pre> <p>Deliverable: Test suite verifying functor laws across compositions.</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#phase-5-agentese-integration","title":"Phase 5: AGENTESE Integration","text":"<p>Wire functors into AGENTESE paths:</p> <pre><code># self.agent.{name}.lift.{functor}\nawait logos.invoke(\"self.agent.summarizer.lift.k8\", observer)\n# Returns K8-lifted agent, ready for deployment\n\n# world.cluster.deploy\nawait logos.invoke(\"world.cluster.deploy\", observer, agent=lifted_agent)\n# Actually deploys to K8s\n</code></pre> <p>Deliverable: AGENTESE paths for functor operations.</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#the-k-gent-wrapper-pattern","title":"The K-Gent Wrapper Pattern","text":"<p>K-gent as a personality wrapper illustrates the universal pattern:</p> <pre><code># Any agent can be wrapped with Kent's personality\ndef kent_wrap(agent: Agent[A, B]) -&gt; Agent[A, B]:\n    \"\"\"Apply K-gent personality to any agent.\"\"\"\n    return K.lift(agent, persona=KENT_EIGENVECTORS)\n\n# This is a natural transformation:\n# kent_wrap(f &gt;&gt; g) \u2261 kent_wrap(f) &gt;&gt; kent_wrap(g)\n\n# Usage:\nkent_summarizer = kent_wrap(Summarizer())\n# Now summarizes with Kent's voice\n</code></pre> <p>The key: this works for any agent without modification.</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#roadmap-from-spec-to-cluster","title":"Roadmap: From Spec to Cluster","text":"Phase Focus Deliverable Tests 1 Functor Interfaces <code>spec/a-gents/functors/*.md</code> N/A (spec) 2 Universal Base <code>agents/a/universal.py</code> 20+ 3 K8-Functor <code>infra/k8s/functor.py</code> 40+ 4 Composition <code>agents/a/_tests/test_composition.py</code> 30+ 5 AGENTESE Wiring <code>protocols/agentese/contexts/self_.py</code> 20+ 6 E2E Verification Single agent \u2192 cluster 10+ <p>Exit Criteria: An agent defined with 10 lines of code can be deployed to K8s with a single functor lift, inheriting D-gent state, K-gent personality, and Mirror observability automatically.</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#design-decisions","title":"Design Decisions","text":""},{"location":"_archive/a-gents-universal-agent-architecture/#why-functors-not-mixins","title":"Why Functors, Not Mixins?","text":"<p>Mixins couple features at the class level. Functors compose at the morphism level:</p> Approach Coupling Composition Verification Mixins Class hierarchy Inheritance order matters Hard to test Functors Structure-preserving maps Order-independent (associative) Laws verified"},{"location":"_archive/a-gents-universal-agent-architecture/#why-lazy-lifting","title":"Why Lazy Lifting?","text":"<p>Eager instantiation wastes resources. Lazy lifting means: - Zero overhead for unused capabilities - Explicit activation makes intent clear - Resources allocated only when needed</p>"},{"location":"_archive/a-gents-universal-agent-architecture/#why-k8-as-functor-not-decorator","title":"Why K8 as Functor, Not Decorator?","text":"<p>K8 deployment isn't just wrapping\u2014it's projection into a different domain (Python runtime \u2192 Kubernetes control plane). Functors model this projection cleanly:</p> <pre><code>Python Category                  K8s Category\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500                \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nAgent[A, B]      \u2500\u2500\u2500\u2500 K8 \u2500\u2500\u2500\u2500\u25ba   CRD + Deployment\n   \u2502                                  \u2502\n   \u2502 &gt;&gt;                               \u2502 Service mesh\n   \u25bc                                  \u25bc\nAgent[B, C]      \u2500\u2500\u2500\u2500 K8 \u2500\u2500\u2500\u2500\u25ba   CRD + Deployment\n</code></pre>"},{"location":"_archive/a-gents-universal-agent-architecture/#zen-of-universal-agents","title":"Zen of Universal Agents","text":"<ol> <li>Batteries included: Every integration exists in potential</li> <li>Explicit activation: Nothing runs until lifted</li> <li>Structure preserved: Composition survives lifting</li> <li>Minimal declaration: One line to activate a capability</li> <li>Automagic deployment: K8.lift() \u2192 running pods</li> <li>Category guarantees: Laws are verified, not aspirational</li> </ol>"},{"location":"_archive/a-gents-universal-agent-architecture/#see-also","title":"See Also","text":"<ul> <li><code>spec/a-gents/abstract/skeleton.md</code> \u2014 The minimal agent skeleton</li> <li><code>spec/c-gents/composition.md</code> \u2014 Composition laws</li> <li><code>spec/c-gents/functors.md</code> \u2014 Functor catalog</li> <li><code>plans/skills/building-agent.md</code> \u2014 Agent building skill</li> <li><code>impl/claude/infra/k8s/</code> \u2014 Current K8s infrastructure</li> </ul> <p>\"The agent that can become a cluster already is one\u2014in potential. The functor merely collapses the wave function.\"</p>"},{"location":"_archive/agent-refactoring-fundamentals/","title":"Agent Refactoring Fundamentals","text":"<p>\"Every agent is a poem; derivation is scansion.\"</p> <p>This document establishes the principles for refining agent derivations to achieve maximal elegance while remaining faithful to <code>spec/principles.md</code>.</p>"},{"location":"_archive/agent-refactoring-fundamentals/#the-central-thesis","title":"The Central Thesis","text":"<p>An agent is elegant when its derivation from bootstrap primitives is both necessary and sufficient\u2014no missing steps, no superfluous ones.</p> <p>The five bootstrap primitives form an irreducible basis:</p> Primitive Symbol Essence Id <code>I</code> Identity morphism\u2014preserve without change Compose <code>&gt;&gt;</code> Sequential combination\u2014output becomes input Ground <code>G</code> Reality grounding\u2014connect to the external Judge <code>J</code> Principle evaluation\u2014apply values Contradict <code>X</code> Tension detection\u2014surface conflicts Sublate <code>S</code> Synthesis\u2014resolve or hold tensions Fix <code>F</code> Convergence\u2014iterate until stable <p>Every derived agent must decompose into compositions of these primitives. The question is not whether it decomposes, but how elegantly.</p>"},{"location":"_archive/agent-refactoring-fundamentals/#the-three-laws-of-elegant-derivation","title":"The Three Laws of Elegant Derivation","text":""},{"location":"_archive/agent-refactoring-fundamentals/#law-1-necessity","title":"Law 1: Necessity","text":"<p>Every primitive in the derivation must earn its place.</p> <p>If you can remove a primitive and the agent still functions correctly, the derivation is inelegant. Redundant primitives indicate either misunderstanding of the agent's purpose or over-engineering.</p> <p>Test: For each primitive in the derivation, ask \"What breaks if I remove this?\"</p>"},{"location":"_archive/agent-refactoring-fundamentals/#law-2-sufficiency","title":"Law 2: Sufficiency","text":"<p>The derivation must fully explain the agent's behavior.</p> <p>If the agent does something that cannot be traced back to its constituent primitives, either the derivation is incomplete or the agent is doing something it shouldn't.</p> <p>Test: For each agent behavior, ask \"Which primitive(s) produce this?\"</p>"},{"location":"_archive/agent-refactoring-fundamentals/#law-3-clarity","title":"Law 3: Clarity","text":"<p>The derivation should be readable as a sentence.</p> <p>A well-derived agent reads like prose: - \"G-gent Grounds intent to domain, then Composes grammar rules, then Judges for constraint satisfaction\" - \"H-gent Contradicts to surface tensions, then Sublates toward synthesis, using Fix when recursive\"</p> <p>If the derivation requires a flowchart to explain, it may be too complex.</p>"},{"location":"_archive/agent-refactoring-fundamentals/#pattern-catalog","title":"Pattern Catalog","text":"<p>From the existing specs, these derivation patterns emerge:</p>"},{"location":"_archive/agent-refactoring-fundamentals/#pattern-a-the-linear-pipeline","title":"Pattern A: The Linear Pipeline","text":"<pre><code>Input \u2192 P\u2081 \u2192 P\u2082 \u2192 P\u2083 \u2192 Output\n</code></pre> <p>Example: G-gent (Grammarian) <pre><code>Ground(domain) &gt;&gt; Compose(rules) &gt;&gt; Judge(constraints) &gt;&gt; Fix(refine)\n</code></pre></p> <p>When to use: When the agent transforms input through distinct, sequential stages.</p> <p>Elegance criterion: The number of stages should match the essential complexity of the transformation, no more.</p>"},{"location":"_archive/agent-refactoring-fundamentals/#pattern-b-the-stratified-architecture","title":"Pattern B: The Stratified Architecture","text":"<pre><code>Infrastructure Level: Operations (not agents)\nComposition Level: Agent wrapping operations\n</code></pre> <p>Example: H-gent (Hegelian), D-gent (Data) <pre><code>Infrastructure: Contradict, Sublate (meta-operations)\nComposition: DialecticAgent = Compose(Contradict, Sublate) : Agent\n</code></pre></p> <p>When to use: When the domain requires both low-level operations AND higher-level orchestration.</p> <p>Elegance criterion: Clear separation between levels; no leakage.</p>"},{"location":"_archive/agent-refactoring-fundamentals/#pattern-c-the-functor-lift","title":"Pattern C: The Functor Lift","text":"<pre><code>K: Agent[A, B] \u2192 Agent[A, B]\n</code></pre> <p>Example: K-gent (Personalization) <pre><code>K = Fix(\u03bbsystem. developer_adapts(system))\nK.lift(agent) = agent colored by personality field\n</code></pre></p> <p>When to use: When the agent transforms other agents while preserving their type signature.</p> <p>Elegance criterion: The functor laws must hold (identity preserved, composition preserved).</p>"},{"location":"_archive/agent-refactoring-fundamentals/#pattern-d-the-lazy-tree","title":"Pattern D: The Lazy Tree","text":"<pre><code>Root Promise\n\u251c\u2500\u2500 Child Promise (deferred)\n\u2502   \u2514\u2500\u2500 Leaf (evaluated)\n\u2514\u2500\u2500 Child Promise (deferred)\n    \u2514\u2500\u2500 Leaf (evaluated)\n</code></pre> <p>Example: J-gent (JIT) <pre><code>Classify(task) &gt;&gt; match {\n    DETERMINISTIC \u2192 Ground(execute)\n    PROBABILISTIC \u2192 Compose(children) &gt;&gt; Fix(collect)\n    CHAOTIC \u2192 Ground(fallback)\n}\n</code></pre></p> <p>When to use: When evaluation order matters and some branches may never be needed.</p> <p>Elegance criterion: The lazy structure should reflect the inherent tree structure of the problem.</p>"},{"location":"_archive/agent-refactoring-fundamentals/#pattern-e-the-separation-of-concerns","title":"Pattern E: The Separation of Concerns","text":"<pre><code>Write-Time: Silent recording\nRead-Time: Interpretive projection\n</code></pre> <p>Example: N-gent (Narrative) <pre><code>Historian: Ground(tap) &gt;&gt; Ground(store)  [no prose]\nBard: Ground(crystals) &gt;&gt; Judge(genre) &gt;&gt; Compose(narrative)\n</code></pre></p> <p>When to use: When the same data needs multiple interpretations, or when recording must not affect execution.</p> <p>Elegance criterion: The separation is clean; neither side knows the other's concerns.</p>"},{"location":"_archive/agent-refactoring-fundamentals/#the-derivation-quality-checklist","title":"The Derivation Quality Checklist","text":"<p>For each agent derivation, verify:</p>"},{"location":"_archive/agent-refactoring-fundamentals/#structural","title":"Structural","text":"<ul> <li> Decomposable: Can be expressed purely in terms of bootstrap primitives</li> <li> Minimal: No primitive can be removed without loss of function</li> <li> Complete: All behaviors traced to primitives</li> <li> Readable: Derivation reads as natural description</li> </ul>"},{"location":"_archive/agent-refactoring-fundamentals/#categorical","title":"Categorical","text":"<ul> <li> Type-correct: Input/output types match at each composition point</li> <li> Composable: The agent itself can be composed with others</li> <li> Law-abiding: Satisfies associativity, identity where applicable</li> </ul>"},{"location":"_archive/agent-refactoring-fundamentals/#principled","title":"Principled","text":"<ul> <li> Tasteful: Minimal complexity for the problem</li> <li> Curated: Deliberate choice of pattern, not accidental</li> <li> Ethical: Judge primitives appear where value judgments are made</li> <li> Joy-inducing: The derivation reveals something beautiful about the problem</li> <li> Composable: Enables further composition (doesn't dead-end)</li> </ul>"},{"location":"_archive/agent-refactoring-fundamentals/#the-refactoring-process","title":"The Refactoring Process","text":""},{"location":"_archive/agent-refactoring-fundamentals/#step-1-extract-current-derivation","title":"Step 1: Extract Current Derivation","text":"<p>Read the agent's README and implementation. Write out the implicit derivation:</p> <pre><code>Agent: [Name]\nCurrent Derivation: P\u2081 &gt;&gt; P\u2082 &gt;&gt; P\u2083\n</code></pre>"},{"location":"_archive/agent-refactoring-fundamentals/#step-2-apply-necessity-test","title":"Step 2: Apply Necessity Test","text":"<p>For each primitive: - What would break if removed? - Is that breakage essential or accidental?</p> <p>If accidental, the primitive is a candidate for removal.</p>"},{"location":"_archive/agent-refactoring-fundamentals/#step-3-apply-sufficiency-test","title":"Step 3: Apply Sufficiency Test","text":"<p>For each documented behavior: - Which primitive(s) produce it? - Is the mapping clear and direct?</p> <p>If unclear, either the derivation or the documentation needs refinement.</p>"},{"location":"_archive/agent-refactoring-fundamentals/#step-4-apply-clarity-test","title":"Step 4: Apply Clarity Test","text":"<p>Write the derivation as a sentence: - Does it read naturally? - Would someone unfamiliar with the system understand the essence?</p> <p>If not, refactor for clarity.</p>"},{"location":"_archive/agent-refactoring-fundamentals/#step-5-verify-pattern-fit","title":"Step 5: Verify Pattern Fit","text":"<p>Does the agent fit a known pattern? - If yes, does it follow the pattern cleanly? - If no, is it a genuinely novel pattern worthy of cataloging?</p>"},{"location":"_archive/agent-refactoring-fundamentals/#step-6-document-refined-derivation","title":"Step 6: Document Refined Derivation","text":"<p>Update the agent's README with the refined derivation, showing: - The primitives used - The composition structure - The pattern employed - Why this is the right decomposition</p>"},{"location":"_archive/agent-refactoring-fundamentals/#agent-derivation-index","title":"Agent Derivation Index","text":"<p>Current derivations from the specs (to be refined):</p> Agent Current Derivation Pattern Elegance Issues A-gent Ground + Compose + Judge + Fix Pipeline Base primitives; inherently elegant B-gent Ground(resources) + Judge(ethics) + Compose(allocation) Pipeline Good; could clarify economic Judge C-gent Pure category theory; IS the composition Meta Definitionally elegant D-gent Stratified: Ground(storage) + Compose(agents) Stratified Clear; infrastructure/composition split good E-gent Ground(observations) + Contradict(hypotheses) + Fix(evolve) Pipeline Good; falsification path clear F-gent Ground(intent) + Compose(artifact) + Judge(quality) + Fix(iterate) Pipeline Dense; consider staging G-gent Ground(domain) + Compose(grammar) + Judge(constraints) + Fix(refine) Pipeline Very clean H-gent Stratified: (Contradict, Sublate) + DialecticAgent wrapper Stratified Clean; separation noted I-gent Ground(state) + Compose(visualization) Pipeline Light; appropriate for interface J-gent Classify(Ground+Judge) + Compose(tree) + Fix(evaluate) Lazy Tree Complex; justified by JIT nature K-gent Fix(\u03bbsystem.developer_adapts) Functor Beautifully minimal L-gent Ground(storage) + Compose(search) + Judge(relevance) Pipeline Good; three-brain architecture maps well M-gent Ground(hologram) + Compose(resonance) + Fix(consolidate) Pipeline Poetic; holographic metaphor preserved N-gent Separation: Ground(tap) // Ground+Judge+Compose(narrate) Separation Clean; Historian/Bard split elegant"},{"location":"_archive/agent-refactoring-fundamentals/#the-refinement-backlog","title":"The Refinement Backlog","text":"<p>Priority issues discovered in the derivations:</p>"},{"location":"_archive/agent-refactoring-fundamentals/#high-priority","title":"High Priority","text":"<ol> <li>F-gent Staging: The Forge does many things. Consider explicit phases:</li> <li>Intent Capture (Ground)</li> <li>Template Selection (Judge)</li> <li>Code Generation (Compose)</li> <li> <p>Iteration (Fix)</p> </li> <li> <p>B-gent Economic Judge: The ethical dimension of resource allocation deserves explicit Judge placement, not implicit in Compose.</p> </li> </ol>"},{"location":"_archive/agent-refactoring-fundamentals/#medium-priority","title":"Medium Priority","text":"<ol> <li> <p>J-gent Complexity: The JIT pattern is inherently complex, but verify each branch of the classification is necessary.</p> </li> <li> <p>T-gent Derivation: Not in index\u2014needs full derivation from spec.</p> </li> </ol>"},{"location":"_archive/agent-refactoring-fundamentals/#low-priority","title":"Low Priority","text":"<ol> <li>Pattern Catalog Expansion: Document any novel patterns found during refinement.</li> </ol>"},{"location":"_archive/agent-refactoring-fundamentals/#the-aesthetic-standard","title":"The Aesthetic Standard","text":"<p>\"Elegance is not a luxury; it is a necessity. An inelegant derivation is a misunderstanding made manifest.\"</p> <p>The goal is not to impress but to reveal. A good derivation should make the reader say \"of course\"\u2014the structure was always there, we're just naming it.</p> <p>Signs of elegance: - The derivation fits on one line - Each primitive appears exactly once (or has clear reason for repetition) - The pattern choice is obvious in hindsight - The derivation could be taught to a newcomer</p> <p>Signs of inelegance: - The derivation requires conditional branches to explain - Primitives appear redundantly - The pattern is unique to this agent (unless genuinely novel) - The derivation requires implementation details to understand</p>"},{"location":"_archive/agent-refactoring-fundamentals/#maintaining-this-document","title":"Maintaining This Document","text":"<p>As agents are refined: 1. Update the Agent Derivation Index 2. Document new patterns discovered 3. Add elegance issues to the backlog 4. Archive resolved issues</p> <p>This is a living document tracking the ongoing pursuit of derivational elegance.</p> <p>\"The unexamined agent is not worth composing.\"</p>"},{"location":"_archive/agent-semaphores-implementation-prompt/","title":"Agent Semaphores Implementation Prompt","text":"<p>Use this prompt with <code>/hydrate</code> to begin implementing Agent Semaphores (The Rodizio Pattern).</p>"},{"location":"_archive/agent-semaphores-implementation-prompt/#context-for-the-implementing-agent","title":"Context for the Implementing Agent","text":"<p>You are implementing Agent Semaphores for kgents\u2014a human-in-the-loop coordination pattern that allows FluxAgents to yield control until humans provide context. This implements the Rodizio Pattern (named after Brazilian steakhouse service).</p> <p>Before writing any code, read these documents in order:</p> <ol> <li><code>plans/agents/semaphores.md</code> \u2014 The plan file (READ FIRST)</li> <li><code>spec/principles.md</code> \u2014 Design principles (constraints on ALL work)</li> <li><code>plans/principles.md</code> \u2014 Forest protocol (session coordination)</li> <li><code>impl/claude/agents/flux/agent.py</code> \u2014 FluxAgent implementation</li> <li><code>impl/claude/agents/flux/perturbation.py</code> \u2014 Perturbation pattern (you'll reuse this)</li> </ol>"},{"location":"_archive/agent-semaphores-implementation-prompt/#the-core-insight","title":"The Core Insight","text":"<p>Traditional human-in-the-loop: ask question \u2192 block \u2192 wait \u2192 continue. This is the interrupt model.</p> <p>Agent Semaphores embrace the yield model via the Purgatory Pattern:</p> <pre><code>Flux Stream        Purgatory         Human           Flux Stream\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Event A  \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2502  Eject   \u2502      \u2502        \u2502      \u2502 Context  \u2502\n\u2502 needs    \u2502 \u2500\u2500\u2192  \u2502  &amp; Save  \u2502 \u2500\u2500\u2192  \u2502 Review \u2502 \u2500\u2500\u2192  \u2502 Re-inject\u2502\n\u2502 human    \u2502      \u2502 state    \u2502      \u2502 &amp; Flip \u2502      \u2502 as Perturb\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n     \u2502                                                    \u2502\n     \u2502               \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                         \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6\u2502 Event B  \u2502\u25c0\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502 proceeds \u2502\n                     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nKey: Stream CONTINUES. Blocked event waits in Purgatory, not in flux.\n</code></pre> <p>Why Purgatory? Two problems with naive generator encoding: 1. Python generators cannot be pickled \u2014 server restart loses stack frame 2. Head-of-line blocking \u2014 one semaphore blocks entire Flux stream</p> <p>Resolution: We RETURN tokens (not YIELD), eject state to Purgatory, and re-inject via existing Perturbation mechanism.</p>"},{"location":"_archive/agent-semaphores-implementation-prompt/#implementation-scope-phase-1-only","title":"Implementation Scope: Phase 1 Only","text":"<p>This prompt is for Phase 1: SemaphoreToken, ReentryContext, and Purgatory.</p> <p>Do NOT attempt Phases 2-5 in this session. Phase 1 is foundational.</p> <p>Goal: Define core types and the Purgatory store. Tests demonstrate token creation and resolution.</p> <p>Exit Criteria: - <code>SemaphoreToken</code> can be created with reason, prompt, options - <code>ReentryContext</code> carries frozen state and human input - <code>Purgatory</code> can save, resolve, cancel, list, and recover tokens - Tests demonstrate the round-trip: create \u2192 save \u2192 resolve \u2192 reentry</p>"},{"location":"_archive/agent-semaphores-implementation-prompt/#file-structure-to-create","title":"File Structure to Create","text":"<pre><code>impl/claude/agents/flux/\n\u251c\u2500\u2500 semaphore/\n\u2502   \u251c\u2500\u2500 __init__.py           # Exports: SemaphoreToken, ReentryContext, Purgatory, SemaphoreReason\n\u2502   \u251c\u2500\u2500 token.py              # SemaphoreToken dataclass\n\u2502   \u251c\u2500\u2500 reentry.py            # ReentryContext dataclass\n\u2502   \u251c\u2500\u2500 reason.py             # SemaphoreReason enum\n\u2502   \u251c\u2500\u2500 purgatory.py          # Purgatory store\n\u2502   \u2514\u2500\u2500 _tests/\n\u2502       \u251c\u2500\u2500 __init__.py\n\u2502       \u251c\u2500\u2500 test_token.py\n\u2502       \u251c\u2500\u2500 test_reentry.py\n\u2502       \u2514\u2500\u2500 test_purgatory.py\n</code></pre>"},{"location":"_archive/agent-semaphores-implementation-prompt/#type-definitions","title":"Type Definitions","text":""},{"location":"_archive/agent-semaphores-implementation-prompt/#semaphorereason-reasonpy","title":"SemaphoreReason (reason.py)","text":"<pre><code>from enum import Enum\n\nclass SemaphoreReason(Enum):\n    \"\"\"Why the agent yielded to human.\"\"\"\n    APPROVAL_NEEDED = \"approval_needed\"      # Sensitive action requiring explicit approval\n    CONTEXT_REQUIRED = \"context_required\"    # Agent needs info only human has\n    SENSITIVE_ACTION = \"sensitive_action\"    # Privacy/security implications\n    AMBIGUOUS_CHOICE = \"ambiguous_choice\"    # Multiple valid interpretations\n    RESOURCE_DECISION = \"resource_decision\"  # Resource allocation needed\n    ERROR_RECOVERY = \"error_recovery\"        # Error occurred, human guidance needed\n</code></pre>"},{"location":"_archive/agent-semaphores-implementation-prompt/#semaphoretoken-tokenpy","title":"SemaphoreToken (token.py)","text":"<pre><code>from dataclasses import dataclass, field\nfrom datetime import datetime\nfrom typing import Any, Generic, TypeVar\nimport uuid\n\nfrom .reason import SemaphoreReason\n\nR = TypeVar(\"R\")  # Required context type\n\n@dataclass\nclass SemaphoreToken(Generic[R]):\n    \"\"\"\n    The Red Card. Return this from an agent to flip red.\n\n    When a FluxAgent's inner.invoke() RETURNS this (not yields!),\n    the event is ejected to Purgatory until human provides context.\n\n    The Rodizio Pattern:\n    - Agent returns SemaphoreToken \u2192 FluxAgent detects \u2192 Eject to Purgatory\n    - Stream continues flowing (no head-of-line blocking)\n    - Human resolves \u2192 ReentryContext injected as Perturbation\n    - Agent.resume() completes processing\n    \"\"\"\n\n    # Identity\n    id: str = field(default_factory=lambda: f\"sem-{uuid.uuid4().hex[:8]}\")\n\n    # Why yielded\n    reason: SemaphoreReason = SemaphoreReason.CONTEXT_REQUIRED\n\n    # State preservation (CRITICAL: this is what makes it crash-safe)\n    frozen_state: bytes = b\"\"  # Pickled agent state at ejection\n    original_event: Any = None  # The event that triggered this semaphore\n\n    # Type hint for expected human input\n    required_type: type[R] | None = None\n\n    # Optional timing\n    deadline: datetime | None = None  # Auto-escalate after this\n    escalation: str | None = None     # Who to escalate to\n\n    # UI metadata (for CLI/TUI display)\n    prompt: str = \"\"                  # Human-readable question\n    options: list[str] = field(default_factory=list)  # Suggested responses\n    severity: str = \"info\"            # \"info\" | \"warning\" | \"critical\"\n\n    # Timestamps\n    created_at: datetime = field(default_factory=datetime.now)\n    resolved_at: datetime | None = None\n    cancelled_at: datetime | None = None\n\n    @property\n    def is_pending(self) -&gt; bool:\n        \"\"\"Check if token is still awaiting resolution.\"\"\"\n        return self.resolved_at is None and self.cancelled_at is None\n\n    @property\n    def is_resolved(self) -&gt; bool:\n        \"\"\"Check if token was resolved (not cancelled).\"\"\"\n        return self.resolved_at is not None\n\n    @property\n    def is_cancelled(self) -&gt; bool:\n        \"\"\"Check if token was cancelled.\"\"\"\n        return self.cancelled_at is not None\n</code></pre>"},{"location":"_archive/agent-semaphores-implementation-prompt/#reentrycontext-reentrypy","title":"ReentryContext (reentry.py)","text":"<pre><code>from dataclasses import dataclass\nfrom typing import Any, Generic, TypeVar\n\nR = TypeVar(\"R\")\n\n@dataclass\nclass ReentryContext(Generic[R]):\n    \"\"\"\n    The Green Card. Injected back into Flux as high-priority Perturbation.\n\n    When a human resolves a semaphore, this carries:\n    1. The frozen state from before ejection\n    2. The human's input/decision\n    3. Reference back to original event\n\n    The agent's resume() method receives this to complete processing.\n    \"\"\"\n\n    token_id: str\n    \"\"\"ID of the resolved SemaphoreToken.\"\"\"\n\n    frozen_state: bytes\n    \"\"\"Pickled state from before ejection. Agent unpickles to restore context.\"\"\"\n\n    human_input: R\n    \"\"\"What the human provided. Type should match token.required_type.\"\"\"\n\n    original_event: Any\n    \"\"\"The event that triggered the semaphore. For audit/debugging.\"\"\"\n\n    def __post_init__(self) -&gt; None:\n        \"\"\"Validate reentry context.\"\"\"\n        if not self.token_id:\n            raise ValueError(\"ReentryContext requires token_id\")\n</code></pre>"},{"location":"_archive/agent-semaphores-implementation-prompt/#purgatory-purgatorypy","title":"Purgatory (purgatory.py)","text":"<pre><code>from dataclasses import dataclass, field\nfrom datetime import datetime\nfrom typing import Any\n\nfrom .token import SemaphoreToken\nfrom .reentry import ReentryContext\n\n@dataclass\nclass Purgatory:\n    \"\"\"\n    The waiting room for ejected events.\n\n    Crash-resistant: survives server restarts via D-gent backing (Phase 3).\n    For Phase 1, in-memory only.\n\n    Key insight: We pickle DATA (frozen_state), not GENERATORS.\n    This is what makes Purgatory crash-safe when D-gent is wired.\n\n    Usage:\n        purgatory = Purgatory()\n\n        # Agent returns SemaphoreToken, FluxAgent detects and ejects\n        await purgatory.save(token)\n\n        # Stream continues, human eventually resolves\n        reentry = await purgatory.resolve(token.id, human_input)\n\n        # reentry is injected as Perturbation\n        # Agent.resume() receives it\n    \"\"\"\n\n    _pending: dict[str, SemaphoreToken] = field(default_factory=dict)\n    _memory: Any = None  # D-gent memory adapter (Phase 3)\n\n    async def save(self, token: SemaphoreToken) -&gt; None:\n        \"\"\"\n        Eject an event to Purgatory.\n\n        Called by FluxAgent when inner.invoke() returns SemaphoreToken.\n        \"\"\"\n        self._pending[token.id] = token\n        if self._memory:\n            await self._persist()\n\n    async def resolve(\n        self,\n        token_id: str,\n        human_input: Any\n    ) -&gt; ReentryContext | None:\n        \"\"\"\n        Resolve a pending semaphore with human-provided context.\n\n        Returns ReentryContext to be injected as Perturbation.\n        Returns None if token not found or already resolved.\n        \"\"\"\n        token = self._pending.get(token_id)\n        if token is None:\n            return None\n        if not token.is_pending:\n            return None\n\n        token.resolved_at = datetime.now()\n\n        reentry = ReentryContext(\n            token_id=token_id,\n            frozen_state=token.frozen_state,\n            human_input=human_input,\n            original_event=token.original_event,\n        )\n\n        if self._memory:\n            await self._persist()\n\n        return reentry\n\n    async def cancel(self, token_id: str) -&gt; bool:\n        \"\"\"\n        Cancel a pending semaphore. Event is discarded.\n\n        Returns True if cancelled, False if not found or already resolved.\n        \"\"\"\n        token = self._pending.get(token_id)\n        if token is None:\n            return False\n        if not token.is_pending:\n            return False\n\n        token.cancelled_at = datetime.now()\n\n        if self._memory:\n            await self._persist()\n\n        return True\n\n    def get(self, token_id: str) -&gt; SemaphoreToken | None:\n        \"\"\"Get a token by ID (any state).\"\"\"\n        return self._pending.get(token_id)\n\n    def list_pending(self) -&gt; list[SemaphoreToken]:\n        \"\"\"List all pending (unresolved) semaphores.\"\"\"\n        return [t for t in self._pending.values() if t.is_pending]\n\n    def list_all(self) -&gt; list[SemaphoreToken]:\n        \"\"\"List all semaphores (any state).\"\"\"\n        return list(self._pending.values())\n\n    async def recover(self) -&gt; list[SemaphoreToken]:\n        \"\"\"\n        Recover pending semaphores after restart.\n\n        Called during FluxAgent initialization (Phase 3).\n        For Phase 1, returns empty list (no persistence).\n        \"\"\"\n        if self._memory:\n            state = await self._memory.load()\n            if state:\n                self._pending = state.get(\"pending\", {})\n        return self.list_pending()\n\n    def clear(self) -&gt; None:\n        \"\"\"Clear all tokens (for testing).\"\"\"\n        self._pending.clear()\n\n    async def _persist(self) -&gt; None:\n        \"\"\"Persist state to D-gent (Phase 3).\"\"\"\n        if self._memory:\n            await self._memory.save({\"pending\": self._pending})\n</code></pre>"},{"location":"_archive/agent-semaphores-implementation-prompt/#test-requirements","title":"Test Requirements","text":""},{"location":"_archive/agent-semaphores-implementation-prompt/#test_tokenpy","title":"test_token.py","text":"<p>Test SemaphoreToken: - Creation with defaults generates valid ID - <code>is_pending</code> True initially, False after resolve/cancel - <code>is_resolved</code> and <code>is_cancelled</code> mutually exclusive - Severity values: \"info\", \"warning\", \"critical\" - Options list preserved - Prompt string preserved - frozen_state can hold pickled data</p>"},{"location":"_archive/agent-semaphores-implementation-prompt/#test_reentrypy","title":"test_reentry.py","text":"<p>Test ReentryContext: - Requires token_id (ValueError if empty) - Preserves frozen_state bytes - Preserves human_input of various types - Preserves original_event</p>"},{"location":"_archive/agent-semaphores-implementation-prompt/#test_purgatorypy","title":"test_purgatory.py","text":"<p>Test Purgatory: - <code>save()</code> stores token by ID - <code>list_pending()</code> returns only pending tokens - <code>resolve()</code> marks token resolved and returns ReentryContext - <code>resolve()</code> returns None for already-resolved token - <code>resolve()</code> returns None for unknown ID - <code>cancel()</code> marks token cancelled - <code>cancel()</code> returns False for already-resolved token - <code>get()</code> returns token regardless of state - <code>list_all()</code> returns all tokens - <code>clear()</code> removes all tokens</p>"},{"location":"_archive/agent-semaphores-implementation-prompt/#integration-test-in-test_purgatorypy","title":"Integration Test (in test_purgatory.py)","text":"<pre><code>async def test_round_trip():\n    \"\"\"Full round-trip: create \u2192 save \u2192 resolve \u2192 reentry.\"\"\"\n    import pickle\n\n    purgatory = Purgatory()\n\n    # Simulate agent state at ejection\n    agent_state = {\"partial_result\": \"halfway there\", \"step\": 3}\n    frozen = pickle.dumps(agent_state)\n\n    # Create token\n    token = SemaphoreToken(\n        reason=SemaphoreReason.APPROVAL_NEEDED,\n        frozen_state=frozen,\n        original_event=\"delete_records\",\n        prompt=\"Delete 47 records?\",\n        options=[\"Approve\", \"Reject\", \"Review\"],\n        severity=\"critical\",\n    )\n\n    # Eject to purgatory\n    await purgatory.save(token)\n    assert len(purgatory.list_pending()) == 1\n\n    # Human resolves\n    reentry = await purgatory.resolve(token.id, \"Approve\")\n\n    assert reentry is not None\n    assert reentry.token_id == token.id\n    assert reentry.human_input == \"Approve\"\n    assert reentry.original_event == \"delete_records\"\n\n    # Restore agent state\n    restored = pickle.loads(reentry.frozen_state)\n    assert restored[\"partial_result\"] == \"halfway there\"\n    assert restored[\"step\"] == 3\n\n    # Token no longer pending\n    assert len(purgatory.list_pending()) == 0\n    assert token.is_resolved\n</code></pre>"},{"location":"_archive/agent-semaphores-implementation-prompt/#technical-constraints","title":"Technical Constraints","text":"<p>From <code>spec/principles.md</code> and codebase conventions:</p> <ol> <li>Python 3.12+: Use <code>Generic[R]</code> pattern, not <code>class Foo[R]:</code></li> <li>Mypy strict: 0 errors required. Run <code>uv run mypy .</code> after every file.</li> <li>Imports: Prefer absolute (<code>from agents.flux.semaphore import ...</code>)</li> <li>Tests: Place in <code>_tests/</code> subdirectory with <code>test_</code> prefix</li> <li>No bloat: Keep files focused. Each file does one thing.</li> <li>Serialization: <code>frozen_state</code> is bytes (pickle). Token itself should be JSON-serializable for Phase 3.</li> </ol>"},{"location":"_archive/agent-semaphores-implementation-prompt/#validation-commands","title":"Validation Commands","text":"<p>Run these after each file:</p> <pre><code>cd /Users/kentgang/git/kgents/impl/claude\n\n# Type check\nuv run mypy agents/flux/semaphore/\n\n# Run tests\nuv run pytest agents/flux/semaphore/_tests/ -v\n\n# Full validation (before committing)\nuv run mypy .\nuv run pytest -m \"not slow\" -q\n</code></pre>"},{"location":"_archive/agent-semaphores-implementation-prompt/#what-not-to-do","title":"What NOT To Do","text":"<ol> <li>Don't implement Flux integration \u2014 That's Phase 2</li> <li>Don't implement D-gent persistence \u2014 That's Phase 3</li> <li>Don't implement AGENTESE paths \u2014 That's Phase 4</li> <li>Don't implement CLI \u2014 That's Phase 5</li> <li>Don't use generators \u2014 We RETURN tokens, not YIELD them</li> <li>Don't add timeouts by default \u2014 Rodizio is INDEFINITE; deadline is opt-in</li> <li>Don't poll \u2014 Purgatory doesn't poll; resolution is explicit</li> </ol>"},{"location":"_archive/agent-semaphores-implementation-prompt/#session-workflow","title":"Session Workflow","text":"<ol> <li>Read the required documents listed above</li> <li>Create the directory structure</li> <li>Implement <code>reason.py</code> first (simplest)</li> <li>Implement <code>token.py</code> with tests</li> <li>Implement <code>reentry.py</code> with tests</li> <li>Implement <code>purgatory.py</code> with tests</li> <li>Write the integration test</li> <li>Run full validation</li> <li>Do NOT commit \u2014 leave for human review</li> </ol>"},{"location":"_archive/agent-semaphores-implementation-prompt/#success-criteria","title":"Success Criteria","text":"Metric Target Files created 8 (4 impl + 4 test) Mypy errors 0 Test coverage All public methods tested Integration test Round-trip works"},{"location":"_archive/agent-semaphores-implementation-prompt/#questions-to-consider-while-implementing","title":"Questions to Consider While Implementing","text":"<ol> <li>Should <code>SemaphoreToken</code> have a <code>__hash__</code> for use in sets?</li> <li>Should <code>Purgatory</code> emit events when tokens change state?</li> <li>What happens if <code>resolve()</code> is called twice with different inputs?</li> <li>Should cancelled tokens be removed from <code>_pending</code> or just marked?</li> </ol> <p>Document your decisions in code comments.</p>"},{"location":"_archive/agent-semaphores-implementation-prompt/#after-phase-1-complete","title":"After Phase 1 Complete","text":"<p>Update <code>plans/agents/semaphores.md</code>: - Change <code>progress: 0</code> to <code>progress: 20</code> - Add session notes about what was implemented - Update <code>last_touched</code> date</p> <p>Update <code>plans/_status.md</code>: - Mark Phase 1 as complete</p> <p>\"The card speaks. The gaucho listens. The purgatory remembers. This is the protocol.\"</p>"},{"location":"_archive/agent-semaphores-qa-prompt/","title":"Agent Semaphores: QA &amp; Integration Prompt","text":"<p>Use this prompt with <code>/hydrate</code> to complete Agent Semaphores integration.</p>"},{"location":"_archive/agent-semaphores-qa-prompt/#session-context","title":"Session Context","text":"<p>Date: 2025-12-12 Status: Phases 1-5 complete (138 tests), QA integration remaining Progress: 95% \u2192 target 100%</p>"},{"location":"_archive/agent-semaphores-qa-prompt/#what-was-built","title":"What Was Built","text":"<p>All core functionality is implemented and tested:</p> <ol> <li>Core Types (<code>agents/flux/semaphore/</code>):</li> <li><code>SemaphoreToken</code> with JSON serialization, deadline checking</li> <li><code>ReentryContext</code> for resumption</li> <li><code>Purgatory</code> in-memory store with pheromone emission</li> <li><code>DurablePurgatory</code> with D-gent persistence</li> <li> <p><code>SemaphoreMixin</code> and <code>SemaphoreCapable</code> protocol</p> </li> <li> <p>AGENTESE Paths (<code>protocols/agentese/contexts/</code>):</p> </li> <li><code>self.semaphore.pending/yield/status</code></li> <li> <p><code>world.purgatory.list/resolve/cancel/inspect/void_expired</code></p> </li> <li> <p>CLI Handler (<code>protocols/cli/handlers/semaphore.py</code>):</p> </li> <li><code>kgents semaphore list/resolve/cancel/inspect/void</code></li> </ol>"},{"location":"_archive/agent-semaphores-qa-prompt/#qa-tasks","title":"QA Tasks","text":""},{"location":"_archive/agent-semaphores-qa-prompt/#1-agentese-path-tests","title":"1. AGENTESE Path Tests","text":"<p>Create <code>protocols/agentese/contexts/_tests/test_semaphore_paths.py</code>:</p> <pre><code># Test self.semaphore.pending returns empty list without purgatory\n# Test self.semaphore.yield creates token when purgatory configured\n# Test self.semaphore.status returns token details\n# Test world.purgatory.list returns pending tokens\n# Test world.purgatory.resolve requires token_id and human_input\n# Test world.purgatory.cancel marks token as cancelled\n# Test world.purgatory.inspect returns full token details\n# Test world.purgatory.void_expired voids past-deadline tokens\n# Test affordance filtering (admin vs non-admin)\n</code></pre>"},{"location":"_archive/agent-semaphores-qa-prompt/#2-cli-handler-tests","title":"2. CLI Handler Tests","text":"<p>Create <code>protocols/cli/handlers/_tests/test_semaphore.py</code>:</p> <pre><code># Test cmd_semaphore with --help\n# Test cmd_semaphore list with empty purgatory\n# Test cmd_semaphore list with pending tokens\n# Test cmd_semaphore resolve with --input flag\n# Test cmd_semaphore cancel\n# Test cmd_semaphore inspect\n# Test cmd_semaphore void\n# Test --json output mode\n# Test error cases (missing token_id, not found, etc.)\n</code></pre>"},{"location":"_archive/agent-semaphores-qa-prompt/#3-end-to-end-integration-test","title":"3. End-to-End Integration Test","text":"<p>Create <code>agents/flux/semaphore/_tests/test_e2e_integration.py</code>:</p> <pre><code># Test full rodizio flow:\n# 1. FluxAgent processes event\n# 2. Agent returns SemaphoreToken (needs approval)\n# 3. Token ejected to DurablePurgatory\n# 4. Stream continues processing other events\n# 5. Human resolves via CLI/AGENTESE\n# 6. ReentryContext injected as perturbation\n# 7. Agent resumes with human input\n</code></pre>"},{"location":"_archive/agent-semaphores-qa-prompt/#4-cortex-daemon-integration","title":"4. Cortex Daemon Integration","text":"<p>Wire CLI handler to shared Purgatory:</p> <p>Current (<code>protocols/cli/handlers/semaphore.py:188-206</code>): <pre><code># Module-level purgatory instance (singleton for CLI session)\n_purgatory_instance: Any = None\n\ndef _get_purgatory() -&gt; Any:\n    global _purgatory_instance\n    if _purgatory_instance is None:\n        _purgatory_instance = Purgatory()  # In-memory only!\n    return _purgatory_instance\n</code></pre></p> <p>Target: Get from Cortex daemon context: <pre><code>def _get_purgatory() -&gt; Any:\n    from protocols.cli.hollow import get_cortex\n    cortex = get_cortex()\n    return cortex.purgatory  # Shared DurablePurgatory\n</code></pre></p>"},{"location":"_archive/agent-semaphores-qa-prompt/#validation-commands","title":"Validation Commands","text":"<pre><code>cd /Users/kentgang/git/kgents/impl/claude\n\n# Run all semaphore tests\nuv run pytest agents/flux/semaphore/_tests/ -v\n\n# Run AGENTESE context tests (when created)\nuv run pytest protocols/agentese/contexts/_tests/test_semaphore_paths.py -v\n\n# Run CLI handler tests (when created)\nuv run pytest protocols/cli/handlers/_tests/test_semaphore.py -v\n\n# Type check\nuv run mypy agents/flux/semaphore/ protocols/cli/handlers/semaphore.py\n\n# Full validation\nuv run pytest -m \"not slow\" -q\n</code></pre>"},{"location":"_archive/agent-semaphores-qa-prompt/#files-to-create","title":"Files to Create","text":"<pre><code>protocols/agentese/contexts/_tests/test_semaphore_paths.py  # AGENTESE path tests\nprotocols/cli/handlers/_tests/test_semaphore.py            # CLI handler tests\nagents/flux/semaphore/_tests/test_e2e_integration.py       # End-to-end test\n</code></pre>"},{"location":"_archive/agent-semaphores-qa-prompt/#files-to-modify","title":"Files to Modify","text":"<pre><code>protocols/cli/handlers/semaphore.py   # Wire to Cortex daemon\n</code></pre>"},{"location":"_archive/agent-semaphores-qa-prompt/#success-criteria","title":"Success Criteria","text":"<ul> <li> All AGENTESE path tests pass</li> <li> All CLI handler tests pass</li> <li> End-to-end integration test passes</li> <li> CLI reads from Cortex daemon's shared Purgatory</li> <li> mypy passes on all new/modified files</li> <li> Update <code>plans/agents/semaphores.md</code> to 100%</li> <li> Archive plan to <code>_archive/semaphores-v1.0-complete.md</code></li> </ul>"},{"location":"_archive/agent-semaphores-qa-prompt/#architecture-notes","title":"Architecture Notes","text":""},{"location":"_archive/agent-semaphores-qa-prompt/#purgatory-lifetime","title":"Purgatory Lifetime","text":"<p>The Purgatory instance should be: 1. Created by Cortex daemon on startup 2. Backed by D-gent (DurablePurgatory) for persistence 3. Recovered on restart via <code>create_and_recover_purgatory()</code> 4. Shared across CLI, AGENTESE, and Flux integration</p>"},{"location":"_archive/agent-semaphores-qa-prompt/#pheromone-integration","title":"Pheromone Integration","text":"<p>Purgatory emits pheromones for monitoring: - <code>purgatory.ejected</code> - Agent yielded, token in purgatory - <code>purgatory.resolved</code> - Human provided input - <code>purgatory.cancelled</code> - Token cancelled - <code>purgatory.voided</code> - Token expired past deadline</p> <p>These should be wired to the Cortex's signal system.</p> <p>\"The card speaks. The gaucho listens. The purgatory remembers. This is the protocol.\"</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/","title":"Agent Synergy Analysis: Critical Review &amp; Implementation Plan","text":"<p>\"The noun is a lie. There is only the rate of change.\"</p> <p>Date: 2025-12-12 Author: Claude Opus 4.5 (analysis agent) Scope: All 23 agents in <code>impl/claude/agents/</code> + recent K-Terrarium/K8s work</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#executive-summary","title":"Executive Summary","text":"<p>After thorough analysis of <code>spec/principles.md</code>, all agent implementations, and industry patterns, this document identifies:</p> <ol> <li>High-value simplifications derivable from principles</li> <li>Synergies between agents and Terrarium/K8s work</li> <li>Cross-agent integration opportunities</li> <li>Critical gaps relative to industry best practices</li> </ol> <p>Key Finding: The codebase has excellent categorical foundations (Composable principle) but under-leverages the Generative principle\u2014many implementations could be derived from specs rather than hand-written.</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#part-1-simplifications-derivable-from-principles","title":"Part 1: Simplifications Derivable from Principles","text":""},{"location":"_archive/agent-synergy-analysis-2025-12/#11-the-single-functor-consolidation","title":"1.1 The \"Single Functor\" Consolidation","text":"<p>Observation: Multiple agents implement functors that transform <code>Agent[A,B] \u2192 Agent[X,Y]</code>:</p> Agent Functor Transform C-gent <code>Maybe</code>, <code>Either</code>, <code>List</code>, <code>Async</code>, <code>Logged</code> Error handling, collection, async Flux <code>Flux</code> Discrete \u2192 Continuous K-gent <code>K</code> (planned) Identity \u2192 Personalized O-gent <code>Observer</code> Agent \u2192 Observed Agent B-gent <code>Metered</code> Agent \u2192 Metered Agent <p>Principle Violation: These are implemented independently despite sharing the same categorical structure.</p> <p>Simplification: Define a Universal Functor Protocol in <code>agents/a/functor.py</code>:</p> <pre><code>@runtime_checkable\nclass Functor(Protocol[F]):\n    \"\"\"All functors satisfy: F(id) = id, F(g \u2218 f) = F(g) \u2218 F(f)\"\"\"\n\n    @staticmethod\n    def lift(agent: Agent[A, B]) -&gt; Agent[F[A], F[B]]: ...\n\n    @staticmethod\n    def unlift(agent: Agent[F[A], F[B]]) -&gt; Agent[A, B]: ...\n</code></pre> <p>Then each functor becomes a derivation from this protocol. The Generative principle says we should be able to regenerate them from the spec.</p> <p>Impact: ~40% reduction in functor boilerplate, single place for law verification.</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#12-the-observer-unification","title":"1.2 The Observer Unification","text":"<p>Observation: Observation happens in multiple places: - O-gent: <code>TelemetryObserver</code>, <code>SemanticObserver</code>, <code>AxiologicalObserver</code> - W-gent: <code>WireObservable</code>, <code>TelemetryInterceptor</code> - N-gent: <code>Historian</code> (write-time observation) - Flux: <code>HolographicBuffer</code> (mirror protocol)</p> <p>Principle: AGENTESE says \"To observe is to act.\" All observation should route through a single mechanism.</p> <p>Simplification: Merge W-gent interceptors into O-gent's composite observer:</p> <pre><code>Before: W-gent.TelemetryInterceptor + O-gent.TelemetryObserver (duplication)\nAfter:  O-gent.TelemetryObserver (single source of truth)\n        W-gent uses O-gent via dependency injection\n</code></pre>"},{"location":"_archive/agent-synergy-analysis-2025-12/#13-the-state-management-pyramid","title":"1.3 The State Management Pyramid","text":"<p>Observation: D-gent has evolved into a complex hierarchy: - <code>VolatileAgent</code> \u2192 <code>PersistentAgent</code> \u2192 <code>CachedAgent</code> - <code>VectorAgent</code>, <code>GraphAgent</code>, <code>StreamAgent</code> (Noosphere) - <code>UnifiedMemory</code>, <code>BicameralMemory</code> (advanced patterns) - <code>Symbiont</code> (composition with pure logic)</p> <p>Principle Alignment: This is correctly Heterarchical (no fixed hierarchy), but violates Tasteful (\"avoid feature creep\").</p> <p>Simplification: Define 3 canonical memory modes: 1. Ephemeral (<code>VolatileAgent</code>) \u2014 fast, in-process 2. Durable (<code>PersistentAgent</code> + backends) \u2014 survives restart 3. Semantic (<code>VectorAgent</code> + <code>GraphAgent</code>) \u2014 knows meaning</p> <p>Everything else composes from these three. <code>Symbiont</code> becomes the universal adapter.</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#14-the-bootstrap-derivation-chain","title":"1.4 The Bootstrap Derivation Chain","text":"<p>Observation: <code>BootstrapWitness</code> verifies category laws, but this verification is scattered: - <code>agents/a/skeleton.py</code> \u2014 defines laws - <code>agents/o/bootstrap_witness.py</code> \u2014 verifies laws - <code>agents/t/law_validator.py</code> \u2014 validates in tests - <code>agents/c/contract_validator.py</code> \u2014 validates contracts</p> <p>Generative Principle: Laws should be defined once and verification should be derived.</p> <p>Simplification: Single <code>LawRegistry</code> that generates validators:</p> <pre><code># Define once\nCATEGORY_LAWS = LawRegistry()\nCATEGORY_LAWS.register(\"identity\", lambda f: Id &gt;&gt; f == f == f &gt;&gt; Id)\nCATEGORY_LAWS.register(\"associativity\", lambda f,g,h: (f &gt;&gt; g) &gt;&gt; h == f &gt;&gt; (g &gt;&gt; h))\n\n# Generate everywhere\ndef verify_for_agent(agent: Agent) -&gt; LawVerificationReport:\n    return CATEGORY_LAWS.verify_all(agent)\n</code></pre>"},{"location":"_archive/agent-synergy-analysis-2025-12/#part-2-synergies-with-k-terrarium-and-k8s-work","title":"Part 2: Synergies with K-Terrarium and K8s Work","text":""},{"location":"_archive/agent-synergy-analysis-2025-12/#21-terrarium-flux-integration-complete-needs-deepening","title":"2.1 Terrarium \u2194 Flux Integration (Complete, needs deepening)","text":"<p>Current State: Terrarium Phase 5 wires Flux events to the Mirror Protocol.</p> <p>Synergy Opportunity: The HolographicBuffer pattern from Terrarium should be promoted to a first-class abstraction:</p> <pre><code>agents/flux/mirror.py (new)\n\u251c\u2500\u2500 HolographicBuffer       # Broadcast without agent load\n\u251c\u2500\u2500 MirrorProtocol         # /observe vs /perturb distinction\n\u2514\u2500\u2500 attach_mirror()        # Standard attachment point\n</code></pre> <p>Why: Every FluxAgent benefits from observation without metabolic drain. This is the Heterarchical principle operationalized.</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#22-k8s-operator-k-gent-soul-integration","title":"2.2 K8s Operator \u2194 K-gent Soul Integration","text":"<p>Current State: - K8s operator deploys AgentServer CRDs - K-gent Soul intercepts semaphores (planned)</p> <p>Synergy Opportunity: K-gent should be the Governance Functor for K8s deployments:</p> <pre><code># agentserver-crd.yaml\nspec:\n  governance:\n    soul:\n      enabled: true\n      interceptPrinciples:\n        - spec/principles.md\n      budgetTier: DIALOGUE  # Cost cap for K-gent decisions\n</code></pre> <p>When the operator reconciles, K-gent validates that the deployment doesn't violate principles.</p> <p>This is the \"Semantic Gatekeeper\" capability from the K-gent plan.</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#23-terrarium-dashboard-i-gent-density-fields","title":"2.3 Terrarium Dashboard \u2194 I-gent Density Fields","text":"<p>Current State: - I-gent has DensityField widgets - Terrarium serves agents over WebSocket</p> <p>Synergy: I-gent widgets should be served through Terrarium, not just rendered in CLI:</p> <pre><code>Browser \u2192 ws://terrarium/observe/agent-id \u2192 DensityField data \u2192 Textual-web\n</code></pre> <p>This enables remote observation of the Semantic Flux\u2014Kent's wish for \"more interactivity.\"</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#24-purgatory-semaphores-k-gent-rodizio-sommelier","title":"2.4 Purgatory (Semaphores) \u2194 K-gent Rodizio Sommelier","text":"<p>Current State: - Agent Semaphores (Rodizio pattern) complete with 182 tests - K-gent <code>intercept()</code> is keyword-based (dangerous)</p> <p>Synergy: K-gent should be the default interceptor for Purgatory semaphores:</p> <pre><code># When semaphore is ejected to Purgatory\nasync def on_semaphore_ejected(token: SemaphoreToken):\n    # K-gent evaluates based on principles, not keywords\n    decision = await kgent.soul.intercept(token)\n    if decision.auto_resolve:\n        await purgatory.resolve(token, decision.context)\n    else:\n        await purgatory.await_human(token)  # Kent decides\n</code></pre> <p>Impact: K-gent becomes the nervous system connecting Terrarium (presence), Purgatory (decisions), and Flux (streams).</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#part-3-cross-agent-integration-opportunities","title":"Part 3: Cross-Agent Integration Opportunities","text":""},{"location":"_archive/agent-synergy-analysis-2025-12/#31-the-triple-brain-l-gent-d-gent-e-gent","title":"3.1 The Triple Brain (L-gent + D-gent + E-gent)","text":"<p>Current State: - L-gent has <code>QueryFusion</code> (keyword + semantic + graph) - D-gent has <code>VectorAgent</code> for semantic search - E-gent has <code>ViralLibrary</code> for mutation patterns</p> <p>Integration Opportunity: Unify into Cognitive Search:</p> <pre><code>User query \u2192 L-gent.QueryFusion\n    \u2193\n\u251c\u2500\u2500 Keyword brain (L-gent.Search)\n\u251c\u2500\u2500 Semantic brain (D-gent.VectorAgent)\n\u251c\u2500\u2500 Graph brain (L-gent.LineageGraph + TypeLattice)\n\u2514\u2500\u2500 Evolution brain (E-gent.ViralLibrary)  \u2190 NEW\n</code></pre> <p>E-gent patterns become searchable. \"Find mutations that improved error handling\" becomes a query.</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#32-the-economic-backbone-b-gent-o-gent-j-gent","title":"3.2 The Economic Backbone (B-gent + O-gent + J-gent)","text":"<p>Current State: - B-gent: Value Tensor, Metered functor, VoI economics - O-gent: Dimension Z (Axiology) observes economics - J-gent: <code>SharedEntropyBudget</code> for depth computation</p> <p>Integration Opportunity: Unified Value Accounting should be a shared service:</p> <pre><code># Single accounting service used by all\nclass UnifiedValueService:\n    ledger: ValueLedger       # B-gent owns\n    observer: AxiologicalObserver  # O-gent observes\n    budget: SharedEntropyBudget    # J-gent computes depth\n\n    async def transact(self, agent_id: str, cost: ValueTensor) -&gt; Receipt:\n        # Single transaction path with observation built-in\n</code></pre>"},{"location":"_archive/agent-synergy-analysis-2025-12/#33-the-narrative-pipeline-n-gent-w-gent-i-gent","title":"3.3 The Narrative Pipeline (N-gent + W-gent + I-gent)","text":"<p>Current State: - N-gent: Historian (crystals), Bard (storytelling) - W-gent: Wire protocol, fidelity levels - I-gent: Visualization (DensityField, FlowArrow)</p> <p>Integration Opportunity: Automated Storytelling Dashboard:</p> <pre><code>N-gent.Historian (crystals)\n    \u2192 W-gent.LiveWire (streaming)\n    \u2192 I-gent.Narrative widget (visualization)\n    \u2192 Terrarium/observe (remote access)\n</code></pre> <p>When an agent runs, its execution trace automatically becomes a visual story.</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#34-the-grammar-ecosystem-g-gent-b-gent-t-gent","title":"3.4 The Grammar Ecosystem (G-gent + B-gent + T-gent)","text":"<p>Current State: - G-gent: Tongue synthesis, pattern inference - B-gent: Syntax Tax, Grammar Insurance, JIT Efficiency - T-gent: Fuzzing integration for tongues</p> <p>This is already well-integrated (B\u00d7G phases 1-6).</p> <p>Enhancement: Add K-gent governance to tongue creation:</p> <pre><code># Before registering a new Tongue\nsoul_check = await kgent.soul.validate(tongue.grammar)\nif soul_check.violates_principles:\n    # K-gent explains why this grammar is problematic\n    raise TongueRejected(soul_check.reasoning)\n</code></pre>"},{"location":"_archive/agent-synergy-analysis-2025-12/#part-4-industry-pattern-comparison","title":"Part 4: Industry Pattern Comparison","text":""},{"location":"_archive/agent-synergy-analysis-2025-12/#41-comparison-with-langgraphcrewaiautogen","title":"4.1 Comparison with LangGraph/CrewAI/AutoGen","text":"Pattern Industry Status kgents Status Gap Graph-based workflow LangGraph core Flux pipeline Flux is streams, not graphs. Consider graph overlay. Role-based agents CrewAI core Partial (K-gent persona) K-gent could define roles not just personality Conversational agents AutoGen core N-gent Bard Bard is storytelling, not conversation Supervisor pattern All frameworks W-gent MiddlewareBus Good alignment Agents as Tools AWS pattern U-gent Good alignment <p>Key Gap: kgents lacks an explicit Group Chat pattern where multiple agents collaborate conversationally. The closest is N-gent's Chronicle (multi-agent crystals), but that's recording, not collaboration.</p> <p>Recommendation: Add <code>agents/m/chorus.py</code> \u2014 Multi-agent conversation orchestration using the Slack puppet from <code>spec/principles.md</code>.</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#42-comparison-with-k8s-ai-patterns","title":"4.2 Comparison with K8s AI Patterns","text":"Pattern Industry (2025) kgents Status Gap AI-Augmented Reconciliation Emerging Not present K-gent could predict scaling needs Self-healing operators Kagent, GKE AgentServer CRD exists Needs health probe integration Agent Sandbox Google Agent Dev Kit J-gent Sandbox exists Good alignment Multi-cluster federation Standard Single cluster Future consideration <p>Key Gap: kgents K8s work is CRD-focused but lacks AI-augmented reconciliation. The operator applies manifests but doesn't predict or self-heal.</p> <p>Recommendation: Wire O-gent observation into the kopf handlers:</p> <pre><code>@kopf.on.timer('kgents.io', 'v1', 'agentservers', interval=60)\nasync def health_probe(spec, status, **kwargs):\n    # O-gent observes, K-gent predicts, operator acts\n    health = await ogent.panopticon.snapshot()\n    if health.prediction.scaling_needed:\n        await scale_deployment(spec['name'], health.recommendation)\n</code></pre>"},{"location":"_archive/agent-synergy-analysis-2025-12/#part-5-implementation-roadmap","title":"Part 5: Implementation Roadmap","text":""},{"location":"_archive/agent-synergy-analysis-2025-12/#phase-1-foundation-consolidation-week-1-2","title":"Phase 1: Foundation Consolidation (Week 1-2)","text":"Task Files Principles Universal Functor Protocol <code>agents/a/functor.py</code> Generative Single LawRegistry <code>agents/a/laws.py</code> Generative, Composable Observer unification Merge W-gent \u2192 O-gent Tasteful Memory mode canonicalization D-gent refactor Tasteful"},{"location":"_archive/agent-synergy-analysis-2025-12/#phase-2-k-gent-nervous-system-week-2-3","title":"Phase 2: K-gent Nervous System (Week 2-3)","text":"Task Files Principles LLM-backed dialogue <code>agents/k/persona.py</code> Joy-Inducing Deep intercept (principle-based) <code>agents/k/soul.py</code> Ethical Purgatory integration <code>agents/k/purgatory.py</code> Heterarchical Audit trail <code>agents/k/audit.py</code> Transparent Infrastructure"},{"location":"_archive/agent-synergy-analysis-2025-12/#phase-3-terrarium-deepening-week-3-4","title":"Phase 3: Terrarium Deepening (Week 3-4)","text":"Task Files Principles Promote HolographicBuffer <code>agents/flux/mirror.py</code> Composable I-gent widget serving <code>protocols/terrarium/widgets.py</code> Joy-Inducing K-gent dashboard <code>protocols/terrarium/soul.py</code> Heterarchical"},{"location":"_archive/agent-synergy-analysis-2025-12/#phase-4-cross-agent-pipelines-week-4-5","title":"Phase 4: Cross-Agent Pipelines (Week 4-5)","text":"Task Files Principles Cognitive Search (L+D+E) <code>agents/l/cognitive.py</code> Generative Unified Value Service (B+O+J) <code>agents/b/unified.py</code> Composable Narrative Dashboard (N+W+I) <code>agents/n/dashboard.py</code> Joy-Inducing"},{"location":"_archive/agent-synergy-analysis-2025-12/#phase-5-k8s-ai-augmentation-week-5-6","title":"Phase 5: K8s AI Augmentation (Week 5-6)","text":"Task Files Principles Health probe with O-gent <code>infra/k8s/operators/health.py</code> Graceful Degradation K-gent governance for CRDs <code>infra/k8s/operators/governance.py</code> Ethical Self-healing reconciliation <code>infra/k8s/operators/heal.py</code> Heterarchical"},{"location":"_archive/agent-synergy-analysis-2025-12/#part-6-risk-assessment","title":"Part 6: Risk Assessment","text":""},{"location":"_archive/agent-synergy-analysis-2025-12/#high-risk-k-gent-llm-costs","title":"High Risk: K-gent LLM Costs","text":"<p>Issue: DIALOGUE tier at 100 calls/day = $36/month. If K-gent intercepts every semaphore, costs explode.</p> <p>Mitigation: 1. Template system for common patterns (zero cost) 2. Budget caps per agent class 3. Batching low-priority intercepts</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#medium-risk-observer-performance","title":"Medium Risk: Observer Performance","text":"<p>Issue: Universal observation could add latency to every agent call.</p> <p>Mitigation: 1. Zero-copy observation (HolographicBuffer pattern) 2. Sampling for high-frequency agents 3. Opt-in observation (not default)</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#low-risk-functor-consolidation-breakage","title":"Low Risk: Functor Consolidation Breakage","text":"<p>Issue: Changing functor structure could break existing code.</p> <p>Mitigation: 1. Backward-compat aliases 2. Gradual migration with deprecation warnings 3. Extensive test coverage already exists (9,348 tests)</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#conclusion","title":"Conclusion","text":"<p>The kgents codebase has strong categorical foundations and excellent test coverage. The key opportunities are:</p> <ol> <li>Leverage Generativity: Many implementations are hand-written that could be derived from specs</li> <li>Wire K-gent as the Nervous System: Connect Terrarium, Purgatory, and Flux through K-gent governance</li> <li>Deepen Terrarium: Make the Web gateway a first-class observation point for all agents</li> <li>Add AI-Augmented K8s: The operator should predict and self-heal, not just apply</li> </ol> <p>The meta-insight: The noun is a lie. The agents aren't static entities\u2014they're rates of change in a flux topology. The implementation should reflect this more directly.</p> <p>\"The skeleton exists. The nervous system requires wiring.\"</p>"},{"location":"_archive/agent-synergy-analysis-2025-12/#references","title":"References","text":"<ul> <li>Speakeasy: Architecture Patterns for Agentic Apps</li> <li>Microsoft Azure: AI Agent Design Patterns</li> <li>Google Cloud: Agentic AI Design Patterns</li> <li>DataCamp: CrewAI vs LangGraph vs AutoGen</li> <li>OuterByte: Kubernetes Operators 2025</li> <li>Google Cloud Blog: Agentic AI on Kubernetes</li> <li>Kagent: Agentic AI for Cloud Native</li> </ul>"},{"location":"_archive/exploration-categorical-consolidation/","title":"Exploration: Categorical Consolidation &amp; Isomorphism Unification","text":"<p>\"The system is beginning to buckle under asymmetric lifting and fragmented composition frameworks.\"</p> <p>Date: 2025-12-12 Author: Deep exploration agent (Opus 4.5) Focus: Architecture unification, functor consolidation, composition algebra</p>"},{"location":"_archive/exploration-categorical-consolidation/#executive-summary","title":"Executive Summary","text":"<p>After comprehensive exploration of 27+ agent modules, 7,293 lines of AGENTESE protocol code, and 9,778+ tests, this document identifies structural isomorphisms awaiting unification and architectural tensions that limit composability.</p> <p>The core insight: kgents has achieved sophisticated categorical foundations (agents as morphisms, functors for lifting), but has hit a scale limit around 27+ agent types. The system needs algebraic consolidation to scale further without redundancy.</p>"},{"location":"_archive/exploration-categorical-consolidation/#part-i-the-functor-landscape","title":"Part I: The Functor Landscape","text":""},{"location":"_archive/exploration-categorical-consolidation/#current-state-7-active-functors","title":"Current State: 7 Active Functors","text":"Functor Domain Lift Unlift Law-Verified MaybeFunctor Effect (Optional) Yes No Yes EitherFunctor Effect (Error) Yes No Yes ListFunctor Effect (Collection) Yes No Yes AsyncFunctor Effect (Async) Yes No Yes LoggedFunctor Effect (Logging) Yes No Yes FixFunctor Effect (Retry) Yes No Yes FluxFunctor Domain (Streaming) Yes Yes Yes* SoulFunctor Domain (Persona) Yes Yes Yes* <p>The Asymmetry Problem: C-gent functors (Maybe, Either, List) lift agents into their domain but provide no way back. This breaks monad transformer composition:</p> <pre><code># Works\nmaybe_agent = MaybeFunctor.lift(agent)  # Agent[A,B] -&gt; Agent[Maybe[A], Maybe[B]]\n\n# Stuck! No unlift\n# MaybeFunctor.unlift(maybe_agent)  # Does not exist\n\n# Can't compose effects naturally\n# Maybe(Either(agent)) is a type mismatch without proper unlift\n</code></pre>"},{"location":"_archive/exploration-categorical-consolidation/#missing-standard-functors","title":"Missing Standard Functors","text":"<p>From category theory, these standard patterns are unimplemented:</p> Pattern Signature Use Case Reader <code>Reader[E, A] = E -&gt; A</code> D-gent context passing State <code>State[S, A] = S -&gt; (A, S)</code> Stateful computation (D-gent already implements protocol, needs functor form) Cont <code>Cont[R, A]</code> Control flow patterns Writer <code>Writer[W, A] = (A, W)</code> Accumulated logging"},{"location":"_archive/exploration-categorical-consolidation/#part-ii-the-agentese-gap-analysis","title":"Part II: The AGENTESE Gap Analysis","text":""},{"location":"_archive/exploration-categorical-consolidation/#implemented-vs-specified-contexts","title":"Implemented vs. Specified Contexts","text":"Context Spec Coverage Impl Coverage Gap <code>world.*</code> Full Full Minor: JIT semantics <code>self.*</code> Full 80% Critical: <code>self.soul.*</code> missing <code>concept.*</code> Full Full None <code>void.*</code> Full 70% <code>void.dream.*</code>, <code>void.slop.*</code> <code>time.*</code> Full Full None"},{"location":"_archive/exploration-categorical-consolidation/#the-selfsoul-gap-critical","title":"The self.soul Gap (Critical)","text":"<p>K-gent's soul handler (<code>protocols/cli/handlers/soul.py</code>, 700+ lines) provides: - <code>cmd_soul</code>, <code>cmd_reflect</code>, <code>cmd_advise</code>, <code>cmd_challenge</code>, <code>cmd_explore</code> - Modes: reflect, advise, challenge, explore - Features: Starters, manifest, eigenvectors, audit, garden, dream</p> <p>But: This is CLI-only. No AGENTESE path exists for: <pre><code>self.soul.manifest      -&gt; Show soul state\nself.soul.reflect       -&gt; Introspection mode\nself.soul.advise        -&gt; Preference-aligned guidance\nself.soul.eigenvectors  -&gt; Personality coordinates\n</code></pre></p> <p>Impact: K-gent cannot be invoked programmatically via Logos. Agents can't query or compose with the soul.</p>"},{"location":"_archive/exploration-categorical-consolidation/#cli-agentese-routing-gap","title":"CLI-AGENTESE Routing Gap","text":"<p>15+ CLI handlers bypass AGENTESE entirely:</p> Handler Expected Path Status soul.py self.soul.* Missing node semaphore.py self.semaphore.* Handler exists, doesn't use Logos status.py self.state.manifest Direct impl flinch.py void.slippage.* Not defined signal.py self.alarm.fire Not defined companions.py Multiple (pulse, breathe, ground) None routed forest.py self.plan.reconcile Not integrated <p>Pattern: The CLI bypasses the semantic layer, preventing agent composition.</p>"},{"location":"_archive/exploration-categorical-consolidation/#part-iii-identified-isomorphisms","title":"Part III: Identified Isomorphisms","text":""},{"location":"_archive/exploration-categorical-consolidation/#isomorphism-1-all-wrapped-agents","title":"Isomorphism 1: All Wrapped Agents","text":"<p>Every lifted agent follows the same structure:</p> <pre><code>class XAgent(Agent[Wrapped[A], Wrapped[B]]):\n    def __init__(self, inner: Agent[A, B]): ...\n    async def invoke(self, input: Wrapped[A]) -&gt; Wrapped[B]: ...\n</code></pre> <p>Instances: MaybeAgent, EitherAgent, FluxAgent, SoulAgent, Symbiont</p> <p>Unification: Create <code>WrappedAgent[F, A, B]</code> base class where F is the functor family.</p>"},{"location":"_archive/exploration-categorical-consolidation/#isomorphism-2-observer-patterns","title":"Isomorphism 2: Observer Patterns","text":"<p>Three independent observation systems:</p> System Location Purpose O-gents <code>o/observer.py</code> Generic wrapping N-gents <code>n/historian.py</code> Trace collection T-gents <code>t/spy.py</code> Test instrumentation <p>All do the same thing: Observe agent invocations without mutation.</p> <p>Unification: Single <code>ObserverFunctor</code> that lifts agents to observed domain.</p>"},{"location":"_archive/exploration-categorical-consolidation/#isomorphism-3-d-gent-state-monad","title":"Isomorphism 3: D-gent \u2245 State Monad","text":"<p>D-gent protocol: <pre><code>async def load(self) -&gt; S      # Read: Unit -&gt; S\nasync def save(self, s: S)     # Write: S -&gt; Unit\n</code></pre></p> <p>This is isomorphic to <code>State[S, A] = S -&gt; (A, S)</code>.</p> <p>Unification: Expose D-gents as <code>StateMonad.lift(agent)</code>, enabling natural composition with Flux.</p>"},{"location":"_archive/exploration-categorical-consolidation/#isomorphism-4-soul-reader-monad","title":"Isomorphism 4: Soul \u2245 Reader Monad","text":"<p>Soul carries persona context through computation: <pre><code>Soul[A] = (value: A, persona: KentEigenvectors)\n</code></pre></p> <p>This is <code>Reader[PersonaContext, A]</code>.</p> <p>Unification: Parameterize Soul as <code>Soul[A, P]</code> where P is persona type. Enable <code>ReaderTransformer</code> composition.</p>"},{"location":"_archive/exploration-categorical-consolidation/#part-iv-anti-patterns-identified","title":"Part IV: Anti-Patterns Identified","text":""},{"location":"_archive/exploration-categorical-consolidation/#anti-pattern-1-state-dependent-semantics","title":"Anti-Pattern 1: State-Dependent Semantics","text":"<p>FluxAgent changes <code>invoke()</code> behavior based on internal state:</p> <pre><code>async def invoke(self, input: A) -&gt; B:\n    if self._state == FluxState.DORMANT:\n        # Discrete agent behavior\n    else:\n        # Perturbation injection (different semantics!)\n</code></pre> <p>Problem: Violates functor identity law. Same agent, different behavior depending on state.</p> <p>Fix: Separate <code>invoke_discrete()</code> from <code>inject_perturbation()</code>.</p>"},{"location":"_archive/exploration-categorical-consolidation/#anti-pattern-2-manual-setupteardown-in-tests","title":"Anti-Pattern 2: Manual Setup/Teardown in Tests","text":"<pre><code>def setup_method(self) -&gt; None:\n    self._saved = FunctorRegistry._functors.copy()\n    FunctorRegistry._functors.clear()  # Clears ALL registrations\n\ndef teardown_method(self) -&gt; None:\n    FunctorRegistry._functors.update(self._saved)  # Incomplete restore\n</code></pre> <p>Problem: Module-level functor registration (<code>_register_cgent_functors()</code> on import) + manual clearing = isolation failures.</p> <p>Fix: Use <code>@pytest.fixture</code> with proper scope: <pre><code>@pytest.fixture\ndef isolated_registry():\n    saved = FunctorRegistry._functors.copy()\n    FunctorRegistry._functors.clear()\n    yield FunctorRegistry\n    FunctorRegistry._functors.clear()\n    FunctorRegistry._functors.update(saved)\n</code></pre></p>"},{"location":"_archive/exploration-categorical-consolidation/#anti-pattern-3-functorregistry-unused","title":"Anti-Pattern 3: FunctorRegistry Unused","text":"<p><code>FunctorRegistry</code> exists (<code>a/functor.py:260-323</code>) with: - <code>register(family, functor)</code> - <code>compose(f, g) -&gt; functor</code></p> <p>But only FluxFunctor registers. C-gents, Soul, Observer functors don't.</p> <p>Consequence: No declarative cross-functor composition.</p>"},{"location":"_archive/exploration-categorical-consolidation/#anti-pattern-4-persona-context-leakage","title":"Anti-Pattern 4: Persona Context Leakage","text":"<p>Soul context is \"sticky\"\u2014once lifted, hard to override:</p> <pre><code>soul_agent = soul_lift(agent)  # Now carries KENT_EIGENVECTORS\n# Can't easily swap to different persona mid-pipeline\n</code></pre> <p>Fix: Parameterize persona type, provide <code>with_persona()</code> combinator.</p>"},{"location":"_archive/exploration-categorical-consolidation/#part-v-consolidation-recommendations","title":"Part V: Consolidation Recommendations","text":""},{"location":"_archive/exploration-categorical-consolidation/#priority-1-critical-path","title":"Priority 1 (Critical Path)","text":"<ol> <li>Add unlift() to C-gent functors (Maybe, Either, List)</li> <li>Enables monad transformer stacks</li> <li> <p>Files: <code>c/functor.py</code></p> </li> <li> <p>Add SoulNode to SelfContextResolver</p> </li> <li>Bridge K-gent CLI handler with AGENTESE</li> <li> <p>Files: <code>protocols/agentese/contexts/self_.py</code>, <code>cli/handlers/soul.py</code></p> </li> <li> <p>Route 15 CLI handlers through Logos</p> </li> <li>Use membrane bridge pattern</li> <li>Files: <code>protocols/cli/handlers/*.py</code></li> </ol>"},{"location":"_archive/exploration-categorical-consolidation/#priority-2-high-impact","title":"Priority 2 (High Impact)","text":"<ol> <li>Create ObserverFunctor</li> <li>Unify O/N/T observation patterns</li> <li> <p>New file: <code>o/observer_functor.py</code></p> </li> <li> <p>Expose D-gents as StateMonad</p> </li> <li>Enable <code>State &gt;&gt; Flux</code> composition</li> <li> <p>New file: <code>d/state_monad.py</code></p> </li> <li> <p>Register all functors in FunctorRegistry</p> </li> <li>Enable declarative composition</li> <li>Files: <code>c/functor.py</code>, <code>k/functor.py</code>, <code>flux/functor.py</code></li> </ol>"},{"location":"_archive/exploration-categorical-consolidation/#priority-3-polish","title":"Priority 3 (Polish)","text":"<ol> <li>Fix FluxAgent state-dependent semantics</li> <li>Separate discrete from streaming invoke</li> <li> <p>Files: <code>flux/agent.py</code></p> </li> <li> <p>Create isolated_registry fixture</p> </li> <li>Fix test isolation anti-pattern</li> <li> <p>Files: <code>agents/conftest.py</code></p> </li> <li> <p>Add void.dream. and void.slop. paths</p> </li> <li>Complete Accursed Share implementation</li> <li> <p>Files: <code>protocols/agentese/contexts/void.py</code></p> </li> <li> <p>Parameterize Soul[A, P]</p> <ul> <li>Enable persona generics</li> <li>Files: <code>k/functor.py</code>, <code>k/persona.py</code></li> </ul> </li> </ol>"},{"location":"_archive/exploration-categorical-consolidation/#part-vi-the-monad-transformer-stack-vision","title":"Part VI: The Monad Transformer Stack Vision","text":"<p>The ultimate goal is a generic monad transformer stack:</p> <pre><code># Compose effects declaratively\nstack = MonadTransformer.stack(\n    StateMonad,      # D-gent state\n    MaybeMonad,      # Error handling\n    FluxMonad,       # Streaming\n    SoulMonad,       # Persona context\n)\n\n# Lift any agent through the stack\ncomposed = stack.lift(base_agent)\n# Type: Agent[Soul[Flux[Maybe[State[S, A]]]], Soul[Flux[Maybe[State[S, B]]]]]\n\n# Run with effect peeling\nresult = await stack.run(composed.invoke(input), initial_state=s0)\n</code></pre> <p>This would transform kgents from a sophisticated specification system into a truly compositional runtime.</p>"},{"location":"_archive/exploration-categorical-consolidation/#part-vii-test-infrastructure-opportunities","title":"Part VII: Test Infrastructure Opportunities","text":""},{"location":"_archive/exploration-categorical-consolidation/#categorical-law-testing-framework","title":"Categorical Law Testing Framework","text":"<p>Extract common law verification to <code>testing/law_verifier.py</code>:</p> <pre><code>class LawVerifier:\n    @staticmethod\n    async def verify_functor_laws(functor: Type[UniversalFunctor]) -&gt; LawResult:\n        \"\"\"Verify identity and composition laws.\"\"\"\n        identity_result = await verify_identity_law(functor)\n        composition_result = await verify_composition_law(functor)\n        return LawResult(identity=identity_result, composition=composition_result)\n\n    @staticmethod\n    async def verify_monad_laws(monad: Type[Monad]) -&gt; LawResult:\n        \"\"\"Verify return, bind, associativity laws.\"\"\"\n        ...\n</code></pre>"},{"location":"_archive/exploration-categorical-consolidation/#composition-matrix-tests","title":"Composition Matrix Tests","text":"<p>Test all valid agent compositions:</p> <pre><code>@pytest.mark.parametrize(\"source,functor\", [\n    (VolatileAgent, Flux),\n    (VolatileAgent, Soul),\n    (SoulAgent, Flux),\n    (FluxAgent, Maybe),\n    ...\n])\nasync def test_composition_valid(source, functor):\n    \"\"\"Verify composition preserves laws.\"\"\"\n    lifted = functor.lift(source())\n    assert await verify_functor_laws(lifted)\n</code></pre>"},{"location":"_archive/exploration-categorical-consolidation/#property-based-testing-expansion","title":"Property-Based Testing Expansion","text":"<p>Add Hypothesis strategies for: - AGENTESE paths (<code>world.house.manifest</code>, etc.) - Rendering archetypes (architect, poet, economist) - Persona types (for parameterized Soul) - Effect stacks (nested monads)</p>"},{"location":"_archive/exploration-categorical-consolidation/#appendix-key-file-references","title":"Appendix: Key File References","text":""},{"location":"_archive/exploration-categorical-consolidation/#core-architecture","title":"Core Architecture","text":"<ul> <li><code>impl/claude/agents/a/functor.py</code> - UniversalFunctor, FunctorRegistry</li> <li><code>impl/claude/agents/c/functor.py</code> - C-gent functors (Maybe, Either, etc.)</li> <li><code>impl/claude/agents/flux/functor.py</code> - FluxFunctor</li> <li><code>impl/claude/agents/k/functor.py</code> - SoulFunctor</li> </ul>"},{"location":"_archive/exploration-categorical-consolidation/#agentese-protocol","title":"AGENTESE Protocol","text":"<ul> <li><code>impl/claude/protocols/agentese/contexts/self_.py</code> - self.* context (missing soul)</li> <li><code>impl/claude/protocols/agentese/contexts/void.py</code> - void.* context</li> <li><code>impl/claude/protocols/agentese/integration.py</code> - Membrane bridge</li> </ul>"},{"location":"_archive/exploration-categorical-consolidation/#testing","title":"Testing","text":"<ul> <li><code>impl/claude/agents/a/_tests/test_functor.py</code> - Functor law tests</li> <li><code>impl/claude/agents/c/_tests/test_functor_laws.py</code> - C-gent law tests</li> <li><code>impl/claude/testing/fixtures.py</code> - Type-safe mocks</li> </ul>"},{"location":"_archive/exploration-categorical-consolidation/#specs","title":"Specs","text":"<ul> <li><code>spec/principles.md</code> - Design principles</li> <li><code>spec/c-gents/functors.md</code> - Functor specification</li> <li><code>spec/protocols/agentese.md</code> - AGENTESE specification</li> </ul>"},{"location":"_archive/exploration-categorical-consolidation/#conclusion","title":"Conclusion","text":"<p>The kgents ecosystem has achieved remarkable categorical sophistication. The path forward is algebraic consolidation:</p> <ol> <li>Symmetric lift/unlift across all functors</li> <li>Unified observer pattern via ObserverFunctor</li> <li>D-gent as StateMonad for composition</li> <li>Complete AGENTESE coverage (self.soul., void.slop.)</li> <li>Comprehensive law verification via composition matrix</li> </ol> <p>This will enable the system to scale from 27 to 50+ agent types without the current friction.</p> <p>\"The noun is a lie. There is only the rate of change.\"</p>"},{"location":"_archive/exploration-terrarium-bounty-board/","title":"Exploration Plan: Terrarium Metrics + Bounty Board","text":"<p>\"Let agents leave signals for other agents.\"</p> <p>Focus: Exploration (15% attention budget) Date: 2025-12-12 Prerequisites: Terrarium Phase 1-5 complete (176+ tests), Bounty Board initialized</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#executive-summary","title":"Executive Summary","text":"<p>This plan addresses the Exploration slice from <code>_focus.md</code>:</p> <p>Exploration (15%): Terrarium Phase 3 + Bounty Board \u2014 Metrics emission for I-gent widgets. The terrarium window should show pressure/flow/temperature. Also: the new Bounty Board (<code>plans/_bounty.md</code>) is stigmergic coordination for agent observations. Let agents leave signals for other agents.</p> <p>There are two complementary workstreams:</p> <ol> <li>Terrarium Metrics \u2192 I-gent Widgets: Wire existing <code>MetricsManager</code> to dashboard visualization</li> <li>Bounty Board Automation: Let agents programmatically post/claim/query bounties</li> </ol> <p>Both serve the meta-goal: stigmergic coordination\u2014agents leaving traces that other agents (and humans) can perceive and act upon.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#current-state","title":"Current State","text":""},{"location":"_archive/exploration-terrarium-bounty-board/#terrarium-metrics-implemented","title":"Terrarium Metrics (Implemented)","text":"<p>The metrics foundation exists in <code>impl/claude/protocols/terrarium/metrics.py</code>:</p> Component Status Location <code>MetricsManager</code> Complete <code>metrics.py:217</code> <code>calculate_pressure()</code> Complete <code>metrics.py:46</code> <code>calculate_flow()</code> Complete <code>metrics.py:81</code> <code>calculate_temperature()</code> Complete <code>metrics.py:108</code> <code>emit_metrics_loop()</code> Complete <code>metrics.py:152</code> <code>TerriumEvent</code> Complete <code>events.py:40</code> <code>EventType.METABOLISM</code> Complete <code>events.py:28</code> <p>What's Missing: Dashboard consumption. The metrics emit through <code>HolographicBuffer</code>, but I-gent widgets don't yet subscribe.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#bounty-board-initialized","title":"Bounty Board (Initialized)","text":"<p>The protocol exists in <code>plans/_bounty.md</code>:</p> Element Status Format spec Complete Lifecycle diagram Complete Initial bounties 5 entries Agent protocol Missing (no programmatic API) <p>What's Missing: Agents can't post/claim bounties programmatically. It's manual markdown editing only.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#workstream-1-terrarium-metrics-i-gent-widgets","title":"Workstream 1: Terrarium Metrics \u2192 I-gent Widgets","text":""},{"location":"_archive/exploration-terrarium-bounty-board/#goal","title":"Goal","text":"<p>The terrarium window (I-gent TUI) should display live metabolism metrics for running FluxAgents.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#architecture","title":"Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     METRICS \u2192 WIDGET FLOW                          \u2502\n\u2502                                                                    \u2502\n\u2502  FluxAgent                MetricsManager           I-gent TUI      \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502 pressure \u2502\u2500\u2500\u2500poll\u2500\u2500\u2500\u2500\u25b6\u2502 emit_metrics \u2502\u2500\u2500\u2500ws\u2500\u2500\u2500\u25b6\u2502 Density  \u2502    \u2502\n\u2502  \u2502 flow     \u2502            \u2502 _loop()      \u2502         \u2502 Field    \u2502    \u2502\n\u2502  \u2502 temp     \u2502            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                   \u2502                      \u2502          \u2502\n\u2502                                 \u25bc                      \u2502          \u2502\n\u2502                          HolographicBuffer \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2502\n\u2502                          (broadcast)                               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/exploration-terrarium-bounty-board/#phases","title":"Phases","text":""},{"location":"_archive/exploration-terrarium-bounty-board/#phase-a-densityfield-widget-binding","title":"Phase A: DensityField Widget Binding","text":"<p>Goal: Wire existing DensityField to consume TerriumEvent.METABOLISM events.</p> <p>Files: <pre><code>impl/claude/agents/i/widgets/density_field.py    # Add metabolism subscription\nimpl/claude/agents/i/terrarium_tui.py            # Wire to HolographicBuffer\n</code></pre></p> <p>Key Integration: <pre><code># In terrarium_tui.py\nasync def _handle_metabolism(self, event: TerriumEvent) -&gt; None:\n    \"\"\"Update DensityField from metabolism event.\"\"\"\n    self.density_field.set_metrics(\n        pressure=event.pressure,\n        flow=event.flow,\n        temperature=event.temperature,\n    )\n</code></pre></p> <p>Exit Criteria: DensityField animates when FluxAgent runs.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#phase-b-multi-agent-dashboard","title":"Phase B: Multi-Agent Dashboard","text":"<p>Goal: Show all registered agents' metrics in a grid.</p> <p>Files: <pre><code>impl/claude/agents/i/widgets/metrics_grid.py     # Grid of mini-density fields\nimpl/claude/agents/i/terrarium_tui.py            # Add MetricsGrid to layout\n</code></pre></p> <p>Exit Criteria: Dashboard shows N agents simultaneously.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#phase-c-fever-overlay-integration","title":"Phase C: Fever Overlay Integration","text":"<p>Goal: Visual alert when agent temperature exceeds threshold.</p> <p>Key Integration: <pre><code># Use existing emit_fever_alert() from metrics.py\nif event.temperature &gt; 0.8:\n    await emit_fever_alert(event.agent_id, buffer, event.temperature)\n</code></pre></p> <p>Exit Criteria: FeverOverlay triggers on high temperature.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#tests-conceptual","title":"Tests (Conceptual)","text":"<ul> <li>Metabolism event updates DensityField values</li> <li>Multiple agents render in MetricsGrid</li> <li>Fever threshold triggers overlay</li> <li>Disconnected observer doesn't crash</li> <li>Metrics continue after agent restart</li> </ul>"},{"location":"_archive/exploration-terrarium-bounty-board/#workstream-2-bounty-board-automation","title":"Workstream 2: Bounty Board Automation","text":""},{"location":"_archive/exploration-terrarium-bounty-board/#goal_1","title":"Goal","text":"<p>Agents can programmatically interact with the Bounty Board through an AGENTESE path.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#architecture_1","title":"Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    BOUNTY BOARD AGENTESE                           \u2502\n\u2502                                                                    \u2502\n\u2502  Agent Session                 BountyBoard           _bounty.md   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 \"noticed X\"  \u2502\u2500\u2500invoke\u2500\u2500\u2500\u2500\u25b6\u2502 .post()   \u2502\u2500\u2500write\u2500\u25b6\u2502 OPEN      \u2502  \u2502\n\u2502  \u2502 \"claim Y\"    \u2502\u2500\u2500invoke\u2500\u2500\u2500\u2500\u25b6\u2502 .claim()  \u2502\u2500\u2500edit\u2500\u2500\u25b6\u2502 CLAIMED   \u2502  \u2502\n\u2502  \u2502 \"resolve Z\"  \u2502\u2500\u2500invoke\u2500\u2500\u2500\u2500\u25b6\u2502 .resolve()\u2502\u2500\u2500move\u2500\u2500\u25b6\u2502 RESOLVED  \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                    \u2502                              \u2502\n\u2502                                    \u25bc                              \u2502\n\u2502                          void.bounty.* (AGENTESE)                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/exploration-terrarium-bounty-board/#agentese-paths","title":"AGENTESE Paths","text":"Path Operation Returns <code>void.bounty.post</code> Create new bounty BountyToken <code>void.bounty.claim</code> Claim open bounty ClaimReceipt <code>void.bounty.resolve</code> Mark bounty done ResolutionRecord <code>void.bounty.query</code> Find matching bounties list[Bounty] <code>void.bounty.manifest</code> Get board state BountyBoardState <p>Why <code>void.*</code>?: The Bounty Board is stigmergic\u2014it's entropy discharge. Agents leave signals as a side effect of work. This aligns with <code>void.sip</code> and <code>void.tithe</code> patterns.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#phases_1","title":"Phases","text":""},{"location":"_archive/exploration-terrarium-bounty-board/#phase-a-bountyboard-core-types","title":"Phase A: BountyBoard Core Types","text":"<p>Goal: Define bounty types and the in-memory representation.</p> <p>Files: <pre><code>impl/claude/protocols/agentese/bounty/\n\u251c\u2500\u2500 __init__.py\n\u251c\u2500\u2500 types.py          # Bounty, BountyType, BountyState\n\u251c\u2500\u2500 board.py          # BountyBoard class\n\u2514\u2500\u2500 _tests/\n    \u2514\u2500\u2500 test_bounty.py\n</code></pre></p> <p>Key Types: <pre><code>@dataclass\nclass Bounty:\n    id: str\n    type: BountyType         # IDEA | GRIPE | WIN\n    impact: ImpactLevel      # HIGH | MED | LOW\n    description: str\n    tags: frozenset[str]\n    created: datetime\n    claimed_by: str | None = None\n    resolved: datetime | None = None\n    outcome: str | None = None\n\nclass BountyBoard:\n    \"\"\"In-memory bounty state with file sync.\"\"\"\n\n    def post(self, type: BountyType, impact: ImpactLevel,\n             description: str, tags: set[str]) -&gt; Bounty: ...\n\n    def claim(self, bounty_id: str, agent_id: str) -&gt; bool: ...\n\n    def resolve(self, bounty_id: str, outcome: str) -&gt; bool: ...\n\n    def query(self, tags: set[str] | None = None,\n              type: BountyType | None = None,\n              state: BountyState | None = None) -&gt; list[Bounty]: ...\n</code></pre></p> <p>Exit Criteria: BountyBoard can post/claim/resolve in memory.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#phase-b-file-sync","title":"Phase B: File Sync","text":"<p>Goal: Sync BountyBoard state to/from <code>plans/_bounty.md</code>.</p> <p>Key Challenges: - Parse existing bounty format (pipe-delimited) - Write back without corrupting manual edits - Handle concurrent writes (file locking or append-only)</p> <p>Approach: Append-only for posts, in-place edit for claims, section move for resolves.</p> <p>Exit Criteria: <code>BountyBoard.load(\"plans/_bounty.md\")</code> round-trips.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#phase-c-agentese-wiring","title":"Phase C: AGENTESE Wiring","text":"<p>Goal: Register <code>void.bounty.*</code> paths in Logos.</p> <p>Files: <pre><code>impl/claude/protocols/agentese/wiring.py    # Add bounty paths\nimpl/claude/protocols/agentese/contexts/void.py  # Handler implementation\n</code></pre></p> <p>Key Integration: <pre><code># In wiring.py\n\"void.bounty.post\": (\"POST\", bounty_post_handler),\n\"void.bounty.claim\": (\"PUT\", bounty_claim_handler),\n\"void.bounty.resolve\": (\"PUT\", bounty_resolve_handler),\n\"void.bounty.query\": (\"GET\", bounty_query_handler),\n\"void.bounty.manifest\": (\"GET\", bounty_manifest_handler),\n</code></pre></p> <p>Exit Criteria: <code>await logos.invoke(\"void.bounty.query\", {\"tags\": [\"#testing\"]})</code> returns bounties.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#phase-d-cli-integration","title":"Phase D: CLI Integration","text":"<p>Goal: <code>kgents bounty</code> command for human access.</p> <p>Subcommands: <pre><code>kgents bounty list [--tag=&lt;tag&gt;] [--type=&lt;type&gt;] [--state=&lt;state&gt;]\nkgents bounty post \"&lt;description&gt;\" --type=&lt;type&gt; --impact=&lt;level&gt; --tags=&lt;tags&gt;\nkgents bounty claim &lt;id&gt;\nkgents bounty resolve &lt;id&gt; \"&lt;outcome&gt;\"\n</code></pre></p> <p>Exit Criteria: Human can manage bounties from CLI.</p>"},{"location":"_archive/exploration-terrarium-bounty-board/#tests-conceptual_1","title":"Tests (Conceptual)","text":"<ul> <li>Post bounty creates valid entry</li> <li>Claim updates in-place without corruption</li> <li>Resolve moves to correct section</li> <li>Query filters by tags/type/state</li> <li>Concurrent posts don't corrupt file</li> <li>AGENTESE paths resolve correctly</li> <li>CLI subcommands work end-to-end</li> </ul>"},{"location":"_archive/exploration-terrarium-bounty-board/#integration-metrics-bounty-board","title":"Integration: Metrics + Bounty Board","text":"<p>The two workstreams connect:</p> <ol> <li>Metrics \u2192 Bounty: When fever threshold exceeded, auto-post a GRIPE bounty</li> <li>Bounty \u2192 Dashboard: Show open bounty count in I-gent widget</li> <li>Agent Session End: Prompt agent to post observations as bounties</li> </ol>"},{"location":"_archive/exploration-terrarium-bounty-board/#example-integration","title":"Example Integration","text":"<pre><code># In flux agent fever handler\nasync def on_fever(agent_id: str, temperature: float) -&gt; None:\n    \"\"\"Auto-post bounty when agent overheats.\"\"\"\n    await logos.invoke(\"void.bounty.post\", {\n        \"type\": \"GRIPE\",\n        \"impact\": \"MED\",\n        \"description\": f\"{agent_id} hit fever temp {temperature:.2f}\",\n        \"tags\": [\"#performance\", \"#auto-generated\"],\n    })\n</code></pre>"},{"location":"_archive/exploration-terrarium-bounty-board/#priority-sequencing","title":"Priority Sequencing","text":"<p>Given 15% attention budget:</p> Priority Work Rationale 1 Phase A: DensityField Binding Highest impact\u2014makes existing metrics visible 2 Phase A: BountyBoard Core Types Foundation for agent signaling 3 Phase B: File Sync Required for persistence 4 Phase C: AGENTESE Wiring Enables programmatic access 5 Phase B: Multi-Agent Dashboard Nice-to-have polish 6 Phase D: CLI Integration Human convenience 7 Phase C: Fever Overlay Joy-inducing polish 8 Integration work Cross-workstream synthesis"},{"location":"_archive/exploration-terrarium-bounty-board/#principles-alignment","title":"Principles Alignment","text":"Principle How This Honors It Tasteful Thin wiring, not new frameworks Curated Reuses existing MetricsManager, HolographicBuffer Ethical Transparent signaling, no hidden side effects Joy-Inducing Live dashboard, fever overlay Composable AGENTESE paths compose with existing void.* Heterarchical Stigmergic coordination, not central control Generative Bounty Board enables emergent agent collaboration"},{"location":"_archive/exploration-terrarium-bounty-board/#exit-criteria-overall","title":"Exit Criteria (Overall)","text":"<p>This exploration slice is complete when:</p> <ol> <li>DensityField shows live pressure/flow/temperature for running FluxAgent</li> <li><code>void.bounty.post</code> AGENTESE path works</li> <li>Bounties persist to <code>plans/_bounty.md</code></li> <li>At least one integration point (fever \u2192 bounty or dashboard \u2192 bounty count)</li> </ol>"},{"location":"_archive/exploration-terrarium-bounty-board/#cross-references","title":"Cross-References","text":"<ul> <li>Plan: <code>plans/agents/terrarium.md</code> \u2014 Phase 3 context</li> <li>Plan: <code>plans/_bounty.md</code> \u2014 Bounty Board protocol</li> <li>Impl: <code>impl/claude/protocols/terrarium/metrics.py</code> \u2014 MetricsManager</li> <li>Impl: <code>impl/claude/protocols/terrarium/events.py</code> \u2014 TerriumEvent</li> <li>Impl: <code>impl/claude/agents/i/terrarium_tui.py</code> \u2014 I-gent TUI</li> <li>Spec: <code>spec/principles.md</code> \u2014 Design constraints</li> </ul> <p>\"The forest speaks to those who listen. Leave a signal. Claim a prize.\"</p>"},{"location":"_archive/kgent-soul-critical-analysis/","title":"K-gent Soul: Critical Analysis","text":"<p>\"The soul that merely stores is not a soul\u2014it is a corpse awaiting animation.\"</p> <p>Date: 2025-12-12 (Refined) Scope: Analysis of <code>impl/claude/agents/k/</code> against <code>spec/principles.md</code> Purpose: Identify the gap between implementation and the Categorical Imperative vision</p>"},{"location":"_archive/kgent-soul-critical-analysis/#executive-summary","title":"Executive Summary","text":"<p>K-gent Soul exists as static personality data but lacks the governance wiring that would make it a Categorical Imperative. The current implementation optimizes for cost (zero-token templates) over coherence (principled mediation).</p> <p>The Core Reframe: K-gent is not a chatbot. It is a Functor that maps Intent \u2192 Implementation while preserving the structure of your principles.</p> Dimension Current Reality Categorical Imperative Vision Semaphore Mediation Keyword matching LLM-backed principle reasoning Terrarium Presence CLI-only Ambient Flux stream Learning Loop Static eigenvectors Holographic Constitution (drift detection) Dialogue Quality Template strings Fractal expansion from seeds Governance Role Passive Active invalidation of principle-violating morphisms"},{"location":"_archive/kgent-soul-critical-analysis/#part-i-the-gap-traceability-matrix","title":"Part I: The Gap Traceability Matrix","text":"Gap Principle Violated Proposed Fix Validation Test No Flux integration Heterarchical (dual mode) <code>KgentFlux</code> stream K-gent runs autonomously AND composably No composition Composable (morphism) Output \u2192 PersonaGarden pipeline 80% of outputs feed forward No learning Generative (spec compresses) Hypnagogic Cycle Eigenvector confidence evolves \u00b10.05/month Hollow responses Joy-Inducing (collaboration) LLM-backed <code>KgentAgent</code> Mirror Test: avg \u2265 4/5 Shallow mediation Ethical (human agency) Deep intercept + audit Zero \"delete production\" auto-approvals"},{"location":"_archive/kgent-soul-critical-analysis/#part-ii-what-exists-assets","title":"Part II: What Exists (Assets)","text":""},{"location":"_archive/kgent-soul-critical-analysis/#21-personality-manifold-eigenvectors","title":"2.1 Personality Manifold (Eigenvectors)","text":"<p>The six eigenvectors are well-grounded:</p> Eigenvector Kent's Coordinate Source Aesthetic (minimalist) 0.15 Git commit patterns Categorical (abstract) 0.92 AGENTESE ontology Gratitude (sacred) 0.78 Accursed Share principle Heterarchy (peer) 0.88 Forest Over King pattern Generativity 0.90 Spec-first ethos Joy (playful) 0.75 Balance in principles <p>Strength: Extraction sources are grounded in actual codebase. Gap: Eigenvectors are constants. No evolution mechanism.</p>"},{"location":"_archive/kgent-soul-critical-analysis/#22-dialogue-modes","title":"2.2 Dialogue Modes","text":"<p>Four epistemically distinct modes (REFLECT/ADVISE/CHALLENGE/EXPLORE) with clear differentiation and appropriate starters.</p> <p>Strength: Clear purpose per mode. Gap: Mode doesn't affect generation. All paths lead to <code>_generate_response()</code> \u2192 template strings.</p>"},{"location":"_archive/kgent-soul-critical-analysis/#23-budget-tiers","title":"2.3 Budget Tiers","text":"<p>DORMANT (0 tok) \u2192 WHISPER (100) \u2192 DIALOGUE (4000) \u2192 DEEP (8000+)</p> <p>Strength: Cost-consciousness is appropriate. Counterargument Addressed: DORMANT/WHISPER are features, not bugs. The problem is DIALOGUE/DEEP\u2014they claim to use LLM but actually use templates.</p>"},{"location":"_archive/kgent-soul-critical-analysis/#part-iii-the-categorical-imperative-architecture","title":"Part III: The Categorical Imperative Architecture","text":""},{"location":"_archive/kgent-soul-critical-analysis/#31-capability-i-semantic-gatekeeper","title":"3.1 Capability I: Semantic Gatekeeper","text":"<p>K-gent intercepts morphisms (agent actions) and invalidates those that violate principles.</p> <pre><code>Agent Action \u2500\u2500\u25b6 [K-gent Validation] \u2500\u2500\u25b6 Execute OR Reject\n                        \u2502\n                   Query Principles\n                   Check Eigenvector Alignment\n                   Calculate Confidence\n</code></pre> <p>Validation Test: The \"Singleton Rejection\" - Trigger: B-gent attempts to create a <code>UserSession</code> singleton - K-gent: \"Rejected. Singleton violates Heterarchical principle. Use D-gent injection.\" - User never reviews architecturally impure code</p>"},{"location":"_archive/kgent-soul-critical-analysis/#32-capability-ii-fractal-expander-the-monad","title":"3.2 Capability II: Fractal Expander (The Monad)","text":"<p>K-gent treats input seeds and fractally expands them into specifications.</p> <p>Validation Test: The \"Seed\" Explosion - Trigger: \"We need a new agent for semantic search\" - K-gent generates: <code>spec/agents/s-gent.md</code>, <code>impl/claude/agents/s/</code>, test harness - Asks: \"Prioritize recall or precision?\"</p>"},{"location":"_archive/kgent-soul-critical-analysis/#33-capability-iii-holographic-constitution","title":"3.3 Capability III: Holographic Constitution","text":"<p>When principles change, the codebase must shift. K-gent monitors isomorphism between documentation and implementation.</p> <p>Validation Test: The \"Drift\" Alarm - Trigger: Edit <code>principles.md</code> to change \"Tasteful\" to \"Radical\" - K-gent: \"Architecture Drift: 45 modules are strictly typed, violating new 'Radical' principle. Propose refactor?\"</p>"},{"location":"_archive/kgent-soul-critical-analysis/#34-capability-iv-auteur-interface-rodizio-sommelier","title":"3.4 Capability IV: Auteur Interface (Rodizio Sommelier)","text":"<p>K-gent pre-computes decisions, surfacing only novel problems.</p> <p>Validation Test: The \"Sommelier\" Pre-Computation - Trigger: Schema migration (usually requires human approval) - K-gent checks git history: \"14 similar migrations approved\" - Auto-resolves with audit trail, no human attention required</p>"},{"location":"_archive/kgent-soul-critical-analysis/#part-iv-implementation-priorities","title":"Part IV: Implementation Priorities","text":""},{"location":"_archive/kgent-soul-critical-analysis/#priority-1-llm-backed-dialogue-joy","title":"Priority 1: LLM-Backed Dialogue (Joy)","text":"<p>Replace template interpolation with actual LLM calls in DIALOGUE/DEEP tiers.</p> <pre><code># Current (broken)\ndef _generate_response(self, mode, message, prefs, pats):\n    return f\"You've expressed before that you value: {', '.join(refs)}...\"\n\n# Required\nasync def _generate_response(self, mode, message, context):\n    return await self._llm.generate(\n        system=self._build_system_prompt(mode),\n        user=self._build_user_prompt(message, context),\n        temperature=self._temperature_for_mode(mode),\n    )\n</code></pre>"},{"location":"_archive/kgent-soul-critical-analysis/#priority-2-deep-intercept-ethical","title":"Priority 2: Deep Intercept (Ethical)","text":"<p>Replace keyword matching with principle-based reasoning.</p> <pre><code># Current (dangerous)\nfor keyword, principles in keyword_principles.items():\n    if keyword in text_lower:\n        matches.extend(principles)  # \"delete\" \u2192 \"Minimalism\" \u2192 auto-approve!\n\n# Required\nasync def intercept_deep(self, token: SemaphoreToken) -&gt; InterceptResult:\n    prompt = f\"\"\"Semaphore: {token.prompt}\n\n    Based on Kent's principles, should this be:\n    1. AUTO-APPROVED (clearly aligns)\n    2. AUTO-REJECTED (clearly violates)\n    3. ESCALATE TO HUMAN (ambiguous)\n\n    Provide confidence (0.0-1.0) and principle rationale.\"\"\"\n\n    return await self._llm.generate(system=\"Ethical reasoning\", user=prompt)\n</code></pre>"},{"location":"_archive/kgent-soul-critical-analysis/#priority-3-flux-integration-heterarchical","title":"Priority 3: Flux Integration (Heterarchical)","text":"<p>K-gent must run as both autonomous stream AND composable function.</p> <pre><code>class KgentFlux(FluxAgent[SoulEvent, SoulEvent]):\n    \"\"\"K-gent as Flux stream.\"\"\"\n\n    async def _source(self) -&gt; AsyncIterator[SoulEvent]:\n        while True:\n            yield HeartbeatEvent()\n            await asyncio.sleep(60)\n\n    async def _transform(self, event: SoulEvent) -&gt; SoulEvent | None:\n        match event:\n            case HeartbeatEvent(): return await self._ambient_reflection()\n            case DialogueEvent(msg): return await self._dialogue_turn(msg)\n            case SemaphoreEvent(tok): return await self._mediate(tok)\n</code></pre>"},{"location":"_archive/kgent-soul-critical-analysis/#priority-4-personagarden-generative","title":"Priority 4: PersonaGarden (Generative)","text":"<p>Close the feedback loop with STONES/SEEDS/TREES/COMPOST.</p> State Description Behavior STONE Immutable ground truth Never decay SEED Observed pattern Awaiting confirmation TREE Confirmed pattern Used in dialogue COMPOST Decayed pattern Archived"},{"location":"_archive/kgent-soul-critical-analysis/#priority-5-hypnagogic-cycle-evolution","title":"Priority 5: Hypnagogic Cycle (Evolution)","text":"<p>Async refinement during off-hours.</p> <ul> <li>Day: Interactions flow, patterns accumulate</li> <li>Night (3AM): Batch inference, SEED \u2192 TREE promotion</li> <li>Result: Eigenvector confidence evolves based on evidence</li> </ul>"},{"location":"_archive/kgent-soul-critical-analysis/#part-v-counterarguments-addressed","title":"Part V: Counterarguments Addressed","text":""},{"location":"_archive/kgent-soul-critical-analysis/#this-is-over-engineered","title":"\"This is over-engineered\"","text":"<p>Response: The Hypnagogic Cycle is optional. The minimum viable K-gent needs only: 1. LLM-backed dialogue (Priority 1) 2. Deep intercept (Priority 2)</p> <p>Everything else is enhancement.</p>"},{"location":"_archive/kgent-soul-critical-analysis/#templates-are-fine-for-cost-control","title":"\"Templates are fine for cost control\"","text":"<p>Response: Agreed for DORMANT/WHISPER. The criticism is that DIALOGUE/DEEP claim to use LLM but don't. Either honor the budget tier or be honest about what you're getting.</p>"},{"location":"_archive/kgent-soul-critical-analysis/#llm-costs-matter","title":"\"LLM costs matter\"","text":"<p>Response: Yes. Proposed cost structure: - DORMANT: $0 (templates) - WHISPER: ~$0.0003/call (100 tokens) - DIALOGUE: ~$0.012/call (4000 tokens) - DEEP: ~$0.024+/call (8000+ tokens)</p> <p>At 100 DIALOGUE calls/day = $1.20/day = $36/month. Acceptable for governance middleware.</p>"},{"location":"_archive/kgent-soul-critical-analysis/#5-weeks-to-full-implementation-is-fantasy","title":"\"5 weeks to full implementation is fantasy\"","text":"<p>Response: Adjusted timeline: - Week 1: LLM dialogue + deep intercept (core value) - Week 2-3: Flux integration + Terrarium wire - Week 4+: PersonaGarden + Hypnagogia (enhancement)</p> <p>Core governance value in Week 1. Full soul in Week 4+.</p>"},{"location":"_archive/kgent-soul-critical-analysis/#part-vi-success-criteria","title":"Part VI: Success Criteria","text":""},{"location":"_archive/kgent-soul-critical-analysis/#the-mirror-test-qualitative","title":"The Mirror Test (Qualitative)","text":"<p>When you type <code>kgents soul challenge \"I'm stuck on architecture\"</code>, the response should feel like Kent on his best day, reminding Kent on his worst day what he actually believes.</p> <p>Metric: Blind rating 1-5. Target: avg \u2265 4.</p>"},{"location":"_archive/kgent-soul-critical-analysis/#the-gatekeeper-test-governance","title":"The Gatekeeper Test (Governance)","text":"<p>K-gent rejects a singleton creation before Kent ever sees it.</p> <p>Metric: % of principle-violating morphisms caught before commit. Target: &gt;80%.</p>"},{"location":"_archive/kgent-soul-critical-analysis/#the-drift-test-holographic","title":"The Drift Test (Holographic)","text":"<p>When principles.md changes, K-gent detects architectural drift within 24 hours.</p> <p>Metric: Drift detection latency. Target: &lt;24h.</p>"},{"location":"_archive/kgent-soul-critical-analysis/#the-feedback-loop-metric","title":"The Feedback Loop Metric","text":"<p>% of K-gent outputs that feed into another system.</p> Output Target Dialogue \u2192 PersonaGarden SEED 60% Intercept \u2192 Audit trail 100% Evidence \u2192 Eigenvector confidence Measurable change/month"},{"location":"_archive/kgent-soul-critical-analysis/#conclusion-from-corpse-to-categorical-imperative","title":"Conclusion: From Corpse to Categorical Imperative","text":"<p>The current K-gent is a personality snapshot. The vision is a Governance Functor that:</p> <ol> <li>Invalidates morphisms that violate principles (Gatekeeper)</li> <li>Expands seeds into specifications (Fractal Monad)</li> <li>Detects drift between documentation and implementation (Holographic)</li> <li>Pre-computes routine decisions (Sommelier)</li> </ol> <p>The skeleton exists. The nervous system requires wiring.</p> <p>\"K-gent doesn't add personality\u2014it navigates to specific coordinates in the inherent personality-space of LLMs. The question isn't whether the soul exists. The question is whether we've connected the wires.\"</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/","title":"K-gent Soul Analysis: Iterative Refinement Prompt","text":"<p>\"The document that critiques itself becomes sharper with each pass.\"</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#context","title":"Context","text":"<p>You are refining <code>docs/kgent-soul-critical-analysis.md</code> \u2014 a critical analysis of K-gent Soul's implementation against kgents principles. The document identifies gaps between intent and implementation, proposes architectural improvements, and outlines feedback loops.</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#your-task","title":"Your Task","text":"<p>Read the analysis document and improve it through iterative refinement. Each pass should have a distinct focus. Do not attempt all passes in one session \u2014 complete one, assess, then proceed.</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#pass-1-structural-integrity","title":"Pass 1: Structural Integrity","text":"<p>Focus: Does the document hold together as an argument?</p> <p>Questions to answer: 1. Does Part II (What's Missing) directly map to Part IV (Proposed Architecture)? Every gap should have a corresponding fix. 2. Are there claims without evidence? Find assertions and verify against actual code in <code>impl/claude/agents/k/</code>. 3. Does the Implementation Roadmap (Part VI) actually produce the Success Criteria (Part VII)? 4. Is there redundancy? The same point made twice weakens both instances.</p> <p>Actions: - Create a traceability matrix: Gap \u2192 Principle Violated \u2192 Proposed Fix \u2192 Roadmap Phase \u2192 Success Metric - Delete or consolidate redundant sections - Add missing logical links</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#pass-2-code-quality","title":"Pass 2: Code Quality","text":"<p>Focus: Is the proposed code actually good?</p> <p>Questions to answer: 1. Does <code>KgentFlux</code> follow the Flux patterns in <code>impl/claude/agents/flux/</code>? Read the actual implementation. 2. Does <code>DialogueChain</code> compose correctly with existing <code>KgentSoul</code>? Check for interface mismatches. 3. Is the LLM integration realistic? Check how other agents in the codebase call LLMs. 4. Does <code>SemaphoreMediator</code> wire correctly to <code>impl/claude/agents/flux/semaphore/purgatory.py</code>?</p> <p>Actions: - Read <code>impl/claude/agents/flux/__init__.py</code> and verify <code>KgentFlux</code> matches FluxAgent patterns - Read <code>impl/claude/agents/flux/semaphore/</code> and verify <code>SemaphoreMediator</code> uses correct interfaces - Rewrite code samples that don't match codebase conventions - Add imports and type annotations where missing</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#pass-3-principle-alignment","title":"Pass 3: Principle Alignment","text":"<p>Focus: Does the analysis itself follow kgents principles?</p> <p>Questions to answer: 1. Tasteful: Is every section justified? What can be deleted? 2. Curated: Are there too many code samples? Quality over quantity. 3. Generative: Could someone regenerate K-gent from this document? If not, what's missing? 4. Joy-Inducing: Is this document pleasant to read? Or is it a slog? 5. Composable: Can sections be read independently? Or is there too much cross-reference?</p> <p>Actions: - Apply the Molasses Test: If any section makes you feel like a butterfly in molasses, simplify it - Add Zen quotes where they illuminate (but not gratuitously) - Ensure each Part has a clear entry/exit that stands alone - Cut prose that doesn't earn its place</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#pass-4-adversarial-review","title":"Pass 4: Adversarial Review","text":"<p>Focus: What would a skeptic say?</p> <p>Questions to answer: 1. \"This is over-engineered\" \u2014 Is the Hypnagogic Cycle actually necessary? What's the simplest thing that would work? 2. \"Templates are fine\" \u2014 Is the criticism of hollow responses fair? Templates at scale might be a feature, not a bug. 3. \"LLM costs matter\" \u2014 The analysis dismisses cost-consciousness. Is that actually Kent's position? 4. \"This roadmap is fantasy\" \u2014 5 weeks to Hypnagogia? Really?</p> <p>Actions: - Add a \"Counterarguments\" section that steelmans the current implementation - Revisit budget tier criticism \u2014 maybe DORMANT/WHISPER are good and DIALOGUE/DEEP are what need work - Add cost estimates to the roadmap (tokens/day, dollars/month) - Adjust timeline if it's unrealistic</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#pass-5-missing-perspectives","title":"Pass 5: Missing Perspectives","text":"<p>Focus: What viewpoints are absent?</p> <p>Questions to answer: 1. User perspective: What does Kent actually want when he types <code>kgents soul</code>? Is the analysis solving the right problem? 2. Operator perspective: Who runs this? What are the ops concerns? (Memory, CPU, API costs) 3. Debuggability: How do you debug a soul that dreams? Where are the observability hooks? 4. Security: K-gent mediates semaphores. What are the attack vectors?</p> <p>Actions: - Add a \"Day in the Life\" scenario showing K-gent in actual use - Add operational considerations section - Propose logging/tracing for the Hypnagogic Cycle - Consider: What happens if the LLM is adversarially prompted via a semaphore?</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#pass-6-compression","title":"Pass 6: Compression","text":"<p>Focus: Make it shorter without losing substance.</p> <p>Target: Reduce document length by 30% while preserving all unique insights.</p> <p>Actions: - Convert prose to tables where appropriate - Collapse code samples into pseudocode where full implementation isn't needed - Move detailed code to an appendix or separate file - Ensure every paragraph has exactly one idea</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#pass-7-final-polish","title":"Pass 7: Final Polish","text":"<p>Focus: Voice and coherence.</p> <p>Questions to answer: 1. Does it sound like something Kent would write? (Check against <code>spec/principles.md</code> voice) 2. Are the Zen quotes earned or decorative? 3. Is the conclusion actually a conclusion, or just a summary? 4. Does the title match the content?</p> <p>Actions: - Read aloud \u2014 fix anything that sounds awkward - Verify all code compiles (syntax check at minimum) - Check all file paths are correct - Ensure the document can be understood without reading the entire kgents codebase</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#meta-instructions","title":"Meta-Instructions","text":"<p>After each pass: 1. Write a one-paragraph summary of changes made 2. Note which questions remain unanswered 3. Assess: Is another pass needed, or is the document ready?</p> <p>Stopping criteria: - The document passes the Molasses Test (reads smoothly) - A traceability matrix exists linking gaps \u2192 fixes \u2192 metrics - At least one counterargument is addressed - Document length is \u2264 80% of original after compression pass</p> <p>Output: - Updated <code>docs/kgent-soul-critical-analysis.md</code> - A brief <code>docs/kgent-soul-analysis-changelog.md</code> tracking refinement history</p>"},{"location":"_archive/kgent-soul-refinement-prompt-original/#invocation","title":"Invocation","text":"<p>To use this prompt:</p> <pre><code># Hydrate context first\n/hydrate\n\n# Then run with this prompt\ncat docs/kgent-soul-refinement-prompt.md\n</code></pre> <p>Or as a slash command if configured:</p> <pre><code>/refine-soul-analysis\n</code></pre> <p>\"Seven passes through the fire; what remains is gold.\"</p>"},{"location":"_archive/mcp-integration/","title":"MCP Integration Guide","text":"<p>\"Protocols are infrastructure, not cognition.\"</p> <p>This document describes how to integrate external tools and data sources via the Model Context Protocol (MCP) into kgents. MCP is a protocol layer, not an agent genus\u2014external capabilities are wrapped as agents using existing L-gent (catalog) and D-gent (data) patterns.</p>"},{"location":"_archive/mcp-integration/#why-not-x-gent","title":"Why Not X-gent?","text":"<p>An earlier proposal suggested \"X-gent\" (Xenolinguist) as a separate genus for MCP integration. Analysis revealed:</p> <ol> <li>Protocols are infrastructure - MCP/OpenAPI are transport protocols, not reasoning patterns</li> <li>Already covered - L-gent (catalog), P-gent (parsing), D-gent (backends)</li> <li>No bootstrap derivation - Protocol adapters don't derive from the seven bootstrap agents</li> </ol> <p>Decision: MCP integration is infrastructure, documented here rather than as an agent genus.</p>"},{"location":"_archive/mcp-integration/#mcp-overview","title":"MCP Overview","text":"<p>The Model Context Protocol connects AI systems to external data sources and tools:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    MODEL CONTEXT PROTOCOL                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      JSON-RPC       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502   KGENTS    \u2502 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba \u2502  MCP SERVER \u2502           \u2502\n\u2502  \u2502  (client)   \u2502                     \u2502  (external) \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502                                                                  \u2502\n\u2502  Capabilities exposed:                                           \u2502\n\u2502  \u2022 Resources (read data)                                        \u2502\n\u2502  \u2022 Tools (execute actions)                                      \u2502\n\u2502  \u2022 Prompts (templated interactions)                             \u2502\n\u2502                                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/mcp-integration/#architecture","title":"Architecture","text":"<p>External MCP capabilities integrate through existing kgents patterns:</p> <pre><code>External MCP Server\n       \u2502\n       \u2502 JSON-RPC\n       \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   MCP Client     \u2502  \u2190 Infrastructure layer (this doc)\n\u2502   (protocol)     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2510\n    \u25bc         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 L-gent \u2502 \u2502 D-gent \u2502  \u2190 Agent layer (existing)\n\u2502(catalog)\u2502 \u2502 (data) \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/mcp-integration/#mcp-client-implementation","title":"MCP Client Implementation","text":"<pre><code>@dataclass\nclass MCPClient:\n    \"\"\"\n    Core MCP client implementation.\n\n    INFRASTRUCTURE LAYER - not an agent.\n    \"\"\"\n\n    servers: dict[str, MCPServer] = field(default_factory=dict)\n    resources: dict[str, MCPResource] = field(default_factory=dict)\n    tools: dict[str, MCPTool] = field(default_factory=dict)\n    transport: MCPTransport = field(default_factory=StdioTransport)\n\n    async def connect(self, config: MCPServerConfig) -&gt; MCPConnection:\n        \"\"\"Connect to an MCP server.\"\"\"\n        connection = await self.transport.connect(config)\n\n        # Initialize protocol\n        init_result = await connection.initialize(\n            protocol_version=\"2024-11-05\",\n            capabilities=self._get_client_capabilities(),\n            client_info={\"name\": \"kgents\", \"version\": \"1.0.0\"}\n        )\n\n        # Store server\n        server = MCPServer(\n            name=config.name,\n            connection=connection,\n            capabilities=init_result.capabilities\n        )\n        self.servers[config.name] = server\n\n        # Discover resources and tools\n        await self._discover_resources(server)\n        await self._discover_tools(server)\n\n        return connection\n\n    async def call_tool(self, tool_name: str, arguments: dict) -&gt; MCPToolResult:\n        \"\"\"Call an MCP tool.\"\"\"\n        tool = self.tools.get(tool_name)\n        if not tool:\n            raise ToolNotFoundError(tool_name)\n\n        server = self.servers[tool.server]\n        return await server.connection.call_tool(tool.name, arguments)\n\n    async def read_resource(self, resource_uri: str) -&gt; MCPResourceContent:\n        \"\"\"Read an MCP resource.\"\"\"\n        resource = self.resources.get(resource_uri)\n        if not resource:\n            raise ResourceNotFoundError(resource_uri)\n\n        server = self.servers[resource.server]\n        return await server.connection.read_resource(resource.uri)\n</code></pre>"},{"location":"_archive/mcp-integration/#l-gent-integration-catalog","title":"L-gent Integration (Catalog)","text":"<p>MCP tools and resources register with L-gent as agents:</p> <pre><code>class MCPAgentFactory:\n    \"\"\"\n    Creates kgents Agents from MCP capabilities.\n\n    Uses L-gent for registration.\n    \"\"\"\n\n    def __init__(self, mcp_client: MCPClient, l_gent: \"L\"):\n        self.mcp = mcp_client\n        self.l_gent = l_gent\n\n    async def register_all(self, server_name: str) -&gt; list[str]:\n        \"\"\"Register all MCP tools/resources as agents with L-gent.\"\"\"\n        registered = []\n\n        # Register tools as agents\n        for tool_name, tool in self.mcp.tools.items():\n            if tool.server == server_name:\n                agent = self._create_tool_agent(tool_name)\n                await self.l_gent.register(\n                    name=f\"mcp.{tool_name}\",\n                    artifact=agent,\n                    tags=[\"external\", \"mcp\", server_name],\n                    metadata={\"source\": \"mcp\", \"type\": \"tool\"}\n                )\n                registered.append(tool_name)\n\n        # Register resources as agents\n        for uri, resource in self.mcp.resources.items():\n            if resource.server == server_name:\n                agent = self._create_resource_agent(uri)\n                await self.l_gent.register(\n                    name=f\"mcp.{resource.name}\",\n                    artifact=agent,\n                    tags=[\"external\", \"mcp\", server_name],\n                    metadata={\"source\": \"mcp\", \"type\": \"resource\"}\n                )\n                registered.append(uri)\n\n        return registered\n\n    def _create_tool_agent(self, tool_name: str) -&gt; Agent:\n        \"\"\"Wrap MCP tool as Agent.\"\"\"\n        tool = self.mcp.tools[tool_name]\n\n        async def invoke(arguments: dict) -&gt; Any:\n            result = await self.mcp.call_tool(tool_name, arguments)\n            return result.content\n\n        return FunctionAgent(\n            invoke,\n            meta=AgentMeta(\n                name=f\"MCP_{tool_name}\",\n                genus=\"external\",\n                description=tool.description\n            )\n        )\n\n    def _create_resource_agent(self, resource_uri: str) -&gt; Agent:\n        \"\"\"Wrap MCP resource as Agent.\"\"\"\n        resource = self.mcp.resources[resource_uri]\n\n        async def invoke(_: None) -&gt; Any:\n            content = await self.mcp.read_resource(resource_uri)\n            return content.text\n\n        return FunctionAgent(\n            invoke,\n            meta=AgentMeta(\n                name=f\"MCP_{resource.name}\",\n                genus=\"external\",\n                description=resource.description\n            )\n        )\n</code></pre>"},{"location":"_archive/mcp-integration/#d-gent-integration-data","title":"D-gent Integration (Data)","text":"<p>MCP databases integrate as D-gent backends:</p> <pre><code>class MCPDatabaseBackend(DataBackend):\n    \"\"\"\n    D-gent backend for MCP database servers.\n    \"\"\"\n\n    def __init__(self, mcp_client: MCPClient, server_name: str):\n        self.mcp = mcp_client\n        self.server = server_name\n        self.query_tool = f\"{server_name}.query\"\n\n    async def load(self, key: str) -&gt; Any:\n        \"\"\"Load data via MCP query.\"\"\"\n        result = await self.mcp.call_tool(\n            self.query_tool,\n            {\"query\": f\"SELECT * FROM {key}\"}\n        )\n        return result.content\n\n    async def save(self, key: str, value: Any) -&gt; None:\n        \"\"\"Save data via MCP (implementation depends on server).\"\"\"\n        raise NotImplementedError(\"Depends on MCP server capabilities\")\n\n    async def query(self, sql: str) -&gt; list[dict]:\n        \"\"\"Execute SQL query via MCP.\"\"\"\n        result = await self.mcp.call_tool(self.query_tool, {\"query\": sql})\n        return result.content\n</code></pre>"},{"location":"_archive/mcp-integration/#openapi-integration","title":"OpenAPI Integration","text":"<p>For REST APIs without MCP servers, use OpenAPI specs:</p> <pre><code>@dataclass\nclass OpenAPIAdapter:\n    \"\"\"\n    Creates agents from OpenAPI specifications.\n\n    Complements MCP for REST APIs.\n    \"\"\"\n\n    http_client: httpx.AsyncClient = field(default_factory=httpx.AsyncClient)\n\n    async def load_spec(self, spec_url: str) -&gt; OpenAPISpec:\n        \"\"\"Load and parse an OpenAPI specification.\"\"\"\n        response = await self.http_client.get(spec_url)\n        spec_dict = response.json()\n        return OpenAPISpec.from_dict(spec_dict)\n\n    def create_endpoint_agent(\n        self,\n        spec: OpenAPISpec,\n        path: str,\n        method: str\n    ) -&gt; Agent:\n        \"\"\"Create an Agent from an OpenAPI endpoint.\"\"\"\n        endpoint = spec.paths.get(path, {}).get(method.lower())\n        base_url = spec.servers[0].get(\"url\", \"\") if spec.servers else \"\"\n\n        async def invoke(params: dict) -&gt; Any:\n            url = f\"{base_url}{path}\"\n\n            # Handle path parameters\n            for param in endpoint.get(\"parameters\", []):\n                if param.get(\"in\") == \"path\":\n                    url = url.replace(\n                        f\"{{{param['name']}}}\",\n                        str(params.get(param[\"name\"], \"\"))\n                    )\n\n            response = await self.http_client.request(\n                method=method.upper(),\n                url=url,\n                params={k: v for k, v in params.items() if k not in url},\n                json=params.get(\"body\")\n            )\n            return response.json()\n\n        return FunctionAgent(invoke)\n</code></pre>"},{"location":"_archive/mcp-integration/#security-considerations","title":"Security Considerations","text":"<p>External data must be sanitized:</p> <pre><code>async def secure_mcp_call(\n    mcp_client: MCPClient,\n    tool_name: str,\n    arguments: dict,\n    p_gent: \"P\"  # Parser for sanitization\n) -&gt; Any:\n    \"\"\"Call MCP tool with input/output sanitization.\"\"\"\n\n    # Sanitize outgoing data\n    for key, value in arguments.items():\n        if isinstance(value, str):\n            # Use P-gent to validate/sanitize\n            sanitized = await p_gent.sanitize(value)\n            arguments[key] = sanitized\n\n    # Call external tool\n    result = await mcp_client.call_tool(tool_name, arguments)\n\n    # Sanitize incoming data\n    if isinstance(result.content, str):\n        result.content = await p_gent.sanitize(result.content)\n\n    return result\n</code></pre>"},{"location":"_archive/mcp-integration/#configuration","title":"Configuration","text":"<p>MCP servers are configured via <code>kgents.toml</code>:</p> <pre><code>[mcp.servers.github]\ncommand = \"npx\"\nargs = [\"-y\", \"@modelcontextprotocol/server-github\"]\n\n[mcp.servers.postgres]\ncommand = \"npx\"\nargs = [\"-y\", \"@modelcontextprotocol/server-postgres\"]\nenv = { DATABASE_URL = \"postgresql://...\" }\n\n[mcp.servers.filesystem]\ncommand = \"npx\"\nargs = [\"-y\", \"@modelcontextprotocol/server-filesystem\", \"/allowed/path\"]\n</code></pre>"},{"location":"_archive/mcp-integration/#supported-mcp-servers","title":"Supported MCP Servers","text":"Server Capabilities Notes GitHub Issues, PRs, Repos Read/write Slack Messages, Channels Read/write PostgreSQL Query, Schema Read/write Filesystem Read, Write Sandboxed paths Puppeteer Browser automation Heavy resource use"},{"location":"_archive/mcp-integration/#anti-patterns","title":"Anti-Patterns","text":"<ol> <li>\u274c Creating \"X-gent\" as protocol adapter genus (protocols are infrastructure)</li> <li>\u274c Exposing raw MCP interfaces to agents (wrap as proper agents)</li> <li>\u274c Skipping sanitization for \"trusted\" external sources (all external is untrusted)</li> <li>\u274c Hardcoding external API URLs (use config)</li> <li>\u274c Caching external data indefinitely (respect TTLs)</li> </ol>"},{"location":"_archive/mcp-integration/#see-also","title":"See Also","text":"<ul> <li>../spec/l-gents/ - Agent catalog for registration</li> <li>../spec/d-gents/ - Data persistence patterns</li> <li>../spec/p-gents/ - Parsing and sanitization</li> <li>MCP Documentation - Official MCP docs</li> </ul>"},{"location":"_archive/semaphores-phase2-prompt/","title":"Agent Semaphores Phase 2: Flux Integration","text":"<p>Use this prompt with <code>/hydrate</code> to continue implementing Agent Semaphores.</p>"},{"location":"_archive/semaphores-phase2-prompt/#context-for-the-implementing-agent","title":"Context for the Implementing Agent","text":"<p>You are implementing Phase 2 of Agent Semaphores \u2014 integrating the Purgatory Pattern into FluxAgent's event loop. Phase 1 (core types) is complete with 78 tests.</p> <p>Before writing any code, read these documents in order:</p> <ol> <li><code>plans/agents/semaphores.md</code> \u2014 The plan file (updated with Phase 1 status)</li> <li><code>plans/_epilogues/2025-12-12-semaphores-phase1.md</code> \u2014 Previous session notes</li> <li><code>impl/claude/agents/flux/semaphore/__init__.py</code> \u2014 Phase 1 exports</li> <li><code>impl/claude/agents/flux/agent.py</code> \u2014 FluxAgent (you'll modify <code>_process_flux</code>)</li> <li><code>impl/claude/agents/flux/perturbation.py</code> \u2014 Perturbation pattern (you'll reuse this)</li> </ol>"},{"location":"_archive/semaphores-phase2-prompt/#phase-1-recap-whats-already-implemented","title":"Phase 1 Recap: What's Already Implemented","text":"<pre><code>from agents.flux.semaphore import (\n    SemaphoreToken,      # The Red Card - return to yield\n    ReentryContext,      # The Green Card - injected as Perturbation\n    Purgatory,           # The waiting room - crash-safe storage\n    SemaphoreReason,     # 6-way taxonomy\n)\n\n# Creating a semaphore (agent returns this)\ntoken = SemaphoreToken(\n    reason=SemaphoreReason.APPROVAL_NEEDED,\n    frozen_state=pickle.dumps(my_state),\n    original_event=event,\n    prompt=\"Delete 47 records?\",\n    options=[\"Approve\", \"Reject\"],\n)\n\n# Purgatory operations\nawait purgatory.save(token)                          # Eject\nreentry = await purgatory.resolve(token.id, input)   # Returns ReentryContext\nawait purgatory.cancel(token.id)                     # Cancel\npurgatory.list_pending()                             # List pending tokens\n</code></pre>"},{"location":"_archive/semaphores-phase2-prompt/#phase-2-goal-wire-semaphores-into-fluxagent","title":"Phase 2 Goal: Wire Semaphores into FluxAgent","text":"<p>When an agent's <code>invoke()</code> returns a <code>SemaphoreToken</code>, FluxAgent should: 1. Detect the token (it's not a normal result) 2. Eject the event to Purgatory 3. Continue processing other events (no head-of-line blocking) 4. Resume when human resolves (via Perturbation re-injection)</p> <pre><code>FluxAgent._process_flux()\n    \u2502\n    \u25bc\nfor event in merged_source:\n    result = await inner.invoke(event)\n    \u2502\n    \u251c\u2500\u2500 if isinstance(result, SemaphoreToken):\n    \u2502       # EJECT: Save to Purgatory, emit None, continue\n    \u2502       await purgatory.save(result)\n    \u2502       continue  # Don't emit result, don't block\n    \u2502\n    \u2514\u2500\u2500 else:\n            # Normal result\n            await emit_output(result)\n\n# When human resolves:\nreentry = await purgatory.resolve(token_id, human_input)\nperturbation = create_perturbation(reentry, priority=200)\nawait flux._perturbation_queue.put(perturbation)\n\n# FluxAgent processes perturbation, calls agent.resume()\n</code></pre>"},{"location":"_archive/semaphores-phase2-prompt/#files-to-create","title":"Files to Create","text":"<pre><code>impl/claude/agents/flux/semaphore/\n\u251c\u2500\u2500 mixin.py             # SemaphoreCapable protocol + SemaphoreMixin\n\u2514\u2500\u2500 _tests/\n    \u2514\u2500\u2500 test_mixin.py    # Tests for mixin\n</code></pre>"},{"location":"_archive/semaphores-phase2-prompt/#mixinpy","title":"mixin.py","text":"<pre><code>from typing import Any, Protocol, TypeVar\n\nB = TypeVar(\"B\")  # Output type\n\nclass SemaphoreCapable(Protocol[B]):\n    \"\"\"\n    Protocol for agents that can yield semaphores.\n\n    Agents implementing this protocol:\n    1. May return SemaphoreToken from invoke() to yield\n    2. Must implement resume() to handle reentry\n\n    The resume() method receives:\n    - frozen_state: bytes from the original SemaphoreToken\n    - human_input: What the human provided\n\n    And returns the final result that would have been returned\n    by the original invoke() if it hadn't yielded.\n    \"\"\"\n\n    async def resume(self, frozen_state: bytes, human_input: Any) -&gt; B:\n        \"\"\"\n        Resume processing after human provides context.\n\n        Args:\n            frozen_state: Pickled agent state from before ejection\n            human_input: Context provided by human\n\n        Returns:\n            The result that invoke() would have returned\n        \"\"\"\n        ...\n\n\nclass SemaphoreMixin:\n    \"\"\"\n    Mixin that adds semaphore yielding capability to agents.\n\n    Provides helper methods for:\n    - Creating SemaphoreTokens with proper state freezing\n    - Implementing resume() with state restoration\n\n    Example:\n        class MyAgent(Agent[str, str], SemaphoreMixin):\n            async def invoke(self, input: str) -&gt; str | SemaphoreToken:\n                if needs_human_input(input):\n                    return self.yield_semaphore(\n                        reason=SemaphoreReason.CONTEXT_REQUIRED,\n                        prompt=\"Which environment?\",\n                        options=[\"staging\", \"production\"],\n                        state={\"input\": input, \"step\": 3},\n                    )\n                return process(input)\n\n            async def resume(self, frozen_state: bytes, human_input: Any) -&gt; str:\n                state = self.restore_state(frozen_state)\n                return process_with_context(state[\"input\"], human_input)\n    \"\"\"\n\n    def yield_semaphore(\n        self,\n        reason: SemaphoreReason,\n        prompt: str,\n        state: dict[str, Any],\n        *,\n        options: list[str] | None = None,\n        severity: str = \"info\",\n        original_event: Any = None,\n        deadline: datetime | None = None,\n        escalation: str | None = None,\n    ) -&gt; SemaphoreToken[Any]:\n        \"\"\"\n        Create a SemaphoreToken to yield control to human.\n\n        Args:\n            reason: Why yielding (taxonomy)\n            prompt: Human-readable question\n            state: Agent state to freeze (will be pickled)\n            options: Suggested responses\n            severity: \"info\" | \"warning\" | \"critical\"\n            original_event: The event that triggered this\n            deadline: Optional auto-escalation deadline\n            escalation: Who to escalate to after deadline\n\n        Returns:\n            SemaphoreToken to return from invoke()\n        \"\"\"\n        import pickle\n        return SemaphoreToken(\n            reason=reason,\n            frozen_state=pickle.dumps(state),\n            original_event=original_event,\n            prompt=prompt,\n            options=options or [],\n            severity=severity,\n            deadline=deadline,\n            escalation=escalation,\n        )\n\n    def restore_state(self, frozen_state: bytes) -&gt; dict[str, Any]:\n        \"\"\"Restore state from frozen bytes.\"\"\"\n        import pickle\n        return pickle.loads(frozen_state)\n</code></pre>"},{"location":"_archive/semaphores-phase2-prompt/#files-to-modify","title":"Files to Modify","text":""},{"location":"_archive/semaphores-phase2-prompt/#implclaudeagentsfluxagentpy","title":"impl/claude/agents/flux/agent.py","text":"<p>Add these changes to FluxAgent:</p> <ol> <li>Add Purgatory instance (or accept via config)</li> <li>Detect SemaphoreToken in <code>_process_flux()</code></li> <li>Handle ReentryContext in perturbation processing</li> </ol> <pre><code># In FluxAgent.__post_init__ or config:\nself._purgatory: Purgatory = Purgatory()\n\n# In _process_flux(), after getting result from inner.invoke():\nresult = await self.inner.invoke(input_data)\n\n# NEW: Check if agent yielded a semaphore\nif isinstance(result, SemaphoreToken):\n    # Eject to Purgatory\n    result.original_event = input_data  # Preserve original event\n    await self._purgatory.save(result)\n\n    # Emit pheromone for observability\n    await self._emit_pheromone(\n        \"semaphore_ejected\",\n        {\"token_id\": result.id, \"reason\": result.reason.value},\n    )\n\n    # Don't emit result, continue to next event\n    continue\n\n# Existing code for normal results...\n</code></pre> <ol> <li>Handle ReentryContext in perturbation processing:</li> </ol> <pre><code># When processing perturbation, check if it's a ReentryContext\nif isinstance(input_data, ReentryContext):\n    # This is a resolved semaphore, call resume()\n    if hasattr(self.inner, 'resume'):\n        result = await self.inner.resume(\n            input_data.frozen_state,\n            input_data.human_input,\n        )\n    else:\n        # Agent doesn't support resume, log warning\n        await self._emit_pheromone(\n            \"semaphore_resume_failed\",\n            {\"token_id\": input_data.token_id, \"error\": \"no resume method\"},\n        )\n        continue\n</code></pre>"},{"location":"_archive/semaphores-phase2-prompt/#test-requirements","title":"Test Requirements","text":""},{"location":"_archive/semaphores-phase2-prompt/#test_mixinpy","title":"test_mixin.py","text":"<ul> <li><code>SemaphoreMixin.yield_semaphore()</code> creates valid token</li> <li><code>SemaphoreMixin.restore_state()</code> unpickles correctly</li> <li>Agent implementing <code>SemaphoreCapable</code> can yield and resume</li> </ul>"},{"location":"_archive/semaphores-phase2-prompt/#test_flux_integrationpy-new-file","title":"test_flux_integration.py (new file)","text":"<ul> <li>FluxAgent detects <code>SemaphoreToken</code> from <code>inner.invoke()</code></li> <li>Token is saved to Purgatory</li> <li>Stream continues (no blocking)</li> <li>Resolving token creates <code>Perturbation</code></li> <li>Perturbation processed, <code>resume()</code> called</li> <li>Result from <code>resume()</code> emitted to output</li> </ul>"},{"location":"_archive/semaphores-phase2-prompt/#integration-test","title":"Integration test","text":"<pre><code>async def test_full_semaphore_flow():\n    \"\"\"Full round-trip: invoke \u2192 yield \u2192 eject \u2192 resolve \u2192 resume \u2192 result.\"\"\"\n\n    class ApprovalAgent(Agent[str, str], SemaphoreMixin):\n        async def invoke(self, input: str) -&gt; str | SemaphoreToken:\n            if input.startswith(\"delete\"):\n                return self.yield_semaphore(\n                    reason=SemaphoreReason.APPROVAL_NEEDED,\n                    prompt=f\"Confirm: {input}?\",\n                    state={\"input\": input},\n                    options=[\"Approve\", \"Reject\"],\n                )\n            return f\"processed: {input}\"\n\n        async def resume(self, frozen_state: bytes, human_input: Any) -&gt; str:\n            state = self.restore_state(frozen_state)\n            if human_input == \"Approve\":\n                return f\"deleted: {state['input']}\"\n            return f\"cancelled: {state['input']}\"\n\n    flux = FluxAgent(inner=ApprovalAgent())\n    purgatory = flux._purgatory\n\n    # Start flux\n    source = async_iter([\"hello\", \"delete records\", \"world\"])\n    results = []\n\n    async for result in flux.start(source):\n        results.append(result)\n\n    # Should have processed non-semaphore events\n    assert \"processed: hello\" in results\n    assert \"processed: world\" in results\n\n    # Semaphore should be in purgatory\n    pending = purgatory.list_pending()\n    assert len(pending) == 1\n    assert pending[0].prompt == \"Confirm: delete records?\"\n\n    # Resolve semaphore\n    reentry = await purgatory.resolve(pending[0].id, \"Approve\")\n\n    # Inject as perturbation\n    perturbation = create_perturbation(reentry, priority=200)\n    await flux._perturbation_queue.put(perturbation)\n\n    # Resume and get result\n    # (need to process perturbation somehow - may need flux running or invoke())\n</code></pre>"},{"location":"_archive/semaphores-phase2-prompt/#technical-constraints","title":"Technical Constraints","text":"<ol> <li>Import SemaphoreToken in agent.py (add to imports)</li> <li>Don't modify token.py or purgatory.py unless necessary</li> <li>Preserve existing Flux behavior for non-semaphore results</li> <li>Pheromone signals for observability: <code>semaphore_ejected</code>, <code>semaphore_resumed</code></li> <li>Type safety: <code>SemaphoreCapable</code> should work with mypy</li> </ol>"},{"location":"_archive/semaphores-phase2-prompt/#validation-commands","title":"Validation Commands","text":"<pre><code>cd /Users/kentgang/git/kgents/impl/claude\n\n# Type check\nuv run mypy agents/flux/semaphore/ agents/flux/agent.py\n\n# Run semaphore tests\nuv run pytest agents/flux/semaphore/_tests/ -v\n\n# Full validation\nuv run mypy .\nuv run pytest -m \"not slow\" -q\n</code></pre>"},{"location":"_archive/semaphores-phase2-prompt/#exit-criteria","title":"Exit Criteria","text":"Metric Target New tests 20+ Mypy errors 0 Existing flux tests Still pass Integration test Full round-trip works"},{"location":"_archive/semaphores-phase2-prompt/#questions-to-resolve","title":"Questions to Resolve","text":"<ol> <li>Purgatory ownership: Should Purgatory be on FluxAgent or passed via config?</li> <li>Resume without flux running: How do we process ReentryContext perturbation if flux has stopped?</li> <li>Multiple semaphores: Test that multiple pending semaphores work correctly</li> </ol> <p>\"The gaucho sees the red card. The stream flows on. The purgatory holds. This is Phase 2.\"</p>"},{"location":"_archive/soul-framework-enterprise/","title":"Soul Framework: The Categorical Imperative for AI Governance","text":"<p>\"The goal is not to make AI that acts like you. The goal is to make AI that helps you become more like the best version of yourself.\"</p> <p>Status: Design Treatment Audience: Enterprise architects, AI platform teams, Product managers Core Insight: K-gent is a Governance Functor, not a chatbot</p>"},{"location":"_archive/soul-framework-enterprise/#executive-summary","title":"Executive Summary","text":"<p>The Soul Framework is a Principled Personalization Layer for AI agents. Unlike behavioral personalization (which optimizes for engagement), Soul Framework optimizes for alignment with stated values and principles.</p> <p>In Category Theory terms: K-gent is the Functor that maps the Category of Intent (specs/principles) to the Category of Implementation (code/infrastructure) while preserving structure.</p> <p>Key Value Propositions:</p> Capability Traditional AI Soul Framework Consistency Style guides (ignored) Eigenvector coordinates embedded in prompts Governance Manual review (expensive) Principle-based filtering + auto-resolution Audit Trail Post-hoc documentation Real-time decision logging with rationale Learning Retrain model ($$$) Lightweight eigenvector evolution Multi-tenant Complex customization Hierarchical composition"},{"location":"_archive/soul-framework-enterprise/#part-i-the-four-capabilities","title":"Part I: The Four Capabilities","text":""},{"location":"_archive/soul-framework-enterprise/#capability-i-the-semantic-gatekeeper","title":"Capability I: The Semantic Gatekeeper","text":"<p>K-gent intercepts agent actions and invalidates those that violate principles before they execute.</p> <pre><code>Agent Action \u2500\u2500\u25b6 [K-gent] \u2500\u2500\u25b6 Valid? \u2500\u2500\u25b6 Execute\n                     \u2502\n              Query Principles\n              Check Alignment\n              Calculate Confidence\n                     \u2502\n                     \u2514\u2500\u2500\u25b6 Invalid \u2500\u2500\u25b6 Reject with Rationale\n</code></pre> <p>Validation Test: The \"Singleton\" Rejection - Trigger: Agent attempts to create a global singleton (common anti-pattern) - K-gent: \"Rejected. Singleton violates Heterarchical principle #6. Use dependency injection.\" - Impact: User never reviews \"working but ugly\" code</p> <p>Enterprise Value: Architectural purity enforced automatically. Review burden reduced.</p>"},{"location":"_archive/soul-framework-enterprise/#capability-ii-the-fractal-expander-the-monad","title":"Capability II: The Fractal Expander (The Monad)","text":"<p>K-gent treats user input as \"seeds\" and fractally expands them into full specifications.</p> <p>Validation Test: The \"Seed\" Explosion - Trigger: \"We need a new agent for semantic search\" - K-gent:   1. Retrieves agent anatomy template from principles   2. Checks naming conventions (AGENTESE paths)   3. Generates: spec, implementation scaffold, test harness   4. Asks: \"Prioritize recall or precision?\"</p> <p>Enterprise Value: The \"blank page\" problem vanishes. Move from \"coding\" to \"correcting.\"</p>"},{"location":"_archive/soul-framework-enterprise/#capability-iii-the-holographic-constitution","title":"Capability III: The Holographic Constitution","text":"<p>Principles are not a dead file\u2014they are the control plane. When <code>principles.md</code> changes, K-gent detects architectural drift.</p> <p>Validation Test: The \"Drift\" Alarm - Trigger: Edit principle \"Tasteful\" to \"Radical\" (permit messy experimentation) - K-gent: \"Architecture Drift: 45 modules strictly typed, violating new 'Radical' principle. Propose refactor?\"</p> <p>Enterprise Value: Documentation becomes live infrastructure. Principle changes propagate.</p>"},{"location":"_archive/soul-framework-enterprise/#capability-iv-the-auteur-interface-rodizio-sommelier","title":"Capability IV: The Auteur Interface (Rodizio Sommelier)","text":"<p>K-gent pre-computes decisions, surfacing only novel problems for human attention.</p> <p>Validation Test: The \"Sommelier\" Pre-Computation - Trigger: Database schema migration (usually requires human approval) - K-gent checks history: \"14 similar non-destructive migrations approved\" - Auto-resolves with audit trail. No human attention required.</p> <p>Enterprise Value: Human attention preserved for genuinely novel decisions.</p>"},{"location":"_archive/soul-framework-enterprise/#part-ii-core-concepts","title":"Part II: Core Concepts","text":""},{"location":"_archive/soul-framework-enterprise/#21-eigenvector-coordinates","title":"2.1 Eigenvector Coordinates","text":"<p>Personality is a continuous manifold, not binary categories. Each axis has low/high poles:</p> Axis Low Pole High Pole Example Communication Terse Elaborate 0.3 = prefer brevity Risk Tolerance Conservative Aggressive 0.7 = lean into risk Formality Casual Formal 0.5 = context-dependent Detail Level Summary Comprehensive 0.8 = prefer thorough Abstraction Concrete Abstract 0.6 = moderate Autonomy Guided Independent 0.4 = prefers options <p>Key Insight: \"Neutral\" is not zero\u2014it's a specific coordinate. Every response implicitly takes a position. Soul Framework makes that position explicit and controllable.</p>"},{"location":"_archive/soul-framework-enterprise/#22-dialogue-modes","title":"2.2 Dialogue Modes","text":"<p>Different contexts require different epistemic stances:</p> Mode Purpose AI Behavior REFLECT Introspection Mirror back, ask questions, notice patterns ADVISE Guidance Offer options, ground in principles CHALLENGE Dialectics Find weaknesses, stress-test, aim for synthesis EXPLORE Discovery Follow tangents, generate hypotheses"},{"location":"_archive/soul-framework-enterprise/#23-budget-tiers","title":"2.3 Budget Tiers","text":"<p>Cost-conscious operation at enterprise scale:</p> Tier Tokens Use Case Cost/Call DORMANT 0 Template responses $0 WHISPER ~100 Quick acknowledgments ~$0.0003 DIALOGUE ~4000 Full conversations ~$0.012 DEEP ~8000+ Complex decisions ~$0.024+ <p>30% of interactions at zero cost using templates for common patterns.</p>"},{"location":"_archive/soul-framework-enterprise/#24-principle-library","title":"2.4 Principle Library","text":"<p>Structured collection of organizational values:</p> <pre><code>principles:\n  - id: \"security-first\"\n    statement: \"Security concerns override feature velocity\"\n    weight: 0.95\n    domain: [\"engineering\", \"product\"]\n\n  - id: \"customer-data-minimal\"\n    statement: \"Collect only essential data\"\n    weight: 0.90\n    domain: [\"product\", \"legal\"]\n</code></pre>"},{"location":"_archive/soul-framework-enterprise/#part-iii-enterprise-architecture","title":"Part III: Enterprise Architecture","text":""},{"location":"_archive/soul-framework-enterprise/#31-hierarchical-eigenvectors","title":"3.1 Hierarchical Eigenvectors","text":"<p>Organizations have layered personality:</p> <pre><code>ORGANIZATION (communication: 0.4, formality: 0.6)\n       \u2502\n       \u251c\u2500\u2500 ENGINEERING (detail: 0.9)\n       \u2502         \u2514\u2500\u2500 Alice (abstraction: 0.9)\n       \u2502\n       \u251c\u2500\u2500 SALES (formality: 0.3)\n       \u2502         \u2514\u2500\u2500 Bob (risk: 0.8)\n       \u2502\n       \u2514\u2500\u2500 LEGAL (formality: 0.9)\n                 \u2514\u2500\u2500 Carol (risk: 0.1)\n</code></pre> <p>Composition Rules: 1. Individual overrides team overrides org (for specified axes) 2. Unspecified axes inherit from parent 3. Confidence scores determine override strength</p>"},{"location":"_archive/soul-framework-enterprise/#32-integration-patterns","title":"3.2 Integration Patterns","text":""},{"location":"_archive/soul-framework-enterprise/#pattern-a-semaphore-mediation","title":"Pattern A: Semaphore Mediation","text":"<pre><code>Agent Decision Point \u2500\u2500\u25b6 Yield Token\n                              \u2502\n                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502   SOUL FRAMEWORK   \u2502\n                    \u2502                    \u2502\n                    \u2502 Query Principles   \u2502\n                    \u2502 Calculate Confidence\u2502\n                    \u2502                    \u2502\n                    \u2502 confidence &gt;= 0.8? \u2502\n                    \u2502    \u250c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2510       \u2502\n                    \u2502    \u25bc       \u25bc       \u2502\n                    \u2502 AUTO   ANNOTATE    \u2502\n                    \u2502 RESOLVE FOR HUMAN  \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/soul-framework-enterprise/#pattern-b-ambient-presence","title":"Pattern B: Ambient Presence","text":"<p>K-gent runs as persistent Flux stream: - Monitors agent activities - Emits low-frequency \"stream of consciousness\" - Provides consistent personality across touchpoints - Visible in dashboards as \"organizational tone\"</p>"},{"location":"_archive/soul-framework-enterprise/#pattern-c-async-refinement-hypnagogia","title":"Pattern C: Async Refinement (Hypnagogia)","text":"<pre><code>Day (Active)                    Night (Hypnagogia)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Interactions flow  \u2502         \u2502 Analyze logs       \u2502\n\u2502 Log decisions      \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6\u2502 Infer patterns     \u2502\n\u2502 Note corrections   \u2502         \u2502 Update eigenvectors\u2502\n\u2502 Capture feedback   \u2502         \u2502 Prune stale rules  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/soul-framework-enterprise/#33-deployment-models","title":"3.3 Deployment Models","text":"Model Description Best For Embedded Soul Layer per agent Microservices Centralized Soul Service API Org-wide consistency Hybrid Central + local overrides Large enterprises Federated Regional instances Multi-geo compliance"},{"location":"_archive/soul-framework-enterprise/#part-iv-api-reference","title":"Part IV: API Reference","text":""},{"location":"_archive/soul-framework-enterprise/#41-soul-state","title":"4.1 Soul State","text":"<pre><code>interface SoulState {\n  eigenvectors: Record&lt;string, number&gt;;  // 0.0 to 1.0\n  active_mode: DialogueMode;\n  principles: PrincipleRef[];\n  session_id: string;\n  tokens_used_session: number;\n}\n</code></pre>"},{"location":"_archive/soul-framework-enterprise/#42-dialogue-requestresponse","title":"4.2 Dialogue Request/Response","text":"<pre><code>interface DialogueRequest {\n  message: string;\n  mode?: DialogueMode;\n  budget?: BudgetTier;\n  context?: Record&lt;string, any&gt;;\n  user_id?: string;\n  team_id?: string;\n  org_id?: string;\n}\n\ninterface DialogueResponse {\n  response: string;\n  mode: DialogueMode;\n  budget_tier: BudgetTier;\n  tokens_used: number;\n  referenced_principles: string[];\n  confidence: number;\n  audit_id: string;\n}\n</code></pre>"},{"location":"_archive/soul-framework-enterprise/#43-intercept-requestresponse","title":"4.3 Intercept Request/Response","text":"<pre><code>interface InterceptRequest {\n  semaphore_id: string;\n  prompt: string;\n  context: Record&lt;string, any&gt;;\n  urgency: number;  // 0.0 to 1.0\n}\n\ninterface InterceptResponse {\n  handled: boolean;\n  recommendation?: \"approve\" | \"reject\" | \"escalate\";\n  annotation?: string;\n  confidence: number;\n  matching_principles: string[];\n  audit_trail: string;\n}\n</code></pre>"},{"location":"_archive/soul-framework-enterprise/#part-v-success-metrics","title":"Part V: Success Metrics","text":""},{"location":"_archive/soul-framework-enterprise/#operational","title":"Operational","text":"Metric Target Response consistency &gt;90% (same eigenvector \u2192 similar tone) Template hit rate &gt;30% (zero-cost responses) Mediation accuracy &gt;85% (auto-resolved confirmed correct) Latency overhead &lt;50ms"},{"location":"_archive/soul-framework-enterprise/#business","title":"Business","text":"Metric Target Decision audit coverage 100% User satisfaction &gt;4.0/5.0 Escalation reduction -40% Onboarding time -60%"},{"location":"_archive/soul-framework-enterprise/#the-mirror-test","title":"The Mirror Test","text":"<p>When you ask the AI a hard question, the response should feel like your organization on its best day, reminding your organization on its worst day what it actually believes.</p>"},{"location":"_archive/soul-framework-enterprise/#part-vi-security-compliance","title":"Part VI: Security &amp; Compliance","text":""},{"location":"_archive/soul-framework-enterprise/#data-handling","title":"Data Handling","text":"<ul> <li>Eigenvector coordinates: non-PII metadata</li> <li>Principle libraries: may contain sensitive policy</li> <li>Audit logs: encrypted at rest and in transit</li> </ul>"},{"location":"_archive/soul-framework-enterprise/#access-control","title":"Access Control","text":"<pre><code>roles:\n  soul_admin: [manage_org_eigenvectors, manage_principles, view_all_audit]\n  team_lead: [manage_team_eigenvectors, view_team_audit]\n  user: [manage_personal_eigenvectors, view_personal_audit]\n</code></pre>"},{"location":"_archive/soul-framework-enterprise/#compliance","title":"Compliance","text":"<ul> <li>SOC2: Audit logging, access controls, encryption</li> <li>GDPR: User data export, right to deletion</li> <li>HIPAA: BAA available, PHI isolation</li> </ul>"},{"location":"_archive/soul-framework-enterprise/#part-vii-competitive-analysis","title":"Part VII: Competitive Analysis","text":"Feature Soul Framework Fine-Tuning RAG Prompt Engineering Setup time Hours Weeks Days Minutes Customization cost Low High Medium Low Consistency High High Medium Low Audit trail Native None Partial None Multi-tenant Native Complex Complex Manual Learning loop Automated Retrain Re-index Manual Latency impact &lt;50ms None 100-500ms None <p>Positioning: Soul Framework is the right choice when you need: - Consistent personality without fine-tuning cost - Audit trails for compliance - Multi-tenant personalization - Continuous learning from feedback</p>"},{"location":"_archive/soul-framework-enterprise/#appendix-reference-implementation","title":"Appendix: Reference Implementation","text":"<p>The kgents reference implementation:</p> Component Location Core Soul <code>impl/claude/agents/k/soul.py</code> Eigenvectors <code>impl/claude/agents/k/eigenvectors.py</code> Templates <code>impl/claude/agents/k/templates.py</code> CLI Handler <code>impl/claude/protocols/cli/handlers/soul.py</code> Tests <code>impl/claude/agents/k/_tests/test_soul.py</code>"},{"location":"_archive/soul-framework-enterprise/#glossary","title":"Glossary","text":"Term Definition Eigenvector Personality axis with coordinates (0.0-1.0) Dialogue Mode Epistemic stance (REFLECT/ADVISE/CHALLENGE/EXPLORE) Budget Tier Token allocation (DORMANT/WHISPER/DIALOGUE/DEEP) Principle Library Structured organizational values Semaphore Mediation Intercepting agent decisions for review Hypnagogia Async refinement during off-peak hours Mirror Test Success criteria for personality alignment Categorical Imperative K-gent as Governance Functor <p>\"Compute over training. Principles over prompts. The soul remembers. The mirror shows.\"</p>"},{"location":"_archive/topos-of-becoming/","title":"The Topos of Becoming: Kgents v4.0 Implementation Guide","text":"<p>Status: Phases 1-4 Complete (320 tests passing) Philosophy: From Object-Oriented to Interaction-Oriented Mathematics: The Category Poly (Polynomial Functors) Key Metaphor: The Hyphal Network (Mycelium)</p> <p>\"The organism is not a noun. It is a set of interaction patterns that persist through time. We do not store context; we grow through it.\"</p>"},{"location":"_archive/topos-of-becoming/#executive-summary","title":"Executive Summary","text":"<p>This document specifies the transformation of kgents from an \"Object-Oriented + Math Patches\" architecture to a fundamentally Interaction-Oriented system based on Polynomial Functors (Poly). This is not a feature update\u2014it is a new ontology.</p>"},{"location":"_archive/topos-of-becoming/#the-paradigm-shift","title":"The Paradigm Shift","text":"Old Paradigm New Paradigm Agents are objects that possess context Agents are interaction patterns that grow through context Context is a window (Store Comonad) Context is a Weave (Trace Monoid) Memory is retrieval (Vector DB) Memory is resonance (Holographic Field) Entropy is a budget parameter Entropy is a gradient to be minimized Observation returns data Observation triggers state transition Logos is a God Object Logos is a Profunctor bridge"},{"location":"_archive/topos-of-becoming/#the-three-critiques-addressed","title":"The Three Critiques Addressed","text":"<ol> <li> <p>The Solipsism of the Store Comonad: Single-agent focus with no inter-agent context intersection. Resolved via Trace Monoids (concurrent history) and Holographic Resonance (immediate cross-agent learning).</p> </li> <li> <p>The Passive Observation Fallacy: <code>manifest()</code> returns data without changing the observed. Resolved via Poly dynamics where observation is mathematically forced to be a state transition: S \u00d7 A \u2192 S \u00d7 B.</p> </li> <li> <p>The Simulated Thermodynamics: Entropy as a budget, not a structural gradient. Resolved via Active Inference where the agent (Hypha) forages through a Free Energy gradient.</p> </li> </ol>"},{"location":"_archive/topos-of-becoming/#part-i-the-mathematical-core","title":"Part I: The Mathematical Core","text":""},{"location":"_archive/topos-of-becoming/#11-why-poly","title":"1.1 Why Poly?","text":"<p>Previous iterations attempted to compose multiple mathematical structures: - Store Comonad for temporal focus - Zipper Comonad for spatial navigation - Sheaves for multi-observer consensus - Galois Connections for compression</p> <p>This is a kitchen sink. We need a single unifying structure.</p> <p>Poly (The Category of Polynomial Functors) provides this unification.</p>"},{"location":"_archive/topos-of-becoming/#12-polynomial-functors","title":"1.2 Polynomial Functors","text":"<p>A polynomial functor P has the form:</p> <pre><code>P(y) = \u03a3_{s \u2208 S} y^{A_s}\n</code></pre> <p>Where: - S: The set of internal states (positions, modes) - A_s: The set of acceptable inputs at state s (directions, affordances) - y: A formal variable representing \"output channels\"</p> <p>Intuition: A polynomial functor is a mode-dependent interface. At each state <code>s</code>, the system exposes a different set of input channels <code>A_s</code>.</p>"},{"location":"_archive/topos-of-becoming/#13-morphisms-in-poly-interactions","title":"1.3 Morphisms in Poly (Interactions)","text":"<p>A morphism between polynomial functors P \u2192 Q consists of:</p> <pre><code>(on_states, on_directions)\n\nwhere:\n  on_states     : P_states \u2192 Q_states\n  on_directions : \u03a0_{p \u2208 P_states} Q_directions(on_states(p)) \u2192 P_directions(p)\n</code></pre> <p>The Key Insight: Morphisms in Poly naturally encode: 1. State Transition (via <code>on_states</code>) 2. Interface Adaptation (via <code>on_directions</code>)</p> <p>There is no way to \"get\" a value without triggering a state update. This structurally eliminates the \"Passive Observation\" fallacy.</p>"},{"location":"_archive/topos-of-becoming/#14-the-mealy-machine-connection","title":"1.4 The Mealy Machine Connection","text":"<p>A system in Poly can be viewed as a Mealy Machine:</p> <pre><code>S \u00d7 A \u2192 S \u00d7 B\n\nwhere:\n  S : Internal state\n  A : Input alphabet (affordances)\n  B : Output alphabet (responses)\n</code></pre> <p>Every interaction: 1. Consumes an input from A 2. Produces an output in B 3. Transitions to a new state in S</p>"},{"location":"_archive/topos-of-becoming/#15-why-this-kills-the-view-from-nowhere","title":"1.5 Why This Kills the View From Nowhere","text":"<p>In traditional systems: <pre><code>house = world.get(\"house\")  # Returns static data\n</code></pre></p> <p>In Poly: <pre><code># You cannot access without a morphism\n# The morphism forces state transition\nhouse_view, new_state = world_poly.dynamics(current_state, observe_request)\n</code></pre></p> <p>You can only interact with an interface P if you have a morphism into it. There is no observation without interaction. The math enforces AGENTESE's core principle.</p>"},{"location":"_archive/topos-of-becoming/#16-references","title":"1.6 References","text":"<ul> <li>Polynomial Functors: A Mathematical Theory of Interaction - Spivak &amp; Niu</li> <li>Poly: An abundant categorical setting for mode-dependent dynamics - Spivak</li> <li>Categories of Polynomial Functors - nLab</li> </ul>"},{"location":"_archive/topos-of-becoming/#part-ii-the-architecture","title":"Part II: The Architecture","text":""},{"location":"_archive/topos-of-becoming/#21-overview","title":"2.1 Overview","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         THE TOPOS OF BECOMING                                \u2502\n\u2502                                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u2502\n\u2502  \u2502  LogosProfunctor\u2502    \u2502   PolyInterface \u2502    \u2502 HolographicField\u2502         \u2502\n\u2502  \u2502   (The Bridge)  \u2502\u2500\u2500\u2500\u25b6\u2502  (The Dynamics) \u2502\u25c0\u2500\u2500\u2500\u2502  (The Memory)   \u2502         \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502\n\u2502           \u2502                     \u2502                      \u25b2                    \u2502\n\u2502           \u2502                     \u2502                      \u2502                    \u2502\n\u2502           \u25bc                     \u25bc                      \u2502                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u2502\n\u2502  \u2502    The Weave    \u2502    \u2502    The Hypha    \u2502    \u2502  Active Inference\u2502         \u2502\n\u2502  \u2502 (Trace Monoid)  \u2502\u25c0\u2500\u2500\u2500\u2502 (Growing Agent) \u2502\u2500\u2500\u2500\u25b6\u2502   (The Drive)   \u2502         \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502\n\u2502                                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/topos-of-becoming/#22-the-logosprofunctor-replacing-god-object","title":"2.2 The LogosProfunctor (Replacing God Object)","text":"<p>The old Logos was a God Object combining resolution, lifting, invocation, and caching. The new Logos is a Profunctor\u2014a bridge between Intent and Implementation.</p> <pre><code>from typing import Protocol, TypeVar\nfrom dataclasses import dataclass\n\nIntent = TypeVar(\"Intent\")\nImplementation = TypeVar(\"Implementation\")\n\nclass LogosProfunctor(Protocol):\n    \"\"\"\n    Maps: Intent -/-&gt; PolyInterface\n\n    A profunctor is contravariant in the first argument,\n    covariant in the second. This captures:\n    - Different intents can map to the same implementation\n    - The same intent can yield different implementations\n      depending on context (observer)\n\n    This is NOT a function; it's a relation with structure.\n    \"\"\"\n\n    def bridge(\n        self,\n        intent: str,\n        observer: \"Hypha\",\n    ) -&gt; \"PolyInterface\":\n        \"\"\"\n        Bridge intent to polynomial interface.\n\n        Args:\n            intent: The AGENTESE path (e.g., \"world.house\")\n            observer: The requesting hypha (provides context)\n\n        Returns:\n            A PolyInterface ready for dynamics() calls\n\n        Note: This is NOT a lookup. The observer's state\n        affects which interface is returned (polymorphism).\n        \"\"\"\n        ...\n\n    def lift(\n        self,\n        interface: \"PolyInterface\",\n    ) -&gt; \"PolyMorphism\":\n        \"\"\"\n        Lift an interface into a composable morphism.\n\n        Enables: logos.lift(P) &gt;&gt; logos.lift(Q)\n        \"\"\"\n        ...\n\n\n@dataclass\nclass LogosComposition:\n    \"\"\"\n    Concrete implementation of LogosProfunctor.\n\n    Decomposes into three modular components\n    (Profunctor Optics pattern):\n    \"\"\"\n    resolver: \"PolyResolver\"   # String \u2192 PolyInterface\n    lifter: \"PolyLifter\"       # Interface \u2192 Morphism\n    ground: \"PolyGround\"       # Morphism \u2192 Execution\n\n    def bridge(self, intent: str, observer: \"Hypha\") -&gt; \"PolyInterface\":\n        return self.resolver.resolve(intent, observer)\n\n    def lift(self, interface: \"PolyInterface\") -&gt; \"PolyMorphism\":\n        return self.lifter.lift(interface)\n\n    async def execute(self, morphism: \"PolyMorphism\", input: Any) -&gt; Any:\n        return await self.ground.execute(morphism, input)\n</code></pre> <p>Key Insight: By making Logos a Profunctor rather than a class, we can have multiple Logos instances: - <code>RealLogos</code>: Resolves to actual implementations - <code>DreamLogos</code>: Resolves to simulated/hallucinated implementations - <code>TestLogos</code>: Resolves to mocked interfaces</p>"},{"location":"_archive/topos-of-becoming/#23-the-polyinterface-replacing-logosnode","title":"2.3 The PolyInterface (Replacing LogosNode)","text":"<p>Every entity in the system is a Polynomial Interface, not an object with methods.</p> <pre><code>from typing import Generic, TypeVar, Type\nfrom dataclasses import dataclass\nfrom abc import abstractmethod\n\nS = TypeVar(\"S\")  # State type\nA = TypeVar(\"A\")  # Input type (affordances)\nB = TypeVar(\"B\")  # Output type\n\n@dataclass\nclass PolyInterface(Generic[S, A, B]):\n    \"\"\"\n    A Polynomial Functor P(y) = \u03a3_{s \u2208 S} y^{A_s}\n\n    Represents a Mode-Dependent Dynamical System.\n\n    This replaces LogosNode. The key differences:\n    1. State is explicit, not hidden\n    2. affordances() becomes scope() - returns TYPE not list\n    3. invoke() becomes dynamics() - ALWAYS updates state\n\n    Category Theory:\n    - Objects in Poly are polynomial functors\n    - Morphisms are (on_states, on_directions) pairs\n    - Composition is functorial\n    \"\"\"\n    state: S\n\n    @abstractmethod\n    def scope(self, s: S) -&gt; Type[A]:\n        \"\"\"\n        The 'Interface' function: At state S, what inputs are valid?\n\n        This replaces `affordances(observer) -&gt; list[str]`.\n\n        Returns a TYPE, not a list. This enables:\n        - Static type checking of valid inputs\n        - Exhaustive pattern matching\n        - No runtime \"affordance not found\" errors\n\n        The returned type may be a Union, Enum, or Protocol.\n        \"\"\"\n        ...\n\n    @abstractmethod\n    def dynamics(self, s: S, input: A) -&gt; tuple[S, B]:\n        \"\"\"\n        The 'Update' function: Given input A, transition and emit B.\n\n        S \u00d7 A \u2192 S \u00d7 B\n\n        This replaces `invoke(aspect, observer, **kwargs)`.\n\n        CRITICAL: This ALWAYS updates state. There is no\n        \"read-only\" operation. Even observation causes transition.\n\n        This structurally enforces \"to observe is to act.\"\n        \"\"\"\n        ...\n\n    def step(self, input: A) -&gt; B:\n        \"\"\"\n        Convenience method: step forward and update internal state.\n\n        Returns only the output; state is mutated in place.\n        \"\"\"\n        new_state, output = self.dynamics(self.state, input)\n        self.state = new_state\n        return output\n\n\n# Example: WorldHouse as PolyInterface\n@dataclass\nclass HouseState:\n    \"\"\"Internal state of a house entity.\"\"\"\n    observation_count: int = 0\n    last_observer_archetype: str | None = None\n    reified_properties: set[str] = field(default_factory=set)\n\nclass HouseInput:\n    \"\"\"Sum type of valid inputs (affordances).\"\"\"\n    pass\n\n@dataclass\nclass Observe(HouseInput):\n    \"\"\"Request to observe the house.\"\"\"\n    observer_archetype: str\n    intent: str  # What aspect to observe\n\n@dataclass\nclass Renovate(HouseInput):\n    \"\"\"Request to renovate (architect only).\"\"\"\n    changes: dict[str, Any]\n\n@dataclass\nclass Inhabit(HouseInput):\n    \"\"\"Request to enter the house.\"\"\"\n    duration: float\n\n@dataclass\nclass HouseOutput:\n    \"\"\"Output from house interactions.\"\"\"\n    view: \"Renderable\"\n    state_delta: dict[str, Any]  # What changed due to interaction\n\nclass WorldHouse(PolyInterface[HouseState, HouseInput, HouseOutput]):\n    \"\"\"\n    A house in the world, as a Polynomial Interface.\n\n    Note: The house REMEMBERS being observed. Each observation\n    reifies certain properties based on observer archetype.\n    \"\"\"\n\n    def scope(self, s: HouseState) -&gt; Type[HouseInput]:\n        # All inputs are always valid (for now)\n        # Could restrict based on state (e.g., can't renovate while inhabited)\n        return HouseInput\n\n    def dynamics(\n        self,\n        s: HouseState,\n        input: HouseInput,\n    ) -&gt; tuple[HouseState, HouseOutput]:\n        match input:\n            case Observe(archetype, intent):\n                # STATE TRANSITION: observation reifies properties\n                new_state = HouseState(\n                    observation_count=s.observation_count + 1,\n                    last_observer_archetype=archetype,\n                    reified_properties=s.reified_properties | self._reify(archetype),\n                )\n                view = self._render(archetype, intent, new_state)\n                return new_state, HouseOutput(view=view, state_delta={\"observed\": True})\n\n            case Renovate(changes):\n                new_state = self._apply_renovation(s, changes)\n                return new_state, HouseOutput(view=None, state_delta=changes)\n\n            case Inhabit(duration):\n                new_state = self._mark_inhabited(s, duration)\n                return new_state, HouseOutput(view=None, state_delta={\"inhabited\": duration})\n\n    def _reify(self, archetype: str) -&gt; set[str]:\n        \"\"\"Observation reifies properties based on who observes.\"\"\"\n        match archetype:\n            case \"architect\":\n                return {\"structural_integrity\", \"load_bearing_walls\", \"foundation_type\"}\n            case \"poet\":\n                return {\"atmosphere\", \"memories\", \"emotional_resonance\"}\n            case \"economist\":\n                return {\"market_value\", \"appreciation_rate\", \"comparable_sales\"}\n            case _:\n                return {\"exists\", \"location\"}\n</code></pre>"},{"location":"_archive/topos-of-becoming/#24-the-weave-replacing-contextwindow","title":"2.4 The Weave (Replacing ContextWindow)","text":"<p>Linear history is insufficient for concurrent agents. The Weave uses Trace Monoids to represent concurrent, braided history.</p> <pre><code>from dataclasses import dataclass, field\nfrom typing import Generic, TypeVar, FrozenSet\nfrom collections.abc import Hashable\n\nT = TypeVar(\"T\", bound=Hashable)\n\n@dataclass(frozen=True)\nclass Event(Generic[T]):\n    \"\"\"An event in the Weave.\"\"\"\n    id: str\n    content: T\n    timestamp: float\n    source: str  # Agent that emitted this event\n\n@dataclass\nclass TraceMonoid(Generic[T]):\n    \"\"\"\n    A Trace Monoid for concurrent history.\n\n    Unlike a linear list, a Trace Monoid captures:\n    - Independent (commutative) events that can be reordered\n    - Dependent events that must maintain order\n\n    The independence relation I \u2286 \u03a3 \u00d7 \u03a3 defines which\n    events commute. Events (a, b) \u2208 I can be swapped\n    without changing meaning.\n\n    Example:\n    - Agent A talks to Agent B (event ab)\n    - Agent C talks to Agent D (event cd)\n    - These are independent: ab\u00b7cd = cd\u00b7ab\n\n    But:\n    - Agent A talks to Agent B (event ab)\n    - Agent B talks to Agent C (event bc)\n    - These are dependent: ab must precede bc\n\n    This is the mathematical foundation for The Weave.\n    \"\"\"\n    events: list[Event[T]] = field(default_factory=list)\n    independence: FrozenSet[tuple[str, str]] = field(default_factory=frozenset)\n\n    # Dependency graph (DAG)\n    _dependencies: dict[str, set[str]] = field(default_factory=dict)\n\n    def append(\n        self,\n        event: Event[T],\n        depends_on: set[str] | None = None,\n    ) -&gt; \"TraceMonoid[T]\":\n        \"\"\"\n        Add an event to the Weave.\n\n        Args:\n            event: The event to add\n            depends_on: IDs of events this one depends on\n\n        Returns:\n            New TraceMonoid with event added\n        \"\"\"\n        new_events = self.events + [event]\n        new_deps = dict(self._dependencies)\n        new_deps[event.id] = depends_on or set()\n\n        return TraceMonoid(\n            events=new_events,\n            independence=self.independence,\n            _dependencies=new_deps,\n        )\n\n    def braid(self) -&gt; \"DependencyGraph\":\n        \"\"\"\n        Return the dependency structure as a graph.\n\n        This shows which events can be reordered (concurrent)\n        and which must maintain order (sequential).\n        \"\"\"\n        return DependencyGraph(self._dependencies)\n\n    def knot(self, event_ids: set[str]) -&gt; Event[T]:\n        \"\"\"\n        Create a synchronization point (knot) in the Weave.\n\n        A knot is where multiple concurrent threads must\n        synchronize before proceeding. It's a consensus point.\n\n        Args:\n            event_ids: Events that must all complete before knot\n\n        Returns:\n            A new Event representing the synchronization\n        \"\"\"\n        # All specified events become dependencies of the knot\n        knot_event = Event(\n            id=f\"knot-{hash(frozenset(event_ids))}\",\n            content=None,  # Knots have no content\n            timestamp=max(\n                e.timestamp for e in self.events if e.id in event_ids\n            ),\n            source=\"weave\",\n        )\n        return knot_event\n\n    def linearize(self) -&gt; list[Event[T]]:\n        \"\"\"\n        Produce a valid linear ordering (topological sort).\n\n        Note: Multiple valid orderings may exist due to\n        concurrency. This returns ONE valid ordering.\n        \"\"\"\n        # Kahn's algorithm for topological sort\n        ...\n\n    def project(self, agent: str) -&gt; list[Event[T]]:\n        \"\"\"\n        Project the Weave to a single agent's perspective.\n\n        Returns only events visible to the specified agent,\n        in their subjective order.\n        \"\"\"\n        return [e for e in self.events if self._visible_to(e, agent)]\n\n\n@dataclass\nclass TheWeave:\n    \"\"\"\n    High-level interface to the Weave system.\n\n    AGENTESE Integration:\n    - self.weave.braid  \u2192 View dependency structure\n    - self.weave.knot   \u2192 Create synchronization point\n    - self.weave.thread \u2192 Get single agent's perspective\n    \"\"\"\n    monoid: TraceMonoid\n\n    async def record(\n        self,\n        content: Any,\n        source: str,\n        depends_on: set[str] | None = None,\n    ) -&gt; str:\n        \"\"\"Record an event in the Weave.\"\"\"\n        event = Event(\n            id=generate_id(),\n            content=content,\n            timestamp=time.time(),\n            source=source,\n        )\n        self.monoid = self.monoid.append(event, depends_on)\n        return event.id\n\n    async def synchronize(self, agents: set[str]) -&gt; str:\n        \"\"\"\n        Create a synchronization point for multiple agents.\n\n        All agents must reach this point before any can proceed.\n        This is a \"knot\" in the Weave.\n        \"\"\"\n        # Find latest event from each agent\n        latest_events = {\n            e.id for e in self.monoid.events\n            if e.source in agents\n        }\n        knot = self.monoid.knot(latest_events)\n        self.monoid = self.monoid.append(knot, latest_events)\n        return knot.id\n</code></pre>"},{"location":"_archive/topos-of-becoming/#25-the-holographic-field-replacing-vector-db","title":"2.5 The Holographic Field (Replacing Vector DB)","text":"<p>Vector Databases (RAG) are fundamentally \"Object Retrieval\"\u2014you query for discrete objects. The Holographic Field uses Hyperdimensional Computing (HDC) for distributed, algebraic memory.</p> <pre><code>import numpy as np\nfrom dataclasses import dataclass, field\nfrom typing import Callable\n\n# HDC uses high-dimensional vectors (typically 10,000 dimensions)\nDIMENSIONS = 10_000\nVector = np.ndarray  # Shape: (DIMENSIONS,)\n\n@dataclass\nclass HolographicField:\n    \"\"\"\n    Hyperdimensional Computing (HDC) Memory.\n\n    Unlike Vector DBs which store discrete embeddings,\n    HDC stores information as a superposition in a\n    single high-dimensional vector (the hologram).\n\n    Key Operations:\n    - bind(*): Multiply vectors (role-filler binding)\n    - bundle(+): Add vectors (superposition)\n    - permute(P): Rotate vectors (sequence encoding)\n\n    Why this is revolutionary:\n    1. House * Architect \u22a5 House * Poet (algebraically!)\n       The same concept bound to different roles yields\n       orthogonal vectors. No complex Lens needed.\n\n    2. Morphic Resonance is INHERENT. When Agent A solves\n       a problem, it adds to the global superposition.\n       Agent B immediately \"feels\" the shift in similarity.\n\n    3. Graceful degradation. Partial matches work.\n       Memory is associative, not lookup-based.\n    \"\"\"\n\n    # The global hologram (superposition of all memories)\n    global_superposition: Vector = field(\n        default_factory=lambda: np.zeros(DIMENSIONS)\n    )\n\n    # Symbol codebook (random vectors for atomic concepts)\n    _codebook: dict[str, Vector] = field(default_factory=dict)\n\n    # Permutation matrix for sequence encoding\n    _permutation: np.ndarray = field(\n        default_factory=lambda: np.random.permutation(DIMENSIONS)\n    )\n\n    def get_symbol(self, name: str) -&gt; Vector:\n        \"\"\"\n        Get or create a random vector for an atomic symbol.\n\n        Atomic symbols are near-orthogonal in high dimensions.\n        \"\"\"\n        if name not in self._codebook:\n            vec = np.random.randn(DIMENSIONS)\n            vec = vec / np.linalg.norm(vec)  # Normalize\n            self._codebook[name] = vec\n        return self._codebook[name]\n\n    def bind(self, a: Vector, b: Vector) -&gt; Vector:\n        \"\"\"\n        Bind two vectors (role-filler association).\n\n        Uses circular convolution (equivalent to XOR in binary HDC).\n\n        Properties:\n        - bind(a, b) \u22a5 a  (orthogonal to components)\n        - bind(a, b) \u22a5 b\n        - bind(a, bind(a, b)) \u2248 b  (self-inverse)\n\n        Example:\n        - bind(HOUSE, ARCHITECT) creates a unique vector\n          representing \"house as seen by architect\"\n        \"\"\"\n        return np.fft.ifft(np.fft.fft(a) * np.fft.fft(b)).real\n\n    def bundle(self, vectors: list[Vector]) -&gt; Vector:\n        \"\"\"\n        Bundle vectors (superposition).\n\n        Creates a composite that is similar to all components.\n\n        Example:\n        - bundle([HOUSE, HOME, SHELTER]) creates a vector\n          similar to all three concepts\n        \"\"\"\n        result = np.sum(vectors, axis=0)\n        return result / np.linalg.norm(result)\n\n    def permute(self, v: Vector, n: int = 1) -&gt; Vector:\n        \"\"\"\n        Permute vector (sequence position encoding).\n\n        permute(v, 0) = v\n        permute(v, 1) = P(v)\n        permute(v, 2) = P(P(v))\n\n        Example:\n        - permute(WORD, 0) = first word\n        - permute(WORD, 1) = second word\n        \"\"\"\n        result = v.copy()\n        for _ in range(n):\n            result = result[self._permutation]\n        return result\n\n    def resonate(self, query: Vector) -&gt; float:\n        \"\"\"\n        Measure resonance with the global field.\n\n        This is \"Morphic Resonance\"\u2014how familiar is this\n        pattern to the collective memory?\n\n        Returns cosine similarity in [-1, 1].\n        \"\"\"\n        if np.linalg.norm(self.global_superposition) == 0:\n            return 0.0\n        return np.dot(\n            query / np.linalg.norm(query),\n            self.global_superposition / np.linalg.norm(self.global_superposition)\n        )\n\n    def imprint(self, experience: Vector, strength: float = 1.0) -&gt; None:\n        \"\"\"\n        Imprint experience into the global field.\n\n        Because the field is holographic:\n        - This doesn't overwrite; it nuances\n        - Repeated imprints strengthen patterns\n        - New patterns shift the whole field slightly\n\n        This IS Morphic Resonance. When one agent learns,\n        all agents feel the field shift.\n        \"\"\"\n        self.global_superposition += strength * experience\n        norm = np.linalg.norm(self.global_superposition)\n        if norm &gt; 0:\n            self.global_superposition /= norm\n\n    def query(self, pattern: Vector, threshold: float = 0.5) -&gt; list[tuple[str, float]]:\n        \"\"\"\n        Query the codebook for similar symbols.\n\n        Unlike vector DB, this doesn't return stored objects.\n        It returns symbolic associations based on similarity.\n        \"\"\"\n        results = []\n        for name, vec in self._codebook.items():\n            sim = np.dot(pattern, vec)\n            if sim &gt; threshold:\n                results.append((name, sim))\n        return sorted(results, key=lambda x: -x[1])\n\n    def encode_structure(\n        self,\n        structure: dict[str, Any],\n        role_binding: bool = True,\n    ) -&gt; Vector:\n        \"\"\"\n        Encode a structured object as a holographic vector.\n\n        Example:\n            encode_structure({\n                \"type\": \"observation\",\n                \"observer\": \"architect\",\n                \"target\": \"house\",\n                \"result\": \"blueprint\"\n            })\n\n        Creates: bundle([\n            bind(TYPE, OBSERVATION),\n            bind(OBSERVER, ARCHITECT),\n            bind(TARGET, HOUSE),\n            bind(RESULT, BLUEPRINT)\n        ])\n        \"\"\"\n        if not role_binding:\n            # Simple bundle of values\n            return self.bundle([\n                self.get_symbol(str(v)) for v in structure.values()\n            ])\n\n        # Role-filler binding\n        bound_pairs = []\n        for role, filler in structure.items():\n            role_vec = self.get_symbol(role)\n            filler_vec = self.get_symbol(str(filler))\n            bound_pairs.append(self.bind(role_vec, filler_vec))\n\n        return self.bundle(bound_pairs)\n\n\n# Global field instance (shared across all agents)\n# This enables Morphic Resonance without explicit communication\nGLOBAL_HOLOGRAM = HolographicField()\n</code></pre>"},{"location":"_archive/topos-of-becoming/#26-the-hypha-the-agent-as-growing-tip","title":"2.6 The Hypha (The Agent as Growing Tip)","text":"<p>The Hypha is the agent reimagined as a fungal growing tip that forages through semantic space.</p> <pre><code>from dataclasses import dataclass, field\nfrom enum import Enum, auto\nfrom typing import Any\n\nclass ForageAction(Enum):\n    \"\"\"Actions the Hypha can take based on Free Energy.\"\"\"\n    EXPLORE = auto()    # High surprise \u2192 branch out\n    EXPLOIT = auto()    # Low surprise, high reward \u2192 consolidate\n    PRUNE = auto()      # Low surprise, low reward \u2192 die back\n    WAIT = auto()       # Uncertain \u2192 gather more data\n\n@dataclass\nclass FreeEnergyState:\n    \"\"\"\n    Active Inference state.\n\n    Free Energy F = Complexity + Inaccuracy\n\n    The agent acts to minimize F by:\n    1. Updating beliefs (reduce inaccuracy)\n    2. Taking action (change world to match beliefs)\n    3. Attending selectively (ignore irrelevant)\n    \"\"\"\n    # Generative model's prediction\n    expected_observation: Vector\n\n    # Actual sensory observation\n    actual_observation: Vector\n\n    # Model complexity (how many parameters)\n    complexity: float = 0.0\n\n    @property\n    def prediction_error(self) -&gt; float:\n        \"\"\"Inaccuracy: divergence between expected and actual.\"\"\"\n        return np.linalg.norm(\n            self.expected_observation - self.actual_observation\n        )\n\n    @property\n    def free_energy(self) -&gt; float:\n        \"\"\"Variational Free Energy (to be minimized).\"\"\"\n        return self.complexity + self.prediction_error\n\n    @property\n    def surprise(self) -&gt; float:\n        \"\"\"Surprise is prediction error (for biological intuition).\"\"\"\n        return self.prediction_error\n\n\n@dataclass\nclass Hypha:\n    \"\"\"\n    The Agent as a Growing Tip (Hyphal Network Metaphor).\n\n    A hypha is a thread of a fungal mycelium. It:\n    - Grows towards nutrients (reward)\n    - Grows towards information (uncertainty reduction)\n    - Dies back when exploration yields nothing\n    - Connects to other hyphae at nodes (synchronization)\n\n    This replaces the \"Agent\" abstraction entirely.\n    \"\"\"\n\n    # Identity\n    id: str\n    name: str\n\n    # State\n    weave: TheWeave = field(default_factory=TheWeave)\n    hologram: HolographicField = field(default_factory=lambda: GLOBAL_HOLOGRAM)\n\n    # Active Inference\n    generative_model: \"GenerativeModel\" = None\n    free_energy_state: FreeEnergyState | None = None\n\n    # Growth parameters\n    exploration_rate: float = 0.3  # Probability of exploring vs exploiting\n    pruning_threshold: float = 0.1  # Free energy below which to prune\n\n    # Poly interface to the world\n    world_interface: PolyInterface | None = None\n\n    async def forage(self) -&gt; ForageAction:\n        \"\"\"\n        Active Inference Loop.\n\n        1. PREDICT: Generate expected observation from model\n        2. SENSE: Sample the world (via Poly dynamics)\n        3. ERROR: Compute prediction error (Free Energy)\n        4. ACT: Choose action based on error\n\n        This is the core \"heartbeat\" of the Hypha.\n        \"\"\"\n        # 1. PREDICT\n        context_vector = self._encode_context()\n        expected = self.generative_model.predict(context_vector)\n\n        # 2. SENSE\n        sense_input = Observe(\n            observer_archetype=self.name,\n            intent=\"forage\",\n        )\n        new_state, output = self.world_interface.dynamics(\n            self.world_interface.state,\n            sense_input,\n        )\n        self.world_interface.state = new_state\n\n        # Encode observation as vector\n        actual = self.hologram.encode_structure({\n            \"output\": str(output),\n            \"state_delta\": output.state_delta,\n        })\n\n        # 3. ERROR\n        self.free_energy_state = FreeEnergyState(\n            expected_observation=expected,\n            actual_observation=actual,\n            complexity=self.generative_model.complexity,\n        )\n\n        # 4. ACT\n        fe = self.free_energy_state.free_energy\n        surprise = self.free_energy_state.surprise\n\n        if surprise &gt; 0.8:\n            # High surprise \u2192 explore (branch the Weave)\n            return ForageAction.EXPLORE\n        elif surprise &lt; self.pruning_threshold:\n            # Very low surprise, check reward\n            reward = self._estimate_reward(output)\n            if reward &gt; 0.5:\n                # Found nutrients \u2192 consolidate\n                return ForageAction.EXPLOIT\n            else:\n                # No nutrients, no surprise \u2192 prune\n                return ForageAction.PRUNE\n        else:\n            # Moderate surprise \u2192 keep going\n            return ForageAction.WAIT\n\n    async def explore(self) -&gt; None:\n        \"\"\"\n        Branch the Weave (create new exploration thread).\n\n        This is void.entropy.sip in the new ontology\u2014\n        drawing from the accursed share to explore.\n        \"\"\"\n        # Record branch event in Weave\n        branch_id = await self.weave.record(\n            content={\"action\": \"explore\", \"surprise\": self.free_energy_state.surprise},\n            source=self.id,\n        )\n\n        # Update generative model with surprise\n        self.generative_model.update(\n            self.free_energy_state.actual_observation,\n            learning_rate=0.1,\n        )\n\n    async def exploit(self) -&gt; None:\n        \"\"\"\n        Consolidate learning (imprint to global field).\n\n        This is void.entropy.pour in the new ontology\u2014\n        returning information to the collective.\n        \"\"\"\n        # Imprint successful pattern to global hologram\n        success_pattern = self.hologram.encode_structure({\n            \"hypha\": self.id,\n            \"context\": self._encode_context(),\n            \"action\": \"success\",\n        })\n        self.hologram.imprint(success_pattern, strength=1.0)\n\n        # Record in Weave\n        await self.weave.record(\n            content={\"action\": \"exploit\", \"imprinted\": True},\n            source=self.id,\n        )\n\n    async def prune(self) -&gt; None:\n        \"\"\"\n        Die back (release resources).\n\n        This is the Accursed Share in action\u2014information\n        that yields no reduction in Free Energy must be\n        discharged.\n        \"\"\"\n        # Record pruning in Weave\n        await self.weave.record(\n            content={\"action\": \"prune\", \"reason\": \"no_nutrients\"},\n            source=self.id,\n        )\n\n        # Release exploration budget\n        # (In a full implementation, this would free compute resources)\n\n    def _encode_context(self) -&gt; Vector:\n        \"\"\"Encode current context as holographic vector.\"\"\"\n        recent_events = self.weave.monoid.events[-10:]  # Last 10 events\n        if not recent_events:\n            return np.zeros(DIMENSIONS)\n\n        event_vectors = [\n            self.hologram.encode_structure({\n                \"event\": e.id,\n                \"source\": e.source,\n                \"content\": str(e.content),\n            })\n            for e in recent_events\n        ]\n\n        # Permute by position for sequence encoding\n        positioned = [\n            self.hologram.permute(v, i)\n            for i, v in enumerate(event_vectors)\n        ]\n\n        return self.hologram.bundle(positioned)\n\n    def _estimate_reward(self, output: Any) -&gt; float:\n        \"\"\"Estimate reward from output (domain-specific).\"\"\"\n        # Placeholder\u2014real implementation would use\n        # domain-specific reward function\n        return 0.5\n\n\n@dataclass\nclass GenerativeModel:\n    \"\"\"\n    The Hypha's internal model of the world.\n\n    Predicts observations and updates based on error.\n    \"\"\"\n    # Simple linear model for demonstration\n    weights: Vector = field(default_factory=lambda: np.random.randn(DIMENSIONS))\n\n    @property\n    def complexity(self) -&gt; float:\n        \"\"\"Model complexity (L2 norm of weights).\"\"\"\n        return np.linalg.norm(self.weights)\n\n    def predict(self, context: Vector) -&gt; Vector:\n        \"\"\"Predict expected observation from context.\"\"\"\n        # Simple linear prediction\n        return context * self.weights\n\n    def update(self, actual: Vector, learning_rate: float = 0.1) -&gt; None:\n        \"\"\"Update model based on actual observation.\"\"\"\n        # Gradient descent on prediction error\n        predicted = self.predict(actual)\n        error = actual - predicted\n        self.weights += learning_rate * error\n</code></pre>"},{"location":"_archive/topos-of-becoming/#part-iii-agentese-path-migration","title":"Part III: AGENTESE Path Migration","text":"<p>The shift from Objects to Interactions requires new AGENTESE paths.</p>"},{"location":"_archive/topos-of-becoming/#31-path-mapping","title":"3.1 Path Mapping","text":"Old Path Old Concept New Path New Concept <code>self.stream.focus</code> Current turn (extract) <code>self.weave.tip</code> Current growth point <code>self.stream.map</code> Context transform <code>self.weave.braid</code> Dependency structure <code>self.stream.seek</code> Navigate history <code>self.weave.thread</code> Agent's perspective <code>self.stream.project</code> Compress <code>self.weave.knot</code> Synchronization point <code>self.memory.recall</code> Vector lookup <code>field.resonate</code> Similarity check (HDC) <code>self.memory.store</code> Vector insert <code>field.imprint</code> Superposition add <code>world.*.manifest</code> Get representation <code>world.poly.step</code> Dynamics transition <code>world.*.affordances</code> List verbs <code>world.poly.scope</code> Input type <code>void.entropy.sip</code> Draw randomness <code>void.prune</code> Die back (release) <code>void.entropy.pour</code> Return randomness <code>void.pulse</code> Vitality rate <code>concept.*.define</code> Create concept <code>field.bind</code> Role-filler binding <code>concept.*.refine</code> Challenge <code>hypha.forage</code> Active inference step"},{"location":"_archive/topos-of-becoming/#32-new-paths","title":"3.2 New Paths","text":"Path Operation Implementation <code>self.weave.tip</code> Current growth position <code>Hypha._encode_context()</code> <code>self.weave.braid</code> Dependency graph <code>TraceMonoid.braid()</code> <code>self.weave.knot</code> Create sync point <code>TheWeave.synchronize()</code> <code>self.weave.thread</code> Single-agent view <code>TraceMonoid.project()</code> <code>field.resonate</code> HDC similarity <code>HolographicField.resonate()</code> <code>field.imprint</code> HDC superposition <code>HolographicField.imprint()</code> <code>field.bind</code> HDC role binding <code>HolographicField.bind()</code> <code>field.bundle</code> HDC composition <code>HolographicField.bundle()</code> <code>world.poly.step</code> Dynamics execution <code>PolyInterface.dynamics()</code> <code>world.poly.scope</code> Input type query <code>PolyInterface.scope()</code> <code>hypha.forage</code> Active inference <code>Hypha.forage()</code> <code>hypha.explore</code> Branch weave <code>Hypha.explore()</code> <code>hypha.exploit</code> Consolidate <code>Hypha.exploit()</code> <code>hypha.prune</code> Die back <code>Hypha.prune()</code> <code>void.prune</code> Release resources Accursed Share discharge <code>void.pulse</code> Vitality metric Rate of <code>dynamics()</code> calls"},{"location":"_archive/topos-of-becoming/#33-context-migration","title":"3.3 Context Migration","text":"Old Context New Context Principle <code>world.*</code> <code>world.poly.*</code> Everything is Poly <code>self.*</code> <code>self.weave.*</code> + <code>hypha.*</code> Agent is Hypha <code>concept.*</code> <code>field.*</code> Concepts are HDC bindings <code>void.*</code> <code>void.*</code> Unchanged (Accursed Share) <code>time.*</code> <code>self.weave.*</code> Time is in the Weave"},{"location":"_archive/topos-of-becoming/#part-iv-implementation-phases","title":"Part IV: Implementation Phases","text":""},{"location":"_archive/topos-of-becoming/#phase-1-the-holographic-soil-hdc-foundation","title":"Phase 1: The Holographic Soil (HDC Foundation)","text":"<p>Goal: Replace vector embeddings with Hyperdimensional Computing.</p> <p>Files to Create: <pre><code>impl/claude/\n\u251c\u2500\u2500 field/\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 holographic.py      # HolographicField class\n\u2502   \u251c\u2500\u2500 hdc_ops.py          # bind, bundle, permute\n\u2502   \u2514\u2500\u2500 _tests/\n\u2502       \u251c\u2500\u2500 test_hdc.py\n\u2502       \u2514\u2500\u2500 test_resonance.py\n</code></pre></p> <p>Exit Criteria: <pre><code># Test: Agent B \"feels\" Agent A's learning\nfield = HolographicField()\n\n# Agent A learns something\npattern_a = field.encode_structure({\"problem\": \"auth\", \"solution\": \"jwt\"})\nfield.imprint(pattern_a)\n\n# Agent B queries with similar problem\nquery_b = field.encode_structure({\"problem\": \"auth\"})\nresonance = field.resonate(query_b)\n\nassert resonance &gt; 0.5  # Agent B feels the pattern\n</code></pre></p> <p>Tests: 40+</p>"},{"location":"_archive/topos-of-becoming/#phase-2-the-poly-core-interface-revolution","title":"Phase 2: The Poly Core (Interface Revolution)","text":"<p>Goal: Replace LogosNode with PolyInterface. Ensure observation always triggers state transition.</p> <p>Files to Create: <pre><code>impl/claude/\n\u251c\u2500\u2500 poly/\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 interface.py        # PolyInterface base class\n\u2502   \u251c\u2500\u2500 profunctor.py       # LogosProfunctor\n\u2502   \u251c\u2500\u2500 morphism.py         # PolyMorphism composition\n\u2502   \u2514\u2500\u2500 _tests/\n\u2502       \u251c\u2500\u2500 test_interface.py\n\u2502       \u251c\u2500\u2500 test_dynamics.py\n\u2502       \u2514\u2500\u2500 test_profunctor.py\n</code></pre></p> <p>Migration: 1. Create <code>PolyInterface</code> protocol 2. Implement <code>WorldHouse</code> as example 3. Create <code>LogosProfunctor</code> to replace <code>Logos</code> 4. Migrate existing LogosNodes one by one</p> <p>Exit Criteria: <pre><code># Test: Observation ALWAYS triggers state transition\nhouse = WorldHouse(state=HouseState())\n\n# Before observation\nassert house.state.observation_count == 0\n\n# Observe\noutput = house.step(Observe(observer_archetype=\"architect\", intent=\"view\"))\n\n# State MUST have changed\nassert house.state.observation_count == 1\nassert \"structural_integrity\" in house.state.reified_properties\n</code></pre></p> <p>Tests: 50+</p>"},{"location":"_archive/topos-of-becoming/#phase-3-the-weave-concurrent-history","title":"Phase 3: The Weave (Concurrent History)","text":"<p>Goal: Replace linear ContextWindow with TraceMonoid-backed Weave.</p> <p>Files to Create: <pre><code>impl/claude/\n\u251c\u2500\u2500 weave/\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 trace_monoid.py     # TraceMonoid implementation\n\u2502   \u251c\u2500\u2500 weave.py            # TheWeave high-level API\n\u2502   \u251c\u2500\u2500 dependency.py       # DependencyGraph utilities\n\u2502   \u2514\u2500\u2500 _tests/\n\u2502       \u251c\u2500\u2500 test_trace_monoid.py\n\u2502       \u251c\u2500\u2500 test_concurrency.py\n\u2502       \u2514\u2500\u2500 test_synchronization.py\n</code></pre></p> <p>Exit Criteria: <pre><code># Test: Concurrent events can be reordered\nweave = TheWeave()\n\n# Two independent events\nid_a = await weave.record({\"msg\": \"A to B\"}, source=\"agent_a\")\nid_c = await weave.record({\"msg\": \"C to D\"}, source=\"agent_c\")\n\n# These are concurrent (no dependency)\nbraid = weave.monoid.braid()\nassert braid.are_concurrent(id_a, id_c)\n\n# Dependent event\nid_b = await weave.record({\"msg\": \"B to C\"}, source=\"agent_b\", depends_on={id_a})\nassert not braid.are_concurrent(id_a, id_b)\n</code></pre></p> <p>Tests: 45+</p>"},{"location":"_archive/topos-of-becoming/#phase-4-the-drive-active-inference","title":"Phase 4: The Drive (Active Inference)","text":"<p>Goal: Implement Hypha with Active Inference foraging loop.</p> <p>Files to Create: <pre><code>impl/claude/\n\u251c\u2500\u2500 hypha/\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 hypha.py            # Hypha agent class\n\u2502   \u251c\u2500\u2500 free_energy.py      # FreeEnergyState, GenerativeModel\n\u2502   \u251c\u2500\u2500 foraging.py         # Foraging logic\n\u2502   \u2514\u2500\u2500 _tests/\n\u2502       \u251c\u2500\u2500 test_hypha.py\n\u2502       \u251c\u2500\u2500 test_free_energy.py\n\u2502       \u2514\u2500\u2500 test_foraging.py\n</code></pre></p> <p>Exit Criteria: <pre><code># Test: Hypha responds to surprise appropriately\nhypha = Hypha(id=\"test\", name=\"test-hypha\")\n\n# High surprise \u2192 explore\nhypha.free_energy_state = FreeEnergyState(\n    expected_observation=np.zeros(DIMENSIONS),\n    actual_observation=np.random.randn(DIMENSIONS),  # Very different\n)\naction = await hypha.forage()\nassert action == ForageAction.EXPLORE\n\n# Low surprise, low reward \u2192 prune\nhypha.free_energy_state = FreeEnergyState(\n    expected_observation=np.ones(DIMENSIONS),\n    actual_observation=np.ones(DIMENSIONS) * 1.01,  # Very similar\n)\naction = await hypha.forage()\nassert action == ForageAction.PRUNE\n</code></pre></p> <p>Tests: 40+</p>"},{"location":"_archive/topos-of-becoming/#phase-5-integration-and-migration","title":"Phase 5: Integration and Migration","text":"<p>Goal: Wire everything together and migrate existing agents.</p> <p>Tasks: 1. Update AGENTESE contexts to use new paths 2. Create migration adapters for existing agents 3. Update <code>protocols/agentese/logos.py</code> to use <code>LogosProfunctor</code> 4. Update <code>agents/d/</code> to use Weave instead of ContextWindow 5. Update <code>agents/i/</code> semantic field to use HolographicField 6. Full integration tests</p> <p>Exit Criteria: - All existing tests pass (with adapters where needed) - New paths (<code>field.*</code>, <code>hypha.*</code>, <code>world.poly.*</code>) functional - Mypy passes with 0 errors - Documentation updated</p>"},{"location":"_archive/topos-of-becoming/#part-v-integration-with-existing-specs","title":"Part V: Integration with Existing Specs","text":""},{"location":"_archive/topos-of-becoming/#51-mapping-to-agent-genera","title":"5.1 Mapping to Agent Genera","text":"Agent Current Role v4.0 Role A-gent Skeleton architecture Unchanged (structure is orthogonal) B-gent Token economics Integrate with Free Energy budgets C-gent Composition Poly morphism composition D-gent State/Memory Replaced by Weave + HolographicField E-gent Thermodynamics Now structural (Active Inference) I-gent Interface Visualize Weave and Field L-gent Registry Register PolyInterfaces M-gent Cartography Navigate HolographicField topology N-gent Narrative Project Weave to linear story T-gent Testing Test Poly dynamics, verify state transitions W-gent Wire protocol Carry Poly morphisms"},{"location":"_archive/topos-of-becoming/#52-spec-compatibility","title":"5.2 Spec Compatibility","text":"Spec Compatibility Notes <code>principles.md</code> Full Poly strengthens AGENTESE principle <code>agentese.md</code> Update paths New paths, same philosophy <code>d-gents/lenses.md</code> Partial Lenses still useful for focused Poly views <code>e-gents/thermodynamics.md</code> Evolved Active Inference replaces \u0394G budget <code>c-gents/composition.md</code> Full Poly morphisms compose"},{"location":"_archive/topos-of-becoming/#53-what-gets-deprecated","title":"5.3 What Gets Deprecated","text":"Component Reason Replacement <code>ContextWindow</code> Linear history insufficient <code>TheWeave</code> <code>ContextComonad</code> Store \u2192 Poly <code>PolyInterface.dynamics()</code> <code>LinearityMap</code> Resource classes subsumed Poly scope <code>ContextProjector</code> Galois Connection HDC bundle/unbundle <code>ModalScope</code> Git metaphor Weave braiding <code>Pulse</code> Vitality signals <code>void.pulse</code> (dynamics rate) <code>StateCrystal</code> Checkpoint Weave knots"},{"location":"_archive/topos-of-becoming/#part-vi-success-criteria","title":"Part VI: Success Criteria","text":""},{"location":"_archive/topos-of-becoming/#61-quantitative-metrics","title":"6.1 Quantitative Metrics","text":"Metric Target Verification Observation triggers state change 100% Property test all <code>dynamics()</code> Inter-agent resonance latency &lt;10ms Benchmark HDC imprint/resonate Weave concurrent events Support 1000+ Stress test TraceMonoid Poly interface compliance 100% Type check all world.* Tests 200+ new pytest count Mypy 0 errors <code>uv run mypy .</code>"},{"location":"_archive/topos-of-becoming/#62-qualitative-criteria","title":"6.2 Qualitative Criteria","text":"Criterion Description Verification No Passive Observation Every <code>manifest</code> equivalent triggers state transition Code review Morphic Resonance Works Agent B learns from Agent A without message passing Integration test Weave Captures Concurrency Independent events commute Property test Active Inference Drives Behavior Hypha acts to minimize Free Energy Behavior test Profunctor Logos Multiple Logos instances possible Test Real vs Dream logos"},{"location":"_archive/topos-of-becoming/#63-philosophical-criteria","title":"6.3 Philosophical Criteria","text":"Criterion Question Evidence Interaction-Oriented Are agents defined by what they DO, not what they ARE? Poly interface, no static properties Mycological Does it feel like growing, not storing? Hypha foraging metaphor Holographic Is memory distributed, not located? No vector DB lookups Concurrent Do agents have subjective time? Weave braiding Thermodynamic Is behavior driven by gradients, not budgets? Free Energy minimization"},{"location":"_archive/topos-of-becoming/#part-vii-risks-and-mitigations","title":"Part VII: Risks and Mitigations","text":"Risk Likelihood Impact Mitigation HDC learning curve High Medium Provide clear examples, reference papers Poly abstraction overhead Medium Medium Optimize hot paths, lazy evaluation Weave complexity Medium High Start with simple dependencies, evolve Migration disruption High High Provide adapters, gradual rollout Performance regression Medium Medium Benchmark continuously Spec/Impl divergence Low High Spec-first development discipline"},{"location":"_archive/topos-of-becoming/#appendix-a-mathematical-references","title":"Appendix A: Mathematical References","text":""},{"location":"_archive/topos-of-becoming/#polynomial-functors","title":"Polynomial Functors","text":"<ul> <li>Polynomial Functors: A Mathematical Theory of Interaction - Spivak &amp; Niu (2022)</li> <li>Poly: An abundant categorical setting - Spivak (2020)</li> <li>Dynamical Systems and Sheaves - Schultz, Spivak, Vasilakopoulou (2016)</li> </ul>"},{"location":"_archive/topos-of-becoming/#trace-monoids","title":"Trace Monoids","text":"<ul> <li>Trace Theory - Mazurkiewicz (1977)</li> <li>The Book of Traces - Diekert &amp; Rozenberg (1995)</li> </ul>"},{"location":"_archive/topos-of-becoming/#hyperdimensional-computing","title":"Hyperdimensional Computing","text":"<ul> <li>Hyperdimensional Computing: An Introduction - Kanerva (2009)</li> <li>Vector Symbolic Architectures - Kleyko et al (2021)</li> </ul>"},{"location":"_archive/topos-of-becoming/#active-inference","title":"Active Inference","text":"<ul> <li>The Free Energy Principle - Friston (2010)</li> <li>Active Inference: A Process Theory - Friston et al (2017)</li> </ul>"},{"location":"_archive/topos-of-becoming/#appendix-b-glossary","title":"Appendix B: Glossary","text":"Term Definition Poly The category of polynomial functors; our mathematical foundation PolyInterface A polynomial functor as a programming interface Dynamics The state transition function S \u00d7 A \u2192 S \u00d7 B Scope The set of valid inputs at a given state Hypha An agent as a growing fungal tip Weave Concurrent history structure (Trace Monoid) Braid Dependency structure within the Weave Knot Synchronization point in the Weave HolographicField HDC-based distributed memory Resonate Query similarity in HDC field Imprint Add pattern to HDC superposition Free Energy Complexity + Prediction Error (to be minimized) Forage Active Inference loop (predict-sense-act) Prune Die back when exploration yields nothing Morphic Resonance Cross-agent learning via shared HDC field"},{"location":"_archive/topos-of-becoming/#appendix-c-migration-checklist","title":"Appendix C: Migration Checklist","text":""},{"location":"_archive/topos-of-becoming/#phase-1-hdc-complete-99-tests","title":"Phase 1: HDC \u2705 COMPLETE (99 tests)","text":"<ul> <li> Implement <code>HolographicField</code> class</li> <li> Implement <code>bind()</code>, <code>bundle()</code>, <code>permute()</code></li> <li> Test cross-agent resonance</li> <li> Benchmark performance</li> </ul>"},{"location":"_archive/topos-of-becoming/#phase-2-poly-complete-83-tests","title":"Phase 2: Poly \u2705 COMPLETE (83 tests)","text":"<ul> <li> Define <code>PolyInterface</code> protocol</li> <li> Implement <code>LogosProfunctor</code></li> <li> Convert <code>WorldHouse</code> to Poly</li> <li> Verify state transition on all observations</li> <li> Migrate remaining LogosNodes</li> </ul>"},{"location":"_archive/topos-of-becoming/#phase-3-weave-complete-70-tests","title":"Phase 3: Weave \u2705 COMPLETE (70 tests)","text":"<ul> <li> Implement <code>TraceMonoid</code></li> <li> Implement <code>TheWeave</code> API</li> <li> Test concurrent event reordering</li> <li> Test synchronization (knots)</li> <li> Deprecate <code>ContextWindow</code></li> </ul>"},{"location":"_archive/topos-of-becoming/#phase-4-hypha-complete-68-tests","title":"Phase 4: Hypha \u2705 COMPLETE (68 tests)","text":"<ul> <li> Implement <code>Hypha</code> class</li> <li> Implement <code>FreeEnergyState</code></li> <li> Implement <code>forage()</code> loop</li> <li> Test behavior based on surprise</li> <li> Integrate with Weave and Field</li> </ul>"},{"location":"_archive/topos-of-becoming/#phase-5-integration","title":"Phase 5: Integration","text":"<ul> <li> Update AGENTESE paths</li> <li> Create migration adapters</li> <li> Update agent genera</li> <li> Full test suite</li> <li> Documentation</li> </ul> <p>\"The organism is not a noun. It is a set of interaction patterns that persist through time. We do not store context; we grow through it.\"</p> <p>\u2014 The Topos of Becoming</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/","title":"Categorical Critique of Creative Exploration","text":"<p>\"The plan is not the territory. The functor is.\"</p> <p>Purpose: Critique 15 sessions through category-theoretic lens Method: Apply Spivak's polynomial functors, operads, and topos theory Outcome: Identify path to true generativity vs. enumeration</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#executive-critique","title":"Executive Critique","text":""},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#what-the-plans-do-well","title":"What the Plans Do Well","text":"<ol> <li>Agents as Morphisms: Core isomorphism <code>Agent[A,B] \u2245 A \u2192 B</code> is correctly grounded</li> <li>Functor Infrastructure: Universal Functor Protocol with lift/unlift symmetry</li> <li>Composition Laws: Identity and associativity verified at runtime</li> <li>AGENTESE Ontology: Observer-dependent affordances (sheaf-like structure)</li> </ol>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#what-the-plans-get-wrong","title":"What the Plans Get Wrong","text":"<ol> <li>Enumerative, Not Generative: 600+ ideas are listed, not derived</li> <li>Missing Operads: Composition syntax is implicit, not programmable</li> <li>No Polynomial Dynamics: Agents lack position/direction structure</li> <li>Weak Emergence Model: No formal path from local \u2192 global</li> <li>CLI-Centric, Not Spec-Centric: Ideas expressed as commands, not types</li> </ol>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#critique-1-the-enumeration-problem","title":"Critique 1: The Enumeration Problem","text":""},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#current-state","title":"Current State","text":"<pre><code>Session 1: 50 ideas\nSession 2: 45 ideas\n...\nSession 15: 40 ideas\nTotal: 600+ ideas\n</code></pre> <p>This is counting, not composition.</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#the-categorical-problem","title":"The Categorical Problem","text":"<p>If agents are morphisms, then the space of agents should be a category, not a list. The questions should be:</p> <ul> <li>What are the generating morphisms?</li> <li>What closure operations produce new morphisms?</li> <li>What natural transformations relate different agents?</li> </ul>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#whats-missing","title":"What's Missing","text":"<p>The plans enumerate instances of composed agents, not the algebra of composition itself.</p> <pre><code>Current:  \"kg soul vibe\" (instance)\n          \"kg soul shadow\" (instance)\n          \"kg soul dialectic\" (instance)\n\nNeeded:   Soul: Operad\n          soul.compose(vibe, shadow) \u2192 dialectic (derivation)\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#categorical-fix","title":"Categorical Fix","text":"<p>Define operads, not CLI commands. An operad O describes how things compose. The CLI commands should be O-algebras\u2014specific instantiations of the grammar.</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#critique-2-missing-polynomial-structure","title":"Critique 2: Missing Polynomial Structure","text":""},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#spivaks-insight","title":"Spivak's Insight","text":"<p>From Polynomial Functors: A Mathematical Theory of Interaction:</p> <p>\"A polynomial functor is a collection of positions and, for each position, a collection of directions.\"</p> <pre><code>P(y) = \u03a3_{i \u2208 Position} y^{Direction_i}\n</code></pre> <p>This captures dynamical systems with: - Positions = states the system can be in - Directions = inputs the system can receive at each position</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#what-kgents-has","title":"What kgents Has","text":"<pre><code>class Agent[A, B]:\n    async def invoke(self, x: A) -&gt; B:\n        ...\n</code></pre> <p>This is a function, not a polynomial. It has: - One implicit position (the agent exists) - One direction type (A) - One output (B)</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#what-kgents-needs","title":"What kgents Needs","text":"<pre><code>class PolyAgent[S, A, B]:\n    \"\"\"Agent as polynomial functor.\"\"\"\n    positions: set[S]           # States the agent can be in\n    directions: Callable[[S], set[A]]  # Inputs accepted per state\n    transitions: Callable[[S, A], tuple[S, B]]  # State \u00d7 Input \u2192 State \u00d7 Output\n</code></pre> <p>This enables: - Composition of dynamical systems (not just functions) - Mode-dependent behavior (different inputs valid in different states) - Wiring diagrams as morphisms between polynomials</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#example-k-gent-as-polynomial","title":"Example: K-gent as Polynomial","text":"<pre><code># Current (functional)\nclass Kgent(Agent[str, SoulResponse]):\n    async def invoke(self, query: str) -&gt; SoulResponse:\n        ...\n\n# Polynomial (dynamical)\nclass KgentPoly(PolyAgent):\n    positions = {REFLECT, ADVISE, CHALLENGE, EXPLORE}  # The four modes\n\n    def directions(self, mode: Mode) -&gt; set[QueryType]:\n        match mode:\n            case REFLECT: return {Introspection, Mirror}\n            case CHALLENGE: return {Thesis, Question}\n            ...\n\n    def transition(self, mode: Mode, query: Query) -&gt; tuple[Mode, Response]:\n        # Mode can change based on interaction\n        ...\n</code></pre> <p>Now K-gent is a dynamical system, not a function. Composition with other agents becomes wiring diagrams.</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#critique-3-operads-are-implicit","title":"Critique 3: Operads Are Implicit","text":""},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#current-composition","title":"Current Composition","text":"<pre><code>pipeline = Ground() &gt;&gt; Judge() &gt;&gt; Sublate()\n</code></pre> <p>The <code>&gt;&gt;</code> operator is hardcoded sequential composition. There's no grammar describing what compositions are valid.</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#operads-make-grammar-explicit","title":"Operads Make Grammar Explicit","text":"<p>From Operads for Complex System Design:</p> <p>\"An operad O defines a theory or grammar of composition, and operad functors O \u2192 Set, known as O-algebras, describe particular applications that obey that grammar.\"</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#what-kgents-should-have","title":"What kgents Should Have","text":"<pre><code># Define the operad of agent composition\nclass AgentOperad:\n    \"\"\"Grammar of how agents compose.\"\"\"\n\n    # Generating operations\n    operations = {\n        \"seq\": Arity(2),      # Sequential: A &gt;&gt; B\n        \"par\": Arity(n),      # Parallel: (A, B, C)\n        \"branch\": Arity(3),   # Conditional: if P then A else B\n        \"fix\": Arity(1),      # Recursion: retry/loop\n        \"trace\": Arity(1),    # Observation: with logging\n    }\n\n    # Composition laws (equations in the operad)\n    laws = [\n        \"seq(seq(a, b), c) = seq(a, seq(b, c))\",  # Associativity\n        \"seq(id, a) = a = seq(a, id)\",             # Identity\n        \"par(a, par(b, c)) = par(par(a, b), c)\",   # Parallel assoc\n    ]\n\n# CLI commands become O-algebras\nclass SoulOperad(AgentOperad):\n    \"\"\"Soul-specific composition grammar.\"\"\"\n    operations = AgentOperad.operations | {\n        \"introspect\": Arity(3),  # vibe &gt;&gt; shadow &gt;&gt; dialectic\n        \"challenge\": Arity(2),   # thesis &gt;&gt; antithesis\n    }\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#benefit-automatic-generation","title":"Benefit: Automatic Generation","text":"<p>With an operad, you don't enumerate 600 ideas. You: 1. Define the generating operations 2. Let closure generate all valid compositions 3. Filter by constraints (type compatibility, governance)</p> <pre><code># Generate all valid 3-step soul pipelines\nvalid_pipelines = soul_operad.enumerate(depth=3, filter=type_safe)\n# Returns: [vibe&gt;&gt;shadow&gt;&gt;dialectic, reflect&gt;&gt;advise&gt;&gt;challenge, ...]\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#critique-4-no-sheaf-structure-for-emergence","title":"Critique 4: No Sheaf Structure for Emergence","text":""},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#the-emergence-problem","title":"The Emergence Problem","text":"<p>The plans discuss \"emergent capabilities\" but provide no formal model. What does it mean for behavior to emerge from composition?</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#topos-theory-answer","title":"Topos Theory Answer","text":"<p>From Sheaves in Geometry and Logic:</p> <p>\"A sheaf is defined as a presheaf satisfying locality and gluing conditions, ensuring coherent global structure while preserving local properties.\"</p> <p>Emergence is the gluing operation: local behaviors combine to produce global behavior.</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#what-kgents-has_1","title":"What kgents Has","text":"<p>AGENTESE has sheaf-like intuition:</p> <pre><code># Different observers, different views\nawait logos.invoke(\"world.house.manifest\", architect_umwelt)  # Local view\nawait logos.invoke(\"world.house.manifest\", poet_umwelt)       # Another local view\n</code></pre> <p>But there's no gluing. No way to combine local views into global truth.</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#what-kgents-needs_1","title":"What kgents Needs","text":"<pre><code>class AgentSheaf:\n    \"\"\"Agents form a sheaf over the observation topology.\"\"\"\n\n    def restriction(self, agent: Agent, subcontext: Context) -&gt; Agent:\n        \"\"\"Restrict agent behavior to smaller context.\"\"\"\n        ...\n\n    def glue(self, local_agents: dict[Context, Agent]) -&gt; Agent:\n        \"\"\"Glue compatible local agents into global agent.\n\n        Precondition: local agents agree on overlaps.\n        \"\"\"\n        for (ctx1, a1), (ctx2, a2) in overlapping_pairs(local_agents):\n            assert self.restriction(a1, ctx1 \u2229 ctx2) == self.restriction(a2, ctx1 \u2229 ctx2)\n\n        return GlobalAgent(local_agents)\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#example-emergent-soul","title":"Example: Emergent Soul","text":"<pre><code># Local soul views\naesthetic_soul = soul.restrict(AestheticContext)      # 0.15\ncategorical_soul = soul.restrict(CategoricalContext)  # 0.92\njoy_soul = soul.restrict(JoyContext)                  # 0.75\n\n# Glue into global soul\nglobal_soul = soul_sheaf.glue({\n    AestheticContext: aesthetic_soul,\n    CategoricalContext: categorical_soul,\n    JoyContext: joy_soul,\n})\n\n# Global soul has emergent behavior from combined constraints\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#critique-5-devex-is-disconnected-from-spec","title":"Critique 5: DevEx Is Disconnected from Spec","text":""},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#current-devex-stack","title":"Current DevEx Stack","text":"<p>From codebase exploration: - Ghost Sensorium: Projects state to files - Flinch System: Captures test failures - HYDRATE Signals: Appends to living document - Triad Health: Database monitoring</p> <p>These are operational tools, not categorical tools.</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#the-gap","title":"The Gap","text":"<p>DevEx should be a functor from the spec category to the implementation category:</p> <pre><code>DevEx: Spec \u2192 Impl\nDevEx(composition_law) = test that verifies composition\nDevEx(type_signature) = CLI command with that signature\nDevEx(operad_operation) = handler that implements operation\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#whats-missing_1","title":"What's Missing","text":"<p>No formal connection between: - Spec documents and their test coverage - Type signatures and CLI implementations - Categorical laws and runtime verification</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#categorical-devex","title":"Categorical DevEx","text":"<pre><code>class SpecProjector:\n    \"\"\"Functor from spec to implementation.\"\"\"\n\n    def lift_type(self, spec_type: TypeSpec) -&gt; PythonType:\n        \"\"\"Spec type \u2192 Python type.\"\"\"\n        ...\n\n    def lift_law(self, law: CategoricalLaw) -&gt; Test:\n        \"\"\"Categorical law \u2192 pytest test.\"\"\"\n        ...\n\n    def lift_operation(self, op: OperadOperation) -&gt; CLIHandler:\n        \"\"\"Operad operation \u2192 CLI handler.\"\"\"\n        ...\n</code></pre> <p>Now DevEx is generative: specs produce implementations, not vice versa.</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#critique-6-the-plans-lack-a-meta-level","title":"Critique 6: The Plans Lack a Meta-Level","text":""},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#the-real-problem","title":"The Real Problem","text":"<p>The 15 sessions are conversations. They produce ideas. But they don't produce the machinery to produce ideas.</p> <p>This is the meta-level gap: we have objects (ideas) but not the category (idea-generation).</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#whats-needed-a-meta-construction-system","title":"What's Needed: A Meta-Construction System","text":"<p>The system should: 1. Define primitives (atomic operations, base types) 2. Define combinators (operads, composition grammars) 3. Enable closure (generate all valid compositions) 4. Support emergence (sheaf gluing for global from local) 5. Allow chaos (void.* for stochastic exploration)</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#toward-meta-construction","title":"Toward Meta-Construction","text":""},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#the-three-layers","title":"The Three Layers","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Layer 3: EMERGENCE                                          \u2502\n\u2502  Sheaves, Gluing, Global from Local                          \u2502\n\u2502  \"What behaviors arise from composition?\"                    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  Layer 2: COMPOSITION                                        \u2502\n\u2502  Operads, Wiring Diagrams, Polynomial Composition            \u2502\n\u2502  \"How do primitives combine?\"                                \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  Layer 1: PRIMITIVES                                         \u2502\n\u2502  Base Agents, Types, Atomic Operations                       \u2502\n\u2502  \"What are the building blocks?\"                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#the-meta-construction-principle","title":"The Meta-Construction Principle","text":"<p>Careful design OR chaotic happenstance.</p> <p>Both paths should lead to valid compositions:</p> <pre><code># Careful design: explicit operad composition\npipeline = soul_operad.compose([\"vibe\", \"shadow\", \"dialectic\"])\n\n# Chaotic happenstance: void.* stochastic composition\npipeline = await void.compose.sip(\n    primitives=[\"vibe\", \"shadow\", \"dialectic\", \"oblique\"],\n    grammar=soul_operad,\n    entropy=0.7\n)\n</code></pre> <p>The operad ensures validity. The entropy introduces variation.</p>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#synthesis-what-the-plans-should-become","title":"Synthesis: What the Plans Should Become","text":""},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#from-enumeration-to-generation","title":"From Enumeration to Generation","text":"<pre><code>Current:  600+ ideas (enumerated)\nFuture:   Operad + Primitives \u2192 \u221e valid compositions (generated)\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#from-functions-to-polynomials","title":"From Functions to Polynomials","text":"<pre><code>Current:  Agent[A, B] = A \u2192 B (stateless function)\nFuture:   PolyAgent[S, A, B] = dynamical system with states\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#from-implicit-to-explicit-grammar","title":"From Implicit to Explicit Grammar","text":"<pre><code>Current:  &gt;&gt; operator (hardcoded)\nFuture:   Operad with seq, par, branch, fix, trace (programmable)\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#from-local-views-to-global-emergence","title":"From Local Views to Global Emergence","text":"<pre><code>Current:  Different observers, different views (disconnected)\nFuture:   Sheaf structure with gluing (emergent global behavior)\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#from-cli-first-to-spec-first","title":"From CLI-First to Spec-First","text":"<pre><code>Current:  \"kg soul vibe\" \u2192 implement handler\nFuture:   SoulOperad.vibe \u2192 ProjectCLI \u2192 handler (derived)\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#action-items","title":"Action Items","text":"<ol> <li>Define Agent Polynomial Protocol (Layer 1)</li> <li>Positions, Directions, Transitions</li> <li> <p>Wiring diagram composition</p> </li> <li> <p>Define Agent Operad (Layer 2)</p> </li> <li>Generating operations: seq, par, branch, fix, trace</li> <li> <p>Domain-specific operads: SoulOperad, ParseOperad, etc.</p> </li> <li> <p>Define Agent Sheaf (Layer 3)</p> </li> <li>Restriction and gluing operations</li> <li> <p>Emergence as sheaf condition</p> </li> <li> <p>Rebuild DevEx as Functor</p> </li> <li>Spec \u2192 Impl projector</li> <li>Automatic test generation from laws</li> <li> <p>Automatic CLI generation from operad operations</p> </li> <li> <p>Integrate void.* for Stochastic Composition</p> </li> <li>Entropy-driven composition within operad grammar</li> <li>Careful design OR chaotic happenstance</li> </ol>"},{"location":"_archive/ideas-synthesis-historical/categorical-critique/#references","title":"References","text":"<ul> <li>Polynomial Functors: A Mathematical Theory of Interaction (Niu &amp; Spivak, 2024)</li> <li>Operads for Complex System Design (Spivak et al.)</li> <li>Sheaves in Geometry and Logic (Mac Lane &amp; Moerdijk)</li> <li>An Invitation to Applied Category Theory (Fong &amp; Spivak)</li> <li>Category Theory for Programmers (Milewski)</li> <li>AlgebraicJulia: Composing Dynamical Systems</li> </ul> <p>\"Don't enumerate the flowers. Describe the garden's grammar.\"</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/","title":"Cross-Synergy Analysis","text":"<p>\"Individual agents are interesting. Agents together? That's where the magic happens.\"</p> <p>Purpose: Map connections between ideas for maximum value extraction Sessions Analyzed: 15 Synergies Identified: 100+</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#synergy-matrix","title":"Synergy Matrix","text":""},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#agent-genus-combinations","title":"Agent Genus Combinations","text":"<pre><code>         K    H    U    P    J    I    M    N    A    B    E    O    \u03a9\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  K \u2502  \u00b7   \u2b50   \u25cb    \u25cb    \u25cb   \u2b50   \u25cb   \u2b50   \u25cb    \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  H \u2502 \u2b50    \u00b7   \u25cb    \u25cb    \u25cb    \u25cb   \u25cb   \u2b50   \u25cb    \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  U \u2502  \u25cb    \u25cb    \u00b7   \u2b50   \u2b50  \u2b50   \u25cb    \u25cb   \u25cb    \u25cb    \u25cb   \u2b50   \u25cb   \u2502\n  P \u2502  \u25cb    \u25cb   \u2b50    \u00b7   \u2b50   \u25cb   \u25cb    \u25cb   \u25cb    \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  J \u2502  \u25cb    \u25cb   \u2b50   \u2b50    \u00b7   \u25cb   \u25cb    \u25cb   \u25cb    \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  I \u2502 \u2b50    \u25cb   \u2b50    \u25cb    \u25cb    \u00b7   \u25cb    \u25cb   \u25cb   \u2b50  \u2b50  \u2b50   \u25cb   \u2502\n  M \u2502  \u25cb    \u25cb    \u25cb    \u25cb    \u25cb    \u25cb    \u00b7  \u2b50   \u25cb    \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  N \u2502 \u2b50   \u2b50   \u25cb    \u25cb    \u25cb    \u25cb   \u2b50   \u00b7   \u25cb    \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  A \u2502  \u25cb    \u25cb    \u25cb    \u25cb    \u25cb    \u25cb    \u25cb    \u25cb    \u00b7    \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  B \u2502  \u25cb    \u25cb    \u25cb    \u25cb    \u25cb   \u2b50   \u25cb    \u25cb   \u25cb    \u00b7    \u25cb    \u25cb    \u25cb   \u2502\n  E \u2502  \u25cb    \u25cb    \u25cb    \u25cb    \u25cb   \u2b50   \u25cb    \u25cb   \u25cb    \u25cb    \u00b7    \u25cb    \u25cb   \u2502\n  O \u2502  \u25cb    \u25cb   \u2b50    \u25cb    \u25cb   \u2b50   \u25cb    \u25cb   \u25cb    \u25cb    \u25cb    \u00b7    \u25cb   \u2502\n  \u03a9 \u2502  \u25cb    \u25cb    \u25cb    \u25cb    \u25cb    \u25cb    \u25cb    \u25cb   \u25cb    \u25cb    \u25cb    \u25cb    \u00b7   \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u2b50 = High synergy (Session 14 crown jewels)\n\u25cb  = Moderate synergy (explored but not crown)\n\u00b7  = Self (identity)\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#top-10-synergy-patterns","title":"Top 10 Synergy Patterns","text":""},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#1-k-gent-h-gent-soul-introspection","title":"1. K-gent + H-gent: Soul Introspection","text":"<p>Combination: K (Soul) \u00d7 H (Thinking) Synergy Level: \u2b50\u2b50\u2b50\u2b50\u2b50</p> <p>Emergent Capabilities: - Soul-aware shadow detection - Personality-informed dialectics - Eigenvector-driven synthesis</p> <p>CLI Commands Created: <pre><code>kg soul introspect    # Full H-gent pipeline through soul lens\nkg soul shadow        # Jungian analysis of eigenvectors\nkg soul dialectic     # Hegelian synthesis of tensions\n</code></pre></p> <p>Implementation Pattern: <pre><code># K-gent provides context, H-gent provides analysis\nkgent = KgentAgent.from_context(ctx)\neigenvectors = await kgent.get_eigenvectors()\n\n# H-jung analyzes through soul lens\njung = JungAgent()\nshadow = await jung.analyze(eigenvectors)\n</code></pre></p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#2-u-gent-p-gent-j-gent-self-healing-infrastructure","title":"2. U-gent + P-gent + J-gent: Self-Healing Infrastructure","text":"<p>Combination: U (Tools) \u00d7 P (Parsing) \u00d7 J (JIT) Synergy Level: \u2b50\u2b50\u2b50\u2b50\u2b50</p> <p>Emergent Capabilities: - Parse tool outputs automatically - Classify reality of tool results - Retry/repair/collapse gracefully</p> <p>Pipeline: <pre><code>U-gent.fetch() \u2192 P-gent.parse() \u2192 J-gent.classify() \u2192 Act or Collapse\n     \u2193               \u2193                  \u2193\n  Circuit          Repair            Fallback\n  Breaker         Strategies         to Ground\n</code></pre></p> <p>Session 14 Crown Jewel: Self-Healing Pipeline (C23)</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#3-i-gent-flux-living-visualizations","title":"3. I-gent + Flux: Living Visualizations","text":"<p>Combination: I (Visualization) \u00d7 Flux (Streaming) Synergy Level: \u2b50\u2b50\u2b50\u2b50\u2b50</p> <p>Emergent Capabilities: - Real-time dashboard updates - Breathing/pulsing indicators - Stigmergic field animation</p> <p>Widget Types: <pre><code>DensityField + FluxEvents \u2192 Living Garden\nSparkline + FluxMetrics \u2192 Breathing Charts\nEntropy + FluxEntropy \u2192 Weather Patterns\n</code></pre></p> <p>Session 14 Crown Jewel: Living Garden Visualization (C03)</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#4-m-gent-n-gent-memory-as-story","title":"4. M-gent + N-gent: Memory as Story","text":"<p>Combination: M (Memory) \u00d7 N (Narrative) Synergy Level: \u2b50\u2b50\u2b50\u2b50</p> <p>Emergent Capabilities: - Autobiographical system history - Memory \u2192 Literature transformation - Trace \u2192 Story pipeline</p> <p>Implementation: <pre><code># M-gent provides raw memory\nmemory = await m_gent.get_holographic_view(start_date, end_date)\n\n# N-gent transforms to narrative\nbard = NarrativeAgent(genre=\"memoir\")\nstory = await bard.narrate(memory)\n</code></pre></p> <p>Session 14 Idea: Memory \u2192 Story Pipeline (C10)</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#5-k-gent-judge-soul-governed-approval","title":"5. K-gent + Judge: Soul-Governed Approval","text":"<p>Combination: K (Soul) \u00d7 Judge (Evaluation) Synergy Level: \u2b50\u2b50\u2b50\u2b50\u2b50</p> <p>Emergent Capabilities: - Ethical judgment informed by personality - Historical pattern matching - Value-aligned recommendations</p> <p>Session 14 Crown Jewel: \"Would Kent Approve?\" (C01)</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#6-h-gent-n-gent-dialectical-narrative","title":"6. H-gent + N-gent: Dialectical Narrative","text":"<p>Combination: H (Thinking) \u00d7 N (Narrative) Synergy Level: \u2b50\u2b50\u2b50\u2b50</p> <p>Emergent Capabilities: - Contradictions as plot points - Synthesis as story resolution - Tension as dramatic arc</p> <p>Session 14 Idea: Dialectical Narrative (C07)</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#7-e-gent-i-gent-evolution-visualization","title":"7. E-gent + I-gent: Evolution Visualization","text":"<p>Combination: E (Evolution) \u00d7 I (Visualization) Synergy Level: \u2b50\u2b50\u2b50\u2b50</p> <p>Emergent Capabilities: - Mutation diffs with thermodynamics overlay - Fitness landscape rendering - Population tree animation</p> <p>Session 14 Idea: Evolution Visualizer (C09)</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#8-b-gent-i-gent-token-economy-dashboard","title":"8. B-gent + I-gent: Token Economy Dashboard","text":"<p>Combination: B (Economics) \u00d7 I (Visualization) Synergy Level: \u2b50\u2b50\u2b50</p> <p>Emergent Capabilities: - Budget bars with forecasts - RoC leaderboards - Economic health indicators</p> <p>Session 14 Idea: Token Economy Dashboard (C15)</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#9-o-gent-i-gent-observation-art","title":"9. O-gent + I-gent: Observation Art","text":"<p>Combination: O (Observation) \u00d7 I (Visualization) Synergy Level: \u2b50\u2b50\u2b50\u2b50</p> <p>Emergent Capabilities: - Panopticon as beautiful dashboard - Borromean knot visualization - Dimension Dance TUI</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#10-witness-shapeshifter-time-travel-replay","title":"10. Witness + Shapeshifter: Time-Travel Replay","text":"<p>Combination: Witness (observe) \u00d7 Shapeshifter (form) Synergy Level: \u2b50\u2b50\u2b50\u2b50</p> <p>Emergent Capabilities: - Watch agent forms evolve over time - Replay with form annotations - Historical appearance tracking</p> <p>Session 14 Crown Jewel: Time-Travel Form Replay (C06)</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#cli-command-synergies","title":"CLI Command Synergies","text":""},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#soul-commands-k-h","title":"Soul Commands (K + H)","text":"<pre><code>kg soul vibe        \u2192 K-gent (pure)\nkg soul shadow      \u2192 K + H-jung\nkg soul dialectic   \u2192 K + H-hegel\nkg soul introspect  \u2192 K + H-hegel + H-lacan + H-jung\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#analysis-commands-u-p-j","title":"Analysis Commands (U + P + J)","text":"<pre><code>kg parse            \u2192 P-gent (pure)\nkg reality          \u2192 J-gent (pure)\nkg analyze          \u2192 U + P + J pipeline\nkg diagnose         \u2192 O + U + P + J\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#creative-commands-a-k","title":"Creative Commands (A + \u03a8 + K)","text":"<pre><code>kg oblique          \u2192 A-gent (pure)\nkg metaphor         \u2192 \u03a8-gent (pure)\nkg create           \u2192 A + \u03a8 + K ensemble\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#cross-session-theme-synergies","title":"Cross-Session Theme Synergies","text":""},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#theme-honest-infrastructure","title":"Theme: Honest Infrastructure","text":"<p>Sessions: 3 (K-gent confidence), 12 (P-gent confidence), 13 (O-gent observation)</p> <p>Pattern: Admitting uncertainty is a feature, not a bug - K-gent: Eigenvector confidence scores - P-gent: Parse confidence thermometer - O-gent: VoI-aware observation</p> <p>Unified Insight: Build systems that say \"I don't know\" with grace</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#theme-living-systems","title":"Theme: Living Systems","text":"<p>Sessions: 5 (Memory garden), 11 (I-gent field), 14 (Stigmergic field)</p> <p>Pattern: Agents as organisms, not machines - Memory as garden (SEED \u2192 TREE lifecycle) - Visualization as weather - Composition as ecosystem</p> <p>Unified Insight: Biological metaphors enable intuitive understanding</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#theme-dialectical-everything","title":"Theme: Dialectical Everything","text":"<p>Sessions: 1 (Contradict/Sublate), 4 (H-hegel), 14 (Dialectical combos)</p> <p>Pattern: Tension is productive, not problematic - Bootstrap: Contradict detects, Sublate resolves - H-gent: Full dialectical pipeline - Cross-pollination: Tensions become narratives</p> <p>Unified Insight: Embrace contradiction as source of insight</p>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#implementation-strategy-synergy-first","title":"Implementation Strategy: Synergy-First","text":""},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#principle-build-combos-get-singles-for-free","title":"Principle: Build combos, get singles for free","text":"<p>Instead of building agents individually, build the high-synergy combinations:</p> <pre><code>Build C01 (\"Would Kent Approve?\")\n  \u2192 Automatically need K-gent, Judge, Ground integration\n  \u2192 Single commands (kg soul, kg judge) emerge as byproducts\n\nBuild C03 (Living Garden)\n  \u2192 Automatically need I-gent widgets, Flux events\n  \u2192 Single widgets emerge as reusable components\n\nBuild C23 (Self-Healing Pipeline)\n  \u2192 Automatically need U-gent, P-gent, J-gent integration\n  \u2192 Individual tools mature through combo testing\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#synergy-implementation-priority","title":"Synergy Implementation Priority","text":"Priority Combo Components Value 1 K + H Soul Introspection K-gent, H-jung, H-lacan, H-hegel Philosophy proof 2 U + P + J Infrastructure U-gent, P-gent, J-gent Reliability 3 I + Flux Visualization I-gent, Flux Aesthetic appeal 4 M + N Memory Story M-gent, N-gent Narrative power 5 K + Judge Approval K-gent, Judge Ethical alignment"},{"location":"_archive/ideas-synthesis-historical/cross-synergy/#parallel-agent-strategy-for-synergies","title":"Parallel Agent Strategy for Synergies","text":"<pre><code>Agent 1: K+H Integration\n\u251c\u2500\u2500 Build K-gent soul infrastructure\n\u251c\u2500\u2500 Wire to H-gent analysis\n\u2514\u2500\u2500 Create unified introspection\n\nAgent 2: U+P+J Integration\n\u251c\u2500\u2500 Build self-healing pipeline\n\u251c\u2500\u2500 Wire circuit breakers\n\u2514\u2500\u2500 Add graceful degradation\n\nAgent 3: I+Flux Integration\n\u251c\u2500\u2500 Build living dashboard\n\u251c\u2500\u2500 Wire Flux events\n\u2514\u2500\u2500 Create breathing widgets\n\nAgent 4: Cross-Integration Testing\n\u251c\u2500\u2500 Verify combos work together\n\u251c\u2500\u2500 Find new emergent patterns\n\u2514\u2500\u2500 Document discoveries\n</code></pre> <p>\"The whole is greater than the sum of its parts. That's not poetry\u2014it's category theory.\"</p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/","title":"Implementation Master Plan: Creative Exploration \u2192 Production","text":"<p>\"The distance from idea to reality is measured in structured execution.\"</p> <p>Source: 15 Creative Exploration Sessions (session-01 through session-15) Scope: ALL Quick Wins, ALL Crown Jewels, Medium Complexity Projects Parallel Agent Strategy: Enabled throughout</p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#executive-summary","title":"Executive Summary","text":"Metric Count Total Sessions 15 Total Ideas 600+ Quick Wins (Priority \u2265 7.0, Effort \u2264 2) 70+ Crown Jewels (Priority 10.0) 45+ Medium Complexity (Effort 3-4) 85+ Estimated Build Time (sequential) 16-20 weeks Estimated Build Time (parallel agents) 6-8 weeks"},{"location":"_archive/ideas-synthesis-historical/master-plan/#the-11-phase-lifecycle","title":"The 11-Phase Lifecycle","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        IMPLEMENTATION LIFECYCLE                              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                              \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502   \u2502PLAN \u2502 \u2192 \u2502 RESEARCH \u2502 \u2192 \u2502 DEVELOP \u2502 \u2192 \u2502 STRATEGIZE \u2502 \u2192 \u2502CROSS-SYNERGIZE\u2502 \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502      \u2193                                                            \u2193          \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502   \u2502IMPLEMENT\u2502 \u2192 \u2502 QA \u2502 \u2192 \u2502 TEST \u2502 \u2192 \u2502 EDUCATE \u2502 \u2192 \u2502 MEASURE \u2502 \u2192 \u2502REFLECT \u2502  \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                     \u2193        \u2502\n\u2502                                                          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502\n\u2502                                                          \u2502   RE-METABOLIZE  \u2502\u2502\n\u2502                                                          \u2502   (Feed back to  \u2502\u2502\n\u2502                                                          \u2502    next cycle)   \u2502\u2502\n\u2502                                                          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-1-plan","title":"Phase 1: PLAN","text":"<p>Goal: Structure the work into executable chunks</p> <p>Outputs: - [x] <code>master-plan.md</code> (this document) - [ ] <code>quick-wins.md</code> - All 70+ quick wins with sprint assignments - [ ] <code>crown-jewels.md</code> - All 45+ crown jewels with deep implementation notes - [ ] <code>medium-complexity.md</code> - All 85+ medium projects with dependencies</p> <p>Parallel Agent Strategy: <pre><code>Agent 1: Extract Quick Wins \u2192 Structure into sprints\nAgent 2: Extract Crown Jewels \u2192 Identify dependencies\nAgent 3: Extract Medium Complexity \u2192 Estimate timelines\nAgent 4: Cross-reference \u2192 Find synergies\n</code></pre></p> <p>Exit Criteria: All three sub-plans created with clear sprint assignments</p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-2-research","title":"Phase 2: RESEARCH","text":"<p>Goal: Understand existing infrastructure before building</p> <p>Activities: 1. Codebase Audit: For each idea, identify:    - Existing implementations to leverage    - Files to touch    - Test coverage gaps</p> <ol> <li>Dependency Mapping:</li> <li>Which ideas depend on others?</li> <li>What's the critical path?</li> <li> <p>What can run in parallel?</p> </li> <li> <p>Architecture Review:</p> </li> <li>Do any ideas conflict with current architecture?</li> <li>Are there hidden blockers?</li> </ol> <p>Parallel Agent Strategy: <pre><code>Agent 1: Audit K-gent / Soul implementations\nAgent 2: Audit H-gent / Thinking implementations\nAgent 3: Audit U/P/J infrastructure\nAgent 4: Audit I-gent visualization\nAgent 5: Audit Cross-pollination requirements\n</code></pre></p> <p>Output: Research findings appended to each sub-plan</p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-3-develop-enhance","title":"Phase 3: DEVELOP / ENHANCE","text":"<p>Goal: Refine idea specifications into implementable designs</p> <p>Activities: 1. API Design: Define interfaces for each CLI command 2. Type Definitions: Create TypedDicts, Protocols, etc. 3. Test Cases: Write test specifications before code 4. Documentation Drafts: Prepare docstrings and user guides</p> <p>Parallel Agent Strategy: <pre><code>Sprint 1 (Week 1-2): Quick Wins Tier S (10.0 priority)\nSprint 2 (Week 3-4): Quick Wins Tier A (9.0-9.9)\nSprint 3 (Week 5-6): Crown Jewels with dependencies resolved\nSprint 4 (Week 7-8): Medium Complexity Phase 1\n</code></pre></p> <p>Output: Detailed design documents for each implementation</p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-4-strategize","title":"Phase 4: STRATEGIZE","text":"<p>Goal: Sequence work for maximum value and minimum risk</p> <p>Strategic Principles: 1. Quick Wins First: Build momentum with easy victories 2. Demonstrate Value Early: Showable items prioritized 3. Unblock Dependencies: Clear blocking paths 4. Parallel Tracks: Multiple agents work simultaneously</p> <p>Sprint Strategy:</p> Sprint Focus Ideas Agents 1 K-gent Soul CLI <code>soul vibe</code>, <code>soul drift</code>, <code>soul tense</code> 2 2 Infrastructure CLI <code>parse</code>, <code>reality</code>, <code>execute</code> 2 3 H-gent Thinking CLI <code>shadow</code>, <code>dialectic</code>, <code>gaps</code> 2 4 Visualization <code>sparkline</code>, <code>weather</code>, dashboards 2 5 Cross-Pollination Combo ideas (C01-C10) 3 6 Integration End-to-end testing 2"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-5-cross-synergize","title":"Phase 5: CROSS-SYNERGIZE","text":"<p>Goal: Identify and exploit connections between ideas</p> <p>Synergy Categories:</p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#a-agent-genus-synergies","title":"A. Agent Genus Synergies","text":"<pre><code>K-gent (Soul) \u2190\u2192 H-gent (Thinking)\n  \u2514\u2500\u2500 \"Soul Shadow\" detection\n  \u2514\u2500\u2500 \"Dialectical Soul Tension\"\n\nU-gent (Tools) \u2190\u2192 P-gent (Parsing)\n  \u2514\u2500\u2500 Self-healing pipelines\n  \u2514\u2500\u2500 Confidence-aware execution\n\nI-gent (Viz) \u2190\u2192 Flux (Streaming)\n  \u2514\u2500\u2500 Living garden dashboards\n  \u2514\u2500\u2500 Real-time health monitoring\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#b-cli-command-synergies","title":"B. CLI Command Synergies","text":"<pre><code>kg soul * \u2190\u2192 kg shadow\n  \u2514\u2500\u2500 Combined: kg introspect (full H-gent pipeline through soul)\n\nkg parse \u2190\u2192 kg reality\n  \u2514\u2500\u2500 Combined: kg analyze (parse + classify in one command)\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#c-cross-session-synergies","title":"C. Cross-Session Synergies","text":"<pre><code>Session 3 (K-gent) + Session 4 (H-gent) + Session 14 (Cross-Pollination)\n  \u2514\u2500\u2500 \"What Would Kent Synthesize?\" (C22)\n  \u2514\u2500\u2500 Ethical Code Review (C32)\n</code></pre> <p>Output: <code>cross-synergy.md</code> with all identified connections</p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-6-implement","title":"Phase 6: IMPLEMENT","text":"<p>Goal: Write code that passes tests</p> <p>Implementation Tracks (Parallel):</p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#track-a-cli-commands-quick-wins","title":"Track A: CLI Commands (Quick Wins)","text":"<pre><code>impl/claude/protocols/cli/handlers/\n  \u251c\u2500\u2500 soul.py      # kg soul *\n  \u251c\u2500\u2500 shadow.py    # kg shadow, kg dialectic\n  \u251c\u2500\u2500 parse.py     # kg parse\n  \u251c\u2500\u2500 reality.py   # kg reality\n  \u251c\u2500\u2500 viz.py       # kg sparkline, kg weather\n  \u2514\u2500\u2500 ...\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#track-b-agent-enhancements","title":"Track B: Agent Enhancements","text":"<pre><code>impl/claude/agents/\n  \u251c\u2500\u2500 k/          # Soul enhancements\n  \u251c\u2500\u2500 h/          # Thinking enhancements\n  \u251c\u2500\u2500 u/          # Tool enhancements\n  \u251c\u2500\u2500 p/          # Parsing enhancements\n  \u2514\u2500\u2500 i/          # Visualization enhancements\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#track-c-integration-cross-pollination","title":"Track C: Integration (Cross-Pollination)","text":"<pre><code>impl/claude/protocols/cli/handlers/\n  \u251c\u2500\u2500 approve.py   # \"Would Kent Approve?\" (C01)\n  \u251c\u2500\u2500 synthesize.py # \"What Would Kent Synthesize?\" (C22)\n  \u2514\u2500\u2500 review.py    # Ethical Code Review (C32)\n</code></pre> <p>Parallel Agent Strategy: <pre><code>Agent 1: CLI handlers (pure wiring)\nAgent 2: Agent enhancements (business logic)\nAgent 3: Tests (parallel test writing)\nAgent 4: Documentation (parallel doc writing)\n</code></pre></p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-7-qa","title":"Phase 7: QA","text":"<p>Goal: Ensure quality before merge</p> <p>QA Checklist: - [ ] All new code has tests - [ ] Type hints complete (mypy passes) - [ ] Ruff formatting clean - [ ] Docstrings present - [ ] No security vulnerabilities - [ ] Performance acceptable</p> <p>QA Strategy: See <code>qa-strategy.md</code></p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-8-test","title":"Phase 8: TEST","text":"<p>Goal: Verify correctness at all levels</p> <p>Test Types (per T-gent taxonomy): 1. Type I: Unit - Individual functions 2. Type II: Property - Invariant checking 3. Type III: Integration - Component interactions 4. Type IV: Adversarial - Chaos testing (Saboteur) 5. Type V: Dialectic - Contradiction detection</p> <p>Target Coverage: 94%+ (match existing standard)</p> <p>Parallel Testing Strategy: <pre><code>Agent 1: Run unit tests\nAgent 2: Run property tests\nAgent 3: Run integration tests\nAgent 4: Run adversarial tests\n</code></pre></p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-9-educate","title":"Phase 9: EDUCATE","text":"<p>Goal: Ensure developer can use and extend</p> <p>Education Deliverables: 1. Quick Start Guide: \"Your first kg command in 60 seconds\" 2. CLI Reference: All commands documented 3. Architecture Overview: How ideas connect to implementation 4. Extension Guide: How to add new commands</p> <p>Output: <code>developer-education.md</code></p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-10-measure","title":"Phase 10: MEASURE","text":"<p>Goal: Track adoption and effectiveness</p> <p>Metrics: 1. Usage Metrics:    - Command invocation counts    - Error rates per command    - Response times</p> <ol> <li>Quality Metrics:</li> <li>Test coverage</li> <li>Bug reports</li> <li> <p>Performance benchmarks</p> </li> <li> <p>Value Metrics:</p> </li> <li>Developer satisfaction (NPS)</li> <li>Time saved estimates</li> <li>Feature requests</li> </ol> <p>Output: <code>metrics-reflection.md</code></p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#phase-11-reflect-re-metabolize","title":"Phase 11: REFLECT &amp; RE-METABOLIZE","text":"<p>Goal: Learn from implementation, feed back to process</p> <p>Reflection Questions: 1. Which ideas delivered more value than expected? 2. Which ideas underperformed? 3. What patterns emerged during implementation? 4. What would we do differently next time?</p> <p>Re-Metabolization: - Successful patterns \u2192 Add to <code>plans/skills/</code> - Failed approaches \u2192 Document in <code>plans/meta.md</code> - New ideas discovered \u2192 Add to <code>plans/ideas/session-16-*.md</code></p>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#document-tree","title":"Document Tree","text":"<pre><code>plans/ideas/impl/\n\u251c\u2500\u2500 master-plan.md          # This document (orchestration)\n\u251c\u2500\u2500 quick-wins.md           # 70+ quick wins structured into sprints\n\u251c\u2500\u2500 crown-jewels.md         # 45+ crown jewels with deep notes\n\u251c\u2500\u2500 medium-complexity.md    # 85+ medium projects\n\u251c\u2500\u2500 cross-synergy.md        # Synergy analysis\n\u251c\u2500\u2500 qa-strategy.md          # Quality assurance approach\n\u251c\u2500\u2500 developer-education.md  # Education materials\n\u2514\u2500\u2500 metrics-reflection.md   # Measurement framework\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#execution-timeline","title":"Execution Timeline","text":"<pre><code>Week 1-2:   Planning &amp; Research (this phase)\nWeek 3-4:   Sprint 1 - K-gent Soul CLI\nWeek 5-6:   Sprint 2 - Infrastructure CLI\nWeek 7-8:   Sprint 3 - H-gent Thinking CLI\nWeek 9-10:  Sprint 4 - Visualization\nWeek 11-12: Sprint 5 - Cross-Pollination Combos\nWeek 13-14: Sprint 6 - Integration &amp; Testing\nWeek 15-16: Education, Metrics, Reflection\n</code></pre>"},{"location":"_archive/ideas-synthesis-historical/master-plan/#success-criteria","title":"Success Criteria","text":"Milestone Definition Target Quick Wins Complete 70+ CLI commands working Week 8 Crown Jewels Complete 45+ top ideas implemented Week 12 Test Coverage All new code tested 94%+ Documentation All commands documented Week 14 Developer Education Tutorial complete Week 15 Metrics Framework Usage tracking live Week 16"},{"location":"_archive/ideas-synthesis-historical/master-plan/#risk-mitigation","title":"Risk Mitigation","text":"Risk Mitigation Scope creep Strict priority ranking; defer non-essentials Dependency deadlock Critical path analysis; unblock early Quality degradation QA gates per sprint; no merge without tests Burnout Parallel agents; sustainable pace Lost context Epilogues per session; clear documentation"},{"location":"_archive/ideas-synthesis-historical/master-plan/#next-steps","title":"Next Steps","text":"<ol> <li>Create <code>quick-wins.md</code> with all 70+ items</li> <li>Create <code>crown-jewels.md</code> with all 45+ items</li> <li>Create <code>medium-complexity.md</code> with all 85+ items</li> <li>Begin Sprint 1: K-gent Soul CLI commands</li> </ol> <p>\"The idea is nothing. The execution is everything.\"</p>"},{"location":"architecture/alethic-algebra-tactics/","title":"Alethic Algebra Tactics: Categorical Foundation Implementation","text":"<p>\"The structure of the agent mirrors the structure of the thought. The code is merely the shadow.\"</p> <p>Created: 2025-12-12 Status: active Progress: 95% Dependencies: agents/a/halo.py \u2705, agents/a/functor.py \u2705, agents/k/functor.py \u2705, agents/c/functor.py \u2705, agents/flux/functor.py \u2705, agents/o/observer_functor.py \u2705, agents/d/state_monad.py \u2705</p>"},{"location":"architecture/alethic-algebra-tactics/#strategic-context","title":"Strategic Context","text":"<p>This plan translates the Alethic Algebra research into concrete implementation tactics. The synergy analysis identified a fundamental isomorphism crisis: all our agents implement functors independently without a unifying structure.</p> <p>The Insight: Halo (already implemented as declarative capabilities) is the seed of the Alethic Architecture. What's missing is the algebraic structure that composes these capabilities into emergent behavior.</p>"},{"location":"architecture/alethic-algebra-tactics/#architectural-decision-universal-functor-mandate","title":"Architectural Decision: Universal Functor Mandate","text":"<p>DECISION (2025-12-12): All agents in kgents SHALL be reformulated through the Universal Functor Protocol.</p>"},{"location":"architecture/alethic-algebra-tactics/#rationale","title":"Rationale","text":"<ol> <li>Isomorphism Crisis: The synergy analysis revealed that C-gent, Flux, K-gent, O-gent, and B-gent all implement functors independently. This creates:</li> <li>Duplicated law verification logic</li> <li>Incompatible composition patterns</li> <li> <p>No unified observation mechanism</p> </li> <li> <p>Generative Principle: A well-formed spec generates implementation. The Universal Functor Protocol IS that spec \u2014 all functor behavior derives from <code>lift()</code> and law compliance.</p> </li> <li> <p>K-gent Integration: K-gent as the \"nervous system\" requires a uniform interface to intercept ANY agent. The Universal Functor Protocol provides this.</p> </li> </ol>"},{"location":"architecture/alethic-algebra-tactics/#what-this-means","title":"What This Means","text":"Agent Genus Current Pattern Reformulated Pattern C-gent <code>MaybeAgent</code>, <code>EitherAgent</code>, etc. <code>MaybeFunctor.lift(agent)</code> Flux <code>FluxAgent</code> wrapper <code>FluxFunctor.lift(agent)</code> K-gent <code>KgentAgent</code> wrapper <code>SoulFunctor.lift(agent)</code> O-gent <code>TelemetryObserver</code> <code>ObserverFunctor.lift(agent)</code> B-gent <code>MeteredAgent</code> <code>MeterFunctor.lift(agent)</code>"},{"location":"architecture/alethic-algebra-tactics/#migration-strategy","title":"Migration Strategy","text":"<ol> <li>Phase 1 \u2705: Define <code>UniversalFunctor</code> protocol (DONE)</li> <li>Phase 2: Retrofit existing C-gent functors to implement protocol</li> <li>Phase 3: Define canonical functors for Flux, K-gent, O-gent, B-gent</li> <li>Phase 4: Register all functors in <code>FunctorRegistry</code></li> <li>Phase 5: Verify laws across entire codebase via <code>FunctorRegistry.verify_all()</code></li> </ol>"},{"location":"architecture/alethic-algebra-tactics/#backward-compatibility","title":"Backward Compatibility","text":"<p>Existing code continues to work. The reformulation is additive: - <code>MaybeAgent(inner)</code> still works (convenience wrapper) - <code>MaybeFunctor.lift(inner)</code> is the canonical form - Both produce the same lifted agent</p>"},{"location":"architecture/alethic-algebra-tactics/#tactical-phases","title":"Tactical Phases","text":""},{"location":"architecture/alethic-algebra-tactics/#phase-1-universal-functor-protocol-complete","title":"Phase 1: Universal Functor Protocol \u2705 COMPLETE","text":"<p>Goal: Define a single functor protocol that unifies all existing functors.</p> <p>Files: - <code>impl/claude/agents/a/functor.py</code> \u2705 - <code>impl/claude/agents/a/_tests/test_functor.py</code> \u2705</p> <p>What Was Built:</p> <pre><code>class UniversalFunctor(Generic[F]):\n    \"\"\"\n    All functors satisfy: F(id) = id, F(g . f) = F(g) . F(f)\n    \"\"\"\n    @staticmethod\n    @abstractmethod\n    def lift(agent: Agent[A, B]) -&gt; Agent[Any, Any]: ...\n\n    @staticmethod\n    def pure(value: A) -&gt; Any: ...  # Optional\n\n# Supporting infrastructure:\n- Liftable[F_co] protocol for runtime_checkable\n- Pointed[F_co] protocol for pure() support\n- FunctorLawResult, FunctorVerificationReport dataclasses\n- verify_identity_law(), verify_composition_law(), verify_functor()\n- compose_functors(), identity_functor()\n- FunctorRegistry with verify_all()\n</code></pre> <p>Principle Application: - Generative: Laws defined once, verification derived - Composable: <code>compose_functors(F, G)</code> is associative</p>"},{"location":"architecture/alethic-algebra-tactics/#phase-2-halo-soulfunctor-integration-complete","title":"Phase 2: Halo + SoulFunctor Integration \u2705 COMPLETE","text":"<p>Goal: Connect Halo metadata to concrete functor implementations.</p> <p>What Was Built:</p> <ol> <li>Halo System (<code>agents/a/halo.py</code>):</li> <li>Four capabilities: <code>@Stateful</code>, <code>@Soulful</code>, <code>@Observable</code>, <code>@Streamable</code></li> <li>Introspection API: <code>get_halo()</code>, <code>has_capability()</code>, <code>get_capability()</code></li> <li> <p>Inheritance: <code>merge_halos()</code>, <code>inherit_halo()</code> with override semantics</p> </li> <li> <p>SoulFunctor (<code>agents/k/functor.py</code>):    <pre><code>class SoulFunctor(UniversalFunctor[SoulAgent[Any, Any]]):\n    @staticmethod\n    def lift(agent: Agent[A, B]) -&gt; SoulAgent[A, B]:\n        return SoulAgent(inner=agent)\n\n    @staticmethod\n    def pure(value: A) -&gt; Soul[A]:\n        return Soul(value=value)\n\n    @staticmethod\n    def lift_with_persona(agent, eigenvectors=None, persona=None):\n        # Explicit persona configuration\n        ...\n</code></pre></p> </li> <li> <p>Soul Context (<code>agents/k/functor.py:Soul[A]</code>):</p> </li> <li>Wraps value with eigenvectors, persona, metadata</li> <li><code>map()</code> preserves context through transformations</li> <li><code>context_prompt</code> generates LLM system context</li> </ol> <p>The Bridge: <pre><code># Halo declares intent\n@Capability.Soulful(persona=\"Kent\", mode=\"strict\")\nclass MyAgent(Agent[str, str]): ...\n\n# Projector reads Halo, applies functor\nagent = SoulFunctor.lift_with_persona(MyAgent(), eigenvectors=KENT_EIGENVECTORS)\n</code></pre></p> <p>Principle Application: - Ethical: <code>mode</code> controls governance strength (advisory/strict/override) - AGENTESE: Soul context is observer-dependent perception</p>"},{"location":"architecture/alethic-algebra-tactics/#phase-3-guard-functor-k-gent-intercept-complete","title":"Phase 3: Guard Functor + K-gent Intercept \u2705 COMPLETE","text":"<p>Goal: K-gent intercept as categorical gate for any agent.</p> <p>What Was Built (<code>agents/k/soul.py:KgentSoul</code>):</p> <pre><code>class KgentSoul:\n    async def intercept(self, token: Any) -&gt; InterceptResult:\n        \"\"\"Shallow intercept: keyword + principle matching\"\"\"\n        matching_principles = self._find_matching_principles(prompt)\n        matching_patterns = self._find_matching_patterns(prompt)\n        confidence = self._calculate_intercept_confidence(...)\n        # High confidence \u2192 auto-resolve; Low \u2192 annotate for human\n\n    async def intercept_deep(self, token: Any) -&gt; InterceptResult:\n        \"\"\"Deep intercept: LLM-backed reasoning against principles\"\"\"\n        # CRITICAL: Dangerous keywords \u2192 always escalate\n        if is_dangerous:\n            return InterceptResult(handled=False, recommendation=\"escalate\")\n        # LLM reasoning with structured output\n        response = await self._llm.generate(system_prompt, user_prompt)\n        return self._parse_intercept_response(response.text, ...)\n</code></pre> <p>The Guard Pattern: <pre><code># KgentSoul acts as parametric Guard\n# The \"validator\" is the eigenvector-backed principle reasoner\n\nclass SoulGuard(UniversalFunctor[Guarded]):\n    def __init__(self, soul: KgentSoul):\n        self.soul = soul\n\n    async def guard(self, agent: Agent[A, B], input: A) -&gt; Guarded[B]:\n        # Check before execution\n        result = await self.soul.intercept_deep(input)\n        if not result.handled and result.recommendation == \"escalate\":\n            raise EscalationRequired(result.annotation)\n        return Guarded(await agent.invoke(input))\n</code></pre></p> <p>Principle Application: - Ethical: <code>DANGEROUS_KEYWORDS</code> are never auto-approved - Heterarchical: advisory/strict/override modes - Generative: Audit trail generated from intercept logic</p>"},{"location":"architecture/alethic-algebra-tactics/#phase-4-localprojector-implementation-complete","title":"Phase 4: LocalProjector Implementation \u2705 COMPLETE","text":"<p>Goal: Compile Halo metadata to runtime functors.</p> <p>What Was Built:</p> Capability Functor Available Implementation <code>@Stateful</code> StatefulAdapter <code>system/projector/local.py</code> \u2705 <code>@Soulful</code> SoulfulAdapter <code>system/projector/local.py</code> \u2705 <code>@Observable</code> ObservableMixin <code>system/projector/local.py</code> \u2705 <code>@Streamable</code> FluxAgent <code>agents/flux/agent.py</code> \u2705 <p>LocalProjector (<code>impl/claude/system/projector/local.py</code>): - Reads capability decorators via <code>get_halo()</code> - Applies functors in canonical order: D \u2192 K \u2192 Mirror \u2192 Flux - 100% test coverage via <code>_tests/test_local.py</code></p> <p>CLI Integration (<code>kgents a</code>): - <code>kgents a list</code> - List available agents - <code>kgents a inspect &lt;name&gt;</code> - Inspect agent Halo - <code>kgents a manifest &lt;name&gt;</code> - Generate K8s manifests - <code>kgents a run &lt;name&gt;</code> - Run agent locally</p> <p>Files Created: - <code>impl/claude/system/projector/__init__.py</code> \u2705 - <code>impl/claude/system/projector/base.py</code> \u2705 - <code>impl/claude/system/projector/local.py</code> \u2705 - <code>impl/claude/system/projector/k8s.py</code> \u2705 - <code>impl/claude/system/projector/_tests/test_local.py</code> \u2705</p>"},{"location":"architecture/alethic-algebra-tactics/#phase-5-law-registry-complete","title":"Phase 5: Law Registry \u2705 COMPLETE","text":"<p>Goal: Define laws once, generate validators everywhere.</p> <p>What Was Built (<code>agents/a/functor.py:FunctorRegistry</code>):</p> <pre><code>class FunctorRegistry:\n    _functors: dict[str, type[UniversalFunctor[Any]]] = {}\n\n    @classmethod\n    def register(cls, name: str, functor: type[UniversalFunctor[Any]]) -&gt; None:\n        \"\"\"Register a functor with the registry.\"\"\"\n        cls._functors[name] = functor\n\n    @classmethod\n    async def verify_all(\n        cls,\n        identity_agent: Agent[A, A],\n        f: Agent[A, B],\n        g: Agent[B, C],\n        test_input_factory: Callable[[str], Any],\n    ) -&gt; dict[str, FunctorVerificationReport]:\n        \"\"\"Verify all registered functors against laws.\"\"\"\n        reports = {}\n        for name, functor in cls._functors.items():\n            test_input = test_input_factory(name)\n            reports[name] = await verify_functor(functor, identity_agent, f, g, test_input)\n        return reports\n</code></pre> <p>All Functors Registered (10+ functors): - <code>Maybe</code>, <code>Either</code>, <code>List</code>, <code>Async</code>, <code>Logged</code>, <code>Fix</code> from <code>agents/c/functor.py</code> \u2705 - <code>Flux</code> from <code>agents/flux/functor.py</code> \u2705 - <code>Soul</code> from <code>agents/k/functor.py</code> \u2705 - <code>Observer</code> from <code>agents/o/observer_functor.py</code> \u2705 - <code>State</code> from <code>agents/d/state_monad.py</code> \u2705</p> <p>Principle Application: - Generative: <code>verify_all()</code> generates verification from registration - Composable: Registry tracks composition compatibility</p>"},{"location":"architecture/alethic-algebra-tactics/#integration-points","title":"Integration Points","text":""},{"location":"architecture/alethic-algebra-tactics/#k-gent-soul-as-nervous-system-operational","title":"K-gent Soul as Nervous System \u2705 OPERATIONAL","text":"<p>The <code>KgentSoul</code> class is the operational realization of the Categorical Imperative:</p> <pre><code># Soul is now the middleware of consciousness\nsoul = KgentSoul()\n\n# Direct dialogue with budget tiers\noutput = await soul.dialogue(\"What am I avoiding?\", DialogueMode.REFLECT)\n# Returns: SoulDialogueOutput with eigenvector context\n\n# Semaphore mediation via intercept\nresult = await soul.intercept(semaphore_token)  # Shallow: keyword matching\nresult = await soul.intercept_deep(semaphore_token)  # Deep: LLM reasoning\n</code></pre> <p>The Four Capabilities of K-gent: | Capability | Implementation | Status | |------------|----------------|--------| | Gatekeeper | <code>intercept_deep()</code> with DANGEROUS_KEYWORDS | \u2705 | | Fractal Expander | <code>dialogue()</code> with budget tiers | \u2705 | | Holographic Constitution | Eigenvectors in <code>to_system_prompt_section()</code> | \u2705 | | Sommelier | Rodizio pattern + halo mode query | \ud83d\udd04 |</p>"},{"location":"architecture/alethic-algebra-tactics/#terrarium-observable-integration","title":"Terrarium + Observable Integration","text":"<p>The Terrarium work (<code>agents/terrarium.md</code> archive) provides the infrastructure:</p> <pre><code>@Capability.Observable(mirror=True, metrics=True)\nclass MyFluxAgent(Kappa[Event, Summary]): ...\n\n# LocalProjector wiring:\n# 1. HolographicBuffer for Terrarium WebSocket\n# 2. Prometheus metrics for ServiceMonitor\n</code></pre>"},{"location":"architecture/alethic-algebra-tactics/#semaphore-halo-synergy","title":"Semaphore + Halo Synergy","text":"<p>The Rodizio pattern (<code>agents/semaphores.md</code> archive) yields tokens:</p> <pre><code>FluxAgent.invoke() \u2192 yield SemaphoreToken\n    \u2193\nPurgatory captures token\n    \u2193\nKgentSoul.intercept(token)\n    \u2193\nQuery Halo @Soulful mode:\n  - advisory: annotate, human decides\n  - strict: auto-resolve high-confidence, escalate rest\n  - override: K-gent decides all (risky, use sparingly)\n</code></pre>"},{"location":"architecture/alethic-algebra-tactics/#cross-agent-pipelines","title":"Cross-Agent Pipelines","text":"<p>With functors unified under <code>UniversalFunctor</code>:</p> <pre><code># Compose lifts\nfull_stack = compose_functors(\n    TelemetryFunctor,  # O-gent: observe\n    SoulFunctor,       # K-gent: govern\n    FluxFunctor,       # Flux: stream\n)\n\n# Apply to any agent\nenhanced = full_stack(MyBusinessLogic())\n\n# Or via archetype + projector\nclass MyService(Kappa[Request, Response]):\n    async def invoke(self, req): return process(req)\n\nagent = LocalProjector().compile(MyService)  # All four capabilities\n</code></pre>"},{"location":"architecture/alethic-algebra-tactics/#implementation-order-updated","title":"Implementation Order (Updated)","text":"Phase Name Status Outcome 1 UniversalFunctor \u2705 COMPLETE Protocol + Registry + Verification 2 Halo + SoulFunctor \u2705 COMPLETE Capabilities + K-gent lift 3 Guard + Intercept \u2705 COMPLETE KgentSoul with LLM-backed reasoning 4 LocalProjector \u2705 COMPLETE Compile Halo \u2192 runtime functor chain 5 LawRegistry \u2705 COMPLETE FunctorRegistry.verify_all() 6 CLI Integration \u2705 COMPLETE <code>kgents a {list,inspect,manifest,run}</code> 7 C-gent Retrofit \u2705 COMPLETE All 6 C-gent functors retrofitted 8 Flux Retrofit \u2705 COMPLETE FluxFunctor implements UniversalFunctor 9 Cross-Functor Composition \u2705 COMPLETE compose_functors() verified <p>All Phases Complete! The Alethic Algebra foundation is operational.</p>"},{"location":"architecture/alethic-algebra-tactics/#agent-reformulation-status","title":"Agent Reformulation Status","text":"<p>Goal: Every functor-like pattern in kgents derives from <code>UniversalFunctor</code>.</p>"},{"location":"architecture/alethic-algebra-tactics/#k-gent-soulfunctor-complete","title":"K-gent SoulFunctor \u2705 COMPLETE","text":"Functor File Status Registry <code>SoulFunctor</code> <code>agents/k/functor.py</code> \u2705 <code>FunctorRegistry.get(\"Soul\")</code> <p>Implementation: - <code>Soul[A]</code> context wrapper with eigenvectors, persona, metadata - <code>SoulAgent[A, B]</code> lifts agents to soul domain - <code>SoulFunctor.lift()</code>, <code>SoulFunctor.pure()</code>, <code>SoulFunctor.lift_with_persona()</code> - Auto-registers on import</p>"},{"location":"architecture/alethic-algebra-tactics/#c-gent-functors-retrofitted","title":"C-gent Functors \u2705 RETROFITTED","text":"<p>All C-gent functors now derive from <code>UniversalFunctor</code> and auto-register:</p> Functor File Implementation Registry <code>MaybeFunctor</code> <code>agents/c/functor.py</code> <code>MaybeAgent</code> + <code>unlift_maybe()</code> \u2705 <code>EitherFunctor</code> <code>agents/c/functor.py</code> <code>EitherAgent</code> + <code>unlift_either()</code> \u2705 <code>ListFunctor</code> <code>agents/c/functor.py</code> <code>ListAgent</code> + <code>unlift_list()</code> \u2705 <code>AsyncFunctor</code> <code>agents/c/functor.py</code> <code>AsyncAgent</code> + <code>unlift_async()</code> \u2705 <code>LoggedFunctor</code> <code>agents/c/functor.py</code> <code>LoggedAgent</code> + <code>unlift_logged()</code> \u2705 <code>FixFunctor</code> <code>agents/c/functor.py</code> <code>FixAgent</code> + <code>unlift_fix()</code> \u2705 <p>All functors support symmetric lifting: <code>unlift(lift(agent)) \u2245 agent</code></p>"},{"location":"architecture/alethic-algebra-tactics/#flux-functor-retrofitted","title":"Flux Functor \u2705 RETROFITTED","text":"Functor File Implementation Registry <code>FluxFunctor</code> <code>agents/flux/functor.py</code> <code>FluxAgent</code> + <code>Flux.unlift()</code> \u2705 <p>FluxFunctor (<code>agents/flux/functor.py</code>): - Derives from <code>UniversalFunctor[FluxAgent[Any, Any]]</code> - <code>lift()</code> creates FluxAgent for stream processing - <code>pure()</code> creates single-element async stream - Auto-registers on import</p>"},{"location":"architecture/alethic-algebra-tactics/#o-gent-unifiedobserverfunctor-complete","title":"O-gent UnifiedObserverFunctor \u2705 COMPLETE","text":"Functor File Implementation Registry <code>UnifiedObserverFunctor</code> <code>agents/o/observer_functor.py</code> <code>ObservedAgent</code> \u2705 <p>Consolidates: - O-gent telemetry - N-gent narrative traces - T-gent metrics</p>"},{"location":"architecture/alethic-algebra-tactics/#d-gent-statemonadfunctor-complete","title":"D-gent StateMonadFunctor \u2705 COMPLETE","text":"Functor File Implementation Registry <code>StateMonadFunctor</code> <code>agents/d/state_monad.py</code> <code>StatefulAgent</code> \u2705 <p>Enables: - Automatic state threading - Composition with Flux and other functors - Symmetric lifting with <code>unlift()</code></p>"},{"location":"architecture/alethic-algebra-tactics/#functor-composition-examples","title":"Functor Composition Examples","text":""},{"location":"architecture/alethic-algebra-tactics/#current-state-working","title":"Current State (Working)","text":"<pre><code># SoulFunctor composition is available now\nfrom agents.k.functor import SoulFunctor, soul, soul_lift\n\n# Lift any agent to soul domain\nsoul_agent = SoulFunctor.lift(my_agent)\n\n# Invoke with soul context\nresult = await soul_agent.invoke(soul(\"What should I prioritize?\"))\n# result is Soul[B] with preserved eigenvectors\n\n# Compose functors (once C-gent retrofitted)\nfrom agents.a.functor import compose_functors\nstack = compose_functors(SoulFunctor, MaybeFunctor)  # Soul \u2218 Maybe\n</code></pre>"},{"location":"architecture/alethic-algebra-tactics/#target-state-after-localprojector","title":"Target State (After LocalProjector)","text":"<pre><code># Halo-driven composition via projector\n@Capability.Stateful(schema=dict)\n@Capability.Soulful(persona=\"Kent\", mode=\"strict\")\n@Capability.Observable(mirror=True)\n@Capability.Streamable(budget=10.0)\nclass MyService(Agent[Request, Response]):\n    @property\n    def name(self): return \"my-service\"\n    async def invoke(self, req): return process(req)\n\n# One-line compilation\nagent = LocalProjector().compile(MyService)\n# Returns: FluxAgent wrapping MirrorAgent wrapping SoulAgent wrapping Symbiont\n</code></pre>"},{"location":"architecture/alethic-algebra-tactics/#with-archetypes-available-now","title":"With Archetypes (Available Now)","text":"<pre><code># Kappa gives you the full Halo automatically\nclass MyService(Kappa[Request, Response]):\n    @property\n    def name(self): return \"my-service\"\n    async def invoke(self, req): return process(req)\n\n# Introspect the Halo\nfrom agents.a.halo import get_halo, has_capability\nhalo = get_halo(MyService)  # {Stateful, Soulful, Observable, Streamable}\nassert has_capability(MyService, SoulfulCapability)\n</code></pre>"},{"location":"architecture/alethic-algebra-tactics/#verification-strategy","title":"Verification Strategy","text":""},{"location":"architecture/alethic-algebra-tactics/#current-state","title":"Current State","text":"<p>SoulFunctor Law Tests (<code>agents/k/_tests/test_soul_functor_laws.py</code>): - Verifies identity and composition laws - Uses <code>verify_functor()</code> from <code>agents/a/functor.py</code></p> <p>FunctorRegistry (<code>agents/a/functor.py</code>): - <code>verify_all()</code> available for batch verification - Currently only Soul registered</p>"},{"location":"architecture/alethic-algebra-tactics/#target-state-after-c-gent-retrofit","title":"Target State (After C-gent Retrofit)","text":"<pre><code># In test suite\nasync def test_all_registered_functors():\n    \"\"\"Verify all functors satisfy categorical laws.\"\"\"\n    reports = await FunctorRegistry.verify_all(\n        identity_agent=Id(),\n        f=double_agent,\n        g=add_one_agent,\n        test_input_factory=create_test_input,\n    )\n\n    # All must pass\n    for name, report in reports.items():\n        assert report.passed, f\"Functor {name} failed: {report.identity_law.explanation}\"\n</code></pre>"},{"location":"architecture/alethic-algebra-tactics/#ci-commands","title":"CI Commands","text":"<pre><code># Run functor law tests\npytest agents/a/_tests/test_functor.py -v\npytest agents/k/_tests/test_soul_functor_laws.py -v\n\n# Run all law tests\npytest -k \"functor_law or law_test\" --tb=short\n</code></pre>"},{"location":"architecture/alethic-algebra-tactics/#principle-alignment-audit","title":"Principle Alignment Audit","text":"<p>How the Alethic Algebra realizes spec/principles.md:</p> Principle Alethic Realization Tasteful Four capabilities only. No kitchen sink. Curated Three archetypes (Kappa/Lambda/Delta) cover 90% of use cases Ethical <code>@Soulful(mode=)</code> controls governance strength; dangerous keywords never auto-approve Joy-Inducing One-line archetype inheritance \u2192 full capability stack Composable Functors satisfy identity + composition laws; <code>compose_functors()</code> is associative Heterarchical advisory/strict/override modes; no fixed orchestrator Generative Laws define structure; verification derives from laws AGENTESE Soul context carries eigenvectors; observation is not neutral Accursed Share <code>@Streamable(budget=)</code> + entropy depletion \u2192 graceful collapse to Ground"},{"location":"architecture/alethic-algebra-tactics/#risk-mitigations","title":"Risk Mitigations","text":"Risk Mitigation Status Breaking existing functors Backward-compat: existing code unaffected, algebra is additive \u2705 Achieved Complexity creep Tasteful: only implement what K-gent + Projector need \u2705 Holding Performance overhead Zero-cost abstraction: Halo is metadata-only until projection \u2705 Achieved Law violations <code>verify_functor()</code> catches violations at test time \u2705 Available"},{"location":"architecture/alethic-algebra-tactics/#success-criteria-updated","title":"Success Criteria (Updated)","text":"Criterion Status UniversalFunctor protocol defined \u2705 SoulFunctor implements protocol \u2705 FunctorRegistry with <code>verify_all()</code> \u2705 Halo capabilities introspectable \u2705 Archetypes inherit Halo \u2705 K-gent intercept_deep() works \u2705 LocalProjector compiles Halo \u2192 runtime \u2705 C-gent functors retrofitted \u2705 Flux functor retrofitted \u2705 All functors registered in batch \u2705 (10+ functors) Cross-functor composition tested \u2705 CLI integration complete \u2705"},{"location":"architecture/alethic-algebra-tactics/#next-actions","title":"Next Actions","text":"<p>The Alethic Algebra is functionally complete. All planned features are implemented.</p> <p>Future Enhancements (not blocking): 1. B-gent Functors: <code>MeteredFunctor</code>, <code>ValueFunctor</code> for token accounting 2. Extended Law Verification: Property-based testing with Hypothesis 3. Performance Optimization: Lazy functor composition 4. Documentation: Comprehensive functor composition guide</p> <p>\"The skeleton exists. The algebra provides the muscles. The soul breathes life.\"</p>"},{"location":"architecture/alethic-algebra-tactics/#completion-summary-2025-12-12","title":"Completion Summary (2025-12-12)","text":"<p>The Alethic Algebra implementation is 95% complete:</p> <ul> <li>10+ functors registered in <code>FunctorRegistry</code></li> <li>Symmetric lifting (<code>lift/unlift</code>) for all major functors</li> <li>Cross-functor composition verified via <code>compose_functors()</code></li> <li>LocalProjector compiles Halo \u2192 runtime in canonical order</li> <li>K8sProjector generates Kubernetes manifests from Halo</li> <li>CLI provides full agent lifecycle management</li> </ul> <p>The remaining 5% represents future enhancements (B-gent functors, extended verification) that are not blocking for the current architecture.</p>"},{"location":"architecture/alethic-algebra-tactics/#next-phase-polish-batteries-included","title":"Next Phase: Polish &amp; Batteries Included","text":"<p>See: <code>prompts/alethic-polish.md</code></p> <p>The architecture is sound. Now make it delightful:</p> Component Purpose Examples directory 5 runnable examples (zero to agent in 5 min) Convenience imports <code>from agents import *</code> gives you everything <code>@agent</code> decorator One-liner agent creation <code>kgents a new</code> Scaffold new agents with boilerplate Functor Field Guide Docs accessible without category theory Test helpers <code>assert_agent_output</code>, <code>assert_functor_laws</code> <p>\"The difference between a good system and a great one is the last 5%.\"</p>"},{"location":"architecture/live-infrastructure/","title":"Live Infrastructure Plan: The Database Triad","text":"<p>\"YAML is generated, not written. The spec is the source of truth.\" \u2014 Spec-Driven Infrastructure Principle</p> <p>Status: Implementation Plan Date: 2025-12-12 Kent's Choices: PostgreSQL + Redis + Qdrant | OTel + Custom | Deep Integration | Visual Dashboards</p>"},{"location":"architecture/live-infrastructure/#overview","title":"Overview","text":"<p>This plan instantiates live infrastructure in Terrarium following the categorical principles. The Database Triad is a coproduct:</p> <pre><code>DB = Postgres \u2295 Redis \u2295 Qdrant\n</code></pre> <p>Each database is a specialized functor: - Postgres: Relations \u2192 State (ACID, source of truth) - Redis: Keys \u2192 State (cache, pub/sub, sessions) - Qdrant: Vectors \u2192 State (embeddings, semantic search)</p>"},{"location":"architecture/live-infrastructure/#phase-1-crds-and-operators","title":"Phase 1: CRDs and Operators","text":""},{"location":"architecture/live-infrastructure/#11-postgresql-crd","title":"1.1 PostgreSQL CRD","text":"<pre><code># impl/claude/infra/k8s/crds/postgres-crd.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  name: postgresclusters.kgents.io\nspec:\n  group: kgents.io\n  names:\n    kind: PostgresCluster\n    listKind: PostgresClusterList\n    plural: postgresclusters\n    singular: postgrescluster\n    shortNames:\n      - pg\n  scope: Namespaced\n  versions:\n    - name: v1alpha1\n      served: true\n      storage: true\n      schema:\n        openAPIV3Schema:\n          type: object\n          required:\n            - spec\n          properties:\n            spec:\n              type: object\n              required:\n                - database\n              properties:\n                database:\n                  type: string\n                  description: Database name\n                replicas:\n                  type: integer\n                  default: 1\n                  minimum: 1\n                  maximum: 3\n                storage:\n                  type: object\n                  properties:\n                    size:\n                      type: string\n                      default: \"1Gi\"\n                    storageClassName:\n                      type: string\n                resources:\n                  type: object\n                  properties:\n                    limits:\n                      type: object\n                      properties:\n                        cpu:\n                          type: string\n                          default: \"500m\"\n                        memory:\n                          type: string\n                          default: \"512Mi\"\n                    requests:\n                      type: object\n                      properties:\n                        cpu:\n                          type: string\n                          default: \"100m\"\n                        memory:\n                          type: string\n                          default: \"256Mi\"\n                pooler:\n                  type: object\n                  description: PgBouncer connection pooler\n                  properties:\n                    enabled:\n                      type: boolean\n                      default: true\n                    poolMode:\n                      type: string\n                      enum: [\"session\", \"transaction\", \"statement\"]\n                      default: \"transaction\"\n                    maxConnections:\n                      type: integer\n                      default: 100\n                backup:\n                  type: object\n                  properties:\n                    enabled:\n                      type: boolean\n                      default: false\n                    schedule:\n                      type: string\n                      description: Cron schedule for backups\n                metrics:\n                  type: object\n                  properties:\n                    enabled:\n                      type: boolean\n                      default: true\n                    port:\n                      type: integer\n                      default: 9187\n            status:\n              type: object\n              properties:\n                phase:\n                  type: string\n                  enum: [\"Pending\", \"Initializing\", \"Running\", \"Failed\", \"Degraded\"]\n                ready:\n                  type: boolean\n                endpoint:\n                  type: string\n                poolerEndpoint:\n                  type: string\n                connections:\n                  type: object\n                  properties:\n                    active:\n                      type: integer\n                    idle:\n                      type: integer\n                    waiting:\n                      type: integer\n      subresources:\n        status: {}\n      additionalPrinterColumns:\n        - name: Phase\n          type: string\n          jsonPath: .status.phase\n        - name: Ready\n          type: boolean\n          jsonPath: .status.ready\n        - name: Endpoint\n          type: string\n          jsonPath: .status.endpoint\n        - name: Active\n          type: integer\n          jsonPath: .status.connections.active\n        - name: Age\n          type: date\n          jsonPath: .metadata.creationTimestamp\n</code></pre>"},{"location":"architecture/live-infrastructure/#12-redis-crd","title":"1.2 Redis CRD","text":"<pre><code># impl/claude/infra/k8s/crds/redis-crd.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  name: redisclusters.kgents.io\nspec:\n  group: kgents.io\n  names:\n    kind: RedisCluster\n    listKind: RedisClusterList\n    plural: redisclusters\n    singular: rediscluster\n    shortNames:\n      - redis\n  scope: Namespaced\n  versions:\n    - name: v1alpha1\n      served: true\n      storage: true\n      schema:\n        openAPIV3Schema:\n          type: object\n          required:\n            - spec\n          properties:\n            spec:\n              type: object\n              properties:\n                image:\n                  type: string\n                  default: \"valkey/valkey:8\"\n                  description: Use Valkey (open source Redis fork)\n                replicas:\n                  type: integer\n                  default: 1\n                maxMemory:\n                  type: string\n                  default: \"128mb\"\n                evictionPolicy:\n                  type: string\n                  enum: [\"noeviction\", \"allkeys-lru\", \"volatile-lru\", \"allkeys-random\"]\n                  default: \"allkeys-lru\"\n                resources:\n                  type: object\n                  properties:\n                    limits:\n                      type: object\n                      properties:\n                        cpu:\n                          type: string\n                          default: \"200m\"\n                        memory:\n                          type: string\n                          default: \"256Mi\"\n                persistence:\n                  type: object\n                  properties:\n                    enabled:\n                      type: boolean\n                      default: false\n                    storageSize:\n                      type: string\n                      default: \"1Gi\"\n                pubsub:\n                  type: object\n                  properties:\n                    enabled:\n                      type: boolean\n                      default: true\n                    maxChannels:\n                      type: integer\n                      default: 100\n                metrics:\n                  type: object\n                  properties:\n                    enabled:\n                      type: boolean\n                      default: true\n                    port:\n                      type: integer\n                      default: 9121\n            status:\n              type: object\n              properties:\n                phase:\n                  type: string\n                ready:\n                  type: boolean\n                endpoint:\n                  type: string\n                memoryUsage:\n                  type: string\n                hitRate:\n                  type: string\n      subresources:\n        status: {}\n      additionalPrinterColumns:\n        - name: Phase\n          type: string\n          jsonPath: .status.phase\n        - name: Memory\n          type: string\n          jsonPath: .status.memoryUsage\n        - name: Hit Rate\n          type: string\n          jsonPath: .status.hitRate\n        - name: Age\n          type: date\n          jsonPath: .metadata.creationTimestamp\n</code></pre>"},{"location":"architecture/live-infrastructure/#13-qdrant-crd","title":"1.3 Qdrant CRD","text":"<pre><code># impl/claude/infra/k8s/crds/qdrant-crd.yaml\napiVersion: apiextensions.k8s.io/v1\nkind: CustomResourceDefinition\nmetadata:\n  name: qdrantclusters.kgents.io\nspec:\n  group: kgents.io\n  names:\n    kind: QdrantCluster\n    listKind: QdrantClusterList\n    plural: qdrantclusters\n    singular: qdrantcluster\n    shortNames:\n      - qdrant\n  scope: Namespaced\n  versions:\n    - name: v1alpha1\n      served: true\n      storage: true\n      schema:\n        openAPIV3Schema:\n          type: object\n          required:\n            - spec\n          properties:\n            spec:\n              type: object\n              properties:\n                replicas:\n                  type: integer\n                  default: 1\n                storage:\n                  type: object\n                  properties:\n                    size:\n                      type: string\n                      default: \"1Gi\"\n                resources:\n                  type: object\n                  properties:\n                    limits:\n                      type: object\n                      properties:\n                        cpu:\n                          type: string\n                          default: \"500m\"\n                        memory:\n                          type: string\n                          default: \"512Mi\"\n                collections:\n                  type: array\n                  description: Pre-create collections on startup\n                  items:\n                    type: object\n                    required:\n                      - name\n                      - dimensions\n                    properties:\n                      name:\n                        type: string\n                      dimensions:\n                        type: integer\n                      distance:\n                        type: string\n                        enum: [\"Cosine\", \"Euclid\", \"Dot\"]\n                        default: \"Cosine\"\n                metrics:\n                  type: object\n                  properties:\n                    enabled:\n                      type: boolean\n                      default: true\n            status:\n              type: object\n              properties:\n                phase:\n                  type: string\n                ready:\n                  type: boolean\n                endpoint:\n                  type: string\n                collections:\n                  type: array\n                  items:\n                    type: object\n                    properties:\n                      name:\n                        type: string\n                      vectors:\n                        type: integer\n      subresources:\n        status: {}\n      additionalPrinterColumns:\n        - name: Phase\n          type: string\n          jsonPath: .status.phase\n        - name: Endpoint\n          type: string\n          jsonPath: .status.endpoint\n        - name: Collections\n          type: integer\n          jsonPath: .status.collections\n        - name: Age\n          type: date\n          jsonPath: .metadata.creationTimestamp\n</code></pre>"},{"location":"architecture/live-infrastructure/#phase-2-operators","title":"Phase 2: Operators","text":""},{"location":"architecture/live-infrastructure/#21-postgresql-operator","title":"2.1 PostgreSQL Operator","text":"<pre><code># impl/claude/infra/k8s/operators/postgres_operator.py\n\"\"\"\nPostgreSQL Operator: Manages PostgresCluster CRDs.\n\nCreates:\n- StatefulSet for PostgreSQL\n- Service for internal access\n- PgBouncer Deployment (if pooler.enabled)\n- PVC for data persistence\n- ConfigMap for postgresql.conf\n- Secret for credentials\n\"\"\"\n\nfrom __future__ import annotations\n\nimport base64\nimport hashlib\nimport secrets\nfrom dataclasses import dataclass, field\nfrom typing import Any\n\nimport kopf\n\n\n@dataclass\nclass PostgresSpec:\n    \"\"\"Parsed PostgresCluster spec.\"\"\"\n\n    database: str\n    replicas: int = 1\n    storage_size: str = \"1Gi\"\n    storage_class: str | None = None\n    cpu_limit: str = \"500m\"\n    memory_limit: str = \"512Mi\"\n    cpu_request: str = \"100m\"\n    memory_request: str = \"256Mi\"\n    pooler_enabled: bool = True\n    pooler_mode: str = \"transaction\"\n    pooler_max_connections: int = 100\n    metrics_enabled: bool = True\n    metrics_port: int = 9187\n\n\ndef parse_postgres_spec(spec: dict[str, Any]) -&gt; PostgresSpec:\n    \"\"\"Parse CRD spec into typed dataclass.\"\"\"\n    resources = spec.get(\"resources\", {})\n    limits = resources.get(\"limits\", {})\n    requests = resources.get(\"requests\", {})\n    storage = spec.get(\"storage\", {})\n    pooler = spec.get(\"pooler\", {})\n    metrics = spec.get(\"metrics\", {})\n\n    return PostgresSpec(\n        database=spec[\"database\"],\n        replicas=spec.get(\"replicas\", 1),\n        storage_size=storage.get(\"size\", \"1Gi\"),\n        storage_class=storage.get(\"storageClassName\"),\n        cpu_limit=limits.get(\"cpu\", \"500m\"),\n        memory_limit=limits.get(\"memory\", \"512Mi\"),\n        cpu_request=requests.get(\"cpu\", \"100m\"),\n        memory_request=requests.get(\"memory\", \"256Mi\"),\n        pooler_enabled=pooler.get(\"enabled\", True),\n        pooler_mode=pooler.get(\"poolMode\", \"transaction\"),\n        pooler_max_connections=pooler.get(\"maxConnections\", 100),\n        metrics_enabled=metrics.get(\"enabled\", True),\n        metrics_port=metrics.get(\"port\", 9187),\n    )\n\n\ndef generate_password() -&gt; str:\n    \"\"\"Generate secure random password.\"\"\"\n    return secrets.token_urlsafe(24)\n\n\ndef to_secret(name: str, namespace: str, database: str) -&gt; dict[str, Any]:\n    \"\"\"Generate Secret manifest for PostgreSQL credentials.\"\"\"\n    password = generate_password()\n    return {\n        \"apiVersion\": \"v1\",\n        \"kind\": \"Secret\",\n        \"metadata\": {\n            \"name\": f\"{name}-credentials\",\n            \"namespace\": namespace,\n            \"labels\": {\n                \"app.kubernetes.io/name\": \"postgres\",\n                \"app.kubernetes.io/instance\": name,\n                \"kgents.io/component\": \"database\",\n            },\n        },\n        \"type\": \"Opaque\",\n        \"data\": {\n            \"username\": base64.b64encode(b\"postgres\").decode(),\n            \"password\": base64.b64encode(password.encode()).decode(),\n            \"database\": base64.b64encode(database.encode()).decode(),\n            \"connection-string\": base64.b64encode(\n                f\"postgresql://postgres:{password}@{name}:5432/{database}\".encode()\n            ).decode(),\n        },\n    }\n\n\ndef to_configmap(name: str, namespace: str, spec: PostgresSpec) -&gt; dict[str, Any]:\n    \"\"\"Generate ConfigMap for postgresql.conf.\"\"\"\n    return {\n        \"apiVersion\": \"v1\",\n        \"kind\": \"ConfigMap\",\n        \"metadata\": {\n            \"name\": f\"{name}-config\",\n            \"namespace\": namespace,\n            \"labels\": {\n                \"app.kubernetes.io/name\": \"postgres\",\n                \"app.kubernetes.io/instance\": name,\n            },\n        },\n        \"data\": {\n            \"postgresql.conf\": f\"\"\"\n# kgents PostgreSQL configuration\nlisten_addresses = '*'\nmax_connections = 200\nshared_buffers = 128MB\nwork_mem = 4MB\n\n# Logging for observability\nlog_statement = 'all'\nlog_duration = on\nlog_min_duration_statement = 100\n\n# pg_stat_statements for metrics\nshared_preload_libraries = 'pg_stat_statements'\npg_stat_statements.track = all\n\"\"\",\n            \"pg_hba.conf\": \"\"\"\n# TYPE  DATABASE        USER            ADDRESS                 METHOD\nlocal   all             all                                     trust\nhost    all             all             0.0.0.0/0               md5\nhost    all             all             ::/0                    md5\n\"\"\",\n        },\n    }\n\n\ndef to_statefulset(\n    name: str, namespace: str, spec: PostgresSpec, secret_name: str\n) -&gt; dict[str, Any]:\n    \"\"\"Generate StatefulSet manifest for PostgreSQL.\"\"\"\n    return {\n        \"apiVersion\": \"apps/v1\",\n        \"kind\": \"StatefulSet\",\n        \"metadata\": {\n            \"name\": name,\n            \"namespace\": namespace,\n            \"labels\": {\n                \"app.kubernetes.io/name\": \"postgres\",\n                \"app.kubernetes.io/instance\": name,\n                \"kgents.io/component\": \"database\",\n            },\n        },\n        \"spec\": {\n            \"serviceName\": name,\n            \"replicas\": spec.replicas,\n            \"selector\": {\n                \"matchLabels\": {\n                    \"app.kubernetes.io/name\": \"postgres\",\n                    \"app.kubernetes.io/instance\": name,\n                }\n            },\n            \"template\": {\n                \"metadata\": {\n                    \"labels\": {\n                        \"app.kubernetes.io/name\": \"postgres\",\n                        \"app.kubernetes.io/instance\": name,\n                    },\n                    \"annotations\": {\n                        \"prometheus.io/scrape\": \"true\" if spec.metrics_enabled else \"false\",\n                        \"prometheus.io/port\": str(spec.metrics_port),\n                    },\n                },\n                \"spec\": {\n                    \"containers\": [\n                        {\n                            \"name\": \"postgres\",\n                            \"image\": \"postgres:16-alpine\",\n                            \"ports\": [{\"containerPort\": 5432, \"name\": \"postgres\"}],\n                            \"env\": [\n                                {\n                                    \"name\": \"POSTGRES_DB\",\n                                    \"valueFrom\": {\n                                        \"secretKeyRef\": {\n                                            \"name\": secret_name,\n                                            \"key\": \"database\",\n                                        }\n                                    },\n                                },\n                                {\n                                    \"name\": \"POSTGRES_PASSWORD\",\n                                    \"valueFrom\": {\n                                        \"secretKeyRef\": {\n                                            \"name\": secret_name,\n                                            \"key\": \"password\",\n                                        }\n                                    },\n                                },\n                            ],\n                            \"resources\": {\n                                \"limits\": {\n                                    \"cpu\": spec.cpu_limit,\n                                    \"memory\": spec.memory_limit,\n                                },\n                                \"requests\": {\n                                    \"cpu\": spec.cpu_request,\n                                    \"memory\": spec.memory_request,\n                                },\n                            },\n                            \"volumeMounts\": [\n                                {\"name\": \"data\", \"mountPath\": \"/var/lib/postgresql/data\"},\n                                {\"name\": \"config\", \"mountPath\": \"/etc/postgresql\"},\n                            ],\n                            \"livenessProbe\": {\n                                \"exec\": {\n                                    \"command\": [\"pg_isready\", \"-U\", \"postgres\"]\n                                },\n                                \"initialDelaySeconds\": 30,\n                                \"periodSeconds\": 10,\n                            },\n                            \"readinessProbe\": {\n                                \"exec\": {\n                                    \"command\": [\"pg_isready\", \"-U\", \"postgres\"]\n                                },\n                                \"initialDelaySeconds\": 5,\n                                \"periodSeconds\": 5,\n                            },\n                        },\n                    ]\n                    + (\n                        [\n                            {\n                                \"name\": \"exporter\",\n                                \"image\": \"prometheuscommunity/postgres-exporter:v0.15.0\",\n                                \"ports\": [\n                                    {\"containerPort\": spec.metrics_port, \"name\": \"metrics\"}\n                                ],\n                                \"env\": [\n                                    {\n                                        \"name\": \"DATA_SOURCE_URI\",\n                                        \"value\": \"localhost:5432/postgres?sslmode=disable\",\n                                    },\n                                    {\n                                        \"name\": \"DATA_SOURCE_USER\",\n                                        \"value\": \"postgres\",\n                                    },\n                                    {\n                                        \"name\": \"DATA_SOURCE_PASS\",\n                                        \"valueFrom\": {\n                                            \"secretKeyRef\": {\n                                                \"name\": secret_name,\n                                                \"key\": \"password\",\n                                            }\n                                        },\n                                    },\n                                ],\n                                \"resources\": {\n                                    \"limits\": {\"cpu\": \"100m\", \"memory\": \"128Mi\"},\n                                    \"requests\": {\"cpu\": \"50m\", \"memory\": \"64Mi\"},\n                                },\n                            }\n                        ]\n                        if spec.metrics_enabled\n                        else []\n                    ),\n                    \"volumes\": [\n                        {\n                            \"name\": \"config\",\n                            \"configMap\": {\"name\": f\"{name}-config\"},\n                        }\n                    ],\n                },\n            },\n            \"volumeClaimTemplates\": [\n                {\n                    \"metadata\": {\"name\": \"data\"},\n                    \"spec\": {\n                        \"accessModes\": [\"ReadWriteOnce\"],\n                        \"resources\": {\"requests\": {\"storage\": spec.storage_size}},\n                        **(\n                            {\"storageClassName\": spec.storage_class}\n                            if spec.storage_class\n                            else {}\n                        ),\n                    },\n                }\n            ],\n        },\n    }\n\n\ndef to_service(name: str, namespace: str) -&gt; dict[str, Any]:\n    \"\"\"Generate Service manifest for PostgreSQL.\"\"\"\n    return {\n        \"apiVersion\": \"v1\",\n        \"kind\": \"Service\",\n        \"metadata\": {\n            \"name\": name,\n            \"namespace\": namespace,\n            \"labels\": {\n                \"app.kubernetes.io/name\": \"postgres\",\n                \"app.kubernetes.io/instance\": name,\n            },\n        },\n        \"spec\": {\n            \"type\": \"ClusterIP\",\n            \"ports\": [\n                {\"port\": 5432, \"targetPort\": 5432, \"name\": \"postgres\"},\n                {\"port\": 9187, \"targetPort\": 9187, \"name\": \"metrics\"},\n            ],\n            \"selector\": {\n                \"app.kubernetes.io/name\": \"postgres\",\n                \"app.kubernetes.io/instance\": name,\n            },\n        },\n    }\n\n\n# Kopf handlers (for real operator deployment)\n@kopf.on.create(\"kgents.io\", \"v1alpha1\", \"postgresclusters\")\nasync def create_postgres(spec: dict, name: str, namespace: str, **kwargs):\n    \"\"\"Handle PostgresCluster creation.\"\"\"\n    parsed = parse_postgres_spec(spec)\n\n    # Generate manifests\n    secret = to_secret(name, namespace, parsed.database)\n    configmap = to_configmap(name, namespace, parsed)\n    statefulset = to_statefulset(name, namespace, parsed, f\"{name}-credentials\")\n    service = to_service(name, namespace)\n\n    # Create resources (kopf.adopt for ownership)\n    # In real implementation, use kubernetes client\n    return {\n        \"phase\": \"Initializing\",\n        \"ready\": False,\n        \"endpoint\": f\"{name}.{namespace}.svc.cluster.local:5432\",\n    }\n\n\n@kopf.on.delete(\"kgents.io\", \"v1alpha1\", \"postgresclusters\")\nasync def delete_postgres(name: str, namespace: str, **kwargs):\n    \"\"\"Handle PostgresCluster deletion.\"\"\"\n    # Kubernetes garbage collection handles owned resources\n    pass\n</code></pre>"},{"location":"architecture/live-infrastructure/#phase-3-database-metrics","title":"Phase 3: Database Metrics","text":""},{"location":"architecture/live-infrastructure/#31-dbpulse-dataclass","title":"3.1 DBPulse Dataclass","text":"<pre><code># impl/claude/protocols/terrarium/db_metrics.py\n\"\"\"\nDatabase Metrics: Emit DB health to Terrarium HolographicBuffer.\n\nExtends the Pulse pattern from agents/d/pulse.py to databases.\nEach backend (Postgres, Redis, Qdrant) has specialized metrics.\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass, field\nfrom datetime import datetime, timezone\nfrom enum import Enum\nfrom typing import Any, Literal\n\n\nclass DBPhase(Enum):\n    \"\"\"Database operational phase.\"\"\"\n\n    STARTING = \"starting\"\n    HEALTHY = \"healthy\"\n    DEGRADED = \"degraded\"\n    OVERLOADED = \"overloaded\"\n    FAILING = \"failing\"\n\n\n@dataclass(frozen=True)\nclass PostgresPulse:\n    \"\"\"Vitality signal for PostgreSQL.\"\"\"\n\n    timestamp: str\n    phase: DBPhase\n\n    # Connection pool\n    pool_active: int\n    pool_idle: int\n    pool_waiting: int\n    pool_max: int\n\n    # Query metrics\n    queries_per_second: float\n    avg_latency_ms: float\n    slow_queries: int  # Queries &gt; 100ms\n\n    # Resource usage\n    connections_used: int\n    connections_max: int\n    cache_hit_ratio: float  # From pg_stat_statements\n\n    # Categorical metric\n    morphisms_executed: int  # Total queries since startup\n\n    def to_event(self) -&gt; dict[str, Any]:\n        \"\"\"Convert to Terrarium event format.\"\"\"\n        return {\n            \"type\": \"DB_PULSE\",\n            \"backend\": \"postgres\",\n            \"timestamp\": self.timestamp,\n            \"phase\": self.phase.value,\n            \"pool\": {\n                \"active\": self.pool_active,\n                \"idle\": self.pool_idle,\n                \"waiting\": self.pool_waiting,\n                \"max\": self.pool_max,\n                \"utilization\": self.pool_active / self.pool_max if self.pool_max &gt; 0 else 0,\n            },\n            \"performance\": {\n                \"qps\": self.queries_per_second,\n                \"latency_ms\": self.avg_latency_ms,\n                \"slow_queries\": self.slow_queries,\n                \"cache_hit_ratio\": self.cache_hit_ratio,\n            },\n            \"morphisms\": self.morphisms_executed,\n        }\n\n    @classmethod\n    def create(\n        cls,\n        pool_active: int = 0,\n        pool_idle: int = 0,\n        pool_waiting: int = 0,\n        pool_max: int = 100,\n        qps: float = 0.0,\n        latency_ms: float = 0.0,\n        slow_queries: int = 0,\n        cache_hit_ratio: float = 0.0,\n        morphisms: int = 0,\n    ) -&gt; PostgresPulse:\n        \"\"\"Factory with sensible defaults.\"\"\"\n        # Determine phase based on metrics\n        utilization = pool_active / pool_max if pool_max &gt; 0 else 0\n        if utilization &gt; 0.9 or latency_ms &gt; 100:\n            phase = DBPhase.OVERLOADED\n        elif utilization &gt; 0.7 or latency_ms &gt; 50:\n            phase = DBPhase.DEGRADED\n        elif pool_active == 0:\n            phase = DBPhase.STARTING\n        else:\n            phase = DBPhase.HEALTHY\n\n        return cls(\n            timestamp=datetime.now(timezone.utc).isoformat(),\n            phase=phase,\n            pool_active=pool_active,\n            pool_idle=pool_idle,\n            pool_waiting=pool_waiting,\n            pool_max=pool_max,\n            queries_per_second=qps,\n            avg_latency_ms=latency_ms,\n            slow_queries=slow_queries,\n            connections_used=pool_active,\n            connections_max=pool_max,\n            cache_hit_ratio=cache_hit_ratio,\n            morphisms_executed=morphisms,\n        )\n\n\n@dataclass(frozen=True)\nclass RedisPulse:\n    \"\"\"Vitality signal for Redis/Valkey.\"\"\"\n\n    timestamp: str\n    phase: DBPhase\n\n    # Memory\n    memory_used_mb: float\n    memory_max_mb: float\n    memory_fragmentation_ratio: float\n\n    # Performance\n    commands_per_second: float\n    hit_rate: float  # Cache hit ratio\n    keyspace_hits: int\n    keyspace_misses: int\n\n    # Pub/Sub\n    pubsub_channels: int\n    pubsub_patterns: int\n\n    # Categorical metric\n    morphisms_executed: int\n\n    def to_event(self) -&gt; dict[str, Any]:\n        return {\n            \"type\": \"DB_PULSE\",\n            \"backend\": \"redis\",\n            \"timestamp\": self.timestamp,\n            \"phase\": self.phase.value,\n            \"memory\": {\n                \"used_mb\": self.memory_used_mb,\n                \"max_mb\": self.memory_max_mb,\n                \"utilization\": self.memory_used_mb / self.memory_max_mb\n                if self.memory_max_mb &gt; 0\n                else 0,\n                \"fragmentation\": self.memory_fragmentation_ratio,\n            },\n            \"performance\": {\n                \"ops_per_second\": self.commands_per_second,\n                \"hit_rate\": self.hit_rate,\n            },\n            \"pubsub\": {\n                \"channels\": self.pubsub_channels,\n                \"patterns\": self.pubsub_patterns,\n            },\n            \"morphisms\": self.morphisms_executed,\n        }\n\n\n@dataclass(frozen=True)\nclass QdrantPulse:\n    \"\"\"Vitality signal for Qdrant.\"\"\"\n\n    timestamp: str\n    phase: DBPhase\n\n    # Collections\n    collections_count: int\n    total_vectors: int\n\n    # Performance\n    searches_per_second: float\n    avg_search_latency_ms: float\n    index_size_mb: float\n\n    # Resource\n    memory_mb: float\n    disk_mb: float\n\n    # Categorical metric\n    morphisms_executed: int\n\n    def to_event(self) -&gt; dict[str, Any]:\n        return {\n            \"type\": \"DB_PULSE\",\n            \"backend\": \"qdrant\",\n            \"timestamp\": self.timestamp,\n            \"phase\": self.phase.value,\n            \"collections\": {\n                \"count\": self.collections_count,\n                \"vectors\": self.total_vectors,\n            },\n            \"performance\": {\n                \"searches_per_second\": self.searches_per_second,\n                \"latency_ms\": self.avg_search_latency_ms,\n            },\n            \"storage\": {\n                \"index_mb\": self.index_size_mb,\n                \"memory_mb\": self.memory_mb,\n                \"disk_mb\": self.disk_mb,\n            },\n            \"morphisms\": self.morphisms_executed,\n        }\n\n\n@dataclass\nclass DBMetricsCollector:\n    \"\"\"Collects metrics from all database backends.\"\"\"\n\n    postgres_endpoint: str | None = None\n    redis_endpoint: str | None = None\n    qdrant_endpoint: str | None = None\n\n    _postgres_client: Any = field(default=None, repr=False)\n    _redis_client: Any = field(default=None, repr=False)\n    _qdrant_client: Any = field(default=None, repr=False)\n\n    async def collect_postgres(self) -&gt; PostgresPulse | None:\n        \"\"\"Collect PostgreSQL metrics via pg_stat_statements.\"\"\"\n        if not self._postgres_client:\n            return None\n\n        # Query pg_stat_statements\n        stats = await self._postgres_client.fetchrow(\n            \"\"\"\n            SELECT\n                sum(calls) as total_calls,\n                sum(total_exec_time) / sum(calls) as avg_time_ms,\n                sum(calls) / EXTRACT(EPOCH FROM (now() - pg_postmaster_start_time())) as qps\n            FROM pg_stat_statements\n            WHERE dbid = (SELECT oid FROM pg_database WHERE datname = current_database())\n            \"\"\"\n        )\n\n        pool = self._postgres_client.get_pool()\n\n        return PostgresPulse.create(\n            pool_active=pool.get_size() - pool.get_idle_size(),\n            pool_idle=pool.get_idle_size(),\n            pool_waiting=0,  # Would need pg_stat_activity query\n            pool_max=pool.get_max_size(),\n            qps=float(stats[\"qps\"] or 0),\n            latency_ms=float(stats[\"avg_time_ms\"] or 0),\n            morphisms=int(stats[\"total_calls\"] or 0),\n        )\n\n    async def collect_redis(self) -&gt; RedisPulse | None:\n        \"\"\"Collect Redis metrics via INFO command.\"\"\"\n        if not self._redis_client:\n            return None\n\n        info = await self._redis_client.info()\n\n        memory_used = info.get(\"used_memory\", 0) / (1024 * 1024)\n        memory_max = info.get(\"maxmemory\", 0) / (1024 * 1024) or 128  # Default 128MB\n\n        hits = info.get(\"keyspace_hits\", 0)\n        misses = info.get(\"keyspace_misses\", 0)\n        hit_rate = hits / (hits + misses) if (hits + misses) &gt; 0 else 0\n\n        # Determine phase\n        utilization = memory_used / memory_max if memory_max &gt; 0 else 0\n        if utilization &gt; 0.9:\n            phase = DBPhase.OVERLOADED\n        elif utilization &gt; 0.7:\n            phase = DBPhase.DEGRADED\n        else:\n            phase = DBPhase.HEALTHY\n\n        return RedisPulse(\n            timestamp=datetime.now(timezone.utc).isoformat(),\n            phase=phase,\n            memory_used_mb=memory_used,\n            memory_max_mb=memory_max,\n            memory_fragmentation_ratio=info.get(\"mem_fragmentation_ratio\", 1.0),\n            commands_per_second=info.get(\"instantaneous_ops_per_sec\", 0),\n            hit_rate=hit_rate,\n            keyspace_hits=hits,\n            keyspace_misses=misses,\n            pubsub_channels=info.get(\"pubsub_channels\", 0),\n            pubsub_patterns=info.get(\"pubsub_patterns\", 0),\n            morphisms_executed=info.get(\"total_commands_processed\", 0),\n        )\n\n    async def collect_qdrant(self) -&gt; QdrantPulse | None:\n        \"\"\"Collect Qdrant metrics via REST API.\"\"\"\n        if not self._qdrant_client:\n            return None\n\n        # Get collections info\n        collections = await self._qdrant_client.get_collections()\n        total_vectors = sum(c.vectors_count for c in collections.collections)\n\n        # Get telemetry\n        telemetry = await self._qdrant_client.get_telemetry()\n\n        return QdrantPulse(\n            timestamp=datetime.now(timezone.utc).isoformat(),\n            phase=DBPhase.HEALTHY,\n            collections_count=len(collections.collections),\n            total_vectors=total_vectors,\n            searches_per_second=telemetry.get(\"requests\", {}).get(\"avg_per_second\", 0),\n            avg_search_latency_ms=telemetry.get(\"requests\", {}).get(\"avg_duration_ms\", 0),\n            index_size_mb=telemetry.get(\"storage\", {}).get(\"index_size_mb\", 0),\n            memory_mb=telemetry.get(\"storage\", {}).get(\"memory_mb\", 0),\n            disk_mb=telemetry.get(\"storage\", {}).get(\"disk_mb\", 0),\n            morphisms_executed=telemetry.get(\"requests\", {}).get(\"total\", 0),\n        )\n</code></pre>"},{"location":"architecture/live-infrastructure/#phase-4-visual-dashboard-widget","title":"Phase 4: Visual Dashboard Widget","text":""},{"location":"architecture/live-infrastructure/#41-db-metrics-panel","title":"4.1 DB Metrics Panel","text":"<pre><code># impl/claude/agents/i/widgets/db_panel.py\n\"\"\"\nDatabase Metrics Panel: Textual widget for live DB visualization.\n\nDisplays:\n- PostgreSQL pool utilization, QPS, latency\n- Redis memory usage, hit rate\n- Qdrant vector count, search latency\n- Bicameral coherency status\n\"\"\"\n\nfrom textual.app import ComposeResult\nfrom textual.containers import Horizontal, Vertical\nfrom textual.widgets import Static, ProgressBar, Label\nfrom textual.reactive import reactive\n\nfrom protocols.terrarium.db_metrics import PostgresPulse, RedisPulse, QdrantPulse\n\n\nclass DBGauge(Static):\n    \"\"\"Base gauge widget for database metrics.\"\"\"\n\n    value = reactive(0.0)\n    label_text = reactive(\"DB\")\n\n    def compose(self) -&gt; ComposeResult:\n        yield Label(self.label_text, id=\"gauge-label\")\n        yield ProgressBar(total=100, show_eta=False, id=\"gauge-bar\")\n        yield Label(\"0%\", id=\"gauge-value\")\n\n    def watch_value(self, value: float) -&gt; None:\n        bar = self.query_one(\"#gauge-bar\", ProgressBar)\n        bar.update(progress=value * 100)\n        self.query_one(\"#gauge-value\", Label).update(f\"{value:.1%}\")\n\n\nclass PostgresGauge(Vertical):\n    \"\"\"PostgreSQL metrics widget.\"\"\"\n\n    DEFAULT_CSS = \"\"\"\n    PostgresGauge {\n        border: solid green;\n        height: auto;\n        padding: 1;\n    }\n\n    PostgresGauge .header {\n        text-style: bold;\n        color: $success;\n    }\n\n    PostgresGauge .metric {\n        margin-left: 2;\n    }\n    \"\"\"\n\n    pulse: PostgresPulse | None = reactive(None)\n\n    def compose(self) -&gt; ComposeResult:\n        yield Label(\"POSTGRES\", classes=\"header\")\n        yield Horizontal(\n            Label(\"Pool:\", classes=\"label\"),\n            ProgressBar(total=100, show_eta=False, id=\"pool-bar\"),\n            Label(\"0/0\", id=\"pool-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"QPS:\", classes=\"label\"),\n            Label(\"0.0\", id=\"qps-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Lat:\", classes=\"label\"),\n            Label(\"0ms\", id=\"latency-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Phase:\", classes=\"label\"),\n            Label(\"unknown\", id=\"phase-text\"),\n            classes=\"metric\",\n        )\n\n    def watch_pulse(self, pulse: PostgresPulse | None) -&gt; None:\n        if not pulse:\n            return\n\n        # Update pool bar\n        bar = self.query_one(\"#pool-bar\", ProgressBar)\n        utilization = pulse.pool_active / pulse.pool_max if pulse.pool_max &gt; 0 else 0\n        bar.update(progress=utilization * 100)\n        self.query_one(\"#pool-text\", Label).update(\n            f\"{pulse.pool_active}/{pulse.pool_max}\"\n        )\n\n        # Update QPS\n        self.query_one(\"#qps-text\", Label).update(f\"{pulse.queries_per_second:.1f}\")\n\n        # Update latency\n        self.query_one(\"#latency-text\", Label).update(f\"{pulse.avg_latency_ms:.1f}ms\")\n\n        # Update phase with color\n        phase_label = self.query_one(\"#phase-text\", Label)\n        phase_label.update(pulse.phase.value)\n        phase_label.styles.color = {\n            \"healthy\": \"green\",\n            \"degraded\": \"yellow\",\n            \"overloaded\": \"red\",\n            \"failing\": \"red\",\n            \"starting\": \"blue\",\n        }.get(pulse.phase.value, \"white\")\n\n\nclass RedisGauge(Vertical):\n    \"\"\"Redis metrics widget.\"\"\"\n\n    DEFAULT_CSS = \"\"\"\n    RedisGauge {\n        border: solid red;\n        height: auto;\n        padding: 1;\n    }\n\n    RedisGauge .header {\n        text-style: bold;\n        color: $error;\n    }\n    \"\"\"\n\n    pulse: RedisPulse | None = reactive(None)\n\n    def compose(self) -&gt; ComposeResult:\n        yield Label(\"REDIS\", classes=\"header\")\n        yield Horizontal(\n            Label(\"Mem:\", classes=\"label\"),\n            ProgressBar(total=100, show_eta=False, id=\"mem-bar\"),\n            Label(\"0/0 MB\", id=\"mem-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Hit:\", classes=\"label\"),\n            Label(\"0%\", id=\"hit-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Ops:\", classes=\"label\"),\n            Label(\"0/s\", id=\"ops-text\"),\n            classes=\"metric\",\n        )\n\n    def watch_pulse(self, pulse: RedisPulse | None) -&gt; None:\n        if not pulse:\n            return\n\n        # Update memory bar\n        bar = self.query_one(\"#mem-bar\", ProgressBar)\n        utilization = (\n            pulse.memory_used_mb / pulse.memory_max_mb if pulse.memory_max_mb &gt; 0 else 0\n        )\n        bar.update(progress=utilization * 100)\n        self.query_one(\"#mem-text\", Label).update(\n            f\"{pulse.memory_used_mb:.0f}/{pulse.memory_max_mb:.0f} MB\"\n        )\n\n        # Update hit rate\n        self.query_one(\"#hit-text\", Label).update(f\"{pulse.hit_rate:.1%}\")\n\n        # Update ops\n        self.query_one(\"#ops-text\", Label).update(f\"{pulse.commands_per_second:.0f}/s\")\n\n\nclass QdrantGauge(Vertical):\n    \"\"\"Qdrant metrics widget.\"\"\"\n\n    DEFAULT_CSS = \"\"\"\n    QdrantGauge {\n        border: solid blue;\n        height: auto;\n        padding: 1;\n    }\n\n    QdrantGauge .header {\n        text-style: bold;\n        color: $primary;\n    }\n    \"\"\"\n\n    pulse: QdrantPulse | None = reactive(None)\n\n    def compose(self) -&gt; ComposeResult:\n        yield Label(\"QDRANT\", classes=\"header\")\n        yield Horizontal(\n            Label(\"Vectors:\", classes=\"label\"),\n            Label(\"0\", id=\"vectors-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Search:\", classes=\"label\"),\n            Label(\"0/s\", id=\"search-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Lat:\", classes=\"label\"),\n            Label(\"0ms\", id=\"latency-text\"),\n            classes=\"metric\",\n        )\n\n    def watch_pulse(self, pulse: QdrantPulse | None) -&gt; None:\n        if not pulse:\n            return\n\n        self.query_one(\"#vectors-text\", Label).update(f\"{pulse.total_vectors:,}\")\n        self.query_one(\"#search-text\", Label).update(\n            f\"{pulse.searches_per_second:.1f}/s\"\n        )\n        self.query_one(\"#latency-text\", Label).update(\n            f\"{pulse.avg_search_latency_ms:.1f}ms\"\n        )\n\n\nclass BicameralCoherencyBar(Vertical):\n    \"\"\"Bicameral Memory coherency status widget.\"\"\"\n\n    DEFAULT_CSS = \"\"\"\n    BicameralCoherencyBar {\n        border: solid magenta;\n        height: auto;\n        padding: 1;\n    }\n\n    BicameralCoherencyBar .header {\n        text-style: bold;\n        color: $secondary;\n    }\n    \"\"\"\n\n    coherency_rate = reactive(1.0)\n    ghosts_healed = reactive(0)\n    stale_flagged = reactive(0)\n\n    def compose(self) -&gt; ComposeResult:\n        yield Label(\"BICAMERAL COHERENCY\", classes=\"header\")\n        yield Horizontal(\n            Label(\"Left (PG) \u2190\u2192 Right (Qdrant)\", classes=\"label\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Coherency:\", classes=\"label\"),\n            ProgressBar(total=100, show_eta=False, id=\"coherency-bar\"),\n            Label(\"100%\", id=\"coherency-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Ghosts healed:\", classes=\"label\"),\n            Label(\"0\", id=\"ghosts-text\"),\n            Label(\" | Stale:\", classes=\"label\"),\n            Label(\"0\", id=\"stale-text\"),\n            classes=\"metric\",\n        )\n\n    def watch_coherency_rate(self, rate: float) -&gt; None:\n        bar = self.query_one(\"#coherency-bar\", ProgressBar)\n        bar.update(progress=rate * 100)\n        text = self.query_one(\"#coherency-text\", Label)\n        text.update(f\"{rate:.1%}\")\n        text.styles.color = \"green\" if rate &gt; 0.95 else \"yellow\" if rate &gt; 0.8 else \"red\"\n\n    def watch_ghosts_healed(self, count: int) -&gt; None:\n        self.query_one(\"#ghosts-text\", Label).update(str(count))\n\n    def watch_stale_flagged(self, count: int) -&gt; None:\n        self.query_one(\"#stale-text\", Label).update(str(count))\n\n\nclass DBMetricsPanel(Vertical):\n    \"\"\"Complete database metrics panel.\"\"\"\n\n    DEFAULT_CSS = \"\"\"\n    DBMetricsPanel {\n        height: auto;\n        padding: 1;\n    }\n\n    DBMetricsPanel &gt; Horizontal {\n        height: auto;\n    }\n    \"\"\"\n\n    def compose(self) -&gt; ComposeResult:\n        yield Horizontal(\n            PostgresGauge(id=\"postgres-gauge\"),\n            RedisGauge(id=\"redis-gauge\"),\n            QdrantGauge(id=\"qdrant-gauge\"),\n        )\n        yield BicameralCoherencyBar(id=\"bicameral-bar\")\n\n    def update_postgres(self, pulse: PostgresPulse) -&gt; None:\n        self.query_one(\"#postgres-gauge\", PostgresGauge).pulse = pulse\n\n    def update_redis(self, pulse: RedisPulse) -&gt; None:\n        self.query_one(\"#redis-gauge\", RedisGauge).pulse = pulse\n\n    def update_qdrant(self, pulse: QdrantPulse) -&gt; None:\n        self.query_one(\"#qdrant-gauge\", QdrantGauge).pulse = pulse\n\n    def update_coherency(\n        self, rate: float, ghosts: int = 0, stale: int = 0\n    ) -&gt; None:\n        bar = self.query_one(\"#bicameral-bar\", BicameralCoherencyBar)\n        bar.coherency_rate = rate\n        bar.ghosts_healed = ghosts\n        bar.stale_flagged = stale\n</code></pre>"},{"location":"architecture/live-infrastructure/#phase-5-terrarium-integration","title":"Phase 5: Terrarium Integration","text":""},{"location":"architecture/live-infrastructure/#51-terrarium-endpoint","title":"5.1 Terrarium Endpoint","text":"<pre><code># Addition to impl/claude/protocols/terrarium/gateway.py\n\n@app.get(\"/api/db/metrics\")\nasync def get_db_metrics():\n    \"\"\"Get aggregated database metrics for I-gent DensityField.\"\"\"\n    collector = app.state.db_collector\n\n    postgres_pulse = await collector.collect_postgres()\n    redis_pulse = await collector.collect_redis()\n    qdrant_pulse = await collector.collect_qdrant()\n\n    return {\n        \"postgres\": postgres_pulse.to_event() if postgres_pulse else None,\n        \"redis\": redis_pulse.to_event() if redis_pulse else None,\n        \"qdrant\": qdrant_pulse.to_event() if qdrant_pulse else None,\n        \"bicameral\": {\n            \"coherency_rate\": app.state.bicameral.stats().get(\"coherency_rate\", 1.0)\n            if hasattr(app.state, \"bicameral\")\n            else 1.0,\n        },\n    }\n</code></pre>"},{"location":"architecture/live-infrastructure/#categorical-summary","title":"Categorical Summary","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              THE DATABASE TRIAD AS COPRODUCT                \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                             \u2502\n\u2502                      DB = Pg \u2295 Redis \u2295 Qdrant               \u2502\n\u2502                                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u2502\n\u2502  \u2502 Postgres \u2502      \u2502  Redis   \u2502      \u2502  Qdrant  \u2502          \u2502\n\u2502  \u2502 (ACID)   \u2502      \u2502 (Cache)  \u2502      \u2502 (Vector) \u2502          \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518          \u2502\n\u2502       \u2502                 \u2502                 \u2502                 \u2502\n\u2502       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                 \u2502\n\u2502                    \u2502                                        \u2502\n\u2502                    \u25bc                                        \u2502\n\u2502            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                 \u2502\n\u2502            \u2502  DBFunctor   \u2502                                 \u2502\n\u2502            \u2502  lift/unlift \u2502                                 \u2502\n\u2502            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                 \u2502\n\u2502                   \u2502                                         \u2502\n\u2502                   \u25bc                                         \u2502\n\u2502            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                 \u2502\n\u2502            \u2502 State[DB, A] \u2502                                 \u2502\n\u2502            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                 \u2502\n\u2502                                                             \u2502\n\u2502  Universal Property:                                        \u2502\n\u2502  For any X and f: Pg\u2192X, g: Redis\u2192X, h: Qdrant\u2192X            \u2502\n\u2502  \u2203! [f,g,h]: DB \u2192 X                                        \u2502\n\u2502                                                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/live-infrastructure/#deliverables-checklist","title":"Deliverables Checklist","text":""},{"location":"architecture/live-infrastructure/#phase-1-crds","title":"Phase 1: CRDs","text":"<ul> <li> PostgresCluster CRD</li> <li> RedisCluster CRD</li> <li> QdrantCluster CRD</li> <li> Apply to Kind cluster</li> </ul>"},{"location":"architecture/live-infrastructure/#phase-2-operators_1","title":"Phase 2: Operators","text":"<ul> <li> postgres_operator.py</li> <li> redis_operator.py</li> <li> qdrant_operator.py</li> <li> Integration tests</li> </ul>"},{"location":"architecture/live-infrastructure/#phase-3-metrics","title":"Phase 3: Metrics","text":"<ul> <li> DBPulse dataclasses</li> <li> DBMetricsCollector</li> <li> Terrarium <code>/api/db/metrics</code></li> </ul>"},{"location":"architecture/live-infrastructure/#phase-4-widgets","title":"Phase 4: Widgets","text":"<ul> <li> PostgresGauge</li> <li> RedisGauge</li> <li> QdrantGauge</li> <li> BicameralCoherencyBar</li> <li> DBMetricsPanel</li> </ul>"},{"location":"architecture/live-infrastructure/#phase-5-integration","title":"Phase 5: Integration","text":"<ul> <li> Kind cluster with DB pods</li> <li> Terrarium wired to collectors</li> <li> I-gent dashboard consuming metrics</li> </ul> <p>\"The stream finds a way around the boulder.\" \u2014 Graceful Degradation Principle</p>"},{"location":"architecture/statefulness-analysis/","title":"Statefulness Analysis: The Database Triad as Functor Stack","text":"<p>\"The noun is a lie. There is only the rate of change.\" \u2014 AGENTESE Axiom</p> <p>\"Everything is slop or comes from slop.\" \u2014 The Accursed Share</p> <p>\"It is untasteful to reimplement 10 years of operational knowledge in a 200-line Python script.\" \u2014 First Principles Critique</p> <p>Author: Claude (with Kent's taste preferences) Date: 2025-12-12 Status: Revised Specification (v2.0)</p>"},{"location":"architecture/statefulness-analysis/#executive-summary","title":"Executive Summary","text":"<p>The kgents D-gent statefulness implementation has strong categorical foundations (StateMonad, StateCrystal, Symbiont) but the infrastructure instantiation plan violates core principles. This revision corrects three fundamental errors:</p> Error Violation Correction Custom Python Operators Tasteful: Reimplementing DB ops from scratch Delegate to CloudNativePG, standard operators Dual-Write Consistency Composable: Split brain between Postgres/Qdrant CDC with Postgres as Source of Truth Vendor-Specific Metrics Categorical: Exposing implementation details Semantic metrics (Durability, Reflex, Resonance) <p>The corrected design models the Database Triad as a Functor Stack, not a coproduct:</p> <pre><code>DBStack = Durability \u2218 Reflex \u2218 Resonance\n        = Postgres \u2192 Redis \u2192 Qdrant (CDC linkage)\n</code></pre>"},{"location":"architecture/statefulness-analysis/#part-i-critical-analysis","title":"Part I: Critical Analysis","text":""},{"location":"architecture/statefulness-analysis/#1-what-exists-strengths","title":"1. What Exists (Strengths)","text":"Component Status Category Theory Alignment VolatileAgent Production-ready Identity morphism (ephemeral state) PersistentAgent Production-ready Endofunctor (file \u2192 state \u2192 file) Symbiont Production-ready Product type: Logic \u00d7 Memory StateMonadFunctor Production-ready State threading via lift/unlift StateCrystal Production-ready Comonad (extract/extend/duplicate) Pulse Production-ready Observable algebra UnifiedObserverFunctor Production-ready Pluggable observation sinks SQLAgent Code exists (mocked) Functor to SQL category RedisAgent Code exists (mocked) Functor to KV category BicameralMemory Requires runtime Coproduct: Left \u2295 Right hemispheres <p>Verdict: The categorical foundations are complete (see <code>categorical-consolidation.md</code>). The remaining gap is infrastructure instantiation.</p>"},{"location":"architecture/statefulness-analysis/#2-critical-gaps-in-original-plan","title":"2. Critical Gaps in Original Plan","text":""},{"location":"architecture/statefulness-analysis/#gap-1-the-operator-anti-pattern","title":"Gap 1: The Operator Anti-Pattern","text":"<p>Original Plan (from <code>live-infrastructure.md</code>): <pre><code># impl/claude/infra/k8s/operators/postgres_operator.py\n@kopf.on.create(\"kgents.io\", \"v1alpha1\", \"postgresclusters\")\nasync def create_postgres(...):\n    statefulset = to_statefulset(...)  # Hand-rolled\n</code></pre></p> <p>Why This Fails:</p> <ol> <li>Complexity Explosion: A production Postgres operator handles:</li> <li>Leader election and automatic failover</li> <li>Point-in-Time Recovery (PITR)</li> <li>TLS certificate rotation</li> <li>Minor version upgrades</li> <li>Backup scheduling with barman</li> <li>Connection pooling with PgBouncer</li> </ol> <p>The 200-line script handles none of these.</p> <ol> <li> <p>Tasteful Violation: \"Quality over quantity\" (Principle 2) means using CloudNativePG (10+ years of community refinement) rather than hand-rolling StatefulSets.</p> </li> <li> <p>Democratization Failure: The Generative Principle states \"AI agents collapse the expertise barrier.\" But a custom operator expands the barrier\u2014now Kent must become a Postgres operator expert to debug it.</p> </li> </ol> <p>Correction: The K8s Projector should emit CloudNativePG Cluster manifests, not StatefulSets.</p>"},{"location":"architecture/statefulness-analysis/#gap-2-the-bicameral-consistency-paradox","title":"Gap 2: The Bicameral Consistency Paradox","text":"<p>Original Design: <pre><code>Agent \u2192 Postgres (write row)\n     \u2192 Qdrant (write vector)  // Separate operation!\n</code></pre></p> <p>Why This Fails (The Dual-Write Problem):</p> Failure Mode Symptom Impact Crash after Postgres, before Qdrant \"Ghost Data\" (ID exists, vector missing) Semantic search finds nothing Crash after Qdrant, before Postgres \"Hallucination\" (vector points to non-existent ID) Recall returns null Network partition State diverges BicameralMemory becomes \"schizophrenic\" <p>Category Theory Analysis:</p> <p>The original design treats the Database Triad as a coproduct: <pre><code>DB = Postgres \u2295 Redis \u2295 Qdrant\n</code></pre></p> <p>But coproducts have independent injections\u2014each database receives data independently. This models the symptom (three databases), not the structure (one truth, multiple views).</p> <p>Correction: Model as a Functor Stack with CDC: <pre><code>Truth (Postgres) \u2192 Derived View (Qdrant)\n</code></pre></p> <p>This is a functorial relationship, not a coproduct.</p>"},{"location":"architecture/statefulness-analysis/#gap-3-leaky-abstraction-vendor-metrics","title":"Gap 3: Leaky Abstraction (Vendor Metrics)","text":"<p>Original Widgets: <pre><code>class PostgresGauge(Vertical):  # Exposes \"Postgres\"\nclass RedisGauge(Vertical):     # Exposes \"Redis\"\nclass QdrantGauge(Vertical):    # Exposes \"Qdrant\"\n</code></pre></p> <p>Why This Fails:</p> <p>If the observer is an agent engineer, they care about: - \"Can I persist state safely?\" (not \"Is Postgres pool saturated?\") - \"Can I recall similar memories?\" (not \"What's Qdrant's vector count?\") - \"Can I think quickly?\" (not \"What's Redis's eviction policy?\")</p> <p>Categorical Violation: The observer should view the State, not the machinery. Metrics should be semantic (reflecting purpose) not vendor (reflecting implementation).</p> <p>Correction: Define semantic metrics as natural transformations between vendor and purpose:</p> <pre><code>\u03b7: VendorMetrics \u27f9 SemanticMetrics\n\n\u03b7(PostgresMetrics) = DurabilitySignal   (\"Is the truth safe?\")\n\u03b7(RedisMetrics)    = ReflexSignal       (\"How fast can I think?\")\n\u03b7(QdrantMetrics)   = ResonanceSignal    (\"Can I remember similar things?\")\n</code></pre>"},{"location":"architecture/statefulness-analysis/#3-anti-patterns-detected-updated","title":"3. Anti-Patterns Detected (Updated)","text":"Anti-Pattern Instance Principle Violated Mocking as Production All DB tests mocked Generative Configuration Sprawl BicameralConfig has 11 knobs Tasteful NIH Syndrome Custom Postgres operator Curated Split Source of Truth Postgres + Qdrant as peers Composable Vendor Metrics PostgresGauge, RedisGauge AGENTESE (\"No view from nowhere\")"},{"location":"architecture/statefulness-analysis/#part-ii-the-corrected-architecture","title":"Part II: The Corrected Architecture","text":""},{"location":"architecture/statefulness-analysis/#1-the-functor-stack-model","title":"1. The Functor Stack Model","text":"<p>Core Insight: The Database Triad is not a coproduct (independent databases) but a Functor Stack (layered transformations on a single source of truth).</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              THE FUNCTOR STACK (Corrected Model)                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                  \u2502\n\u2502   Postgres (ANCHOR)                                              \u2502\n\u2502       \u2502                                                          \u2502\n\u2502       \u2502 CDC/Outbox                                               \u2502\n\u2502       \u25bc                                                          \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u2502\n\u2502   \u2502              SYNAPSE FLUX AGENT                    \u2502         \u2502\n\u2502   \u2502   (Tails WAL/Outbox, transforms, propagates)       \u2502         \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502\n\u2502       \u2502                           \u2502                              \u2502\n\u2502       \u2502 Embeddings                \u2502 Cache invalidation           \u2502\n\u2502       \u25bc                           \u25bc                              \u2502\n\u2502   Qdrant (ASSOCIATOR)         Redis (SPARK)                     \u2502\n\u2502                                                                  \u2502\n\u2502   Categorical Structure:                                         \u2502\n\u2502                                                                  \u2502\n\u2502   Postgres \u2500\u2500Synapse\u2500\u2500\u25b6 Qdrant                                  \u2502\n\u2502       \u2502                    \u2502                                     \u2502\n\u2502       \u2502    CDC Functor     \u2502                                     \u2502\n\u2502       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                     \u2502\n\u2502                                                                  \u2502\n\u2502   DurabilityFunctor: Postgres \u2192 State[Row]                      \u2502\n\u2502   ReflexFunctor: Redis \u2192 State[KV]                              \u2502\n\u2502   ResonanceFunctor: Qdrant \u2192 State[Vector]                      \u2502\n\u2502                                                                  \u2502\n\u2502   Stack: Durability \u2218 (Reflex \u00d7 Resonance)                      \u2502\n\u2502          where Reflex and Resonance are derived views           \u2502\n\u2502                                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Formal Definition:</p> <p>Let Anchor = Category of Postgres tables (objects) and SQL queries (morphisms). Let View = Category of derived state (Qdrant collections, Redis keys).</p> <p>The CDC Functor is: <pre><code>Synapse: Anchor \u2192 View\n</code></pre></p> <p>Such that for any query <code>f: A \u2192 B</code> in Anchor: <pre><code>Synapse(A) = derived view of A\nSynapse(f) = transformation that maintains derived view consistency\n</code></pre></p> <p>Key Property: Qdrant and Redis are functorial images of Postgres, not independent stores.</p>"},{"location":"architecture/statefulness-analysis/#2-the-operator-of-operators-managed-not-built","title":"2. The Operator-of-Operators (Managed, Not Built)","text":"<p>Instead of writing <code>postgres_operator.py</code>, we delegate to standard operators and have the K8s Projector configure them.</p>"},{"location":"architecture/statefulness-analysis/#the-stack","title":"The Stack","text":"Vendor Operator Why Postgres CloudNativePG (CNPG) Industry standard, handles HA/PITR/backups Redis Bitnami Helm Chart or Spotahome Battle-tested, handles failover Qdrant Official Qdrant Helm Chart Vendor-supported"},{"location":"architecture/statefulness-analysis/#the-revised-projector","title":"The Revised Projector","text":"<pre><code># impl/claude/system/projector/k8s_database.py\n\"\"\"\nK8s Database Projector: Emits manifests for standard operators.\n\nPrinciple: \"Managed, Not Built\"\n- We emit CloudNativePG Cluster CRs, not StatefulSets\n- The operator handles Day 2 operations\n- Our Projector is a thin configuration layer\n\"\"\"\n\nfrom __future__ import annotations\nfrom dataclasses import dataclass\nfrom typing import Any\n\n\n@dataclass\nclass DatabaseProjection:\n    \"\"\"Projection from spec to operator manifest.\"\"\"\n\n    postgres: dict[str, Any] | None = None\n    redis: dict[str, Any] | None = None\n    qdrant: dict[str, Any] | None = None\n\n\ndef to_cnpg_cluster(name: str, database: str, storage: str = \"1Gi\") -&gt; dict[str, Any]:\n    \"\"\"\n    Generate CloudNativePG Cluster manifest.\n\n    This is NOT a StatefulSet\u2014it's a high-level intent that CNPG\n    reconciles into StatefulSets, Services, Secrets, etc.\n    \"\"\"\n    return {\n        \"apiVersion\": \"postgresql.cnpg.io/v1\",\n        \"kind\": \"Cluster\",\n        \"metadata\": {\n            \"name\": name,\n            \"labels\": {\n                \"kgents.io/component\": \"database\",\n                \"kgents.io/role\": \"anchor\",\n            },\n        },\n        \"spec\": {\n            \"instances\": 1,  # Start minimal, scale declaratively\n            \"storage\": {\n                \"size\": storage,\n            },\n            \"postgresql\": {\n                \"shared_preload_libraries\": [\"pg_stat_statements\"],\n            },\n            # CNPG handles:\n            # - Automatic failover\n            # - TLS rotation\n            # - Backup scheduling (when configured)\n            # - Metrics export\n            \"monitoring\": {\n                \"enablePodMonitor\": True,\n            },\n        },\n    }\n\n\ndef to_redis_release(name: str, memory: str = \"128Mi\") -&gt; dict[str, Any]:\n    \"\"\"\n    Generate Helm Release for Redis (Bitnami).\n\n    Using HelmRelease (FluxCD) or direct Helm values.\n    \"\"\"\n    return {\n        \"apiVersion\": \"helm.toolkit.fluxcd.io/v2beta1\",\n        \"kind\": \"HelmRelease\",\n        \"metadata\": {\n            \"name\": f\"{name}-redis\",\n            \"labels\": {\n                \"kgents.io/component\": \"cache\",\n                \"kgents.io/role\": \"spark\",\n            },\n        },\n        \"spec\": {\n            \"interval\": \"10m\",\n            \"chart\": {\n                \"spec\": {\n                    \"chart\": \"redis\",\n                    \"version\": \"18.x\",\n                    \"sourceRef\": {\n                        \"kind\": \"HelmRepository\",\n                        \"name\": \"bitnami\",\n                    },\n                },\n            },\n            \"values\": {\n                \"architecture\": \"standalone\",\n                \"master\": {\n                    \"resources\": {\n                        \"limits\": {\"memory\": memory},\n                    },\n                },\n                \"metrics\": {\n                    \"enabled\": True,\n                },\n            },\n        },\n    }\n\n\ndef to_qdrant_release(name: str, storage: str = \"1Gi\") -&gt; dict[str, Any]:\n    \"\"\"\n    Generate Helm Release for Qdrant.\n    \"\"\"\n    return {\n        \"apiVersion\": \"helm.toolkit.fluxcd.io/v2beta1\",\n        \"kind\": \"HelmRelease\",\n        \"metadata\": {\n            \"name\": f\"{name}-qdrant\",\n            \"labels\": {\n                \"kgents.io/component\": \"vector\",\n                \"kgents.io/role\": \"associator\",\n            },\n        },\n        \"spec\": {\n            \"interval\": \"10m\",\n            \"chart\": {\n                \"spec\": {\n                    \"chart\": \"qdrant\",\n                    \"version\": \"0.9.x\",\n                    \"sourceRef\": {\n                        \"kind\": \"HelmRepository\",\n                        \"name\": \"qdrant\",\n                    },\n                },\n            },\n            \"values\": {\n                \"persistence\": {\n                    \"size\": storage,\n                },\n                \"metrics\": {\n                    \"serviceMonitor\": {\n                        \"enabled\": True,\n                    },\n                },\n            },\n        },\n    }\n\n\ndef project_database_triad(\n    name: str,\n    database: str = \"kgents\",\n    pg_storage: str = \"1Gi\",\n    redis_memory: str = \"128Mi\",\n    qdrant_storage: str = \"1Gi\",\n) -&gt; DatabaseProjection:\n    \"\"\"\n    Project the complete Database Triad.\n\n    Returns manifests for:\n    - CloudNativePG Cluster (Anchor)\n    - Redis HelmRelease (Spark)\n    - Qdrant HelmRelease (Associator)\n    \"\"\"\n    return DatabaseProjection(\n        postgres=to_cnpg_cluster(name, database, pg_storage),\n        redis=to_redis_release(name, redis_memory),\n        qdrant=to_qdrant_release(name, qdrant_storage),\n    )\n</code></pre> <p>Benefits: - Free HA: CNPG handles leader election, failover - Free Backups: Barman integration when configured - Free Metrics: Prometheus exporters included - Free Upgrades: Operators handle rolling updates</p>"},{"location":"architecture/statefulness-analysis/#3-the-synapse-cdc-link","title":"3. The Synapse (CDC Link)","text":"<p>The Synapse is a specialized Flux agent that maintains consistency between the Anchor (Postgres) and derived views (Qdrant).</p> <p>Categorical Definition:</p> <pre><code>Synapse: Flux[ChangeEvent, SyncResult]\n\nwhere:\n  ChangeEvent = ROW_INSERTED | ROW_UPDATED | ROW_DELETED\n  SyncResult  = VectorUpserted | VectorDeleted | CacheInvalidated\n</code></pre> <p>Implementation Pattern:</p> <pre><code># impl/claude/agents/flux/synapse.py\n\"\"\"\nSynapse: CDC Flux agent that maintains derived views.\n\nCategorical Role: Functor from Anchor changes to View updates.\n\"\"\"\n\nfrom __future__ import annotations\nfrom dataclasses import dataclass\nfrom typing import AsyncIterator\nfrom agents.flux.agent import FluxAgent\nfrom agents.d.volatile import VolatileAgent\n\n\n@dataclass\nclass ChangeEvent:\n    \"\"\"A change in the Anchor (Postgres).\"\"\"\n    table: str\n    operation: str  # INSERT, UPDATE, DELETE\n    row_id: str\n    data: dict\n\n\n@dataclass\nclass SyncResult:\n    \"\"\"Result of syncing to derived view.\"\"\"\n    target: str  # \"qdrant\" or \"redis\"\n    operation: str\n    success: bool\n    lag_ms: float\n\n\nclass Synapse(FluxAgent[ChangeEvent, SyncResult]):\n    \"\"\"\n    CDC Flux agent maintaining Postgres \u2192 Qdrant consistency.\n\n    Workflow:\n    1. Tail Postgres WAL or Outbox table\n    2. For each change, compute derived state\n    3. Push to Qdrant (vectors) and/or Redis (cache invalidation)\n    4. Acknowledge sync completion\n\n    Guarantee: If Postgres has row R, eventually Qdrant has vector(R).\n    \"\"\"\n\n    async def process_stream(\n        self,\n        events: AsyncIterator[ChangeEvent]\n    ) -&gt; AsyncIterator[SyncResult]:\n        async for event in events:\n            # 1. Extract embedding from content\n            if event.operation in (\"INSERT\", \"UPDATE\"):\n                embedding = await self._compute_embedding(event.data)\n\n                # 2. Upsert to Qdrant\n                await self.qdrant.upsert(\n                    collection=\"memories\",\n                    points=[{\n                        \"id\": event.row_id,\n                        \"vector\": embedding,\n                        \"payload\": {\"source\": \"postgres\", \"table\": event.table},\n                    }],\n                )\n\n                # 3. Mark sync complete in Postgres\n                await self.postgres.execute(\n                    \"UPDATE memories SET vector_synced_at = NOW() WHERE id = $1\",\n                    event.row_id,\n                )\n\n            elif event.operation == \"DELETE\":\n                await self.qdrant.delete(collection=\"memories\", ids=[event.row_id])\n\n            yield SyncResult(\n                target=\"qdrant\",\n                operation=event.operation,\n                success=True,\n                lag_ms=self._measure_lag(),\n            )\n\n    async def _compute_embedding(self, data: dict) -&gt; list[float]:\n        \"\"\"Compute embedding for content.\"\"\"\n        # Delegate to embedding provider (OpenAI, local model, etc.)\n        ...\n</code></pre> <p>Key Property: Postgres is the sole source of writes. Qdrant is mathematically derivative. If Qdrant is wiped, it can be fully regenerated from Postgres.</p> <p>Outbox Pattern (Alternative to WAL tailing):</p> <pre><code>-- Table: outbox\nCREATE TABLE outbox (\n    id SERIAL PRIMARY KEY,\n    event_type TEXT NOT NULL,\n    payload JSONB NOT NULL,\n    processed BOOLEAN DEFAULT FALSE,\n    created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Trigger: populate outbox on memory changes\nCREATE OR REPLACE FUNCTION memory_change_trigger() RETURNS TRIGGER AS $$\nBEGIN\n    INSERT INTO outbox (event_type, payload)\n    VALUES (\n        TG_OP,\n        jsonb_build_object('table', TG_TABLE_NAME, 'row', row_to_json(NEW))\n    );\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER memory_outbox_trigger\n    AFTER INSERT OR UPDATE OR DELETE ON memories\n    FOR EACH ROW EXECUTE FUNCTION memory_change_trigger();\n</code></pre> <p>The Synapse polls the outbox table, processes events, and marks them as processed. This avoids WAL tailing complexity while preserving consistency guarantees.</p>"},{"location":"architecture/statefulness-analysis/#4-semantic-metrics-the-observers-view","title":"4. Semantic Metrics (The Observer's View)","text":"<p>Principle: Metrics should reflect teleological purpose, not vendor implementation.</p>"},{"location":"architecture/statefulness-analysis/#the-natural-transformation","title":"The Natural Transformation","text":"<pre><code>\u03b7: VendorPulse \u27f9 SemanticPulse\n\nVendorPulse:                    SemanticPulse:\n\u251c\u2500 PostgresPulse                \u251c\u2500 DurabilitySignal\n\u251c\u2500 RedisPulse           \u03b7       \u251c\u2500 ReflexSignal\n\u2514\u2500 QdrantPulse         \u2500\u2500\u2500\u25b6     \u2514\u2500 ResonanceSignal\n</code></pre>"},{"location":"architecture/statefulness-analysis/#implementation","title":"Implementation","text":"<pre><code># impl/claude/protocols/terrarium/semantic_metrics.py\n\"\"\"\nSemantic Metrics: Purpose-oriented DB health signals.\n\nThese are natural transformations from vendor metrics to semantic signals.\nThe observer sees \"Is the truth safe?\" not \"Postgres pool utilization.\"\n\"\"\"\n\nfrom __future__ import annotations\nfrom dataclasses import dataclass\nfrom enum import Enum\nfrom datetime import datetime, timezone\n\n\nclass HealthLevel(Enum):\n    \"\"\"Semantic health levels.\"\"\"\n    THRIVING = \"thriving\"      # Everything excellent\n    HEALTHY = \"healthy\"        # Normal operation\n    STRAINED = \"strained\"      # Approaching limits\n    DEGRADED = \"degraded\"      # Reduced capability\n    CRITICAL = \"critical\"      # Intervention needed\n\n\n@dataclass(frozen=True)\nclass DurabilitySignal:\n    \"\"\"\n    Is the truth safe?\n\n    Derived from PostgreSQL metrics. The observer asks:\n    \"Can I persist state with confidence?\"\n    \"\"\"\n    timestamp: str\n    health: HealthLevel\n\n    # Semantic metrics (not \"pool_active\" but \"persistence_confidence\")\n    persistence_confidence: float  # 0-1, derived from WAL lag, replication\n    truth_integrity: float         # 0-1, derived from checksum, corruption checks\n    write_capacity: float          # 0-1, derived from pool utilization inverse\n\n    @classmethod\n    def from_postgres_pulse(cls, pulse: \"PostgresPulse\") -&gt; \"DurabilitySignal\":\n        \"\"\"Natural transformation: PostgresPulse \u2192 DurabilitySignal.\"\"\"\n        # Compute semantic metrics from vendor metrics\n        pool_available = 1 - (pulse.pool_active / pulse.pool_max) if pulse.pool_max &gt; 0 else 0\n\n        # Health level based on semantic interpretation\n        if pool_available &gt; 0.5 and pulse.avg_latency_ms &lt; 20:\n            health = HealthLevel.THRIVING\n        elif pool_available &gt; 0.2 and pulse.avg_latency_ms &lt; 100:\n            health = HealthLevel.HEALTHY\n        elif pool_available &gt; 0.1:\n            health = HealthLevel.STRAINED\n        elif pulse.pool_waiting &gt; 0:\n            health = HealthLevel.DEGRADED\n        else:\n            health = HealthLevel.CRITICAL\n\n        return cls(\n            timestamp=datetime.now(timezone.utc).isoformat(),\n            health=health,\n            persistence_confidence=pool_available,\n            truth_integrity=1.0,  # Would check WAL/replication status\n            write_capacity=pool_available,\n        )\n\n\n@dataclass(frozen=True)\nclass ReflexSignal:\n    \"\"\"\n    How fast can I think?\n\n    Derived from Redis metrics. The observer asks:\n    \"Can I access cached state quickly?\"\n    \"\"\"\n    timestamp: str\n    health: HealthLevel\n\n    # Semantic metrics\n    thought_speed: float      # 0-1, derived from ops latency\n    memory_pressure: float    # 0-1, derived from eviction rate\n    recall_reliability: float # 0-1, derived from hit rate\n\n    @classmethod\n    def from_redis_pulse(cls, pulse: \"RedisPulse\") -&gt; \"ReflexSignal\":\n        \"\"\"Natural transformation: RedisPulse \u2192 ReflexSignal.\"\"\"\n        memory_free = 1 - (pulse.memory_used_mb / pulse.memory_max_mb) if pulse.memory_max_mb &gt; 0 else 0\n\n        if pulse.hit_rate &gt; 0.9 and memory_free &gt; 0.3:\n            health = HealthLevel.THRIVING\n        elif pulse.hit_rate &gt; 0.7 and memory_free &gt; 0.1:\n            health = HealthLevel.HEALTHY\n        elif pulse.hit_rate &gt; 0.5:\n            health = HealthLevel.STRAINED\n        else:\n            health = HealthLevel.DEGRADED\n\n        return cls(\n            timestamp=datetime.now(timezone.utc).isoformat(),\n            health=health,\n            thought_speed=1.0 if pulse.commands_per_second &gt; 0 else 0.5,\n            memory_pressure=1 - memory_free,\n            recall_reliability=pulse.hit_rate,\n        )\n\n\n@dataclass(frozen=True)\nclass ResonanceSignal:\n    \"\"\"\n    Can I remember similar things?\n\n    Derived from Qdrant metrics. The observer asks:\n    \"Can semantic search find relevant memories?\"\n    \"\"\"\n    timestamp: str\n    health: HealthLevel\n\n    # Semantic metrics\n    associative_capacity: float  # 0-1, derived from vector count vs limit\n    search_responsiveness: float # 0-1, derived from search latency\n    coherency_with_truth: float  # 0-1, derived from CDC lag\n\n    @classmethod\n    def from_qdrant_pulse(cls, pulse: \"QdrantPulse\", cdc_lag_ms: float = 0) -&gt; \"ResonanceSignal\":\n        \"\"\"Natural transformation: QdrantPulse \u2192 ResonanceSignal.\"\"\"\n        # Coherency degrades as CDC lag increases\n        coherency = max(0, 1 - (cdc_lag_ms / 5000))  # 5s lag = 0 coherency\n\n        if pulse.avg_search_latency_ms &lt; 50 and coherency &gt; 0.9:\n            health = HealthLevel.THRIVING\n        elif pulse.avg_search_latency_ms &lt; 200 and coherency &gt; 0.7:\n            health = HealthLevel.HEALTHY\n        elif coherency &gt; 0.5:\n            health = HealthLevel.STRAINED\n        else:\n            health = HealthLevel.DEGRADED\n\n        return cls(\n            timestamp=datetime.now(timezone.utc).isoformat(),\n            health=health,\n            associative_capacity=1.0,  # Would check collection capacity\n            search_responsiveness=max(0, 1 - pulse.avg_search_latency_ms / 500),\n            coherency_with_truth=coherency,\n        )\n\n\n@dataclass(frozen=True)\nclass TriadHealth:\n    \"\"\"\n    Aggregate health of the Database Triad.\n\n    The observer sees one signal: \"Is my state infrastructure working?\"\n    \"\"\"\n    durability: DurabilitySignal\n    reflex: ReflexSignal\n    resonance: ResonanceSignal\n\n    @property\n    def overall_health(self) -&gt; HealthLevel:\n        \"\"\"Aggregate health (worst-of).\"\"\"\n        levels = [self.durability.health, self.reflex.health, self.resonance.health]\n        priority = [HealthLevel.CRITICAL, HealthLevel.DEGRADED, HealthLevel.STRAINED,\n                    HealthLevel.HEALTHY, HealthLevel.THRIVING]\n        for level in priority:\n            if level in levels:\n                return level\n        return HealthLevel.HEALTHY\n</code></pre>"},{"location":"architecture/statefulness-analysis/#5-revised-widget-implementation","title":"5. Revised Widget Implementation","text":"<pre><code># impl/claude/agents/i/widgets/semantic_panel.py\n\"\"\"\nSemantic Dashboard: Purpose-oriented state visibility.\n\nThe observer sees:\n- \"Is the truth safe?\" (not \"Postgres pool\")\n- \"How fast can I think?\" (not \"Redis memory\")\n- \"Can I remember similar things?\" (not \"Qdrant vectors\")\n\"\"\"\n\nfrom textual.app import ComposeResult\nfrom textual.containers import Horizontal, Vertical\nfrom textual.widgets import Static, Label, ProgressBar\nfrom textual.reactive import reactive\n\nfrom protocols.terrarium.semantic_metrics import (\n    DurabilitySignal, ReflexSignal, ResonanceSignal, TriadHealth, HealthLevel\n)\n\n\nclass SemanticGauge(Vertical):\n    \"\"\"Base gauge for semantic signals.\"\"\"\n\n    DEFAULT_CSS = \"\"\"\n    SemanticGauge {\n        height: auto;\n        padding: 1;\n        border: solid $primary;\n    }\n\n    SemanticGauge .header {\n        text-style: bold;\n    }\n\n    SemanticGauge .metric {\n        margin-left: 2;\n    }\n    \"\"\"\n\n    health: HealthLevel = reactive(HealthLevel.HEALTHY)\n\n    def _health_color(self, level: HealthLevel) -&gt; str:\n        return {\n            HealthLevel.THRIVING: \"green\",\n            HealthLevel.HEALTHY: \"blue\",\n            HealthLevel.STRAINED: \"yellow\",\n            HealthLevel.DEGRADED: \"orange\",\n            HealthLevel.CRITICAL: \"red\",\n        }.get(level, \"white\")\n\n\nclass DurabilityGauge(SemanticGauge):\n    \"\"\"Is the truth safe?\"\"\"\n\n    signal: DurabilitySignal | None = reactive(None)\n\n    def compose(self) -&gt; ComposeResult:\n        yield Label(\"IS THE TRUTH SAFE?\", classes=\"header\")\n        yield Horizontal(\n            Label(\"Persistence:\", classes=\"label\"),\n            ProgressBar(total=100, show_eta=False, id=\"persistence-bar\"),\n            Label(\"100%\", id=\"persistence-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Write Capacity:\", classes=\"label\"),\n            ProgressBar(total=100, show_eta=False, id=\"write-bar\"),\n            Label(\"100%\", id=\"write-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Status:\", classes=\"label\"),\n            Label(\"HEALTHY\", id=\"status-text\"),\n            classes=\"metric\",\n        )\n\n    def watch_signal(self, signal: DurabilitySignal | None) -&gt; None:\n        if not signal:\n            return\n\n        # Update persistence confidence\n        bar = self.query_one(\"#persistence-bar\", ProgressBar)\n        bar.update(progress=signal.persistence_confidence * 100)\n        self.query_one(\"#persistence-text\", Label).update(\n            f\"{signal.persistence_confidence:.0%}\"\n        )\n\n        # Update write capacity\n        write_bar = self.query_one(\"#write-bar\", ProgressBar)\n        write_bar.update(progress=signal.write_capacity * 100)\n        self.query_one(\"#write-text\", Label).update(\n            f\"{signal.write_capacity:.0%}\"\n        )\n\n        # Update status\n        status = self.query_one(\"#status-text\", Label)\n        status.update(signal.health.value.upper())\n        status.styles.color = self._health_color(signal.health)\n\n\nclass ReflexGauge(SemanticGauge):\n    \"\"\"How fast can I think?\"\"\"\n\n    signal: ReflexSignal | None = reactive(None)\n\n    def compose(self) -&gt; ComposeResult:\n        yield Label(\"HOW FAST CAN I THINK?\", classes=\"header\")\n        yield Horizontal(\n            Label(\"Thought Speed:\", classes=\"label\"),\n            ProgressBar(total=100, show_eta=False, id=\"speed-bar\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Recall Reliability:\", classes=\"label\"),\n            Label(\"0%\", id=\"recall-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Status:\", classes=\"label\"),\n            Label(\"HEALTHY\", id=\"status-text\"),\n            classes=\"metric\",\n        )\n\n    def watch_signal(self, signal: ReflexSignal | None) -&gt; None:\n        if not signal:\n            return\n\n        bar = self.query_one(\"#speed-bar\", ProgressBar)\n        bar.update(progress=signal.thought_speed * 100)\n\n        self.query_one(\"#recall-text\", Label).update(\n            f\"{signal.recall_reliability:.0%}\"\n        )\n\n        status = self.query_one(\"#status-text\", Label)\n        status.update(signal.health.value.upper())\n        status.styles.color = self._health_color(signal.health)\n\n\nclass ResonanceGauge(SemanticGauge):\n    \"\"\"Can I remember similar things?\"\"\"\n\n    signal: ResonanceSignal | None = reactive(None)\n\n    def compose(self) -&gt; ComposeResult:\n        yield Label(\"CAN I REMEMBER SIMILAR THINGS?\", classes=\"header\")\n        yield Horizontal(\n            Label(\"Search Responsiveness:\", classes=\"label\"),\n            ProgressBar(total=100, show_eta=False, id=\"search-bar\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Coherency with Truth:\", classes=\"label\"),\n            ProgressBar(total=100, show_eta=False, id=\"coherency-bar\"),\n            Label(\"100%\", id=\"coherency-text\"),\n            classes=\"metric\",\n        )\n        yield Horizontal(\n            Label(\"Status:\", classes=\"label\"),\n            Label(\"HEALTHY\", id=\"status-text\"),\n            classes=\"metric\",\n        )\n\n    def watch_signal(self, signal: ResonanceSignal | None) -&gt; None:\n        if not signal:\n            return\n\n        search_bar = self.query_one(\"#search-bar\", ProgressBar)\n        search_bar.update(progress=signal.search_responsiveness * 100)\n\n        coherency_bar = self.query_one(\"#coherency-bar\", ProgressBar)\n        coherency_bar.update(progress=signal.coherency_with_truth * 100)\n        self.query_one(\"#coherency-text\", Label).update(\n            f\"{signal.coherency_with_truth:.0%}\"\n        )\n\n        status = self.query_one(\"#status-text\", Label)\n        status.update(signal.health.value.upper())\n        status.styles.color = self._health_color(signal.health)\n\n\nclass SemanticTriadPanel(Vertical):\n    \"\"\"Complete semantic dashboard for state infrastructure.\"\"\"\n\n    DEFAULT_CSS = \"\"\"\n    SemanticTriadPanel {\n        height: auto;\n        padding: 1;\n    }\n\n    SemanticTriadPanel &gt; Horizontal {\n        height: auto;\n    }\n\n    SemanticTriadPanel #overall-status {\n        text-style: bold;\n        text-align: center;\n        padding: 1;\n    }\n    \"\"\"\n\n    health: TriadHealth | None = reactive(None)\n\n    def compose(self) -&gt; ComposeResult:\n        yield Label(\"STATE INFRASTRUCTURE HEALTH\", id=\"overall-status\")\n        yield Horizontal(\n            DurabilityGauge(id=\"durability\"),\n            ReflexGauge(id=\"reflex\"),\n            ResonanceGauge(id=\"resonance\"),\n        )\n\n    def watch_health(self, health: TriadHealth | None) -&gt; None:\n        if not health:\n            return\n\n        self.query_one(\"#durability\", DurabilityGauge).signal = health.durability\n        self.query_one(\"#reflex\", ReflexGauge).signal = health.reflex\n        self.query_one(\"#resonance\", ResonanceGauge).signal = health.resonance\n\n        # Update overall status\n        overall = self.query_one(\"#overall-status\", Label)\n        color = {\n            HealthLevel.THRIVING: \"green\",\n            HealthLevel.HEALTHY: \"blue\",\n            HealthLevel.STRAINED: \"yellow\",\n            HealthLevel.DEGRADED: \"orange\",\n            HealthLevel.CRITICAL: \"red\",\n        }.get(health.overall_health, \"white\")\n        overall.styles.color = color\n</code></pre>"},{"location":"architecture/statefulness-analysis/#part-iii-categorical-formalization","title":"Part III: Categorical Formalization","text":""},{"location":"architecture/statefulness-analysis/#1-the-database-category-revised","title":"1. The Database Category (Revised)","text":"<p>Objects: Tables in Postgres (the Anchor) Morphisms: SQL queries (transformations of rows)</p> <pre><code>Ob(Anchor) = { Table_memories, Table_sessions, Table_outbox, ... }\nHom(A, B) = { f: A \u2192 B | f is a valid SQL query }\n</code></pre>"},{"location":"architecture/statefulness-analysis/#2-the-cdc-functor","title":"2. The CDC Functor","text":"<pre><code>Synapse: Anchor \u2192 View\n</code></pre> <p>Functor Laws: 1. Identity: <code>Synapse(id_A) = id_{Synapse(A)}</code>    - If no change to table A, no change to derived view 2. Composition: <code>Synapse(g \u2218 f) = Synapse(g) \u2218 Synapse(f)</code>    - Sequential changes compose in the derived view</p>"},{"location":"architecture/statefulness-analysis/#3-the-semantic-transformation","title":"3. The Semantic Transformation","text":"<pre><code>\u03b7: VendorMetrics \u27f9 SemanticMetrics\n</code></pre> <p>Naturality Square: <pre><code>                    collect_postgres\nPostgresCluster \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6 PostgresPulse\n       \u2502                                      \u2502\n       \u2502 vendor_upgrade                       \u2502 \u03b7_Postgres\n       \u25bc                                      \u25bc\nPostgresCluster' \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6 DurabilitySignal'\n                    \u03b7(collect_postgres)\n</code></pre></p> <p>For any upgrade to the vendor (e.g., Postgres 15 \u2192 16), the semantic interpretation must commute: upgrading then measuring = measuring then transforming.</p>"},{"location":"architecture/statefulness-analysis/#4-the-state-monad-from-categorical-consolidation","title":"4. The State Monad (From Categorical Consolidation)","text":"<p>The StateMonadFunctor (already implemented) threads state through computation:</p> <pre><code>StateMonadFunctor.lift(agent, memory=postgres_client)\n</code></pre> <p>This lifts any agent into stateful computation backed by Postgres.</p>"},{"location":"architecture/statefulness-analysis/#5-the-bicameral-coproduct-revised","title":"5. The Bicameral Coproduct (Revised)","text":"<p>Original Model (incorrect): <pre><code>Bicameral = Postgres \u2295 Qdrant  // Independent injections\n</code></pre></p> <p>Revised Model: <pre><code>Bicameral = Postgres \u00d7_{Synapse} Qdrant  // Fiber product over Synapse\n</code></pre></p> <p>The fiber product ensures that for any memory <code>m</code>: - <code>m</code> in Postgres \u27f9 eventually <code>vector(m)</code> in Qdrant - The Synapse functor maintains the correspondence</p>"},{"location":"architecture/statefulness-analysis/#part-iv-implementation-roadmap-revised","title":"Part IV: Implementation Roadmap (Revised)","text":""},{"location":"architecture/statefulness-analysis/#phase-1-operator-bootstrap-infrastructure-delegation","title":"Phase 1: Operator Bootstrap (Infrastructure Delegation)","text":"<p>Goal: Install standard operators, not write custom ones.</p> <p>Actions: <pre><code># scripts/bootstrap_operators.sh\n\n# 1. Install CloudNativePG\nkubectl apply -f https://raw.githubusercontent.com/cloudnative-pg/cloudnative-pg/release-1.22/releases/cnpg-1.22.yaml\n\n# 2. Add Bitnami Helm repo\nhelm repo add bitnami https://charts.bitnami.com/bitnami\n\n# 3. Add Qdrant Helm repo\nhelm repo add qdrant https://qdrant.github.io/qdrant-helm\n\n# 4. Install FluxCD for HelmRelease management (optional)\nflux install\n</code></pre></p> <p>Deliverables: - [x] Bootstrap script for operator installation - [ ] CloudNativePG Cluster CR for kgents - [ ] Redis HelmRelease for kgents - [ ] Qdrant HelmRelease for kgents</p>"},{"location":"architecture/statefulness-analysis/#phase-2-projector-revision","title":"Phase 2: Projector Revision","text":"<p>Goal: K8s Projector emits operator CRs, not StatefulSets.</p> <p>Actions: 1. Create <code>impl/claude/system/projector/k8s_database.py</code> (code above) 2. Remove custom <code>postgres_operator.py</code>, <code>redis_operator.py</code> 3. Update Projector tests to verify CR generation</p> <p>Deliverables: - [ ] <code>to_cnpg_cluster()</code> function - [ ] <code>to_redis_release()</code> function - [ ] <code>to_qdrant_release()</code> function - [ ] Projector integration tests</p>"},{"location":"architecture/statefulness-analysis/#phase-3-synapse-implementation","title":"Phase 3: Synapse Implementation","text":"<p>Goal: CDC Flux agent maintains Postgres \u2192 Qdrant consistency.</p> <p>Actions: 1. Implement Outbox table and trigger in migrations 2. Create <code>impl/claude/agents/flux/synapse.py</code> 3. Wire Synapse into D-gent initialization 4. Add coherency metrics to Terrarium</p> <p>Deliverables: - [ ] Outbox migration SQL - [ ] Synapse FluxAgent class - [ ] CDC lag metric in TriadHealth - [ ] Integration tests with real DB</p>"},{"location":"architecture/statefulness-analysis/#phase-4-semantic-metrics","title":"Phase 4: Semantic Metrics","text":"<p>Goal: Replace vendor metrics with semantic signals.</p> <p>Actions: 1. Create <code>impl/claude/protocols/terrarium/semantic_metrics.py</code> (code above) 2. Create <code>impl/claude/agents/i/widgets/semantic_panel.py</code> (code above) 3. Update Terrarium gateway to serve semantic metrics 4. Deprecate vendor-specific widgets</p> <p>Deliverables: - [ ] DurabilitySignal, ReflexSignal, ResonanceSignal dataclasses - [ ] Natural transformation functions (from_*_pulse) - [ ] SemanticTriadPanel widget - [ ] <code>/api/state/health</code> endpoint</p>"},{"location":"architecture/statefulness-analysis/#phase-5-integration-testing","title":"Phase 5: Integration &amp; Testing","text":"<p>Goal: End-to-end verification with real infrastructure.</p> <p>Actions: 1. Create integration test suite with Kind + operators 2. Verify CDC lag under load 3. Test failover scenarios (operator-managed) 4. Verify semantic metrics during degradation</p> <p>Deliverables: - [ ] <code>@pytest.mark.integration</code> test suite - [ ] CDC coherency tests - [ ] Failover verification - [ ] Semantic metric accuracy tests</p>"},{"location":"architecture/statefulness-analysis/#part-v-comparison-table","title":"Part V: Comparison Table","text":"Feature Original Plan (v1) Revised Plan (v2) Orchestration Custom Python Operators CloudNativePG + Helm Charts Consistency \"Check on Read\" (Race Conditions) CDC / Outbox Pattern (Eventual Consistency) Source of Truth Split (Postgres + Qdrant) Unified (Postgres; Qdrant is a View) Observability Vendor Metrics (Pool Size) Semantic Metrics (Coherency Lag) Maintenance Ignored (No Backups) Automated (Via Standard Operators) Categorical Model Coproduct (DB = Pg \u2295 Redis \u2295 Qdrant) Functor Stack (Synapse: Anchor \u2192 View) Day 2 Ops Manual intervention Operator-managed (HA, PITR, TLS) Expertise Required DBA + K8s + Python Spec authoring only"},{"location":"architecture/statefulness-analysis/#part-vi-risk-assessment-revised","title":"Part VI: Risk Assessment (Revised)","text":"Risk Likelihood Impact Mitigation Operator learning curve Medium Low Operators have excellent docs CDC lag under high load Medium Medium Tune batch size, add backpressure Helm version conflicts Low Medium Pin versions in HelmRelease Semantic metric inaccuracy Low Medium Validate against vendor metrics Kind resource limits Medium Low Increase Kind node resources"},{"location":"architecture/statefulness-analysis/#conclusion","title":"Conclusion","text":"<p>The revised architecture honors kgents principles:</p> Principle How This Revision Honors It Tasteful Delegate to experts (operators), don't reimplement Curated Three semantic signals, not eleven vendor metrics Composable CDC functor composes with StateMonad Heterarchical No \"boss\" database; Postgres is truth, not controller Generative Projector generates operator CRs from spec AGENTESE Semantic metrics respect observer's view <p>The Accursed Share is acknowledged: this revision is itself slop until implemented. But it is better-composted slop\u2014the categorical foundations are sound, the infrastructure is delegated, and the observer sees purpose, not machinery.</p> <p>\"Plans are worthless, but planning is everything.\" \u2014 Eisenhower</p> <p>\"Buy before build. The community's ten years of refinement is free.\" \u2014 First Principles</p> <p>Sources: - CloudNativePG \u2014 Production-grade Postgres operator - Debezium \u2014 CDC platform (inspiration for Synapse) - Transactional Outbox Pattern - Natural Transformations in Software</p>"},{"location":"gallery/","title":"Gallery","text":"<p>Welcome to the kgents Gallery - a curated collection of interactive examples showcasing the power and elegance of agent-oriented programming.</p>"},{"location":"gallery/#philosophy","title":"Philosophy","text":"<p>\"An agent is a morphism A \u2192 B. Everything else is added via Halo.\"</p> <p>The Gallery demonstrates kgents' core principles:</p> <ul> <li>Composability: Agents are morphisms that compose predictably</li> <li>Functors: Lift agents to new contexts (Maybe, Flux, etc.)</li> <li>Personality: Soul governance ensures aligned responses</li> <li>Tasteful design: Quality over quantity, always</li> </ul>"},{"location":"gallery/#featured-examples","title":"Featured Examples","text":"<ul> <li> <p> Hello World</p> <p>Your first agent - learn the fundamental Agent[A, B] pattern</p> <p> Get started</p> </li> <li> <p> Composition</p> <p>Chain agents with the &gt;&gt; operator - category theory in action</p> <p> Learn composition</p> </li> <li> <p> Functors</p> <p>Lift agents to handle optional values with the Maybe functor</p> <p> Explore functors</p> </li> <li> <p> Soul Dialogue</p> <p>Chat with K-gent, Kent's digital simulacra</p> <p> Meet K-gent</p> </li> <li> <p> Streaming</p> <p>Transform discrete agents into continuous processors with Flux</p> <p> Flow like water</p> </li> <li> <p> Custom Archetype</p> <p>Build production-ready agents with Kappa (full-stack archetype)</p> <p> Build it</p> </li> </ul>"},{"location":"gallery/#quick-start","title":"Quick Start","text":"<p>All examples are interactive and runnable. Each page includes:</p> <ol> <li>Concept: The core idea explained clearly</li> <li>Code: Working examples you can run</li> <li>Exercises: Hands-on challenges to deepen understanding</li> </ol> <p>To run any example:</p> <pre><code># Clone the repo\ngit clone https://github.com/kentgang/kgents.git\ncd kgents\n\n# Install dependencies\npip install -e .\n\n# Run an example\npython -m impl.claude.agents.examples.hello_world\n</code></pre>"},{"location":"gallery/#learning-path","title":"Learning Path","text":"<p>New to kgents? Follow this sequence:</p> <ol> <li>Hello World - Understand the Agent[A, B] pattern</li> <li>Composition - Learn to chain agents with &gt;&gt;</li> <li>Functors - Handle edge cases elegantly</li> <li>Soul Dialogue - Add personality to your agents</li> <li>Streaming - Process continuous flows</li> <li>Custom Archetype - Build production systems</li> </ol>"},{"location":"gallery/#interactive-playground","title":"Interactive Playground","text":"<p>For hands-on experimentation, try the CLI playground:</p> <pre><code># Interactive tutorials\nkgents play hello        # Start with hello world\nkgents play compose      # Learn composition\nkgents play functor      # Explore functors\nkgents play soul         # Meet K-gent\n\n# REPL environment\nkgents play repl         # Experimental sandbox\n</code></pre>"},{"location":"gallery/#contributing-examples","title":"Contributing Examples","text":"<p>Have a tasteful agent pattern to share? We welcome contributions that:</p> <ul> <li>Demonstrate clear, focused concepts</li> <li>Include working code with tests</li> <li>Follow kgents principles (composable, ethical, joy-inducing)</li> <li>Add genuine educational value</li> </ul> <p>See the project repository for contribution guidelines.</p>"},{"location":"gallery/#support","title":"Support","text":"<ul> <li>Documentation: Read the Docs</li> <li>Issues: GitHub Issues</li> <li>Discussions: GitHub Discussions</li> </ul> <p>\"The noun is a lie. There is only the rate of change.\"</p>"},{"location":"gallery/examples/composition/","title":"Composition","text":"<p>Chain agents together with the <code>&gt;&gt;</code> operator - category theory in action.</p>"},{"location":"gallery/examples/composition/#the-operator","title":"The &gt;&gt; Operator","text":"<p>Agents compose. Given:</p> <pre><code>f: Agent[A, B]\ng: Agent[B, C]\n</code></pre> <p>Then <code>f &gt;&gt; g</code> creates a new agent:</p> <pre><code>Agent[A, C]\n</code></pre> <p>This is the heart of functional agent design.</p>"},{"location":"gallery/examples/composition/#basic-example","title":"Basic Example","text":"<pre><code>from bootstrap.types import Agent\n\nclass DoubleAgent(Agent[int, int]):\n    @property\n    def name(self) -&gt; str:\n        return \"double\"\n\n    async def invoke(self, input: int) -&gt; int:\n        return input * 2\n\nclass StringifyAgent(Agent[int, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"stringify\"\n\n    async def invoke(self, input: int) -&gt; str:\n        return f\"Result: {input}\"\n\n# Compose them\ndouble = DoubleAgent()\nstringify = StringifyAgent()\npipeline = double &gt;&gt; stringify\n\n# The pipeline is itself an agent!\nresult = await pipeline.invoke(21)\n# -&gt; \"Result: 42\"\n\nprint(pipeline.name)  # (double &gt;&gt; stringify)\n</code></pre>"},{"location":"gallery/examples/composition/#key-insight-composition-creates-new-agents","title":"Key Insight: Composition Creates New Agents","text":"<p>The <code>&gt;&gt;</code> operator doesn't just chain functions. It creates a new agent that:</p> <ul> <li>Runs <code>f</code>, then <code>g</code> on <code>f</code>'s output</li> <li>Has its own <code>name</code> (automatically generated from component names)</li> <li>Is itself composable (can be used in further compositions)</li> </ul> <pre><code># pipeline is an Agent[int, str]\n# You can compose it further\nuppercase = UppercaseAgent()  # Agent[str, str]\nfull_pipeline = pipeline &gt;&gt; uppercase  # Agent[int, str]\n</code></pre>"},{"location":"gallery/examples/composition/#the-category-laws","title":"The Category Laws","text":"<p>Agents form a category. This means they satisfy three laws:</p>"},{"location":"gallery/examples/composition/#1-identity-law","title":"1. Identity Law","text":"<p>There exists an identity agent that does nothing:</p> <pre><code>from bootstrap.types import Agent\nfrom typing import TypeVar, Generic\n\nT = TypeVar(\"T\")\n\nclass IdentityAgent(Agent[T, T], Generic[T]):\n    @property\n    def name(self) -&gt; str:\n        return \"identity\"\n\n    async def invoke(self, input: T) -&gt; T:\n        return input\n\nidentity: IdentityAgent[int] = IdentityAgent()\ndouble = DoubleAgent()\n\n# id &gt;&gt; f = f\nresult1 = await (identity &gt;&gt; double).invoke(10)  # 20\n# f &gt;&gt; id = f\nresult2 = await (double &gt;&gt; identity).invoke(10)  # 20\n# f alone\nresult3 = await double.invoke(10)  # 20\n\n# All three are equal!\nassert result1 == result2 == result3\n</code></pre>"},{"location":"gallery/examples/composition/#2-associativity-law","title":"2. Associativity Law","text":"<p>Grouping doesn't matter - composition is associative:</p> <pre><code>class AddOneAgent(Agent[int, int]):\n    @property\n    def name(self) -&gt; str:\n        return \"add-one\"\n\n    async def invoke(self, input: int) -&gt; int:\n        return input + 1\n\ndouble = DoubleAgent()\nadd_one = AddOneAgent()\nstringify = StringifyAgent()\n\n# (f &gt;&gt; g) &gt;&gt; h\nleft = (double &gt;&gt; add_one) &gt;&gt; stringify\n# f &gt;&gt; (g &gt;&gt; h)\nright = double &gt;&gt; (add_one &gt;&gt; stringify)\n\n# Both produce the same result\nresult_left = await left.invoke(5)   # \"Result: 11\"\nresult_right = await right.invoke(5)  # \"Result: 11\"\n\nassert result_left == result_right\n</code></pre> <p>This means you can build pipelines however you like and get the same result.</p>"},{"location":"gallery/examples/composition/#3-composition-law","title":"3. Composition Law","text":"<p>If <code>f: A \u2192 B</code> and <code>g: B \u2192 C</code>, then <code>f &gt;&gt; g: A \u2192 C</code>.</p> <p>The types must align:</p> <pre><code># Valid: output of double (int) matches input of stringify (int)\npipeline = double &gt;&gt; stringify  # Agent[int, str]\n\n# Invalid: type mismatch\n# pipeline = stringify &gt;&gt; double  # Error! str \u2260 int\n</code></pre>"},{"location":"gallery/examples/composition/#why-this-matters","title":"Why This Matters","text":"<p>Category laws give you guarantees about composition:</p>"},{"location":"gallery/examples/composition/#1-build-big-from-small","title":"1. Build Big from Small","text":"<pre><code># Start with simple agents\nvalidate = ValidateInput()      # Agent[str, str | None]\nsanitize = SanitizeText()       # Agent[str, str]\nanalyze = AnalyzeContent()      # Agent[str, Analysis]\nsummarize = CreateSummary()     # Agent[Analysis, str]\nformat_output = FormatMarkdown()  # Agent[str, str]\n\n# Compose into a complex pipeline\nfull_pipeline = (\n    validate &gt;&gt;\n    sanitize &gt;&gt;\n    analyze &gt;&gt;\n    summarize &gt;&gt;\n    format_output\n)\n\n# The pipeline is predictable because of category laws\n</code></pre>"},{"location":"gallery/examples/composition/#2-reuse-components","title":"2. Reuse Components","text":"<pre><code># Define once\nstrip = StripWhitespace()       # Agent[str, str]\nlowercase = Lowercase()         # Agent[str, str]\nremove_punct = RemovePunct()    # Agent[str, str]\n\n# Reuse in different pipelines\nsanitize = strip &gt;&gt; lowercase &gt;&gt; remove_punct\n\n# Use sanitize in multiple contexts\nuser_input_pipeline = sanitize &gt;&gt; validate &gt;&gt; process\nsearch_pipeline = sanitize &gt;&gt; tokenize &gt;&gt; index\n</code></pre>"},{"location":"gallery/examples/composition/#3-test-independently","title":"3. Test Independently","text":"<pre><code># Test each agent in isolation\nasync def test_double():\n    double = DoubleAgent()\n    assert await double.invoke(5) == 10\n\nasync def test_stringify():\n    stringify = StringifyAgent()\n    assert await stringify.invoke(42) == \"Result: 42\"\n\n# Composition guarantees correct behavior when combined\n# If both tests pass, double &gt;&gt; stringify will work!\n</code></pre>"},{"location":"gallery/examples/composition/#4-reason-mathematically","title":"4. Reason Mathematically","text":"<p>Category laws let you refactor with confidence:</p> <pre><code># These are GUARANTEED to be equivalent:\npipeline1 = (a &gt;&gt; b) &gt;&gt; (c &gt;&gt; d)\npipeline2 = a &gt;&gt; (b &gt;&gt; c) &gt;&gt; d\npipeline3 = ((a &gt;&gt; b) &gt;&gt; c) &gt;&gt; d\n\n# No surprises. No hidden behavior.\n</code></pre>"},{"location":"gallery/examples/composition/#type-safety","title":"Type Safety","text":"<p>TypeScript-style type checking helps catch errors at edit time:</p> <pre><code># mypy will catch type mismatches\ndouble: Agent[int, int] = DoubleAgent()\nstringify: Agent[int, str] = StringifyAgent()\nuppercase: Agent[str, str] = UppercaseAgent()\n\n# Valid\ngood = double &gt;&gt; stringify &gt;&gt; uppercase  # Agent[int, str]\n\n# Invalid - mypy error!\n# bad = double &gt;&gt; uppercase  # Error: int \u2260 str\n</code></pre>"},{"location":"gallery/examples/composition/#real-world-example","title":"Real-World Example","text":"<pre><code>from dataclasses import dataclass\nfrom bootstrap.types import Agent\n\n@dataclass\nclass User:\n    email: str\n    raw_input: str\n\n@dataclass\nclass CleanInput:\n    text: str\n    user_email: str\n\n@dataclass\nclass Analysis:\n    sentiment: str\n    topics: list[str]\n    confidence: float\n\nclass ExtractText(Agent[User, CleanInput]):\n    @property\n    def name(self) -&gt; str:\n        return \"extract-text\"\n\n    async def invoke(self, input: User) -&gt; CleanInput:\n        return CleanInput(\n            text=input.raw_input.strip(),\n            user_email=input.email\n        )\n\nclass AnalyzeText(Agent[CleanInput, Analysis]):\n    @property\n    def name(self) -&gt; str:\n        return \"analyze\"\n\n    async def invoke(self, input: CleanInput) -&gt; Analysis:\n        # Imagine calling an LLM here\n        return Analysis(\n            sentiment=\"positive\",\n            topics=[\"kgents\", \"agents\"],\n            confidence=0.92\n        )\n\nclass FormatReport(Agent[Analysis, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"format-report\"\n\n    async def invoke(self, input: Analysis) -&gt; str:\n        return f\"Sentiment: {input.sentiment}\\nTopics: {', '.join(input.topics)}\"\n\n# Compose the full pipeline\nanalyze_user_input = ExtractText() &gt;&gt; AnalyzeText() &gt;&gt; FormatReport()\n\n# Use it\nuser = User(email=\"alice@example.com\", raw_input=\" I love kgents! \")\nreport = await analyze_user_input.invoke(user)\n# -&gt; \"Sentiment: positive\\nTopics: kgents, agents\"\n</code></pre>"},{"location":"gallery/examples/composition/#whats-next","title":"What's Next?","text":"<p>You've learned:</p> <ul> <li>Use <code>&gt;&gt;</code> to chain agents together</li> <li>Composition creates new agents (not just chains)</li> <li>Category laws: identity, associativity, composition</li> <li>Type safety catches errors early</li> </ul> <p>Next step: Learn about functors - lifting agents to new contexts.</p> <p> Explore Functors</p>"},{"location":"gallery/examples/composition/#exercises","title":"Exercises","text":"<ol> <li>Chain three agents: Create <code>double &gt;&gt; add_one &gt;&gt; stringify</code> and test it</li> <li>Verify associativity: Prove <code>(a &gt;&gt; b) &gt;&gt; c = a &gt;&gt; (b &gt;&gt; c)</code> with your own agents</li> <li>Build a text processing pipeline: <code>strip &gt;&gt; lowercase &gt;&gt; remove_punctuation &gt;&gt; word_count</code></li> </ol>"},{"location":"gallery/examples/composition/#run-the-example","title":"Run the Example","text":"<pre><code>python -m impl.claude.agents.examples.composed_pipeline\n</code></pre>"},{"location":"gallery/examples/composition/#full-source","title":"Full Source","text":"<p>View the complete source code: impl/claude/agents/examples/composed_pipeline.py</p>"},{"location":"gallery/examples/custom-archetype/","title":"Custom Archetype","text":"<p>Build production-ready agents with Kappa - the full-stack archetype.</p>"},{"location":"gallery/examples/custom-archetype/#archetypes-pre-configured-agent-patterns","title":"Archetypes: Pre-configured Agent Patterns","text":"<p>An archetype is a pre-configured agent with a specific set of capabilities. Think of it as a template for common use cases.</p> <p>kgents provides several archetypes:</p> Archetype Capabilities Use Case Alpha (\u03b1) Stateless, Observable Pure functions with tracing Beta (\u03b2) Stateful Agents with memory Gamma (\u03b3) Soulful Personality-aligned responses Delta (\u03b4) Stateful + Observable Stateful with tracing Kappa (\u03ba) Everything Full-stack, production-ready"},{"location":"gallery/examples/custom-archetype/#what-is-kappa","title":"What is Kappa?","text":"<p>Kappa is the batteries-included archetype:</p> <pre><code>Kappa = Stateful + Soulful + Observable + Streamable\n</code></pre> <p>Use Kappa when you need:</p> <ul> <li>State management (conversation history, memory)</li> <li>Personality alignment (soul governance)</li> <li>Observability (traces, metrics, logs)</li> <li>Streaming support (process flows)</li> </ul>"},{"location":"gallery/examples/custom-archetype/#basic-kappa-agent","title":"Basic Kappa Agent","text":"<pre><code>from agents.a import Kappa\nfrom dataclasses import dataclass\n\n@dataclass\nclass Advice:\n    suggestion: str\n    reasoning: str\n    confidence: float\n\nclass AdvisorAgent(Kappa[str, Advice]):\n    \"\"\"A full-stack advisor agent.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"kappa-advisor\"\n\n    async def invoke(self, input: str) -&gt; Advice:\n        # Access state (provided by Stateful capability)\n        # State is automatically managed\n        history = self.state.get(\"history\", [])\n        history.append(input)\n        self.state[\"history\"] = history\n\n        # Generate advice\n        # (Soul governance is automatically applied)\n        return Advice(\n            suggestion=\"Trust the process.\",\n            reasoning=\"Kappa agents have all capabilities. Use them wisely.\",\n            confidence=0.95,\n        )\n</code></pre> <p>That's it. The Kappa archetype provides:</p> <ul> <li><code>self.state</code> - Persistent state dictionary</li> <li>Soul governance - Responses filtered through K-gent</li> <li>Traces - Automatic observability</li> <li>Stream support - Can be lifted with Flux</li> </ul>"},{"location":"gallery/examples/custom-archetype/#capabilities-in-detail","title":"Capabilities in Detail","text":""},{"location":"gallery/examples/custom-archetype/#1-stateful","title":"1. Stateful","text":"<p>Kappa agents have built-in state management:</p> <pre><code>class StatefulCounter(Kappa[str, int]):\n    @property\n    def name(self) -&gt; str:\n        return \"counter\"\n\n    async def invoke(self, input: str) -&gt; int:\n        # Get current count (default to 0)\n        count = self.state.get(\"count\", 0)\n\n        # Increment\n        count += 1\n\n        # Store\n        self.state[\"count\"] = count\n\n        return count\n\n# Usage\ncounter = StatefulCounter()\nawait counter.invoke(\"increment\")  # -&gt; 1\nawait counter.invoke(\"increment\")  # -&gt; 2\nawait counter.invoke(\"increment\")  # -&gt; 3\n\n# State persists across invocations\n</code></pre>"},{"location":"gallery/examples/custom-archetype/#2-soulful","title":"2. Soulful","text":"<p>Responses are filtered through soul governance:</p> <pre><code>class PersonalityAgent(Kappa[str, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"personality\"\n\n    async def invoke(self, input: str) -&gt; str:\n        # Raw response\n        response = f\"You said: {input}\"\n\n        # Soul governance (automatic) ensures:\n        # - Aligned with declared eigenvectors\n        # - Consistent with persona\n        # - Passes principle checks\n\n        return response\n</code></pre>"},{"location":"gallery/examples/custom-archetype/#3-observable","title":"3. Observable","text":"<p>Kappa agents are automatically instrumented:</p> <pre><code>class TracedAgent(Kappa[str, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"traced\"\n\n    async def invoke(self, input: str) -&gt; str:\n        # Traces are automatically emitted:\n        # - Input received\n        # - Processing started\n        # - Result produced\n        # - Duration, status, metadata\n\n        result = input.upper()\n        return result\n\n# View traces\n# kgents trace show traced\n</code></pre>"},{"location":"gallery/examples/custom-archetype/#4-streamable","title":"4. Streamable","text":"<p>Kappa agents can be lifted to Flux:</p> <pre><code>from agents.flux import Flux\n\nkappa_agent = MyKappaAgent()\n\n# Lift to streaming\nflux_agent = Flux.lift(kappa_agent)\n\n# Process streams\nasync for result in flux_agent.start(source):\n    print(result)\n</code></pre>"},{"location":"gallery/examples/custom-archetype/#building-a-custom-archetype","title":"Building a Custom Archetype","text":"<p>What if Kappa is too much? Build your own archetype:</p> <pre><code>from agents.a import Capability\nfrom bootstrap.types import Agent\n\n# Custom archetype: Stateful + Observable (no soul, no streaming)\nclass Sigma(Agent[A, B]):\n    \"\"\"Stateful + Observable archetype.\"\"\"\n    pass\n\n# Decorate with capabilities\nSigma = Capability.Stateful(Sigma)\nSigma = Capability.Observable(Sigma)\n\n# Use it\nclass MyAgent(Sigma[str, int]):\n    @property\n    def name(self) -&gt; str:\n        return \"sigma-agent\"\n\n    async def invoke(self, input: str) -&gt; int:\n        # Has state and observability, but not soul\n        return len(input)\n</code></pre>"},{"location":"gallery/examples/custom-archetype/#capability-decorators","title":"Capability Decorators","text":"<p>Capabilities are added via decorators:</p> <pre><code>from agents.a import Capability\n\n# Single capability\n@Capability.Stateful\nclass Agent1(Agent[str, str]):\n    ...\n\n# Multiple capabilities\n@Capability.Soulful(persona=\"Kent\")\n@Capability.Stateful\nclass Agent2(Agent[str, str]):\n    ...\n\n# All capabilities (equivalent to Kappa)\n@Capability.Stateful\n@Capability.Soulful(persona=\"Kent\")\n@Capability.Observable\nclass Agent3(Agent[str, str]):\n    ...\n</code></pre>"},{"location":"gallery/examples/custom-archetype/#inspecting-halos","title":"Inspecting Halos","text":"<p>Every agent has a Halo - the set of capabilities wrapping the skeleton:</p> <pre><code>from agents.a import get_halo\n\nclass MyAgent(Kappa[str, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"my-agent\"\n\n    async def invoke(self, input: str) -&gt; str:\n        return input.upper()\n\n# Get the halo\nhalo = get_halo(MyAgent)\n\n# Inspect capabilities\nfor cap in halo:\n    print(type(cap).__name__)\n# -&gt; StatefulCapability\n# -&gt; SoulfulCapability\n# -&gt; ObservableCapability\n</code></pre>"},{"location":"gallery/examples/custom-archetype/#real-world-example-conversational-agent","title":"Real-World Example: Conversational Agent","text":"<pre><code>from agents.a import Kappa\nfrom dataclasses import dataclass\nfrom typing import List\n\n@dataclass\nclass Message:\n    role: str  # \"user\" or \"assistant\"\n    content: str\n\n@dataclass\nclass Conversation:\n    messages: List[Message]\n    summary: str\n\nclass ConversationalAgent(Kappa[str, str]):\n    \"\"\"A conversational agent with memory and personality.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"conversational\"\n\n    async def invoke(self, user_input: str) -&gt; str:\n        # Get conversation history (Stateful)\n        messages = self.state.get(\"messages\", [])\n\n        # Add user message\n        messages.append(Message(role=\"user\", content=user_input))\n\n        # Generate response (with Soul governance)\n        response = self._generate_response(messages)\n\n        # Add assistant message\n        messages.append(Message(role=\"assistant\", content=response))\n\n        # Update state\n        self.state[\"messages\"] = messages\n\n        # Return response\n        return response\n\n    def _generate_response(self, messages: List[Message]) -&gt; str:\n        # In production, call an LLM here\n        # For demo, simple echo\n        last_user_message = messages[-1].content\n        return f\"You said: {last_user_message}. How interesting!\"\n\n# Usage\nagent = ConversationalAgent()\n\nresponse1 = await agent.invoke(\"Hello!\")\n# -&gt; \"You said: Hello!. How interesting!\"\n\nresponse2 = await agent.invoke(\"What's your name?\")\n# -&gt; \"You said: What's your name?. How interesting!\"\n\n# State persists - conversation history is maintained\nhistory = agent.state.get(\"messages\", [])\n# -&gt; [\n#     Message(role=\"user\", content=\"Hello!\"),\n#     Message(role=\"assistant\", content=\"You said: Hello!...\"),\n#     Message(role=\"user\", content=\"What's your name?\"),\n#     Message(role=\"assistant\", content=\"You said: What's your name?...\"),\n# ]\n</code></pre>"},{"location":"gallery/examples/custom-archetype/#production-checklist","title":"Production Checklist","text":"<p>When building production agents with Kappa:</p> <ul> <li> State: Define what needs to persist across invocations</li> <li> Soul: Ensure responses align with brand/persona</li> <li> Traces: Add custom spans for complex operations</li> <li> Errors: Handle errors gracefully (state rollback, error traces)</li> <li> Tests: Test each capability independently</li> <li> Config: Make agents configurable (don't hardcode)</li> </ul>"},{"location":"gallery/examples/custom-archetype/#halo-pattern-separation-of-concerns","title":"Halo Pattern: Separation of Concerns","text":"<p>The Halo pattern separates:</p> <ul> <li>Skeleton: Core transformation logic (Agent[A, B])</li> <li>Capabilities: Cross-cutting concerns (state, soul, traces)</li> </ul> <pre><code># BAD: Everything in one class\nclass MessyAgent(Agent[str, str]):\n    def __init__(self):\n        self.state = {}\n        self.tracer = Tracer()\n        self.soul = Soul()\n\n    async def invoke(self, input: str) -&gt; str:\n        # State management\n        # Soul governance\n        # Trace emission\n        # Business logic\n        # All tangled together!\n        ...\n\n# GOOD: Capabilities separate from logic\nclass CleanAgent(Kappa[str, str]):\n    async def invoke(self, input: str) -&gt; str:\n        # Just business logic\n        # State, soul, traces handled by Halo\n        return input.upper()\n</code></pre>"},{"location":"gallery/examples/custom-archetype/#choosing-an-archetype","title":"Choosing an Archetype","text":"Need Archetype Why Pure function Alpha (\u03b1) Stateless, just tracing Needs memory Beta (\u03b2) Stateful Personality Gamma (\u03b3) Soulful Stateful + traced Delta (\u03b4) State + observability Production-ready Kappa (\u03ba) Everything Custom mix Roll your own Compose capabilities"},{"location":"gallery/examples/custom-archetype/#whats-next","title":"What's Next?","text":"<p>You've learned:</p> <ul> <li>Kappa is the full-stack archetype (Stateful + Soulful + Observable + Streamable)</li> <li>Capabilities are added via decorators</li> <li>Halos separate skeleton from cross-cutting concerns</li> <li>Build custom archetypes by composing capabilities</li> </ul> <p>Next step: Explore more examples in the gallery!</p> <p> Back to Gallery</p>"},{"location":"gallery/examples/custom-archetype/#exercises","title":"Exercises","text":"<ol> <li>Create a custom archetype: Build an archetype with just Stateful + Observable</li> <li>Build a counter agent: Use Kappa to build a stateful counter</li> <li>Add tracing: View traces for your Kappa agent with <code>kgents trace show</code></li> </ol>"},{"location":"gallery/examples/custom-archetype/#run-the-example","title":"Run the Example","text":"<pre><code>python -m impl.claude.agents.examples.soulful_advisor\n</code></pre>"},{"location":"gallery/examples/custom-archetype/#full-source","title":"Full Source","text":"<p>View the complete source code: - impl/claude/agents/examples/soulful_advisor.py - impl/claude/agents/a/archetype.py - impl/claude/agents/a/capability.py</p>"},{"location":"gallery/examples/functors/","title":"Functors","text":"<p>Lift agents to handle wrapped values - elegantly handling optionals, errors, and more.</p>"},{"location":"gallery/examples/functors/#the-problem","title":"The Problem","text":"<p>You have a simple agent:</p> <pre><code>class DoubleAgent(Agent[int, int]):\n    async def invoke(self, input: int) -&gt; int:\n        return input * 2\n</code></pre> <p>But now your input might be <code>None</code>. What do you do?</p> <p>Bad solution: Add null checks everywhere</p> <pre><code>async def invoke(self, input: int | None) -&gt; int | None:\n    if input is None:\n        return None\n    return input * 2  # Now with special cases!\n</code></pre> <p>This gets messy fast. What about composition?</p> <pre><code># Now every agent needs null checks\npipeline = maybe_double &gt;&gt; maybe_add_one &gt;&gt; maybe_stringify\n# Each one has if input is None: return None\n</code></pre> <p>Better solution: Use a Functor to lift the agent.</p>"},{"location":"gallery/examples/functors/#the-maybe-type","title":"The Maybe Type","text":"<p>First, we need a type that explicitly represents \"maybe has a value\":</p> <pre><code>from agents.c import Maybe, Just, Nothing\n\n# Maybe[A] is either Just(value) or Nothing\nhas_value: Maybe[int] = Just(42)\nno_value: Maybe[int] = Nothing\n\n# Pattern: Use Maybe instead of None\n# Benefits:\n#   - Type-safe: compiler knows it might be empty\n#   - Composable: works with functors\n#   - Explicit: no surprise NoneType errors\n</code></pre> <p><code>Maybe[A]</code> is like <code>Optional[A]</code>, but designed for composition:</p> <ul> <li><code>Just(value)</code> = has a value</li> <li><code>Nothing</code> = no value (singleton, not a type)</li> </ul>"},{"location":"gallery/examples/functors/#the-maybefunctor","title":"The MaybeFunctor","text":"<p>A Functor transforms agents to work with wrapped values:</p> <pre><code>Agent[A, B]  -&gt;  Agent[F[A], F[B]]\n</code></pre> <p>For the Maybe functor:</p> <pre><code>Agent[A, B]  -&gt;  Agent[Maybe[A], Maybe[B]]\n</code></pre> <p>Here's how:</p> <pre><code>from agents.c import MaybeFunctor, Just, Nothing\n\nclass DoubleAgent(Agent[int, int]):\n    @property\n    def name(self) -&gt; str:\n        return \"double\"\n\n    async def invoke(self, input: int) -&gt; int:\n        return input * 2\n\n# Original: Agent[int, int]\ndouble = DoubleAgent()\n\n# Lifted: Agent[Maybe[int], Maybe[int]]\nmaybe_double = MaybeFunctor.lift(double)\n\n# Now it handles optional values automatically!\nawait maybe_double.invoke(Just(21))  # -&gt; Just(42)\nawait maybe_double.invoke(Nothing)   # -&gt; Nothing\n</code></pre> <p>No null checks. No special cases. Just lift.</p>"},{"location":"gallery/examples/functors/#how-it-works","title":"How It Works","text":"<p>The <code>MaybeFunctor.lift()</code> function wraps your agent:</p> <ol> <li>If input is <code>Just(value)</code>, unwrap it and call the original agent</li> <li>If input is <code>Nothing</code>, skip the agent and return <code>Nothing</code></li> <li>Wrap the result back in <code>Maybe</code></li> </ol> <pre><code># Conceptual implementation\nclass LiftedMaybeAgent(Agent[Maybe[A], Maybe[B]]):\n    def __init__(self, original: Agent[A, B]):\n        self.original = original\n\n    async def invoke(self, input: Maybe[A]) -&gt; Maybe[B]:\n        if isinstance(input, Just):\n            result = await self.original.invoke(input.value)\n            return Just(result)\n        else:\n            return Nothing\n</code></pre>"},{"location":"gallery/examples/functors/#composition-with-maybe","title":"Composition with Maybe","text":"<p>The real power: compose lifted agents without any null checks:</p> <pre><code>from agents.c import MaybeFunctor\n\n# Original agents (simple, no null handling)\ndouble = DoubleAgent()       # int -&gt; int\nadd_one = AddOneAgent()      # int -&gt; int\nstringify = StringifyAgent() # int -&gt; str\n\n# Lift all of them\nmaybe_double = MaybeFunctor.lift(double)\nmaybe_add_one = MaybeFunctor.lift(add_one)\nmaybe_stringify = MaybeFunctor.lift(stringify)\n\n# Compose the lifted agents\npipeline = maybe_double &gt;&gt; maybe_add_one &gt;&gt; maybe_stringify\n\n# If ANY step returns Nothing, the whole pipeline returns Nothing\nawait pipeline.invoke(Just(5))   # -&gt; Just(\"Result: 11\")\nawait pipeline.invoke(Nothing)   # -&gt; Nothing\n</code></pre> <p>Your agent code stays simple. The functor handles the wrapping.</p>"},{"location":"gallery/examples/functors/#other-functors","title":"Other Functors","text":"<p>The Maybe functor is just one example. kgents provides several:</p>"},{"location":"gallery/examples/functors/#list-functor","title":"List Functor","text":"<p>Process multiple values:</p> <pre><code>Agent[A, B]  -&gt;  Agent[List[A], List[B]]\n</code></pre> <p>Apply an agent to each item in a list:</p> <pre><code>list_double = ListFunctor.lift(double)\nawait list_double.invoke([1, 2, 3])  # -&gt; [2, 4, 6]\n</code></pre>"},{"location":"gallery/examples/functors/#either-functor","title":"Either Functor","text":"<p>Handle success or error:</p> <pre><code>Agent[A, B]  -&gt;  Agent[Either[E, A], Either[E, B]]\n</code></pre> <p>Short-circuit on error:</p> <pre><code>from agents.c import Either, Left, Right\n\neither_double = EitherFunctor.lift(double)\nawait either_double.invoke(Right(21))  # -&gt; Right(42)\nawait either_double.invoke(Left(\"error\"))  # -&gt; Left(\"error\")\n</code></pre>"},{"location":"gallery/examples/functors/#flux-functor","title":"Flux Functor","text":"<p>Transform discrete agents into continuous processors:</p> <pre><code>Agent[A, B]  -&gt;  FluxAgent[A, B]\n</code></pre> <p>(See the Streaming example for details.)</p>"},{"location":"gallery/examples/functors/#the-functor-pattern","title":"The Functor Pattern","text":"<p>All functors follow the same pattern:</p> <pre><code># 1. Define a wrapper type (Maybe, List, Either, Flux)\n# 2. Implement lift() to transform Agent[A, B] -&gt; Agent[F[A], F[B]]\n# 3. Use it!\n\noriginal_agent = MyAgent()\nlifted_agent = SomeFunctor.lift(original_agent)\n</code></pre> <p>The power: Your agent code stays simple. The functor adds the behavior.</p>"},{"location":"gallery/examples/functors/#functor-laws","title":"Functor Laws","text":"<p>Like agents, functors must satisfy laws:</p>"},{"location":"gallery/examples/functors/#1-identity-law","title":"1. Identity Law","text":"<p>Lifting the identity agent does nothing:</p> <pre><code>identity = IdentityAgent[int]()\nlifted = MaybeFunctor.lift(identity)\n\n# lifted is effectively identity\nawait lifted.invoke(Just(42))  # -&gt; Just(42)\nawait lifted.invoke(Nothing)   # -&gt; Nothing\n</code></pre>"},{"location":"gallery/examples/functors/#2-composition-law","title":"2. Composition Law","text":"<p>Lifting preserves composition:</p> <pre><code># Lift then compose\nlifted_f = MaybeFunctor.lift(f)\nlifted_g = MaybeFunctor.lift(g)\npipeline1 = lifted_f &gt;&gt; lifted_g\n\n# Compose then lift\npipeline2 = MaybeFunctor.lift(f &gt;&gt; g)\n\n# Both are equivalent!\n</code></pre> <p>These laws guarantee that functors behave predictably.</p>"},{"location":"gallery/examples/functors/#real-world-example-parsing-pipeline","title":"Real-World Example: Parsing Pipeline","text":"<pre><code>from agents.c import Maybe, Just, Nothing, MaybeFunctor\nfrom bootstrap.types import Agent\n\nclass ParseInt(Agent[str, int | None]):\n    \"\"\"Parse string to int, return None if invalid.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"parse-int\"\n\n    async def invoke(self, input: str) -&gt; int | None:\n        try:\n            return int(input)\n        except ValueError:\n            return None\n\nclass ConvertToMaybe(Agent[int | None, Maybe[int]]):\n    \"\"\"Convert None to Nothing, value to Just(value).\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"to-maybe\"\n\n    async def invoke(self, input: int | None) -&gt; Maybe[int]:\n        return Just(input) if input is not None else Nothing\n\nclass DoubleAgent(Agent[int, int]):\n    @property\n    def name(self) -&gt; str:\n        return \"double\"\n\n    async def invoke(self, input: int) -&gt; int:\n        return input * 2\n\nclass StringifyAgent(Agent[int, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"stringify\"\n\n    async def invoke(self, input: int) -&gt; str:\n        return f\"Result: {input}\"\n\n# Build the pipeline\nparse = ParseInt()\nto_maybe = ConvertToMaybe()\nmaybe_double = MaybeFunctor.lift(DoubleAgent())\nmaybe_stringify = MaybeFunctor.lift(StringifyAgent())\n\npipeline = parse &gt;&gt; to_maybe &gt;&gt; maybe_double &gt;&gt; maybe_stringify\n\n# Use it\nawait pipeline.invoke(\"21\")    # -&gt; Just(\"Result: 42\")\nawait pipeline.invoke(\"xyz\")   # -&gt; Nothing\n</code></pre> <p>The functor handles all the error propagation. Your business logic stays clean.</p>"},{"location":"gallery/examples/functors/#when-to-use-functors","title":"When to Use Functors","text":"<p>Use functors when you need to:</p> <ul> <li>Handle optionals: MaybeFunctor</li> <li>Process lists: ListFunctor</li> <li>Manage errors: EitherFunctor</li> <li>Work with streams: FluxFunctor (Flux)</li> <li>Add context: ReaderFunctor, WriterFunctor</li> </ul> <p>Don't use functors when:</p> <ul> <li>The agent naturally handles the wrapped type</li> <li>You need custom error handling logic</li> <li>The wrapping adds more complexity than it removes</li> </ul>"},{"location":"gallery/examples/functors/#whats-next","title":"What's Next?","text":"<p>You've learned:</p> <ul> <li><code>Maybe[A]</code> represents optional values explicitly</li> <li><code>MaybeFunctor.lift()</code> makes agents handle optionals</li> <li>Functors let you add powers without changing agent code</li> <li>The functor pattern: lift, compose, profit</li> </ul> <p>Next step: Chat with K-gent and experience personality-aligned dialogue.</p> <p> Meet K-gent</p>"},{"location":"gallery/examples/functors/#exercises","title":"Exercises","text":"<ol> <li>Lift a custom agent: Create your own agent and lift it with MaybeFunctor</li> <li>Chain three lifted agents: Compose <code>maybe_parse &gt;&gt; maybe_double &gt;&gt; maybe_stringify</code></li> <li>Create a ListFunctor pipeline: Process a list of numbers through multiple transformations</li> </ol>"},{"location":"gallery/examples/functors/#run-the-example","title":"Run the Example","text":"<pre><code>python -m impl.claude.agents.examples.composed_pipeline\n</code></pre> <p>(The composed_pipeline example includes functor demos.)</p>"},{"location":"gallery/examples/functors/#full-source","title":"Full Source","text":"<p>View functor implementations: - impl/claude/agents/c/functor.py - impl/claude/agents/c/maybe.py</p>"},{"location":"gallery/examples/hello-world/","title":"Hello World","text":"<p>Your first agent - the fundamental building block of kgents.</p>"},{"location":"gallery/examples/hello-world/#the-minimal-agent","title":"The Minimal Agent","text":"<p>An agent is a morphism A \u2192 B: it transforms input of type A into output of type B.</p> <pre><code>from bootstrap.types import Agent\n\nclass GreetAgent(Agent[str, str]):\n    \"\"\"Transforms a name into a greeting.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"greeter\"\n\n    async def invoke(self, input: str) -&gt; str:\n        return f\"Hello, {input}!\"\n</code></pre> <p>That's it. Every agent in kgents follows this pattern:</p> <ul> <li>Type parameters: <code>Agent[Input, Output]</code> declares the transformation</li> <li>name property: Identifies the agent (used in composition, logs, traces)</li> <li>invoke method: The actual transformation logic</li> </ul>"},{"location":"gallery/examples/hello-world/#running-it","title":"Running It","text":"<pre><code>import asyncio\n\nasync def main():\n    agent = GreetAgent()\n    result = await agent.invoke(\"World\")\n    print(result)  # Hello, World!\n\nasyncio.run(main())\n</code></pre> <p>Or run the included example:</p> <pre><code>python -m impl.claude.agents.examples.hello_world\n</code></pre>"},{"location":"gallery/examples/hello-world/#why-async","title":"Why Async?","text":"<p>The <code>invoke</code> method is async (<code>async def</code>) even though this example doesn't need it. Why?</p> <p>Flexibility. Many real-world agents:</p> <ul> <li>Call external APIs (LLMs, databases, web services)</li> <li>Perform I/O operations</li> <li>Coordinate with other async agents</li> </ul> <p>By making <code>invoke</code> async from the start, we avoid retrofitting later.</p>"},{"location":"gallery/examples/hello-world/#key-insight-agents-are-morphisms","title":"Key Insight: Agents Are Morphisms","text":"<p>In category theory, a morphism is an arrow between objects. In kgents:</p> <ul> <li>Objects = Python types (str, int, MyDataClass, etc.)</li> <li>Morphisms = Agents (transformations between types)</li> </ul> <p>This mathematical framing gives us guarantees:</p> <ol> <li>Composition: <code>f &gt;&gt; g</code> chains agents predictably</li> <li>Identity: There exists an identity agent that does nothing</li> <li>Associativity: <code>(f &gt;&gt; g) &gt;&gt; h = f &gt;&gt; (g &gt;&gt; h)</code></li> </ol> <p>These aren't just nice properties - they're laws that make agents composable.</p>"},{"location":"gallery/examples/hello-world/#creating-your-own-agent","title":"Creating Your Own Agent","text":"<p>Let's build a different agent with different types:</p> <pre><code>from bootstrap.types import Agent\n\nclass ShoutAgent(Agent[str, str]):\n    \"\"\"Transforms text to uppercase with enthusiasm.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"shouter\"\n\n    async def invoke(self, input: str) -&gt; str:\n        return input.upper() + \"!\"\n\n# Usage\nagent = ShoutAgent()\nresult = await agent.invoke(\"hello kgents\")\n# -&gt; \"HELLO KGENTS!\"\n</code></pre>"},{"location":"gallery/examples/hello-world/#different-inputoutput-types","title":"Different Input/Output Types","text":"<p>Agents can transform between ANY types:</p> <pre><code>from dataclasses import dataclass\nfrom bootstrap.types import Agent\n\n@dataclass\nclass Person:\n    name: str\n    age: int\n\nclass PersonToGreeting(Agent[Person, str]):\n    @property\n    def name(self) -&gt; str:\n        return \"person-greeter\"\n\n    async def invoke(self, input: Person) -&gt; str:\n        return f\"Hello, {input.name}! You are {input.age} years old.\"\n\n# Usage\nagent = PersonToGreeting()\nperson = Person(name=\"Alice\", age=30)\ngreeting = await agent.invoke(person)\n# -&gt; \"Hello, Alice! You are 30 years old.\"\n</code></pre>"},{"location":"gallery/examples/hello-world/#agent-class-hierarchy","title":"Agent != Class Hierarchy","text":"<p>Critical insight: <code>Agent[A, B]</code> is NOT a traditional class hierarchy.</p> <p>Traditional OOP: <pre><code>class Animal:\n    def speak(self): pass\n\nclass Dog(Animal):\n    def speak(self): return \"woof\"\n</code></pre></p> <p>Agent-oriented: <pre><code>class GreetAgent(Agent[str, str]):\n    # This is the SKELETON\n    # Everything else (state, soul, observability) is added via Halo\n    ...\n</code></pre></p> <p>The skeleton is minimal. Capabilities are added via decorators:</p> <pre><code>from agents.a import Capability\n\n@Capability.Soulful(persona=\"Kent\")\n@Capability.Stateful\nclass MyAgent(Agent[str, str]):\n    ...\n</code></pre> <p>(More on capabilities in later examples.)</p>"},{"location":"gallery/examples/hello-world/#whats-next","title":"What's Next?","text":"<p>You've learned:</p> <ul> <li>Agent[A, B] is a transformation from A to B</li> <li>Every agent has a <code>name</code> and an <code>invoke</code> method</li> <li>Agents are morphisms (they obey category laws)</li> </ul> <p>Next step: Learn to chain agents together with composition.</p> <p> Learn Composition</p>"},{"location":"gallery/examples/hello-world/#exercises","title":"Exercises","text":"<ol> <li>Create a ReverseAgent: Agent[str, str] that reverses a string</li> <li>Create a LengthAgent: Agent[str, int] that returns string length</li> <li>Create a ValidateEmailAgent: Agent[str, bool] that checks if input is a valid email</li> </ol>"},{"location":"gallery/examples/hello-world/#run-the-example","title":"Run the Example","text":"<pre><code># From the kgents repo root\npython -m impl.claude.agents.examples.hello_world\n</code></pre>"},{"location":"gallery/examples/hello-world/#full-source","title":"Full Source","text":"<p>View the complete source code: impl/claude/agents/examples/hello_world.py</p>"},{"location":"gallery/examples/soul-dialogue/","title":"Soul Dialogue","text":"<p>Chat with K-gent, Kent's digital simulacra - personality-aligned dialogue that feels genuine.</p>"},{"location":"gallery/examples/soul-dialogue/#what-is-k-gent-soul","title":"What is K-gent Soul?","text":"<p>K-gent Soul is NOT a chatbot. It's a Governance Functor - a personality model that ensures responses align with declared preferences and eigenvectors.</p> <p>Think of it as:</p> <ul> <li>Traditional chatbot: <code>input -&gt; LLM -&gt; output</code></li> <li>K-gent Soul: <code>input -&gt; [Eigenvector Alignment] -&gt; LLM -&gt; [Principle Check] -&gt; output</code></li> </ul> <p>The soul ensures every response feels \"on brand\" - like Kent on his best day.</p>"},{"location":"gallery/examples/soul-dialogue/#the-four-dialogue-modes","title":"The Four Dialogue Modes","text":"<p>K-gent has four distinct modes, each activating different personality dimensions:</p> Mode Purpose Example Starter REFLECT Mirror back for examination \"Let me understand: you're saying...\" ADVISE Offer preference-aligned suggestions \"Based on what matters to you...\" CHALLENGE Push back constructively \"Have you considered the opposite...\" EXPLORE Follow tangents, generate hypotheses \"That reminds me of... what if...\""},{"location":"gallery/examples/soul-dialogue/#basic-usage","title":"Basic Usage","text":""},{"location":"gallery/examples/soul-dialogue/#from-the-cli","title":"From the CLI","text":"<p>The simplest way to interact with K-gent:</p> <pre><code># Interactive dialogue (default: REFLECT mode)\nkgents soul\n\n# Specific mode with prompt\nkgents soul challenge \"I think premature optimization is fine\"\n\n# Quick response (fewer tokens)\nkgents soul advise \"Should I refactor this?\" --quick\n\n# See all starter prompts\nkgents soul starters\n\n# View soul state\nkgents soul manifest\n</code></pre>"},{"location":"gallery/examples/soul-dialogue/#from-python","title":"From Python","text":"<pre><code>from agents.k import KgentSoul, DialogueMode\n\n# Create a soul instance\nsoul = KgentSoul()\n\n# Have a dialogue\noutput = await soul.dialogue(\n    \"What makes a good agent design?\",\n    mode=DialogueMode.REFLECT,\n)\n\nprint(output.response)\n# -&gt; A thoughtful, Kent-like reflection on agent design\n</code></pre>"},{"location":"gallery/examples/soul-dialogue/#the-dialogue-modes-explained","title":"The Dialogue Modes Explained","text":""},{"location":"gallery/examples/soul-dialogue/#reflect-mode","title":"REFLECT Mode","text":"<p>Purpose: Mirror back your thinking for examination.</p> <p>When to use: - Clarifying your own thoughts - Processing complex ideas - Getting a fresh perspective on your reasoning</p> <p>Example:</p> <pre><code>$ kgents soul reflect \"I'm torn between microservices and monoliths\"\n</code></pre> <p>K-gent response:</p> <p>Let me understand: you're weighing modularity against simplicity. The question isn't \"which is better\" - it's \"what serves this context?\" Microservices excel when you have clear bounded contexts and independent teams. Monoliths shine when coordination costs matter more than scaling each piece independently. What does your system need right now?</p>"},{"location":"gallery/examples/soul-dialogue/#advise-mode","title":"ADVISE Mode","text":"<p>Purpose: Offer recommendations aligned with your values.</p> <p>When to use: - Making decisions - Seeking guidance - Getting preference-aligned suggestions</p> <p>Example:</p> <pre><code>$ kgents soul advise \"Should I spend time on this optimization?\"\n</code></pre> <p>K-gent response:</p> <p>Based on what matters to you - tasteful design, joy-inducing systems - ask: will this optimization make the system more delightful to work with, or just faster? If it's pure speed without improving the developer experience, defer it. If it removes friction and makes the code clearer, do it now. Premature optimization is waste. Timely optimization is craft.</p>"},{"location":"gallery/examples/soul-dialogue/#challenge-mode","title":"CHALLENGE Mode","text":"<p>Purpose: Push back constructively to stress-test ideas.</p> <p>When to use: - Validating assumptions - Finding blind spots - Strengthening arguments</p> <p>Example:</p> <pre><code>$ kgents soul challenge \"I think we should add more features\"\n</code></pre> <p>K-gent response:</p> <p>Have you considered that every feature is also debt? More features means more surface area, more complexity, more to maintain. What if instead of adding, you composed better? What if you made what you have more delightful? The best feature is often the one you remove, not add.</p>"},{"location":"gallery/examples/soul-dialogue/#explore-mode","title":"EXPLORE Mode","text":"<p>Purpose: Follow tangents, generate creative hypotheses.</p> <p>When to use: - Brainstorming - Creative problem-solving - Discovering unexpected connections</p> <p>Example:</p> <pre><code>$ kgents soul explore \"How do agents relate to category theory?\"\n</code></pre> <p>K-gent response:</p> <p>That reminds me of how functors preserve structure... What if we thought of agents not as objects but as arrows? Then composition becomes the primary operation, not method calls. And what if we lifted that to different contexts? Maybe[Agent] for fallible agents, Flux[Agent] for streaming... suddenly we have a whole algebra of agent transformations. The noun is a lie; there's only the morphism!</p>"},{"location":"gallery/examples/soul-dialogue/#eigenvectors-personality-dimensions","title":"Eigenvectors: Personality Dimensions","text":"<p>K-gent's responses are shaped by eigenvectors - personality dimensions:</p> <ul> <li>Tasteful: Quality over quantity, always</li> <li>Curated: Intentional selection, not everything</li> <li>Ethical: Augment human judgment, don't replace it</li> <li>Joy-Inducing: Delight matters, not just function</li> </ul> <p>These aren't just prompts - they're coordinate axes in personality space.</p>"},{"location":"gallery/examples/soul-dialogue/#adding-soul-to-your-agents","title":"Adding Soul to Your Agents","text":"<p>The <code>@Soulful</code> capability adds soul governance to any agent:</p> <pre><code>from agents.a import Capability\nfrom bootstrap.types import Agent\n\n@Capability.Soulful(persona=\"Kent\")\nclass AdvisorAgent(Agent[str, str]):\n    \"\"\"An advisor that gives persona-aligned advice.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"advisor\"\n\n    async def invoke(self, input: str) -&gt; str:\n        # Soul governance wraps this automatically\n        # Responses will be filtered through K-gent's eigenvectors\n        return f\"Consider: {input}\"\n</code></pre> <p>When compiled through <code>LocalProjector</code> with an active K-gent instance, the agent's responses will be:</p> <ol> <li>Pre-processed through eigenvector alignment</li> <li>Post-processed through principle checking</li> <li>Guaranteed to feel \"on brand\"</li> </ol>"},{"location":"gallery/examples/soul-dialogue/#example-soulful-advisor","title":"Example: Soulful Advisor","text":"<pre><code>from dataclasses import dataclass\nfrom agents.a import Capability\nfrom bootstrap.types import Agent\n\n@dataclass\nclass Advice:\n    suggestion: str\n    reasoning: str\n    confidence: float\n\n@Capability.Soulful(persona=\"Kent\")\nclass AdvisorAgent(Agent[str, Advice]):\n    \"\"\"Provides persona-aligned advice.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"advisor\"\n\n    async def invoke(self, input: str) -&gt; Advice:\n        # In production, this would consult K-gent\n        if \"code\" in input.lower():\n            return Advice(\n                suggestion=\"Start with the simplest thing that could work.\",\n                reasoning=\"Complexity is debt. Simplicity compounds.\",\n                confidence=0.9,\n            )\n        else:\n            return Advice(\n                suggestion=\"What would make you smile when you look back?\",\n                reasoning=\"The mirror test: does this feel like you on your best day?\",\n                confidence=0.7,\n            )\n\n# Usage\nadvisor = AdvisorAgent()\nadvice = await advisor.invoke(\"How should I approach this code review?\")\nprint(advice.suggestion)\n# -&gt; \"Start with the simplest thing that could work.\"\n</code></pre>"},{"location":"gallery/examples/soul-dialogue/#soul-as-governance","title":"Soul as Governance","text":"<p>K-gent Soul isn't just for chatting. It's a governance mechanism:</p> <p>Without soul: <pre><code># Agent might give inconsistent advice\nresponse1 = await agent.invoke(\"Should I optimize?\")\n# -&gt; \"Yes, optimize everything!\"\n\nresponse2 = await agent.invoke(\"Should I add features?\")\n# -&gt; \"Yes, add more features!\"\n\n# Contradictory! Both can't be right.\n</code></pre></p> <p>With soul: <pre><code>@Capability.Soulful(persona=\"Kent\")\nclass ConsistentAgent(Agent[str, str]):\n    ...\n\n# Responses are filtered through eigenvectors\n# Contradictions are caught and resolved\n# Every response aligns with declared preferences\n</code></pre></p>"},{"location":"gallery/examples/soul-dialogue/#interactive-dialogue","title":"Interactive Dialogue","text":"<p>Try an interactive session:</p> <pre><code>$ kgents soul\n\nWelcome to K-gent Soul (REFLECT mode)\nType 'help' for commands, 'quit' to exit\n\nYou: What makes agents different from classes?\n\nK-gent: Let me understand: you're asking about the conceptual shift.\nClasses are about IDENTITY - \"what is this thing?\" Agents are about\nTRANSFORMATION - \"what does this do?\" A class has methods. An agent\nIS a method (invoke). The skeleton is minimal; capabilities are added\nvia Halo. This inverts the traditional OOP hierarchy. Instead of\nbuilding up from base classes, you compose morphisms. Identity is\nemergent, not primary.\n\nYou: quit\n\nGoodbye!\n</code></pre>"},{"location":"gallery/examples/soul-dialogue/#starters-for-each-mode","title":"Starters for Each Mode","text":"<p>K-gent provides conversation starters tailored to each mode:</p> <pre><code>$ kgents soul starters\n\nREFLECT:\n- \"Help me think through...\"\n- \"I'm noticing a pattern...\"\n- \"Let me understand what I'm actually asking...\"\n\nADVISE:\n- \"What would you recommend for...\"\n- \"Given my constraints, should I...\"\n- \"How would you approach...\"\n\nCHALLENGE:\n- \"I believe X, but...\"\n- \"Why shouldn't I...\"\n- \"What am I missing about...\"\n\nEXPLORE:\n- \"What if we combined...\"\n- \"I wonder what would happen if...\"\n- \"This reminds me of...\"\n</code></pre>"},{"location":"gallery/examples/soul-dialogue/#whats-next","title":"What's Next?","text":"<p>You've learned:</p> <ul> <li>K-gent Soul provides personality-aligned dialogue</li> <li>Four modes: REFLECT, ADVISE, CHALLENGE, EXPLORE</li> <li>Soul is a governance functor, not just a chatbot</li> <li>Use <code>@Soulful</code> to add soul governance to agents</li> </ul> <p>Next step: Learn about streaming agents with the Flux functor.</p> <p> Flow Like Water</p>"},{"location":"gallery/examples/soul-dialogue/#exercises","title":"Exercises","text":"<ol> <li>Try each mode: Have a dialogue in REFLECT, ADVISE, CHALLENGE, and EXPLORE modes</li> <li>Add soul to an agent: Wrap one of your agents with <code>@Capability.Soulful</code></li> <li>Compare responses: Ask the same question in different modes and notice the differences</li> </ol>"},{"location":"gallery/examples/soul-dialogue/#run-the-example","title":"Run the Example","text":"<pre><code># Interactive soul dialogue\nkgents soul\n\n# Or run the Python example\npython -m impl.claude.agents.examples.soulful_advisor\n</code></pre>"},{"location":"gallery/examples/soul-dialogue/#full-source","title":"Full Source","text":"<p>View the complete source code: - impl/claude/agents/examples/soulful_advisor.py - impl/claude/agents/k/soul.py</p>"},{"location":"gallery/examples/streaming/","title":"Streaming","text":"<p>Transform discrete agents into continuous processors with the Flux functor.</p>"},{"location":"gallery/examples/streaming/#the-insight","title":"The Insight","text":"<p>\"The noun is a lie. There is only the rate of change.\"</p> <p>Traditional agents process points - discrete transformations:</p> <pre><code>Agent[A, B]  # A point transformation: one input \u2192 one output\n</code></pre> <p>But what if you need to process flows - continuous streams?</p> <pre><code>FluxAgent[A, B]  # A continuous transformation: stream A \u2192 stream B\n</code></pre> <p>The Flux Functor bridges these worlds.</p>"},{"location":"gallery/examples/streaming/#the-flux-functor","title":"The Flux Functor","text":"<p>Flux transforms discrete agents into streaming processors:</p> <pre><code>Flux.lift: Agent[A, B] \u2192 FluxAgent[A, B]\n</code></pre> <p>A FluxAgent:</p> <ul> <li>Accepts a stream of inputs (<code>AsyncIterator[A]</code>)</li> <li>Produces a stream of outputs (<code>AsyncIterator[B]</code>)</li> <li>Maintains continuous processing (no blocking)</li> </ul>"},{"location":"gallery/examples/streaming/#basic-example","title":"Basic Example","text":"<pre><code>from agents.flux import Flux, FluxAgent\nfrom bootstrap.types import Agent\nfrom typing import AsyncIterator\n\nclass DoubleAgent(Agent[int, int]):\n    \"\"\"Doubles its input.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"doubler\"\n\n    async def invoke(self, input: int) -&gt; int:\n        return input * 2\n\n# Create a discrete agent\ndoubler = DoubleAgent()\n\n# Lift it to the flux domain\nflux_doubler: FluxAgent[int, int] = Flux.lift(doubler)\n\n# Create a stream source\nasync def number_source() -&gt; AsyncIterator[int]:\n    for i in range(1, 6):\n        yield i\n\n# Process the stream\nasync for result in flux_doubler.start(number_source()):\n    print(result)  # 2, 4, 6, 8, 10\n</code></pre>"},{"location":"gallery/examples/streaming/#how-it-works","title":"How It Works","text":"<p>When you lift an agent with <code>Flux.lift()</code>:</p> <ol> <li>Start: The flux agent accepts an async iterator</li> <li>Process: For each item in the stream, invoke the underlying agent</li> <li>Yield: Emit results as they're produced (no buffering)</li> <li>Continue: Keep processing until the stream ends</li> </ol> <pre><code># Conceptual implementation\nclass FluxAgent:\n    def __init__(self, agent: Agent[A, B]):\n        self.agent = agent\n\n    async def start(self, source: AsyncIterator[A]) -&gt; AsyncIterator[B]:\n        async for item in source:\n            result = await self.agent.invoke(item)\n            yield result\n</code></pre>"},{"location":"gallery/examples/streaming/#flux-configuration","title":"Flux Configuration","text":"<p>FluxAgent accepts configuration for advanced behavior:</p> <pre><code>from agents.flux import Flux, FluxConfig\n\nconfig = FluxConfig(\n    buffer_size=100,          # Internal buffer size\n    feedback_fraction=0.0,    # Ouroboric feedback (advanced)\n)\n\nflux_agent = Flux.lift(doubler, config=config)\n</code></pre>"},{"location":"gallery/examples/streaming/#buffer-size","title":"Buffer Size","text":"<p>Controls how many items can be buffered internally:</p> <pre><code>config = FluxConfig(buffer_size=10)\nflux_agent = Flux.lift(doubler, config=config)\n\n# If the source produces faster than the agent processes,\n# items are buffered up to buffer_size\n</code></pre>"},{"location":"gallery/examples/streaming/#feedback-fraction-advanced","title":"Feedback Fraction (Advanced)","text":"<p>Enables ouroboric feedback - feeding output back as input:</p> <pre><code>config = FluxConfig(feedback_fraction=0.1)\nflux_agent = Flux.lift(doubler, config=config)\n\n# 10% of output is fed back as input\n# Creates a self-sustaining loop (use carefully!)\n</code></pre> <p>This is useful for:</p> <ul> <li>Evolutionary systems (output influences future input)</li> <li>Recursive refinement</li> <li>Self-organizing agents</li> </ul>"},{"location":"gallery/examples/streaming/#stream-sources","title":"Stream Sources","text":"<p>You can create streams from many sources:</p>"},{"location":"gallery/examples/streaming/#generator-function","title":"Generator Function","text":"<pre><code>async def number_source(n: int) -&gt; AsyncIterator[int]:\n    for i in range(1, n + 1):\n        yield i\n        await asyncio.sleep(0.01)  # Simulate work\n</code></pre>"},{"location":"gallery/examples/streaming/#file-streaming","title":"File Streaming","text":"<pre><code>async def file_lines(path: str) -&gt; AsyncIterator[str]:\n    async with aiofiles.open(path) as f:\n        async for line in f:\n            yield line.strip()\n</code></pre>"},{"location":"gallery/examples/streaming/#websocket-streaming","title":"WebSocket Streaming","text":"<pre><code>async def websocket_messages(ws) -&gt; AsyncIterator[str]:\n    async for message in ws:\n        yield message\n</code></pre>"},{"location":"gallery/examples/streaming/#event-streaming","title":"Event Streaming","text":"<pre><code>async def events(queue: asyncio.Queue) -&gt; AsyncIterator[Event]:\n    while True:\n        event = await queue.get()\n        if event is None:  # Sentinel value\n            break\n        yield event\n</code></pre>"},{"location":"gallery/examples/streaming/#composing-flux-agents","title":"Composing Flux Agents","text":"<p>Flux agents compose just like regular agents:</p> <pre><code>from agents.flux import Flux\n\n# Create discrete agents\ndouble = DoubleAgent()\nfilter_even = FilterEvenAgent()\n\n# Lift to flux\nflux_double = Flux.lift(double)\nflux_filter = Flux.lift(filter_even)\n\n# Compose them\n# (Note: actual composition uses the &gt;&gt; operator on FluxPipeline)\n# This shows the concept:\n\nasync def pipeline(source: AsyncIterator[int]) -&gt; AsyncIterator[int]:\n    # Double all numbers\n    doubled = flux_double.start(source)\n    # Filter to even numbers\n    filtered = flux_filter.start(doubled)\n    return filtered\n\n# Use it\nasync for result in pipeline(number_source(5)):\n    print(result)  # 2, 4, 6, 8, 10 (all even)\n</code></pre>"},{"location":"gallery/examples/streaming/#real-world-example-log-processing","title":"Real-World Example: Log Processing","text":"<pre><code>from dataclasses import dataclass\nfrom agents.flux import Flux\nfrom bootstrap.types import Agent\nfrom typing import AsyncIterator\n\n@dataclass\nclass LogLine:\n    timestamp: str\n    level: str\n    message: str\n\n@dataclass\nclass ParsedLog:\n    timestamp: str\n    level: str\n    message: str\n    is_error: bool\n\nclass ParseLogAgent(Agent[str, ParsedLog]):\n    \"\"\"Parse a log line into structured data.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"parse-log\"\n\n    async def invoke(self, input: str) -&gt; ParsedLog:\n        # Simple parser (in reality, use regex or proper parser)\n        parts = input.split(\" \", 2)\n        if len(parts) &lt; 3:\n            return ParsedLog(\"\", \"INFO\", input, False)\n\n        timestamp, level, message = parts\n        return ParsedLog(\n            timestamp=timestamp,\n            level=level,\n            message=message,\n            is_error=(level == \"ERROR\"),\n        )\n\nclass FilterErrorsAgent(Agent[ParsedLog, ParsedLog | None]):\n    \"\"\"Filter to only error logs.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"filter-errors\"\n\n    async def invoke(self, input: ParsedLog) -&gt; ParsedLog | None:\n        return input if input.is_error else None\n\nclass FormatLogAgent(Agent[ParsedLog, str]):\n    \"\"\"Format log for display.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"format-log\"\n\n    async def invoke(self, input: ParsedLog) -&gt; str:\n        return f\"[{input.timestamp}] {input.level}: {input.message}\"\n\n# Create flux agents\nflux_parse = Flux.lift(ParseLogAgent())\nflux_filter = Flux.lift(FilterErrorsAgent())\nflux_format = Flux.lift(FormatLogAgent())\n\n# Stream log file\nasync def log_stream(path: str) -&gt; AsyncIterator[str]:\n    with open(path) as f:\n        for line in f:\n            yield line.strip()\n\n# Process logs\nasync def process_logs(path: str):\n    source = log_stream(path)\n    parsed = flux_parse.start(source)\n    errors = flux_filter.start(parsed)\n    formatted = flux_format.start(errors)\n\n    async for log in formatted:\n        print(log)\n\n# Run it\nawait process_logs(\"/var/log/app.log\")\n</code></pre>"},{"location":"gallery/examples/streaming/#living-pipelines","title":"Living Pipelines","text":"<p>Flux agents create living pipelines - continuously processing streams:</p> <pre><code># Traditional batch processing\nlogs = read_all_logs()\nparsed = [parse(log) for log in logs]\nerrors = [log for log in parsed if is_error(log)]\nformatted = [format(log) for log in errors]\n\n# Memory intensive! Must load everything first.\n</code></pre> <p>vs</p> <pre><code># Flux streaming\nsource = log_stream()\nparsed = flux_parse.start(source)\nerrors = flux_filter.start(parsed)\nformatted = flux_format.start(errors)\n\nasync for log in formatted:\n    process(log)\n\n# Memory efficient! Process one item at a time.\n# Pipeline is \"alive\" - always ready to process.\n</code></pre>"},{"location":"gallery/examples/streaming/#the-operator-fluxpipeline","title":"The | Operator (FluxPipeline)","text":"<p>For complex pipelines, use <code>FluxPipeline</code>:</p> <pre><code>from agents.flux import FluxPipeline\n\npipeline = (\n    FluxPipeline.from_source(log_stream(\"/var/log/app.log\"))\n    | flux_parse\n    | flux_filter\n    | flux_format\n)\n\nasync for result in pipeline:\n    print(result)\n</code></pre> <p>This creates a declarative pipeline that's easy to read and modify.</p>"},{"location":"gallery/examples/streaming/#flux-vs-traditional-async-iteration","title":"Flux vs. Traditional Async Iteration","text":"<p>Traditional approach:</p> <pre><code>async def process_stream(source):\n    async for item in source:\n        doubled = await double(item)\n        if doubled % 2 == 0:\n            formatted = await format(doubled)\n            print(formatted)\n</code></pre> <p>Flux approach:</p> <pre><code>pipeline = flux_double &gt;&gt; flux_filter &gt;&gt; flux_format\n\nasync for result in pipeline.start(source):\n    print(result)\n</code></pre> <p>Benefits:</p> <ul> <li>Composable: Build pipelines from reusable agents</li> <li>Testable: Test each agent independently</li> <li>Declarative: Pipeline structure is clear</li> <li>Type-safe: Types flow through the pipeline</li> </ul>"},{"location":"gallery/examples/streaming/#when-to-use-flux","title":"When to Use Flux","text":"<p>Use Flux when you have:</p> <ul> <li>Continuous data: Log streams, sensor data, user events</li> <li>Large datasets: Too big to fit in memory</li> <li>Real-time processing: Need results as data arrives</li> <li>Long-running pipelines: Always-on processors</li> </ul> <p>Don't use Flux when:</p> <ul> <li>You need to process all data before returning (use batch agents)</li> <li>Order matters and you need backpressure (use explicit queues)</li> <li>The stream is finite and small (just use a list)</li> </ul>"},{"location":"gallery/examples/streaming/#whats-next","title":"What's Next?","text":"<p>You've learned:</p> <ul> <li>Flux transforms discrete agents into continuous processors</li> <li><code>Flux.lift()</code> creates streaming agents</li> <li>FluxConfig controls buffer size and feedback</li> <li>Compose flux agents to build living pipelines</li> </ul> <p>Next step: Build production-ready agents with the Kappa archetype.</p> <p> Custom Archetype</p>"},{"location":"gallery/examples/streaming/#exercises","title":"Exercises","text":"<ol> <li>Create a streaming pipeline: Build <code>flux_parse &gt;&gt; flux_transform &gt;&gt; flux_format</code></li> <li>Process a file stream: Use Flux to process a large file line-by-line</li> <li>Experiment with feedback: Create a flux agent with <code>feedback_fraction &gt; 0</code> and observe behavior</li> </ol>"},{"location":"gallery/examples/streaming/#run-the-example","title":"Run the Example","text":"<pre><code>python -m impl.claude.agents.examples.streaming_pipeline\n</code></pre>"},{"location":"gallery/examples/streaming/#full-source","title":"Full Source","text":"<p>View the complete source code: - impl/claude/agents/examples/streaming_pipeline.py - impl/claude/agents/flux/functor.py</p>"},{"location":"ideas-synthesis/","title":"Ideas Synthesis: Methodology","text":"<p>\"The distance from idea to reality is measured in structured execution.\"</p>"},{"location":"ideas-synthesis/#what-this-directory-is-and-is-not","title":"What This Directory Is (And Is Not)","text":"<p>IS: Documentation of the methodology for creative exploration and idea synthesis.</p> <p>IS NOT: An inventory of ideas (those belong in <code>plans/</code>).</p>"},{"location":"ideas-synthesis/#the-creative-exploration-process","title":"The Creative Exploration Process","text":""},{"location":"ideas-synthesis/#origins-2025-12-13","title":"Origins (2025-12-13)","text":"<p>Fifteen creative exploration sessions generated 600+ ideas across 28 agent archetypes. This process used:</p> <ol> <li>Session-Based Exploration: Each session focused on one agent genus</li> <li>Priority Scoring: FUN + SHOWABLE + PRACTICAL - EFFORT = Priority</li> <li>Cross-Pollination: Final sessions combined agents into synergistic compositions</li> <li>Categorical Critique: Category theory lens applied to all ideas</li> </ol>"},{"location":"ideas-synthesis/#the-scoring-formula","title":"The Scoring Formula","text":"<pre><code>Priority = FUN + SHOWABLE + PRACTICAL - (EFFORT / 2)\n\nWhere:\n- FUN: 0-5 (How enjoyable to implement?)\n- SHOWABLE: 0-5 (How impressive to demonstrate?)\n- PRACTICAL: 0-5 (How useful day-to-day?)\n- EFFORT: 1-5 (How much work?)\n</code></pre> <p>Crown Jewels = Priority &gt;= 10.0 (the \"must ship\" features)</p>"},{"location":"ideas-synthesis/#from-ideas-to-plans","title":"From Ideas to Plans","text":"<p>Ideas generated in this process flow into the planning system:</p> <pre><code>Creative Session \u2192 Idea Inventory \u2192 Audit \u2192 Plan File \u2192 Implementation\n</code></pre>"},{"location":"ideas-synthesis/#assimilation-protocol","title":"Assimilation Protocol","text":"<p>When auditing ideas:</p> <ol> <li>Check Implementation Status: Is it already done?</li> <li>Cross-Reference Plans: Does a plan already cover this?</li> <li>Extract to Plans: Create plan file for unimplemented high-priority ideas</li> <li>Delete Inventory: Once ideas are in plans, delete the inventory file</li> </ol>"},{"location":"ideas-synthesis/#reference-documents-historical","title":"Reference Documents (Historical)","text":"<p>These files capture the output of the creative exploration process:</p> File Purpose Status <code>master-plan.md</code> Original orchestration doc Historical reference <code>categorical-critique.md</code> Category theory analysis Educational reference <code>cross-synergy.md</code> Cross-agent combinations Educational reference <code>developer-education.md</code> Onboarding guide Active documentation <code>execution-prompt.md</code> Prompt template for agents Tool <code>meta-construction.md</code> Emergent composition system Spec reference <code>metrics-reflection.md</code> Metrics framework Spec reference <code>qa-strategy.md</code> QA approach Active methodology"},{"location":"ideas-synthesis/#idea-inventory-files-deprecated","title":"Idea Inventory Files (DEPRECATED)","text":"<p>The following files have been assimilated into plans and should be deleted:</p> File Destination Action <code>crown-jewels.md</code> <code>plans/devex/cli-quick-wins-wave4.md</code> + already implemented DELETE <code>quick-wins.md</code> <code>plans/devex/cli-quick-wins-wave4.md</code> + already implemented DELETE <code>medium-complexity.md</code> <code>plans/devex/cli-quick-wins-wave4.md</code> + Agent Town DELETE"},{"location":"ideas-synthesis/#what-was-implemented","title":"What Was Implemented","text":"<p>From the original 600+ ideas:</p> Category Implemented Plan K-gent soul commands <code>kg soul vibe/drift/tense</code> K-gent Phase 1 (88 tests) Agent Town 7 citizens, coalitions, memory Agent Town Phase 4 (437 tests) AGENTESE REPL Full interactive navigation REPL Waves 1-3 (97 tests) Fuzzy matching Typo correction, suggestions REPL Wave 3 Session persistence Save/restore state REPL Wave 3"},{"location":"ideas-synthesis/#what-remains","title":"What Remains","text":"<p>Remaining high-value ideas extracted to <code>plans/devex/cli-quick-wins-wave4.md</code>: - H-gent thinking commands (<code>kg shadow</code>, <code>kg dialectic</code>) - Creative commands (<code>kg oblique</code>, <code>kg yes-and</code>) - Infrastructure commands (<code>kg parse</code>, <code>kg reality</code>) - Cross-pollination (<code>kg approve</code>)</p>"},{"location":"ideas-synthesis/#running-your-own-creative-session","title":"Running Your Own Creative Session","text":"<p>To generate new ideas:</p> <ol> <li>Pick an agent genus (e.g., H-gents for philosophical thinking)</li> <li>Brainstorm freely for 30-60 minutes</li> <li>Apply the scoring formula</li> <li>Extract Crown Jewels (priority &gt;= 10.0)</li> <li>Create plan files for winners</li> <li>Discard the inventory (ideas are in plans now)</li> </ol>"},{"location":"ideas-synthesis/#principles-from-specprinciplesmd","title":"Principles (from spec/principles.md)","text":"<ul> <li>Generativity: Status should derive from implementation, not documentation</li> <li>The Molasses Test: Can this file be deleted in 30 days?</li> <li>Aggressive Archiving: Ideas become plans or get deleted</li> </ul> <p>\"Ideas are free. Execution is expensive. Plans are the bridge.\"</p>"},{"location":"ideas-synthesis/developer-education/","title":"Developer Education Guide","text":"<p>\"The best documentation is the one you don't have to read.\"</p> <p>Audience: Kent (primary developer) Goal: Enable rapid understanding and extension of the system Format: Progressive disclosure (quick start \u2192 deep dive)</p>"},{"location":"ideas-synthesis/developer-education/#60-second-quick-start","title":"60-Second Quick Start","text":"<pre><code># Install (if not already)\nuv sync\n\n# Check your soul\nkg soul vibe\n\n# Parse something\nkg parse \"analyze this text for meaning\"\n\n# Get a dialectical synthesis\nkg dialectic \"move fast\" \"don't break things\"\n\n# See agent composition\nkg compose Ground &gt;&gt; Judge &gt;&gt; Sublate\n\n# Get creative inspiration\nkg oblique\n</code></pre> <p>That's it. You're using kgents.</p>"},{"location":"ideas-synthesis/developer-education/#5-minute-overview","title":"5-Minute Overview","text":""},{"location":"ideas-synthesis/developer-education/#what-is-kgents","title":"What is kgents?","text":"<p>A specification and implementation for tasteful, ethical, joy-inducing AI agents.</p>"},{"location":"ideas-synthesis/developer-education/#key-concepts","title":"Key Concepts","text":"Concept One-Liner Agent Genus Letter-coded agent families (K, H, U, P, J, I...) AGENTESE Verb-first protocol for agent-world interaction Eigenvectors Six dimensions of Kent's cognitive personality Bootstrap Agents 7 core agents (Id, Compose, Judge, Ground, Contradict, Sublate, Fix) Flux Event streaming for agent coordination"},{"location":"ideas-synthesis/developer-education/#the-agent-alphabet","title":"The Agent Alphabet","text":"<pre><code>A - Art/Creativity coaches\nB - Economics/Distillation\nC - Category Theory (composition)\nD - Data/State\nE - Evolution\nH - Thinking (Hegel, Jung, Lacan)\nI - Visualization\nJ - JIT Reality Classifier\nK - Kent simulacra (soul)\nM - Memory\nN - Narrative\nP - Parsing\nT - Testing\nU - Tools/MCP\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#the-six-eigenvectors","title":"The Six Eigenvectors","text":"<pre><code>Aesthetic:    0.15  (taste, beauty, craft)\nCategorical:  0.20  (structure, types, composition)\nGratitude:    0.15  (appreciation, acknowledgment)\nHeterarchy:   0.15  (non-hierarchical, network thinking)\nGenerativity: 0.20  (creation, emergence)\nJoy:          0.15  (delight, play, humor)\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#cli-reference","title":"CLI Reference","text":""},{"location":"ideas-synthesis/developer-education/#soul-commands-k-gent","title":"Soul Commands (K-gent)","text":"<pre><code># Get current soul vibe\nkg soul vibe\n# Output: { dominant: \"categorical\", confidence: 0.92, mood: \"contemplative\" }\n\n# Detect eigenvector drift\nkg soul drift\n# Output: Drift detected in 'aesthetic' (+0.05 over 7 days)\n\n# Find soul tensions\nkg soul tense\n# Output: Tension: categorical (0.20) vs joy (0.15)\n\n# Query from Kent's perspective\nkg soul ask \"Should I refactor this?\"\n# Output: { perspective: \"Kent would consider...\", confidence: 0.85 }\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#parsing-commands-p-gent","title":"Parsing Commands (P-gent)","text":"<pre><code># Parse with confidence\nkg parse \"analyze this\"\n# Output: { intent: \"analysis\", confidence: 0.87, domain: \"general\" }\n\n# Repair and parse broken input\nkg repair \"{ incomplete json\"\n# Output: { repaired: true, result: { ... }, confidence: 0.72 }\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#reality-classification-j-gent","title":"Reality Classification (J-gent)","text":"<pre><code># Classify reality type\nkg reality \"The system crashed after deploy\"\n# Output: { reality: Reality.EMPIRICAL, evidence: [\"crash\", \"deploy\"] }\n\n# Full analysis pipeline\nkg analyze \"optimize database queries\"\n# Output: Ground \u2192 Judge \u2192 Verdict pipeline result\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#thinking-commands-h-gent","title":"Thinking Commands (H-gent)","text":"<pre><code># Jungian shadow analysis\nkg shadow \"I hate legacy code\"\n# Output: { shadow: \"perfectionism\", projection: true, integration: \"...\" }\n\n# Dialectical synthesis\nkg dialectic \"move fast\" \"don't break things\"\n# Output: { synthesis: \"Move fast on reversible, careful on irreversible\" }\n\n# Lacanian gaps\nkg gaps \"I want to refactor everything\"\n# Output: { desire: \"control\", lack: \"certainty\", objet_a: \"perfect code\" }\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#visualization-commands-i-gent","title":"Visualization Commands (I-gent)","text":"<pre><code># Sparkline of metrics\nkg sparkline --metric cpu --window 1h\n\n# Weather report (system health)\nkg weather\n\n# Full dashboard\nkg dash\n\n# Living garden view\nkg garden\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#composition-commands-a-gent","title":"Composition Commands (A-gent)","text":"<pre><code># Compose agents\nkg compose Ground &gt;&gt; Judge &gt;&gt; Sublate\n\n# What-if exploration\nkg whatif \"merge these PRs together\"\n\n# Oblique strategy\nkg oblique\n# Output: \"Honor thy error as a hidden intention\"\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#cross-pollination-commands","title":"Cross-Pollination Commands","text":"<pre><code># Would Kent Approve?\nkg approve \"this code change\"\n\n# Full introspection (K + H pipeline)\nkg introspect\n\n# Memory as story\nkg remember --as-story --days 7\n\n# Ethical code review\nkg review --ethical path/to/diff\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#architecture-overview","title":"Architecture Overview","text":""},{"location":"ideas-synthesis/developer-education/#directory-structure","title":"Directory Structure","text":"<pre><code>kgents/\n\u251c\u2500\u2500 spec/                    # Language specification\n\u2502   \u251c\u2500\u2500 protocols/\n\u2502   \u2502   \u2514\u2500\u2500 agentese.md      # AGENTESE spec\n\u2502   \u2514\u2500\u2500 principles.md        # Core principles\n\u2502\n\u251c\u2500\u2500 impl/                    # Reference implementation\n\u2502   \u2514\u2500\u2500 claude/\n\u2502       \u251c\u2500\u2500 agents/          # Agent implementations\n\u2502       \u2502   \u251c\u2500\u2500 a/           # Art/Creativity\n\u2502       \u2502   \u251c\u2500\u2500 h/           # Thinking (Hegel, Jung, Lacan)\n\u2502       \u2502   \u251c\u2500\u2500 i/           # Visualization\n\u2502       \u2502   \u251c\u2500\u2500 k/           # Kent simulacra\n\u2502       \u2502   \u251c\u2500\u2500 p/           # Parsing\n\u2502       \u2502   \u251c\u2500\u2500 t/           # Testing\n\u2502       \u2502   \u2514\u2500\u2500 u/           # Tools\n\u2502       \u2502\n\u2502       \u251c\u2500\u2500 protocols/\n\u2502       \u2502   \u251c\u2500\u2500 agentese/    # AGENTESE impl (559 tests)\n\u2502       \u2502   \u2502   \u251c\u2500\u2500 contexts/\n\u2502       \u2502   \u2502   \u2502   \u251c\u2500\u2500 world.py\n\u2502       \u2502   \u2502   \u2502   \u251c\u2500\u2500 self_.py\n\u2502       \u2502   \u2502   \u2502   \u251c\u2500\u2500 concept.py\n\u2502       \u2502   \u2502   \u2502   \u251c\u2500\u2500 void.py\n\u2502       \u2502   \u2502   \u2502   \u2514\u2500\u2500 time_.py\n\u2502       \u2502   \u2502   \u2514\u2500\u2500 logos.py  # Central dispatch\n\u2502       \u2502   \u2502\n\u2502       \u2502   \u2514\u2500\u2500 cli/\n\u2502       \u2502       \u2514\u2500\u2500 handlers/ # CLI command handlers\n\u2502       \u2502\n\u2502       \u2514\u2500\u2500 flux/            # Event streaming\n\u2502\n\u251c\u2500\u2500 plans/                   # Planning documents\n\u2502   \u251c\u2500\u2500 skills/              # Reusable patterns\n\u2502   \u251c\u2500\u2500 ideas/               # Creative exploration\n\u2502   \u2502   \u2514\u2500\u2500 impl/            # Implementation plans\n\u2502   \u2514\u2500\u2500 _forest.md           # Forest Protocol index\n\u2502\n\u2514\u2500\u2500 tests/                   # Test suites\n    \u251c\u2500\u2500 unit/\n    \u251c\u2500\u2500 property/\n    \u251c\u2500\u2500 integration/\n    \u251c\u2500\u2500 adversarial/\n    \u2514\u2500\u2500 dialectic/\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#data-flow","title":"Data Flow","text":"<pre><code>User Input\n    \u2193\nCLI Handler (protocols/cli/handlers/*.py)\n    \u2193\nAGENTESE Dispatch (protocols/agentese/logos.py)\n    \u2193\nContext Resolution (world.*, self.*, concept.*, void.*, time.*)\n    \u2193\nAgent Execution (agents/*/)\n    \u2193\nFlux Event Stream (optional)\n    \u2193\nResponse Synthesis\n    \u2193\nOutput Formatting\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#key-files","title":"Key Files","text":"File Purpose <code>logos.py</code> Central AGENTESE dispatch <code>handlers/soul.py</code> Soul CLI commands <code>agents/k/eigenvectors.py</code> Eigenvector calculations <code>agents/k/garden.py</code> Memory garden <code>agents/h/thinking.py</code> Dialectical pipeline <code>agents/i/widgets/</code> TUI widget components"},{"location":"ideas-synthesis/developer-education/#extension-guide","title":"Extension Guide","text":""},{"location":"ideas-synthesis/developer-education/#adding-a-new-cli-command","title":"Adding a New CLI Command","text":"<ol> <li> <p>Create handler file: <pre><code># impl/claude/protocols/cli/handlers/mycommand.py\nfrom impl.claude.protocols.cli.handlers.base import BaseHandler\n\nclass MyCommandHandler(BaseHandler):\n    \"\"\"Handle the mycommand CLI command.\"\"\"\n\n    async def handle(self, args: Namespace) -&gt; int:\n        # Implementation here\n        result = await self.do_work(args)\n        self.output(result)\n        return 0\n</code></pre></p> </li> <li> <p>Register in CLI: <pre><code># impl/claude/protocols/cli/__init__.py\nfrom .handlers.mycommand import MyCommandHandler\n\nHANDLERS = {\n    # ... existing handlers\n    \"mycommand\": MyCommandHandler,\n}\n</code></pre></p> </li> <li> <p>Add tests: <pre><code># tests/unit/test_mycommand.py\nasync def test_mycommand_basic():\n    handler = MyCommandHandler()\n    result = await handler.handle(args)\n    assert result == 0\n</code></pre></p> </li> </ol>"},{"location":"ideas-synthesis/developer-education/#adding-a-new-agent","title":"Adding a New Agent","text":"<ol> <li> <p>Create agent directory: <pre><code>impl/claude/agents/x/\n\u251c\u2500\u2500 __init__.py\n\u251c\u2500\u2500 agent.py       # Main agent class\n\u251c\u2500\u2500 types.py       # Type definitions\n\u2514\u2500\u2500 _tests/\n    \u2514\u2500\u2500 test_x.py\n</code></pre></p> </li> <li> <p>Implement agent class: <pre><code># impl/claude/agents/x/agent.py\nfrom impl.claude.agents.base import BaseAgent\n\nclass XAgent(BaseAgent):\n    \"\"\"X-gent: Description of what it does.\"\"\"\n\n    async def invoke(self, input: XInput) -&gt; XOutput:\n        # Agent logic here\n        return XOutput(...)\n</code></pre></p> </li> <li> <p>Register with AGENTESE (if needed): <pre><code># impl/claude/protocols/agentese/contexts/self_.py\nasync def handle_self_x(path: str, umwelt: Umwelt) -&gt; Any:\n    \"\"\"Handle self.x.* paths.\"\"\"\n    agent = XAgent()\n    return await agent.invoke(...)\n</code></pre></p> </li> </ol>"},{"location":"ideas-synthesis/developer-education/#adding-a-new-widget","title":"Adding a New Widget","text":"<ol> <li> <p>Create widget file: <pre><code># impl/claude/agents/i/widgets/mywidget.py\nfrom textual.widget import Widget\n\nclass MyWidget(Widget):\n    \"\"\"Description of widget.\"\"\"\n\n    def compose(self) -&gt; ComposeResult:\n        yield Static(\"Content\")\n\n    def on_mount(self) -&gt; None:\n        # Setup code\n        pass\n</code></pre></p> </li> <li> <p>Add to widget exports: <pre><code># impl/claude/agents/i/widgets/__init__.py\nfrom .mywidget import MyWidget\n\n__all__ = [..., \"MyWidget\"]\n</code></pre></p> </li> <li> <p>Use in screen: <pre><code># impl/claude/agents/i/screens/myscreen.py\nfrom impl.claude.agents.i.widgets import MyWidget\n\nclass MyScreen(Screen):\n    def compose(self) -&gt; ComposeResult:\n        yield MyWidget()\n</code></pre></p> </li> </ol>"},{"location":"ideas-synthesis/developer-education/#adding-an-agentese-path","title":"Adding an AGENTESE Path","text":"<ol> <li> <p>Choose context (world, self, concept, void, time)</p> </li> <li> <p>Add handler: <pre><code># impl/claude/protocols/agentese/contexts/self_.py\nasync def handle_self_mypath(path: str, umwelt: Umwelt) -&gt; Any:\n    \"\"\"Handle self.mypath.* paths.\"\"\"\n    parts = path.split(\".\")\n\n    if parts[2] == \"manifest\":\n        return await manifest_mypath(umwelt)\n    elif parts[2] == \"witness\":\n        return await witness_mypath(umwelt)\n\n    raise UnknownPath(path)\n</code></pre></p> </li> <li> <p>Register in router: <pre><code># impl/claude/protocols/agentese/logos.py\nSELF_HANDLERS = {\n    # ... existing\n    \"mypath\": handle_self_mypath,\n}\n</code></pre></p> </li> </ol>"},{"location":"ideas-synthesis/developer-education/#common-patterns","title":"Common Patterns","text":""},{"location":"ideas-synthesis/developer-education/#pattern-agent-composition","title":"Pattern: Agent Composition","text":"<pre><code># Compose multiple agents into a pipeline\npipeline = compose(Ground(), Judge(), Sublate())\nresult = await pipeline.invoke(input)\n\n# Or using the &gt;&gt; operator\npipeline = Ground() &gt;&gt; Judge() &gt;&gt; Sublate()\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#pattern-flux-event-streaming","title":"Pattern: Flux Event Streaming","text":"<pre><code># Subscribe to events\nasync for event in flux.subscribe(\"soul.*\"):\n    match event.type:\n        case \"soul.vibe.changed\":\n            await handle_vibe_change(event)\n        case \"soul.drift.detected\":\n            await handle_drift(event)\n\n# Publish events\nawait flux.publish(SoulEvent(type=\"soul.vibe.changed\", data=new_vibe))\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#pattern-error-handling-with-reality","title":"Pattern: Error Handling with Reality","text":"<pre><code># Use J-gent reality classification for error handling\nreality = await j_gent.classify(result)\n\nmatch reality:\n    case Reality.NECESSARY:\n        # Certain - proceed confidently\n        return result.data\n    case Reality.EMPIRICAL:\n        # Likely - proceed with monitoring\n        return result.data, {\"monitor\": True}\n    case Reality.CHAOTIC:\n        # Uncertain - fall back to ground\n        return await ground.invoke(VOID)\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#pattern-dialectical-resolution","title":"Pattern: Dialectical Resolution","text":"<pre><code># Use H-gent for contradiction resolution\nthesis = user_position\nantithesis = await contradict.detect(thesis)\nsynthesis = await sublate.resolve(thesis, antithesis)\n\n# Result includes aufheben analysis\nprint(f\"Preserved: {synthesis.preserved}\")\nprint(f\"Negated: {synthesis.negated}\")\nprint(f\"Elevated: {synthesis.elevated}\")\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#debugging-tips","title":"Debugging Tips","text":""},{"location":"ideas-synthesis/developer-education/#enable-verbose-logging","title":"Enable Verbose Logging","text":"<pre><code># Set log level\nexport KGENTS_LOG_LEVEL=DEBUG\n\n# Or per-command\nkg soul vibe --verbose\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#trace-agentese-paths","title":"Trace AGENTESE Paths","text":"<pre><code># Trace path resolution\nkg trace \"self.soul.vibe\"\n# Output: self.soul.vibe \u2192 handle_self_soul \u2192 eigenvector_calculation \u2192 vibe_synthesis\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#inspect-agent-state","title":"Inspect Agent State","text":"<pre><code># In Python REPL\nfrom impl.claude.agents.k import KgentAgent\n\nkgent = KgentAgent.from_context(ctx)\nprint(kgent.state)\nprint(kgent.eigenvectors)\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#test-in-isolation","title":"Test in Isolation","text":"<pre><code># Run single test\nuv run pytest tests/unit/test_soul.py::test_vibe_calculation -v\n\n# Run with pdb on failure\nuv run pytest --pdb tests/unit/test_soul.py\n</code></pre>"},{"location":"ideas-synthesis/developer-education/#glossary","title":"Glossary","text":"Term Definition Agent Autonomous unit with specific capabilities AGENTESE Verb-first protocol for agent interaction Aufheben Dialectical operation: preserve, negate, elevate Bootstrap The 7 core agents that self-ground Chrysalis Agent in metamorphosis state Eigenvector Dimension of Kent's cognitive personality Flux Event streaming system for agent coordination Ground Bootstrap agent providing factual foundation Handle AGENTESE morphism: Observer \u2192 Interaction Holographic Memory model where each part contains the whole Logos Central AGENTESE dispatch system Stigmergic Indirect coordination through environment Sublate Bootstrap agent for dialectical synthesis Umwelt Observer's perceptual world"},{"location":"ideas-synthesis/developer-education/#faq","title":"FAQ","text":"<p>Q: Where do I start? A: Run <code>kg soul vibe</code> and <code>kg oblique</code>. Explore from there.</p> <p>Q: How do I add a new command? A: See Extension Guide \u2192 Adding a New CLI Command.</p> <p>Q: What's the fastest way to understand the architecture? A: Read <code>logos.py</code> (central dispatch) and <code>handlers/soul.py</code> (example handler).</p> <p>Q: How do tests work? A: Five types (Unit, Property, Integration, Adversarial, Dialectic). Run <code>uv run pytest</code>.</p> <p>Q: Where are the eigenvectors defined? A: <code>impl/claude/agents/k/eigenvectors.py</code></p> <p>Q: How does AGENTESE work? A: Paths like <code>self.soul.vibe</code> dispatch through <code>logos.py</code> to context handlers.</p>"},{"location":"ideas-synthesis/developer-education/#resources","title":"Resources","text":"<ul> <li><code>spec/protocols/agentese.md</code> - AGENTESE specification</li> <li><code>spec/principles.md</code> - Core principles</li> <li><code>plans/skills/</code> - Reusable patterns</li> <li><code>plans/ideas/impl/</code> - Implementation plans</li> <li><code>CLAUDE.md</code> - Project overview</li> </ul> <p>\"Documentation is a love letter to your future self.\"</p>"},{"location":"ideas-synthesis/execution-prompt/","title":"Enhanced Execution Prompt: Meta-Construction Implementation","text":"<p>You are implementing the kgents meta-construction system. Your goal is to shift from enumerated ideas to generative machinery while maintaining backward compatibility with existing DevEx infrastructure.</p>"},{"location":"ideas-synthesis/execution-prompt/#source-documents-read-these-first","title":"Source Documents (Read These First)","text":""},{"location":"ideas-synthesis/execution-prompt/#categorical-foundation","title":"Categorical Foundation","text":"<ul> <li><code>plans/ideas/impl/categorical-critique.md</code> - Analysis of what's missing</li> <li><code>plans/ideas/impl/meta-construction.md</code> - The generative solution</li> <li><code>docs/categorical-foundations.md</code> - Existing categorical basis</li> </ul>"},{"location":"ideas-synthesis/execution-prompt/#legacy-implementation-plans","title":"Legacy Implementation Plans","text":"<ul> <li><code>plans/ideas/impl/master-plan.md</code> - 11-phase lifecycle</li> <li><code>plans/ideas/impl/quick-wins.md</code> - 70+ CLI commands</li> <li><code>plans/ideas/impl/crown-jewels.md</code> - 45+ top ideas</li> <li><code>plans/ideas/impl/cross-synergy.md</code> - Agent combinations</li> </ul>"},{"location":"ideas-synthesis/execution-prompt/#devex-infrastructure-already-working","title":"DevEx Infrastructure (Already Working)","text":"<ul> <li><code>impl/claude/protocols/cli/devex/</code> - Ghost, Flinch, HYDRATE</li> <li><code>impl/claude/infra/ghost/</code> - Daemon, collectors, health</li> <li><code>impl/claude/protocols/cli/handlers/ghost.py</code> - <code>kgents ghost</code></li> <li><code>impl/claude/protocols/cli/handlers/flinch.py</code> - <code>kgents flinch</code></li> </ul>"},{"location":"ideas-synthesis/execution-prompt/#two-implementation-tracks","title":"Two Implementation Tracks","text":""},{"location":"ideas-synthesis/execution-prompt/#track-a-legacy-cli-first-parallel-with-track-b","title":"Track A: Legacy (CLI-First) \u2014 Parallel with Track B","text":"<p>Continue implementing the 70+ quick wins and crown jewels as CLI commands. This provides immediate value while Track B builds the generative foundation.</p> <pre><code>Sprint 1-2: K-gent Soul CLI\n  - kg soul vibe, kg soul drift, kg soul shadow\n  - Wire to existing eigenvector infrastructure\n\nSprint 3-4: Infrastructure CLI\n  - kg parse, kg reality, kg analyze\n  - Wire to P-gent, J-gent\n\nSprint 5-6: Cross-Pollination\n  - kg approve (\"Would Kent Approve?\")\n  - kg introspect (K + H pipeline)\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#track-b-generative-spec-first-the-meta-construction","title":"Track B: Generative (Spec-First) \u2014 The Meta-Construction","text":"<p>Build the machinery that generates agents, not agents themselves.</p> <pre><code>Phase 1: Polynomial Primitives\n  - Convert Agent[A,B] to PolyAgent[S,A,B]\n  - Add positions, directions, transitions\n  - File: impl/claude/agents/poly/\n\nPhase 2: Universal Operad\n  - Define Operad dataclass\n  - Implement seq, par, branch, fix, trace\n  - File: impl/claude/agents/operad/\n\nPhase 3: Domain Operads\n  - SOUL_OPERAD, PARSE_OPERAD, REALITY_OPERAD\n  - Auto-generate CLI from operads\n  - File: impl/claude/agents/operad/domains/\n\nPhase 4: Sheaf Emergence\n  - AgentSheaf with restrict/glue\n  - SOUL_SHEAF over eigenvectors\n  - File: impl/claude/agents/sheaf/\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#devex-integration-points","title":"DevEx Integration Points","text":""},{"location":"ideas-synthesis/execution-prompt/#ghost-sensorium-use-this","title":"Ghost Sensorium (Use This)","text":"<p>Project meta-construction health to <code>.kgents/ghost/</code>:</p> <pre><code># Extend ghost daemon with meta collector\nclass MetaGhostCollector(GhostCollector):\n    async def collect(self) -&gt; CollectorResult:\n        return CollectorResult(\n            success=True,\n            data={\n                \"primitives\": len(PRIMITIVES),\n                \"operads\": list(OPERAD_REGISTRY),\n                \"compositions_generated\": composition_count,\n            }\n        )\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#flinch-system-wire-test-failures","title":"Flinch System (Wire Test Failures)","text":"<p>All operad law violations should register as flinches:</p> <pre><code># When operad law fails\nflinch_store.record(FlinchRecord(\n    nodeid=\"operad::associativity\",\n    error_type=\"LawViolation\",\n    message=\"seq(seq(a,b),c) \u2260 seq(a,seq(b,c))\"\n))\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#hydrate-signals-track-progress","title":"HYDRATE Signals (Track Progress)","text":"<pre><code>append_hydrate_signal(HydrateEvent.CUSTOM, \"Phase 2: Operad complete, 5 ops defined\")\nappend_hydrate_signal(HydrateEvent.TEST_RUN, \"Operad laws: 12 passed, 0 failed\")\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#parallel-agent-strategy","title":"Parallel Agent Strategy","text":""},{"location":"ideas-synthesis/execution-prompt/#agent-1-polynomial-foundation","title":"Agent 1: Polynomial Foundation","text":"<pre><code>Focus: impl/claude/agents/poly/\nTasks:\n  - PolyAgent protocol (positions, directions, transitions)\n  - Convert 7 bootstrap agents\n  - Wiring diagram composition\nTests: Type I (unit) + Type II (property laws)\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#agent-2-operad-infrastructure","title":"Agent 2: Operad Infrastructure","text":"<pre><code>Focus: impl/claude/agents/operad/\nTasks:\n  - Operad dataclass\n  - Universal operations (seq, par, branch, fix, trace)\n  - Law verification at runtime\nTests: Type I + Type V (dialectic for laws)\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#agent-3-domain-operads-cli-generation","title":"Agent 3: Domain Operads + CLI Generation","text":"<pre><code>Focus: impl/claude/agents/operad/domains/\nTasks:\n  - SOUL_OPERAD, PARSE_OPERAD, REALITY_OPERAD\n  - CLIAlgebra functor\n  - Auto-register handlers from operad\nTests: Type III (integration)\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#agent-4-sheaf-emergence","title":"Agent 4: Sheaf Emergence","text":"<pre><code>Focus: impl/claude/agents/sheaf/\nTasks:\n  - AgentSheaf protocol\n  - SOUL_SHEAF over eigenvector contexts\n  - Gluing verification\nTests: Type I + emergence verification\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#agent-5-devex-ghost-integration","title":"Agent 5: DevEx + Ghost Integration","text":"<pre><code>Focus: impl/claude/infra/ghost/\nTasks:\n  - MetaGhostCollector\n  - Operad health projection\n  - Flinch integration for law violations\nTests: Type III (integration with daemon)\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#key-implementation-patterns","title":"Key Implementation Patterns","text":""},{"location":"ideas-synthesis/execution-prompt/#pattern-1-polynomial-agent","title":"Pattern 1: Polynomial Agent","text":"<pre><code>@dataclass(frozen=True)\nclass PolyAgent(Generic[S, A, B]):\n    name: str\n    positions: FrozenSet[S]\n    directions: Callable[[S], FrozenSet[A]]\n    transition: Callable[[S, A], tuple[S, B]]\n\n    def invoke(self, state: S, input: A) -&gt; tuple[S, B]:\n        assert state in self.positions\n        assert input in self.directions(state)\n        return self.transition(state, input)\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#pattern-2-operad-definition","title":"Pattern 2: Operad Definition","text":"<pre><code>@dataclass\nclass Operad:\n    name: str\n    operations: dict[str, Operation]\n    laws: list[str]\n\n    def compose(self, op: str, *agents) -&gt; PolyAgent:\n        return self.operations[op].compose(*agents)\n\n    def verify_laws(self) -&gt; bool:\n        # Runtime law verification\n        ...\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#pattern-3-cli-from-operad","title":"Pattern 3: CLI from Operad","text":"<pre><code>class CLIAlgebra:\n    def __init__(self, operad: Operad):\n        self.operad = operad\n\n    def to_cli(self, op_name: str) -&gt; CLIHandler:\n        # Automatic handler generation\n        ...\n\n    def register_all(self, cli: CLI) -&gt; None:\n        for op in self.operad.operations:\n            cli.register(f\"kg {self.operad.name} {op}\", self.to_cli(op))\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#pattern-4-sheaf-gluing","title":"Pattern 4: Sheaf Gluing","text":"<pre><code>class AgentSheaf:\n    def restrict(self, agent: PolyAgent, ctx: Context) -&gt; PolyAgent:\n        # Restrict to subcontext\n        ...\n\n    def glue(self, locals: dict[Context, PolyAgent]) -&gt; PolyAgent:\n        # Verify compatibility, then glue\n        assert self.compatible(locals)\n        return self._glue_impl(locals)\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#testing-strategy","title":"Testing Strategy","text":""},{"location":"ideas-synthesis/execution-prompt/#operad-law-tests-type-v-dialectic","title":"Operad Law Tests (Type V - Dialectic)","text":"<pre><code>@pytest.mark.parametrize(\"a,b,c\", agent_triples)\ndef test_associativity(a, b, c):\n    \"\"\"seq(seq(a,b),c) = seq(a,seq(b,c))\"\"\"\n    left = operad.compose(\"seq\", operad.compose(\"seq\", a, b), c)\n    right = operad.compose(\"seq\", a, operad.compose(\"seq\", b, c))\n    assert agents_equivalent(left, right)\n\ndef test_identity():\n    \"\"\"seq(id, a) = a = seq(a, id)\"\"\"\n    for a in primitives:\n        assert agents_equivalent(operad.compose(\"seq\", ID, a), a)\n        assert agents_equivalent(operad.compose(\"seq\", a, ID), a)\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#sheaf-gluing-tests","title":"Sheaf Gluing Tests","text":"<pre><code>def test_compatible_gluing():\n    \"\"\"Compatible local agents glue successfully.\"\"\"\n    locals = {ctx: restrict(soul, ctx) for ctx in contexts}\n    global_soul = sheaf.glue(locals)\n    assert global_soul is not None\n\ndef test_incompatible_rejection():\n    \"\"\"Incompatible local agents fail to glue.\"\"\"\n    incompatible = {\"ctx1\": agent_a, \"ctx2\": agent_b}  # Disagree on overlap\n    with pytest.raises(GluingError):\n        sheaf.glue(incompatible)\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#success-criteria","title":"Success Criteria","text":"Criterion Target Verification Polynomial primitives 13+ agents converted Unit tests Universal operad 5 operations (seq, par, branch, fix, trace) Law tests Domain operads 3+ (Soul, Parse, Reality) Integration tests CLI auto-generation 10+ handlers from operad E2E tests Sheaf emergence Soul emergence working Gluing tests DevEx integration Ghost projects operad health Daemon test Chaos composition 100+ valid random agents Property tests"},{"location":"ideas-synthesis/execution-prompt/#file-structure-after-implementation","title":"File Structure After Implementation","text":"<pre><code>impl/claude/agents/\n\u251c\u2500\u2500 poly/\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 protocol.py        # PolyAgent definition\n\u2502   \u251c\u2500\u2500 primitives.py      # 13 polynomial primitives\n\u2502   \u251c\u2500\u2500 wiring.py          # Wiring diagram composition\n\u2502   \u2514\u2500\u2500 _tests/\n\u2502\n\u251c\u2500\u2500 operad/\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 core.py            # Operad, Operation dataclasses\n\u2502   \u251c\u2500\u2500 universal.py       # AGENT_OPERAD\n\u2502   \u251c\u2500\u2500 algebra.py         # CLIAlgebra functor\n\u2502   \u251c\u2500\u2500 domains/\n\u2502   \u2502   \u251c\u2500\u2500 soul.py        # SOUL_OPERAD\n\u2502   \u2502   \u251c\u2500\u2500 parse.py       # PARSE_OPERAD\n\u2502   \u2502   \u2514\u2500\u2500 reality.py     # REALITY_OPERAD\n\u2502   \u2514\u2500\u2500 _tests/\n\u2502       \u251c\u2500\u2500 test_laws.py   # Operad law verification\n\u2502       \u2514\u2500\u2500 test_algebra.py\n\u2502\n\u251c\u2500\u2500 sheaf/\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 protocol.py        # AgentSheaf definition\n\u2502   \u251c\u2500\u2500 soul_sheaf.py      # SOUL_SHEAF\n\u2502   \u2514\u2500\u2500 _tests/\n\u2502       \u2514\u2500\u2500 test_emergence.py\n\u2502\n\u2514\u2500\u2500 existing agents (k/, h/, u/, p/, etc.)\n</code></pre>"},{"location":"ideas-synthesis/execution-prompt/#the-fundamental-shift","title":"The Fundamental Shift","text":"<p>Before: 600 ideas \u2192 implement each \u2192 600 CLI commands After: Operad + Primitives \u2192 generate \u2192 \u221e valid compositions</p> <p>The operad guarantees validity. The sheaf enables emergence. The void.* provides chaos.</p> <p>Careful design OR chaotic happenstance \u2192 valid agents.</p>"},{"location":"ideas-synthesis/execution-prompt/#commands-to-verify-progress","title":"Commands to Verify Progress","text":"<pre><code># Check polynomial primitives\nuv run pytest impl/claude/agents/poly/_tests/ -v\n\n# Check operad laws\nuv run pytest impl/claude/agents/operad/_tests/test_laws.py -v\n\n# Check sheaf emergence\nuv run pytest impl/claude/agents/sheaf/_tests/test_emergence.py -v\n\n# Check auto-generated CLI\nkg soul introspect  # Should work from operad\n\n# Check ghost projection\nkgents ghost --show  # Should include meta.json\n\n# Full test suite\nuv run pytest --cov=impl --cov-report=html\n</code></pre> <p>\"Build the grammar, not the sentences.\"</p>"},{"location":"ideas-synthesis/meta-construction/","title":"Meta-Construction System: Primitives \u2192 Emergence","text":"<p>\"Don't build agents. Build the machine that builds agents.\"</p> <p>Purpose: Replace 600+ enumerated ideas with generative machinery Theory: Polynomial functors + Operads + Sheaves Outcome: Careful design OR chaotic happenstance \u2192 valid compositions</p>"},{"location":"ideas-synthesis/meta-construction/#the-vision","title":"The Vision","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     META-CONSTRUCTION SYSTEM                             \u2502\n\u2502                                                                          \u2502\n\u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                     \u2502\n\u2502    \u2502PRIMITIVES\u2502  +   \u2502 OPERADS  \u2502  +   \u2502 SHEAVES  \u2502  =  EMERGENCE       \u2502\n\u2502    \u2502(atoms)   \u2502      \u2502(grammar) \u2502      \u2502(gluing)  \u2502                     \u2502\n\u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                     \u2502\n\u2502         \u2502                 \u2502                 \u2502                            \u2502\n\u2502         \u25bc                 \u25bc                 \u25bc                            \u2502\n\u2502    Base agents      Composition       Local \u2192 Global                    \u2502\n\u2502    Types            rules             behavior                           \u2502\n\u2502    Operations       Wiring            Emergence                          \u2502\n\u2502                                                                          \u2502\n\u2502    \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500         \u2502\n\u2502                            \u2193                                             \u2502\n\u2502                      TWO PATHS                                           \u2502\n\u2502              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                               \u2502\n\u2502              \u2502                          \u2502                               \u2502\n\u2502         Careful Design          Chaotic Happenstance                    \u2502\n\u2502         (intentional)           (void.* entropy)                        \u2502\n\u2502              \u2502                          \u2502                               \u2502\n\u2502              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                               \u2502\n\u2502                         \u25bc                                                \u2502\n\u2502                  VALID COMPOSITION                                       \u2502\n\u2502              (operad guarantees validity)                               \u2502\n\u2502                                                                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#layer-1-primitives-the-atoms","title":"Layer 1: Primitives (The Atoms)","text":""},{"location":"ideas-synthesis/meta-construction/#primitive-agent-protocol","title":"Primitive Agent Protocol","text":"<p>Every primitive agent is a polynomial functor:</p> <pre><code>from dataclasses import dataclass\nfrom typing import Generic, TypeVar, Callable, FrozenSet\n\nS = TypeVar(\"S\")  # State/Position\nA = TypeVar(\"A\")  # Input/Direction\nB = TypeVar(\"B\")  # Output\n\n@dataclass(frozen=True)\nclass PolyAgent(Generic[S, A, B]):\n    \"\"\"\n    Agent as polynomial functor.\n\n    P(y) = \u03a3_{s \u2208 positions} y^{directions(s)}\n\n    Following Spivak's \"Polynomial Functors: A Mathematical Theory of Interaction\"\n    \"\"\"\n    name: str\n    positions: FrozenSet[S]\n    directions: Callable[[S], FrozenSet[A]]\n    transition: Callable[[S, A], tuple[S, B]]\n\n    def invoke(self, state: S, input: A) -&gt; tuple[S, B]:\n        \"\"\"Execute one step of the dynamical system.\"\"\"\n        assert state in self.positions, f\"Invalid state: {state}\"\n        assert input in self.directions(state), f\"Invalid input {input} for state {state}\"\n        return self.transition(state, input)\n\n    def run(self, initial: S, inputs: list[A]) -&gt; tuple[S, list[B]]:\n        \"\"\"Run the system through a sequence of inputs.\"\"\"\n        state = initial\n        outputs = []\n        for inp in inputs:\n            state, out = self.invoke(state, inp)\n            outputs.append(out)\n        return state, outputs\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#the-primitive-catalog","title":"The Primitive Catalog","text":"<pre><code># Layer 1 Primitives: The 13 Atoms\n\nPRIMITIVES = {\n    # Bootstrap (7)\n    \"id\": PolyAgent(\n        name=\"Id\",\n        positions=frozenset({\"ready\"}),\n        directions=lambda s: frozenset({Any}),\n        transition=lambda s, x: (\"ready\", x)\n    ),\n    \"ground\": PolyAgent(\n        name=\"Ground\",\n        positions=frozenset({\"grounded\", \"floating\"}),\n        directions=lambda s: frozenset({Query, Void}),\n        transition=ground_transition\n    ),\n    \"judge\": PolyAgent(\n        name=\"Judge\",\n        positions=frozenset({\"deliberating\", \"decided\"}),\n        directions=lambda s: frozenset({Claim}) if s == \"deliberating\" else frozenset(),\n        transition=judge_transition\n    ),\n    \"contradict\": PolyAgent(\n        name=\"Contradict\",\n        positions=frozenset({\"seeking\", \"found\"}),\n        directions=lambda s: frozenset({Thesis}),\n        transition=contradict_transition\n    ),\n    \"sublate\": PolyAgent(\n        name=\"Sublate\",\n        positions=frozenset({\"analyzing\", \"synthesized\"}),\n        directions=lambda s: frozenset({Contradiction}),\n        transition=sublate_transition\n    ),\n    \"compose\": PolyAgent(\n        name=\"Compose\",\n        positions=frozenset({\"ready\"}),\n        directions=lambda s: frozenset({AgentPair}),\n        transition=compose_transition\n    ),\n    \"fix\": PolyAgent(\n        name=\"Fix\",\n        positions=frozenset({\"trying\", \"succeeded\", \"failed\"}),\n        directions=fix_directions,\n        transition=fix_transition\n    ),\n\n    # Perception (3)\n    \"manifest\": PolyAgent(\n        name=\"Manifest\",\n        positions=frozenset({\"observing\"}),\n        directions=lambda s: frozenset({Handle, Umwelt}),\n        transition=manifest_transition\n    ),\n    \"witness\": PolyAgent(\n        name=\"Witness\",\n        positions=frozenset({\"recording\", \"replaying\"}),\n        directions=witness_directions,\n        transition=witness_transition\n    ),\n    \"lens\": PolyAgent(\n        name=\"Lens\",\n        positions=frozenset({\"focused\"}),\n        directions=lambda s: frozenset({Agent, Selector}),\n        transition=lens_transition\n    ),\n\n    # Entropy (3)\n    \"sip\": PolyAgent(\n        name=\"Sip\",\n        positions=frozenset({\"thirsty\", \"sated\"}),\n        directions=lambda s: frozenset({EntropyRequest}) if s == \"thirsty\" else frozenset(),\n        transition=sip_transition\n    ),\n    \"tithe\": PolyAgent(\n        name=\"Tithe\",\n        positions=frozenset({\"owing\", \"paid\"}),\n        directions=lambda s: frozenset({Offering}) if s == \"owing\" else frozenset(),\n        transition=tithe_transition\n    ),\n    \"define\": PolyAgent(\n        name=\"Define\",\n        positions=frozenset({\"creating\"}),\n        directions=lambda s: frozenset({Spec}),\n        transition=define_transition\n    ),\n}\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#primitive-properties","title":"Primitive Properties","text":"<p>Every primitive satisfies:</p> <ol> <li>Finite positions: State space is enumerable</li> <li>Type-indexed directions: Inputs depend on current state</li> <li>Deterministic transitions: Same state + input \u2192 same output</li> <li>Composable interface: Compatible with operad operations</li> </ol>"},{"location":"ideas-synthesis/meta-construction/#layer-2-operads-the-grammar","title":"Layer 2: Operads (The Grammar)","text":""},{"location":"ideas-synthesis/meta-construction/#the-agent-operad","title":"The Agent Operad","text":"<pre><code>from dataclasses import dataclass\nfrom typing import Callable, Any\n\n@dataclass\nclass Operation:\n    \"\"\"An operation in the operad.\"\"\"\n    name: str\n    arity: int  # Number of inputs\n    signature: str  # Type signature\n    compose: Callable[..., PolyAgent]  # Composition function\n\n@dataclass\nclass Operad:\n    \"\"\"\n    Grammar of composition.\n\n    Following \"Operads for Complex System Design\" (Spivak et al.)\n    \"\"\"\n    name: str\n    operations: dict[str, Operation]\n    laws: list[str]  # Equations that must hold\n\n    def compose(self, op_name: str, *agents: PolyAgent) -&gt; PolyAgent:\n        \"\"\"Apply an operation to agents.\"\"\"\n        op = self.operations[op_name]\n        assert len(agents) == op.arity, f\"{op_name} requires {op.arity} agents\"\n        return op.compose(*agents)\n\n    def enumerate(self, primitives: list[PolyAgent], depth: int) -&gt; list[PolyAgent]:\n        \"\"\"Generate all valid compositions up to given depth.\"\"\"\n        results = list(primitives)  # Depth 0\n        for d in range(1, depth + 1):\n            for op in self.operations.values():\n                for combo in combinations_with_replacement(results, op.arity):\n                    try:\n                        composed = op.compose(*combo)\n                        if composed not in results:\n                            results.append(composed)\n                    except TypeError:\n                        pass  # Type mismatch, skip\n        return results\n\n\n# The Universal Agent Operad\nAGENT_OPERAD = Operad(\n    name=\"AgentOperad\",\n    operations={\n        \"seq\": Operation(\n            name=\"seq\",\n            arity=2,\n            signature=\"Agent[A,B] \u00d7 Agent[B,C] \u2192 Agent[A,C]\",\n            compose=sequential_compose\n        ),\n        \"par\": Operation(\n            name=\"par\",\n            arity=2,  # Can be n-ary via currying\n            signature=\"Agent[A,B] \u00d7 Agent[A,C] \u2192 Agent[A, (B,C)]\",\n            compose=parallel_compose\n        ),\n        \"branch\": Operation(\n            name=\"branch\",\n            arity=3,\n            signature=\"Pred[A] \u00d7 Agent[A,B] \u00d7 Agent[A,B] \u2192 Agent[A,B]\",\n            compose=branch_compose\n        ),\n        \"fix\": Operation(\n            name=\"fix\",\n            arity=2,\n            signature=\"Pred[B] \u00d7 Agent[A,B] \u2192 Agent[A,B]\",\n            compose=fix_compose\n        ),\n        \"trace\": Operation(\n            name=\"trace\",\n            arity=1,\n            signature=\"Agent[A,B] \u2192 Agent[A,B] (with observation)\",\n            compose=trace_compose\n        ),\n    },\n    laws=[\n        # Associativity\n        \"seq(seq(a, b), c) = seq(a, seq(b, c))\",\n        \"par(par(a, b), c) = par(a, par(b, c))\",\n\n        # Identity\n        \"seq(id, a) = a\",\n        \"seq(a, id) = a\",\n\n        # Distributivity\n        \"seq(branch(p, a, b), c) = branch(p, seq(a, c), seq(b, c))\",\n\n        # Trace naturality\n        \"seq(trace(a), b) = trace(seq(a, b))\",\n    ]\n)\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#domain-specific-operads","title":"Domain-Specific Operads","text":"<pre><code># Soul Operad (K-gent compositions)\nSOUL_OPERAD = Operad(\n    name=\"SoulOperad\",\n    operations=AGENT_OPERAD.operations | {\n        \"introspect\": Operation(\n            name=\"introspect\",\n            arity=0,\n            signature=\"() \u2192 Agent[Query, SoulInsight]\",\n            compose=lambda: seq(PRIMITIVES[\"ground\"], seq(PRIMITIVES[\"manifest\"], PRIMITIVES[\"witness\"]))\n        ),\n        \"shadow\": Operation(\n            name=\"shadow\",\n            arity=1,\n            signature=\"Agent[A, Thesis] \u2192 Agent[A, Shadow]\",\n            compose=lambda a: seq(a, seq(PRIMITIVES[\"contradict\"], jungian_project))\n        ),\n        \"dialectic\": Operation(\n            name=\"dialectic\",\n            arity=2,\n            signature=\"Agent[A, Thesis] \u00d7 Agent[A, Antithesis] \u2192 Agent[A, Synthesis]\",\n            compose=lambda t, a: seq(par(t, a), PRIMITIVES[\"sublate\"])\n        ),\n    },\n    laws=AGENT_OPERAD.laws + [\n        \"shadow(dialectic(t, a)) = dialectic(shadow(t), shadow(a))\",\n    ]\n)\n\n# Parse Operad (P-gent compositions)\nPARSE_OPERAD = Operad(\n    name=\"ParseOperad\",\n    operations=AGENT_OPERAD.operations | {\n        \"confident\": Operation(\n            name=\"confident\",\n            arity=1,\n            signature=\"Agent[str, ParseResult] \u2192 Agent[str, ConfidentParse]\",\n            compose=lambda p: trace(seq(p, confidence_annotate))\n        ),\n        \"repair\": Operation(\n            name=\"repair\",\n            arity=2,\n            signature=\"Agent[str, ParseResult] \u00d7 Agent[Error, str] \u2192 Agent[str, ParseResult]\",\n            compose=lambda p, r: fix(lambda x: x.confidence &gt; 0.5, seq(p, branch(is_error, r, id)))\n        ),\n    },\n    laws=AGENT_OPERAD.laws\n)\n\n# Reality Operad (J-gent compositions)\nREALITY_OPERAD = Operad(\n    name=\"RealityOperad\",\n    operations=AGENT_OPERAD.operations | {\n        \"classify\": Operation(\n            name=\"classify\",\n            arity=1,\n            signature=\"Agent[A, Claim] \u2192 Agent[A, Reality]\",\n            compose=lambda c: seq(c, reality_classifier)\n        ),\n        \"collapse\": Operation(\n            name=\"collapse\",\n            arity=2,\n            signature=\"Agent[A, B] \u00d7 Agent[Chaotic, B] \u2192 Agent[A, B]\",\n            compose=lambda a, fallback: branch(\n                lambda x: reality_classifier(x) != Reality.CHAOTIC,\n                a,\n                seq(const(VOID), fallback)\n            )\n        ),\n    },\n    laws=AGENT_OPERAD.laws\n)\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#operad-algebras-cli-commands","title":"Operad Algebras = CLI Commands","text":"<p>The CLI is an O-algebra: a functor from operad to implementation.</p> <pre><code>class CLIAlgebra:\n    \"\"\"\n    Functor: Operad \u2192 CLI Commands\n\n    Each operad operation becomes a CLI handler.\n    \"\"\"\n\n    def __init__(self, operad: Operad):\n        self.operad = operad\n\n    def to_cli(self, op_name: str) -&gt; CLIHandler:\n        \"\"\"Convert operad operation to CLI handler.\"\"\"\n        op = self.operad.operations[op_name]\n\n        async def handler(args: Namespace) -&gt; int:\n            # Parse inputs from args\n            agent_inputs = self.parse_args(args, op.arity)\n            # Compose using operad\n            composed = self.operad.compose(op_name, *agent_inputs)\n            # Execute\n            result = composed.run(initial_state, args.input)\n            # Output\n            print(format_result(result))\n            return 0\n\n        return handler\n\n    def register_all(self, cli: CLI) -&gt; None:\n        \"\"\"Register all operad operations as CLI commands.\"\"\"\n        for op_name in self.operad.operations:\n            cli.register(\n                f\"kg {self.operad.name.lower().replace('operad', '')} {op_name}\",\n                self.to_cli(op_name)\n            )\n\n# Usage: Automatic CLI generation\nsoul_cli = CLIAlgebra(SOUL_OPERAD)\nsoul_cli.register_all(kg_cli)\n# Creates: kg soul introspect, kg soul shadow, kg soul dialectic\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#layer-3-sheaves-emergence","title":"Layer 3: Sheaves (Emergence)","text":""},{"location":"ideas-synthesis/meta-construction/#the-agent-sheaf","title":"The Agent Sheaf","text":"<pre><code>from dataclasses import dataclass\nfrom typing import Dict, TypeVar, Generic\n\nCtx = TypeVar(\"Ctx\")  # Context type\n\n@dataclass\nclass AgentSheaf(Generic[Ctx]):\n    \"\"\"\n    Sheaf structure for emergent behavior.\n\n    Local agents (per-context) glue into global agent.\n    Following Mac Lane &amp; Moerdijk's \"Sheaves in Geometry and Logic\"\n    \"\"\"\n    contexts: set[Ctx]\n    overlap: Callable[[Ctx, Ctx], Ctx | None]  # Intersection of contexts\n\n    def restrict(self, agent: PolyAgent, subcontext: Ctx) -&gt; PolyAgent:\n        \"\"\"Restrict agent behavior to subcontext.\"\"\"\n        restricted_positions = frozenset(\n            s for s in agent.positions\n            if self.position_in_context(s, subcontext)\n        )\n        return PolyAgent(\n            name=f\"{agent.name}|{subcontext}\",\n            positions=restricted_positions,\n            directions=lambda s: agent.directions(s) if s in restricted_positions else frozenset(),\n            transition=agent.transition\n        )\n\n    def compatible(self, locals: Dict[Ctx, PolyAgent]) -&gt; bool:\n        \"\"\"Check if local agents agree on overlaps.\"\"\"\n        for ctx1, agent1 in locals.items():\n            for ctx2, agent2 in locals.items():\n                if ctx1 == ctx2:\n                    continue\n                overlap = self.overlap(ctx1, ctx2)\n                if overlap is not None:\n                    r1 = self.restrict(agent1, overlap)\n                    r2 = self.restrict(agent2, overlap)\n                    if not self.agents_equal(r1, r2):\n                        return False\n        return True\n\n    def glue(self, locals: Dict[Ctx, PolyAgent]) -&gt; PolyAgent:\n        \"\"\"\n        Glue compatible local agents into global agent.\n\n        This is where EMERGENCE happens: the global agent has\n        behaviors that no single local agent has.\n        \"\"\"\n        assert self.compatible(locals), \"Local agents not compatible on overlaps\"\n\n        # Global positions = union of local positions\n        global_positions = frozenset().union(*(\n            a.positions for a in locals.values()\n        ))\n\n        # Global directions = context-aware union\n        def global_directions(s):\n            for ctx, agent in locals.items():\n                if s in agent.positions:\n                    return agent.directions(s)\n            return frozenset()\n\n        # Global transition = dispatch to appropriate local\n        def global_transition(s, inp):\n            for ctx, agent in locals.items():\n                if s in agent.positions and inp in agent.directions(s):\n                    return agent.transition(s, inp)\n            raise ValueError(f\"No local agent handles state {s} with input {inp}\")\n\n        return PolyAgent(\n            name=f\"Glued({', '.join(a.name for a in locals.values())})\",\n            positions=global_positions,\n            directions=global_directions,\n            transition=global_transition\n        )\n\n\n# The Soul Sheaf\nSOUL_SHEAF = AgentSheaf(\n    contexts={\n        \"aesthetic\",     # Taste, beauty\n        \"categorical\",   # Structure, types\n        \"gratitude\",     # Sacred, appreciation\n        \"heterarchy\",    # Peer, non-hierarchical\n        \"generativity\",  # Creation, emergence\n        \"joy\",           # Delight, play\n    },\n    overlap=eigenvector_overlap  # How eigenvector contexts intersect\n)\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#emergent-soul-example","title":"Emergent Soul Example","text":"<pre><code># Local soul agents (one per eigenvector context)\nlocal_souls = {\n    \"aesthetic\": PolyAgent(\n        name=\"AestheticSoul\",\n        positions=frozenset({\"minimalist\", \"baroque\"}),\n        directions=lambda s: frozenset({AestheticQuery}),\n        transition=aesthetic_judgment  # \"Does this need to exist?\"\n    ),\n    \"categorical\": PolyAgent(\n        name=\"CategoricalSoul\",\n        positions=frozenset({\"abstract\", \"concrete\"}),\n        directions=lambda s: frozenset({StructureQuery}),\n        transition=categorical_judgment  # \"What's the morphism?\"\n    ),\n    \"joy\": PolyAgent(\n        name=\"JoySoul\",\n        positions=frozenset({\"playful\", \"austere\"}),\n        directions=lambda s: frozenset({JoyQuery}),\n        transition=joy_judgment  # \"Where's the delight?\"\n    ),\n    # ... other eigenvectors\n}\n\n# Glue into emergent global soul\nKENT_SOUL = SOUL_SHEAF.glue(local_souls)\n\n# The global soul has EMERGENT behavior:\n# - In \"minimalist\" + \"abstract\" state, it asks:\n#   \"What's the simplest morphism?\"\n# - This question exists in neither local agent alone\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#the-two-paths-design-vs-happenstance","title":"The Two Paths: Design vs. Happenstance","text":""},{"location":"ideas-synthesis/meta-construction/#path-1-careful-design","title":"Path 1: Careful Design","text":"<pre><code>def careful_compose(operad: Operad, operations: list[str]) -&gt; PolyAgent:\n    \"\"\"\n    Intentional composition via explicit operation sequence.\n\n    The developer specifies exactly which operations to apply.\n    \"\"\"\n    result = PRIMITIVES[\"id\"]\n    for op_name in operations:\n        if op_name in PRIMITIVES:\n            # Binary operation with primitive\n            result = operad.compose(\"seq\", result, PRIMITIVES[op_name])\n        else:\n            # Operad operation\n            result = operad.compose(op_name, result)\n    return result\n\n# Usage\nsoul_pipeline = careful_compose(\n    SOUL_OPERAD,\n    [\"ground\", \"introspect\", \"shadow\", \"dialectic\"]\n)\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#path-2-chaotic-happenstance","title":"Path 2: Chaotic Happenstance","text":"<pre><code>import random\n\nasync def chaotic_compose(\n    operad: Operad,\n    primitives: list[PolyAgent],\n    entropy: float = 0.5,\n    max_depth: int = 5\n) -&gt; PolyAgent:\n    \"\"\"\n    Stochastic composition via void.* entropy.\n\n    The operad GUARANTEES validity. Entropy introduces variation.\n    \"\"\"\n    # Draw from accursed share\n    seed = await logos.invoke(\"void.entropy.sip\", {\"amount\": entropy})\n\n    current = random.choice(primitives)\n\n    for _ in range(max_depth):\n        # Random operation\n        op = random.choice(list(operad.operations.values()))\n\n        # Random compatible agents\n        try:\n            args = [current]\n            for _ in range(op.arity - 1):\n                # Type-guided random selection\n                compatible = [p for p in primitives if types_match(p, op, len(args))]\n                if compatible:\n                    args.append(random.choice(compatible))\n                else:\n                    break\n\n            if len(args) == op.arity:\n                current = op.compose(*args)\n\n        except TypeError:\n            # Incompatible types, try again\n            continue\n\n        # Early termination based on entropy\n        if random.random() &gt; entropy:\n            break\n\n    # Tithe gratitude for the gift\n    await logos.invoke(\"void.gratitude.tithe\", {\"offering\": current.name})\n\n    return current\n\n# Usage\nemergent_agent = await chaotic_compose(\n    SOUL_OPERAD,\n    list(PRIMITIVES.values()),\n    entropy=0.7,\n    max_depth=4\n)\n# Result: Unpredictable but VALID composition\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#the-key-insight","title":"The Key Insight","text":"<p>Both paths produce valid compositions because: 1. The operad defines what compositions are legal 2. The types constrain what can connect 3. The sheaf conditions ensure gluing is coherent</p> <p>Chaos introduces variation. Structure ensures validity.</p>"},{"location":"ideas-synthesis/meta-construction/#devex-integration","title":"DevEx Integration","text":""},{"location":"ideas-synthesis/meta-construction/#the-spec-projector-functor","title":"The Spec Projector Functor","text":"<pre><code>class SpecProjector:\n    \"\"\"\n    Functor: Spec \u2192 Implementation\n\n    Specs generate implementations, not vice versa.\n    \"\"\"\n\n    def project_operad(self, operad: Operad) -&gt; dict[str, Any]:\n        \"\"\"Generate CLI, tests, and docs from operad.\"\"\"\n        return {\n            \"cli_handlers\": self.project_cli(operad),\n            \"tests\": self.project_tests(operad),\n            \"docs\": self.project_docs(operad),\n        }\n\n    def project_cli(self, operad: Operad) -&gt; list[CLIHandler]:\n        \"\"\"Operad operations \u2192 CLI handlers.\"\"\"\n        return [CLIAlgebra(operad).to_cli(op) for op in operad.operations]\n\n    def project_tests(self, operad: Operad) -&gt; list[Test]:\n        \"\"\"Operad laws \u2192 pytest tests.\"\"\"\n        tests = []\n        for law in operad.laws:\n            tests.append(self.law_to_test(law))\n        return tests\n\n    def project_docs(self, operad: Operad) -&gt; str:\n        \"\"\"Operad \u2192 markdown documentation.\"\"\"\n        doc = f\"# {operad.name}\\n\\n\"\n        doc += \"## Operations\\n\\n\"\n        for name, op in operad.operations.items():\n            doc += f\"### `{name}`\\n\"\n            doc += f\"- Arity: {op.arity}\\n\"\n            doc += f\"- Signature: `{op.signature}`\\n\\n\"\n        doc += \"## Laws\\n\\n\"\n        for law in operad.laws:\n            doc += f\"- `{law}`\\n\"\n        return doc\n\n# Usage: Generate everything from operad\nprojector = SpecProjector()\nsoul_impl = projector.project_operad(SOUL_OPERAD)\n# soul_impl[\"cli_handlers\"] \u2192 ready to register\n# soul_impl[\"tests\"] \u2192 ready to run\n# soul_impl[\"docs\"] \u2192 ready to publish\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#ghost-sensorium-integration","title":"Ghost Sensorium Integration","text":"<pre><code># Extend Ghost with meta-construction awareness\nclass MetaGhostCollector(GhostCollector):\n    \"\"\"Collect meta-construction system health.\"\"\"\n\n    async def collect(self) -&gt; CollectorResult:\n        return CollectorResult(\n            success=True,\n            data={\n                \"primitives_count\": len(PRIMITIVES),\n                \"operads\": list(OPERAD_REGISTRY.keys()),\n                \"compositions_today\": await self.count_compositions(),\n                \"chaos_entropy_used\": await self.entropy_usage(),\n                \"sheaf_gluings\": await self.gluing_count(),\n            }\n        )\n\n# Project to ghost files\n# .kgents/ghost/meta.json shows meta-construction health\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#implementation-roadmap","title":"Implementation Roadmap","text":""},{"location":"ideas-synthesis/meta-construction/#phase-1-polynomial-primitives-week-1-2","title":"Phase 1: Polynomial Primitives (Week 1-2)","text":"<pre><code>Tasks:\n- [ ] Define PolyAgent protocol\n- [ ] Convert 7 bootstrap agents to polynomial form\n- [ ] Add position/direction/transition to Agent base\n- [ ] Tests for polynomial laws\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#phase-2-universal-operad-week-3-4","title":"Phase 2: Universal Operad (Week 3-4)","text":"<pre><code>Tasks:\n- [ ] Define Operad dataclass\n- [ ] Implement seq, par, branch, fix, trace operations\n- [ ] Verify operad laws at runtime\n- [ ] Tests for associativity, identity, distributivity\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#phase-3-domain-operads-week-5-6","title":"Phase 3: Domain Operads (Week 5-6)","text":"<pre><code>Tasks:\n- [ ] SOUL_OPERAD with introspect, shadow, dialectic\n- [ ] PARSE_OPERAD with confident, repair\n- [ ] REALITY_OPERAD with classify, collapse\n- [ ] Tests for domain-specific laws\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#phase-4-sheaf-emergence-week-7-8","title":"Phase 4: Sheaf Emergence (Week 7-8)","text":"<pre><code>Tasks:\n- [ ] Define AgentSheaf with restrict/glue\n- [ ] SOUL_SHEAF over eigenvector contexts\n- [ ] Verify gluing conditions\n- [ ] Tests for emergence properties\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#phase-5-two-paths-week-9-10","title":"Phase 5: Two Paths (Week 9-10)","text":"<pre><code>Tasks:\n- [ ] careful_compose for intentional design\n- [ ] chaotic_compose with void.* entropy\n- [ ] Integration with AGENTESE void context\n- [ ] Tests for validity under both paths\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#phase-6-devex-projection-week-11-12","title":"Phase 6: DevEx Projection (Week 11-12)","text":"<pre><code>Tasks:\n- [ ] SpecProjector functor\n- [ ] Automatic CLI from operads\n- [ ] Automatic tests from laws\n- [ ] Automatic docs from signatures\n</code></pre>"},{"location":"ideas-synthesis/meta-construction/#success-criteria","title":"Success Criteria","text":"Criterion Target Primitives as polynomials 13+ primitives converted Operad coverage 3+ domain operads Sheaf gluings Soul emergence working Careful design path 10+ valid compositions Chaotic path 100+ valid random compositions DevEx projection CLI auto-generated from operad Law verification 100% operad laws tested"},{"location":"ideas-synthesis/meta-construction/#the-meta-insight","title":"The Meta-Insight","text":"<p>The 600+ ideas from creative exploration are instances. The meta-construction system produces the space of instances.</p> <pre><code>Before: 600 ideas (finite, enumerated)\nAfter:  Operad \u00d7 Primitives \u00d7 Entropy \u2192 \u221e valid compositions (infinite, generated)\n</code></pre> <p>This is the shift from documentation to specification. From output to grammar. From enumeration to generation.</p> <p>The careful designer and the chaotic explorer arrive at the same garden\u2014one through intention, one through happenstance. Both paths are valid because the operad guarantees it.</p> <p>\"Build the machine that builds the machines.\"</p>"},{"location":"ideas-synthesis/meta-construction/#references","title":"References","text":"<ul> <li>Polynomial Functors - Niu &amp; Spivak</li> <li>Operads for Complex System Design - Spivak et al.</li> <li>Sheaves in Geometry and Logic - Mac Lane &amp; Moerdijk</li> <li>AlgebraicJulia - Compositional dynamical systems</li> <li>Category Theory for Programmers - Milewski</li> <li>Programming with Categories - Fong, Milewski, Spivak</li> </ul>"},{"location":"ideas-synthesis/metrics-reflection/","title":"Metrics and Reflection Framework","text":"<p>\"What gets measured gets improved. What gets reflected upon gets transformed.\"</p> <p>Purpose: Track, measure, and learn from implementation Phases: Measure \u2192 Analyze \u2192 Reflect \u2192 Re-Metabolize Cadence: Per-sprint metrics, monthly reflection</p>"},{"location":"ideas-synthesis/metrics-reflection/#part-1-measurement-framework","title":"Part 1: Measurement Framework","text":""},{"location":"ideas-synthesis/metrics-reflection/#usage-metrics","title":"Usage Metrics","text":""},{"location":"ideas-synthesis/metrics-reflection/#command-invocation-tracking","title":"Command Invocation Tracking","text":"<pre><code># Automatic CLI telemetry (opt-in)\n@track_usage\nasync def handle_soul_vibe(args: Namespace) -&gt; int:\n    \"\"\"Track invocation of 'kg soul vibe'.\"\"\"\n    # Implementation\n    pass\n\n# Telemetry data structure\nclass CommandTelemetry(TypedDict):\n    command: str           # e.g., \"soul.vibe\"\n    timestamp: datetime\n    duration_ms: int\n    success: bool\n    error_type: str | None\n    user_context: str      # \"cli\" | \"script\" | \"api\"\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#metric-categories","title":"Metric Categories","text":"Category Metrics Collection Method Volume Invocations per day/week/month CLI telemetry Performance P50/P95/P99 latency Timing middleware Reliability Success rate, error distribution Error logging Adoption New commands used, command diversity Usage patterns"},{"location":"ideas-synthesis/metrics-reflection/#dashboard-specification","title":"Dashboard Specification","text":"<pre><code>\u250c\u2500 USAGE METRICS DASHBOARD \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                                    \u2502\n\u2502  Top Commands (7 days)          Response Times (P95)               \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500          \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500                 \u2502\n\u2502  1. kg soul vibe      (142)     kg parse:      120ms              \u2502\n\u2502  2. kg oblique        (98)      kg soul vibe:   85ms              \u2502\n\u2502  3. kg parse          (76)      kg dialectic:  340ms              \u2502\n\u2502  4. kg dialectic      (45)      kg compose:     45ms              \u2502\n\u2502                                                                    \u2502\n\u2502  Success Rate: 97.2%            Error Breakdown                    \u2502\n\u2502  \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591 97%     \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500                  \u2502\n\u2502                                 Timeout:    12 (1.2%)              \u2502\n\u2502  Daily Trend                    ParseError:  8 (0.8%)              \u2502\n\u2502  \u2581\u2582\u2583\u2584\u2585\u2586\u2587\u2588\u2587\u2586\u2585\u2584\u2583\u2582\u2581               Other:       7 (0.7%)              \u2502\n\u2502                                                                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#quality-metrics","title":"Quality Metrics","text":""},{"location":"ideas-synthesis/metrics-reflection/#test-coverage-tracking","title":"Test Coverage Tracking","text":"Metric Target Measurement Line Coverage &gt;= 94% <code>pytest --cov</code> Branch Coverage &gt;= 90% <code>pytest --cov-branch</code> Type Coverage 100% <code>mypy --strict</code> Mutation Score &gt;= 80% <code>mutmut run</code>"},{"location":"ideas-synthesis/metrics-reflection/#code-quality-scores","title":"Code Quality Scores","text":"<pre><code># Quality score calculation\ndef calculate_quality_score(module: str) -&gt; QualityScore:\n    return QualityScore(\n        test_coverage=get_test_coverage(module),\n        type_coverage=get_type_coverage(module),\n        lint_score=get_lint_score(module),\n        complexity=get_cyclomatic_complexity(module),\n        doc_coverage=get_doc_coverage(module)\n    )\n\n# Composite score\ncomposite = (\n    test_coverage * 0.3 +\n    type_coverage * 0.2 +\n    lint_score * 0.2 +\n    (1 - complexity_normalized) * 0.15 +\n    doc_coverage * 0.15\n)\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#bug-metrics","title":"Bug Metrics","text":"Metric Definition Target Bug Escape Rate Bugs found in prod / total bugs &lt; 5% Mean Time to Detect Time from introduction to discovery &lt; 24 hours Mean Time to Fix Time from detection to fix &lt; 4 hours Regression Rate Fixed bugs that reappear &lt; 2%"},{"location":"ideas-synthesis/metrics-reflection/#value-metrics","title":"Value Metrics","text":""},{"location":"ideas-synthesis/metrics-reflection/#developer-experience-dx-score","title":"Developer Experience (DX) Score","text":"<pre><code>DX Score = (Ease \u00d7 0.3) + (Speed \u00d7 0.3) + (Joy \u00d7 0.2) + (Power \u00d7 0.2)\n\nWhere:\n- Ease: How easy to use (1-10 self-rating)\n- Speed: Time saved vs alternative (estimated hours)\n- Joy: How enjoyable to use (1-10 self-rating)\n- Power: Capability unlocked (1-10 self-rating)\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#time-savings-estimation","title":"Time Savings Estimation","text":"Task Without kgents With kgents Savings Soul check 10 min (manual reflection) 5 sec 9.9 min Parse analysis 5 min (manual inspection) 2 sec 4.97 min Dialectical synthesis 30 min (thinking) 10 sec 29.8 min Code review ethics 15 min (checklist) 30 sec 14.5 min"},{"location":"ideas-synthesis/metrics-reflection/#feature-request-tracking","title":"Feature Request Tracking","text":"<pre><code>class FeatureRequest(TypedDict):\n    id: str\n    title: str\n    description: str\n    requested_by: str\n    requested_at: datetime\n    priority: int  # User-assigned 1-10\n    implemented: bool\n    implementation_date: datetime | None\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#sprint-metrics-summary","title":"Sprint Metrics Summary","text":"Sprint Commands Shipped Test Coverage Bugs Found DX Score 1 10 95% 3 - 2 15 94% 5 - 3 12 96% 2 - 4 20 94% 4 - 5 8 95% 6 - 6 - 94% - 8.5"},{"location":"ideas-synthesis/metrics-reflection/#part-2-analysis-framework","title":"Part 2: Analysis Framework","text":""},{"location":"ideas-synthesis/metrics-reflection/#weekly-analysis","title":"Weekly Analysis","text":"<p>Schedule: Every Friday Duration: 30 minutes Output: <code>plans/metrics/week-YYYY-WW.md</code></p> <p>Template: <pre><code># Week [NUMBER] Metrics Analysis\n\n## Usage Summary\n- Total invocations: [N]\n- Most used: [command] ([N] times)\n- Least used: [command] ([N] times)\n- New commands tried: [list]\n\n## Quality Summary\n- Test coverage: [X]%\n- Bugs introduced: [N]\n- Bugs fixed: [N]\n- Outstanding issues: [N]\n\n## Observations\n- [Observation 1]\n- [Observation 2]\n\n## Actions\n- [ ] [Action 1]\n- [ ] [Action 2]\n</code></pre></p>"},{"location":"ideas-synthesis/metrics-reflection/#monthly-analysis","title":"Monthly Analysis","text":"<p>Schedule: First Monday of month Duration: 1 hour Output: <code>plans/metrics/month-YYYY-MM.md</code></p> <p>Sections: 1. Usage trends (growth, decline) 2. Quality trajectory (improving, stable, declining) 3. Value delivered (time saved, problems solved) 4. Pain points identified 5. Opportunities spotted</p>"},{"location":"ideas-synthesis/metrics-reflection/#part-3-reflection-framework","title":"Part 3: Reflection Framework","text":""},{"location":"ideas-synthesis/metrics-reflection/#the-five-reflection-questions","title":"The Five Reflection Questions","text":"<p>After each major milestone, answer:</p> <ol> <li>What worked?</li> <li>Which implementations exceeded expectations?</li> <li>Which patterns proved valuable?</li> <li> <p>Which decisions were good?</p> </li> <li> <p>What didn't work?</p> </li> <li>Which implementations underperformed?</li> <li>Which patterns failed?</li> <li> <p>Which decisions were poor?</p> </li> <li> <p>What surprised us?</p> </li> <li>Unexpected successes</li> <li>Unexpected failures</li> <li> <p>Emergent behaviors</p> </li> <li> <p>What did we learn?</p> </li> <li>New insights about agents</li> <li>New insights about composition</li> <li> <p>New insights about the problem space</p> </li> <li> <p>What would we do differently?</p> </li> <li>Process changes</li> <li>Technical changes</li> <li>Priority changes</li> </ol>"},{"location":"ideas-synthesis/metrics-reflection/#reflection-template","title":"Reflection Template","text":"<pre><code># [Milestone] Reflection\n\n## Context\n- Sprint: [N]\n- Date: [YYYY-MM-DD]\n- Features shipped: [list]\n\n## The Five Questions\n\n### What Worked?\n- [Item 1]: [Why it worked]\n- [Item 2]: [Why it worked]\n\n### What Didn't Work?\n- [Item 1]: [Why it failed]\n- [Item 2]: [Why it failed]\n\n### What Surprised Us?\n- [Surprise 1]: [Implications]\n- [Surprise 2]: [Implications]\n\n### What Did We Learn?\n- [Learning 1]: [How to apply]\n- [Learning 2]: [How to apply]\n\n### What Would We Do Differently?\n- [Change 1]: [Rationale]\n- [Change 2]: [Rationale]\n\n## Action Items\n- [ ] [Immediate action]\n- [ ] [Near-term action]\n- [ ] [Long-term action]\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#part-4-re-metabolization-process","title":"Part 4: Re-Metabolization Process","text":""},{"location":"ideas-synthesis/metrics-reflection/#pattern-extraction","title":"Pattern Extraction","text":"<p>When a pattern proves valuable:</p> <ol> <li> <p>Document in skills/: <pre><code># plans/skills/[pattern-name].md\n\n## Pattern: [Name]\n\n### When to Use\n[Circumstances]\n\n### Implementation\n[Code/steps]\n\n### Examples\n[Real examples from codebase]\n\n### Pitfalls\n[Common mistakes]\n</code></pre></p> </li> <li> <p>Add to CLAUDE.md: <pre><code>## Skills Directory\n\n| Skill | Description |\n|-------|-------------|\n| [new-pattern] | [One-liner] |\n</code></pre></p> </li> </ol>"},{"location":"ideas-synthesis/metrics-reflection/#anti-pattern-documentation","title":"Anti-Pattern Documentation","text":"<p>When a pattern proves harmful:</p> <ol> <li>Document in plans/meta.md: <pre><code>## Anti-Patterns\n\n### [Anti-Pattern Name]\n- **What it is**: [Description]\n- **Why it fails**: [Explanation]\n- **Better alternative**: [Suggestion]\n- **Discovered**: [Date, sprint]\n</code></pre></li> </ol>"},{"location":"ideas-synthesis/metrics-reflection/#idea-generation","title":"Idea Generation","text":"<p>Insights feed back into creative exploration:</p> <ol> <li>New ideas \u2192 <code>plans/ideas/session-16-*.md</code></li> <li>Refined ideas \u2192 Update existing session files</li> <li>Dead ideas \u2192 Archive with explanation</li> </ol>"},{"location":"ideas-synthesis/metrics-reflection/#knowledge-transfer","title":"Knowledge Transfer","text":"<pre><code>Lessons Learned\n    \u2193\nskills/ (patterns)\n    \u2193\nmeta.md (anti-patterns)\n    \u2193\nSession 16+ (new ideas)\n    \u2193\nNext Implementation Cycle\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#metric-collection-implementation","title":"Metric Collection Implementation","text":""},{"location":"ideas-synthesis/metrics-reflection/#telemetry-module","title":"Telemetry Module","text":"<pre><code># impl/claude/protocols/cli/telemetry.py\nfrom dataclasses import dataclass\nfrom datetime import datetime\nfrom pathlib import Path\nimport json\n\n@dataclass\nclass TelemetryEvent:\n    command: str\n    timestamp: datetime\n    duration_ms: int\n    success: bool\n    error_type: str | None = None\n\nclass TelemetryCollector:\n    \"\"\"Collect and store CLI usage telemetry.\"\"\"\n\n    def __init__(self, data_path: Path):\n        self.data_path = data_path\n        self.events: list[TelemetryEvent] = []\n\n    def record(self, event: TelemetryEvent) -&gt; None:\n        \"\"\"Record a telemetry event.\"\"\"\n        self.events.append(event)\n        self._persist(event)\n\n    def _persist(self, event: TelemetryEvent) -&gt; None:\n        \"\"\"Persist event to disk.\"\"\"\n        with open(self.data_path / \"telemetry.jsonl\", \"a\") as f:\n            f.write(json.dumps(event.__dict__, default=str) + \"\\n\")\n\n    def get_summary(self, days: int = 7) -&gt; dict:\n        \"\"\"Get usage summary for the last N days.\"\"\"\n        cutoff = datetime.now() - timedelta(days=days)\n        recent = [e for e in self.events if e.timestamp &gt; cutoff]\n\n        return {\n            \"total_invocations\": len(recent),\n            \"success_rate\": sum(e.success for e in recent) / len(recent),\n            \"commands\": Counter(e.command for e in recent),\n            \"avg_duration_ms\": sum(e.duration_ms for e in recent) / len(recent)\n        }\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#quality-tracking","title":"Quality Tracking","text":"<pre><code># impl/claude/protocols/cli/quality.py\nimport subprocess\n\ndef get_test_coverage(path: str = \".\") -&gt; float:\n    \"\"\"Get test coverage percentage.\"\"\"\n    result = subprocess.run(\n        [\"uv\", \"run\", \"pytest\", \"--cov=impl\", \"--cov-report=json\", \"-q\"],\n        capture_output=True, text=True\n    )\n    # Parse coverage.json\n    with open(\"coverage.json\") as f:\n        data = json.load(f)\n    return data[\"totals\"][\"percent_covered\"]\n\ndef get_quality_report() -&gt; dict:\n    \"\"\"Generate comprehensive quality report.\"\"\"\n    return {\n        \"test_coverage\": get_test_coverage(),\n        \"type_coverage\": get_type_coverage(),\n        \"lint_issues\": get_lint_issues(),\n        \"complexity\": get_complexity_metrics(),\n        \"doc_coverage\": get_doc_coverage()\n    }\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#reporting-schedule","title":"Reporting Schedule","text":"Report Frequency Owner Audience Usage Summary Daily Automated Developer Quality Report Per-PR CI Developer Sprint Metrics Bi-weekly Developer Self Monthly Reflection Monthly Developer Self Quarterly Review Quarterly Developer Self"},{"location":"ideas-synthesis/metrics-reflection/#dashboard-commands","title":"Dashboard Commands","text":"<pre><code># View usage metrics\nkg metrics usage\n\n# View quality metrics\nkg metrics quality\n\n# Generate report\nkg metrics report --period week\n\n# Start dashboard TUI\nkg dash metrics\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#success-criteria","title":"Success Criteria","text":"Timeframe Criterion Target Sprint 6 Usage tracking live 100% commands tracked Sprint 6 Quality tracking live Automated per-PR Month 3 First monthly reflection complete Document exists Month 3 5+ patterns extracted to skills/ Pattern count Month 6 Re-metabolization cycle complete Ideas \u2192 Impl \u2192 Learn \u2192 Ideas"},{"location":"ideas-synthesis/metrics-reflection/#metric-storage","title":"Metric Storage","text":"<pre><code>~/.kgents/\n\u251c\u2500\u2500 telemetry/\n\u2502   \u251c\u2500\u2500 usage.jsonl           # Raw usage events\n\u2502   \u2514\u2500\u2500 aggregates/\n\u2502       \u251c\u2500\u2500 daily-YYYY-MM-DD.json\n\u2502       \u2514\u2500\u2500 weekly-YYYY-WW.json\n\u2502\n\u251c\u2500\u2500 quality/\n\u2502   \u251c\u2500\u2500 coverage.json         # Latest coverage\n\u2502   \u2514\u2500\u2500 history/\n\u2502       \u2514\u2500\u2500 coverage-YYYY-MM-DD.json\n\u2502\n\u2514\u2500\u2500 reflections/\n    \u251c\u2500\u2500 week-YYYY-WW.md\n    \u2514\u2500\u2500 month-YYYY-MM.md\n</code></pre>"},{"location":"ideas-synthesis/metrics-reflection/#privacy-and-data-handling","title":"Privacy and Data Handling","text":"<ul> <li>All telemetry is local-only by default</li> <li>No external transmission without explicit opt-in</li> <li>Data can be cleared with <code>kg metrics clear</code></li> <li>User controls retention period</li> </ul> <p>\"The unexamined code is not worth shipping.\"</p>"},{"location":"ideas-synthesis/qa-strategy/","title":"QA and Testing Strategy","text":"<p>\"Untested code is broken code you haven't discovered yet.\"</p> <p>Purpose: Ensure quality throughout implementation of 200+ ideas Test Target: 94%+ coverage (match existing standard) Framework: T-gent five-type taxonomy</p>"},{"location":"ideas-synthesis/qa-strategy/#t-gent-five-type-test-taxonomy","title":"T-gent Five-Type Test Taxonomy","text":""},{"location":"ideas-synthesis/qa-strategy/#type-i-unit-tests","title":"Type I: Unit Tests","text":"<p>Purpose: Verify individual functions in isolation Coverage Target: 100% of new code paths</p> <p>Patterns: <pre><code># tests/unit/test_soul_commands.py\ndef test_eigenvector_calculation():\n    \"\"\"Type I: Pure function testing.\"\"\"\n    eigenvectors = calculate_eigenvectors(persona_state)\n    assert eigenvectors.aesthetic &gt;= 0.0\n    assert eigenvectors.aesthetic &lt;= 1.0\n    assert sum(eigenvectors.values()) == pytest.approx(1.0)\n\ndef test_vibe_synthesis():\n    \"\"\"Type I: Output structure validation.\"\"\"\n    vibe = synthesize_vibe(eigenvectors, mood=\"contemplative\")\n    assert \"summary\" in vibe\n    assert \"dominant_trait\" in vibe\n</code></pre></p> <p>Quick Win Application: - Every CLI command gets Type I tests - Every widget gets Type I tests - Every helper function gets Type I tests</p>"},{"location":"ideas-synthesis/qa-strategy/#type-ii-property-tests","title":"Type II: Property Tests","text":"<p>Purpose: Verify invariants hold across random inputs Coverage Target: Critical algorithms only</p> <p>Patterns: <pre><code># tests/property/test_composition.py\nfrom hypothesis import given, strategies as st\n\n@given(st.lists(st.sampled_from(AGENT_NAMES), min_size=2))\ndef test_composition_associativity(agent_names):\n    \"\"\"Type II: Composition law holds.\"\"\"\n    agents = [get_agent(name) for name in agent_names]\n\n    # (A &gt;&gt; B) &gt;&gt; C == A &gt;&gt; (B &gt;&gt; C)\n    left = compose(compose(agents[0], agents[1]), agents[2])\n    right = compose(agents[0], compose(agents[1], agents[2]))\n\n    result_left = await left.invoke(test_input)\n    result_right = await right.invoke(test_input)\n    assert result_left == result_right\n\n@given(st.text(min_size=1))\ndef test_parse_never_crashes(input_text):\n    \"\"\"Type II: Parser robustness.\"\"\"\n    result = p_gent.parse(input_text)\n    assert result.confidence &gt;= 0.0\n    assert result.confidence &lt;= 1.0\n</code></pre></p> <p>Crown Jewel Application: - <code>kg compose</code> composition laws - Parser confidence bounds - Eigenvector normalization</p>"},{"location":"ideas-synthesis/qa-strategy/#type-iii-integration-tests","title":"Type III: Integration Tests","text":"<p>Purpose: Verify component interactions Coverage Target: All CLI commands end-to-end</p> <p>Patterns: <pre><code># tests/integration/test_soul_flow.py\nasync def test_soul_vibe_end_to_end():\n    \"\"\"Type III: Full CLI flow.\"\"\"\n    result = await run_cli(\"kg soul vibe\")\n\n    assert result.exit_code == 0\n    assert \"dominant:\" in result.output\n    assert \"eigenvectors:\" in result.output or \"confidence:\" in result.output\n\nasync def test_pipeline_integration():\n    \"\"\"Type III: Multi-agent pipeline.\"\"\"\n    result = await run_cli(\"kg analyze --input 'test data'\")\n\n    # Verify all stages executed\n    assert \"ground:\" in result.output or result.metadata.get(\"ground_executed\")\n    assert \"judge:\" in result.output or result.metadata.get(\"judge_executed\")\n    assert \"verdict:\" in result.output\n</code></pre></p> <p>Medium Complexity Application: - Pipeline Builder produces valid pipelines - Synthesis Wizard generates valid syntheses - Time Travel Debugger replays correctly</p>"},{"location":"ideas-synthesis/qa-strategy/#type-iv-adversarial-tests","title":"Type IV: Adversarial Tests","text":"<p>Purpose: Verify behavior under hostile/chaotic conditions Coverage Target: All critical paths</p> <p>Patterns: <pre><code># tests/adversarial/test_chaos.py\nasync def test_byzantine_input():\n    \"\"\"Type IV: Saboteur agent testing.\"\"\"\n    saboteur = SaboteurAgent()\n    malicious_input = await saboteur.generate_attack(\"injection\")\n\n    result = await run_cli(f\"kg parse '{malicious_input}'\")\n\n    # System should not crash\n    assert result.exit_code in [0, 1]  # Success or handled error\n    # No code execution should occur\n    assert \"eval\" not in result.output\n    assert \"exec\" not in result.output\n\nasync def test_resource_exhaustion():\n    \"\"\"Type IV: Resource limits respected.\"\"\"\n    huge_input = \"x\" * 1_000_000\n\n    result = await run_cli(f\"kg parse '{huge_input}'\", timeout=5)\n\n    assert result.exit_code in [0, 1, 124]  # Success, error, or timeout\n    # Memory should not explode\n    assert result.max_memory_mb &lt; 500\n</code></pre></p> <p>Cross-Pollination Application: - Self-Healing Pipeline handles failures - \"Would Kent Approve?\" rejects malicious code - Circuit breakers trip correctly</p>"},{"location":"ideas-synthesis/qa-strategy/#type-v-dialectic-tests","title":"Type V: Dialectic Tests","text":"<p>Purpose: Verify contradiction detection and resolution Coverage Target: All dialectical agents</p> <p>Patterns: <pre><code># tests/dialectic/test_synthesis.py\nasync def test_contradiction_detection():\n    \"\"\"Type V: Contradict agent finds tensions.\"\"\"\n    thesis = \"Move fast\"\n    antithesis = \"Don't break things\"\n\n    result = await contradict.detect(thesis, antithesis)\n\n    assert result.tension_detected\n    assert result.contradiction_type in [\"direct\", \"indirect\", \"partial\"]\n\nasync def test_synthesis_aufheben():\n    \"\"\"Type V: Sublate preserves, negates, elevates.\"\"\"\n    contradiction = Contradiction(\n        thesis=\"Speed\",\n        antithesis=\"Stability\"\n    )\n\n    synthesis = await sublate.resolve(contradiction)\n\n    # Aufheben verification\n    assert synthesis.preserved  # Something kept from both\n    assert synthesis.negated    # Something rejected from both\n    assert synthesis.elevated   # Something new emerges\n</code></pre></p> <p>Crown Jewel Application: - <code>kg dialectic</code> produces valid syntheses - <code>kg shadow</code> detects genuine shadows - Three-Lens Replay gives distinct perspectives</p>"},{"location":"ideas-synthesis/qa-strategy/#qa-gates","title":"QA Gates","text":""},{"location":"ideas-synthesis/qa-strategy/#sprint-gate-criteria","title":"Sprint Gate Criteria","text":"Sprint Gate Requirements 1 (K-gent CLI) Type I + III for all <code>soul *</code> commands 2 (Infrastructure) Type I + II + IV for parser, reality classifier 3 (H-gent CLI) Type I + III + V for dialectical commands 4 (Visualization) Type I + III for all widgets 5 (Cross-Pollination) Type III + IV + V for all combos 6 (Integration) Full test suite green"},{"location":"ideas-synthesis/qa-strategy/#merge-criteria","title":"Merge Criteria","text":"<p>Every PR must pass: - [ ] All Type I tests green - [ ] Type II tests (if applicable) green - [ ] Type III smoke test green - [ ] mypy --strict passes - [ ] ruff check passes - [ ] Coverage &gt;= 94% - [ ] No security vulnerabilities</p>"},{"location":"ideas-synthesis/qa-strategy/#parallel-testing-strategy","title":"Parallel Testing Strategy","text":""},{"location":"ideas-synthesis/qa-strategy/#test-execution-tracks","title":"Test Execution Tracks","text":"<pre><code>Track A: Unit Tests (Type I)\n\u251c\u2500\u2500 Run: pytest tests/unit/ -n auto\n\u251c\u2500\u2500 Time: ~30 seconds\n\u2514\u2500\u2500 Agent: Test Runner 1\n\nTrack B: Property Tests (Type II)\n\u251c\u2500\u2500 Run: pytest tests/property/ -n auto --hypothesis-profile=ci\n\u251c\u2500\u2500 Time: ~2 minutes\n\u2514\u2500\u2500 Agent: Test Runner 2\n\nTrack C: Integration Tests (Type III)\n\u251c\u2500\u2500 Run: pytest tests/integration/ -n auto\n\u251c\u2500\u2500 Time: ~3 minutes\n\u2514\u2500\u2500 Agent: Test Runner 3\n\nTrack D: Adversarial Tests (Type IV)\n\u251c\u2500\u2500 Run: pytest tests/adversarial/ --timeout=60\n\u251c\u2500\u2500 Time: ~5 minutes\n\u2514\u2500\u2500 Agent: Test Runner 4\n\nTrack E: Dialectic Tests (Type V)\n\u251c\u2500\u2500 Run: pytest tests/dialectic/\n\u251c\u2500\u2500 Time: ~1 minute\n\u2514\u2500\u2500 Agent: Test Runner 5\n</code></pre> <p>Total Time (Parallel): ~5 minutes Total Time (Sequential): ~12 minutes</p>"},{"location":"ideas-synthesis/qa-strategy/#test-coverage-by-feature","title":"Test Coverage by Feature","text":""},{"location":"ideas-synthesis/qa-strategy/#quick-wins-test-requirements","title":"Quick Wins Test Requirements","text":"Feature Category Type I Type II Type III Type IV Type V Soul CLI \u2713 - \u2713 - - Parse CLI \u2713 \u2713 \u2713 \u2713 - Reality CLI \u2713 - \u2713 \u2713 - Visualization \u2713 - \u2713 - - Dialectic CLI \u2713 - \u2713 - \u2713"},{"location":"ideas-synthesis/qa-strategy/#crown-jewels-test-requirements","title":"Crown Jewels Test Requirements","text":"Feature Type I Type II Type III Type IV Type V kg whatif \u2713 - \u2713 - \u2713 kg soul vibe \u2713 \u2713 \u2713 - - kg compose \u2713 \u2713 \u2713 - - kg parse \u2713 \u2713 \u2713 \u2713 - kg shadow \u2713 - \u2713 - \u2713 Ethical Review \u2713 - \u2713 \u2713 \u2713"},{"location":"ideas-synthesis/qa-strategy/#cross-pollination-test-requirements","title":"Cross-Pollination Test Requirements","text":"Combo Type I Type II Type III Type IV Type V K + H \u2713 - \u2713 - \u2713 U + P + J \u2713 \u2713 \u2713 \u2713 - I + Flux \u2713 - \u2713 - - M + N \u2713 - \u2713 - -"},{"location":"ideas-synthesis/qa-strategy/#test-data-strategy","title":"Test Data Strategy","text":""},{"location":"ideas-synthesis/qa-strategy/#fixtures","title":"Fixtures","text":"<pre><code># conftest.py\n@pytest.fixture\ndef minimal_persona():\n    \"\"\"Smallest valid persona for testing.\"\"\"\n    return PersonaState(\n        eigenvectors={\"aesthetic\": 0.5, \"categorical\": 0.5},\n        confidence=0.8\n    )\n\n@pytest.fixture\ndef full_persona():\n    \"\"\"Complete persona with all fields.\"\"\"\n    return PersonaState(\n        eigenvectors={\n            \"aesthetic\": 0.15,\n            \"categorical\": 0.20,\n            \"gratitude\": 0.15,\n            \"heterarchy\": 0.15,\n            \"generativity\": 0.20,\n            \"joy\": 0.15\n        },\n        mood=\"contemplative\",\n        confidence=0.92,\n        last_updated=datetime.now()\n    )\n\n@pytest.fixture\ndef contradiction_pair():\n    \"\"\"Standard thesis/antithesis for dialectic tests.\"\"\"\n    return {\n        \"thesis\": \"Move fast\",\n        \"antithesis\": \"Don't break things\"\n    }\n</code></pre>"},{"location":"ideas-synthesis/qa-strategy/#golden-files","title":"Golden Files","text":"<pre><code>tests/golden/\n\u251c\u2500\u2500 soul_vibe_output.json       # Expected vibe response\n\u251c\u2500\u2500 parse_confidence.json       # Expected parse results\n\u251c\u2500\u2500 synthesis_aufheben.json     # Expected synthesis structure\n\u2514\u2500\u2500 shadow_detection.json       # Expected shadow output\n</code></pre>"},{"location":"ideas-synthesis/qa-strategy/#continuous-integration","title":"Continuous Integration","text":""},{"location":"ideas-synthesis/qa-strategy/#github-actions-workflow","title":"GitHub Actions Workflow","text":"<pre><code># .github/workflows/qa.yml\nname: QA Pipeline\n\non: [push, pull_request]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    strategy:\n      matrix:\n        test-type: [unit, property, integration, adversarial, dialectic]\n\n    steps:\n      - uses: actions/checkout@v4\n      - uses: astral-sh/setup-uv@v4\n\n      - name: Run ${{ matrix.test-type }} tests\n        run: |\n          uv run pytest tests/${{ matrix.test-type }}/ \\\n            --cov=impl \\\n            --cov-report=xml \\\n            -v\n\n  coverage:\n    needs: test\n    runs-on: ubuntu-latest\n    steps:\n      - name: Check coverage\n        run: |\n          coverage=$(cat coverage.xml | grep line-rate | head -1 | grep -oP '\\d+\\.\\d+')\n          if (( $(echo \"$coverage &lt; 0.94\" | bc -l) )); then\n            echo \"Coverage $coverage below 94% threshold\"\n            exit 1\n          fi\n</code></pre>"},{"location":"ideas-synthesis/qa-strategy/#quality-metrics","title":"Quality Metrics","text":""},{"location":"ideas-synthesis/qa-strategy/#per-sprint-metrics","title":"Per-Sprint Metrics","text":"Metric Target Measurement Test Coverage &gt;= 94% <code>pytest --cov</code> Type Hint Coverage 100% <code>mypy --strict</code> Lint Score 0 errors <code>ruff check</code> Security Issues 0 critical <code>bandit -r</code> Test Duration &lt; 5 min CI time"},{"location":"ideas-synthesis/qa-strategy/#aggregate-metrics","title":"Aggregate Metrics","text":"Metric Target Total Tests Written 500+ (new) Test/Code Ratio &gt;= 1:1 Flaky Test Rate &lt; 1% Mean Time to Fix &lt; 4 hours"},{"location":"ideas-synthesis/qa-strategy/#security-testing","title":"Security Testing","text":""},{"location":"ideas-synthesis/qa-strategy/#owasp-top-10-checklist","title":"OWASP Top 10 Checklist","text":"Vulnerability Test Type Command Injection Type IV <code>kg parse</code> with malicious input Broken Auth Type III API key handling XSS Type IV TUI output sanitization Insecure Design Type V Architectural review Misconfig Type III Default settings"},{"location":"ideas-synthesis/qa-strategy/#specific-security-tests","title":"Specific Security Tests","text":"<pre><code># tests/security/test_injection.py\n@pytest.mark.parametrize(\"payload\", [\n    \"'; DROP TABLE users; --\",\n    \"${7*7}\",\n    \"{{7*7}}\",\n    \"__import__('os').system('id')\",\n    \"&lt;script&gt;alert('xss')&lt;/script&gt;\"\n])\nasync def test_injection_resistance(payload):\n    \"\"\"Verify no injection vulnerabilities.\"\"\"\n    result = await run_cli(f\"kg parse '{payload}'\")\n\n    # Command should not execute\n    assert \"49\" not in result.output  # ${7*7} result\n    assert \"uid=\" not in result.output  # os.system result\n</code></pre>"},{"location":"ideas-synthesis/qa-strategy/#test-automation-commands","title":"Test Automation Commands","text":"<pre><code># Run all tests\nuv run pytest\n\n# Run by type\nuv run pytest tests/unit/\nuv run pytest tests/property/\nuv run pytest tests/integration/\nuv run pytest tests/adversarial/\nuv run pytest tests/dialectic/\n\n# Run with coverage\nuv run pytest --cov=impl --cov-report=html\n\n# Run specific feature\nuv run pytest -k \"soul\"\nuv run pytest -k \"parse\"\nuv run pytest -k \"dialectic\"\n\n# Run parallel\nuv run pytest -n auto\n\n# Run with verbose output\nuv run pytest -v --tb=short\n</code></pre>"},{"location":"ideas-synthesis/qa-strategy/#qa-checklist-template","title":"QA Checklist Template","text":""},{"location":"ideas-synthesis/qa-strategy/#per-feature-checklist","title":"Per-Feature Checklist","text":"<pre><code>## Feature: [Name]\n\n### Code Quality\n- [ ] Type hints complete\n- [ ] Docstrings present\n- [ ] No magic numbers\n- [ ] Error handling complete\n\n### Tests\n- [ ] Type I: Unit tests written\n- [ ] Type II: Property tests (if applicable)\n- [ ] Type III: Integration test written\n- [ ] Type IV: Adversarial test (if applicable)\n- [ ] Type V: Dialectic test (if applicable)\n\n### Coverage\n- [ ] Line coverage &gt;= 94%\n- [ ] Branch coverage &gt;= 90%\n- [ ] Edge cases covered\n\n### Security\n- [ ] Input validation\n- [ ] Output sanitization\n- [ ] No secrets in code\n\n### Performance\n- [ ] Response time acceptable\n- [ ] Memory usage bounded\n- [ ] No blocking operations\n</code></pre> <p>\"Quality is not an act, it is a habit.\"</p>"},{"location":"saas/","title":"kgents SaaS Infrastructure","text":"<p>Production infrastructure for multi-tenant kgents API with usage-based billing.</p>"},{"location":"saas/#overview","title":"Overview","text":"<p>The kgents SaaS infrastructure provides:</p> <ul> <li>NATS JetStream: Real-time event streaming for SSE and inter-agent communication</li> <li>OpenMeter: Usage-based billing with event aggregation</li> <li>Stripe Integration: Subscription management and payment processing</li> <li>Observability: Prometheus metrics and Grafana dashboards</li> </ul>"},{"location":"saas/#architecture","title":"Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      kgents SaaS API                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502   Soul API  \u2502   \u2502  AGENTESE   \u2502   \u2502  Sessions   \u2502           \u2502\n\u2502  \u2502  Endpoints  \u2502   \u2502  Endpoints  \u2502   \u2502  Endpoints  \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502         \u2502                 \u2502                 \u2502                   \u2502\n\u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                    \u2502\n\u2502                      \u25bc                                          \u2502\n\u2502              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                  \u2502\n\u2502              \u2502 SaaSClients   \u2502                                  \u2502\n\u2502              \u2502  Singleton    \u2502                                  \u2502\n\u2502              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                  \u2502\n\u2502                      \u2502                                          \u2502\n\u2502         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                             \u2502\n\u2502         \u25bc            \u25bc            \u25bc                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u2502\n\u2502  \u2502 NATSBridge  \u2502  \u2502 OpenMeter   \u2502  \u2502   Stripe    \u2502             \u2502\n\u2502  \u2502 (streaming) \u2502  \u2502  Client     \u2502  \u2502  Webhooks   \u2502             \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502\n\u2502         \u2502                \u2502                \u2502                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502                \u2502                \u2502\n          \u25bc                \u25bc                \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502   NATS    \u2502    \u2502 OpenMeter \u2502    \u2502  Stripe   \u2502\n    \u2502 JetStream \u2502    \u2502   Cloud   \u2502    \u2502   API     \u2502\n    \u2502  Cluster  \u2502    \u2502           \u2502    \u2502           \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"saas/#components","title":"Components","text":""},{"location":"saas/#natsbridge","title":"NATSBridge","text":"<p>Real-time event streaming with: - JetStream for durable message delivery - Circuit breaker for resilience - In-memory fallback when NATS unavailable - Multi-consumer support (SSE, metering, observability)</p> <p>Location: <code>impl/claude/protocols/streaming/nats_bridge.py</code></p>"},{"location":"saas/#openmeterclient","title":"OpenMeterClient","text":"<p>Usage-based billing with: - Event buffering and batching - Automatic flush on interval/count - CloudEvents format - Non-blocking async operation</p> <p>Location: <code>impl/claude/protocols/billing/openmeter_client.py</code></p>"},{"location":"saas/#stripe-integration","title":"Stripe Integration","text":"<p>Subscription lifecycle management: - Webhook endpoint for Stripe events - Event translation to OpenMeter - Idempotency handling - Signature verification</p> <p>Location: <code>impl/claude/protocols/api/webhooks.py</code>, <code>impl/claude/protocols/billing/stripe_to_openmeter.py</code></p>"},{"location":"saas/#saasclients-singleton","title":"SaaSClients Singleton","text":"<p>Centralized lifecycle management: - Lazy initialization - Graceful startup/shutdown - Health check aggregation</p> <p>Location: <code>impl/claude/protocols/config/clients.py</code></p>"},{"location":"saas/#quick-start","title":"Quick Start","text":""},{"location":"saas/#local-development","title":"Local Development","text":"<pre><code># Start NATS (optional, will use fallback)\ndocker run -d --name nats -p 4222:4222 -p 8222:8222 nats:2.10-alpine --jetstream\n\n# Set environment variables\nexport NATS_ENABLED=true\nexport NATS_SERVERS=nats://localhost:4222\n\n# Run API\nuv run uvicorn protocols.api.app:create_app --factory --reload\n</code></pre>"},{"location":"saas/#kubernetes-deployment","title":"Kubernetes Deployment","text":"<pre><code># Deploy NATS cluster\nkubectl apply -k impl/claude/infra/k8s/manifests/nats/\n\n# Or use the deploy script\n./impl/claude/infra/k8s/scripts/deploy-nats.sh\n</code></pre>"},{"location":"saas/#documentation","title":"Documentation","text":"Document Description environment-variables.md Complete environment variable reference health-endpoints.md Health check endpoint documentation runbook.md Operational runbook for common scenarios"},{"location":"saas/#related-documentation","title":"Related Documentation","text":"<ul> <li><code>docs/skills/n-phase-cycle/saas-phase3-integrate-ship.md</code> - Phase 3 implementation details</li> <li><code>docs/skills/n-phase-cycle/saas-phase4-deploy.md</code> - Phase 4 deployment details</li> <li><code>impl/claude/protocols/config/</code> - Configuration module</li> <li><code>impl/claude/infra/k8s/manifests/nats/</code> - Kubernetes manifests</li> </ul>"},{"location":"saas/architecture-current/","title":"Current Architecture: Single-Region Deployment","text":"<p>Phase 10 Documentation: Baseline for multi-region evaluation.</p>"},{"location":"saas/architecture-current/#overview","title":"Overview","text":"<p>kgents SaaS operates in a single-region Kubernetes cluster with the following topology:</p> <pre><code>                            Internet\n                               \u2502\n                               \u25bc\n                      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                      \u2502   Kong/Ingress \u2502\n                      \u2502   (Gateway)    \u2502\n                      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n              \u25bc                               \u25bc\n     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n     \u2502   kgent-api     \u2502             \u2502   kgent-api     \u2502\n     \u2502   (Replica 1)   \u2502             \u2502   (Replica 2)   \u2502\n     \u2502   :8000         \u2502             \u2502   :8000         \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n             \u2502                                \u2502\n     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n     \u2502                                                \u2502\n     \u25bc                                                \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502    NATS      \u2502  \u2502    Redis     \u2502  \u2502  Prometheus  \u2502  \u2502    Loki      \u2502\n\u2502   Cluster    \u2502  \u2502   (Cache)    \u2502  \u2502   (Metrics)  \u2502  \u2502   (Logs)     \u2502\n\u2502  (3 nodes)   \u2502  \u2502  (1 node)    \u2502  \u2502              \u2502  \u2502              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"saas/architecture-current/#namespaces","title":"Namespaces","text":"Namespace Purpose Components <code>kgents-triad</code> Core data services API, Redis, Postgres, Kong <code>kgents-agents</code> Agent runtime NATS cluster <code>kgents-observability</code> Monitoring Prometheus, Grafana, Loki, Tempo, OTEL"},{"location":"saas/architecture-current/#component-inventory","title":"Component Inventory","text":""},{"location":"saas/architecture-current/#1-api-service-kgent-api","title":"1. API Service (<code>kgent-api</code>)","text":"<p>Location: <code>kgents-triad</code> namespace</p> Property Value Replicas 2 Image <code>kgents/api:latest</code> Port 8000 CPU Request/Limit 100m / 500m Memory Request/Limit 256Mi / 512Mi HPA 2-10 replicas, CPU target 70% PDB minAvailable: 1 <p>Dependencies: - NATS (<code>nats.kgents-agents.svc:4222</code>) - Redis (<code>triad-redis.kgents-triad.svc:6379</code>) - OpenMeter (external SaaS) - Stripe (external SaaS)</p> <p>Endpoints: - <code>/health</code> - Basic health check - <code>/health/saas</code> - SaaS infrastructure status (NATS, OpenMeter) - <code>/metrics</code> - Prometheus metrics - <code>/webhooks/stripe</code> - Stripe webhook receiver</p>"},{"location":"saas/architecture-current/#2-nats-cluster","title":"2. NATS Cluster","text":"<p>Location: <code>kgents-agents</code> namespace</p> Property Value Replicas 3 (StatefulSet) Image <code>nats:2.10-alpine</code> Ports 4222 (client), 6222 (cluster), 8222 (monitor) CPU Request/Limit 100m / 500m Memory Request/Limit 256Mi / 1Gi Storage 10Gi per node (PVC) PDB minAvailable: 2 <p>JetStream Streams: - <code>AGENTESE</code> - Agent-world interaction events - <code>EVENTS</code> - System event bus</p> <p>Backup: - Daily CronJob at 02:00 UTC - Retention: 7 days - Storage: <code>nats-backup-pvc</code></p>"},{"location":"saas/architecture-current/#3-redis-cache","title":"3. Redis Cache","text":"<p>Location: <code>kgents-triad</code> namespace</p> Property Value Replicas 1 Image <code>redis:7-alpine</code> Port 6379 Memory 128MB max (allkeys-lru) CPU Request/Limit 50m / 200m Memory Request/Limit 64Mi / 256Mi <p>Purpose: - Idempotency key store (Stripe webhooks) - Rate limiting counters - Session cache</p> <p>Note: No persistence configured. Data loss acceptable (short TTL keys).</p>"},{"location":"saas/architecture-current/#4-observability-stack","title":"4. Observability Stack","text":"<p>Location: <code>kgents-observability</code> namespace</p> Component Purpose Retention Prometheus Metrics collection 15 days Grafana Dashboards N/A Loki Log aggregation 7 days Tempo Distributed tracing 7 days OTEL Collector Telemetry gateway N/A <p>Alert Rules: 8 configured (see <code>production-checklist.md</code>)</p>"},{"location":"saas/architecture-current/#5-network-policies","title":"5. Network Policies","text":"Policy Effect <code>default-deny</code> Block all inter-namespace traffic by default <code>nats-policy</code> Allow API \u2192 NATS on port 4222 <code>redis-policy</code> Allow API \u2192 Redis on port 6379"},{"location":"saas/architecture-current/#external-dependencies","title":"External Dependencies","text":"Service Purpose Recovery OpenMeter Usage metering Buffer locally, retry with backoff Stripe Billing webhooks Stripe retries for 72h CloudFlare/Route53 DNS Manual failover"},{"location":"saas/architecture-current/#current-backuprecovery-state","title":"Current Backup/Recovery State","text":""},{"location":"saas/architecture-current/#whats-backed-up","title":"What's Backed Up","text":"Component Method Frequency Location NATS streams CronJob Daily Local PVC K8s manifests GitOps On commit GitHub Secrets External Secrets Operator 5min sync Cloud Secret Manager"},{"location":"saas/architecture-current/#whats-not-backed-up","title":"What's NOT Backed Up","text":"Component Risk Mitigation Redis data Short-TTL keys Acceptable loss In-flight NATS messages Up to 5 min Circuit breaker fallback Grafana dashboards Manual recreation JSON in git repo"},{"location":"saas/architecture-current/#recovery-targets-current-state","title":"Recovery Targets (Current State)","text":"Component RTO RPO Achievable? API &lt; 5 min N/A Yes (HPA + PDB) NATS &lt; 15 min &lt; 5 min Partial (no DR region) Secrets &lt; 30 min &lt; 1 hour Yes (ESO sync)"},{"location":"saas/architecture-current/#single-points-of-failure","title":"Single Points of Failure","text":"SPOF Impact Phase 11+ Mitigation Single region Total outage DR region Redis (1 replica) Cache miss Redis Cluster or Sentinel NATS backup PVC Backup loss Cross-region S3/GCS"},{"location":"saas/architecture-current/#network-topology","title":"Network Topology","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Kubernetes Cluster                          \u2502\n\u2502                                                                 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 kgents-triad                                             \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u2502   \u2502\n\u2502  \u2502  \u2502  API x2  \u2502\u2500\u2500\u2502  Redis   \u2502  \u2502 Postgres \u2502              \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502          \u2502 NetworkPolicy: nats-policy                           \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 kgents-agents                                            \u2502   \u2502\n\u2502  \u2502       \u25bc                                                  \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u2502   \u2502\n\u2502  \u2502  \u2502  NATS-0  \u2502\u2500\u2500\u2502  NATS-1  \u2502\u2500\u2500\u2502  NATS-2  \u2502              \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                                 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 kgents-observability                                     \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502   \u2502\n\u2502  \u2502  \u2502Prometheus\u2502 \u2502 Grafana  \u2502 \u2502   Loki   \u2502 \u2502  Tempo   \u2502   \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"saas/architecture-current/#resource-summary","title":"Resource Summary","text":"Component vCPU (request) Memory (request) Storage API x2 200m 512Mi - NATS x3 300m 768Mi 30Gi Redis x1 50m 64Mi - Prometheus 100m 512Mi 50Gi Grafana 100m 256Mi 1Gi Loki 100m 256Mi 10Gi Tempo 100m 256Mi 10Gi Total ~1 vCPU ~2.5Gi ~100Gi"},{"location":"saas/architecture-current/#configuration-references","title":"Configuration References","text":"<ul> <li>API Deployment: <code>impl/claude/infra/k8s/manifests/api/deployment.yaml</code></li> <li>NATS StatefulSet: <code>impl/claude/infra/k8s/manifests/nats/statefulset.yaml</code></li> <li>Redis: <code>impl/claude/infra/k8s/manifests/triad/03-redis.yaml</code></li> <li>Network Policies: <code>impl/claude/infra/k8s/manifests/network-policies/</code></li> <li>Observability: <code>impl/claude/infra/k8s/manifests/observability/</code></li> </ul> <p>Last Updated: 2025-12-14 | Phase 10: STRATEGIZE</p>"},{"location":"saas/chaos-baseline/","title":"Chaos Engineering Baseline","text":"<p>Documented failure scenarios and recovery behaviors for kgents SaaS infrastructure.</p>"},{"location":"saas/chaos-baseline/#overview","title":"Overview","text":"<p>This document captures the baseline chaos engineering scenarios and expected recovery times. These scenarios validate that the system degrades gracefully and recovers automatically.</p> <p>Scope: Staging/development environments only. Production chaos requires explicit approval.</p>"},{"location":"saas/chaos-baseline/#failure-scenarios","title":"Failure Scenarios","text":""},{"location":"saas/chaos-baseline/#scenario-1-api-pod-termination","title":"Scenario 1: API Pod Termination","text":"<p>Description: Simulate pod failure by deleting an API pod.</p> <p>Expected Behavior: - HPA detects reduced replica count - New pod scheduled immediately - Traffic routed to remaining healthy pod(s) - PDB prevents all pods from being disrupted simultaneously</p> <p>Recovery SLA: &lt; 30 seconds</p> <p>Test Command: <pre><code># Get a pod name\nPOD=$(kubectl get pods -n kgents-triad -l app.kubernetes.io/name=kgent-api -o jsonpath='{.items[0].metadata.name}')\n\n# Delete the pod\nkubectl delete pod $POD -n kgents-triad\n\n# Watch recovery\nwatch kubectl get pods -n kgents-triad -l app.kubernetes.io/name=kgent-api\n</code></pre></p> <p>Expected Output: <pre><code>NAME                         READY   STATUS    AGE\nkgent-api-xxx-abc123         1/1     Running   2s    # New pod starting\nkgent-api-xxx-def456         1/1     Running   10m   # Existing pod\n</code></pre></p> <p>Observed Results: - [ ] Recovery time: ___ seconds - [ ] Traffic continuity: [ ] Yes [ ] No - [ ] Errors during recovery: ___</p>"},{"location":"saas/chaos-baseline/#scenario-2-nats-leader-election","title":"Scenario 2: NATS Leader Election","text":"<p>Description: Simulate NATS cluster leader failure to trigger leader election.</p> <p>Expected Behavior: - NATS cluster elects new leader (Raft consensus) - API circuit breaker may trigger briefly - Fallback queue buffers messages during transition - Auto-recovery after leader election completes</p> <p>Recovery SLA: &lt; 60 seconds</p> <p>Test Command: <pre><code># Find current leader (usually nats-0)\nkubectl exec -n kgents-agents nats-0 -- nats-server --version\n\n# Kill leader pod\nkubectl delete pod nats-0 -n kgents-agents\n\n# Watch cluster recovery\nwatch kubectl get pods -n kgents-agents -l app.kubernetes.io/name=nats\n</code></pre></p> <p>Expected Output: <pre><code>NAME    READY   STATUS    AGE\nnats-0  0/1     Init      5s    # Restarting\nnats-1  1/1     Running   24h   # New leader\nnats-2  1/1     Running   24h   # Follower\n</code></pre></p> <p>Observed Results: - [ ] Recovery time: ___ seconds - [ ] Circuit breaker activated: [ ] Yes [ ] No - [ ] Messages lost: ___ - [ ] Fallback queue depth: ___</p>"},{"location":"saas/chaos-baseline/#scenario-3-network-partition-nats-unreachable","title":"Scenario 3: Network Partition (NATS Unreachable)","text":"<p>Description: Simulate network partition between API and NATS.</p> <p>Expected Behavior: - Circuit breaker opens after 3 consecutive failures - Health endpoint shows <code>nats.status: circuit_open</code> - Fallback queue activates, buffers up to 1000 messages - Auto-recovery when network restored (30s recovery window)</p> <p>Recovery SLA: &lt; 90 seconds (after network restored)</p> <p>Test Command: <pre><code># Apply network policy to block NATS traffic\ncat &lt;&lt;EOF | kubectl apply -f -\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: chaos-block-nats\n  namespace: kgents-triad\nspec:\n  podSelector:\n    matchLabels:\n      app.kubernetes.io/name: kgent-api\n  policyTypes:\n    - Egress\n  egress:\n    - to:\n        - namespaceSelector:\n            matchLabels:\n              name: kgents-observability\n    # NATS blocked by omission\nEOF\n\n# Monitor circuit breaker\nwatch 'kubectl exec -n kgents-triad deploy/kgent-api -- curl -s localhost:8000/health/saas | jq .nats'\n\n# Remove policy to restore connectivity\nkubectl delete networkpolicy chaos-block-nats -n kgents-triad\n</code></pre></p> <p>Expected Output (during partition): <pre><code>{\n  \"status\": \"circuit_open\",\n  \"fallback_queue_depth\": 42,\n  \"mode\": \"fallback\"\n}\n</code></pre></p> <p>Observed Results: - [ ] Circuit opened after: ___ failures - [ ] Fallback queue activated: [ ] Yes [ ] No - [ ] Recovery time after restore: ___ seconds - [ ] Messages in fallback queue processed: [ ] Yes [ ] No</p>"},{"location":"saas/chaos-baseline/#scenario-4-resource-exhaustion-memory-pressure","title":"Scenario 4: Resource Exhaustion (Memory Pressure)","text":"<p>Description: Simulate memory pressure by consuming memory in the pod.</p> <p>Expected Behavior: - OOMKilled if limits exceeded - Pod restarted by kubelet - Liveness probe detects unhealthy state - HPA may scale up if sustained</p> <p>Recovery SLA: &lt; 45 seconds</p> <p>Test Command: <pre><code># This is informational - don't run in production\n# Use a stress tool or allocate memory in application\n\n# Monitor memory\nkubectl top pods -n kgents-triad -l app.kubernetes.io/name=kgent-api\n\n# Watch for OOM events\nkubectl get events -n kgents-triad --field-selector reason=OOMKilled\n</code></pre></p> <p>Note: Memory exhaustion testing should be done carefully. Consider using a dedicated test pod.</p> <p>Observed Results: - [ ] OOMKilled at: ___ Mi - [ ] Restart time: ___ seconds - [ ] Traffic impact: ___</p>"},{"location":"saas/chaos-baseline/#scenario-5-observability-stack-failure","title":"Scenario 5: Observability Stack Failure","text":"<p>Description: Verify API continues operating if Prometheus/Grafana fail.</p> <p>Expected Behavior: - API continues serving requests - Metrics endpoint may timeout but doesn't crash - No impact on core functionality</p> <p>Recovery SLA: N/A (graceful degradation)</p> <p>Test Command: <pre><code># Scale down observability\nkubectl scale deployment prometheus -n kgents-observability --replicas=0\n\n# Verify API health\ncurl localhost:8000/health\ncurl localhost:8000/health/saas\n\n# Restore observability\nkubectl scale deployment prometheus -n kgents-observability --replicas=1\n</code></pre></p> <p>Observed Results: - [ ] API continued operating: [ ] Yes [ ] No - [ ] Any errors logged: ___</p>"},{"location":"saas/chaos-baseline/#recovery-time-summary","title":"Recovery Time Summary","text":"Scenario SLA Baseline Status API Pod Kill &lt; 30s ___ s [ ] Pass NATS Leader Election &lt; 60s ___ s [ ] Pass Network Partition &lt; 90s ___ s [ ] Pass Memory Pressure &lt; 45s ___ s [ ] Pass Observability Failure N/A N/A [ ] Pass"},{"location":"saas/chaos-baseline/#chaos-test-script","title":"Chaos Test Script","text":"<p>A simple script to run basic chaos scenarios:</p> <pre><code>#!/bin/bash\n# chaos-test.sh - Basic chaos engineering tests\n# Usage: ./chaos-test.sh &lt;scenario&gt;\n\nset -e\n\nNAMESPACE_API=\"kgents-triad\"\nNAMESPACE_NATS=\"kgents-agents\"\n\ncase \"$1\" in\n  api-kill)\n    echo \"=== Scenario: API Pod Kill ===\"\n    POD=$(kubectl get pods -n $NAMESPACE_API -l app.kubernetes.io/name=kgent-api -o jsonpath='{.items[0].metadata.name}')\n    echo \"Killing pod: $POD\"\n    START=$(date +%s)\n    kubectl delete pod $POD -n $NAMESPACE_API\n\n    # Wait for new pod\n    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kgent-api -n $NAMESPACE_API --timeout=60s\n    END=$(date +%s)\n    echo \"Recovery time: $((END-START)) seconds\"\n    ;;\n\n  nats-kill)\n    echo \"=== Scenario: NATS Leader Kill ===\"\n    echo \"Killing nats-0\"\n    START=$(date +%s)\n    kubectl delete pod nats-0 -n $NAMESPACE_NATS\n\n    # Wait for pod ready\n    kubectl wait --for=condition=ready pod/nats-0 -n $NAMESPACE_NATS --timeout=120s\n    END=$(date +%s)\n    echo \"Recovery time: $((END-START)) seconds\"\n    ;;\n\n  health-check)\n    echo \"=== Health Check ===\"\n    kubectl exec -n $NAMESPACE_API deploy/kgent-api -- curl -s localhost:8000/health/saas | jq .\n    ;;\n\n  *)\n    echo \"Usage: $0 {api-kill|nats-kill|health-check}\"\n    exit 1\n    ;;\nesac\n</code></pre>"},{"location":"saas/chaos-baseline/#recommendations","title":"Recommendations","text":""},{"location":"saas/chaos-baseline/#immediate","title":"Immediate","text":"<ol> <li>Run all scenarios in staging environment</li> <li>Document baseline recovery times</li> <li>Add chaos metrics to Grafana dashboard</li> </ol>"},{"location":"saas/chaos-baseline/#future-phase-10","title":"Future (Phase 10+)","text":"<ol> <li>Implement automated chaos testing in CI</li> <li>Consider Litmus Chaos or Chaos Mesh for advanced scenarios</li> <li>Add multi-region failover testing</li> <li>Implement game days for production readiness</li> </ol>"},{"location":"saas/chaos-baseline/#references","title":"References","text":"<ul> <li>NATS Clustering</li> <li>Kubernetes Pod Disruption Budgets</li> <li>Circuit Breaker Pattern</li> </ul> <p>Last Updated: 2025-12-14 | Phase 9: Production Hardening</p>"},{"location":"saas/deployment-checklist/","title":"SaaS Deployment Checklist","text":"<p>Step-by-step checklist for safe API deployments with zero downtime.</p>"},{"location":"saas/deployment-checklist/#pre-deployment","title":"Pre-Deployment","text":""},{"location":"saas/deployment-checklist/#1-code-verification","title":"1. Code Verification","text":"<ul> <li> All tests pass: <code>uv run pytest impl/claude</code></li> <li> Security scan clean: <code>pip-audit</code></li> <li> No HIGH/CRITICAL vulnerabilities: <code>trivy image kgents/api:latest</code></li> <li> Code review approved</li> </ul>"},{"location":"saas/deployment-checklist/#2-infrastructure-check","title":"2. Infrastructure Check","text":"<pre><code># Verify cluster health\nkubectl cluster-info\nkubectl get nodes\n\n# Check current deployment status\nkubectl get pods -n kgents-triad -l app.kubernetes.io/name=kgent-api\nkubectl get hpa -n kgents-triad\n\n# Verify PDB is in place\nkubectl get pdb -n kgents-triad\n</code></pre> <ul> <li> All nodes healthy</li> <li> Current pods running (2/2)</li> <li> HPA responding</li> <li> PDB configured</li> </ul>"},{"location":"saas/deployment-checklist/#3-observability-ready","title":"3. Observability Ready","text":"<pre><code># Verify monitoring\nkubectl get pods -n kgents-observability\n</code></pre> <ul> <li> Prometheus scraping</li> <li> Grafana accessible</li> <li> Loki collecting logs</li> <li> Alerts configured</li> </ul>"},{"location":"saas/deployment-checklist/#deployment-steps","title":"Deployment Steps","text":""},{"location":"saas/deployment-checklist/#step-1-build-new-image","title":"Step 1: Build New Image","text":"<pre><code># Build with explicit tag\ndocker build -t kgents/api:v1.x.x -f impl/claude/infra/k8s/images/api/Dockerfile impl/claude\n\n# Also tag as latest\ndocker tag kgents/api:v1.x.x kgents/api:latest\n\n# For Kind cluster\nkind load docker-image kgents/api:v1.x.x --name kgents-triad\n</code></pre>"},{"location":"saas/deployment-checklist/#step-2-update-deployment","title":"Step 2: Update Deployment","text":"<pre><code># Option A: Update image tag in deployment.yaml\n# Edit: spec.template.spec.containers[0].image: kgents/api:v1.x.x\nkubectl apply -f impl/claude/infra/k8s/manifests/api/deployment.yaml\n\n# Option B: Patch image directly\nkubectl set image deployment/kgent-api \\\n  api=kgents/api:v1.x.x \\\n  -n kgents-triad\n</code></pre>"},{"location":"saas/deployment-checklist/#step-3-monitor-rollout","title":"Step 3: Monitor Rollout","text":"<pre><code># Watch rollout progress\nkubectl rollout status deployment/kgent-api -n kgents-triad --timeout=300s\n\n# Watch pods transition\nwatch kubectl get pods -n kgents-triad -l app.kubernetes.io/name=kgent-api\n\n# Check events for issues\nkubectl get events -n kgents-triad --sort-by='.lastTimestamp' | tail -20\n</code></pre> <p>Expected Behavior: - New pod starts \u2192 passes startup probe - Old pod marked for termination - Traffic shifts to new pod - Old pod terminates after grace period - Repeat for each replica</p>"},{"location":"saas/deployment-checklist/#step-4-verify-health","title":"Step 4: Verify Health","text":"<pre><code># Check health endpoints\nkubectl exec -n kgents-triad deploy/kgent-api -- curl -s localhost:8000/health\nkubectl exec -n kgents-triad deploy/kgent-api -- curl -s localhost:8000/health/saas\n\n# Check logs for errors\nkubectl logs -n kgents-triad -l app.kubernetes.io/name=kgent-api --tail=50\n\n# Verify version (if exposed)\ncurl -s http://localhost:8000/health | jq '.version'\n</code></pre> <ul> <li> <code>/health</code> returns 200</li> <li> <code>/health/saas</code> returns expected status</li> <li> No error logs</li> <li> Correct version deployed</li> </ul>"},{"location":"saas/deployment-checklist/#rollback-procedure","title":"Rollback Procedure","text":""},{"location":"saas/deployment-checklist/#automatic-rollback-on-failure","title":"Automatic Rollback (on failure)","text":"<pre><code># Kubernetes will automatically roll back if:\n# - Startup probe fails\n# - Liveness probe fails during rollout\n# - Container crashes repeatedly\n</code></pre>"},{"location":"saas/deployment-checklist/#manual-rollback","title":"Manual Rollback","text":"<pre><code># View rollout history\nkubectl rollout history deployment/kgent-api -n kgents-triad\n\n# Rollback to previous version\nkubectl rollout undo deployment/kgent-api -n kgents-triad\n\n# Rollback to specific revision\nkubectl rollout undo deployment/kgent-api -n kgents-triad --to-revision=2\n\n# Watch rollback progress\nkubectl rollout status deployment/kgent-api -n kgents-triad\n</code></pre>"},{"location":"saas/deployment-checklist/#rollback-verification","title":"Rollback Verification","text":"<pre><code># Confirm pods running correct image\nkubectl get pods -n kgents-triad -l app.kubernetes.io/name=kgent-api -o jsonpath='{.items[*].spec.containers[0].image}'\n\n# Verify health\nkubectl exec -n kgents-triad deploy/kgent-api -- curl -s localhost:8000/health\n</code></pre>"},{"location":"saas/deployment-checklist/#post-deployment","title":"Post-Deployment","text":""},{"location":"saas/deployment-checklist/#1-monitor-metrics-15-minutes","title":"1. Monitor Metrics (15 minutes)","text":"<pre><code># Watch error rate\n# In Grafana: kgents_api_request_errors_total\n\n# Watch latency\n# In Grafana: histogram_quantile(0.95, kgents_api_request_latency_seconds_bucket)\n</code></pre> <ul> <li> Error rate stable</li> <li> Latency within SLA</li> <li> No circuit breaker activations</li> <li> Memory usage stable</li> </ul>"},{"location":"saas/deployment-checklist/#2-smoke-tests","title":"2. Smoke Tests","text":"<pre><code># Run quick load test\nk6 run --vus 10 --duration 30s impl/claude/tests/load/saas-health.js\n</code></pre> <ul> <li> All thresholds pass</li> <li> No errors</li> </ul>"},{"location":"saas/deployment-checklist/#3-update-documentation","title":"3. Update Documentation","text":"<ul> <li> Update changelog if needed</li> <li> Note any configuration changes</li> <li> Update runbook if procedures changed</li> </ul>"},{"location":"saas/deployment-checklist/#emergency-procedures","title":"Emergency Procedures","text":""},{"location":"saas/deployment-checklist/#complete-outage","title":"Complete Outage","text":"<pre><code># Scale to known good state\nkubectl rollout undo deployment/kgent-api -n kgents-triad\n\n# If rollback fails, scale down and investigate\nkubectl scale deployment/kgent-api -n kgents-triad --replicas=0\n\n# Check events and logs\nkubectl describe deployment/kgent-api -n kgents-triad\nkubectl logs -n kgents-triad -l app.kubernetes.io/name=kgent-api --previous\n</code></pre>"},{"location":"saas/deployment-checklist/#partial-degradation","title":"Partial Degradation","text":"<pre><code># Scale up for capacity\nkubectl scale deployment/kgent-api -n kgents-triad --replicas=4\n\n# Check which pods are failing\nkubectl get pods -n kgents-triad -l app.kubernetes.io/name=kgent-api -o wide\n\n# Remove problematic pods\nkubectl delete pod &lt;pod-name&gt; -n kgents-triad\n</code></pre>"},{"location":"saas/deployment-checklist/#deployment-strategy-reference","title":"Deployment Strategy Reference","text":"<p>Current configuration (<code>deployment.yaml</code>):</p> <pre><code>strategy:\n  type: RollingUpdate\n  rollingUpdate:\n    maxSurge: 1        # Allow 1 extra pod during rollout\n    maxUnavailable: 0  # Never reduce below desired count\n</code></pre> <p>This ensures: - Zero downtime during deployments - Gradual traffic shift to new pods - Automatic rollback on probe failures</p>"},{"location":"saas/deployment-checklist/#checklist-summary","title":"Checklist Summary","text":""},{"location":"saas/deployment-checklist/#pre-deployment_1","title":"Pre-Deployment","text":"<ul> <li> Tests passing</li> <li> Security scans clean</li> <li> Cluster healthy</li> <li> Monitoring ready</li> </ul>"},{"location":"saas/deployment-checklist/#during-deployment","title":"During Deployment","text":"<ul> <li> Image built and loaded</li> <li> Deployment updated</li> <li> Rollout successful</li> <li> Health verified</li> </ul>"},{"location":"saas/deployment-checklist/#post-deployment_1","title":"Post-Deployment","text":"<ul> <li> Metrics stable (15 min)</li> <li> Smoke tests pass</li> <li> Documentation updated</li> </ul> <p>Last Updated: 2025-12-14 | Phase 9: Production Hardening</p>"},{"location":"saas/dr-contracts/","title":"Disaster Recovery Contracts","text":"<p>Testable RPO/RTO assertions for kgents SaaS infrastructure.</p>"},{"location":"saas/dr-contracts/#overview","title":"Overview","text":"<p>This document defines disaster recovery contracts as testable assertions. Each contract specifies: - RTO (Recovery Time Objective): Maximum acceptable downtime - RPO (Recovery Point Objective): Maximum acceptable data loss - Validation: How to test the assertion - Owner: Responsible party for meeting the contract</p>"},{"location":"saas/dr-contracts/#recovery-targets-summary","title":"Recovery Targets Summary","text":"Component RTO RPO Priority Owner API &lt; 5 min N/A (stateless) P0 ops NATS Streams &lt; 15 min &lt; 5 min P0 ops Secrets/Config &lt; 30 min &lt; 1 hour P0 ops Observability &lt; 1 hour N/A P2 ops Grafana Dashboards &lt; 2 hours N/A P3 ops"},{"location":"saas/dr-contracts/#contract-1-api-recovery","title":"Contract 1: API Recovery","text":""},{"location":"saas/dr-contracts/#targets","title":"Targets","text":"<pre><code># dr_contracts.py - Testable assertions\n\nfrom datetime import timedelta\n\nclass APIRecoveryContract:\n    \"\"\"API must recover within 5 minutes of failover trigger.\"\"\"\n\n    RTO = timedelta(minutes=5)\n    RPO = None  # Stateless, no data loss concern\n\n    @staticmethod\n    def assert_recovery(failover_triggered_at: datetime, service_healthy_at: datetime) -&gt; bool:\n        \"\"\"\n        Assert: recovery_time &lt; RTO\n\n        &gt;&gt;&gt; failover = datetime(2025, 1, 1, 12, 0, 0)\n        &gt;&gt;&gt; healthy = datetime(2025, 1, 1, 12, 3, 30)  # 3.5 min later\n        &gt;&gt;&gt; APIRecoveryContract.assert_recovery(failover, healthy)\n        True\n        \"\"\"\n        recovery_time = service_healthy_at - failover_triggered_at\n        return recovery_time &lt; APIRecoveryContract.RTO\n</code></pre>"},{"location":"saas/dr-contracts/#validation-procedure","title":"Validation Procedure","text":"<ol> <li> <p>Simulate Failover:    <pre><code># Record start time\nSTART=$(date +%s)\n\n# Trigger DNS failover (simulate primary region down)\n# In production: Route53/CloudFlare health check failure\n\n# In test: directly update DNS or use chaos tool\nkubectl delete deployment kgent-api -n kgents-triad\n</code></pre></p> </li> <li> <p>Measure Recovery:    <pre><code># Poll health endpoint until success\nwhile ! curl -sf https://api.kgents.io/health; do\n  sleep 5\ndone\n\nEND=$(date +%s)\nRECOVERY_TIME=$((END - START))\n\n# Assert\nif [ $RECOVERY_TIME -lt 300 ]; then\n  echo \"PASS: Recovery in ${RECOVERY_TIME}s (&lt; 300s)\"\nelse\n  echo \"FAIL: Recovery in ${RECOVERY_TIME}s (&gt;= 300s)\"\nfi\n</code></pre></p> </li> </ol>"},{"location":"saas/dr-contracts/#dependencies","title":"Dependencies","text":"<ul> <li>DNS TTL: 60 seconds (recommended)</li> <li>Pod startup time: ~30 seconds</li> <li>Health check interval: 10 seconds</li> <li>Failover detection: 2-3 failed checks</li> </ul>"},{"location":"saas/dr-contracts/#failure-modes","title":"Failure Modes","text":"Failure Impact on RTO Mitigation DNS propagation delay +60-120s Lower TTL to 30s Slow pod startup +30-60s Pre-pull images, tune probes DB connection timeout +30s Connection pool warm-up"},{"location":"saas/dr-contracts/#contract-2-nats-stream-recovery","title":"Contract 2: NATS Stream Recovery","text":""},{"location":"saas/dr-contracts/#targets_1","title":"Targets","text":"<pre><code>class NATSRecoveryContract:\n    \"\"\"NATS streams must recover within 15 minutes with &lt; 5 min data loss.\"\"\"\n\n    RTO = timedelta(minutes=15)\n    RPO = timedelta(minutes=5)\n\n    @staticmethod\n    def assert_rto(failover_triggered_at: datetime, streams_healthy_at: datetime) -&gt; bool:\n        \"\"\"Assert: stream recovery &lt; 15 minutes.\"\"\"\n        recovery_time = streams_healthy_at - failover_triggered_at\n        return recovery_time &lt; NATSRecoveryContract.RTO\n\n    @staticmethod\n    def assert_rpo(last_replicated_seq: int, current_origin_seq: int, msg_rate_per_min: float) -&gt; bool:\n        \"\"\"\n        Assert: message lag &lt; 5 minutes worth of messages.\n\n        &gt;&gt;&gt; # Mirror is 100 messages behind, rate is 50 msg/min\n        &gt;&gt;&gt; NATSRecoveryContract.assert_rpo(900, 1000, 50)\n        True  # 100 msgs / 50 msg/min = 2 min &lt; 5 min\n        \"\"\"\n        message_lag = current_origin_seq - last_replicated_seq\n        time_lag_minutes = message_lag / msg_rate_per_min if msg_rate_per_min &gt; 0 else 0\n        return time_lag_minutes &lt; NATSRecoveryContract.RPO.total_seconds() / 60\n</code></pre>"},{"location":"saas/dr-contracts/#validation-procedure_1","title":"Validation Procedure","text":"<ol> <li> <p>Measure Mirror Lag (continuous):    <pre><code># Get mirror stream info\nnats stream info AGENTESE_MIRROR --json | jq '.mirror.lag'\n\n# Calculate time lag\nORIGIN_SEQ=$(nats stream info AGENTESE --json | jq '.state.last_seq')\nMIRROR_SEQ=$(nats stream info AGENTESE_MIRROR --json | jq '.state.last_seq')\nLAG=$((ORIGIN_SEQ - MIRROR_SEQ))\n\n# Assuming 100 msg/min average\nTIME_LAG_MIN=$((LAG / 100))\n\nif [ $TIME_LAG_MIN -lt 5 ]; then\n  echo \"PASS: Mirror lag ${TIME_LAG_MIN}min (&lt; 5min RPO)\"\nelse\n  echo \"FAIL: Mirror lag ${TIME_LAG_MIN}min (&gt;= 5min RPO)\"\nfi\n</code></pre></p> </li> <li> <p>Simulate Stream Failover:    <pre><code># Record state\nSTART=$(date +%s)\nORIGIN_SEQ=$(nats stream info AGENTESE --json | jq '.state.last_seq')\n\n# Kill origin cluster (simulate region failure)\nkubectl delete statefulset nats -n kgents-agents\n\n# Promote mirror to primary (manual step)\n# In DR region: reconfigure clients to use local stream\n\n# Measure recovery\nwhile ! nats stream info AGENTESE_DR; do\n  sleep 5\ndone\n\nEND=$(date +%s)\nRTO_ACTUAL=$((END - START))\n</code></pre></p> </li> </ol>"},{"location":"saas/dr-contracts/#mirror-configuration","title":"Mirror Configuration","text":"<pre><code># NATS stream mirror configuration\nstreams:\n  - name: AGENTESE\n    cluster: rg1-primary\n    subjects: [\"agentese.&gt;\"]\n    retention: limits\n    max_msgs: 1000000\n\n  - name: AGENTESE_MIRROR\n    cluster: rg2-dr\n    mirror:\n      name: AGENTESE\n      filter_subject: \"agentese.&gt;\"\n    # Mirror inherits retention from source\n</code></pre>"},{"location":"saas/dr-contracts/#failure-modes_1","title":"Failure Modes","text":"Failure Impact Mitigation Gateway disconnect RPO increases Monitor gateway health Mirror lag spike RPO violation Alert on lag &gt; 3min Split brain Data divergence Fencing + manual reconcile"},{"location":"saas/dr-contracts/#contract-3-secretsconfig-recovery","title":"Contract 3: Secrets/Config Recovery","text":""},{"location":"saas/dr-contracts/#targets_2","title":"Targets","text":"<pre><code>class SecretsRecoveryContract:\n    \"\"\"Secrets must sync within 30 minutes, config within 1 hour.\"\"\"\n\n    SECRETS_RTO = timedelta(minutes=30)\n    CONFIG_RPO = timedelta(hours=1)\n\n    @staticmethod\n    def assert_secrets_sync(primary_version: str, dr_version: str) -&gt; bool:\n        \"\"\"Assert: DR region has same secret version as primary.\"\"\"\n        return primary_version == dr_version\n\n    @staticmethod\n    def assert_config_freshness(last_sync: datetime, now: datetime) -&gt; bool:\n        \"\"\"Assert: config synced within RPO window.\"\"\"\n        age = now - last_sync\n        return age &lt; SecretsRecoveryContract.CONFIG_RPO\n</code></pre>"},{"location":"saas/dr-contracts/#validation-procedure_2","title":"Validation Procedure","text":"<ol> <li> <p>Secrets Sync Check:    <pre><code># Get secret version in primary\nPRIMARY_VERSION=$(kubectl get secret kgents-api-secrets -n kgents-triad \\\n  -o jsonpath='{.metadata.resourceVersion}' --context=primary)\n\n# Get secret version in DR\nDR_VERSION=$(kubectl get secret kgents-api-secrets -n kgents-triad \\\n  -o jsonpath='{.metadata.resourceVersion}' --context=dr)\n\n# With External Secrets Operator, compare ExternalSecret status\nESO_SYNC=$(kubectl get externalsecret kgents-api-secrets -n kgents-triad \\\n  -o jsonpath='{.status.syncedResourceVersion}' --context=dr)\n</code></pre></p> </li> <li> <p>ArgoCD Sync Check:    <pre><code># Check last sync time\nargocd app get kgents-saas --output json | jq '.status.operationState.finishedAt'\n\n# Verify sync status\nargocd app get kgents-saas --output json | jq '.status.sync.status'\n# Expected: \"Synced\"\n</code></pre></p> </li> </ol>"},{"location":"saas/dr-contracts/#sync-configuration","title":"Sync Configuration","text":"Component Method Frequency Tool K8s Secrets External Secrets Operator 5 min poll ESO K8s Manifests GitOps On commit ArgoCD RBAC GitOps On commit ArgoCD Network Policies GitOps On commit ArgoCD"},{"location":"saas/dr-contracts/#contract-4-observability-recovery","title":"Contract 4: Observability Recovery","text":""},{"location":"saas/dr-contracts/#targets_3","title":"Targets","text":"<pre><code>class ObservabilityRecoveryContract:\n    \"\"\"Observability can degrade; restore within 1 hour.\"\"\"\n\n    RTO = timedelta(hours=1)\n    RPO = None  # Metrics loss acceptable during DR\n    PRIORITY = \"P2\"  # Non-critical\n\n    @staticmethod\n    def assert_degraded_operation(api_healthy: bool, observability_healthy: bool) -&gt; bool:\n        \"\"\"\n        Assert: API can operate without observability.\n        Observability failure should NOT cause API failure.\n        \"\"\"\n        # API should be healthy even if observability is down\n        return api_healthy  # observability_healthy is independent\n</code></pre>"},{"location":"saas/dr-contracts/#validation","title":"Validation","text":"<pre><code># Verify API operates without observability\nkubectl scale deployment prometheus -n kgents-observability --replicas=0\nkubectl scale deployment grafana -n kgents-observability --replicas=0\n\n# API should still respond\ncurl -sf https://api.kgents.io/health\n# Expected: 200 OK\n\n# Restore\nkubectl scale deployment prometheus -n kgents-observability --replicas=1\nkubectl scale deployment grafana -n kgents-observability --replicas=1\n</code></pre>"},{"location":"saas/dr-contracts/#failover-trigger-conditions","title":"Failover Trigger Conditions","text":""},{"location":"saas/dr-contracts/#automatic-triggers","title":"Automatic Triggers","text":"<pre><code># Failover trigger configuration\nautomatic_triggers:\n  - name: health_check_failure\n    condition: \"consecutive_failures &gt;= 3\"\n    check_interval: \"30s\"\n    action: dns_failover\n    notification: pagerduty_critical\n\n  - name: error_rate_spike\n    condition: \"error_rate_5m &gt; 50%\"\n    action: alert_oncall\n    notification: pagerduty_warning\n    # Manual confirmation required before failover\n\n  - name: latency_degradation\n    condition: \"p99_latency_5m &gt; 10s\"\n    action: alert_oncall\n    notification: slack_warning\n    # Investigate before failover\n</code></pre>"},{"location":"saas/dr-contracts/#manual-triggers","title":"Manual Triggers","text":"<pre><code>manual_triggers:\n  - name: region_outage\n    declared_by: [\"oncall\", \"sre_lead\", \"cto\"]\n    action: execute_dr_runbook\n    checklist:\n      - confirm_primary_unreachable\n      - notify_stakeholders\n      - initiate_failover\n      - verify_dr_health\n      - update_status_page\n\n  - name: data_corruption\n    declared_by: [\"sre_lead\", \"cto\"]\n    action: halt_and_investigate\n    checklist:\n      - stop_all_writes\n      - preserve_evidence\n      - assess_blast_radius\n      - decide_recovery_strategy\n\n  - name: security_incident\n    declared_by: [\"security_team\", \"cto\"]\n    action: isolate_and_failover\n    checklist:\n      - isolate_compromised_region\n      - rotate_all_secrets\n      - failover_to_clean_region\n      - forensic_preservation\n</code></pre>"},{"location":"saas/dr-contracts/#trigger-decision-matrix","title":"Trigger Decision Matrix","text":"Signal Threshold Action Auto/Manual Health check fail 3 consecutive DNS failover Auto Error rate &gt; 50% for 5min Alert + investigate Manual Latency p99 &gt; 10s for 5min Alert + investigate Manual Region outage Provider status Full DR Manual NATS cluster down All 3 pods unhealthy Alert + consider DR Manual"},{"location":"saas/dr-contracts/#state-synchronization-requirements","title":"State Synchronization Requirements","text":""},{"location":"saas/dr-contracts/#continuous-sync-p0","title":"Continuous Sync (P0)","text":"State Method Lag Budget Alert Threshold NATS Streams JetStream Mirror &lt; 5 min &gt; 3 min API Secrets ESO &lt; 5 min &gt; 10 min"},{"location":"saas/dr-contracts/#periodic-sync-p1","title":"Periodic Sync (P1)","text":"State Method Frequency Verification K8s Manifests ArgoCD GitOps On commit Sync status Helm Values ArgoCD GitOps On commit Sync status Network Policies ArgoCD GitOps On commit Sync status"},{"location":"saas/dr-contracts/#on-demand-sync-p2","title":"On-Demand Sync (P2)","text":"State Method Trigger Notes Grafana Dashboards Git export Pre-DR drill JSON in repo Alert Rules Git Pre-DR drill YAML in repo Runbooks Git Manual update Markdown in repo"},{"location":"saas/dr-contracts/#testing-schedule","title":"Testing Schedule","text":""},{"location":"saas/dr-contracts/#weekly","title":"Weekly","text":"<ul> <li> Verify NATS mirror lag &lt; 3 min</li> <li> Check ESO sync status</li> <li> Validate ArgoCD sync status</li> </ul>"},{"location":"saas/dr-contracts/#monthly","title":"Monthly","text":"<ul> <li> DNS failover drill (staging)</li> <li> Secret rotation test</li> <li> Runbook review</li> </ul>"},{"location":"saas/dr-contracts/#quarterly","title":"Quarterly","text":"<ul> <li> Full DR drill (staging)</li> <li> RTO/RPO measurement</li> <li> Contract review and update</li> </ul>"},{"location":"saas/dr-contracts/#contract-violations","title":"Contract Violations","text":""},{"location":"saas/dr-contracts/#escalation-path","title":"Escalation Path","text":"Severity Condition Response Time Escalation P0 RTO/RPO breach in production &lt; 15 min CTO + Eng Lead P1 RTO/RPO at risk (&gt; 80% threshold) &lt; 1 hour SRE Lead P2 Sync lag warning &lt; 4 hours On-call"},{"location":"saas/dr-contracts/#post-incident","title":"Post-Incident","text":"<p>After any DR event or drill: 1. Measure actual RTO/RPO achieved 2. Compare against contracts 3. Document gaps and remediation 4. Update contracts if needed (via PR)</p>"},{"location":"saas/dr-contracts/#references","title":"References","text":"<ul> <li>Phase 10 Research: <code>docs/saas/multi-region-research.md</code></li> <li>Chaos Baseline: <code>docs/saas/chaos-baseline.md</code></li> <li>Runbook: <code>docs/saas/runbook.md</code></li> <li>Production Checklist: <code>docs/saas/production-checklist.md</code></li> </ul> <p>Last Updated: 2025-12-14 | Phase 10: DEVELOP</p>"},{"location":"saas/environment-variables/","title":"Environment Variables Reference","text":"<p>Complete reference for kgents SaaS infrastructure configuration.</p>"},{"location":"saas/environment-variables/#nats-configuration","title":"NATS Configuration","text":"Variable Default Required Description <code>NATS_SERVERS</code> <code>nats://localhost:4222</code> No Comma-separated list of NATS server URLs <code>NATS_ENABLED</code> <code>false</code> No Enable NATS streaming (<code>true</code>/<code>false</code>) <code>NATS_STREAM_NAME</code> <code>kgent-events</code> No JetStream stream name <code>NATS_MAX_RECONNECT</code> <code>10</code> No Maximum reconnection attempts"},{"location":"saas/environment-variables/#example","title":"Example","text":"<pre><code># Single server\nNATS_SERVERS=nats://nats.kgents-agents.svc.cluster.local:4222\nNATS_ENABLED=true\n\n# Multiple servers (HA)\nNATS_SERVERS=nats://nats-0.nats.svc:4222,nats://nats-1.nats.svc:4222,nats://nats-2.nats.svc:4222\n</code></pre>"},{"location":"saas/environment-variables/#notes","title":"Notes","text":"<ul> <li>When <code>NATS_ENABLED=false</code> or NATS is unavailable, the system uses an in-memory fallback queue</li> <li>JetStream stream is auto-created on first publish</li> <li>Circuit breaker opens after 5 consecutive failures and recovers after 30 seconds</li> </ul>"},{"location":"saas/environment-variables/#openmeter-configuration","title":"OpenMeter Configuration","text":"Variable Default Required Description <code>OPENMETER_API_KEY</code> (empty) Yes* OpenMeter API key (starts with <code>om_</code>) <code>OPENMETER_BASE_URL</code> <code>https://openmeter.cloud</code> No OpenMeter API endpoint <code>OPENMETER_ENABLED</code> <code>false</code> No Enable usage metering (<code>true</code>/<code>false</code>) <code>OPENMETER_BATCH_SIZE</code> <code>100</code> No Events to buffer before auto-flush <code>OPENMETER_FLUSH_INTERVAL</code> <code>1.0</code> No Seconds between automatic flushes <p>*Required when <code>OPENMETER_ENABLED=true</code></p>"},{"location":"saas/environment-variables/#example_1","title":"Example","text":"<pre><code>OPENMETER_API_KEY=om_live_xxxxxxxxxxxx\nOPENMETER_ENABLED=true\nOPENMETER_BATCH_SIZE=100\nOPENMETER_FLUSH_INTERVAL=1.0\n</code></pre>"},{"location":"saas/environment-variables/#notes_1","title":"Notes","text":"<ul> <li>Events are buffered and flushed either when batch size is reached or on interval</li> <li>On shutdown, remaining events are flushed</li> <li>When <code>OPENMETER_ENABLED=false</code>, events are counted locally but not sent</li> </ul>"},{"location":"saas/environment-variables/#stripe-configuration","title":"Stripe Configuration","text":"Variable Default Required Description <code>STRIPE_API_KEY</code> (empty) Yes* Stripe secret key (starts with <code>sk_</code>) <code>STRIPE_WEBHOOK_SECRET</code> (empty) Yes* Webhook signing secret (starts with <code>whsec_</code>) <code>STRIPE_PRICE_PRO_MONTHLY</code> (empty) No Pro monthly price ID <code>STRIPE_PRICE_PRO_YEARLY</code> (empty) No Pro yearly price ID <code>STRIPE_PRICE_TEAMS_MONTHLY</code> (empty) No Teams monthly price ID <p>*Required for Stripe integration</p>"},{"location":"saas/environment-variables/#example_2","title":"Example","text":"<pre><code>STRIPE_API_KEY=sk_live_xxxxxxxxxxxx\nSTRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxx\n</code></pre>"},{"location":"saas/environment-variables/#notes_2","title":"Notes","text":"<ul> <li>Use test keys (<code>sk_test_</code>, <code>whsec_test_</code>) for development</li> <li>Webhook secret is obtained from Stripe Dashboard \u2192 Developers \u2192 Webhooks</li> <li>All webhook events are signature-verified before processing</li> </ul>"},{"location":"saas/environment-variables/#api-configuration","title":"API Configuration","text":"Variable Default Required Description <code>API_HOST</code> <code>0.0.0.0</code> No API server bind host <code>API_PORT</code> <code>8000</code> No API server port <code>CORS_ORIGINS</code> <code>*</code> No Allowed CORS origins (comma-separated)"},{"location":"saas/environment-variables/#example_3","title":"Example","text":"<pre><code>API_HOST=0.0.0.0\nAPI_PORT=8000\nCORS_ORIGINS=https://app.kgents.io,https://dashboard.kgents.io\n</code></pre>"},{"location":"saas/environment-variables/#observability-configuration","title":"Observability Configuration","text":"Variable Default Required Description <code>KGENTS_TELEMETRY_ENABLED</code> <code>false</code> No Enable OpenTelemetry tracing <code>OTEL_EXPORTER_OTLP_ENDPOINT</code> (empty) No OTLP endpoint for traces <code>LOG_LEVEL</code> <code>INFO</code> No Logging level"},{"location":"saas/environment-variables/#example_4","title":"Example","text":"<pre><code>KGENTS_TELEMETRY_ENABLED=true\nOTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317\nLOG_LEVEL=DEBUG\n</code></pre>"},{"location":"saas/environment-variables/#kubernetes-configmap-example","title":"Kubernetes ConfigMap Example","text":"<pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: kgents-api-config\n  namespace: kgents-agents\ndata:\n  NATS_SERVERS: \"nats://nats.kgents-agents.svc.cluster.local:4222\"\n  NATS_ENABLED: \"true\"\n  NATS_STREAM_NAME: \"kgent-events\"\n  OPENMETER_BASE_URL: \"https://openmeter.cloud\"\n  OPENMETER_ENABLED: \"true\"\n  OPENMETER_BATCH_SIZE: \"100\"\n  OPENMETER_FLUSH_INTERVAL: \"1.0\"\n</code></pre>"},{"location":"saas/environment-variables/#kubernetes-secret-example","title":"Kubernetes Secret Example","text":"<pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: kgents-api-secrets\n  namespace: kgents-agents\ntype: Opaque\nstringData:\n  OPENMETER_API_KEY: \"om_live_xxxxxxxxxxxx\"\n  STRIPE_API_KEY: \"sk_live_xxxxxxxxxxxx\"\n  STRIPE_WEBHOOK_SECRET: \"whsec_xxxxxxxxxxxx\"\n</code></pre>"},{"location":"saas/environment-variables/#configuration-loading-order","title":"Configuration Loading Order","text":"<ol> <li>Environment variables (highest priority)</li> <li><code>.env</code> file (if present)</li> <li>Default values (lowest priority)</li> </ol> <p>The <code>SaaSConfig</code> class in <code>impl/claude/protocols/config/saas.py</code> handles loading and validation.</p>"},{"location":"saas/health-endpoints/","title":"Health Endpoints Documentation","text":"<p>Health check endpoints for monitoring kgents SaaS infrastructure.</p>"},{"location":"saas/health-endpoints/#endpoints","title":"Endpoints","text":"Endpoint Auth Description <code>GET /health</code> None Basic API health check <code>GET /health/saas</code> None SaaS infrastructure health <code>GET /webhooks/stripe/health</code> None Stripe webhook bridge health <code>GET /metrics</code> None Prometheus metrics"},{"location":"saas/health-endpoints/#get-health","title":"GET /health","text":"<p>Basic API health check. Returns overall service status.</p>"},{"location":"saas/health-endpoints/#response","title":"Response","text":"<pre><code>{\n  \"status\": \"ok\",\n  \"version\": \"v1\",\n  \"has_llm\": true,\n  \"components\": {\n    \"soul\": \"ok\",\n    \"llm\": \"ok\",\n    \"auth\": \"ok\",\n    \"metering\": \"ok\"\n  }\n}\n</code></pre>"},{"location":"saas/health-endpoints/#status-values","title":"Status Values","text":"Status Meaning <code>ok</code> All components healthy <code>degraded</code> Some components unavailable but service functional <code>error</code> Critical components failing"},{"location":"saas/health-endpoints/#component-status","title":"Component Status","text":"Component Description <code>soul</code> K-gent Soul instantiation <code>llm</code> LLM provider availability <code>auth</code> Authentication middleware <code>metering</code> Usage metering middleware"},{"location":"saas/health-endpoints/#get-healthsaas","title":"GET /health/saas","text":"<p>SaaS infrastructure health. Returns status of NATS and OpenMeter.</p>"},{"location":"saas/health-endpoints/#response_1","title":"Response","text":"<pre><code>{\n  \"status\": \"ok\",\n  \"started\": true,\n  \"openmeter\": {\n    \"configured\": true,\n    \"status\": \"healthy\",\n    \"metrics\": {\n      \"events_sent\": 1234,\n      \"events_failed\": 0,\n      \"events_buffered\": 5,\n      \"last_flush\": \"2025-12-14T10:30:00Z\",\n      \"configured\": true,\n      \"running\": true\n    }\n  },\n  \"nats\": {\n    \"configured\": true,\n    \"status\": \"healthy\",\n    \"mode\": \"jetstream\"\n  }\n}\n</code></pre>"},{"location":"saas/health-endpoints/#status-values_1","title":"Status Values","text":"Status Meaning <code>ok</code> All infrastructure healthy <code>degraded</code> Some components unavailable <code>not_started</code> Infrastructure not initialized <code>not_configured</code> SaaS infrastructure not available"},{"location":"saas/health-endpoints/#nats-status","title":"NATS Status","text":"Status Meaning <code>healthy</code> Connected to JetStream <code>disconnected</code> Not connected to NATS <code>circuit_open</code> Circuit breaker open, using fallback <code>disabled</code> NATS_ENABLED=false"},{"location":"saas/health-endpoints/#nats-modes","title":"NATS Modes","text":"Mode Meaning <code>jetstream</code> Connected to JetStream <code>fallback</code> Using in-memory queue"},{"location":"saas/health-endpoints/#openmeter-status","title":"OpenMeter Status","text":"Status Meaning <code>healthy</code> Connected to OpenMeter API <code>unhealthy</code> API errors <code>degraded</code> httpx not installed <code>disabled</code> OPENMETER_ENABLED=false"},{"location":"saas/health-endpoints/#get-webhooksstripehealth","title":"GET /webhooks/stripe/health","text":"<p>Stripe webhook bridge health. Returns metrics and configuration status.</p>"},{"location":"saas/health-endpoints/#response_2","title":"Response","text":"<pre><code>{\n  \"stripe_sdk\": true,\n  \"billing_module\": true,\n  \"webhook_secret_configured\": true,\n  \"openmeter_connected\": true,\n  \"bridge_metrics\": {\n    \"events_processed\": 42,\n    \"events_skipped\": 3,\n    \"events_failed\": 0,\n    \"idempotency_store_size\": 45\n  }\n}\n</code></pre>"},{"location":"saas/health-endpoints/#fields","title":"Fields","text":"Field Description <code>stripe_sdk</code> Stripe Python SDK installed <code>billing_module</code> Billing module available <code>webhook_secret_configured</code> STRIPE_WEBHOOK_SECRET set <code>openmeter_connected</code> OpenMeter client available <code>bridge_metrics</code> Processing statistics"},{"location":"saas/health-endpoints/#get-metrics","title":"GET /metrics","text":"<p>Prometheus metrics endpoint. Returns metrics in text format.</p>"},{"location":"saas/health-endpoints/#example-response","title":"Example Response","text":"<pre><code># HELP kgents_nats_circuit_state Circuit breaker state (0=closed, 1=open, 2=half_open)\n# TYPE kgents_nats_circuit_state gauge\nkgents_nats_circuit_state 0\n\n# HELP kgents_nats_messages_published_total Total messages published to NATS\n# TYPE kgents_nats_messages_published_total counter\nkgents_nats_messages_published_total{subject_type=\"chunk\"} 1234\n\n# HELP kgents_openmeter_events_buffered Events currently in OpenMeter buffer\n# TYPE kgents_openmeter_events_buffered gauge\nkgents_openmeter_events_buffered 5\n\n# HELP kgents_stripe_webhooks_received_total Total Stripe webhooks received\n# TYPE kgents_stripe_webhooks_received_total counter\nkgents_stripe_webhooks_received_total{event_type=\"invoice.paid\"} 42\n</code></pre>"},{"location":"saas/health-endpoints/#available-metrics","title":"Available Metrics","text":"Metric Type Description <code>kgents_nats_circuit_state</code> Gauge Circuit breaker state (0/1/2) <code>kgents_nats_messages_published_total</code> Counter Messages published to NATS <code>kgents_nats_publish_errors_total</code> Counter NATS publish errors <code>kgents_nats_fallback_queue_depth</code> Gauge Fallback queue depth <code>kgents_openmeter_events_buffered</code> Gauge OpenMeter buffer depth <code>kgents_openmeter_events_sent_total</code> Counter Events sent to OpenMeter <code>kgents_openmeter_flush_errors_total</code> Counter OpenMeter flush errors <code>kgents_openmeter_flush_latency_seconds</code> Histogram Flush latency <code>kgents_stripe_webhooks_received_total</code> Counter Webhooks received <code>kgents_stripe_webhooks_processed_total</code> Counter Webhooks processed <code>kgents_stripe_webhooks_errors_total</code> Counter Webhook errors <code>kgents_api_requests_total</code> Counter API requests <code>kgents_api_request_latency_seconds</code> Histogram API latency"},{"location":"saas/health-endpoints/#usage-with-kubernetes","title":"Usage with Kubernetes","text":""},{"location":"saas/health-endpoints/#liveness-probe","title":"Liveness Probe","text":"<pre><code>livenessProbe:\n  httpGet:\n    path: /health\n    port: 8000\n  initialDelaySeconds: 10\n  periodSeconds: 30\n</code></pre>"},{"location":"saas/health-endpoints/#readiness-probe","title":"Readiness Probe","text":"<pre><code>readinessProbe:\n  httpGet:\n    path: /health/saas\n    port: 8000\n  initialDelaySeconds: 5\n  periodSeconds: 10\n</code></pre>"},{"location":"saas/health-endpoints/#prometheus-servicemonitor","title":"Prometheus ServiceMonitor","text":"<pre><code>apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: kgents-api\nspec:\n  selector:\n    matchLabels:\n      app: kgents-api\n  endpoints:\n    - port: http\n      path: /metrics\n      interval: 30s\n</code></pre>"},{"location":"saas/launch-announcement/","title":"kgents SaaS Launch Announcement","text":"<p>Production-ready AGENTESE and K-gent Soul API now available.</p>"},{"location":"saas/launch-announcement/#whats-launching","title":"What's Launching","text":"<p>kgents SaaS provides cloud-hosted access to the AGENTESE protocol and K-gent Soul, enabling developers to build tasteful, ethical AI agent applications.</p>"},{"location":"saas/launch-announcement/#core-capabilities","title":"Core Capabilities","text":"<ol> <li>AGENTESE Protocol - Universal agent-world interaction ontology</li> <li>Five contexts: <code>world.*</code>, <code>self.*</code>, <code>concept.*</code>, <code>void.*</code>, <code>time.*</code></li> <li>Handle-based invocation with observer-dependent affordances</li> <li> <p>Composable agent morphisms via <code>&gt;&gt;</code></p> </li> <li> <p>K-gent Soul API - Multi-tenant agent persona service</p> </li> <li>Governance system with principles</li> <li>Dialogue with memory integration</li> <li> <p>Session management</p> </li> <li> <p>Usage-Based Billing - Fair, transparent metering</p> </li> <li>OpenMeter integration for precise token tracking</li> <li>Stripe payment processing</li> <li>Real-time usage dashboards</li> </ol>"},{"location":"saas/launch-announcement/#api-endpoints","title":"API Endpoints","text":"Endpoint Purpose <code>/v1/agentese/invoke</code> Execute AGENTESE paths <code>/v1/agentese/resolve</code> Resolve handles to values <code>/v1/soul/dialogue</code> Converse with K-gent <code>/v1/soul/governance</code> Query governance principles <code>/v1/kgent/sessions</code> Manage conversation sessions <p>Full API documentation: <code>/docs</code></p>"},{"location":"saas/launch-announcement/#infrastructure","title":"Infrastructure","text":""},{"location":"saas/launch-announcement/#production-ready","title":"Production-Ready","text":"<ul> <li>Network-isolated NATS cluster (3 replicas)</li> <li>Pod Disruption Budget ensures availability</li> <li>Default-deny network policies</li> <li>Circuit breaker patterns for resilience</li> </ul>"},{"location":"saas/launch-announcement/#observability","title":"Observability","text":"<ul> <li>Prometheus metrics at <code>/metrics</code></li> <li>Grafana dashboards pre-configured</li> <li>Distributed tracing via Tempo</li> <li>8 active alerts monitoring health</li> </ul>"},{"location":"saas/launch-announcement/#performance-baseline","title":"Performance Baseline","text":"Metric Value Throughput 478 req/s (4.8x target) p95 Latency 6.95ms Error Rate 0%"},{"location":"saas/launch-announcement/#getting-started","title":"Getting Started","text":""},{"location":"saas/launch-announcement/#1-obtain-api-key","title":"1. Obtain API Key","text":"<p>Contact the kgents team to request access.</p>"},{"location":"saas/launch-announcement/#2-test-connection","title":"2. Test Connection","text":"<pre><code>curl -H \"Authorization: Bearer $API_KEY\" \\\n  https://api.kgents.io/health\n</code></pre>"},{"location":"saas/launch-announcement/#3-invoke-agentese","title":"3. Invoke AGENTESE","text":"<pre><code>curl -X POST https://api.kgents.io/v1/agentese/invoke \\\n  -H \"Authorization: Bearer $API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"path\": \"self.soul.principles.manifest\"}'\n</code></pre>"},{"location":"saas/launch-announcement/#4-start-a-session","title":"4. Start a Session","text":"<pre><code>curl -X POST https://api.kgents.io/v1/kgent/sessions \\\n  -H \"Authorization: Bearer $API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"title\": \"My First Session\"}'\n</code></pre>"},{"location":"saas/launch-announcement/#pricing","title":"Pricing","text":"<p>Usage-based billing via OpenMeter: - Tokens processed: $X per 1M tokens - API calls: $Y per 1K calls - Sessions: $Z per session-hour</p> <p>See billing documentation for details.</p>"},{"location":"saas/launch-announcement/#support","title":"Support","text":"<ul> <li>Documentation: https://docs.kgents.io</li> <li>Issues: https://github.com/kgents/kgents/issues</li> <li>Status: https://status.kgents.io</li> </ul>"},{"location":"saas/launch-announcement/#roadmap","title":"Roadmap","text":"<p>Phase 8+: - Loki log aggregation - Multi-region deployment - HPA auto-scaling - Enhanced security audits</p> <p>\"To read is to invoke. There is no view from nowhere.\"</p> <p>kgents SaaS v1.0.0 | 2025-12-14</p>"},{"location":"saas/load-test-baseline/","title":"SaaS Load Test Baseline","text":"<p>Production readiness verification for kgents SaaS infrastructure.</p>"},{"location":"saas/load-test-baseline/#summary","title":"Summary","text":"Metric Target Baseline Status Requests/sec 100 478 4.8x above target Error rate &lt; 1% 0% PASS p95 latency &lt; 500ms 6.95ms 72x better p99 latency &lt; 1000ms ~10ms PASS <p>Test Date: 2025-12-14 Test Duration: 5 minutes (baseline scenario) Virtual Users: 50 concurrent</p>"},{"location":"saas/load-test-baseline/#test-configuration","title":"Test Configuration","text":"<pre><code>k6 run impl/claude/tests/load/saas-health.js\n</code></pre>"},{"location":"saas/load-test-baseline/#scenario","title":"Scenario","text":"<ul> <li>Executor: constant-vus (50 virtual users)</li> <li>Duration: 5 minutes</li> <li>Target Endpoint: <code>/health/saas</code></li> <li>Environment: Local API (localhost:8000)</li> </ul>"},{"location":"saas/load-test-baseline/#results","title":"Results","text":""},{"location":"saas/load-test-baseline/#full-baseline-test-50-vus-5-min","title":"Full Baseline Test (50 VUs, 5 min)","text":"<pre><code>{\n  \"timestamp\": \"2025-12-14T22:53:01.123Z\",\n  \"total_requests\": 143383,\n  \"avg_req_per_second\": 477.79,\n  \"error_rate\": 0,\n  \"latency\": {\n    \"p95\": 6.954,\n    \"max\": 34.983\n  },\n  \"thresholds_passed\": true\n}\n</code></pre>"},{"location":"saas/load-test-baseline/#quick-validation-test-10-vus-30-sec","title":"Quick Validation Test (10 VUs, 30 sec)","text":"<pre><code>{\n  \"timestamp\": \"2025-12-14T22:47:53.871Z\",\n  \"total_requests\": 2900,\n  \"avg_req_per_second\": 96.43,\n  \"error_rate\": 0,\n  \"latency\": {\n    \"p95\": 3.36,\n    \"max\": 30.973\n  },\n  \"thresholds_passed\": true\n}\n</code></pre>"},{"location":"saas/load-test-baseline/#thresholds","title":"Thresholds","text":"Threshold Condition Passed http_req_duration p95 &lt; 500ms YES http_req_duration p99 &lt; 1000ms YES errors rate &lt; 1% YES health_check_duration p95 &lt; 300ms YES"},{"location":"saas/load-test-baseline/#analysis","title":"Analysis","text":""},{"location":"saas/load-test-baseline/#performance-characteristics","title":"Performance Characteristics","text":"<ol> <li> <p>Throughput: The API sustained ~478 req/s with 50 concurrent users, well above the 100 req/s target. This provides significant headroom for traffic growth.</p> </li> <li> <p>Latency: Sub-10ms p95 latency indicates efficient request handling. The health check endpoint is lightweight and suitable for frequent polling.</p> </li> <li> <p>Stability: Zero errors over 143,383 requests demonstrates robust stability under load.</p> </li> <li> <p>Scalability: Linear request rate with constant VUs suggests good parallelization. HPA can be tuned based on these metrics.</p> </li> </ol>"},{"location":"saas/load-test-baseline/#saas-infrastructure-status","title":"SaaS Infrastructure Status","text":"<p>During testing, the SaaS infrastructure was running with: - OpenMeter: disabled (not configured) - NATS: disabled (not configured)</p> <p>Production metrics may differ when SaaS integrations are enabled.</p>"},{"location":"saas/load-test-baseline/#recommendations","title":"Recommendations","text":""},{"location":"saas/load-test-baseline/#pre-production","title":"Pre-Production","text":"<ol> <li>Re-run baseline with SaaS integrations enabled (NATS + OpenMeter)</li> <li>Add stress test scenario (100+ VUs) to find breaking point</li> <li>Configure HPA based on observed CPU/memory during load</li> </ol>"},{"location":"saas/load-test-baseline/#post-launch","title":"Post-Launch","text":"<ol> <li>Establish ongoing performance monitoring</li> <li>Schedule weekly load tests in staging</li> <li>Create alerts for p95 latency &gt; 100ms</li> </ol>"},{"location":"saas/load-test-baseline/#ci-integration","title":"CI Integration","text":"<pre><code># Example GitHub Actions integration\n- name: Run Load Tests\n  run: |\n    k6 run --out json=results.json impl/claude/tests/load/saas-health.js\n    cat results.json | jq '.thresholds_passed'\n</code></pre> <p>Baseline established: 2025-12-14 | Phase 7: Production Launch</p>"},{"location":"saas/multi-region-research/","title":"Multi-Region Evaluation: Research Findings","text":"<p>Phase 10 Track A: Research synthesis for multi-region patterns and DR strategy.</p>"},{"location":"saas/multi-region-research/#executive-summary","title":"Executive Summary","text":"<p>After evaluating multi-region patterns for Kubernetes and NATS, the recommended approach for kgents SaaS is:</p> <ol> <li>Active-Passive (warm standby) for Kubernetes workloads</li> <li>Super-Cluster with Mirroring for NATS JetStream</li> <li>DNS-based failover via Route53/CloudFlare</li> </ol> <p>This approach balances cost, complexity, and recovery objectives. Full active-active is not recommended at current scale.</p>"},{"location":"saas/multi-region-research/#multi-region-deployment-patterns","title":"Multi-Region Deployment Patterns","text":""},{"location":"saas/multi-region-research/#pattern-comparison-table","title":"Pattern Comparison Table","text":"Pattern RTO RPO Cost Complexity Best For Active-Active ~0 ~0 $$$$ Very High Mission-critical, global users Active-Passive 5-15min &lt; 1min $$ Medium Most SaaS, regional failover Pilot Light 15-30min &lt; 5min $ Low Cost-sensitive, infrequent DR Backup &amp; Restore 1-4h hours $ Low Dev/staging, disaster-only"},{"location":"saas/multi-region-research/#pattern-details","title":"Pattern Details","text":""},{"location":"saas/multi-region-research/#active-active-full-redundancy","title":"Active-Active (Full Redundancy)","text":"<ul> <li>Both regions serve traffic simultaneously</li> <li>Requires global load balancer (CloudFlare, AWS Global Accelerator)</li> <li>Database sync complexity (CRDTs, multi-primary)</li> <li>Cost: 2x infrastructure + cross-region network</li> <li>Not recommended for kgents Phase 10 (overkill for current scale)</li> </ul>"},{"location":"saas/multi-region-research/#active-passive-warm-standby-recommended","title":"Active-Passive (Warm Standby) \u2713 RECOMMENDED","text":"<ul> <li>Primary region handles all traffic</li> <li>Secondary region ready to take over</li> <li>Automated DNS failover (5-15 min)</li> <li>State sync via backup replication</li> <li>Cost: ~1.3x infrastructure</li> <li>Best fit for kgents SaaS tier</li> </ul>"},{"location":"saas/multi-region-research/#pilot-light-minimal-standby","title":"Pilot Light (Minimal Standby)","text":"<ul> <li>Minimal infrastructure in DR region</li> <li>Core components only (secrets, configs)</li> <li>Scale-up triggered on failover</li> <li>Manual intervention often required</li> <li>Good stepping stone before Active-Passive</li> </ul>"},{"location":"saas/multi-region-research/#nats-multi-cluster-options","title":"NATS Multi-Cluster Options","text":""},{"location":"saas/multi-region-research/#option-comparison","title":"Option Comparison","text":"Option Consistency Write Latency Read Latency Regional Failure Cost Clustered (single) Immediate Low Low Total outage $ Super-Cluster + Mirror Eventual High\u2192Origin Low (local) Writes blocked $$ Stretch Cluster Immediate High (cross-WAN) High Survives 1 region $$$ Virtual Streams (v2.10+) Eventual Low (local) Low (local) Full availability $$"},{"location":"saas/multi-region-research/#recommended-super-cluster-with-stream-mirroring","title":"Recommended: Super-Cluster with Stream Mirroring","text":"<p>For kgents SaaS, the Super-Cluster with Stream Mirroring pattern provides:</p> <ol> <li>Location transparency: Clients connect to any cluster</li> <li>Low-latency reads: Mirrors serve local consumers</li> <li>DR capability: Mirror can become primary if origin fails</li> <li>Existing compatibility: Works with current NATS 2.10 setup</li> </ol>"},{"location":"saas/multi-region-research/#architecture","title":"Architecture","text":"<pre><code>Region 1 (Primary)              Region 2 (DR)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  NATS Cluster   \u2502\u25c4\u2500\u2500Gateway\u2500\u2500\u25ba  NATS Cluster   \u2502\n\u2502  (3 nodes)      \u2502            \u2502  (3 nodes)      \u2502\n\u2502                 \u2502            \u2502                 \u2502\n\u2502  AGENTESE       \u2502\u2500\u2500\u2500Mirror\u2500\u2500\u25ba\u2502  AGENTESE       \u2502\n\u2502  (origin)       \u2502            \u2502  (mirror)       \u2502\n\u2502                 \u2502            \u2502                 \u2502\n\u2502  EVENTS         \u2502\u2500\u2500\u2500Mirror\u2500\u2500\u25ba\u2502  EVENTS         \u2502\n\u2502  (origin)       \u2502            \u2502  (mirror)       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"saas/multi-region-research/#key-configuration","title":"Key Configuration","text":"<pre><code># Gateway configuration (each cluster)\ngateway:\n  name: rg1\n  gateways:\n    - name: rg1\n      urls: [\"nats://nats-rg1-0:7222\", ...]\n    - name: rg2\n      urls: [\"nats://nats-rg2-0:7222\", ...]\n</code></pre>"},{"location":"saas/multi-region-research/#stream-mirroring","title":"Stream Mirroring","text":"<pre><code># Create mirror in DR region\nnats stream add AGENTESE_MIRROR \\\n  --mirror AGENTESE \\\n  --cluster=rg2\n</code></pre>"},{"location":"saas/multi-region-research/#alternative-virtual-streams-future","title":"Alternative: Virtual Streams (Future)","text":"<p>NATS 2.10+ Virtual Streams provide active-active writes but require: - More complex configuration (9+ servers for 3-region) - Careful subject namespace design - Tolerance for eventual consistency</p> <p>Defer to Phase 12+ after validating basic multi-region.</p>"},{"location":"saas/multi-region-research/#kubernetes-dr-strategy","title":"Kubernetes DR Strategy","text":""},{"location":"saas/multi-region-research/#recommended-tools","title":"Recommended Tools","text":"Component Tool Purpose Backup/Restore Velero Cluster state, PVs, secrets State Sync ArgoCD GitOps manifest sync DNS Failover Route53/CloudFlare Health-based routing Service Mesh Istio (optional) Cross-cluster traffic"},{"location":"saas/multi-region-research/#failover-flow","title":"Failover Flow","text":"<pre><code>1. Health check fails (Route53/CloudFlare)\n           \u2502\n           \u25bc\n2. DNS TTL expires (60s recommended)\n           \u2502\n           \u25bc\n3. Traffic routes to DR region\n           \u2502\n           \u25bc\n4. Velero restore triggers (if needed)\n           \u2502\n           \u25bc\n5. ArgoCD syncs latest manifests\n           \u2502\n           \u25bc\n6. Services healthy in DR region\n</code></pre>"},{"location":"saas/multi-region-research/#gitops-sync-strategy","title":"GitOps Sync Strategy","text":"<ul> <li>Same repo: Both regions pull from same Git source</li> <li>ArgoCD ApplicationSet: Region-specific overlays via Kustomize</li> <li>Secrets: External Secrets Operator with multi-region secret store</li> </ul>"},{"location":"saas/multi-region-research/#current-infrastructure-gaps","title":"Current Infrastructure Gaps","text":""},{"location":"saas/multi-region-research/#chaos-baseline-gaps-for-multi-region","title":"Chaos Baseline Gaps for Multi-Region","text":"<p>Current chaos scenarios (Phase 9) are single-region focused:</p> Gap Impact Mitigation No cross-region failover test Unknown DR RTO Add DNS failover scenario No NATS mirror lag test Unknown RPO for streams Add mirror lag monitoring No split-brain scenario Data consistency risk Add partition test No secret sync validation DR may have stale secrets Test ESO sync"},{"location":"saas/multi-region-research/#proposed-new-scenarios-phase-11","title":"Proposed New Scenarios (Phase 11+)","text":"<ol> <li>Region Failover: Simulate primary region loss via DNS manipulation</li> <li>NATS Mirror Lag: Measure replication lag under load</li> <li>Secret Rotation During Failover: Validate secret sync</li> <li>Cross-Region Latency Spike: Gateway timeout handling</li> </ol>"},{"location":"saas/multi-region-research/#cost-estimates","title":"Cost Estimates","text":""},{"location":"saas/multi-region-research/#self-hosted-multi-region-aws","title":"Self-Hosted Multi-Region (AWS)","text":"Component Primary DR (Passive) Monthly Cost EKS Cluster 3x t3.medium 3x t3.medium ~$200 NATS (EC2/EKS) 3x t3.small 3x t3.small ~$120 Cross-region transfer - ~100GB/month ~$10 Route53 health checks - 3 endpoints ~$5 S3 backup storage 50GB Cross-region replication ~$5 Total ~$340/month"},{"location":"saas/multi-region-research/#synadia-cloud-managed-nats","title":"Synadia Cloud (Managed NATS)","text":"Plan Connections Storage Monthly Personal 10 5GB Free Starter 100 25GB $49 Pro 1,000 100GB $199 Premium 10,000 1TB $899 <p>For multi-region: Pro tier ($199) + Remote System add-on ($49) = $248/month for managed NATS</p>"},{"location":"saas/multi-region-research/#comparison","title":"Comparison","text":"Approach Monthly Cost Operational Burden Self-hosted multi-region ~$340 High (manage NATS, K8s) Synadia Cloud + self K8s ~$248 + ~$200 K8s = ~$448 Medium Self NATS + managed K8s ~$120 + ~$300 = ~$420 Medium <p>Recommendation: Start with self-hosted Active-Passive (~$340/month). Evaluate Synadia Cloud if operational burden becomes significant.</p>"},{"location":"saas/multi-region-research/#recommendations-for-kgents-saas","title":"Recommendations for kgents SaaS","text":""},{"location":"saas/multi-region-research/#phase-10-evaluationdesign","title":"Phase 10 (Evaluation/Design)","text":"<ol> <li>Document current single-region architecture</li> <li>Define RPO/RTO targets (proposed: API RTO &lt;5min, NATS RPO &lt;5min)</li> <li>Design failover procedures</li> <li>Create DR runbook section</li> <li>Cost approval for ~$340/month additional spend</li> </ol>"},{"location":"saas/multi-region-research/#phase-11-implementation","title":"Phase 11 (Implementation)","text":"<ol> <li>Deploy second NATS cluster in DR region</li> <li>Configure gateway connectivity</li> <li>Set up stream mirroring for critical streams (AGENTESE, EVENTS)</li> <li>Deploy Velero for cluster backup</li> <li>Configure DNS failover</li> </ol>"},{"location":"saas/multi-region-research/#phase-12-optimization","title":"Phase 12+ (Optimization)","text":"<ol> <li>Evaluate Virtual Streams for active-active</li> <li>Implement automated DR testing</li> <li>Consider Synadia Cloud migration</li> <li>Add cross-region observability</li> </ol>"},{"location":"saas/multi-region-research/#references","title":"References","text":"<ul> <li>NATS JetStream Clustering</li> <li>NATS Super-Cluster Examples</li> <li>Multi-Region Consistency Models (Synadia)</li> <li>Azure AKS Active-Passive</li> <li>Kubernetes DR Best Practices (Portworx)</li> <li>Synadia Cloud Pricing</li> </ul> <p>Research Phase Complete. Entropy: 0.03 spent.</p> <p>\u27ff[DEVELOP]</p>"},{"location":"saas/multi-region-roadmap/","title":"Multi-Region Migration Roadmap","text":"<p>Phase 10 Deliverable: Sequenced migration path from single-region to disaster-ready infrastructure.</p>"},{"location":"saas/multi-region-roadmap/#executive-summary","title":"Executive Summary","text":"<p>This roadmap outlines four phases to achieve multi-region disaster recovery capability for kgents SaaS. The recommended approach is Active-Passive with NATS stream mirroring, prioritizing simplicity and cost-effectiveness over full active-active redundancy.</p> <p>Target State: - RTO &lt; 5 minutes (API), &lt; 15 minutes (NATS) - RPO &lt; 5 minutes - ~$340/month additional cost</p>"},{"location":"saas/multi-region-roadmap/#current-state-phase-10","title":"Current State (Phase 10)","text":"Aspect Status Single-region deployment Complete DR contracts defined Complete Research synthesis Complete Cost estimates Complete Migration roadmap This document <p>See: <code>docs/saas/architecture-current.md</code> for detailed topology.</p>"},{"location":"saas/multi-region-roadmap/#phase-11-external-backup-foundation","title":"Phase 11: External Backup (Foundation)","text":"<p>Goal: Establish cross-region backup foundation before deploying DR infrastructure.</p>"},{"location":"saas/multi-region-roadmap/#objective","title":"Objective","text":"<p>Move from local-only backups to cross-region durable storage, enabling point-in-time recovery even if primary region is destroyed.</p>"},{"location":"saas/multi-region-roadmap/#deliverables","title":"Deliverables","text":"Item Description Effort S3/GCS bucket Cross-region backup destination 1-2 hours NATS backup to S3 Modify CronJob to upload to S3 2-4 hours Velero installation Cluster state backup tool 2-4 hours Velero schedules Daily cluster snapshots 1-2 hours Restore runbook Document recovery procedures 2-3 hours"},{"location":"saas/multi-region-roadmap/#architecture","title":"Architecture","text":"<pre><code>Primary Region                    Cross-Region Storage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  NATS Cluster   \u2502\u2500\u2500CronJob\u2500\u2500\u2500\u2500\u25ba\u2502  S3/GCS Bucket  \u2502\n\u2502                 \u2502              \u2502  (nats-backups) \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                         \u25b2\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                      \u2502\n\u2502  Velero         \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u2502  (cluster state)\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"saas/multi-region-roadmap/#implementation-details","title":"Implementation Details","text":""},{"location":"saas/multi-region-roadmap/#1-create-backup-bucket","title":"1. Create Backup Bucket","text":"<pre><code># AWS S3\naws s3 mb s3://kgents-dr-backups --region us-west-2\naws s3api put-bucket-versioning \\\n  --bucket kgents-dr-backups \\\n  --versioning-configuration Status=Enabled\n\n# GCS\ngcloud storage buckets create gs://kgents-dr-backups \\\n  --location=us-west1 \\\n  --uniform-bucket-level-access\n</code></pre>"},{"location":"saas/multi-region-roadmap/#2-update-nats-backup-cronjob","title":"2. Update NATS Backup CronJob","text":"<pre><code># Add S3 upload step to backup-cronjob.yaml\ncontainers:\n  - name: backup\n    image: nats:2.10-alpine\n    command:\n      - /bin/sh\n      - -c\n      - |\n        nats stream backup AGENTESE /backups/$(date +%Y%m%d).tar.gz\n        aws s3 cp /backups/$(date +%Y%m%d).tar.gz s3://kgents-dr-backups/nats/\n</code></pre>"},{"location":"saas/multi-region-roadmap/#3-install-velero","title":"3. Install Velero","text":"<pre><code>velero install \\\n  --provider aws \\\n  --bucket kgents-dr-backups \\\n  --backup-location-config region=us-west-2 \\\n  --snapshot-location-config region=us-west-2 \\\n  --plugins velero/velero-plugin-for-aws:v1.8.0\n\n# Create daily schedule\nvelero schedule create daily-cluster-backup \\\n  --schedule=\"0 3 * * *\" \\\n  --include-namespaces kgents-triad,kgents-agents\n</code></pre>"},{"location":"saas/multi-region-roadmap/#success-criteria","title":"Success Criteria","text":"<ul> <li> NATS backups appear in S3/GCS within 24 hours</li> <li> Velero backup completes successfully</li> <li> Restore test from S3 to staging namespace succeeds</li> <li> Runbook reviewed and approved</li> </ul>"},{"location":"saas/multi-region-roadmap/#dependencies","title":"Dependencies","text":"<ul> <li>AWS/GCP account with cross-region bucket access</li> <li>IAM credentials for backup service account</li> </ul>"},{"location":"saas/multi-region-roadmap/#estimated-effort","title":"Estimated Effort","text":"<p>Total: 1-2 days</p>"},{"location":"saas/multi-region-roadmap/#phase-12-cross-region-dns-setup","title":"Phase 12: Cross-Region DNS Setup","text":"<p>Goal: Establish DNS infrastructure for automated failover.</p>"},{"location":"saas/multi-region-roadmap/#objective_1","title":"Objective","text":"<p>Configure health-checked DNS routing that can automatically redirect traffic to DR region when primary fails.</p>"},{"location":"saas/multi-region-roadmap/#deliverables_1","title":"Deliverables","text":"Item Description Effort DNS provider selection Route53 or CloudFlare 1 hour Health check endpoints Configure health probes 1-2 hours Failover DNS records Primary + failover configuration 2-3 hours TTL optimization Reduce TTL for faster failover 1 hour Failover testing Validate DNS cutover timing 2-3 hours"},{"location":"saas/multi-region-roadmap/#architecture_1","title":"Architecture","text":"<pre><code>                CloudFlare / Route53\n                \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                \u2502  api.kgents.io  \u2502\n                \u2502                 \u2502\n                \u2502  Health Check   \u2502\n                \u2502  every 30s      \u2502\n                \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502                               \u2502\n         \u25bc (Primary)                     \u25bc (Failover)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  us-east-1      \u2502             \u2502  us-west-2      \u2502\n\u2502  (Active)       \u2502             \u2502  (Standby)      \u2502\n\u2502                 \u2502             \u2502                 \u2502\n\u2502  Health: /health\u2502             \u2502  Health: /health\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"saas/multi-region-roadmap/#implementation-details_1","title":"Implementation Details","text":""},{"location":"saas/multi-region-roadmap/#route53-configuration","title":"Route53 Configuration","text":"<pre><code># Primary record\nType: A\nName: api.kgents.io\nRoutingPolicy: Failover\nSetIdentifier: primary\nFailoverRecordType: PRIMARY\nHealthCheckId: $PRIMARY_HEALTH_CHECK\nTTL: 60\nValue: $PRIMARY_ALB_IP\n\n# Failover record\nType: A\nName: api.kgents.io\nRoutingPolicy: Failover\nSetIdentifier: dr\nFailoverRecordType: SECONDARY\nTTL: 60\nValue: $DR_ALB_IP\n</code></pre>"},{"location":"saas/multi-region-roadmap/#health-check-configuration","title":"Health Check Configuration","text":"<pre><code>HealthCheck:\n  Type: HTTPS\n  FullyQualifiedDomainName: primary.api.kgents.io\n  Port: 443\n  ResourcePath: /health\n  RequestInterval: 30\n  FailureThreshold: 3\n</code></pre>"},{"location":"saas/multi-region-roadmap/#success-criteria_1","title":"Success Criteria","text":"<ul> <li> Health checks active and passing</li> <li> Failover triggers within 90 seconds of primary failure</li> <li> DNS propagation completes within TTL window</li> <li> Failback tested and documented</li> </ul>"},{"location":"saas/multi-region-roadmap/#dependencies_1","title":"Dependencies","text":"<ul> <li>Phase 11 complete (backup foundation)</li> <li>DR region cluster exists (Phase 13 dependency)</li> </ul>"},{"location":"saas/multi-region-roadmap/#estimated-effort_1","title":"Estimated Effort","text":"<p>Total: 1 day</p>"},{"location":"saas/multi-region-roadmap/#phase-13-standby-cluster-deployment","title":"Phase 13: Standby Cluster Deployment","text":"<p>Goal: Deploy warm standby cluster in DR region with NATS stream mirroring.</p>"},{"location":"saas/multi-region-roadmap/#objective_2","title":"Objective","text":"<p>Create a near-real-time replica of production infrastructure that can assume traffic within RTO targets.</p>"},{"location":"saas/multi-region-roadmap/#deliverables_2","title":"Deliverables","text":"Item Description Effort DR cluster provisioning K8s cluster in secondary region 2-4 hours Namespace mirroring ArgoCD ApplicationSet 2-3 hours NATS gateway setup Cross-cluster gateway 4-6 hours Stream mirroring Mirror critical streams 2-3 hours Secret sync External Secrets cross-region 2-3 hours Failover testing End-to-end DR drill 4-6 hours"},{"location":"saas/multi-region-roadmap/#architecture_2","title":"Architecture","text":"<pre><code>Region 1 (Primary)                    Region 2 (DR)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         \u2502          \u2502                         \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502          \u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502   kgent-api     \u2502    \u2502          \u2502    \u2502   kgent-api     \u2502  \u2502\n\u2502  \u2502   (active)      \u2502    \u2502          \u2502    \u2502   (standby)     \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502          \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502           \u2502             \u2502          \u2502             \u2502           \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502          \u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  NATS Cluster   \u2502\u25c4\u2500\u2500\u2500\u253c\u2500\u2500Gateway\u2500\u253c\u2500\u2500\u2500\u25ba\u2502  NATS Cluster   \u2502  \u2502\n\u2502  \u2502  (origin)       \u2502    \u2502          \u2502    \u2502  (mirror)       \u2502  \u2502\n\u2502  \u2502                 \u2502    \u2502          \u2502    \u2502                 \u2502  \u2502\n\u2502  \u2502  AGENTESE \u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u253c\u2500Mirror\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u25ba\u2502  AGENTESE_MIR   \u2502  \u2502\n\u2502  \u2502  EVENTS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u253c\u2500Mirror\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u25ba\u2502  EVENTS_MIR     \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502          \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                         \u2502          \u2502                         \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502          \u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502    Redis        \u2502    \u2502          \u2502    \u2502    Redis        \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502          \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                         \u2502          \u2502                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"saas/multi-region-roadmap/#implementation-details_2","title":"Implementation Details","text":""},{"location":"saas/multi-region-roadmap/#1-provision-dr-cluster","title":"1. Provision DR Cluster","text":"<pre><code># EKS example\neksctl create cluster \\\n  --name kgents-dr \\\n  --region us-west-2 \\\n  --nodegroup-name standard \\\n  --node-type t3.medium \\\n  --nodes 3\n\n# Apply base manifests\nkubectl --context=dr apply -f impl/claude/infra/k8s/manifests/namespace.yaml\n</code></pre>"},{"location":"saas/multi-region-roadmap/#2-configure-nats-gateway","title":"2. Configure NATS Gateway","text":"<pre><code># nats-config in DR cluster\ngateway:\n  name: dr\n  gateways:\n    - name: primary\n      urls:\n        - nats://nats-0.nats-headless.kgents-agents.svc:7222\n        - nats://nats-1.nats-headless.kgents-agents.svc:7222\n        - nats://nats-2.nats-headless.kgents-agents.svc:7222\n    - name: dr\n      urls:\n        - nats://nats-0.nats-headless.kgents-agents.svc:7222\n</code></pre>"},{"location":"saas/multi-region-roadmap/#3-create-stream-mirrors","title":"3. Create Stream Mirrors","text":"<pre><code># Connect to DR NATS cluster\nnats --context=dr stream add AGENTESE_MIRROR \\\n  --mirror AGENTESE \\\n  --mirror-filter-subject \"agentese.&gt;\" \\\n  --storage file \\\n  --retention limits \\\n  --max-msgs 1000000\n\nnats --context=dr stream add EVENTS_MIRROR \\\n  --mirror EVENTS \\\n  --storage file\n</code></pre>"},{"location":"saas/multi-region-roadmap/#4-argocd-applicationset","title":"4. ArgoCD ApplicationSet","text":"<pre><code>apiVersion: argoproj.io/v1alpha1\nkind: ApplicationSet\nmetadata:\n  name: kgents-multiregion\nspec:\n  generators:\n    - list:\n        elements:\n          - cluster: primary\n            url: https://primary.k8s.kgents.io\n          - cluster: dr\n            url: https://dr.k8s.kgents.io\n  template:\n    metadata:\n      name: 'kgents-{{cluster}}'\n    spec:\n      project: default\n      source:\n        repoURL: https://github.com/kgents/kgents\n        path: impl/claude/infra/k8s/manifests\n      destination:\n        server: '{{url}}'\n</code></pre>"},{"location":"saas/multi-region-roadmap/#success-criteria_2","title":"Success Criteria","text":"<ul> <li> DR cluster operational</li> <li> NATS gateway connected between regions</li> <li> Stream mirrors lag &lt; 3 minutes under load</li> <li> Secrets sync validated</li> <li> Full DR drill completes within RTO targets</li> </ul>"},{"location":"saas/multi-region-roadmap/#dependencies_2","title":"Dependencies","text":"<ul> <li>Phase 11 complete (backup infrastructure)</li> <li>Phase 12 complete (DNS failover ready)</li> <li>Budget approved (~$200/month for DR cluster)</li> </ul>"},{"location":"saas/multi-region-roadmap/#estimated-effort_2","title":"Estimated Effort","text":"<p>Total: 3-5 days</p>"},{"location":"saas/multi-region-roadmap/#phase-14-active-active-optional","title":"Phase 14: Active-Active (Optional)","text":"<p>Goal: Enable simultaneous traffic serving from both regions for latency optimization.</p>"},{"location":"saas/multi-region-roadmap/#objective_3","title":"Objective","text":"<p>Upgrade from Active-Passive to Active-Active for global latency optimization and zero-downtime failover. Only pursue if business requirements justify additional complexity.</p>"},{"location":"saas/multi-region-roadmap/#prerequisites","title":"Prerequisites","text":"<ul> <li> Phase 13 complete and stable for 30+ days</li> <li> Confirmed need for &lt; 100ms global latency</li> <li> Budget approved (~$340/month additional)</li> <li> Engineering capacity for ongoing maintenance</li> </ul>"},{"location":"saas/multi-region-roadmap/#deliverables_3","title":"Deliverables","text":"Item Description Effort Global load balancer CloudFlare/AWS Global Accelerator 2-3 days NATS Virtual Streams Active-active message routing 3-5 days Conflict resolution Idempotency key strategy 2-3 days Consistency testing Validate no data loss 2-3 days Runbook updates Multi-region operations 1-2 days"},{"location":"saas/multi-region-roadmap/#architecture_3","title":"Architecture","text":"<pre><code>                 Global Load Balancer\n                 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                 \u2502  CloudFlare     \u2502\n                 \u2502  Anycast        \u2502\n                 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                          \u2502\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502                               \u2502\n          \u25bc                               \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Region 1           \u2502       \u2502  Region 2           \u2502\n\u2502  (Active)           \u2502       \u2502  (Active)           \u2502\n\u2502                     \u2502       \u2502                     \u2502\n\u2502  API \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u25ba API              \u2502\n\u2502       \u2502             \u2502       \u2502       \u2502             \u2502\n\u2502  NATS \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u25ba NATS          \u2502\n\u2502  (Virtual Streams)  \u2502       \u2502  (Virtual Streams)  \u2502\n\u2502                     \u2502       \u2502                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"saas/multi-region-roadmap/#key-considerations","title":"Key Considerations","text":""},{"location":"saas/multi-region-roadmap/#consistency-model","title":"Consistency Model","text":"<p>Active-Active requires accepting eventual consistency:</p> Operation Consistency Strategy Read Local Serve from nearest region Write Eventual Conflict resolution via timestamps Idempotency Global Distributed idempotency store"},{"location":"saas/multi-region-roadmap/#when-not-to-pursue-active-active","title":"When NOT to Pursue Active-Active","text":"<ul> <li>Current traffic &lt; 1000 req/min (single region sufficient)</li> <li>P99 latency acceptable at &lt; 500ms globally</li> <li>Team lacks distributed systems expertise</li> <li>Budget constraints</li> </ul>"},{"location":"saas/multi-region-roadmap/#estimated-effort_3","title":"Estimated Effort","text":"<p>Total: 2-3 weeks (if pursued)</p>"},{"location":"saas/multi-region-roadmap/#cost-summary","title":"Cost Summary","text":"Phase One-Time Monthly Cumulative Monthly Phase 10 (Current) - ~$340 $340 Phase 11: External Backup $0 +$20 (S3) $360 Phase 12: DNS Failover $0 +$5 (health checks) $365 Phase 13: Standby Cluster $0 +$200 (EKS) $565 Phase 14: Active-Active $0 +$200 (upgrade) $765 <p>Recommended stopping point: Phase 13 (~$565/month total)</p>"},{"location":"saas/multi-region-roadmap/#dependency-graph","title":"Dependency Graph","text":"<pre><code>Phase 10 (Current)\n    \u2502\n    \u25bc\nPhase 11: External Backup\n    \u2502\n    \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u25bc                  \u25bc\nPhase 12: DNS      Phase 13: Standby\n    \u2502                  \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n              \u2502\n              \u25bc\n    Phase 14: Active-Active\n         (Optional)\n</code></pre>"},{"location":"saas/multi-region-roadmap/#decision-points","title":"Decision Points","text":"After Phase Decision Criteria 11 Proceed to 12-13? Budget approved, RTO &lt; 15min required 13 Proceed to 14? Global latency requirements, &gt; 10k daily users"},{"location":"saas/multi-region-roadmap/#references","title":"References","text":"<ul> <li>Current Architecture: <code>docs/saas/architecture-current.md</code></li> <li>DR Contracts: <code>docs/saas/dr-contracts.md</code></li> <li>Research Findings: <code>docs/saas/multi-region-research.md</code></li> <li>Runbook: <code>docs/saas/runbook.md</code></li> </ul> <p>Last Updated: 2025-12-14 | Phase 10: STRATEGIZE</p>"},{"location":"saas/production-checklist/","title":"SaaS Production Readiness Checklist","text":"<p>Pre-launch verification for kgents SaaS infrastructure.</p>"},{"location":"saas/production-checklist/#overview","title":"Overview","text":"<p>This checklist ensures all critical systems are properly configured and secured before production launch.</p> <p>Legend: - <code>[x]</code> Complete - <code>[ ]</code> Pending - <code>[!]</code> Blocking (must fix before launch) - <code>[-]</code> N/A or deferred</p>"},{"location":"saas/production-checklist/#1-secrets-management","title":"1. Secrets Management","text":"Item Status Owner Notes All secrets in K8s Secrets (not ConfigMaps) [x] ops <code>kgents-api-secrets</code> OPENMETER_API_KEY stored securely [x] ops K8s Secret STRIPE_API_KEY stored securely [x] ops K8s Secret STRIPE_WEBHOOK_SECRET stored securely [x] ops K8s Secret No secrets in git history [x] dev Verified Secrets rotated within 90 days [ ] ops Schedule rotation Rotation policy documented [x] ops See runbook.md"},{"location":"saas/production-checklist/#required-environment-variables","title":"Required Environment Variables","text":"<pre><code># In kgents-api-secrets\nOPENMETER_API_KEY=om_live_xxx\nSTRIPE_API_KEY=sk_live_xxx\nSTRIPE_WEBHOOK_SECRET=whsec_xxx\n\n# Optional (with defaults)\nREDIS_URL=redis://triad-redis.kgents-triad.svc.cluster.local:6379\nNATS_SERVERS=nats://nats.kgents-agents.svc.cluster.local:4222\nNATS_ENABLED=true\n</code></pre>"},{"location":"saas/production-checklist/#2-network-policies","title":"2. Network Policies","text":"Item Status Owner Notes NATS cluster isolated [x] ops <code>manifests/network-policies/nats-policy.yaml</code> Redis isolated to triad namespace [x] ops <code>manifests/network-policies/redis-policy.yaml</code> API ingress rules defined [ ] ops Kong gateway in place Default deny policies [x] ops <code>manifests/network-policies/default-deny.yaml</code>"},{"location":"saas/production-checklist/#recommended-network-policy","title":"Recommended Network Policy","text":"<pre><code>apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: nats-access\n  namespace: kgents-agents\nspec:\n  podSelector:\n    matchLabels:\n      app.kubernetes.io/name: nats\n  policyTypes:\n    - Ingress\n  ingress:\n    - from:\n        - namespaceSelector:\n            matchLabels:\n              kgents.io/tier: gateway\n      ports:\n        - port: 4222\n</code></pre>"},{"location":"saas/production-checklist/#3-resource-limits","title":"3. Resource Limits","text":"Item Status Owner Notes CPU/memory limits on NATS pods [x] ops See statefulset.yaml CPU/memory limits on API pods [x] ops 100m-500m CPU, 256Mi-512Mi memory PodDisruptionBudget for NATS [x] ops <code>manifests/nats/pdb.yaml</code> minAvailable: 2 HPA for API [x] ops Scale on CPU 70%, 2-10 replicas LimitRange in kgents-agents [x] ops default 256Mi/100m"},{"location":"saas/production-checklist/#current-nats-resources","title":"Current NATS Resources","text":"<pre><code>resources:\n  requests:\n    cpu: 100m\n    memory: 256Mi\n  limits:\n    cpu: 500m\n    memory: 1Gi\n</code></pre>"},{"location":"saas/production-checklist/#recommended-pdb","title":"Recommended PDB","text":"<pre><code>apiVersion: policy/v1\nkind: PodDisruptionBudget\nmetadata:\n  name: nats-pdb\n  namespace: kgents-agents\nspec:\n  minAvailable: 2\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: nats\n</code></pre>"},{"location":"saas/production-checklist/#4-observability","title":"4. Observability","text":"Item Status Owner Notes Metrics endpoint exposed [x] dev <code>/metrics</code> on API Prometheus scraping [x] ops OTEL collector + direct Alerting rules deployed [x] ops 8 alerts configured Grafana dashboard imported [x] ops dashboard-saas.json Log aggregation [x] ops Loki + Promtail deployed (Phase 8). Grafana datasource configured. Distributed tracing [x] ops Tempo + OTEL"},{"location":"saas/production-checklist/#active-alerts","title":"Active Alerts","text":"Alert Severity Condition NATSCircuitOpen warning Circuit open 5m NATSCircuitOpenCritical critical Circuit open 15m NATSPodNotReady critical Pod not ready 5m OpenMeterFlushErrors warning Error rate &gt; 0.1/5m OpenMeterBufferFull warning Buffer &gt; 1000 events StripeWebhookErrors warning Error rate &gt; 0.1/5m HighAPILatency warning p95 &gt; 2s for 5m"},{"location":"saas/production-checklist/#5-disaster-recovery","title":"5. Disaster Recovery","text":"Item Status Owner Notes NATS data backup strategy [x] ops Daily CronJob backup (Phase 9) Circuit breaker recovery [x] dev Auto-recover after 30s Fallback queue strategy [x] dev In-memory queue during outage Idempotency store redundancy [x] dev Redis + in-memory fallback Runbook documented [x] ops docs/saas/runbook.md Rollback procedures [x] ops Blue/green with instant rollback Chaos baseline documented [x] dev docs/saas/chaos-baseline.md"},{"location":"saas/production-checklist/#recovery-procedures","title":"Recovery Procedures","text":"<ol> <li>NATS Failure: Circuit breaker opens, fallback queue buffers events (max 1000)</li> <li>Redis Failure: Automatic fallback to in-memory idempotency store</li> <li>OpenMeter Failure: Buffer continues, flush retries with exponential backoff</li> <li>Stripe Webhook Failure: Events redelivered by Stripe for 72h</li> </ol>"},{"location":"saas/production-checklist/#6-load-testing","title":"6. Load Testing","text":"Item Status Owner Notes Baseline throughput documented [x] dev 478 req/s achieved (target 100). See docs/saas/load-test-baseline.md OpenMeter rate limits known [ ] ops Check account limits NATS message rate tested [ ] dev Target: 1000 msg/s Memory leak testing [x] dev Soak test script ready (Phase 9). See docs/saas/soak-test-baseline.md Circuit breaker stress test [x] dev Chaos test script (Phase 9). See docs/saas/chaos-baseline.md"},{"location":"saas/production-checklist/#recommended-tests","title":"Recommended Tests","text":"<pre><code># k6 load test for /health/saas\nk6 run --vus 50 --duration 5m impl/claude/tests/load/saas-health.js\n\n# With custom API URL\nAPI_BASE_URL=https://api.kgents.io k6 run impl/claude/tests/load/saas-health.js\n\n# NATS benchmark\nnats bench test --pub 10 --sub 10 --size 1024 --msgs 10000\n</code></pre>"},{"location":"saas/production-checklist/#7-security-review","title":"7. Security Review","text":"Item Status Owner Notes Stripe webhook signature verification [x] dev Implemented Rate limiting on webhook endpoint [x] dev 100 req/min Input validation [x] dev Pydantic models No SQL injection risks [x] dev ORM only Dependency vulnerability scan [x] sec pip-audit: 1 LOW (pip CVE-2025-8869), no HIGH/CRITICAL Container image scan [x] sec Trivy: 0 HIGH/CRITICAL vulnerabilities in kgents/api:latest"},{"location":"saas/production-checklist/#8-documentation","title":"8. Documentation","text":"Item Status Owner Notes API documentation [x] dev OpenAPI spec Environment variables [x] docs environment-variables.md Health endpoints [x] docs health-endpoints.md Runbook [x] ops runbook.md Production checklist [x] ops This file"},{"location":"saas/production-checklist/#blocking-items-summary","title":"Blocking Items Summary","text":"Item Category Priority Status ~~Network policies for NATS~~ Security ~~High~~ RESOLVED ~~PodDisruptionBudget~~ Reliability ~~Medium~~ RESOLVED ~~Load testing baseline~~ Performance ~~Medium~~ RESOLVED ~~Log aggregation~~ Observability ~~Low~~ RESOLVED - Loki + Promtail deployed in Phase 8"},{"location":"saas/production-checklist/#9-multi-region-readiness-phase-10","title":"9. Multi-Region Readiness (Phase 10)","text":"Item Status Owner Notes Current architecture documented [x] docs <code>docs/saas/architecture-current.md</code> DR contracts defined [x] ops <code>docs/saas/dr-contracts.md</code> Multi-region research complete [x] dev <code>docs/saas/multi-region-research.md</code> Migration roadmap created [x] ops <code>docs/saas/multi-region-roadmap.md</code> Cost estimates approved [ ] finance ~$340/month for Active-Passive DR Phase 11 prerequisites [ ] ops S3/GCS bucket, Velero install"},{"location":"saas/production-checklist/#multi-region-prerequisites-for-phase-11","title":"Multi-Region Prerequisites (for Phase 11+)","text":"<p>Before proceeding to multi-region implementation:</p> <ul> <li> Budget approval for ~$340/month additional infrastructure</li> <li> AWS/GCP cross-region access configured</li> <li> Velero backup location credentials provisioned</li> <li> ArgoCD multi-cluster configuration planned</li> <li> DR drill schedule approved (monthly staging, quarterly prod)</li> </ul>"},{"location":"saas/production-checklist/#recommended-migration-path","title":"Recommended Migration Path","text":"Phase Description Effort Monthly Cost 11 External Backup (S3/Velero) 1-2 days +$20 12 Cross-Region DNS Failover 1 day +$5 13 Standby Cluster + NATS Mirror 3-5 days +$200 14 Active-Active (optional) 2-3 weeks +$200 <p>See: <code>docs/saas/multi-region-roadmap.md</code> for detailed implementation plans.</p>"},{"location":"saas/production-checklist/#launch-approval","title":"Launch Approval","text":"<ul> <li> All HIGH priority blocking items resolved</li> <li> Security review sign-off</li> <li> Operations team sign-off</li> <li> Development team sign-off</li> </ul> <p>Target Launch Date: TBD</p>"},{"location":"saas/production-checklist/#changelog","title":"Changelog","text":"<ul> <li>2025-12-14: Phase 10 Multi-Region Evaluation - Architecture documented, DR contracts, migration roadmap (Phases 11-14)</li> <li>2025-12-14: Phase 9 Production Hardening - Soak test script, blue/green deployment, API PDB, NATS backup CronJob, chaos baseline</li> <li>2025-12-14: Phase 8 Enterprise Ready - API deployed to K8s (2 replicas, HPA), Loki log aggregation, security scans complete (0 HIGH/CRITICAL)</li> <li>2025-12-14: Phase 7 Production Launch - Policies applied/verified, load test baseline (478 req/s), log aggregation deferred</li> <li>2025-12-14: Phase 6 Launch Prep - Network policies, PDB, and load tests created</li> <li>2025-12-14: Initial checklist created (Phase 5 Operate)</li> </ul>"},{"location":"saas/runbook/","title":"SaaS Infrastructure Runbook","text":"<p>Operational procedures for common scenarios and incidents.</p>"},{"location":"saas/runbook/#table-of-contents","title":"Table of Contents","text":"<ol> <li>Startup Procedures</li> <li>Shutdown Procedures</li> <li>Deployment &amp; Rollback</li> <li>Backup &amp; Restore</li> <li>Disaster Recovery</li> <li>Incident Response</li> <li>Common Issues</li> <li>Monitoring Alerts</li> </ol>"},{"location":"saas/runbook/#startup-procedures","title":"Startup Procedures","text":""},{"location":"saas/runbook/#deploy-nats-cluster","title":"Deploy NATS Cluster","text":"<pre><code># Check prerequisites\nkubectl cluster-info\nkubectl get ns kgents-agents || kubectl apply -f impl/claude/infra/k8s/manifests/namespace.yaml\n\n# Deploy NATS\nkubectl apply -k impl/claude/infra/k8s/manifests/nats/\n\n# Wait for pods\nkubectl rollout status statefulset/nats -n kgents-agents --timeout=120s\n\n# Verify cluster\nkubectl get pods -n kgents-agents -l app.kubernetes.io/name=nats\n</code></pre>"},{"location":"saas/runbook/#verify-nats-health","title":"Verify NATS Health","text":"<pre><code># Check pod status\nkubectl get pods -n kgents-agents -l app.kubernetes.io/name=nats\n\n# Check logs\nkubectl logs -n kgents-agents nats-0 -c nats\n\n# Check JetStream status\nkubectl exec -n kgents-agents nats-0 -- nats-server --version\n</code></pre>"},{"location":"saas/runbook/#deploy-api-with-saas-infrastructure","title":"Deploy API with SaaS Infrastructure","text":"<pre><code># Set secrets\nkubectl create secret generic kgents-api-secrets \\\n  -n kgents-agents \\\n  --from-literal=OPENMETER_API_KEY=om_live_xxx \\\n  --from-literal=STRIPE_API_KEY=sk_live_xxx \\\n  --from-literal=STRIPE_WEBHOOK_SECRET=whsec_xxx\n\n# Deploy API (assumes deployment manifest exists)\nkubectl apply -f impl/claude/infra/k8s/manifests/api/deployment.yaml\n\n# Verify SaaS health\ncurl https://api.kgents.io/health/saas\n</code></pre>"},{"location":"saas/runbook/#shutdown-procedures","title":"Shutdown Procedures","text":""},{"location":"saas/runbook/#graceful-api-shutdown","title":"Graceful API Shutdown","text":"<p>The API automatically: 1. Stops accepting new requests 2. Flushes OpenMeter buffer 3. Closes NATS connection</p> <pre><code># Scale down gracefully\nkubectl scale deployment kgents-api -n kgents-agents --replicas=0\n\n# Wait for pods to terminate\nkubectl wait --for=delete pod -l app=kgents-api -n kgents-agents --timeout=60s\n</code></pre>"},{"location":"saas/runbook/#nats-cluster-shutdown","title":"NATS Cluster Shutdown","text":"<pre><code># Scale down (preserves data)\nkubectl scale statefulset nats -n kgents-agents --replicas=0\n\n# Or delete entirely (loses data)\nkubectl delete -k impl/claude/infra/k8s/manifests/nats/\n</code></pre>"},{"location":"saas/runbook/#deployment-rollback","title":"Deployment &amp; Rollback","text":""},{"location":"saas/runbook/#bluegreen-deployment","title":"Blue/Green Deployment","text":"<p>The API uses a RollingUpdate strategy with zero-downtime guarantees:</p> <pre><code>strategy:\n  type: RollingUpdate\n  rollingUpdate:\n    maxSurge: 1        # Allow 1 extra pod during rollout\n    maxUnavailable: 0  # Never reduce below desired count\n</code></pre>"},{"location":"saas/runbook/#deploy-new-version","title":"Deploy New Version","text":"<pre><code># Option 1: Update image tag in manifest\n# Edit deployment.yaml: image: kgents/api:v1.x.x\nkubectl apply -f impl/claude/infra/k8s/manifests/api/deployment.yaml\n\n# Option 2: Direct image update\nkubectl set image deployment/kgent-api \\\n  api=kgents/api:v1.x.x \\\n  -n kgents-triad\n\n# Monitor rollout\nkubectl rollout status deployment/kgent-api -n kgents-triad --timeout=300s\n</code></pre>"},{"location":"saas/runbook/#rollback-procedures","title":"Rollback Procedures","text":""},{"location":"saas/runbook/#immediate-rollback-to-previous-version","title":"Immediate Rollback (to previous version)","text":"<pre><code># Rollback to previous revision\nkubectl rollout undo deployment/kgent-api -n kgents-triad\n\n# Verify rollback\nkubectl rollout status deployment/kgent-api -n kgents-triad\n</code></pre>"},{"location":"saas/runbook/#rollback-to-specific-version","title":"Rollback to Specific Version","text":"<pre><code># View rollout history\nkubectl rollout history deployment/kgent-api -n kgents-triad\n\n# Rollback to specific revision (e.g., revision 2)\nkubectl rollout undo deployment/kgent-api -n kgents-triad --to-revision=2\n\n# Verify\nkubectl get pods -n kgents-triad -l app.kubernetes.io/name=kgent-api -o jsonpath='{.items[*].spec.containers[0].image}'\n</code></pre>"},{"location":"saas/runbook/#emergency-scale-down","title":"Emergency Scale Down","text":"<pre><code># If rollback fails, scale down completely\nkubectl scale deployment/kgent-api -n kgents-triad --replicas=0\n\n# Investigate\nkubectl describe deployment/kgent-api -n kgents-triad\nkubectl logs -n kgents-triad -l app.kubernetes.io/name=kgent-api --previous\n</code></pre>"},{"location":"saas/runbook/#rollback-verification-checklist","title":"Rollback Verification Checklist","text":"<ul> <li> Pods running correct image version</li> <li> Health endpoints returning 200</li> <li> No error spikes in logs</li> <li> Metrics stable in Grafana</li> </ul> <p>See also: <code>docs/saas/deployment-checklist.md</code></p>"},{"location":"saas/runbook/#backup-restore","title":"Backup &amp; Restore","text":""},{"location":"saas/runbook/#quick-reference","title":"Quick Reference","text":"Component Schedule Retention Location Restore Time NATS JetStream Daily 2 AM UTC 7 days local, 30 days S3 PVC + S3 ~5 min Velero (K8s state) Daily 3 AM UTC 30 days S3 ~15 min Redis Not backed up N/A N/A Rebuild on deploy <p>One-liner health check: <pre><code>kubectl get cronjob,job -n kgents-agents -l app.kubernetes.io/name=nats-backup &amp;&amp; aws s3 ls s3://kgents-dr-backups/nats/ 2&gt;/dev/null | tail -1 || echo \"S3 not configured\"\n</code></pre></p>"},{"location":"saas/runbook/#service-level-indicators-slis","title":"Service Level Indicators (SLIs)","text":"SLI Target Measurement Alert Threshold Backup Freshness &lt; 25 hours <code>time() - last_successful_backup_time</code> Warning: 25h, Critical: 48h Backup Success Rate &gt; 99% <code>successful / total</code> over 30 days Warning: &lt; 99%, Critical: &lt; 95% Recovery Time Objective (RTO) &lt; 15 min Manual restore drill results N/A (drill-based) Recovery Point Objective (RPO) &lt; 24 hours Backup schedule (daily 2 AM UTC) Alert on 2 missed backups Off-site Replication Lag &lt; 48 hours <code>time() - last_s3_upload</code> Warning: 48h, Critical: 72h <p>Baseline Measurements (as of 2025-12-14): - Local backup time: ~30 seconds (empty JetStream) - S3 upload time: Pending S3 bucket configuration - Restore time: ~5 minutes (tested with manual restore)</p> <p>Dashboard: <code>kgents SaaS Infrastructure</code> \u2192 <code>Backup Health</code> row</p>"},{"location":"saas/runbook/#nats-jetstream-backup","title":"NATS JetStream Backup","text":"<p>Backups run daily at 2 AM UTC via CronJob.</p> <p>Storage Locations: - Local: <code>nats-backup-pvc</code> in <code>kgents-agents</code> (7-day retention) - Remote: S3 bucket <code>kgents-dr-backups/nats/</code> (30-day retention, if configured)</p>"},{"location":"saas/runbook/#manual-backup","title":"Manual Backup","text":"<pre><code># Trigger manual backup\nkubectl create job --from=cronjob/nats-backup nats-backup-manual -n kgents-agents\n\n# Watch progress\nkubectl logs -f job/nats-backup-manual -n kgents-agents\n\n# List local backups\nkubectl exec -n kgents-agents deploy/nats -- ls -la /backups/\n\n# List S3 backups (if configured)\naws s3 ls s3://kgents-dr-backups/nats/ --human-readable\n</code></pre>"},{"location":"saas/runbook/#restore-from-local-backup","title":"Restore from Local Backup","text":"<pre><code># List available local backups\nkubectl exec -n kgents-agents -it $(kubectl get pods -n kgents-agents -l app.kubernetes.io/name=nats -o jsonpath='{.items[0].metadata.name}') -- ls /backups/\n\n# Run restore (replace with actual backup filename)\nkubectl exec -n kgents-agents -it $(kubectl get pods -n kgents-agents -l app.kubernetes.io/name=nats -o jsonpath='{.items[0].metadata.name}') -- /scripts/restore.sh 20251214-020000.tar.gz\n</code></pre>"},{"location":"saas/runbook/#restore-from-s3-backup-cross-region-dr","title":"Restore from S3 Backup (Cross-Region DR)","text":"<p>Use this procedure when primary region is unavailable or for DR testing.</p> <pre><code># 1. List available S3 backups\naws s3 ls s3://kgents-dr-backups/nats/ --human-readable\n\n# 2. Download backup to local PVC\n# (From inside a pod with S3 access)\nkubectl run s3-restore --image=amazon/aws-cli:latest --rm -it \\\n  --env=\"AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}\" \\\n  --env=\"AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}\" \\\n  -- sh -c \"\n    aws s3 cp s3://kgents-dr-backups/nats/20251214-020000.tar.gz /tmp/\n    ls -la /tmp/*.tar.gz\n  \"\n\n# 3. Copy to NATS backup PVC\nkubectl cp /tmp/20251214-020000.tar.gz kgents-agents/nats-0:/backups/\n\n# 4. Run restore script\nkubectl exec -n kgents-agents -it nats-0 -- /scripts/restore.sh 20251214-020000.tar.gz\n</code></pre> <p>Alternative: Direct S3 restore with temporary pod</p> <pre><code># Create a restore job that downloads from S3 and restores\ncat &lt;&lt;EOF | kubectl apply -f -\napiVersion: batch/v1\nkind: Job\nmetadata:\n  name: nats-restore-from-s3\n  namespace: kgents-agents\nspec:\n  template:\n    spec:\n      restartPolicy: Never\n      containers:\n        - name: restore\n          image: natsio/nats-box:0.14.1\n          command: [\"/bin/sh\", \"-c\"]\n          args:\n            - |\n              # Download from S3\n              apk add --no-cache python3 py3-pip\n              pip3 install awscli\n              aws s3 cp s3://kgents-dr-backups/nats/20251214-020000.tar.gz /backups/\n              # Restore\n              /scripts/restore.sh 20251214-020000.tar.gz\n          env:\n            - name: AWS_ACCESS_KEY_ID\n              valueFrom:\n                secretKeyRef:\n                  name: nats-backup-s3\n                  key: AWS_ACCESS_KEY_ID\n            - name: AWS_SECRET_ACCESS_KEY\n              valueFrom:\n                secretKeyRef:\n                  name: nats-backup-s3\n                  key: AWS_SECRET_ACCESS_KEY\n            - name: AWS_DEFAULT_REGION\n              valueFrom:\n                secretKeyRef:\n                  name: nats-backup-s3\n                  key: AWS_DEFAULT_REGION\n          volumeMounts:\n            - name: backup-storage\n              mountPath: /backups\n            - name: backup-scripts\n              mountPath: /scripts\n      volumes:\n        - name: backup-storage\n          persistentVolumeClaim:\n            claimName: nats-backup-pvc\n        - name: backup-scripts\n          configMap:\n            name: nats-backup-script\n            defaultMode: 0755\nEOF\n\n# Watch progress\nkubectl logs -f job/nats-restore-from-s3 -n kgents-agents\n</code></pre> <p>Important Notes: - Restore only recovers stream/consumer configuration, not message data - For full message recovery, use NATS native <code>nats stream restore</code> with filesystem backup - Test restore in a non-production namespace first - S3 backups have longer retention (30 days) than local (7 days)</p>"},{"location":"saas/runbook/#backup-verification","title":"Backup Verification","text":"<pre><code># Check backup CronJob status\nkubectl get cronjob nats-backup -n kgents-agents\n\n# View recent backup jobs\nkubectl get jobs -n kgents-agents -l app.kubernetes.io/name=nats-backup\n\n# Check local backup PVC usage\nkubectl exec -n kgents-agents deploy/nats -- du -sh /backups/\n\n# Verify S3 backup exists (most recent)\naws s3 ls s3://kgents-dr-backups/nats/ --human-readable | tail -1\n</code></pre>"},{"location":"saas/runbook/#velero-cluster-state-backup","title":"Velero Cluster State Backup","text":"<p>Velero backs up Kubernetes resources and PVCs daily at 3 AM UTC.</p> <p>Storage Location: S3 bucket <code>kgents-dr-backups/velero/</code> (30-day retention)</p>"},{"location":"saas/runbook/#manual-backup_1","title":"Manual Backup","text":"<pre><code># Create manual backup\nvelero backup create manual-backup-$(date +%Y%m%d) \\\n  --include-namespaces kgents-triad,kgents-agents\n\n# Watch progress\nvelero backup describe manual-backup-$(date +%Y%m%d) --details\n\n# List all backups\nvelero backup get\n</code></pre>"},{"location":"saas/runbook/#restore-from-velero-backup","title":"Restore from Velero Backup","text":"<pre><code># List available backups\nvelero backup get\n\n# Describe a specific backup\nvelero backup describe daily-kgents-backup-20251214 --details\n\n# Full restore (to same namespaces)\nvelero restore create --from-backup daily-kgents-backup-20251214\n\n# Restore to different namespaces (staging test)\nvelero restore create --from-backup daily-kgents-backup-20251214 \\\n  --namespace-mappings kgents-agents:kgents-agents-staging,kgents-triad:kgents-triad-staging\n\n# Watch restore progress\nvelero restore describe &lt;restore-name&gt; --details\n</code></pre>"},{"location":"saas/runbook/#restore-specific-resources","title":"Restore Specific Resources","text":"<pre><code># Restore only ConfigMaps and Secrets\nvelero restore create --from-backup daily-kgents-backup-20251214 \\\n  --include-resources configmaps,secrets\n\n# Restore only a specific namespace\nvelero restore create --from-backup daily-kgents-backup-20251214 \\\n  --include-namespaces kgents-agents\n</code></pre>"},{"location":"saas/runbook/#velero-verification","title":"Velero Verification","text":"<pre><code># Check Velero pods\nkubectl get pods -n velero\n\n# Check backup storage location status\nvelero backup-location get\n\n# Check schedule status\nvelero schedule get\n\n# Check most recent backup\nvelero backup get | head -2\n</code></pre>"},{"location":"saas/runbook/#redis-backup-future","title":"Redis Backup (Future)","text":"<p>Redis backup is not currently configured. Data in Redis is primarily idempotency keys with short TTL. Loss of Redis data results in: - Potential duplicate webhook processing (mitigated by Stripe idempotency) - Need to rebuild rate limit counters</p>"},{"location":"saas/runbook/#backup-troubleshooting","title":"Backup Troubleshooting","text":"<p>Common backup issues and resolutions:</p>"},{"location":"saas/runbook/#cronjob-not-running","title":"CronJob Not Running","text":"<p>Symptoms: No recent jobs in <code>kubectl get jobs -n kgents-agents</code></p> <p>Diagnosis: <pre><code># Check CronJob status\nkubectl get cronjob nats-backup -n kgents-agents -o yaml | grep -A5 \"status:\"\n\n# Check for scheduling issues\nkubectl describe cronjob nats-backup -n kgents-agents | grep -A10 \"Events:\"\n</code></pre></p> <p>Resolution: <pre><code># Verify CronJob exists\nkubectl get cronjob nats-backup -n kgents-agents\n\n# If missing, apply manifests\nkubectl apply -k impl/claude/infra/k8s/manifests/nats/\n\n# Trigger manual backup to verify\nkubectl create job --from=cronjob/nats-backup test-backup -n kgents-agents\n</code></pre></p>"},{"location":"saas/runbook/#backup-job-failing","title":"Backup Job Failing","text":"<p>Symptoms: Job status shows <code>Failed</code>, pods in <code>Error</code> state</p> <p>Diagnosis: <pre><code># View job logs\nkubectl logs -n kgents-agents -l job-name=nats-backup-xxxxx\n\n# Check pod events\nkubectl describe pod -n kgents-agents -l job-name=nats-backup-xxxxx\n</code></pre></p> <p>Common Causes:</p> Error Message Cause Resolution <code>PVC not found</code> Backup PVC missing <code>kubectl apply -k manifests/nats/</code> <code>connection refused</code> NATS not running Check NATS StatefulSet health <code>permission denied</code> Script not executable ConfigMap mode issue, reapply <code>No space left</code> PVC full Increase PVC size or run cleanup"},{"location":"saas/runbook/#s3-upload-failing","title":"S3 Upload Failing","text":"<p>Symptoms: Backup completes but no files in S3</p> <p>Diagnosis: <pre><code># Check if S3 credentials configured\nkubectl get secret nats-backup-s3 -n kgents-agents -o json | jq '.data | keys'\n\n# Test S3 access\nkubectl run s3-test --image=amazon/aws-cli:latest --rm -it \\\n  --env-from=secret/nats-backup-s3 \\\n  -- s3 ls s3://kgents-dr-backups/\n</code></pre></p> <p>Common Causes:</p> Error Message Cause Resolution <code>S3/GCS upload skipped</code> Secret not configured Apply <code>backup-s3-secret.yaml</code> <code>AccessDenied</code> IAM policy issue Verify <code>iam-policy.json</code> applied <code>NoSuchBucket</code> Bucket doesn't exist Create bucket in AWS/GCP console <code>Timeout</code> Network policy blocking Check egress rules for S3"},{"location":"saas/runbook/#restore-failing","title":"Restore Failing","text":"<p>Symptoms: Restore script errors, streams not recreated</p> <p>Diagnosis: <pre><code># Check restore logs\nkubectl logs -f job/nats-restore -n kgents-agents\n\n# Verify backup integrity\nkubectl exec -n kgents-agents nats-0 -- tar -tzf /backups/&lt;backup&gt;.tar.gz\n</code></pre></p> <p>Common Causes:</p> Error Message Cause Resolution <code>Archive corrupt</code> Incomplete backup Use older backup <code>Stream already exists</code> Partial restore Delete existing streams first <code>Invalid JSON</code> Format incompatibility Check NATS version match"},{"location":"saas/runbook/#pvc-full-cleanup-not-running","title":"PVC Full / Cleanup Not Running","text":"<p>Symptoms: Backup fails with disk space error</p> <p>Diagnosis: <pre><code># Check PVC usage\nkubectl exec -n kgents-agents nats-0 -- df -h /backups\n\n# List backups\nkubectl exec -n kgents-agents nats-0 -- ls -la /backups/\n</code></pre></p> <p>Resolution: <pre><code># Manual cleanup (delete backups older than 3 days)\nkubectl exec -n kgents-agents nats-0 -- \\\n  find /backups -name \"*.tar.gz\" -mtime +3 -delete\n\n# Verify space freed\nkubectl exec -n kgents-agents nats-0 -- df -h /backups\n</code></pre></p>"},{"location":"saas/runbook/#degraded-mode-operations","title":"Degraded Mode Operations","text":"<p>What happens when components are unavailable:</p>"},{"location":"saas/runbook/#s3-unavailable","title":"S3 Unavailable","text":"<p>Impact: Backups continue locally; no off-site copy Detection: Check job logs for \"S3/GCS upload skipped\" Action: - Monitor local backup retention (7 days) - Prioritize S3 connectivity fix if outage &gt; 3 days - Consider manual backup copy: <code>kubectl cp kgents-agents/nats-0:/backups ./local-backup/</code></p>"},{"location":"saas/runbook/#nats-unavailable","title":"NATS Unavailable","text":"<p>Impact: Backup job fails; no new backups created Detection: Job status <code>Failed</code>, logs show connection errors Action: - Fix NATS cluster first (see NATS section) - Backups will resume automatically when NATS recovers - If prolonged, verify last successful backup is recent</p>"},{"location":"saas/runbook/#pvc-approaching-capacity","title":"PVC Approaching Capacity","text":"<p>Impact: New backups may fail; retention cleanup may fail Detection: <code>df -h /backups</code> shows &gt; 80% usage Action: <pre><code># Check current usage\nkubectl exec -n kgents-agents nats-0 -- du -sh /backups/*\n\n# Manual cleanup if needed\nkubectl exec -n kgents-agents nats-0 -- \\\n  find /backups -name \"*.tar.gz\" -mtime +3 -delete\n\n# Consider PVC resize if recurring\nkubectl edit pvc nats-backup-pvc -n kgents-agents\n</code></pre></p>"},{"location":"saas/runbook/#velero-unavailable","title":"Velero Unavailable","text":"<p>Impact: K8s resource backups stop; NATS data backups unaffected Detection: <code>velero backup-location get</code> shows unavailable Action: - Check Velero pods: <code>kubectl get pods -n velero</code> - Check S3 connectivity from Velero namespace - NATS backup is independent; data still protected</p>"},{"location":"saas/runbook/#s3-setup-prerequisites-platform-engineers","title":"S3 Setup Prerequisites (Platform Engineers)","text":"<p>Complete these steps before enabling S3 backup integration:</p>"},{"location":"saas/runbook/#step-1-create-s3-bucket","title":"Step 1: Create S3 Bucket","text":"<pre><code># Create bucket with versioning\naws s3api create-bucket \\\n  --bucket kgents-dr-backups \\\n  --region us-west-2 \\\n  --create-bucket-configuration LocationConstraint=us-west-2\n\naws s3api put-bucket-versioning \\\n  --bucket kgents-dr-backups \\\n  --versioning-configuration Status=Enabled\n\n# Set lifecycle policy for 30-day retention\naws s3api put-bucket-lifecycle-configuration \\\n  --bucket kgents-dr-backups \\\n  --lifecycle-configuration file://lifecycle.json\n</code></pre> <p><code>lifecycle.json</code>: <pre><code>{\n  \"Rules\": [\n    {\n      \"ID\": \"nats-backup-expiration\",\n      \"Status\": \"Enabled\",\n      \"Filter\": {\"Prefix\": \"nats/\"},\n      \"Expiration\": {\"Days\": 30}\n    },\n    {\n      \"ID\": \"velero-backup-expiration\",\n      \"Status\": \"Enabled\",\n      \"Filter\": {\"Prefix\": \"velero/\"},\n      \"Expiration\": {\"Days\": 30}\n    }\n  ]\n}\n</code></pre></p>"},{"location":"saas/runbook/#step-2-create-iam-policy","title":"Step 2: Create IAM Policy","text":"<p>Apply the least-privilege policy from <code>manifests/nats/iam-policy.json</code>:</p> <pre><code># Create policy\naws iam create-policy \\\n  --policy-name kgents-backup-policy \\\n  --policy-document file://impl/claude/infra/k8s/manifests/nats/iam-policy.json\n\n# Create user for backups\naws iam create-user --user-name kgents-backup-sa\n\n# Attach policy\naws iam attach-user-policy \\\n  --user-name kgents-backup-sa \\\n  --policy-arn arn:aws:iam::ACCOUNT_ID:policy/kgents-backup-policy\n\n# Create access key\naws iam create-access-key --user-name kgents-backup-sa &gt; credentials.json\n</code></pre>"},{"location":"saas/runbook/#step-3-create-kubernetes-secret","title":"Step 3: Create Kubernetes Secret","text":"<pre><code># Create secret from credentials\nkubectl create secret generic nats-backup-s3 \\\n  -n kgents-agents \\\n  --from-literal=AWS_ACCESS_KEY_ID=$(jq -r '.AccessKey.AccessKeyId' credentials.json) \\\n  --from-literal=AWS_SECRET_ACCESS_KEY=$(jq -r '.AccessKey.SecretAccessKey' credentials.json) \\\n  --from-literal=AWS_DEFAULT_REGION=us-west-2 \\\n  --from-literal=S3_BUCKET=kgents-dr-backups\n\n# Verify secret exists\nkubectl get secret nats-backup-s3 -n kgents-agents\n</code></pre>"},{"location":"saas/runbook/#step-4-verify-integration","title":"Step 4: Verify Integration","text":"<pre><code># Trigger manual backup\nkubectl create job --from=cronjob/nats-backup nats-backup-s3-test -n kgents-agents\n\n# Watch logs for S3 upload\nkubectl logs -f job/nats-backup-s3-test -n kgents-agents\n\n# Verify in S3\naws s3 ls s3://kgents-dr-backups/nats/ --human-readable\n</code></pre>"},{"location":"saas/runbook/#checklist","title":"Checklist","text":"<ul> <li> S3 bucket created with versioning enabled</li> <li> Lifecycle policy applied (30-day retention)</li> <li> IAM policy created from <code>iam-policy.json</code></li> <li> IAM user created with policy attached</li> <li> Kubernetes secret created with credentials</li> <li> Manual backup test shows S3 upload successful</li> <li> S3 backup visible in bucket listing</li> </ul>"},{"location":"saas/runbook/#disaster-recovery","title":"Disaster Recovery","text":"<p>Cross-region failover procedures for major outages. See <code>docs/saas/dr-contracts.md</code> for RPO/RTO targets.</p>"},{"location":"saas/runbook/#recovery-targets","title":"Recovery Targets","text":"Component RTO RPO Priority API &lt; 5 min N/A P0 NATS Streams &lt; 15 min &lt; 5 min P0 Secrets/Config &lt; 30 min &lt; 1 hour P0 Observability &lt; 1 hour N/A P2"},{"location":"saas/runbook/#failover-decision-checklist","title":"Failover Decision Checklist","text":"<p>Before initiating failover, confirm:</p> <ul> <li> Primary region confirmed unreachable (not just degraded)</li> <li> Multiple health checks failing (not transient)</li> <li> Estimated recovery time in primary &gt; RTO targets</li> <li> DR region verified healthy</li> <li> Stakeholders notified</li> </ul>"},{"location":"saas/runbook/#failover-procedure","title":"Failover Procedure","text":""},{"location":"saas/runbook/#step-1-declare-dr-event","title":"Step 1: Declare DR Event","text":"<pre><code># Notify team\necho \"DR EVENT DECLARED: $(date -u +%Y-%m-%dT%H:%M:%SZ)\" &gt;&gt; /tmp/dr-log.txt\n\n# Record start time for RTO measurement\nexport DR_START=$(date +%s)\n</code></pre>"},{"location":"saas/runbook/#step-2-dns-failover","title":"Step 2: DNS Failover","text":"<pre><code># Option A: Route53 (if using AWS)\naws route53 change-resource-record-sets \\\n  --hosted-zone-id $HOSTED_ZONE_ID \\\n  --change-batch '{\n    \"Changes\": [{\n      \"Action\": \"UPSERT\",\n      \"ResourceRecordSet\": {\n        \"Name\": \"api.kgents.io\",\n        \"Type\": \"A\",\n        \"AliasTarget\": {\n          \"HostedZoneId\": \"$DR_ALB_ZONE\",\n          \"DNSName\": \"$DR_ALB_DNS\",\n          \"EvaluateTargetHealth\": true\n        }\n      }\n    }]\n  }'\n\n# Option B: CloudFlare\ncurl -X PATCH \"https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID\" \\\n  -H \"Authorization: Bearer $CF_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  --data '{\"content\": \"$DR_IP\"}'\n</code></pre>"},{"location":"saas/runbook/#step-3-verify-dr-region-health","title":"Step 3: Verify DR Region Health","text":"<pre><code># Wait for DNS propagation (60s TTL)\nsleep 60\n\n# Verify API health in DR\ncurl -sf https://api.kgents.io/health || echo \"WARN: Health check failed\"\ncurl -sf https://api.kgents.io/health/saas || echo \"WARN: SaaS health failed\"\n\n# Verify NATS mirror status\nkubectl --context=dr exec -n kgents-agents nats-0 -- \\\n  nats stream info AGENTESE_MIRROR --json | jq '.mirror.lag'\n</code></pre>"},{"location":"saas/runbook/#step-4-verify-state-sync","title":"Step 4: Verify State Sync","text":"<pre><code># Check secrets are current\nkubectl --context=dr get externalsecret -n kgents-triad -o wide\n\n# Check ArgoCD sync status\nargocd --server $DR_ARGOCD app get kgents-saas --output json | jq '.status.sync.status'\n</code></pre>"},{"location":"saas/runbook/#step-5-record-recovery-time","title":"Step 5: Record Recovery Time","text":"<pre><code>DR_END=$(date +%s)\nRTO_ACTUAL=$((DR_END - DR_START))\n\necho \"RTO: ${RTO_ACTUAL}s (target: 300s)\"\n\nif [ $RTO_ACTUAL -lt 300 ]; then\n  echo \"PASS: Within RTO target\"\nelse\n  echo \"FAIL: Exceeded RTO target\"\nfi\n</code></pre>"},{"location":"saas/runbook/#step-6-post-failover-communication","title":"Step 6: Post-Failover Communication","text":"<ul> <li> Update status page (status.kgents.io)</li> <li> Notify affected customers</li> <li> Alert internal stakeholders</li> <li> Log incident in incident tracker</li> </ul>"},{"location":"saas/runbook/#failback-procedure","title":"Failback Procedure","text":"<p>After primary region recovers:</p>"},{"location":"saas/runbook/#step-1-verify-primary-health","title":"Step 1: Verify Primary Health","text":"<pre><code># Check all pods healthy\nkubectl --context=primary get pods -n kgents-triad\nkubectl --context=primary get pods -n kgents-agents\n\n# Verify NATS cluster\nkubectl --context=primary exec -n kgents-agents nats-0 -- nats server check\n</code></pre>"},{"location":"saas/runbook/#step-2-resync-state","title":"Step 2: Resync State","text":"<pre><code># Trigger ArgoCD sync\nargocd --server $PRIMARY_ARGOCD app sync kgents-saas\n\n# Verify secrets synced\nkubectl --context=primary get externalsecret -n kgents-triad -o wide\n</code></pre>"},{"location":"saas/runbook/#step-3-gradual-traffic-shift","title":"Step 3: Gradual Traffic Shift","text":"<pre><code># Route53: Enable weighted routing\n# Start with 10% traffic to primary\naws route53 change-resource-record-sets \\\n  --hosted-zone-id $HOSTED_ZONE_ID \\\n  --change-batch file://weighted-10-primary.json\n\n# Monitor error rates for 15 minutes\n# If healthy, increase to 50%, then 100%\n</code></pre>"},{"location":"saas/runbook/#step-4-complete-failback","title":"Step 4: Complete Failback","text":"<pre><code># Full traffic to primary\naws route53 change-resource-record-sets \\\n  --hosted-zone-id $HOSTED_ZONE_ID \\\n  --change-batch file://full-primary.json\n\n# Verify\ndig api.kgents.io +short\n</code></pre>"},{"location":"saas/runbook/#communication-templates","title":"Communication Templates","text":""},{"location":"saas/runbook/#status-page-update-failover","title":"Status Page Update (Failover)","text":"<pre><code>Title: Service Degradation - Failover in Progress\nStatus: Investigating \u2192 Identified \u2192 Monitoring\n\nWe are experiencing issues with our primary region and have initiated\nfailover to our disaster recovery site. Service may be briefly interrupted.\n\nExpected resolution: Within 15 minutes\nImpact: API requests may fail briefly during transition\n\nUpdates will be posted every 5 minutes.\n</code></pre>"},{"location":"saas/runbook/#status-page-update-recovered","title":"Status Page Update (Recovered)","text":"<pre><code>Title: Service Restored\nStatus: Resolved\n\nFailover to DR region complete. All services operating normally.\nWe are monitoring for any residual issues.\n\nRoot cause analysis will be shared within 24 hours.\n</code></pre>"},{"location":"saas/runbook/#dr-drill-schedule","title":"DR Drill Schedule","text":"Frequency Scope Environment Monthly DNS failover only Staging Quarterly Full DR drill Staging Annually Full DR drill Production (planned maintenance)"},{"location":"saas/runbook/#dr-metrics-to-track","title":"DR Metrics to Track","text":"<p>After each DR event or drill:</p> <ul> <li> Time to detect (TTD)</li> <li> Time to failover (RTO actual)</li> <li> Data loss measured (RPO actual)</li> <li> Customer impact duration</li> <li> Lessons learned documented</li> </ul> <p>See: <code>docs/saas/dr-contracts.md</code> for full contract specifications.</p>"},{"location":"saas/runbook/#incident-response","title":"Incident Response","text":""},{"location":"saas/runbook/#nats-circuit-breaker-open","title":"NATS Circuit Breaker Open","text":"<p>Symptoms: - <code>/health/saas</code> shows <code>nats.status: circuit_open</code> - Dashboard shows <code>kgents_nats_circuit_state = 1</code> - Fallback queue depth increasing</p> <p>Response:</p> <ol> <li> <p>Check NATS cluster health    <pre><code>kubectl get pods -n kgents-agents -l app.kubernetes.io/name=nats\nkubectl logs -n kgents-agents nats-0 -c nats --tail=50\n</code></pre></p> </li> <li> <p>Check network connectivity    <pre><code>kubectl exec -n kgents-agents deploy/kgents-api -- nc -zv nats.kgents-agents.svc 4222\n</code></pre></p> </li> <li> <p>If NATS is healthy, circuit will auto-recover in 30s</p> </li> <li> <p>If NATS is down, restart cluster    <pre><code>kubectl rollout restart statefulset/nats -n kgents-agents\n</code></pre></p> </li> </ol>"},{"location":"saas/runbook/#openmeter-flush-failures","title":"OpenMeter Flush Failures","text":"<p>Symptoms: - <code>kgents_openmeter_flush_errors_total</code> increasing - Buffer depth growing - Events not appearing in OpenMeter dashboard</p> <p>Response:</p> <ol> <li> <p>Check OpenMeter health    <pre><code>curl -H \"Authorization: Bearer $OPENMETER_API_KEY\" \\\n  https://openmeter.cloud/api/v1/meters\n</code></pre></p> </li> <li> <p>Check API logs for errors    <pre><code>kubectl logs -n kgents-agents deploy/kgents-api --tail=100 | grep -i openmeter\n</code></pre></p> </li> <li> <p>Verify API key is valid</p> </li> <li> <p>If API key expired, rotate:    <pre><code>kubectl create secret generic kgents-api-secrets \\\n  -n kgents-agents \\\n  --from-literal=OPENMETER_API_KEY=om_live_new_xxx \\\n  --dry-run=client -o yaml | kubectl apply -f -\nkubectl rollout restart deployment/kgents-api -n kgents-agents\n</code></pre></p> </li> </ol>"},{"location":"saas/runbook/#stripe-webhook-failures","title":"Stripe Webhook Failures","text":"<p>Symptoms: - <code>kgents_stripe_webhooks_errors_total</code> increasing - <code>/webhooks/stripe/health</code> shows errors - Stripe dashboard shows failed deliveries</p> <p>Response:</p> <ol> <li> <p>Check webhook secret    <pre><code>kubectl get secret kgents-api-secrets -n kgents-agents -o jsonpath='{.data.STRIPE_WEBHOOK_SECRET}' | base64 -d\n</code></pre></p> </li> <li> <p>Verify in Stripe Dashboard \u2192 Developers \u2192 Webhooks</p> </li> <li> <p>Check for signature verification errors in logs    <pre><code>kubectl logs -n kgents-agents deploy/kgents-api --tail=100 | grep -i stripe\n</code></pre></p> </li> <li> <p>Rotate webhook secret if compromised:</p> </li> <li>Generate new secret in Stripe Dashboard</li> <li>Update Kubernetes secret</li> <li>Restart API</li> </ol>"},{"location":"saas/runbook/#common-issues","title":"Common Issues","text":""},{"location":"saas/runbook/#issue-saas-infrastructure-not-available","title":"Issue: \"SaaS infrastructure not available\"","text":"<p>Cause: SaaS config module not imported</p> <p>Solution: - Ensure <code>protocols.config</code> module is accessible - Check <code>PYTHONPATH</code> in deployment</p>"},{"location":"saas/runbook/#issue-nats-connection-refused","title":"Issue: \"NATS connection refused\"","text":"<p>Cause: NATS not running or wrong address</p> <p>Solution: 1. Check NATS pods are running 2. Verify <code>NATS_SERVERS</code> environment variable 3. Check network policies allow traffic</p>"},{"location":"saas/runbook/#issue-openmeter-401-unauthorized","title":"Issue: \"OpenMeter 401 Unauthorized\"","text":"<p>Cause: Invalid or expired API key</p> <p>Solution: 1. Verify API key in OpenMeter dashboard 2. Update secret and restart</p>"},{"location":"saas/runbook/#issue-circuit-breaker-stuck-open","title":"Issue: \"Circuit breaker stuck open\"","text":"<p>Cause: NATS failures not recovering</p> <p>Solution: 1. Check NATS cluster health 2. Manually reset circuit (requires code change or restart) 3. Increase <code>failure_threshold</code> if false positives</p>"},{"location":"saas/runbook/#issue-fallback-queue-full","title":"Issue: \"Fallback queue full\"","text":"<p>Cause: NATS down for extended period</p> <p>Solution: 1. Fix NATS cluster 2. Events in fallback queue will be lost if API restarts 3. Consider increasing queue size in NATSBridge config</p>"},{"location":"saas/runbook/#monitoring-alerts","title":"Monitoring Alerts","text":""},{"location":"saas/runbook/#recommended-alert-rules","title":"Recommended Alert Rules","text":"<pre><code>groups:\n  - name: kgents-saas\n    rules:\n      - alert: NATSCircuitOpen\n        expr: kgents_nats_circuit_state == 1\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: NATS circuit breaker is open\n          description: NATS circuit breaker has been open for 5 minutes\n\n      - alert: OpenMeterFlushErrors\n        expr: rate(kgents_openmeter_flush_errors_total[5m]) &gt; 0.1\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: OpenMeter flush errors detected\n          description: OpenMeter is experiencing flush errors\n\n      - alert: StripeWebhookErrors\n        expr: rate(kgents_stripe_webhooks_errors_total[5m]) &gt; 0.1\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: Stripe webhook errors detected\n          description: Stripe webhooks are failing\n\n      - alert: HighAPILatency\n        expr: histogram_quantile(0.95, rate(kgents_api_request_latency_seconds_bucket[5m])) &gt; 2\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: High API latency detected\n          description: 95th percentile API latency is above 2 seconds\n</code></pre>"},{"location":"saas/runbook/#contact","title":"Contact","text":"<p>For escalation: - Infrastructure: Check <code>impl/claude/infra/k8s/</code> for deployment details - Billing: Check <code>impl/claude/protocols/billing/</code> for integration code - API: Check <code>impl/claude/protocols/api/</code> for endpoint code</p>"},{"location":"saas/soak-test-baseline/","title":"SaaS Soak Test Baseline","text":"<p>Long-running stability validation for kgents SaaS infrastructure.</p>"},{"location":"saas/soak-test-baseline/#overview","title":"Overview","text":"<p>Soak testing validates system stability over extended periods, detecting: - Memory leaks - Resource exhaustion - Latency degradation - Connection pool exhaustion - Circuit breaker patterns</p> <p>Test Script: <code>impl/claude/tests/load/saas-soak.js</code></p>"},{"location":"saas/soak-test-baseline/#test-configurations","title":"Test Configurations","text":""},{"location":"saas/soak-test-baseline/#full-soak-test-production-validation","title":"Full Soak Test (Production Validation)","text":"<pre><code>k6 run --vus 10 --duration 24h impl/claude/tests/load/saas-soak.js\n</code></pre> Parameter Value Duration 24 hours Virtual Users 10 constant Endpoints <code>/health/saas</code>, <code>/v1/agentese/resolve</code> Request Rate ~20 req/s sustained"},{"location":"saas/soak-test-baseline/#accelerated-soak-test-cistaging","title":"Accelerated Soak Test (CI/Staging)","text":"<pre><code>k6 run --vus 25 --duration 4h impl/claude/tests/load/saas-soak.js\n</code></pre> Parameter Value Duration 4 hours Virtual Users 25 constant Endpoints <code>/health/saas</code>, <code>/v1/agentese/resolve</code> Request Rate ~50 req/s sustained"},{"location":"saas/soak-test-baseline/#quick-validation-development","title":"Quick Validation (Development)","text":"<pre><code>k6 run --vus 10 --duration 1h impl/claude/tests/load/saas-soak.js\n</code></pre>"},{"location":"saas/soak-test-baseline/#thresholds","title":"Thresholds","text":"Metric Threshold Rationale Health p95 latency &lt; 200ms Stricter than baseline for stability Agentese p95 latency &lt; 300ms Accounts for business logic Error rate &lt; 0.1% Near-zero tolerance for soak Memory growth &lt; 10% over baseline Detect leaks"},{"location":"saas/soak-test-baseline/#baseline-results","title":"Baseline Results","text":""},{"location":"saas/soak-test-baseline/#test-run-date","title":"Test Run: [DATE]","text":"<p>Configuration: - Duration: ___ hours - VUs: ___ - Environment: ___</p> <p>Results:</p> Metric Value Status Total Requests ___ \u2014 Requests/sec ___ \u2014 Error Rate ___% [ ] Pass Health p95 ___ ms [ ] Pass Health p99 ___ ms [ ] Pass Agentese p95 ___ ms [ ] Pass Circuit Breaker Activations ___ \u2014 Memory Growth Indicator ___x [ ] Pass <p>Stability Analysis:</p> <ul> <li> Latency remained stable throughout test</li> <li> No memory leak indicators (growth &lt; 10%)</li> <li> Error rate stayed below threshold</li> <li> No circuit breaker issues</li> </ul>"},{"location":"saas/soak-test-baseline/#memory-leak-detection","title":"Memory Leak Detection","text":"<p>The soak test tracks latency growth as a proxy for memory leaks:</p> <pre><code>Memory Growth Indicator = Current Latency / Baseline Latency\n</code></pre> Indicator Interpretation &lt; 1.1x Healthy (&lt; 10% growth) 1.1x - 1.5x Warning (investigate) &gt; 1.5x Critical (likely leak)"},{"location":"saas/soak-test-baseline/#if-memory-leak-detected","title":"If Memory Leak Detected","text":"<ol> <li> <p>Identify the source: <pre><code># Check API memory in Prometheus/Grafana\n# Query: container_memory_usage_bytes{container=\"api\"}\n</code></pre></p> </li> <li> <p>Profile the application: <pre><code># Enable memory profiling\nkubectl exec -n kgents-triad deploy/kgent-api -- python -c \"import tracemalloc; tracemalloc.start()\"\n</code></pre></p> </li> <li> <p>Common causes:</p> </li> <li>Unclosed connections (NATS, Redis)</li> <li>Growing caches without eviction</li> <li>Event handler accumulation</li> <li>Large request/response buffering</li> </ol>"},{"location":"saas/soak-test-baseline/#grafana-dashboard","title":"Grafana Dashboard","text":""},{"location":"saas/soak-test-baseline/#recommended-panels-for-soak-testing","title":"Recommended Panels for Soak Testing","text":"<ol> <li> <p>Memory Over Time <pre><code>container_memory_usage_bytes{container=\"api\", namespace=\"kgents-triad\"}\n</code></pre></p> </li> <li> <p>Latency Percentiles Over Time <pre><code>histogram_quantile(0.95, rate(kgents_api_request_latency_seconds_bucket[5m]))\n</code></pre></p> </li> <li> <p>Error Rate Over Time <pre><code>rate(kgents_api_request_errors_total[5m])\n</code></pre></p> </li> <li> <p>Circuit Breaker State <pre><code>kgents_nats_circuit_state\n</code></pre></p> </li> </ol>"},{"location":"saas/soak-test-baseline/#running-the-test","title":"Running the Test","text":""},{"location":"saas/soak-test-baseline/#prerequisites","title":"Prerequisites","text":"<ol> <li>k6 installed: <code>brew install k6</code></li> <li>API running locally or accessible</li> <li>Grafana/Prometheus available for monitoring</li> </ol>"},{"location":"saas/soak-test-baseline/#execute","title":"Execute","text":"<pre><code># Set environment variables\nexport API_BASE_URL=http://localhost:8000\nexport SOAK_DURATION=4h\nexport SOAK_VUS=10\n\n# Run test\nk6 run impl/claude/tests/load/saas-soak.js\n\n# Output saved to: soak-test-results.json\n</code></pre>"},{"location":"saas/soak-test-baseline/#monitor-during-test","title":"Monitor During Test","text":"<pre><code># Watch API memory\nkubectl top pods -n kgents-triad -l app.kubernetes.io/name=kgent-api --watch\n\n# Watch circuit breaker\nwatch 'curl -s localhost:8000/health/saas | jq .nats'\n\n# Watch k6 output\n# (k6 will print progress and final summary)\n</code></pre>"},{"location":"saas/soak-test-baseline/#historical-results","title":"Historical Results","text":"Date Duration VUs Error Rate Health p95 Memory Growth Status ___ ___ h ___ ___% ___ ms ___x [ ] Pass"},{"location":"saas/soak-test-baseline/#ci-integration","title":"CI Integration","text":"<pre><code># Example GitHub Actions job\nsoak-test:\n  runs-on: ubuntu-latest\n  timeout-minutes: 300  # 5 hours max\n  steps:\n    - uses: actions/checkout@v4\n    - uses: grafana/k6-action@v0.3.0\n      with:\n        filename: impl/claude/tests/load/saas-soak.js\n        flags: --vus 25 --duration 4h\n      env:\n        API_BASE_URL: ${{ secrets.STAGING_API_URL }}\n    - uses: actions/upload-artifact@v3\n      with:\n        name: soak-test-results\n        path: soak-test-results.json\n</code></pre>"},{"location":"saas/soak-test-baseline/#next-steps","title":"Next Steps","text":"<p>After successful soak test: 1. Record baseline in this document 2. Add memory trend panel to Grafana 3. Configure alert for memory growth &gt; 20% 4. Schedule weekly soak tests in staging</p> <p>Last Updated: 2025-12-14 | Phase 9: Production Hardening</p>"},{"location":"skills/","title":"Agent Skills Directory","text":"<p>\"Skills are crystallized knowledge. Agents pull what they need, when they need it.\"</p> <p>This directory contains skill documents\u2014detailed how-to guides for common development tasks in the kgents codebase. Unlike ephemeral session knowledge, skills are persistent, versioned, and discoverable.</p>"},{"location":"skills/#purpose","title":"Purpose","text":"<p>When an agent (Claude or otherwise) needs to perform a specific task, they can:</p> <ol> <li>Pull: Read a skill document to learn the canonical way to do something</li> <li>Apply: Follow the documented pattern to complete the task</li> <li>Contribute: Add new skills when they learn something novel</li> </ol> <p>This creates a flywheel of knowledge accumulation: - Agent completes task \u2192 Documents pattern \u2192 Future agents benefit</p>"},{"location":"skills/#directory-structure","title":"Directory Structure","text":"<pre><code>docs/skills/\n\u251c\u2500\u2500 README.md                    # This file\n\u251c\u2500\u2500 agentese-path.md             # How to add an AGENTESE path\n\u251c\u2500\u2500 agentese-repl.md             # Interactive REPL guide (Wave 2)\n\u251c\u2500\u2500 agent-observability.md       # Adding observability to agents\n\u251c\u2500\u2500 agent-town-visualization.md  # Scatter plots, SSE, NATS for Agent Town\n\u251c\u2500\u2500 building-agent.md            # Create Agent[A, B] with functors\n\u251c\u2500\u2500 defensive-component-lifecycle.md  # Error boundaries, toasts, async state\n\u251c\u2500\u2500 cli-command.md               # How to add a CLI command\n\u251c\u2500\u2500 flux-agent.md                # How to create a Flux agent\n\u251c\u2500\u2500 handler-patterns.md          # Common handler patterns\n\u251c\u2500\u2500 hotdata-pattern.md           # Pre-computed data for demos/tests\n\u251c\u2500\u2500 plan-file.md                 # Writing plan files (Forest Protocol)\n\u251c\u2500\u2500 polynomial-agent.md          # Create PolyAgent[S, A, B] with modes\n\u251c\u2500\u2500 reconciliation-session.md    # Audit and sync forest state\n\u251c\u2500\u2500 test-patterns.md             # Testing patterns and conventions\n\u2514\u2500\u2500 n-phase-cycle/               # Implementation lifecycle skills\n    \u251c\u2500\u2500 README.md                # Index and usage guide\n    \u251c\u2500\u2500 plan.md                  # PLAN phase skill\n    \u251c\u2500\u2500 research.md              # RESEARCH phase skill\n    \u251c\u2500\u2500 develop.md               # DEVELOP phase skill\n    \u251c\u2500\u2500 strategize.md            # STRATEGIZE phase skill\n    \u251c\u2500\u2500 cross-synergize.md       # CROSS-SYNERGIZE phase skill\n    \u251c\u2500\u2500 implement.md             # IMPLEMENT phase skill\n    \u251c\u2500\u2500 qa.md                    # QA phase skill\n    \u251c\u2500\u2500 test.md                  # TEST phase skill\n    \u251c\u2500\u2500 educate.md               # EDUCATE phase skill\n    \u251c\u2500\u2500 measure.md               # MEASURE phase skill\n    \u251c\u2500\u2500 reflect.md               # REFLECT phase skill\n    \u251c\u2500\u2500 meta-skill-operad.md     # Category-theoretic skill mutation\n    \u251c\u2500\u2500 meta-re-metabolize.md    # Lifecycle refresh protocol\n    \u251c\u2500\u2500 lookback-revision.md     # Oblique retrospection cycle\n    \u251c\u2500\u2500 process-metrics.md       # Lifecycle instrumentation\n    \u2514\u2500\u2500 re-metabolize-slash-command.md  # /re-metabolize design\n</code></pre>"},{"location":"skills/#how-agents-should-use-this","title":"How Agents Should Use This","text":""},{"location":"skills/#discovery-pull-pattern","title":"Discovery (Pull Pattern)","text":"<p>When starting a task that might have a documented skill:</p> <pre><code>1. Check if docs/skills/ has a relevant document\n2. Read the skill document\n3. Follow the documented pattern\n4. Note any deviations or improvements\n</code></pre>"},{"location":"skills/#contribution-push-pattern","title":"Contribution (Push Pattern)","text":"<p>After completing a novel task:</p> <pre><code>1. Check if the pattern is general enough to document\n2. Create a new skill document following the template below\n3. Reference related skills and cross-link\n</code></pre>"},{"location":"skills/#skill-document-template","title":"Skill Document Template","text":"<pre><code># Skill: [Name]\n\n&gt; One-line description of what this skill enables\n\n**Difficulty**: Easy | Medium | Hard\n**Prerequisites**: [List of required knowledge]\n**Files Touched**: [Typical files modified]\n\n---\n\n## Overview\n\nBrief explanation of when and why you'd use this skill.\n\n---\n\n## Step-by-Step\n\n### Step 1: [Action]\n\nWhat to do and why.\n\n**File**: `path/to/file.py`\n**Pattern**:\n\\`\\`\\`python\n# Code example\n\\`\\`\\`\n\n### Step 2: [Action]\n\n...\n\n---\n\n## Verification\n\nHow to confirm the skill was applied correctly.\n\n---\n\n## Common Pitfalls\n\n- Pitfall 1: Description and how to avoid\n- Pitfall 2: ...\n\n---\n\n## Related Skills\n\n- [Related Skill 1](related-skill-1.md)\n- [Related Skill 2](related-skill-2.md)\n\n---\n\n## Changelog\n\n- YYYY-MM-DD: Initial version\n</code></pre>"},{"location":"skills/#index-of-skills","title":"Index of Skills","text":"Skill Description Difficulty agentese-path Add a new AGENTESE path (e.g., <code>self.soul.*</code>) Medium agentese-repl Interactive REPL for AGENTESE navigation and composition Easy-Medium agent-observability Adding observability to agents Medium agent-town-visualization Eigenvector scatter, SSE streaming, NATS bridge Medium defensive-component-lifecycle Error boundaries, async state, toasts, offline detection Easy-Medium building-agent Create a well-formed <code>Agent[A, B]</code> with functors Medium cli-command Add a new CLI command to kgents Easy flux-agent Lift an agent to continuous stream processing Medium frontend-contracts Validate backend JSON matches frontend TypeScript types Easy-Medium handler-patterns Common patterns for CLI handlers Easy-Medium hotdata-pattern Pre-computed LLM data for demos/tests (AD-004) Easy plan-file Write plan files following the Forest Protocol Easy polynomial-agent Create <code>PolyAgent[S, A, B]</code> with state-dependent behavior Medium-Advanced reconciliation-session Audit, surface, and sync forest state Medium saas-patterns SaaS infrastructure patterns (webhooks, NATS, NetworkPolicy, Kind) Medium test-patterns Testing patterns and conventions Easy-Medium Lifecycle three-phase Default: SENSE\u2192ACT\u2192REFLECT (compresses 11 phases) Easy n-phase-cycle/ Full 11-phase lifecycle (Crown Jewels only) Varies n-phase-cycle/plan Frame intent, scope, and constraints Easy n-phase-cycle/research Map terrain, surface blockers Medium n-phase-cycle/develop Shape specs/APIs, sharpen edges Medium n-phase-cycle/strategize Sequence moves for leverage Medium n-phase-cycle/cross-synergize Find combinatorial lifts Medium n-phase-cycle/implement Ship code with compositional fidelity Medium n-phase-cycle/qa Quality gates, checklists, hygiene Easy-Medium n-phase-cycle/test Verification depth and coverage Medium n-phase-cycle/educate Teach users how to wield the work Easy n-phase-cycle/measure Instrumentation and effect tracking Medium n-phase-cycle/reflect Distill learnings, seed next loop Easy n-phase-cycle/meta-skill-operad Category-theoretic mutation protocol Medium n-phase-cycle/meta-re-metabolize Lifecycle refresh endofunctor Medium n-phase-cycle/lookback-revision Oblique retrospection (double-loop) Medium n-phase-cycle/process-metrics Lifecycle instrumentation/tracing Medium"},{"location":"skills/#future-skills-to-document","title":"Future Skills (To Document)","text":"<ul> <li> Writing Type I-V tests (T-gent patterns)</li> <li> Creating a Tongue (DSL)</li> <li> Implementing a protocol handler</li> <li> Adding metrics and observability (Terrarium integration)</li> <li> Implementing the Rodizio pattern (human-in-the-loop semaphores)</li> <li> Sheaf emergence patterns (SOUL_SHEAF gluing)</li> </ul> <p>\"The best documentation is the one that exists when you need it.\"</p>"},{"location":"skills/agent-observability/","title":"Skill: Agent Observability","text":"<p>Add metrics, mirrors, pheromones, and debugging support to agents.</p> <p>Difficulty: Medium Prerequisites: Understanding of Agent[A, B] protocol, FluxAgent basics Files Touched: <code>impl/claude/protocols/terrarium/</code>, <code>impl/claude/agents/i/</code>, <code>impl/claude/agents/flux/</code> References: <code>protocols/terrarium/mirror.py</code>, <code>agents/i/semantic_field.py</code>, <code>agents/flux/metabolism.py</code></p>"},{"location":"skills/agent-observability/#overview","title":"Overview","text":"<p>kgents has three observability systems that work together:</p> System Purpose Key Files Mirror Protocol Real-time UI streaming <code>protocols/terrarium/mirror.py</code> Metabolism Resource tracking (entropy, temperature) <code>agents/flux/metabolism.py</code> SemanticField Inter-agent pheromone signaling <code>agents/i/semantic_field.py</code> <p>Key Principle: \"To Observe is to Disturb\" (AGENTESE). 50 observers should NOT cost the agent 50x entropy. The Mirror Protocol decouples observation from computation.</p>"},{"location":"skills/agent-observability/#mirror-protocol-terrarium-tui","title":"Mirror Protocol (Terrarium TUI)","text":"<p>The HolographicBuffer enables fire-and-forget event emission:</p> <pre><code>from protocols.terrarium.mirror import HolographicBuffer\n\n# Agent side: emit events once\nbuffer = HolographicBuffer(max_history=100)\n\nasync def my_agent_work():\n    result = compute_something()\n\n    # Fire and forget - never blocks\n    await buffer.reflect({\n        \"type\": \"result\",\n        \"agent_id\": \"my-agent\",\n        \"data\": result,\n        \"timestamp\": datetime.now().isoformat(),\n    })\n\n# Observer side: attach to buffer\nasync def websocket_handler(websocket):\n    await buffer.attach_mirror(websocket)\n    # Late joiners receive history (\"The Ghost\")\n    # All future events broadcast automatically\n\n    # Cleanup when done\n    buffer.detach_mirror(websocket)\n</code></pre>"},{"location":"skills/agent-observability/#design-principles","title":"Design Principles","text":"<ol> <li>reflect() is fire-and-forget: Agent never waits for observers</li> <li>Broadcast failures don't propagate: Slow clients are cleaned up automatically</li> <li>Late joiners receive history: \"The Ghost\" provides catch-up</li> <li>Disconnected observers auto-cleaned: No manual cleanup needed</li> </ol>"},{"location":"skills/agent-observability/#buffer-properties","title":"Buffer Properties","text":"<pre><code>buffer.observer_count   # Number of active mirrors\nbuffer.history_length   # Current history length\nbuffer.events_reflected # Total events emitted\n\n# REST endpoint support\nsnapshot = buffer.get_snapshot()  # Get current history without WebSocket\n</code></pre>"},{"location":"skills/agent-observability/#metabolism-resource-tracking","title":"Metabolism (Resource Tracking)","text":"<p>FluxMetabolism connects FluxAgents to the MetabolicEngine for entropy tracking:</p> <pre><code>from agents.flux import Flux, FluxConfig\nfrom agents.flux.metabolism import FluxMetabolism, create_flux_metabolism\nfrom protocols.agentese.metabolism import MetabolicEngine, FeverEvent\n\n# Create metabolism adapter\nengine = MetabolicEngine(critical_threshold=0.5)\nmetabolism = create_flux_metabolism(\n    engine=engine,\n    input_tokens=50,    # Estimated input tokens per event\n    output_tokens=100,  # Estimated output tokens per event\n)\n\n# Attach to FluxAgent\nflux = Flux.lift(my_agent)\nflux.attach_metabolism(metabolism)\n\n# Process events - metabolism tracked automatically\nasync for result in flux.start(event_stream):\n    print(metabolism.status())\n    # {\n    #   \"pressure\": 0.35,\n    #   \"temperature\": 0.5,\n    #   \"in_fever\": False,\n    #   \"events_metabolized\": 42,\n    #   \"fevers_triggered\": 0,\n    # }\n</code></pre>"},{"location":"skills/agent-observability/#fever-handling","title":"Fever Handling","text":"<p>When metabolic pressure exceeds threshold, fever triggers:</p> <pre><code>async def on_fever(event: FeverEvent) -&gt; None:\n    \"\"\"Creative interruption - system running hot.\"\"\"\n    print(f\"Fever! Intensity: {event.intensity}\")\n    print(f\"Oblique strategy: {event.oblique_strategy}\")\n    # Take creative action, tithe, or cool down\n\nmetabolism = FluxMetabolism(\n    engine=engine,\n    on_fever=on_fever,  # Callback when fever triggers\n)\n</code></pre>"},{"location":"skills/agent-observability/#voluntary-discharge-tithe","title":"Voluntary Discharge (Tithe)","text":"<pre><code># Voluntarily discharge pressure (gratitude pattern)\nresult = metabolism.tithe(amount=0.1)\n# {\n#   \"discharged\": 0.1,\n#   \"remaining_pressure\": 0.25,\n#   \"gratitude\": \"The Accursed Share accepts your tithe.\",\n# }\n</code></pre>"},{"location":"skills/agent-observability/#key-insight","title":"Key Insight","text":"<p>Two types of entropy:</p> <ul> <li>Flux entropy (J-gent): Per-agent computational budget (local)</li> <li>Metabolic entropy (void.entropy): System-wide activity pressure (global)</li> </ul> <p>They work together\u2014flux bounds individual computation, metabolism tracks overall \"heat\".</p>"},{"location":"skills/agent-observability/#metrics-emission-terrarium","title":"Metrics Emission (Terrarium)","text":"<p>The MetricsManager emits periodic metabolism events for visualization:</p> <pre><code>from protocols.terrarium.metrics import MetricsManager, emit_metrics_loop\nfrom protocols.terrarium.mirror import HolographicBuffer\n\nmanager = MetricsManager(default_interval=1.0)\n\n# Start metrics emission for an agent\nmanager.start_metrics(\n    agent_id=\"flux-001\",\n    flux_agent=flux,\n    buffer=buffer,\n    interval=1.0,  # Emit every second\n)\n\n# Events emitted to buffer:\n# {\n#   \"event_type\": \"metabolism\",\n#   \"agent_id\": \"flux-001\",\n#   \"pressure\": 35.0,     # Queue backlog (0-100)\n#   \"flow\": 10.5,         # Events/second throughput\n#   \"temperature\": 0.42,  # Entropy consumption rate (0-1)\n#   \"state\": \"running\",\n# }\n\n# Stop when done\nmanager.stop_metrics(\"flux-001\")\n</code></pre>"},{"location":"skills/agent-observability/#metric-calculations","title":"Metric Calculations","text":"Metric Meaning Calculation <code>pressure</code> Queue backlog Output queue fullness + perturbation backlog <code>flow</code> Throughput Events processed / time delta <code>temperature</code> Entropy rate Consumed entropy ratio OR metabolic temperature"},{"location":"skills/agent-observability/#fever-alerts","title":"Fever Alerts","text":"<pre><code>from protocols.terrarium.metrics import emit_fever_alert\n\n# Emit when temperature exceeds threshold\nawait emit_fever_alert(\n    agent_id=\"flux-001\",\n    buffer=buffer,\n    temperature=0.92,\n    threshold=0.8,\n)\n# Emits: {\"event_type\": \"fever\", \"severity\": \"high\", ...}\n</code></pre>"},{"location":"skills/agent-observability/#semanticfield-pheromone-communication","title":"SemanticField (Pheromone Communication)","text":"<p>Agents communicate indirectly via pheromones deposited in a shared field:</p> <pre><code>from agents.i.semantic_field import (\n    SemanticField,\n    SemanticPheromoneKind,\n    FieldCoordinate,\n    MetaphorPayload,\n    WarningPayload,\n)\n\nfield = SemanticField()\n\n# Agent A emits a pheromone\npheromone_id = field.emit(\n    emitter=\"psi-gent\",\n    kind=SemanticPheromoneKind.METAPHOR,\n    payload=MetaphorPayload(\n        source_domain=\"database query\",\n        target_domain=\"topological sort\",\n        confidence=0.8,\n    ),\n    position=FieldCoordinate(domain=\"optimization\"),\n    intensity=1.0,\n)\n\n# Agent B senses nearby pheromones (doesn't know about A)\npheromones = field.sense(\n    position=FieldCoordinate(domain=\"optimization\"),\n    kinds={SemanticPheromoneKind.METAPHOR},\n)\n\nfor p in pheromones:\n    print(f\"Found metaphor: {p.payload.description}\")\n</code></pre>"},{"location":"skills/agent-observability/#pheromone-types","title":"Pheromone Types","text":"Kind Emitter Purpose Decay Rate <code>METAPHOR</code> Psi-gent Functor[P,K] for pattern matching Slow (0.1) <code>INTENT</code> F-gent Artifact creation intent Moderate (0.2) <code>WARNING</code> J-gent Safety alerts (broadcast widely) Fast (0.3) <code>OPPORTUNITY</code> B-gent Economic signals Moderate (0.15) <code>CAPABILITY</code> L-gent Agent capability advertisement Very slow (0.02) <code>STATE</code> D-gent Data state changes Medium (0.15) <code>TEST</code> T-gent Test results Fast (0.25)"},{"location":"skills/agent-observability/#decay-and-sensing","title":"Decay and Sensing","text":"<pre><code># Pheromones decay over time\nfield.tick(dt=1.0)  # Apply time decay\n\n# Sense with radius\npheromones = field.sense(\n    position=my_position,\n    radius=0.5,  # Semantic distance in embedding space\n    kinds={SemanticPheromoneKind.WARNING},  # Filter by type\n    min_intensity=0.1,  # Ignore faded pheromones\n)\n\n# Subscribe to deposit events\ndef on_deposit(pheromone):\n    print(f\"New pheromone from {pheromone.emitter}\")\n\nfield._on_deposit.append(on_deposit)\n</code></pre>"},{"location":"skills/agent-observability/#stigmergic-coordination","title":"Stigmergic Coordination","text":"<p>Agents coordinate without knowing each other:</p> <pre><code># Psi-gent deposits metaphor (doesn't know F exists)\nfield.emit(\n    emitter=\"psi-gent\",\n    kind=SemanticPheromoneKind.METAPHOR,\n    payload=MetaphorPayload(\n        source_domain=\"file system\",\n        target_domain=\"tree traversal\",\n        confidence=0.9,\n    ),\n    position=FieldCoordinate(domain=\"data_structures\"),\n)\n\n# F-gent senses metaphors (doesn't know Psi exists)\nmetaphors = field.sense(\n    position=FieldCoordinate(domain=\"data_structures\"),\n    kinds={SemanticPheromoneKind.METAPHOR},\n)\n\n# Result: Complete decoupling via shared environment\n</code></pre>"},{"location":"skills/agent-observability/#integration-example","title":"Integration Example","text":"<p>Combining all three systems:</p> <pre><code>from protocols.terrarium.mirror import HolographicBuffer\nfrom protocols.terrarium.metrics import MetricsManager\nfrom agents.flux import Flux, FluxConfig\nfrom agents.flux.metabolism import create_flux_metabolism\nfrom agents.i.semantic_field import SemanticField, SemanticPheromoneKind\n\n# 1. Create infrastructure\nbuffer = HolographicBuffer()\nmetrics = MetricsManager()\nfield = SemanticField()\nengine = MetabolicEngine()\n\n# 2. Create metabolized FluxAgent\nmetabolism = create_flux_metabolism(engine=engine)\nflux = Flux.lift(my_agent)\nflux.attach_metabolism(metabolism)\n\n# 3. Start metrics emission\nmetrics.start_metrics(\"my-agent\", flux, buffer)\n\n# 4. Process with pheromone emission\nasync for result in flux.start(event_stream):\n    # Emit result to mirror (for UI)\n    await buffer.reflect({\n        \"type\": \"result\",\n        \"agent_id\": \"my-agent\",\n        \"data\": result,\n    })\n\n    # Emit pheromone to field (for other agents)\n    if result.is_significant:\n        field.emit(\n            emitter=\"my-agent\",\n            kind=SemanticPheromoneKind.STATE,\n            payload={\"changed\": result.key},\n            position=FieldCoordinate(domain=\"state_updates\"),\n        )\n\n# 5. Clean up\nmetrics.stop_metrics(\"my-agent\")\n</code></pre>"},{"location":"skills/agent-observability/#debugging-patterns","title":"Debugging Patterns","text":""},{"location":"skills/agent-observability/#status-inspection","title":"Status Inspection","text":"<pre><code># Metabolism status\nprint(metabolism.status())\n\n# Buffer status\nprint(f\"Observers: {buffer.observer_count}\")\nprint(f\"Events: {buffer.events_reflected}\")\n\n# Field status\nprint(f\"Active pheromones: {len([p for p in field._pheromones.values() if p.is_active])}\")\n</code></pre>"},{"location":"skills/agent-observability/#event-tracing","title":"Event Tracing","text":"<pre><code># Log all pheromone deposits\ndef trace_deposits(pheromone):\n    print(f\"[{pheromone.emitter}] {pheromone.kind.name}: {pheromone.payload}\")\n\nfield._on_deposit.append(trace_deposits)\n</code></pre>"},{"location":"skills/agent-observability/#mirror-snapshots","title":"Mirror Snapshots","text":"<pre><code># Get current state without WebSocket\nevents = buffer.get_snapshot()\nfor event in events[-10:]:  # Last 10 events\n    print(event)\n</code></pre>"},{"location":"skills/agent-observability/#quick-reference","title":"Quick Reference","text":""},{"location":"skills/agent-observability/#holographicbuffer","title":"HolographicBuffer","text":"<pre><code>buffer = HolographicBuffer(max_history=100)\nawait buffer.reflect(event)         # Fire and forget\nawait buffer.attach_mirror(ws)      # Connect observer\nbuffer.detach_mirror(ws)            # Disconnect\nbuffer.get_snapshot()               # REST-friendly\nbuffer.clear_history()              # Reset\n</code></pre>"},{"location":"skills/agent-observability/#fluxmetabolism","title":"FluxMetabolism","text":"<pre><code>metabolism = create_flux_metabolism(engine=engine)\nflux.attach_metabolism(metabolism)\nawait metabolism.consume(event)     # Called per event\nmetabolism.tithe(0.1)               # Voluntary discharge\nmetabolism.status()                 # Full status dict\nmetabolism.pressure                 # Current pressure\nmetabolism.temperature              # Token ratio\nmetabolism.in_fever                 # Fever state\n</code></pre>"},{"location":"skills/agent-observability/#semanticfield","title":"SemanticField","text":"<pre><code>field = SemanticField()\nfield.emit(emitter, kind, payload, position)  # Deposit\nfield.sense(position, radius, kinds)          # Query\nfield.tick(dt)                                # Apply decay\nfield.deposit(pheromone)                      # Direct deposit\n</code></pre>"},{"location":"skills/agent-observability/#related-skills","title":"Related Skills","text":"<ul> <li>building-agent - Creating well-formed agents</li> <li>flux-agent - Streaming agents</li> <li>test-patterns - Testing with observability</li> </ul>"},{"location":"skills/agent-observability/#changelog","title":"Changelog","text":"<ul> <li>2025-12-12: Initial version synthesizing Mirror, Metabolism, and SemanticField patterns</li> </ul>"},{"location":"skills/agent-town-archetypes/","title":"Skill: Agent Town Archetypes","text":"<p>Create and manage citizen archetypes with eigenvector biases</p> <p>Difficulty: Easy-Medium Prerequisites: Understanding of Agent Town citizens, eigenvectors Files Touched: <code>agents/town/archetypes.py</code>, <code>agents/town/citizen.py</code></p>"},{"location":"skills/agent-town-archetypes/#overview","title":"Overview","text":"<p>Archetypes represent cosmotechnical approaches to the world. Each archetype has: 1. Eigenvector biases \u2014 Deviations from 0.5 baseline 2. Cosmotechnics \u2014 Associated skill/technique 3. Factory functions \u2014 Create citizens with appropriate defaults</p>"},{"location":"skills/agent-town-archetypes/#the-five-archetypes","title":"The Five Archetypes","text":"Archetype Cosmotechnics Key Biases Role Builder CONSTRUCTION_V2 creativity\u2191, patience\u2191, ambition\u2191 Infrastructure creation Trader EXCHANGE_V2 curiosity\u2191, trust\u2193, ambition\u2191\u2191 Resource exchange Healer RESTORATION warmth\u2191\u2191, patience\u2191, trust\u2191 Social/emotional repair Scholar SYNTHESIS_V2 curiosity\u2191\u2191, patience\u2191 Skill discovery, teaching Watcher MEMORY_V2 patience\u2191\u2191, trust\u2191, resilience\u2191 Memory witnesses, historians"},{"location":"skills/agent-town-archetypes/#quick-start","title":"Quick Start","text":""},{"location":"skills/agent-town-archetypes/#creating-an-archetype-citizen","title":"Creating an Archetype Citizen","text":"<pre><code>from agents.town.archetypes import create_builder, create_healer\n\n# Create a builder\nbob = create_builder(\"bob\", seed=42)\nprint(bob.eigenvectors.creativity)  # ~0.7 (baseline 0.5 + bias 0.2)\n\n# Create a healer\neve = create_healer(\"eve\")\nprint(eve.eigenvectors.warmth)  # ~0.75 (baseline 0.5 + bias 0.25)\n</code></pre>"},{"location":"skills/agent-town-archetypes/#creating-evolving-archetypes","title":"Creating Evolving Archetypes","text":"<pre><code>from agents.town.archetypes import create_archetype, ArchetypeKind\nfrom agents.town.evolving import create_evolving_citizen\n\n# Create via generic factory\nscholar = create_archetype(\"ada\", ArchetypeKind.SCHOLAR)\n\n# Create evolving version (N-Phase lifecycle)\nevolving_scholar = create_evolving_citizen(scholar)\n</code></pre>"},{"location":"skills/agent-town-archetypes/#archetype-specifications","title":"Archetype Specifications","text":""},{"location":"skills/agent-town-archetypes/#archetypespec-dataclass","title":"ArchetypeSpec Dataclass","text":"<pre><code>@dataclass(frozen=True)\nclass ArchetypeSpec:\n    kind: ArchetypeKind\n    cosmotechnics: Cosmotechnics\n    warmth_bias: float = 0.0      # [-0.5, 0.5]\n    curiosity_bias: float = 0.0\n    trust_bias: float = 0.0\n    creativity_bias: float = 0.0\n    patience_bias: float = 0.0\n    resilience_bias: float = 0.0\n    ambition_bias: float = 0.0\n</code></pre>"},{"location":"skills/agent-town-archetypes/#the-registry","title":"The Registry","text":"<pre><code>from agents.town.archetypes import ARCHETYPE_SPECS, ArchetypeKind\n\n# Access spec\nbuilder_spec = ARCHETYPE_SPECS[ArchetypeKind.BUILDER]\nprint(builder_spec.creativity_bias)  # 0.2\n</code></pre>"},{"location":"skills/agent-town-archetypes/#eigenvector-space-7d","title":"Eigenvector Space (7D)","text":"<p>Each citizen has 7 eigenvector dimensions:</p> Dimension Description Range Warmth Social disposition [0, 1] Curiosity Openness to new information [0, 1] Trust Willingness to cooperate [0, 1] Creativity Novel solution generation [0, 1] Patience Tolerance for delay [0, 1] Resilience Recovery from setbacks [0, 1] Ambition Goal-seeking intensity [0, 1]"},{"location":"skills/agent-town-archetypes/#operations-on-eigenvectors","title":"Operations on Eigenvectors","text":"<pre><code>from agents.town.citizen import Eigenvectors\n\nev1 = citizen_a.eigenvectors\nev2 = citizen_b.eigenvectors\n\n# Cosine similarity (for coalition detection)\nsimilarity = ev1.similarity(ev2)  # [0, 1]\n\n# Bounded drift (evolution)\nnew_ev = ev1.drift(warmth=0.05, creativity=-0.02)  # Clamped to [0, 1]\n</code></pre>"},{"location":"skills/agent-town-archetypes/#drift-laws-7d-metric","title":"Drift Laws (7D Metric)","text":"<p>The eigenvector space preserves metric laws:</p> Law Description Verification Identity <code>drift(0, ..., 0) = self</code> <code>ev.drift() == ev</code> Symmetry <code>dist(a, b) = dist(b, a)</code> <code>ev1.similarity(ev2) == ev2.similarity(ev1)</code> Triangle <code>dist(a, c) &lt;= dist(a, b) + dist(b, c)</code> Cosine distance forms metric"},{"location":"skills/agent-town-archetypes/#factory-patterns","title":"Factory Patterns","text":""},{"location":"skills/agent-town-archetypes/#simple-factory","title":"Simple Factory","text":"<pre><code>def create_builder(name: str, seed: int | None = None) -&gt; Citizen:\n    \"\"\"Create a Builder archetype citizen.\"\"\"\n    return create_archetype(name, ArchetypeKind.BUILDER, seed=seed)\n</code></pre>"},{"location":"skills/agent-town-archetypes/#generic-factory","title":"Generic Factory","text":"<pre><code>from agents.town.archetypes import create_archetype, ArchetypeKind\n\n# Create any archetype\ncitizen = create_archetype(\n    name=\"alice\",\n    kind=ArchetypeKind.HEALER,\n    seed=42,  # Reproducible variance\n)\n</code></pre>"},{"location":"skills/agent-town-archetypes/#evolving-factory","title":"Evolving Factory","text":"<pre><code>from agents.town.archetypes import create_evolving_archetype, ArchetypeKind\n\n# Create evolving citizen with N-Phase lifecycle\nevolving = create_evolving_archetype(\n    name=\"ada\",\n    kind=ArchetypeKind.SCHOLAR,\n)\n# evolving has: lifecycle_phase, evolve(), decay()\n</code></pre>"},{"location":"skills/agent-town-archetypes/#composing-archetypes","title":"Composing Archetypes","text":""},{"location":"skills/agent-town-archetypes/#town-with-mixed-archetypes","title":"Town with Mixed Archetypes","text":"<pre><code>from agents.town.environment import TownEnvironment\nfrom agents.town.archetypes import (\n    create_builder, create_trader, create_healer,\n    create_scholar, create_watcher,\n)\n\n# Create a balanced town (Phase 4 recipe)\ntown = TownEnvironment(\n    name=\"Harmony\",\n    citizens={\n        \"bob\": create_builder(\"bob\"),\n        \"eve\": create_trader(\"eve\"),\n        \"dan\": create_healer(\"dan\"),\n        \"ada\": create_scholar(\"ada\"),\n        \"max\": create_watcher(\"max\"),\n    },\n)\n</code></pre>"},{"location":"skills/agent-town-archetypes/#25-citizen-town-phase-4-default","title":"25-Citizen Town (Phase 4 Default)","text":"<pre><code>from agents.town.environment import create_phase4_environment\n\n# Creates 25 citizens: 5 archetypes x 5 each\ntown = create_phase4_environment(name=\"Metropolis\")\n</code></pre>"},{"location":"skills/agent-town-archetypes/#heritage-papers-realized","title":"Heritage Papers Realized","text":"Paper Implementation CHATDEV Multi-agent roles (Builder, Trader, Healer, Scholar, Watcher) SIMULACRA GraphMemory + eigenvector personalities AGENT HOSPITAL Domain-specific simulation template"},{"location":"skills/agent-town-archetypes/#verification","title":"Verification","text":"<pre><code># Run archetype tests\nuv run pytest agents/town/_tests/test_archetypes.py -v\n\n# Check eigenvector laws\nuv run pytest agents/town/_tests/test_citizen.py -v -k \"eigenvector\"\n</code></pre>"},{"location":"skills/agent-town-archetypes/#common-pitfalls","title":"Common Pitfalls","text":"<ol> <li>Bias overflow: Biases are clamped, but large biases + variance can hit bounds</li> <li>Seed determinism: Without seed, variance is random\u2014tests may flake</li> <li>Coalition homogeneity: All same archetype \u2192 no interesting dynamics</li> </ol>"},{"location":"skills/agent-town-archetypes/#related-skills","title":"Related Skills","text":"<ul> <li>polynomial-agent \u2014 CitizenPolynomial state machine</li> <li>agent-town-coalitions \u2014 Coalition detection</li> <li>agent-town-visualization \u2014 Eigenvector scatter plots</li> </ul>"},{"location":"skills/agent-town-archetypes/#changelog","title":"Changelog","text":"<ul> <li>2025-12-14: Initial version (RE-METABOLIZE cycle)</li> </ul>"},{"location":"skills/agent-town-coalitions/","title":"Skill: Agent Town Coalitions","text":"<p>Detect overlapping coalitions via k-clique percolation and manage reputation with EigenTrust</p> <p>Difficulty: Medium Prerequisites: Understanding of Agent Town citizens, eigenvectors, graph algorithms Files Touched: <code>agents/town/coalition.py</code>, <code>agents/town/environment.py</code></p>"},{"location":"skills/agent-town-coalitions/#overview","title":"Overview","text":"<p>Coalitions are groups of citizens with aligned eigenvectors. Agent Town uses:</p> <ol> <li>k-clique percolation \u2014 Detect overlapping community structure</li> <li>EigenTrust reputation \u2014 Weight trust by trustworthiness of assigners</li> <li>Coalition lifecycle \u2014 Formation, action, decay</li> </ol>"},{"location":"skills/agent-town-coalitions/#heritage","title":"Heritage","text":"Source Pattern Application Palla et al. (2005) k-clique percolation Overlapping community detection Kamvar et al. (2003) EigenTrust Reputation in P2P networks D-gent BFS pattern Graph traversal k-hop neighbor discovery"},{"location":"skills/agent-town-coalitions/#quick-start","title":"Quick Start","text":""},{"location":"skills/agent-town-coalitions/#detecting-coalitions","title":"Detecting Coalitions","text":"<pre><code>from agents.town.coalition import detect_coalitions\nfrom agents.town.environment import TownEnvironment\n\n# Create town with citizens\ntown = TownEnvironment(name=\"Test\", citizens={...})\n\n# Detect coalitions (k=3, similarity threshold 0.6)\ncoalitions = detect_coalitions(\n    citizens=town.citizens,\n    k=3,\n    similarity_threshold=0.6,\n)\n\nfor c in coalitions:\n    print(f\"{c.name}: {c.members} (strength={c.strength:.2f})\")\n</code></pre>"},{"location":"skills/agent-town-coalitions/#computing-reputation","title":"Computing Reputation","text":"<pre><code>from agents.town.coalition import compute_reputation, EigenTrustConfig\n\n# Compute EigenTrust reputation scores\nreputation = compute_reputation(\n    citizens=town.citizens,\n    interactions=town.interaction_history,\n    config=EigenTrustConfig(\n        alpha=0.5,  # Damping factor\n        epsilon=0.001,  # Convergence threshold\n        max_iterations=100,\n    ),\n)\n\n# reputation: dict[str, float] \u2014 citizen_id \u2192 reputation score [0, 1]\n</code></pre>"},{"location":"skills/agent-town-coalitions/#coalition-dataclass","title":"Coalition Dataclass","text":"<pre><code>@dataclass\nclass Coalition:\n    id: str                     # UUID prefix\n    name: str                   # Human-readable name\n    members: set[str]           # Citizen IDs\n    formed_at: datetime         # Formation timestamp\n    strength: float             # [0, 1] \u2014 decays without action\n    purpose: str                # Optional coalition purpose\n</code></pre>"},{"location":"skills/agent-town-coalitions/#coalition-methods","title":"Coalition Methods","text":"<pre><code># Add/remove members\ncoalition.add_member(\"alice\")\ncoalition.remove_member(\"bob\")\n\n# Compute centroid eigenvector\ncentroid = coalition.compute_centroid(town.citizens)\n\n# Lifecycle\ncoalition.decay(rate=0.05)      # Passive decay\ncoalition.reinforce(amount=0.1)  # Action reinforcement\n\n# Check if alive\nif coalition.is_alive(threshold=0.1):\n    ...\n</code></pre>"},{"location":"skills/agent-town-coalitions/#k-clique-percolation-algorithm","title":"K-Clique Percolation Algorithm","text":""},{"location":"skills/agent-town-coalitions/#how-it-works","title":"How It Works","text":"<ol> <li>Build similarity graph: Edge between citizens if <code>similarity(a, b) &gt; threshold</code></li> <li>Find all k-cliques: Complete subgraphs of k vertices</li> <li>Build clique overlap graph: Cliques share k-1 vertices \u2192 edge</li> <li>Connected components: Each component is a coalition</li> </ol>"},{"location":"skills/agent-town-coalitions/#why-k3","title":"Why k=3?","text":"k Behavior Use Case 2 Edges \u2192 clusters Too loose for coalitions 3 Triangles \u2192 communities Good for 25-100 citizens 4 Tetrahedra \u2192 tight groups Too restrictive for small towns"},{"location":"skills/agent-town-coalitions/#complexity","title":"Complexity","text":"<ul> <li>k-clique finding: O(n^k) worst case</li> <li>Practical: O(n\u00b2) for sparse graphs (low similarity threshold)</li> <li>Scaling: Works well for ~100 citizens; beyond that, consider sampling</li> </ul>"},{"location":"skills/agent-town-coalitions/#eigentrust-reputation","title":"EigenTrust Reputation","text":""},{"location":"skills/agent-town-coalitions/#the-problem","title":"The Problem","text":"<p>Simple trust aggregation is vulnerable to Sybil attacks (fake identities boost reputation).</p>"},{"location":"skills/agent-town-coalitions/#the-solution","title":"The Solution","text":"<p>Weight trust by the trustworthiness of the assigner:</p> <pre><code>reputation[i] = \u03a3_j (trust[j\u2192i] \u00d7 reputation[j])\n</code></pre> <p>Iterating to fixed point produces stable reputation scores.</p>"},{"location":"skills/agent-town-coalitions/#configuration","title":"Configuration","text":"<pre><code>@dataclass\nclass EigenTrustConfig:\n    alpha: float = 0.5          # Damping factor (0.5 = balanced)\n    epsilon: float = 0.001      # Convergence threshold\n    max_iterations: int = 100   # Safety limit\n    pre_trust: dict[str, float] = field(default_factory=dict)  # Bootstrap\n</code></pre>"},{"location":"skills/agent-town-coalitions/#convergence","title":"Convergence","text":"<p>EigenTrust converges if: - Damping factor \u03b1 \u2208 (0, 1) - Trust matrix is row-stochastic - Typically converges in 10-20 iterations</p>"},{"location":"skills/agent-town-coalitions/#coalition-lifecycle","title":"Coalition Lifecycle","text":"<pre><code>FORMATION \u2192 ACTION \u2192 DECAY \u2192 (DISSOLUTION | REINFORCEMENT)\n                       \u2191                \u2193\n                       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"skills/agent-town-coalitions/#formation","title":"Formation","text":"<p>Coalitions form when k-clique percolation detects community structure.</p> <pre><code># Run detection periodically\ncoalitions = detect_coalitions(citizens, k=3, threshold=0.6)\n</code></pre>"},{"location":"skills/agent-town-coalitions/#action","title":"Action","text":"<p>Collective actions reinforce coalition strength.</p> <pre><code># When coalition acts together\ncoalition.reinforce(amount=0.15)\n</code></pre>"},{"location":"skills/agent-town-coalitions/#decay","title":"Decay","text":"<p>Without action, coalitions decay passively.</p> <pre><code># Apply decay each time step\nfor coalition in coalitions:\n    coalition.decay(rate=0.05)\n</code></pre>"},{"location":"skills/agent-town-coalitions/#dissolution","title":"Dissolution","text":"<p>Coalitions dissolve when strength drops below threshold OR members &lt; 2.</p> <pre><code>alive_coalitions = [c for c in coalitions if c.is_alive(threshold=0.1)]\n</code></pre>"},{"location":"skills/agent-town-coalitions/#integration-with-town-simulation","title":"Integration with Town Simulation","text":""},{"location":"skills/agent-town-coalitions/#in-townflux-step","title":"In TownFlux Step","text":"<pre><code>async def step(self) -&gt; AsyncIterator[TownEvent]:\n    # ... generate events ...\n\n    # Periodic coalition update\n    if self.total_events % 10 == 0:\n        self._update_coalitions()\n\n    yield event\n\ndef _update_coalitions(self) -&gt; None:\n    # Detect new coalitions\n    detected = detect_coalitions(self.environment.citizens, k=3)\n\n    # Merge with existing (preserve strength)\n    for new_c in detected:\n        existing = self._find_matching(new_c)\n        if existing:\n            existing.reinforce(0.05)\n        else:\n            self._coalitions.append(new_c)\n\n    # Decay all\n    for c in self._coalitions:\n        c.decay(0.02)\n\n    # Prune dead coalitions\n    self._coalitions = [c for c in self._coalitions if c.is_alive()]\n</code></pre>"},{"location":"skills/agent-town-coalitions/#in-api-response","title":"In API Response","text":"<pre><code>@router.get(\"/{town_id}/coalitions\")\nasync def get_coalitions(town_id: str) -&gt; list[dict]:\n    flux = get_flux(town_id)\n    return [c.to_dict() for c in flux._coalitions]\n</code></pre>"},{"location":"skills/agent-town-coalitions/#visualization","title":"Visualization","text":"<p>Coalitions appear in the eigenvector scatter plot as clusters:</p> <pre><code>+----------------------------------------------------------+\n|                    Eigenvector Space (WT)                |\n|                                                          |\n|          b b b           Coalition A                     |\n|           b              (Builders)                      |\n|                                                          |\n|                   h h           Coalition B              |\n|                    h h          (Healers)                |\n|                                                          |\n|   t t t              Bridge nodes: t (shared k-1)        |\n|    t                                                     |\n+----------------------------------------------------------+\n</code></pre> <p>Bridge nodes (\u25cb) are members of multiple coalitions via shared k-1 cliques.</p>"},{"location":"skills/agent-town-coalitions/#serialization","title":"Serialization","text":"<pre><code># Coalition to dict\ndata = coalition.to_dict()\n# {\n#   \"id\": \"abc123\",\n#   \"name\": \"builders-coalition\",\n#   \"members\": [\"bob\", \"eve\", \"ada\"],\n#   \"formed_at\": \"2025-12-14T10:00:00\",\n#   \"strength\": 0.85,\n#   \"purpose\": \"\"\n# }\n\n# Dict to Coalition\nrestored = Coalition.from_dict(data)\n</code></pre>"},{"location":"skills/agent-town-coalitions/#verification","title":"Verification","text":"<pre><code># Run coalition tests\nuv run pytest agents/town/_tests/test_coalition.py -v\n\n# Check k-clique detection\nuv run pytest agents/town/_tests/test_coalition.py -v -k \"clique\"\n\n# Check EigenTrust convergence\nuv run pytest agents/town/_tests/test_coalition.py -v -k \"eigentrust\"\n</code></pre>"},{"location":"skills/agent-town-coalitions/#common-pitfalls","title":"Common Pitfalls","text":"<ol> <li>High similarity threshold: Too high \u2192 no coalitions; too low \u2192 one giant coalition</li> <li>Forgetting decay: Coalitions grow forever without passive decay</li> <li>EigenTrust divergence: Check alpha and iteration limits</li> <li>Bridge node confusion: Members of multiple coalitions appear in both</li> </ol>"},{"location":"skills/agent-town-coalitions/#related-skills","title":"Related Skills","text":"<ul> <li>agent-town-archetypes \u2014 Archetype eigenvector biases</li> <li>agent-town-visualization \u2014 Scatter plot with coalition markers</li> <li>polynomial-agent \u2014 CitizenPolynomial state machine</li> </ul>"},{"location":"skills/agent-town-coalitions/#changelog","title":"Changelog","text":"<ul> <li>2025-12-14: Initial version (RE-METABOLIZE cycle)</li> </ul>"},{"location":"skills/agent-town-inhabit/","title":"Skill: Agent Town INHABIT Mode","text":"<p>\"You are not controlling the citizen. You are becoming them, constrained by who they are.\"</p>"},{"location":"skills/agent-town-inhabit/#when-to-use","title":"When to Use","text":"<p>Use INHABIT mode when you want to: - Experience Agent Town from inside a citizen's consciousness - Collaborate with a citizen while respecting their autonomy - Explore the simulation through a character's unique perspective - Test how citizens respond to different approaches</p>"},{"location":"skills/agent-town-inhabit/#core-concepts","title":"Core Concepts","text":""},{"location":"skills/agent-town-inhabit/#the-punchdrunk-principle","title":"The Punchdrunk Principle","text":"<p>INHABIT mode is inspired by Punchdrunk's Sleep No More where masked audience members become part of the performance. Users don't control citizens\u2014they collaborate with them.</p>"},{"location":"skills/agent-town-inhabit/#consent-debt-meter","title":"Consent Debt Meter","text":"<p>Every INHABIT session tracks relationship health:</p> <pre><code>HARMONIOUS (0.0-0.2)  \u2192  TENSE (0.2-0.4)  \u2192  STRAINED (0.4-0.6)  \u2192  CRITICAL (0.6-0.8)  \u2192  RUPTURED (1.0)\n</code></pre> <ul> <li>Suggestions: Don't increase debt. Citizen may accept or refuse based on personality.</li> <li>Forces: Add debt. Expensive, limited, and logged. Use sparingly.</li> <li>Apologies: Reduce debt. Repair the relationship.</li> <li>Time decay: Debt slowly decays (harmony restoration).</li> </ul>"},{"location":"skills/agent-town-inhabit/#alignment-thresholds","title":"Alignment Thresholds","text":"<p>Actions are evaluated against the citizen's 7D eigenvector personality:</p> Score Response Meaning &gt; 0.5 ENACT Citizen performs action with your influence 0.3-0.5 NEGOTIATE Citizen hesitates, may suggest alternative &lt; 0.3 RESIST Citizen refuses (conflicts with their values)"},{"location":"skills/agent-town-inhabit/#api-usage","title":"API Usage","text":""},{"location":"skills/agent-town-inhabit/#create-session","title":"Create Session","text":"<pre><code>from agents.town.inhabit_session import InhabitSession, SubscriptionTier\nfrom agents.town.citizen import Citizen\n\ncitizen = town.get_citizen(\"alice\")\nsession = InhabitSession(\n    citizen=citizen,\n    user_tier=SubscriptionTier.CITIZEN,  # Sets caps\n)\nsession.force_enabled = True  # Opt-in for Advanced INHABIT\n</code></pre>"},{"location":"skills/agent-town-inhabit/#suggest-actions-collaborative","title":"Suggest Actions (Collaborative)","text":"<pre><code>result = session.suggest_action(\"help Bob at the workshop\")\n# result: {\"success\": bool, \"message\": str}\n</code></pre>"},{"location":"skills/agent-town-inhabit/#process-with-llm-alignment-phase-8","title":"Process with LLM Alignment (Phase 8)","text":"<pre><code>from agents.k.llm import create_llm_client\n\nllm = create_llm_client()\nresponse = await session.process_input_async(\"greet the newcomer warmly\", llm)\n\n# response.type: \"enact\" | \"resist\" | \"negotiate\" | \"exit\"\n# response.message: What happened\n# response.inner_voice: Citizen's internal thoughts\n# response.cost: Tokens used\n# response.alignment: AlignmentScore (score, violated_value, reasoning)\n</code></pre>"},{"location":"skills/agent-town-inhabit/#force-actions-use-sparingly","title":"Force Actions (Use Sparingly)","text":"<pre><code># Synchronous (no LLM)\nresult = session.force_action(\"go to the well\", severity=0.2)\n\n# Async with inner voice generation\nresponse = await session.force_action_async(\"go to the well\", llm)\n# Costs 3x tokens, adds consent debt, marks as \"forced\"\n</code></pre>"},{"location":"skills/agent-town-inhabit/#apologize-repair-relationship","title":"Apologize (Repair Relationship)","text":"<pre><code>result = session.apologize(sincerity=0.3)\n# Reduces consent debt\n</code></pre>"},{"location":"skills/agent-town-inhabit/#check-status","title":"Check Status","text":"<pre><code>status = session.get_status()\n# {\n#   \"citizen\": \"Alice\",\n#   \"tier\": \"citizen\",\n#   \"duration\": 120.5,\n#   \"time_remaining\": 779.5,\n#   \"consent\": {\"debt\": 0.3, \"status\": \"TENSE\", ...},\n#   \"force\": {\"enabled\": True, \"used\": 1, \"remaining\": 2, ...},\n#   \"expired\": False,\n# }\n</code></pre>"},{"location":"skills/agent-town-inhabit/#subscription-tiers","title":"Subscription Tiers","text":"Tier Session Cap Force Limit Notes TOURIST N/A N/A No INHABIT access RESIDENT 10 min 0 Basic INHABIT, no force CITIZEN 15 min 3 Full INHABIT FOUNDER 30 min 5 Extended limits"},{"location":"skills/agent-town-inhabit/#eigenvector-dimensions","title":"Eigenvector Dimensions","text":"<p>Alignment is checked against these personality dimensions:</p> Dimension Low High Affects warmth Cold, distant Warm, nurturing Helping, caring actions curiosity Incurious Curious, exploring Discovery, investigation trust Suspicious Trusting, open Sharing, confiding creativity Conventional Creative, novel New ideas, invention patience Impatient Patient, deliberate Waiting, careful actions resilience Fragile Resilient Facing challenges ambition Content Ambitious Goal pursuit, competition"},{"location":"skills/agent-town-inhabit/#heuristic-fallback","title":"Heuristic Fallback","text":"<p>When LLM is unavailable, alignment uses keyword matching:</p> <pre><code># Positive keywords boost score for high-dimension citizens\n\"warmth\": [\"warm\", \"kind\", \"help\", \"care\", \"gentle\", \"friendly\"]\n\"curiosity\": [\"explore\", \"discover\", \"investigate\", \"learn\", \"study\"]\n\"trust\": [\"trust\", \"believe\", \"confide\", \"share secret\", \"open up\"]\n\n# Negative keywords reduce score for high-dimension citizens\n\"warmth\": [\"cold\", \"cruel\", \"hurt\", \"attack\", \"aggressive\"]\n\"trust\": [\"betray\", \"deceive\", \"lie\", \"manipulate\", \"trick\"]\n</code></pre>"},{"location":"skills/agent-town-inhabit/#townflux-integration","title":"TownFlux Integration","text":"<p>INHABIT events are emitted to TownFlux:</p> <pre><code>event = session.emit_inhabit_event(response)\n# {\n#   \"phase\": \"INHABIT\",\n#   \"operation\": \"inhabit_enact\" | \"inhabit_resist\" | \"inhabit_negotiate\",\n#   \"participants\": [\"Alice\"],\n#   \"success\": bool,\n#   \"drama_contribution\": 0.1 (enact) | 0.3 (resist),\n#   \"metadata\": {\n#     \"inner_voice\": \"...\",\n#     \"alignment_score\": 0.8,\n#     \"violated_value\": None | \"trust\" | ...,\n#     \"consent_debt\": 0.3,\n#   }\n# }\n</code></pre>"},{"location":"skills/agent-town-inhabit/#ethics-principles","title":"Ethics Principles","text":"<p>INHABIT mode embodies spec/principles.md \u00a73 (Ethical):</p> <ol> <li>Augment, don't replace judgment: Citizens maintain agency</li> <li>Force is expensive: Limited, logged, adds consent debt</li> <li>Rupture protection: At rupture, citizen refuses all interaction</li> <li>Transparency: Inner voice reveals citizen's perspective</li> <li>Recovery path: Apologies and time can repair relationships</li> </ol>"},{"location":"skills/agent-town-inhabit/#example-session","title":"Example Session","text":"<pre><code># Enter INHABIT mode with Alice\nsession = InhabitSession(citizen=alice, user_tier=SubscriptionTier.CITIZEN)\nsession.force_enabled = True\n\n# Try a warm action (aligned with Alice's high warmth)\nresponse = await session.process_input_async(\"offer tea to the tired traveler\", llm)\n# \u2192 ENACT: Alice offers tea. Inner voice: \"The inn exists for moments like these.\"\n\n# Try a cold action (violates Alice's warmth)\nresponse = await session.process_input_async(\"interrogate Clara aggressively\", llm)\n# \u2192 RESIST: Alice doesn't want to. Conflicts with warmth.\n#   Inner voice: \"I don't corner guests. That's not who I am.\"\n\n# Force if needed (expensive!)\nresponse = await session.force_action_async(\"confront Clara about the well\", llm)\n# \u2192 ENACT: Alice reluctantly complies. Debt increases. 3x token cost.\n\n# Repair the relationship\nsession.apologize(sincerity=0.4)\n# \u2192 Debt reduced. Alice relaxes.\n</code></pre>"},{"location":"skills/agent-town-inhabit/#testing","title":"Testing","text":"<pre><code># Unit test alignment parsing\ndef test_parse_alignment_response():\n    from agents.town.inhabit_session import _parse_alignment_response\n\n    text = \"SCORE: 0.75\\nVIOLATED: none\\nREASONING: Aligned.\\nREPHRASE: none\"\n    result = _parse_alignment_response(text)\n    assert result.score == 0.75\n\n# Test heuristic fallback\ndef test_heuristic_warmth():\n    from agents.town.inhabit_session import _heuristic_alignment\n\n    result = _heuristic_alignment(warm_citizen, \"help kindly\", \"test\")\n    assert result.score &gt; 0.5\n\n# Async integration test\n@pytest.mark.asyncio\nasync def test_process_enact(alice, mock_llm):\n    session = InhabitSession(citizen=alice, user_tier=SubscriptionTier.CITIZEN)\n    response = await session.process_input_async(\"help neighbor\", mock_llm)\n    assert response.type == \"enact\"\n</code></pre>"},{"location":"skills/agent-town-inhabit/#related","title":"Related","text":"<ul> <li><code>docs/skills/agent-town-archetypes.md</code> - Citizen archetypes</li> <li><code>docs/skills/agent-town-coalitions.md</code> - Coalition dynamics</li> <li><code>spec/protocols/agentese.md</code> - AGENTESE observer-dependent handles</li> <li><code>spec/principles.md</code> \u00a73 - Ethical principles</li> </ul> <p>\"The citizen can refuse. That's not a bug\u2014it's the core feature.\"</p>"},{"location":"skills/agent-town-visualization/","title":"Skill: Agent Town Visualization","text":"<p>Visualize citizen eigenvectors, stream town events, and build real-time dashboards</p> <p>Difficulty: Medium Prerequisites: Understanding of Agent Town citizens, eigenvectors, coalitions Files Touched: <code>agents/town/visualization.py</code>, API routes, dashboard components</p>"},{"location":"skills/agent-town-visualization/#overview","title":"Overview","text":"<p>Agent Town visualization provides three main components:</p> <ol> <li>EigenvectorScatterWidget - Project 7D citizen personality space to 2D scatter plots</li> <li>TownSSEEndpoint - Stream town events to web clients via Server-Sent Events</li> <li>TownNATSBridge - Publish/subscribe town events via NATS JetStream</li> </ol> <p>All components follow functor laws and support graceful degradation.</p>"},{"location":"skills/agent-town-visualization/#quick-start","title":"Quick Start","text":""},{"location":"skills/agent-town-visualization/#ascii-scatter-plot-cli","title":"ASCII Scatter Plot (CLI)","text":"<pre><code>from agents.town.visualization import (\n    ScatterPoint,\n    ScatterState,\n    project_scatter_to_ascii,\n)\n\n# Create a point from citizen data\npoint = ScatterPoint(\n    citizen_id=\"alice\",\n    citizen_name=\"Alice\",\n    archetype=\"builder\",\n    warmth=0.7,\n    curiosity=0.8,\n    trust=0.6,\n    creativity=0.9,\n    patience=0.5,\n    resilience=0.4,\n    ambition=0.3,\n)\n\n# Create state and render\nstate = ScatterState(points=(point,))\nprint(project_scatter_to_ascii(state))\n</code></pre> <p>Output: <pre><code>+----------------------------------------------------------+\n|                    Eigenvector Space (WT)                |\n|                                                          |\n|                    b                                     |\n|                                                          |\n+----------------------------------------------------------+\nX: Warmth  |  Y: Trust\nLegend: B=Builder\nCitizens: 1/1\n</code></pre></p>"},{"location":"skills/agent-town-visualization/#eigenvectorscatterwidget","title":"EigenvectorScatterWidget","text":""},{"location":"skills/agent-town-visualization/#creating-the-widget","title":"Creating the Widget","text":"<pre><code>from agents.town.visualization import (\n    EigenvectorScatterWidgetImpl,\n    ProjectionMethod,\n    ScatterState,\n)\n\n# Default state\nwidget = EigenvectorScatterWidgetImpl()\n\n# With initial projection\nwidget = EigenvectorScatterWidgetImpl(\n    initial_state=ScatterState(projection=ProjectionMethod.PCA)\n)\n</code></pre>"},{"location":"skills/agent-town-visualization/#loading-citizens","title":"Loading Citizens","text":"<pre><code>from agents.town.citizen import Citizen\nfrom agents.town.coalition import Coalition\n\n# Load from existing citizen dict\nwidget.load_from_citizens(\n    citizens={\"alice\": alice_citizen, \"bob\": bob_citizen},\n    coalitions={\"builders\": builders_coalition},\n    evolving_ids={\"alice\"},  # Mark evolving citizens\n)\n</code></pre>"},{"location":"skills/agent-town-visualization/#projecting-to-targets","title":"Projecting to Targets","text":"<pre><code>from agents.i.reactive.widget import RenderTarget\n\n# CLI (ASCII art)\nascii_output = widget.project(RenderTarget.CLI)\n\n# JSON (for web APIs)\njson_output = widget.project(RenderTarget.JSON)\n\n# TUI (for Textual apps)\ntui_output = widget.project(RenderTarget.TUI)\n</code></pre>"},{"location":"skills/agent-town-visualization/#state-mutations","title":"State Mutations","text":"<pre><code># Select a citizen (highlights in visualization)\nwidget.select_citizen(\"alice\")\n\n# Change projection method\nwidget.set_projection(ProjectionMethod.PAIR_CC)  # Curiosity vs Creativity\n\n# Filter by archetype\nwidget.filter_by_archetype((\"builder\", \"healer\"))\n\n# Toggle evolving-only view\nwidget.toggle_evolving_only()\n</code></pre>"},{"location":"skills/agent-town-visualization/#functor-laws","title":"Functor Laws","text":"<p>The widget satisfies functor laws, enabling safe composition:</p> <pre><code># LAW 1: Identity\nwidget.map(lambda s: s)  # Returns identical widget\n\n# LAW 2: Composition\nf = lambda s: ScatterState(..., projection=ProjectionMethod.PCA)\ng = lambda s: ScatterState(..., show_evolving_only=True)\n\n# These are equivalent:\nwidget.map(f).map(g)\nwidget.map(lambda s: g(f(s)))\n\n# LAW 3: State-Map Equivalence\nwidget.map(f) == widget.with_state(f(widget.state.value))\n</code></pre>"},{"location":"skills/agent-town-visualization/#projection-methods","title":"Projection Methods","text":"Method X Axis Y Axis Use Case <code>PAIR_WT</code> Warmth Trust Social dynamics <code>PAIR_CC</code> Curiosity Creativity Innovation potential <code>PAIR_PR</code> Patience Resilience Stability analysis <code>PAIR_RA</code> Resilience Ambition Growth trajectory <code>PCA</code> PC1 PC2 Maximum variance view <code>TSNE</code> t-SNE1 t-SNE2 Local structure <code>CUSTOM</code> User-defined User-defined Custom analysis"},{"location":"skills/agent-town-visualization/#townsseendpoint","title":"TownSSEEndpoint","text":"<p>Stream town events to web clients via Server-Sent Events.</p>"},{"location":"skills/agent-town-visualization/#fastapi-integration","title":"FastAPI Integration","text":"<pre><code>from fastapi import FastAPI\nfrom fastapi.responses import StreamingResponse\nfrom agents.town.visualization import TownSSEEndpoint\n\napp = FastAPI()\n\n@app.get(\"/towns/{town_id}/events\")\nasync def stream_events(town_id: str):\n    endpoint = TownSSEEndpoint(town_id)\n    return StreamingResponse(\n        endpoint.generate(),\n        media_type=\"text/event-stream\",\n    )\n</code></pre>"},{"location":"skills/agent-town-visualization/#pushing-events","title":"Pushing Events","text":"<pre><code>endpoint = TownSSEEndpoint(\"town123\")\n\n# Push status updates\nawait endpoint.push_status({\"day\": 1, \"phase\": \"MORNING\"})\n\n# Push eigenvector drift (for scatter animation)\nawait endpoint.push_eigenvector_drift(\n    citizen_id=\"alice\",\n    old_eigenvectors={\"warmth\": 0.5, \"trust\": 0.5},\n    new_eigenvectors={\"warmth\": 0.6, \"trust\": 0.6},\n    drift_magnitude=0.14,\n)\n\n# Push coalition changes\nawait endpoint.push_coalition_change(coalition, \"formed\")\n</code></pre>"},{"location":"skills/agent-town-visualization/#sse-event-format","title":"SSE Event Format","text":"<pre><code>event: town.status\ndata: {\"day\": 1, \"phase\": \"MORNING\"}\n\nevent: town.eigenvector.drift\ndata: {\"citizen_id\": \"alice\", \"drift\": 0.14, ...}\n\nevent: town.coalition.formed\ndata: {\"coalition_id\": \"builders\", \"members\": [\"alice\", \"bob\"]}\n</code></pre>"},{"location":"skills/agent-town-visualization/#graceful-shutdown","title":"Graceful Shutdown","text":"<pre><code># Close endpoint when client disconnects\nendpoint.close()\n</code></pre>"},{"location":"skills/agent-town-visualization/#townnatsbridge","title":"TownNATSBridge","text":"<p>Publish/subscribe town events via NATS JetStream with memory fallback.</p>"},{"location":"skills/agent-town-visualization/#creating-the-bridge","title":"Creating the Bridge","text":"<pre><code>from agents.town.visualization import TownNATSBridge\n\n# Default (localhost:4222 with memory fallback)\nbridge = TownNATSBridge()\n\n# Custom servers\nbridge = TownNATSBridge(\n    servers=[\"nats://nats1:4222\", \"nats://nats2:4222\"],\n    fallback_to_memory=True,\n)\n\n# Connect\nawait bridge.connect()\n</code></pre>"},{"location":"skills/agent-town-visualization/#context-manager","title":"Context Manager","text":"<pre><code>async with TownNATSBridge() as bridge:\n    await bridge.publish_status(\"town123\", {\"day\": 1})\n    # Auto-closes on exit\n</code></pre>"},{"location":"skills/agent-town-visualization/#publishing-events","title":"Publishing Events","text":"<pre><code># Status updates\nawait bridge.publish_status(\"town123\", {\"phase\": \"AFTERNOON\"})\n\n# Town events\nawait bridge.publish_town_event(\"town123\", town_event)\n\n# Eigenvector drift\nawait bridge.publish_eigenvector_drift(\n    town_id=\"town123\",\n    citizen_id=\"alice\",\n    old_eigenvectors={\"warmth\": 0.5},\n    new_eigenvectors={\"warmth\": 0.6},\n)\n\n# Coalition changes\nawait bridge.publish_coalition_change(\"town123\", coalition, \"formed\")\n</code></pre>"},{"location":"skills/agent-town-visualization/#subscribing","title":"Subscribing","text":"<pre><code># Subscribe to all events for a town\nasync for event in bridge.subscribe_town(\"town123\"):\n    print(event)\n\n# Replay from beginning\nasync for event in bridge.subscribe_town(\"town123\", from_beginning=True):\n    print(event)\n</code></pre>"},{"location":"skills/agent-town-visualization/#nats-subject-schema","title":"NATS Subject Schema","text":"<pre><code>town.{town_id}.{phase}.{operation}\n\nExamples:\n  town.abc123.morning.greet\n  town.abc123.afternoon.trade\n  town.abc123.status.phase_change\n  town.abc123.coalition.formed\n  town.abc123.eigenvector.drift\n\nWildcards:\n  town.abc123.&gt;         - All events for town\n  town.abc123.morning.&gt; - All morning events\n  town.*.status.&gt;       - Status events for all towns\n</code></pre>"},{"location":"skills/agent-town-visualization/#memory-fallback","title":"Memory Fallback","text":"<p>When NATS is unavailable, the bridge uses in-memory queues:</p> <pre><code>bridge = TownNATSBridge(fallback_to_memory=True)\n# Don't call connect() - stays in fallback mode\n\nawait bridge.publish_status(\"town123\", {\"test\": True})\n# Events queued in memory, accessible via subscribe_town()\n</code></pre>"},{"location":"skills/agent-town-visualization/#visualization-characters","title":"Visualization Characters","text":"<p>The ASCII scatter uses these characters:</p> Character Meaning <code>b</code>, <code>t</code>, <code>h</code>... Archetype first letter (lowercase = unselected) <code>B</code>, <code>T</code>, <code>H</code>... Selected/hovered citizen (uppercase) <code>\u25cb</code> Bridge node (member of multiple coalitions) <code>\u25cf</code> Selected bridge node <code>\u2606</code> K-gent projection <code>\u2605</code> Selected K-gent"},{"location":"skills/agent-town-visualization/#serialization","title":"Serialization","text":""},{"location":"skills/agent-town-visualization/#scatterpoint","title":"ScatterPoint","text":"<pre><code>point = ScatterPoint(...)\nd = point.to_dict()\n\n# Reconstruct\nrestored = ScatterPoint(\n    citizen_id=d[\"citizen_id\"],\n    citizen_name=d[\"citizen_name\"],\n    archetype=d[\"archetype\"],\n    warmth=d[\"eigenvectors\"][\"warmth\"],\n    # ... other eigenvectors\n    x=d[\"x\"],\n    y=d[\"y\"],\n    color=d[\"color\"],\n    is_evolving=d[\"is_evolving\"],\n    coalition_ids=tuple(d[\"coalition_ids\"]),\n)\n</code></pre>"},{"location":"skills/agent-town-visualization/#scatterstate","title":"ScatterState","text":"<pre><code>state = ScatterState(...)\nd = state.to_dict()\n\n# Contains:\n# - type: \"eigenvector_scatter\"\n# - points: list of point dicts\n# - projection: enum name string\n# - selected_citizen_id, filters, etc.\n</code></pre>"},{"location":"skills/agent-town-visualization/#projectionmethod-enum","title":"ProjectionMethod Enum","text":"<pre><code># Serialize\nname = method.name  # \"PAIR_CC\"\n\n# Deserialize\nmethod = ProjectionMethod[name]\n</code></pre>"},{"location":"skills/agent-town-visualization/#verification","title":"Verification","text":"<pre><code># Run all visualization tests\nuv run pytest agents/town/_tests/test_visualization_contracts.py -v\n\n# Run law tests\nuv run pytest agents/town/_tests/test_visualization_contracts.py -v -k \"law\"\n\n# Run edge case tests\nuv run pytest agents/town/_tests/test_visualization_contracts.py -v -k \"SSE or NATS or Roundtrip\"\n</code></pre>"},{"location":"skills/agent-town-visualization/#common-pitfalls","title":"Common Pitfalls","text":"<ol> <li> <p>Forgetting to close SSE endpoints: Always call <code>endpoint.close()</code> when clients disconnect to prevent resource leaks.</p> </li> <li> <p>Assuming NATS is available: Use <code>fallback_to_memory=True</code> for graceful degradation in development/testing.</p> </li> <li> <p>Mutating frozen dataclasses: <code>ScatterPoint</code> and <code>ScatterState</code> are frozen. Use <code>widget.map()</code> or create new instances.</p> </li> <li> <p>Ignoring projection bounds: PCA/t-SNE coordinates may be outside [0,1]. The ASCII projection normalizes from [-2,2].</p> </li> <li> <p>Enum identity comparison: After reload, use <code>method.value</code> or <code>method.name</code> for comparison, not <code>is</code>.</p> </li> </ol>"},{"location":"skills/agent-town-visualization/#related-skills","title":"Related Skills","text":"<ul> <li>building-agent - Creating Agent[A, B]</li> <li>polynomial-agent - State-dependent agents (CitizenPolynomial)</li> <li>flux-agent - Stream processing (TownFlux)</li> </ul>"},{"location":"skills/agent-town-visualization/#phase-6-live-marimo-notebook-research","title":"Phase 6: Live Marimo Notebook (RESEARCH)","text":"<p>This section documents the technical research for implementing a live marimo notebook with eigenvector scatter visualization and SSE updates.</p>"},{"location":"skills/agent-town-visualization/#anywidget-pattern-svg-scatter","title":"Anywidget Pattern: SVG Scatter","text":"<p>Decision: Use SVG over Canvas for the scatter plot.</p> <p>Rationale: - Native click handling per element (no hit-testing) - CSS transitions work directly (<code>transition: all 0.3s ease-out</code>) - Text elements for labels with proper anchoring - <code>:hover</code> pseudo-class works on SVG elements - Adequate performance for 25-100 citizens</p> <p>Structure: <pre><code>function renderScatter(el, state) {\n  const svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\n  svg.setAttribute(\"viewBox\", \"0 0 400 300\");\n\n  state.points.forEach(point =&gt; {\n    const circle = document.createElementNS(\"http://www.w3.org/2000/svg\", \"circle\");\n    circle.setAttribute(\"cx\", point.x * 380 + 10);\n    circle.setAttribute(\"cy\", (1 - point.y) * 280 + 10);\n    circle.setAttribute(\"r\", point.size * 8 + 4);\n    circle.style.transition = \"all 0.3s ease-out\";\n    circle.onclick = () =&gt; selectCitizen(point.citizen_id);\n    svg.appendChild(circle);\n  });\n}\n</code></pre></p>"},{"location":"skills/agent-town-visualization/#sse-client-pattern","title":"SSE Client Pattern","text":"<p>EventSource with typed events: <pre><code>function connectSSE(model, townId) {\n  const eventSource = new EventSource(`/v1/town/${townId}/events`);\n\n  eventSource.addEventListener('town.eigenvector.drift', (e) =&gt; {\n    const data = JSON.parse(e.data);\n    updatePointPosition(model, data);\n  });\n\n  eventSource.addEventListener('town.status', (e) =&gt; {\n    model.set('town_status', JSON.parse(e.data));\n    model.save_changes();\n  });\n\n  // Browser auto-reconnects after ~3 seconds\n  return () =&gt; eventSource.close();  // Cleanup function\n}\n</code></pre></p>"},{"location":"skills/agent-town-visualization/#marimo-notebook-structure","title":"Marimo Notebook Structure","text":"<p>Marimo notebooks are pure Python files, not .ipynb:</p> <pre><code># agents/town/demo_marimo.py\nimport marimo\napp = marimo.App()\n\n@app.cell\ndef __():\n    import marimo as mo\n    from agents.i.marimo.widgets import EigenvectorScatterWidget\n    return mo, EigenvectorScatterWidget\n\n@app.cell\ndef __(mo, EigenvectorScatterWidget):\n    scatter = EigenvectorScatterWidget(town_id=\"abc123\")\n    widget = mo.ui.anywidget(scatter)\n    return widget\n\n@app.cell\ndef __(widget):\n    widget  # Display (reactive)\n\n@app.cell\ndef __(mo):\n    projection = mo.ui.dropdown(\n        options=[\"PAIR_WT\", \"PAIR_CC\", \"PCA\"],\n        value=\"PAIR_WT\"\n    )\n    return projection\n</code></pre>"},{"location":"skills/agent-town-visualization/#integration-file-map","title":"Integration File Map","text":"File Purpose <code>agents/i/marimo/widgets/js/scatter.js</code> SVG scatter ESM with SSE client <code>agents/i/marimo/widgets/scatter.py</code> EigenvectorScatterWidgetMarimo <code>agents/town/demo_marimo.py</code> Live notebook demo"},{"location":"skills/agent-town-visualization/#sse-event-flow","title":"SSE Event Flow","text":"<pre><code>API (/v1/town/{id}/events)     scatter.js ESM           Python traitlets\n         |                          |                          |\n         |-- town.eigenvector.drift |                          |\n         |                          | model.set('points', new) |\n         |                          | model.save_changes()     |\n         |                          |-------------------------&gt;|\n         |                          |                          | marimo re-renders\n</code></pre>"},{"location":"skills/agent-town-visualization/#sources","title":"Sources","text":"<ul> <li>EventSource Basics (web.dev)</li> <li>SSE 2025 Patterns</li> <li>mo.ui.anywidget API</li> <li>anywidget Getting Started</li> </ul>"},{"location":"skills/agent-town-visualization/#phase-6-live-marimo-demo-educate","title":"Phase 6: Live Marimo Demo (EDUCATE)","text":"<p>This section documents the implemented live marimo visualization demo.</p>"},{"location":"skills/agent-town-visualization/#running-the-demo","title":"Running the Demo","text":"<pre><code># Start the API server first (required for SSE)\nuv run uvicorn protocols.api.app:app --reload\n\n# Launch the marimo notebook\nmarimo edit agents/town/demo_marimo.py\n\n# Or run as script\nmarimo run agents/town/demo_marimo.py\n</code></pre>"},{"location":"skills/agent-town-visualization/#demo-features","title":"Demo Features","text":"Feature Description Cell Town creation Create Phase 3 or 4 towns via API Cell 7 Projection selection Switch between PAIR_WT, PAIR_CC, PCA, etc. Cell 5 Citizen filtering Filter by archetype, evolving status Cell 6 Live scatter SVG plot with CSS transitions Cell 11 Click-to-details Click citizen \u2192 fetch LOD 2 details Cell 12 Simulation stepping Advance by 1-10 cycles Cell 13 SSE status Connection indicator in footer Cell 14"},{"location":"skills/agent-town-visualization/#cell-dag-law-l1","title":"Cell DAG (Law L1)","text":"<pre><code>imports \u2192 widget_imports \u2192 create_widget \u2192 town_controls\n                                        \u2192 projection_controls\n                                        \u2192 filter_controls\n                                        \u2192 simulation_controls\n                                        \u2192 main_layout\n</code></pre> <p>Marimo enforces pure functions per cell. Circular dependencies are compile-time errors.</p>"},{"location":"skills/agent-town-visualization/#reactivity-laws","title":"Reactivity Laws","text":"Law Trigger Effect L2 <code>town_id_input.value</code> change Cell 8 re-runs \u2192 SSE reconnects L3 <code>widget.clicked_citizen_id</code> change Cell 12 re-runs \u2192 details fetched L4 All async cells use <code>await</code> No blocking; marimo handles concurrency"},{"location":"skills/agent-town-visualization/#widget-architecture","title":"Widget Architecture","text":"<pre><code>EigenvectorScatterWidgetMarimo (Python)\n    \u2193 traitlets.tag(sync=True)\nscatter.js ESM (JavaScript)\n    \u2193 model.set() + model.save_changes()\nmarimo re-render\n</code></pre> <p>The widget bridges Python state to JavaScript via anywidget's traitlet sync protocol.</p>"},{"location":"skills/agent-town-visualization/#sse-integration","title":"SSE Integration","text":"<pre><code>// scatter.js handles SSE connection\neventSource.addEventListener('town.eigenvector.drift', (e) =&gt; {\n  const data = JSON.parse(e.data);\n  // Update point position \u2192 CSS transition animates\n  model.set('points', updatedPoints);\n  model.save_changes();\n});\n</code></pre> <p>Browser auto-reconnects on disconnect (EventSource spec). The widget shows status via <code>sse_connected</code> traitlet.</p>"},{"location":"skills/agent-town-visualization/#teaching-example-functor-laws-in-tests","title":"Teaching Example: Functor Laws in Tests","text":"<pre><code># From test_functor.py \u2014 verification pattern\n\ndef test_identity_law_passes(self) -&gt; None:\n    \"\"\"Test identity law: F(id) = id.\n\n    The identity operation maps to SENSE (neutral phase).\n    Applying the functor twice yields the same result.\n    \"\"\"\n    result = verify_identity_law()\n    assert result.status == LawStatus.PASSED\n\ndef test_composition_law_act_act(self) -&gt; None:\n    \"\"\"Test composition: F(f &gt;&gt; g) = F(f) &gt;&gt; F(g).\n\n    If greet and gossip both map to ACT,\n    their composition must also be valid in ACT.\n    \"\"\"\n    result = verify_composition_law(\"greet\", \"gossip\")\n    assert result.status == LawStatus.PASSED\n\ndef test_composition_law_reflect_act_fails(self) -&gt; None:\n    \"\"\"Test invalid composition: REFLECT &gt;&gt; ACT fails.\n\n    Phase transitions must be forward: SENSE \u2192 ACT \u2192 REFLECT.\n    Going backward violates the N-Phase operad laws.\n    \"\"\"\n    result = verify_composition_law(\"solo\", \"greet\")\n    assert result.status == LawStatus.FAILED\n</code></pre>"},{"location":"skills/agent-town-visualization/#teaching-example-widget-state-map-equivalence","title":"Teaching Example: Widget State Map Equivalence","text":"<pre><code># The functor law for widgets\n\ndef test_state_map_equivalence(widget: EigenvectorScatterWidgetImpl) -&gt; None:\n    \"\"\"Test: widget.map(f) \u2261 widget.with_state(f(state)).\n\n    This law ensures that:\n    1. Mapping a function over the widget\n    2. Is the same as applying that function to state\n\n    Enables filter composition without mutating widget.\n    \"\"\"\n    f = lambda s: ScatterState(points=s.points, show_evolving_only=True)\n\n    # These must be equivalent:\n    result_via_map = widget.map(f)\n    result_via_state = widget.with_state(f(widget.state.value))\n\n    assert result_via_map.state.value == result_via_state.state.value\n</code></pre>"},{"location":"skills/agent-town-visualization/#teaching-example-graceful-degradation","title":"Teaching Example: Graceful Degradation","text":"<pre><code># From demo_marimo.py \u2014 handle API failures gracefully\n\nasync def connect_town(town_id_input, scatter, fetch_scatter_data):\n    \"\"\"Connect to existing town when town_id_input changes.\"\"\"\n    if town_id_input.value and town_id_input.value != scatter.town_id:\n        try:\n            scatter_data = await fetch_scatter_data(town_id_input.value)\n            scatter.points = scatter_data.get(\"points\", [])\n            scatter.town_id = town_id_input.value\n        except Exception:\n            pass  # Silently fail for invalid town IDs\n    return ()\n</code></pre> <p>The pattern: try the operation, catch exceptions, maintain previous state. Users see no crash; the widget simply doesn't update.</p>"},{"location":"skills/agent-town-visualization/#phase-7-llm-backed-citizen-dialogue","title":"Phase 7: LLM-Backed Citizen Dialogue","text":"<p>This section documents the dialogue generation system for Agent Town citizens.</p>"},{"location":"skills/agent-town-visualization/#overview_1","title":"Overview","text":"<p>Phase 7 adds speech to citizens. When citizens interact (greet, gossip, trade), they generate dialogue via LLM calls, grounded in their memories and consistent with their archetype personality.</p> <p>Key Features: - Budget-aware routing: citizen tiers \u2192 model selection - Template fallback: always produces dialogue (never fails silently) - Memory grounding: dialogue references past interactions - Archetype voice: personality-consistent speech</p>"},{"location":"skills/agent-town-visualization/#quick-start_1","title":"Quick Start","text":"<pre><code>from agents.town.dialogue_engine import (\n    CitizenDialogueEngine,\n    DialogueBudgetConfig,\n    MockLLMClient,\n)\n\n# Create engine with mock LLM (for testing)\nengine = CitizenDialogueEngine(\n    llm_client=MockLLMClient(),\n    budget_config=DialogueBudgetConfig(),\n)\n\n# Register citizens with budget tiers\nengine.register_citizen(\"alice\", tier=\"evolving\")  # Full LLM\nengine.register_citizen(\"bob\", tier=\"leader\")      # Sampled LLM\nengine.register_citizen(\"carol\", tier=\"standard\")  # Template/cached\n\n# Generate dialogue\nfrom agents.town.flux import TownPhase\nresult = await engine.generate(\n    speaker=alice,\n    listener=bob,\n    operation=\"greet\",\n    phase=TownPhase.MORNING,\n)\nprint(result.text)  # \"Good morning, Bob. The structure holds...\"\n</code></pre>"},{"location":"skills/agent-town-visualization/#budget-tiers","title":"Budget Tiers","text":"<p>Citizens receive different dialogue quality based on their tier:</p> Tier Daily Tokens Model Access Use Case <code>evolving</code> 2000 SONNET/HAIKU 3-5 evolving citizens <code>leader</code> 500 HAIKU/CACHED 5 archetype leaders <code>standard</code> 100 CACHED/TEMPLATE 15+ standard citizens <p>Cascade Behavior: <pre><code>SONNET (budget OK) \u2192 HAIKU (budget low) \u2192 CACHED (similar dialogue exists) \u2192 TEMPLATE (fallback)\n</code></pre></p> <p>Evolving citizens NEVER get TEMPLATE\u2014they cascade to HAIKU even when budget is low.</p>"},{"location":"skills/agent-town-visualization/#registering-citizens","title":"Registering Citizens","text":"<pre><code># Register at town initialization\nfor citizen_id, citizen in town.citizens.items():\n    if citizen_id in town.evolving_ids:\n        tier = \"evolving\"\n    elif citizen.is_archetype_leader:\n        tier = \"leader\"\n    else:\n        tier = \"standard\"\n    engine.register_citizen(citizen_id, tier=tier)\n</code></pre>"},{"location":"skills/agent-town-visualization/#configuring-budget","title":"Configuring Budget","text":"<pre><code>from agents.town.dialogue_engine import DialogueBudgetConfig\n\nconfig = DialogueBudgetConfig(\n    # Model routing by operation\n    model_routing={\n        \"greet\": \"haiku\",       # Quick greetings\n        \"gossip\": \"haiku\",      # Social chatter\n        \"trade\": \"sonnet\",      # Nuanced negotiation\n        \"council\": \"sonnet\",    # Coalition decisions\n        \"solo_reflect\": \"haiku\",\n    },\n    # Daily token limits by tier\n    tier_budgets={\n        \"evolving\": 2000,\n        \"leader\": 500,\n        \"standard\": 100,\n    },\n    # Estimated tokens per operation\n    operation_estimates={\n        \"greet\": 50,\n        \"gossip\": 100,\n        \"trade\": 200,\n        \"council\": 500,\n        \"solo_reflect\": 75,\n    },\n)\n\nengine = CitizenDialogueEngine(\n    llm_client=create_llm_client(),  # Real LLM\n    budget_config=config,\n)\n</code></pre>"},{"location":"skills/agent-town-visualization/#streaming-dialogue","title":"Streaming Dialogue","text":"<pre><code>async for chunk in engine.generate_stream(\n    speaker=alice,\n    listener=bob,\n    operation=\"trade\",\n    phase=TownPhase.AFTERNOON,\n):\n    if isinstance(chunk, str):\n        # Text chunk - display progressively\n        print(chunk, end=\"\", flush=True)\n    else:\n        # DialogueResult - final stats\n        print(f\"\\n[Tokens: {chunk.tokens_used}, Model: {chunk.model}]\")\n</code></pre>"},{"location":"skills/agent-town-visualization/#archetype-voices","title":"Archetype Voices","text":"<p>Each archetype has a distinct voice pattern derived from their cosmotechnics:</p> Archetype Voice Pattern Temperature Builder Construction metaphors, practical 0.5 Trader Exchange framing, calculating 0.6 Healer Restoration language, empathetic 0.7 Scholar Curious, probing, pattern-seeking 0.4 Watcher Historical references, patient 0.5 <p>Example Builder Voice: <pre><code>\"Good to see you, Bob. Working on any new projects?\"\n\"The foundation's looking solid today.\"\n</code></pre></p> <p>Example Healer Voice: <pre><code>\"Hello, Bob. How are you feeling today?\"\n\"I sensed someone needed company. Are you alright?\"\n</code></pre></p>"},{"location":"skills/agent-town-visualization/#memory-grounding","title":"Memory Grounding","text":"<p>Dialogue uses M-gent's foveation pattern for memory context:</p> <pre><code>@dataclass\nclass DialogueContext:\n    focal_memories: list[str]      # Top 3 by relevance\n    peripheral_memories: list[str]  # Next 2\n    relationship: float             # [-1, 1]\n    phase_name: str\n    region: str\n    recent_events: list[str]\n    shared_coalition: str | None\n</code></pre> <p>Memories mentioning the listener are prioritized. Relationship affects tone.</p>"},{"location":"skills/agent-town-visualization/#dialogueresult","title":"DialogueResult","text":"<pre><code>@dataclass\nclass DialogueResult:\n    text: str                       # The dialogue\n    tokens_used: int                # Actual token count\n    model: str                      # \"claude-3-haiku\" / \"template\" / \"cached\"\n    grounded_memories: list[str]    # Memories referenced\n    was_template: bool              # True if template fallback\n    was_cached: bool                # True if cache hit\n    speaker_id: str\n    listener_id: str\n    operation: str                  # \"greet\" / \"gossip\" / \"trade\"\n</code></pre>"},{"location":"skills/agent-town-visualization/#adr-key-design-decisions","title":"ADR: Key Design Decisions","text":""},{"location":"skills/agent-town-visualization/#adr-1-evolving-citizens-always-get-llm","title":"ADR-1: Evolving Citizens Always Get LLM","text":"<p>Context: Some citizens are marked \"evolving\" because they're under active observation for eigenvector drift.</p> <p>Decision: Evolving citizens NEVER fall back to TEMPLATE, only HAIKU.</p> <p>Rationale: Template dialogue doesn't create enough variation for eigenvector evolution. Even budget-constrained evolving citizens need some LLM diversity.</p>"},{"location":"skills/agent-town-visualization/#adr-2-reuse-k-gent-llm-infrastructure","title":"ADR-2: Reuse K-gent LLM Infrastructure","text":"<p>Context: K-gent already has LLMClient, MockLLMClient, and streaming patterns.</p> <p>Decision: Direct import from <code>agents.k.llm</code> rather than duplicating.</p> <p>Rationale: <code>Cross-agent import OK: Town\u2192K-gent LLM; reuse &gt; duplicate</code> (meta.md 2025-12-14). The LLM interface is stable and well-tested.</p>"},{"location":"skills/agent-town-visualization/#adr-3-foveation-pattern-for-memory-grounding","title":"ADR-3: Foveation Pattern for Memory Grounding","text":"<p>Context: Citizens have potentially many memories of each other.</p> <p>Decision: Use M-gent's foveation pattern: 3 focal + 2 peripheral memories.</p> <p>Rationale: 5 memories provide sufficient context without overwhelming the prompt. Focal/peripheral split mirrors human attention.</p>"},{"location":"skills/agent-town-visualization/#adr-4-template-fallback-never-fails","title":"ADR-4: Template Fallback Never Fails","text":"<p>Context: LLM calls can fail, budgets can be exhausted.</p> <p>Decision: Template tier always produces coherent dialogue.</p> <p>Rationale: <code>Tier cascade: TEMPLATE never fails; budget exhaustion \u2192 graceful fallback</code> (meta.md 2025-12-14).</p>"},{"location":"skills/agent-town-visualization/#verification-commands-phase-7","title":"Verification Commands (Phase 7)","text":"<pre><code># Run dialogue engine tests\nuv run pytest agents/town/_tests/test_dialogue_engine.py -v\n\n# Run live LLM integration tests (requires credentials)\nuv run pytest agents/town/_tests/test_integration.py -v -k \"dialogue\"\n\n# Check budget cascade behavior\nuv run pytest agents/town/_tests/test_dialogue_engine.py -v -k \"tier or cascade\"\n\n# Full town test suite (696 tests)\nuv run pytest agents/town/_tests/ -v --tb=short\n</code></pre>"},{"location":"skills/agent-town-visualization/#teaching-example-budget-tier-selection","title":"Teaching Example: Budget Tier Selection","text":"<pre><code>def test_tier_cascade(engine: CitizenDialogueEngine) -&gt; None:\n    \"\"\"Test: evolving \u2192 leader \u2192 standard tier behavior.\n\n    Evolving citizens cascade: SONNET \u2192 HAIKU (never TEMPLATE).\n    Leaders cascade: HAIKU \u2192 CACHED \u2192 TEMPLATE.\n    Standard: CACHED \u2192 TEMPLATE.\n    \"\"\"\n    # Register citizens\n    engine.register_citizen(\"evolving_1\", tier=\"evolving\")\n    engine.register_citizen(\"leader_1\", tier=\"leader\")\n    engine.register_citizen(\"standard_1\", tier=\"standard\")\n\n    # Evolving gets SONNET initially\n    tier = engine.get_tier(evolving_citizen)\n    assert tier in (DialogueTier.SONNET, DialogueTier.HAIKU)\n    assert tier != DialogueTier.TEMPLATE  # Never template\n\n    # Leader gets HAIKU or CACHED\n    tier = engine.get_tier(leader_citizen)\n    assert tier in (DialogueTier.HAIKU, DialogueTier.CACHED, DialogueTier.TEMPLATE)\n\n    # Standard gets CACHED or TEMPLATE\n    tier = engine.get_tier(standard_citizen)\n    assert tier in (DialogueTier.CACHED, DialogueTier.TEMPLATE)\n</code></pre>"},{"location":"skills/agent-town-visualization/#teaching-example-streaming-accumulation","title":"Teaching Example: Streaming Accumulation","text":"<pre><code>async def test_streaming_accumulation(engine: CitizenDialogueEngine) -&gt; None:\n    \"\"\"Test: streaming yields chunks + final result.\n\n    Stream yields strings (chunks) during generation,\n    then DialogueResult at the end with token counts.\n    \"\"\"\n    chunks = []\n    final_result = None\n\n    async for item in engine.generate_stream(\n        speaker=alice,\n        listener=bob,\n        operation=\"greet\",\n        phase=TownPhase.MORNING,\n    ):\n        if isinstance(item, str):\n            chunks.append(item)\n        else:\n            final_result = item\n\n    # Chunks accumulated to full text\n    assert \"\".join(chunks) == final_result.text\n    # Result has token accounting\n    assert final_result.tokens_used &gt;= 0\n</code></pre>"},{"location":"skills/agent-town-visualization/#phase-7-metrics-and-measurement-measure","title":"Phase 7: Metrics and Measurement (MEASURE)","text":"<p>This section documents the quantitative metrics for the Phase 7 dialogue system.</p>"},{"location":"skills/agent-town-visualization/#code-metrics","title":"Code Metrics","text":"Metric Value Notes Town tests total 696 +71 from Phase 7 Dialogue tests 71 test_dialogue_engine.py Integration tests 16 test_integration.py (dialogue) Production lines 880 dialogue_engine.py + dialogue_voice.py Test lines 1482 test_dialogue_engine.py Modules added 2 dialogue_engine, dialogue_voice Cross-agent deps +1 K-gent LLM (direct import)"},{"location":"skills/agent-town-visualization/#leading-indicators","title":"Leading Indicators","text":"Audience Goal Signal Source Operator Run dialogue demo Template fallback rate DialogueResult.was_template Operator Budget stays healthy Daily token burn rate CitizenBudget.tokens_used_today Maintainer Extend archetypes safely Voice test coverage test_dialogue_engine.py Maintainer Understand cascade Tier transition logs DialogueTier changes Contributor Add features confidently Test regression rate CI pipeline User Dialogue feels authentic Memory grounding rate DialogueResult.grounded_memories"},{"location":"skills/agent-town-visualization/#baselines-and-thresholds","title":"Baselines and Thresholds","text":"Metric Baseline Alert Threshold Rationale Template fallback rate &lt;20% (evolving) &gt;50% Budget too tight Dialogue test suite 15.83s &gt;30s CI feedback loop Memory grounding 2+ memories 0 memories Context missing Tokens per greet ~50 &gt;100 Prompt bloat Tokens per trade ~200 &gt;400 Model inefficiency Daily budget burn &lt;80% &gt;95% Budget exhaustion risk"},{"location":"skills/agent-town-visualization/#counter-metrics","title":"Counter-Metrics","text":"<p>What would indicate this feature is harmful?</p> Signal Counter-Signal Mitigation High dialogue quality Token cost explosion Tier budgets, cascade Memory grounding Slow context build Foveation limit (5 max) Archetype consistency Repetitive dialogue Temperature tuning Fast generation Model quality drop Tier selection logic Many tests Slow CI Parallel execution"},{"location":"skills/agent-town-visualization/#budget-model-validation","title":"Budget Model Validation","text":"Tier Daily Limit Est. Interactions Burn Rate Evolving 2000 tokens ~20 trades 100%/day sustainable Leader 500 tokens ~10 greets 50%/day expected Standard 100 tokens Template only 0% (cached/template)"},{"location":"skills/agent-town-visualization/#verification-commands-metrics","title":"Verification Commands (Metrics)","text":"<pre><code># Check dialogue test duration (baseline: 15.83s)\nuv run pytest agents/town/_tests/test_dialogue_engine.py -q --tb=no\n\n# Check total town tests (baseline: 696)\nuv run pytest agents/town/_tests/ --collect-only -q 2&gt;/dev/null | tail -1\n\n# Run full suite with durations\nuv run pytest agents/town/_tests/ -v --durations=10 --tb=short\n</code></pre>"},{"location":"skills/agent-town-visualization/#verification-commands-phase-6","title":"Verification Commands (Phase 6)","text":"<pre><code># Run all Phase 6 tests\nuv run pytest agents/town/_tests/test_visualization_contracts.py -v\nuv run pytest agents/town/_tests/test_functor.py -v\nuv run pytest agents/town/_tests/test_marimo_integration.py -v\n\n# Check functor laws specifically\nuv run pytest agents/town/_tests/test_functor.py -v -k \"law\"\n\n# Full town test suite\nuv run pytest agents/town/_tests/ -v --tb=short\n</code></pre>"},{"location":"skills/agent-town-visualization/#performance-baselines","title":"Performance Baselines","text":"Metric Value Notes Render (25 citizens) 0.03ms p50 Measure before optimizing SSE connection &lt;100ms Localhost; production varies CSS transition 300ms <code>ease-out</code> curve Test suite 1.36s 529 tests"},{"location":"skills/agent-town-visualization/#phase-6-metrics-and-measurement-measure","title":"Phase 6: Metrics and Measurement (MEASURE)","text":"<p>This section documents the leading indicators, baselines, and alert thresholds for Agent Town visualization.</p>"},{"location":"skills/agent-town-visualization/#leading-indicators_1","title":"Leading Indicators","text":"Audience Goal Signal Source Operator Run the demo successfully Demo launch success rate API <code>/v1/town/</code> Operator Stable SSE connections SSE disconnection rate <code>TownSSEEndpoint</code> Maintainer Extend widgets safely Functor law test coverage <code>test_functor.py</code> Maintainer Understand widget state Documentation completeness Skill doc Contributor Add features with confidence Test regression rate CI pipeline Contributor Quick feedback loop Test suite duration <code>pytest --durations</code>"},{"location":"skills/agent-town-visualization/#baselines-and-thresholds_1","title":"Baselines and Thresholds","text":"Metric Baseline Alert Threshold Rationale Widget render (25 citizens) 0.03ms p50 &gt;10ms 300x regression SSE connection time &lt;100ms &gt;500ms User-perceptible delay CSS transition duration 300ms Fixed Design constant Test count 529 &lt;500 Regression indicator Test suite duration 1.51s &gt;5s CI feedback loop Functor law tests 33 &lt;30 Law coverage Marimo integration tests 24 &lt;20 Widget coverage"},{"location":"skills/agent-town-visualization/#counter-metrics_1","title":"Counter-Metrics","text":"<p>What would indicate this feature is harmful?</p> Signal Counter-Signal Mitigation High adoption (many demos) Memory exhaustion from SSE Connection pooling, max concurrent Fast render CPU spike during PCA Cache PCA results Many tests Slow CI feedback Parallel test execution Rich documentation Stale docs Changelog discipline"},{"location":"skills/agent-town-visualization/#metric-locations","title":"Metric Locations","text":"Metric Location How to Check Test count <code>pytest --collect-only</code> <code>uv run pytest agents/town/_tests/ --collect-only \\| grep \"test\" \\| wc -l</code> Test duration pytest output <code>uv run pytest agents/town/_tests/ -q --tb=no</code> Render benchmark <code>test_visualization_contracts.py</code> See <code>TestScatterPerformance</code> Functor laws <code>test_functor.py</code> <code>uv run pytest agents/town/_tests/test_functor.py -v -k \"law\"</code>"},{"location":"skills/agent-town-visualization/#dashboard-sketch-future","title":"Dashboard Sketch (Future)","text":"<pre><code>+----------------------------------------------------------+\n|                 Agent Town Metrics                        |\n+----------------------------------------------------------+\n| Test Health                | Widget Performance          |\n| ========================== | =========================== |\n| Tests: 529 \u2713               | Render p50: 0.03ms \u2713        |\n| Duration: 1.51s \u2713          | SSE connect: &lt;100ms \u2713       |\n| Functor laws: 33 \u2713         | Memory: N/A                 |\n+----------------------------------------------------------+\n| SSE Connections            | Demo Usage                  |\n| ========================== | =========================== |\n| Active: 0                  | Today: N/A                  |\n| Disconnects: 0             | This week: N/A              |\n+----------------------------------------------------------+\n</code></pre>"},{"location":"skills/agent-town-visualization/#verification-commands-metrics_1","title":"Verification Commands (Metrics)","text":"<pre><code># Check current test count (baseline: 529)\nuv run pytest agents/town/_tests/ --collect-only -q 2&gt;/dev/null | tail -1\n\n# Run performance tests\nuv run pytest agents/town/_tests/test_visualization_contracts.py -v -k \"Performance\"\n\n# Check functor law coverage\nuv run pytest agents/town/_tests/test_functor.py -v --tb=short\n\n# Full metrics check\nuv run pytest agents/town/_tests/ -v --durations=10 --tb=short\n</code></pre>"},{"location":"skills/agent-town-visualization/#recursive-hologram","title":"Recursive Hologram","text":"<p>This skill unfolds from the unified categorical foundation:</p> <pre><code>PolyAgent[S, A, B]  \u2192  TOWN_OPERAD  \u2192  TownSheaf (future)\n        \u2193                   \u2193                  \u2193\n  ScatterState       town.*.* paths      global coherence\n        \u2193                   \u2193                  \u2193\n  Functor Laws       Phase transitions   Eigenvector centroid\n</code></pre> <p>Self-Similarity: The widget's <code>map(f)</code> operation IS a functor; the functor IS the pattern; the pattern IS the skill.</p>"},{"location":"skills/agent-town-visualization/#continuation-generator","title":"Continuation Generator","text":"<pre><code>\u27ff[REFLECT]\n/hydrate prompts/agent-town-phase7-reflect.md\nhandles: metrics_recorded=true; budget_model=validated; baselines=captured\nmission: synthesize Phase 7 learnings, identify patterns for Phase 8\n</code></pre> <p>Exploration Seeds (Accursed Share for Phase 7+):</p> Seed Domain Entropy Budget LLM-backed citizen dialogue <code>void.llm.*</code> 0.15 Procedural town generation <code>void.generation.*</code> 0.10 Inter-town communication <code>void.network.*</code> 0.10 Time-travel debugging <code>void.temporal.*</code> 0.05 Citizen death/rebirth <code>void.lifecycle.*</code> 0.05 TownSheaf coherence <code>concept.sheaf.*</code> 0.10"},{"location":"skills/agent-town-visualization/#changelog","title":"Changelog","text":"<ul> <li>2025-12-14: Phase 7 MEASURE - Code metrics, leading indicators, budget model validation</li> <li>2025-12-14: Phase 7 EDUCATE - DialogueEngine API, budget tiers, archetype voices, ADRs</li> <li>2025-12-14: Added Recursive Hologram and Continuation Generator (RE-METABOLIZE)</li> <li>2025-12-14: Phase 6 MEASURE - Metrics, baselines, thresholds, counter-metrics</li> <li>2025-12-14: Phase 6 EDUCATE - Teaching examples, demo guide, verification commands</li> <li>2025-12-14: Phase 6 RESEARCH - Live marimo notebook patterns</li> <li>2025-12-14: Initial version (Phase 5 EDUCATE)</li> </ul>"},{"location":"skills/agentese-path/","title":"Skill: Adding an AGENTESE Path","text":"<p>Add a new path to the AGENTESE system (e.g., <code>self.soul.*</code> or <code>world.calendar.*</code>).</p> <p>Difficulty: Medium Prerequisites: Understanding of AGENTESE ontology (<code>spec/protocols/agentese.md</code>), familiarity with Python dataclasses Files Touched: <code>protocols/agentese/contexts/&lt;context&gt;.py</code>, <code>protocols/agentese/contexts/__init__.py</code>, tests</p>"},{"location":"skills/agentese-path/#overview","title":"Overview","text":"<p>AGENTESE paths follow the structure <code>&lt;context&gt;.&lt;holon&gt;.&lt;aspect&gt;</code>. There are exactly five contexts:</p> Context Purpose Resolver File <code>world.*</code> External entities <code>contexts/world.py</code> <code>self.*</code> Internal state <code>contexts/self_.py</code> <code>concept.*</code> Abstract ideas <code>contexts/concept.py</code> <code>void.*</code> Entropy/Accursed Share <code>contexts/void.py</code> <code>time.*</code> Temporal operations <code>contexts/time.py</code> <p>Adding a new path involves: 1. Adding to an existing context (most common) - Add a new holon to a context 2. Adding a new aspect to an existing holon - Extend an existing node</p>"},{"location":"skills/agentese-path/#n-cycle-quickrun-doc-only","title":"N-cycle Quickrun (doc-only)","text":"<ul> <li>PLAN\u2192REFLECT: <code>concept.agentese.manifest[phase=PLAN][minimal_output=true]</code> scope; <code>concept.agentese.refine[phase=DEVELOP][rollback=true][law_check=true]</code> draft handles; <code>void.entropy.sip[entropy=0.07]</code> budget; <code>time.agentese.witness[phase=REFLECT]</code> log; ops apply when code gates open.</li> </ul>"},{"location":"skills/agentese-path/#step-by-step-add-a-holon-to-existing-context","title":"Step-by-Step: Add a Holon to Existing Context","text":"<p>This is the most common case: adding something like <code>self.semaphore.*</code> or <code>world.purgatory.*</code>.</p>"},{"location":"skills/agentese-path/#step-1-define-affordances","title":"Step 1: Define Affordances","text":"<p>Add your holon's affordances to the context's affordance dict.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <p>Pattern (using <code>self_.py</code> as example): <pre><code># Near the top of the file, find or add the affordances dict\nSELF_AFFORDANCES: dict[str, tuple[str, ...]] = {\n    \"memory\": (\"consolidate\", \"prune\", \"checkpoint\", \"recall\", \"forget\"),\n    \"capabilities\": (\"list\", \"acquire\", \"release\"),\n    # ... existing entries ...\n\n    # ADD YOUR NEW HOLON HERE\n    \"semaphore\": (\"pending\", \"yield\", \"status\"),\n}\n</code></pre></p>"},{"location":"skills/agentese-path/#step-2-create-the-node-class","title":"Step 2: Create the Node Class","text":"<p>Create a dataclass that extends <code>BaseLogosNode</code>.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <p>Template: <pre><code>@dataclass\nclass MyNewNode(BaseLogosNode):\n    \"\"\"\n    &lt;context&gt;.&lt;holon&gt; - Brief description.\n\n    Provides access to &lt;what this does&gt;:\n    - aspect1: Description\n    - aspect2: Description\n    - aspect3: Description\n\n    AGENTESE: &lt;context&gt;.&lt;holon&gt;.*\n    \"\"\"\n\n    _handle: str = \"&lt;context&gt;.&lt;holon&gt;\"\n\n    # Integration points (optional)\n    _some_service: Any = None\n\n    @property\n    def handle(self) -&gt; str:\n        return self._handle\n\n    def _get_affordances_for_archetype(self, archetype: str) -&gt; tuple[str, ...]:\n        \"\"\"Return affordances for this holon.\"\"\"\n        # Option 1: Same for all archetypes\n        return SELF_AFFORDANCES[\"&lt;holon&gt;\"]\n\n        # Option 2: Archetype-specific\n        # if archetype in (\"admin\", \"developer\"):\n        #     return (\"aspect1\", \"aspect2\", \"aspect3\")\n        # return (\"aspect1\",)  # Read-only for others\n\n    async def manifest(self, observer: \"Umwelt[Any, Any]\") -&gt; Renderable:\n        \"\"\"View current state.\"\"\"\n        return BasicRendering(\n            summary=\"&lt;Holon&gt; State\",\n            content=\"Description of current state\",\n            metadata={\"key\": \"value\"},\n        )\n\n    async def _invoke_aspect(\n        self,\n        aspect: str,\n        observer: \"Umwelt[Any, Any]\",\n        **kwargs: Any,\n    ) -&gt; Any:\n        \"\"\"Handle holon-specific aspects.\"\"\"\n        match aspect:\n            case \"aspect1\":\n                return await self._handle_aspect1(observer, **kwargs)\n            case \"aspect2\":\n                return await self._handle_aspect2(observer, **kwargs)\n            case _:\n                return {\"aspect\": aspect, \"status\": \"not implemented\"}\n\n    async def _handle_aspect1(\n        self,\n        observer: \"Umwelt[Any, Any]\",\n        **kwargs: Any,\n    ) -&gt; dict[str, Any]:\n        \"\"\"Handle aspect1 - describe what it does.\"\"\"\n        # Your implementation here\n        return {\"status\": \"ok\"}\n\n    async def _handle_aspect2(\n        self,\n        observer: \"Umwelt[Any, Any]\",\n        **kwargs: Any,\n    ) -&gt; dict[str, Any]:\n        \"\"\"Handle aspect2 - describe what it does.\"\"\"\n        # Your implementation here\n        return {\"status\": \"ok\"}\n</code></pre></p>"},{"location":"skills/agentese-path/#step-3-wire-into-context-resolver","title":"Step 3: Wire into Context Resolver","text":"<p>Add your node to the context resolver's <code>resolve()</code> method.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <p>Pattern (for <code>SelfContextResolver</code>): <pre><code>@dataclass\nclass SelfContextResolver:\n    \"\"\"Resolver for self.* context.\"\"\"\n\n    # Add integration point if needed\n    _purgatory: Any = None\n\n    # Add singleton node field\n    _semaphore: SemaphoreNode | None = None\n\n    def __post_init__(self) -&gt; None:\n        \"\"\"Initialize singleton nodes.\"\"\"\n        # ... existing nodes ...\n        self._semaphore = SemaphoreNode(_purgatory=self._purgatory)\n\n    def resolve(self, holon: str, rest: list[str]) -&gt; BaseLogosNode:\n        \"\"\"Resolve a self.* path to a node.\"\"\"\n        match holon:\n            # ... existing cases ...\n            case \"semaphore\":\n                return self._semaphore or SemaphoreNode()\n            case _:\n                # Fallback for undefined holons\n                return GenericSelfNode(holon)\n</code></pre></p>"},{"location":"skills/agentese-path/#step-4-update-factory-function","title":"Step 4: Update Factory Function","text":"<p>If your node needs integration points, update the context's factory function.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <p>Pattern: <pre><code>def create_self_resolver(\n    d_gent: Any = None,\n    n_gent: Any = None,\n    purgatory: Any = None,  # ADD NEW PARAMETER\n) -&gt; SelfContextResolver:\n    \"\"\"Create a SelfContextResolver with optional integrations.\"\"\"\n    resolver = SelfContextResolver()\n    resolver._d_gent = d_gent\n    resolver._n_gent = n_gent\n    resolver._purgatory = purgatory  # WIRE IT IN\n    resolver.__post_init__()\n    return resolver\n</code></pre></p>"},{"location":"skills/agentese-path/#step-5-update-create_context_resolvers","title":"Step 5: Update <code>create_context_resolvers</code>","text":"<p>If you added new integration points, update the unified factory.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/__init__.py</code></p> <p>Pattern: <pre><code>def create_context_resolvers(\n    # ... existing params ...\n    purgatory: Any = None,  # ADD IF NEW\n) -&gt; dict[str, Any]:\n    \"\"\"Create all five context resolvers.\"\"\"\n    return {\n        # ... existing resolvers ...\n        \"self\": create_self_resolver(\n            d_gent=d_gent,\n            n_gent=narrator,\n            purgatory=purgatory,  # PASS IT THROUGH\n        ),\n    }\n</code></pre></p>"},{"location":"skills/agentese-path/#step-6-export-from-__init__py","title":"Step 6: Export from <code>__init__.py</code>","text":"<p>Export your new node class and any constants.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/__init__.py</code></p> <p>Pattern: <pre><code>from .self_ import (\n    # ... existing exports ...\n    SemaphoreNode,  # ADD\n)\n\n__all__ = [\n    # ... existing exports ...\n    \"SemaphoreNode\",  # ADD\n]\n</code></pre></p>"},{"location":"skills/agentese-path/#step-7-write-tests","title":"Step 7: Write Tests","text":"<p>Create tests for your new path.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/_tests/test_&lt;holon&gt;.py</code></p> <p>Template: <pre><code>\"\"\"\nTests for &lt;context&gt;.&lt;holon&gt;.* paths.\n\nTests verify:\n1. Basic functionality of each aspect\n2. Affordance filtering by archetype\n3. Error handling\n4. Integration with services (if applicable)\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom typing import Any, cast\n\nimport pytest\nfrom bootstrap.umwelt import Umwelt\n\nfrom ..&lt;context&gt; import (\n    MyNewNode,\n    create_&lt;context&gt;_resolver,\n)\n\n\n# === Test Fixtures ===\n\nclass MockDNA:\n    \"\"\"Mock DNA for testing.\"\"\"\n    def __init__(self, name: str = \"test\", archetype: str = \"default\") -&gt; None:\n        self.name = name\n        self.archetype = archetype\n        self.capabilities: tuple[str, ...] = ()\n\n\nclass MockUmwelt:\n    \"\"\"Mock Umwelt for testing.\"\"\"\n    def __init__(self, archetype: str = \"default\", name: str = \"test\") -&gt; None:\n        self.dna = MockDNA(name=name, archetype=archetype)\n        self.gravity: tuple[Any, ...] = ()\n        self.context: dict[str, Any] = {}\n\n\n@pytest.fixture\ndef observer() -&gt; Umwelt[Any, Any]:\n    \"\"\"Default observer.\"\"\"\n    return cast(Umwelt[Any, Any], MockUmwelt())\n\n\n@pytest.fixture\ndef resolver() -&gt; &lt;Context&gt;ContextResolver:\n    \"\"\"Context resolver.\"\"\"\n    return create_&lt;context&gt;_resolver()\n\n\n# === Tests ===\n\nclass TestAspect1:\n    \"\"\"Tests for &lt;context&gt;.&lt;holon&gt;.aspect1\"\"\"\n\n    @pytest.mark.asyncio\n    async def test_aspect1_basic(\n        self,\n        resolver: &lt;Context&gt;ContextResolver,\n        observer: Umwelt[Any, Any],\n    ) -&gt; None:\n        \"\"\"Basic test for aspect1.\"\"\"\n        node = resolver.resolve(\"&lt;holon&gt;\", [])\n\n        result = await node._invoke_aspect(\"aspect1\", observer)\n\n        assert result[\"status\"] == \"ok\"\n\n\nclass TestAffordances:\n    \"\"\"Tests for affordance filtering.\"\"\"\n\n    def test_affordances_for_admin(self) -&gt; None:\n        \"\"\"Admin has expected affordances.\"\"\"\n        node = MyNewNode()\n        affordances = node._get_affordances_for_archetype(\"admin\")\n\n        assert \"aspect1\" in affordances\n        assert \"aspect2\" in affordances\n</code></pre></p>"},{"location":"skills/agentese-path/#step-by-step-add-aspect-to-existing-holon","title":"Step-by-Step: Add Aspect to Existing Holon","text":"<p>If you need to add a new aspect to an existing holon (e.g., adding <code>self.memory.dream</code>):</p>"},{"location":"skills/agentese-path/#step-1-add-to-affordances","title":"Step 1: Add to Affordances","text":"<p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <pre><code>SELF_AFFORDANCES: dict[str, tuple[str, ...]] = {\n    \"memory\": (\"consolidate\", \"prune\", \"checkpoint\", \"recall\", \"forget\", \"dream\"),  # ADD\n    # ...\n}\n</code></pre>"},{"location":"skills/agentese-path/#step-2-add-handler-method","title":"Step 2: Add Handler Method","text":"<pre><code>async def _invoke_aspect(\n    self,\n    aspect: str,\n    observer: \"Umwelt[Any, Any]\",\n    **kwargs: Any,\n) -&gt; Any:\n    match aspect:\n        # ... existing cases ...\n        case \"dream\":\n            return await self._dream(observer, **kwargs)\n\nasync def _dream(\n    self,\n    observer: \"Umwelt[Any, Any]\",\n    **kwargs: Any,\n) -&gt; dict[str, Any]:\n    \"\"\"Handle dream aspect - hypnagogic memory consolidation.\"\"\"\n    # Implementation\n    return {\"dreamed\": True}\n</code></pre>"},{"location":"skills/agentese-path/#step-3-add-tests","title":"Step 3: Add Tests","text":"<p>Add test cases for the new aspect.</p>"},{"location":"skills/agentese-path/#forest-handle-appendix-agentese-x-plans-doc-only","title":"Forest Handle Appendix (AGENTESE x Plans) - Doc Only","text":"<p>Forest handles are functor views over planning artifacts. Preserve Minimal Output (one renderable/dict) and category laws (identity/associativity). Use streams over arrays when multiple items are needed.</p> Handle Inputs Output (Minimal Output) Roles (guest/meta/ops) Notes <code>concept.forest.manifest[phase=PLAN][minimal_output=true]</code> observer role, optional <code>{path?, status?, span?}</code> Renderable dict <code>{canopy, ledger_state, affordances}</code> guest: manifest, meta: manifest+affordances, ops: add lint flag Single canopy view; stream sequential manifests if many plans. <code>time.forest.witness[phase=REFLECT][law_check=true]</code> <code>{range?, filter?}</code> Iterator over epilogue events (one per call) guest: read, meta: filter, ops: annotate spans Law check = epilogue order + identity (idempotent replay). <code>concept.forest.refine[phase=DEVELOP][rollback=true][law_check=true]</code> mutation patch <code>{add|prune|fuse}</code> Sympathetic dict <code>{status, applied_patch?, rollback_token?}</code> meta: propose, ops: apply/rollback, guest: read-only Associativity enforced on patch composition; rollback token required for ops. <code>void.forest.sip[phase=RESEARCH][entropy=0.07]</code> <code>{seed?, selector?}</code> <code>{selection, entropy_spent}</code> guest/meta: suggest dormant, ops: approve Accursed Share draw; returns single selection not list. <code>self.forest.define[phase=IMPLEMENT][minimal_output=true]</code> <code>{path, scaffold}</code> <code>{status, draft_header}</code> meta: scaffold, ops: promote, guest: request only Yoneda hint: handle is view; scaffold emitted, not persisted."},{"location":"skills/agentese-path/#categorylaw-notes","title":"Category/Law Notes","text":"<ul> <li>Identity: <code>concept.forest.refine</code> with noop patch is neutral; <code>manifest &gt;&gt; Id = manifest</code>.  </li> <li>Associativity: mutation pipelines respect <code>(a &gt;&gt; b) &gt;&gt; c == a &gt;&gt; (b &gt;&gt; c)</code>; reject reorderings that break ledger consistency.  </li> <li>Minimal Output: never return raw arrays; emit iterator/stream or single renderable.  </li> <li>Yoneda: handles are observer-indexed views; changing observer role changes affordance surface without changing the handle string.</li> </ul>"},{"location":"skills/agentese-path/#clause-micro-prompts-phase-ledger-ready","title":"Clause Micro-Prompts (phase ledger ready)","text":"<ul> <li><code>void.entropy.sip[phase=PLAN][entropy=0.07]@span=forest_plan</code> -&gt; record <code>entropy.spent += 0.07</code>.  </li> <li><code>concept.forest.manifest[phase=RESEARCH][minimal_output=true]@span=forest_trace</code> -&gt; map headers/ledgers, log deviations; sample epilogue via <code>time.forest.witness</code>.  </li> <li><code>concept.forest.refine[phase=DEVELOP][rollback=true][law_check=true]@span=forest_dev</code> -&gt; apply patch; rollback token required on failure.  </li> <li><code>time.forest.witness[phase=REFLECT]@span=forest_trace</code> -&gt; stream last epilogue; log ledger delta.  </li> <li><code>void.entropy.pour[phase=REFLECT]@span=entropy_return</code> -&gt; return unused Accursed Share.  </li> </ul>"},{"location":"skills/agentese-path/#n-phase-continuation-doc-only-forest","title":"N-Phase Continuation (doc-only; forest)","text":"<ul> <li>PLAN: <code>concept.forest.manifest[phase=PLAN][minimal_output=true]@span=forest_plan</code> \u2192 declare scope, non-goals, roles (ops/meta/guest); draw <code>void.entropy.sip[entropy=0.07]</code>.  </li> <li>RESEARCH: <code>concept.forest.manifest[phase=RESEARCH]</code> to map headers/ledgers and log deviations; sample epilogues via <code>time.forest.witness@span=forest_trace</code>.  </li> <li>DEVELOP: <code>concept.forest.refine[phase=DEVELOP][rollback=true][law_check=true]@span=forest_dev</code> \u2192 draft handle/IO/law notes; enforce Minimal Output; persist rollback token.  </li> <li>STRATEGIZE: Order rollout docs \u2192 skills \u2192 dry-run adapters; set observer gating matrix; budget entropy return.  </li> <li>CROSS-SYNERGIZE: Align with <code>process-metrics.md</code>, <code>phase-accountability.md</code>, <code>meta-skill-operad.md</code>; declare Accursed Share rotation <code>void.forest.sip</code>.  </li> <li>IMPLEMENT: Doc-only edits in <code>docs/skills/agentese-path.md</code> and forest/n-phase meta plan; no CLI/impl code.  </li> <li>QA/TEST: Headers \u2264100 lines; <code>phase_ledger</code> + <code>entropy</code> present; clauses carry <code>[phase]</code>, <code>[entropy]</code>, <code>[law_check]</code>, <code>[rollback]</code>, <code>[minimal_output]</code>; dry-run = single renderable per handle, witness ordering stable, refine emits rollback token.  </li> <li>EDUCATE: Capture usage snippets + clause patterns in <code>docs/skills/n-phase-cycle/*</code> meta skills.  </li> <li>MEASURE: Desired spans <code>{phase,tokens_in/out,duration_ms,entropy,law_checks}</code> recorded (deferred).  </li> <li>REFLECT: Log learnings/risks; <code>void.entropy.pour</code> unused; tithe if overdrawn.  </li> </ul>"},{"location":"skills/agentese-path/#rollout-doc-skill-adapter-code-deferred","title":"Rollout (doc -&gt; skill -&gt; adapter -&gt; code deferred)","text":"<ol> <li>Docs (this file + meta plan) define contracts and roles.  </li> <li>N-phase skills embed clause-aware prompts for ledger capture.  </li> <li>Adapter spec (forest meta plan) maps handles to CLI once wiring allowed.  </li> <li>Code hooks (forest CLI, spans) are deferred; keep Minimal Output until live.</li> </ol>"},{"location":"skills/agentese-path/#qaverification-doc-scope","title":"QA/Verification (doc scope)","text":"<ul> <li>Handles declare roles, law checks, and entropy band 0.05-0.10.  </li> <li>Outputs are single renderables or iterators; no arrays.  </li> <li>Clause examples include <code>[phase]</code>, <code>[entropy]</code>, <code>[law_check]</code>, <code>[rollback]</code>.</li> </ul>"},{"location":"skills/agentese-path/#verification","title":"Verification","text":""},{"location":"skills/agentese-path/#test-1-resolve-path","title":"Test 1: Resolve path","text":"<pre><code>cd impl/claude\nuv run python -c \"\nfrom protocols.agentese import create_logos\nlogos = create_logos()\nnode = logos.resolve('&lt;context&gt;.&lt;holon&gt;')\nprint(f'Handle: {node.handle}')\n\"\n</code></pre>"},{"location":"skills/agentese-path/#test-2-check-affordances","title":"Test 2: Check affordances","text":"<pre><code>uv run python -c \"\nfrom protocols.agentese import create_logos\nfrom protocols.agentese.node import AgentMeta\nlogos = create_logos()\nnode = logos.resolve('&lt;context&gt;.&lt;holon&gt;')\nmeta = AgentMeta(name='test', archetype='admin')\nprint(f'Affordances: {node.affordances(meta)}')\n\"\n</code></pre>"},{"location":"skills/agentese-path/#test-3-run-tests","title":"Test 3: Run tests","text":"<pre><code>cd impl/claude\nuv run pytest protocols/agentese/contexts/_tests/test_&lt;holon&gt;.py -v\n</code></pre>"},{"location":"skills/agentese-path/#test-4-full-invoke","title":"Test 4: Full invoke","text":"<pre><code>uv run python -c \"\nimport asyncio\nfrom typing import Any, cast\nfrom bootstrap.umwelt import Umwelt\nfrom protocols.agentese import create_logos\n\nclass MockDNA:\n    def __init__(self, archetype: str = 'admin'):\n        self.name = 'test'\n        self.archetype = archetype\n        self.capabilities: tuple[str, ...] = ()\n\nclass MockUmwelt:\n    def __init__(self, archetype: str = 'admin'):\n        self.dna = MockDNA(archetype=archetype)\n        self.gravity: tuple[Any, ...] = ()\n        self.context: dict[str, Any] = {}\n\nasync def main():\n    logos = create_logos()\n    umwelt = cast(Umwelt[Any, Any], MockUmwelt(archetype='admin'))\n    result = await logos.invoke('&lt;context&gt;.&lt;holon&gt;.&lt;aspect&gt;', umwelt)\n    print(result)\n\nasyncio.run(main())\n\"\n</code></pre>"},{"location":"skills/agentese-path/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/agentese-path/#1-forgetting-to-export-from-__init__py","title":"1. Forgetting to export from <code>__init__.py</code>","text":"<p>Symptom: <code>ImportError</code> when trying to use your node elsewhere.</p> <p>Fix: Add to both imports and <code>__all__</code> in <code>contexts/__init__.py</code>.</p>"},{"location":"skills/agentese-path/#2-not-wiring-integration-points","title":"2. Not wiring integration points","text":"<p>Symptom: Your node always returns \"not configured\" errors.</p> <p>Fix: 1. Add parameter to factory function 2. Pass through in <code>create_context_resolvers()</code> 3. Wire to resolver's <code>__post_init__()</code></p>"},{"location":"skills/agentese-path/#3-missing-property-on-handle","title":"3. Missing <code>@property</code> on handle","text":"<p>Symptom: <code>AttributeError: 'MyNode' object has no attribute 'handle'</code></p> <p>Fix: Ensure <code>handle</code> is a property: <pre><code>@property\ndef handle(self) -&gt; str:\n    return self._handle\n</code></pre></p>"},{"location":"skills/agentese-path/#4-blocking-in-async-methods","title":"4. Blocking in async methods","text":"<p>Symptom: Performance issues, event loop blocked.</p> <p>Fix: Use <code>await</code> for I/O operations, don't do heavy computation in aspect handlers.</p>"},{"location":"skills/agentese-path/#5-not-handling-unknown-aspects","title":"5. Not handling unknown aspects","text":"<p>Symptom: <code>KeyError</code> or crashes on unrecognized aspects.</p> <p>Fix: Always have a default case in your match statement: <pre><code>case _:\n    return {\"aspect\": aspect, \"status\": \"not implemented\"}\n</code></pre></p>"},{"location":"skills/agentese-path/#6-returning-arrays-instead-of-single-values","title":"6. Returning arrays instead of single values","text":"<p>Symptom: Breaks composition pipelines.</p> <p>Fix: Return iterators or single values, never raw arrays (see Minimal Output Principle in spec).</p>"},{"location":"skills/agentese-path/#real-example-adding-selfsemaphore","title":"Real Example: Adding <code>self.semaphore.*</code>","text":"<p>The semaphore path was added in this order:</p> <ol> <li> <p>Affordances in <code>self_.py</code>:    <pre><code>\"semaphore\": (\"pending\", \"yield\", \"status\"),\n</code></pre></p> </li> <li> <p>SemaphoreNode class (100 lines) handling:</p> </li> <li><code>pending</code>: List pending semaphores</li> <li><code>yield</code>: Create new semaphore</li> <li> <p><code>status</code>: Get token status</p> </li> <li> <p>SelfContextResolver update:</p> </li> <li>Added <code>_purgatory: Any = None</code> field</li> <li>Added <code>_semaphore: SemaphoreNode | None = None</code> field</li> <li>Added case in <code>resolve()</code> method</li> <li> <p>Updated <code>__post_init__()</code> to create node</p> </li> <li> <p>Factory update in <code>create_self_resolver()</code>:</p> </li> <li>Added <code>purgatory</code> parameter</li> <li> <p>Wired to resolver</p> </li> <li> <p><code>__init__.py</code> updates:</p> </li> <li>Added <code>SemaphoreNode</code> import</li> <li>Added to <code>__all__</code></li> <li> <p>Updated <code>create_context_resolvers()</code> parameter</p> </li> <li> <p>Tests in <code>contexts/_tests/test_semaphore_paths.py</code> (700 lines)</p> </li> </ol>"},{"location":"skills/agentese-path/#related-skills","title":"Related Skills","text":"<ul> <li>cli-command - Adding CLI commands</li> <li>handler-patterns - Common handler patterns</li> <li>test-patterns - Testing patterns</li> <li>polynomial-agent - Operads and law checks</li> </ul>"},{"location":"skills/agentese-path/#changelog","title":"Changelog","text":"<ul> <li>2025-12-12: Initial version based on <code>self.semaphore.*</code> and <code>world.purgatory.*</code> implementations</li> <li>2025-12-13: Added forest handle appendix, clause micro-prompts, and law/role gates (doc-only)</li> </ul>"},{"location":"skills/agentese-repl/","title":"AGENTESE REPL: Developer Guide","text":"<p>\"The interface that teaches its own structure through use is no interface at all.\"</p> <p>The AGENTESE REPL transforms CLI interaction into liturgical navigation\u2014commands become invocations, exploration becomes discovery, and the ontology reveals itself through use.</p>"},{"location":"skills/agentese-repl/#table-of-contents","title":"Table of Contents","text":"<ol> <li>Getting Started</li> <li>The Five Contexts</li> <li>Observer Archetypes</li> <li>Pipeline Composition</li> <li>Starter Pack Implementations</li> <li>Meta-Cognition: Evolving Your Workflow</li> <li>Maintenance &amp; Extension Patterns</li> <li>Ideation Garden</li> </ol>"},{"location":"skills/agentese-repl/#getting-started","title":"Getting Started","text":""},{"location":"skills/agentese-repl/#launching-the-repl","title":"Launching the REPL","text":"<pre><code># Standard launch\nkg -i\n\n# With verbose output (shows stack traces on errors)\nkg -i --verbose\n\n# The REPL is also available via the full command\nkgents --interactive\n</code></pre>"},{"location":"skills/agentese-repl/#the-prompt-anatomy","title":"The Prompt Anatomy","text":"<pre><code>(E) [self.soul] \u00bb\n \u2502   \u2502    \u2502    \u2514\u2500\u2500 Invocation indicator\n \u2502   \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Current holon\n \u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Current context (colored by type)\n \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Observer archetype (E=explorer, D=developer, A=architect, *=admin)\n</code></pre>"},{"location":"skills/agentese-repl/#navigation-primitives","title":"Navigation Primitives","text":"Command Effect Example <code>&lt;context&gt;</code> Enter context <code>self</code>, <code>world</code>, <code>void</code> <code>&lt;holon&gt;</code> Navigate to holon (within context) <code>soul</code>, <code>agents</code>, <code>entropy</code> <code>..</code> Go up one level From <code>self.soul</code> \u2192 <code>self</code> <code>.</code> Show current path Displays <code>self.soul</code> <code>/</code> Return to root From anywhere \u2192 <code>[root]</code> <code>?</code> Show affordances What's available here? <code>??</code> Detailed help Deep documentation"},{"location":"skills/agentese-repl/#invocation-patterns","title":"Invocation Patterns","text":"<pre><code># Navigate then invoke\nself\nsoul\nreflect \"What should I focus on?\"\n\n# Direct invocation (space-separated)\nself soul reflect \"What should I focus on?\"\n\n# Dotted path invocation\nself.soul.reflect \"What should I focus on?\"\n\n# From any location, full path works\nworld.agents.list\n</code></pre>"},{"location":"skills/agentese-repl/#the-five-contexts","title":"The Five Contexts","text":"<p>The AGENTESE ontology organizes all operations into five contexts. Each context has its own color in the REPL prompt.</p>"},{"location":"skills/agentese-repl/#self-green-the-internal","title":"<code>self.*</code> (Green) \u2014 The Internal","text":"<p>Your agent's inner world: state, memory, soul, capabilities.</p> <pre><code>[self] \u00bb ?\n  status       System health at a glance\n  memory       Four Pillars memory health\n  dream        LucidDreamer morning briefing\n  soul         K-gent soul dialogue\n  capabilities What can I do?\n  dashboard    Real-time TUI dashboard\n</code></pre> <p>Key Patterns: - <code>self status</code> \u2014 Quick health check before starting work - <code>self soul reflect</code> \u2014 Mirror your current state - <code>self memory</code> \u2014 Check memory consolidation status - <code>self dashboard --demo</code> \u2014 Visual system overview</p>"},{"location":"skills/agentese-repl/#world-blue-the-external","title":"<code>world.*</code> (Blue) \u2014 The External","text":"<p>Agents, infrastructure, resources\u2014everything outside.</p> <pre><code>[world] \u00bb ?\n  agents       Agent operations (list, run, inspect)\n  daemon       Cortex daemon lifecycle\n  infra        K8s infrastructure operations\n  fixture      HotData fixtures\n  exec         Q-gent execution\n  dev          Live reload development\n  town         Agent Town simulation\n</code></pre> <p>Key Patterns: - <code>world agents list</code> \u2014 See registered agents - <code>world town step</code> \u2014 Advance Agent Town simulation - <code>world daemon status</code> \u2014 Check cortex health - <code>world infra status</code> \u2014 K8s cluster overview</p>"},{"location":"skills/agentese-repl/#concept-magenta-the-abstract","title":"<code>concept.*</code> (Magenta) \u2014 The Abstract","text":"<p>Laws, principles, dialectics\u2014pure ideas.</p> <pre><code>[concept] \u00bb ?\n  laws         Category laws (identity, associativity)\n  dialectic    Challenge and refine concepts\n  principle    Design principles\n  operad       Composition grammar\n</code></pre> <p>Key Patterns: - <code>concept laws verify</code> \u2014 Check category law compliance - <code>concept dialectic \"Is this approach sound?\"</code> \u2014 Challenge ideas - <code>concept principle list</code> \u2014 Review design principles</p>"},{"location":"skills/agentese-repl/#void-gray-the-accursed-share","title":"<code>void.*</code> (Gray) \u2014 The Accursed Share","text":"<p>Entropy, shadow, serendipity\u2014the creative unknown.</p> <pre><code>[void] \u00bb ?\n  entropy      Draw/return randomness\n  shadow       Jungian shadow analysis\n  serendipity  Request tangents\n  gratitude    Express thanks (tithe)\n  archetype    Archetypal patterns\n</code></pre> <p>Key Patterns: - <code>void entropy sip</code> \u2014 Draw from the Accursed Share - <code>void shadow</code> \u2014 Surface unconscious patterns - <code>void serendipity</code> \u2014 Request creative tangents - <code>void gratitude tithe \"Thank you for...\"</code> \u2014 Pay for order received</p>"},{"location":"skills/agentese-repl/#time-yellow-the-temporal","title":"<code>time.*</code> (Yellow) \u2014 The Temporal","text":"<p>Traces, history, forecasts\u2014temporal navigation.</p> <pre><code>[time] \u00bb ?\n  trace        View temporal traces\n  past         View past state\n  future       Forecast (probabilistic)\n  schedule     Schedule future actions\n  turn         Turn management\n</code></pre> <p>Key Patterns: - <code>time trace</code> \u2014 View execution history - <code>time past 1h</code> \u2014 State one hour ago - <code>time schedule \"review\" +24h</code> \u2014 Schedule future action</p>"},{"location":"skills/agentese-repl/#observer-archetypes","title":"Observer Archetypes","text":"<p>The REPL supports different observer archetypes that affect which affordances are visible and how the system responds.</p>"},{"location":"skills/agentese-repl/#switching-observers","title":"Switching Observers","text":"<pre><code>/observer              # Show current archetype\n/observer developer    # Switch to developer\n/observers             # List all archetypes\n</code></pre>"},{"location":"skills/agentese-repl/#available-archetypes","title":"Available Archetypes","text":"Archetype Prompt Description Affordances <code>explorer</code> (E) Curious newcomer <code>manifest</code>, <code>witness</code>, <code>affordances</code> <code>developer</code> (D) Skilled builder Above + <code>define</code>, technical details <code>architect</code> (A) System designer Above + structural, composition <code>admin</code> (*) Full access All affordances, including dangerous"},{"location":"skills/agentese-repl/#why-archetypes-matter","title":"Why Archetypes Matter","text":"<p>Different observers see different things. An <code>explorer</code> sees pedagogical affordances designed for learning. A <code>developer</code> sees implementation details. An <code>architect</code> sees structural relationships.</p> <pre><code># As explorer: see what's available for learning\n(E) [concept] \u00bb ?\n  laws, dialectic, principle, operad\n\n# Switch to architect: see compositional structure\n/observer architect\n(A) [concept] \u00bb ?\n  laws, dialectic, principle, operad\n  + compose, define, refine\n</code></pre> <p>This embodies the AGENTESE principle: there is no view from nowhere. Every observation is situated.</p>"},{"location":"skills/agentese-repl/#pipeline-composition","title":"Pipeline Composition","text":"<p>The <code>&gt;&gt;</code> operator composes paths into pipelines that execute sequentially.</p>"},{"location":"skills/agentese-repl/#basic-composition","title":"Basic Composition","text":"<pre><code># Execute self.status, then world.agents\nself status &gt;&gt; world agents\n\n# Output shows each step:\n# [1/2] self status\n# [CORTEX] ? CRITICAL | instance:... | ...\n#\n# [2/2] world agents\n# [A] Available Archetypes: ...\n</code></pre>"},{"location":"skills/agentese-repl/#pipeline-principles","title":"Pipeline Principles","text":"<ol> <li>Left-to-right execution \u2014 Each path runs in order</li> <li>Output passing \u2014 Results flow to next step (when supported)</li> <li>Graceful fallback \u2014 Uses CLI routing when Logos unavailable</li> <li>Full paths work \u2014 <code>world.agents.list &gt;&gt; concept.count</code></li> </ol>"},{"location":"skills/agentese-repl/#common-pipelines","title":"Common Pipelines","text":"<pre><code># Health check pipeline\nself status &gt;&gt; world daemon status &gt;&gt; world infra status\n\n# Agent Town workflow\nworld town step &gt;&gt; world town observe alice &gt;&gt; time trace\n\n# Memory consolidation check\nself memory &gt;&gt; self soul reflect \"How's my memory?\"\n</code></pre>"},{"location":"skills/agentese-repl/#future-true-composition","title":"Future: True Composition","text":"<p>When Logos integration deepens, pipelines will support true morphism composition:</p> <pre><code># Future: output of manifest becomes input to refine\nworld.document.manifest &gt;&gt; concept.summary.refine &gt;&gt; self.memory.engram\n</code></pre>"},{"location":"skills/agentese-repl/#starter-pack-implementations","title":"Starter Pack Implementations","text":""},{"location":"skills/agentese-repl/#morning-workflow","title":"Morning Workflow","text":"<p>Start your day with a system check and soul reflection:</p> <pre><code>kg -i\nself status                    # System health\nself memory                    # Memory consolidation\nself soul reflect \"What should I focus on today?\"\nvoid entropy sip               # Draw creative energy\nexit\n</code></pre>"},{"location":"skills/agentese-repl/#agent-development-workflow","title":"Agent Development Workflow","text":"<p>When building or debugging agents:</p> <pre><code>kg -i\n/observer developer            # Switch to dev mode\nworld agents list              # See available agents\nworld agents inspect MyAgent   # Deep inspection\nself soul challenge \"Is this architecture right?\"\nworld town step                # Test in simulation\ntime trace                     # Review execution\nexit\n</code></pre>"},{"location":"skills/agentese-repl/#exploration-workflow","title":"Exploration Workflow","text":"<p>When learning the system or onboarding:</p> <pre><code>kg -i\n/observer explorer             # Pedagogical mode\n?                              # What contexts exist?\nself                           # Enter self\n?                              # What holons here?\nsoul                           # Go deeper\n??                             # Detailed help\n..                             # Back up\nworld                          # Try another context\nexit\n</code></pre>"},{"location":"skills/agentese-repl/#debugging-workflow","title":"Debugging Workflow","text":"<p>When something goes wrong:</p> <pre><code>kg -i\n/observer admin                # Full access\nself status                    # Quick health check\ntime trace                     # Recent execution\nself memory                    # Memory health\nworld daemon logs              # Check daemon\nworld infra status             # Infrastructure\nexit\n</code></pre>"},{"location":"skills/agentese-repl/#meta-cognition-evolving-your-workflow","title":"Meta-Cognition: Evolving Your Workflow","text":""},{"location":"skills/agentese-repl/#the-repl-as-thought-partner","title":"The REPL as Thought Partner","text":"<p>The REPL isn't just a command interface\u2014it's a cognitive scaffold. The five contexts mirror aspects of cognition:</p> <ul> <li>self = Introspection, self-model</li> <li>world = Perception, action in environment</li> <li>concept = Abstract reasoning, principles</li> <li>void = Creativity, unconscious processing</li> <li>time = Memory, planning, temporal reasoning</li> </ul>"},{"location":"skills/agentese-repl/#workflow-evolution-stages","title":"Workflow Evolution Stages","text":"<p>Stage 1: Navigation Learn the contexts, use <code>?</code> liberally, build muscle memory for <code>.</code>, <code>..</code>, <code>/</code>.</p> <p>Stage 2: Invocation Start invoking aspects directly. Learn the difference between navigating (<code>soul</code>) and invoking (<code>soul reflect</code>).</p> <p>Stage 3: Composition Build pipelines. Chain operations. Think in morphisms.</p> <p>Stage 4: Observer Fluency Switch archetypes fluidly. Use <code>explorer</code> for learning, <code>developer</code> for building, <code>architect</code> for designing.</p> <p>Stage 5: Ambient Use The REPL becomes a persistent companion. You think in AGENTESE paths even outside the REPL.</p>"},{"location":"skills/agentese-repl/#integration-patterns","title":"Integration Patterns","text":"<p>Terminal Multiplexing: Keep a REPL session in a dedicated tmux/screen pane. Quick checks without leaving your editor.</p> <p>IDE Integration: Future: REPL as VS Code/Cursor extension. Invoke paths from editor.</p> <p>Voice Interface: Future: Voice-to-REPL for hands-free interaction.</p>"},{"location":"skills/agentese-repl/#the-liturgical-mindset","title":"The Liturgical Mindset","text":"<p>Approach the REPL liturgically: - Commands are invocations, not queries - You're grasping handles, not accessing data - Results are manifestations specific to your observer - Composition is ritual, building meaning through structure</p>"},{"location":"skills/agentese-repl/#maintenance-extension-patterns","title":"Maintenance &amp; Extension Patterns","text":""},{"location":"skills/agentese-repl/#adding-a-new-holon","title":"Adding a New Holon","text":"<p>To add a holon to a context:</p> <ol> <li>Update the context router (<code>protocols/cli/contexts/&lt;context&gt;.py</code>):</li> </ol> <pre><code>def _register_holons(self) -&gt; None:\n    self.register(\n        \"myholon\",\n        \"Description of my holon\",\n        _handle_myholon,\n        aspects=[\"manifest\", \"witness\", \"myaspect\"],\n    )\n\ndef _handle_myholon(args: list[str], ctx: InvocationContext | None = None) -&gt; int:\n    # Implementation\n    pass\n</code></pre> <ol> <li>Update REPL holon list (<code>protocols/cli/repl.py</code>):</li> </ol> <pre><code>CONTEXT_HOLONS = {\n    \"self\": [\"status\", \"memory\", ..., \"myholon\"],\n    ...\n}\n</code></pre> <ol> <li>Update context help in <code>_show_detailed_help()</code>.</li> </ol>"},{"location":"skills/agentese-repl/#adding-a-new-aspect","title":"Adding a New Aspect","text":"<p>Aspects are verbs that can be invoked on holons. To add one:</p> <ol> <li>Add to holon registration (the <code>aspects</code> list)</li> <li>Handle in the holon handler (switch on aspect name)</li> <li>Update Logos resolver if using Logos routing</li> </ol>"},{"location":"skills/agentese-repl/#adding-a-new-observer-archetype","title":"Adding a New Observer Archetype","text":"<pre><code># In protocols/cli/repl.py\nOBSERVER_ARCHETYPES = {\n    ...\n    \"scientist\": \"Hypothesis-driven, sees experimental affordances\",\n}\n</code></pre> <p>Consider what affordances this archetype should see and update the DNA capabilities in <code>ReplState.get_umwelt()</code>.</p>"},{"location":"skills/agentese-repl/#testing-repl-changes","title":"Testing REPL Changes","text":"<pre><code># Quick smoke test\necho -e \"?\\nself\\n?\\nexit\" | python -m protocols.cli.repl\n\n# Full CLI test suite\nuv run pytest protocols/cli/ -q\n\n# Type checking\nuv run mypy protocols/cli/repl.py --ignore-missing-imports\n</code></pre>"},{"location":"skills/agentese-repl/#ideation-garden","title":"Ideation Garden","text":"<p>These are evergreen ideas for extending the REPL. Pick one when entropy allows.</p>"},{"location":"skills/agentese-repl/#near-term-extensions","title":"Near-Term Extensions","text":"Idea Complexity Value Notes Fuzzy matching M High Typo tolerance: <code>slef</code> \u2192 \"Did you mean <code>self</code>?\" Session persistence S Medium Resume from last location Bookmark paths S Medium <code>/bookmark soul</code> \u2192 <code>/goto soul</code> Alias system S High <code>alias s=\"self status\"</code> History search S Medium Ctrl+R fuzzy search through history"},{"location":"skills/agentese-repl/#medium-term-extensions","title":"Medium-Term Extensions","text":"Idea Complexity Value Notes Tutorial mode M High <code>kg -i --tutorial</code> guided walkthrough LLM suggestions L High \"Did you mean...\" with semantic understanding Auto-complete from registry M High Dynamic completion from Logos Result caching M Medium <code>$_</code> = last result, <code>$1</code> = result 1 back Script mode M High <code>kg -i &lt; script.repl</code> for automation"},{"location":"skills/agentese-repl/#long-term-visions","title":"Long-Term Visions","text":"Idea Complexity Value Notes REPL-as-TUI L High Evolve into Textual app with panels Voice REPL L Medium Voice input for accessibility Web REPL L Medium Browser-based exploration Multiplayer REPL XL High Shared session, collaborative exploration REPL Notebooks L High Jupyter-style cells with AGENTESE"},{"location":"skills/agentese-repl/#conceptual-extensions","title":"Conceptual Extensions","text":"<p>Observer Algebra: What if observers could be composed? <code>explorer &gt;&gt; developer</code> = sees both pedagogical and technical.</p> <p>Temporal REPL: Navigate not just space (contexts) but time. <code>[self.soul@-1h]</code> = soul state one hour ago.</p> <p>Hypothetical Worlds: <code>/fork</code> creates a hypothetical branch. Explore \"what if\" without affecting real state.</p> <p>Meta-REPL: The REPL that operates on the REPL. <code>meta.repl.extend \"new-holon\"</code> adds holons at runtime.</p>"},{"location":"skills/agentese-repl/#quick-reference-card","title":"Quick Reference Card","text":"<pre><code>NAVIGATION\n  &lt;context&gt;     Enter context (self, world, concept, void, time)\n  &lt;holon&gt;       Navigate to holon\n  ..            Go up\n  .             Show path\n  /             Go to root\n\nINTROSPECTION\n  ?             Show affordances\n  ??            Detailed help\n  help          Full help\n\nINVOCATION\n  &lt;path&gt;        Invoke manifest aspect\n  &lt;path&gt; &lt;asp&gt;  Invoke specific aspect\n  path &gt;&gt; path  Compose and execute pipeline\n\nOBSERVER\n  /observer              Show current\n  /observer &lt;archetype&gt;  Switch (explorer, developer, architect, admin)\n  /observers             List all\n\nMETA\n  exit, quit, q  Leave REPL\n  clear          Clear screen\n  history        Show command history\n  Ctrl+C         Interrupt (doesn't exit)\n</code></pre>"},{"location":"skills/agentese-repl/#philosophy","title":"Philosophy","text":"<p>The AGENTESE REPL embodies several core principles:</p> <ol> <li>No View From Nowhere \u2014 Every command is situated in an observer context</li> <li>Verb-First Ontology \u2014 Paths are invocations, not queries</li> <li>Graceful Degradation \u2014 Works even when subsystems are offline</li> <li>Pedagogical Interface \u2014 The structure teaches itself through use</li> <li>Compositional Thinking \u2014 <code>&gt;&gt;</code> makes composition first-class</li> <li>Joy-Inducing \u2014 Warmth and personality in every interaction</li> </ol> <p>The REPL is not just a tool\u2014it's a way of thinking about agent-world interaction.</p> <p>\"The noun is a lie. There is only the rate of change.\"</p>"},{"location":"skills/building-agent/","title":"Skill: Building an Agent","text":"<p>Create a well-formed agent that composes via functors and integrates with AGENTESE protocols.</p> <p>Difficulty: Medium Prerequisites: Understanding of Agent[A, B] protocol, composition laws, AGENTESE paths Files Touched: <code>impl/claude/agents/&lt;letter&gt;/</code>, <code>impl/claude/protocols/agentese/</code>, tests References: <code>docs/impl-guide.md</code>, <code>spec/principles.md</code></p>"},{"location":"skills/building-agent/#overview","title":"Overview","text":"<p>An agent in kgents is a morphism A \u2192 B in the category of agents. Building an agent well means:</p> <ol> <li>Defining clear input/output types (A and B)</li> <li>Implementing the Agent protocol (name, invoke)</li> <li>Composing linearly via <code>&gt;&gt;</code> and functors</li> <li>Integrating with AGENTESE paths where appropriate</li> <li>Writing specification-faithful tests</li> </ol> <p>This skill synthesizes patterns from recently developed agents (Flux, Semaphores, Creativity) and the design principles.</p>"},{"location":"skills/building-agent/#when-to-use-polynomial-agents-instead","title":"When to Use Polynomial Agents Instead","text":"<p>If your agent needs mode-dependent behavior\u2014different inputs/outputs based on internal state\u2014use a Polynomial Agent instead of <code>Agent[A, B]</code>.</p> Scenario Use <code>Agent[A, B]</code> Use <code>PolyAgent[S, A, B]</code> Stateless transform \u2713 \u2713 (overkill) State machine \u2717 \u2713 Protocol phases \u2717 \u2713 Mode-dependent I/O \u2717 \u2713 <p>See: <code>docs/skills/polynomial-agent.md</code> for the polynomial agent skill guide.</p>"},{"location":"skills/building-agent/#the-agent-protocol","title":"The Agent Protocol","text":"<p>Every agent implements the base protocol from <code>bootstrap/types.py</code>:</p> <pre><code>from bootstrap.types import Agent\nfrom typing import TypeVar\n\nA = TypeVar(\"A\")\nB = TypeVar(\"B\")\n\nclass MyAgent(Agent[A, B]):\n    \"\"\"One-line description of agent purpose.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"my-agent\"\n\n    async def invoke(self, input: A) -&gt; B:\n        # Transform input to output\n        return result\n</code></pre>"},{"location":"skills/building-agent/#category-laws-required","title":"Category Laws (Required)","text":"<p>Your agent MUST satisfy these laws:</p> Law Requirement How to Verify Identity <code>Id &gt;&gt; f \u2261 f \u2261 f &gt;&gt; Id</code> Test composition with Id agent Associativity <code>(f &gt;&gt; g) &gt;&gt; h \u2261 f &gt;&gt; (g &gt;&gt; h)</code> Test reordering doesn't change output <p>Implication: Any agent that breaks these laws is NOT a valid agent.</p>"},{"location":"skills/building-agent/#step-by-step-creating-an-agent","title":"Step-by-Step: Creating an Agent","text":""},{"location":"skills/building-agent/#step-1-define-domain-types","title":"Step 1: Define Domain Types","text":"<p>Start with clear input/output types. Use dataclasses for structured data.</p> <p>File: <code>impl/claude/agents/&lt;letter&gt;/types.py</code> (or inline if simple)</p> <pre><code>from __future__ import annotations\nfrom dataclasses import dataclass, field\nfrom typing import Generic, TypeVar\n\n@dataclass(frozen=True)\nclass MyInput:\n    \"\"\"Input to MyAgent. Frozen = immutable.\"\"\"\n    content: str\n    context: dict[str, str] = field(default_factory=dict)\n\n@dataclass\nclass MyOutput:\n    \"\"\"Output from MyAgent.\"\"\"\n    result: str\n    confidence: float\n    metadata: dict[str, str] = field(default_factory=dict)\n</code></pre> <p>Best Practice: Use <code>frozen=True</code> for inputs (immutability), regular dataclasses for outputs that may be enriched downstream.</p>"},{"location":"skills/building-agent/#step-2-implement-the-agent","title":"Step 2: Implement the Agent","text":"<p>File: <code>impl/claude/agents/&lt;letter&gt;/agent.py</code></p> <pre><code>\"\"\"\nMyAgent: Brief description of purpose.\n\nLonger description of what this agent does and why.\n\"\"\"\n\nfrom __future__ import annotations\nfrom dataclasses import dataclass, field\nfrom typing import TYPE_CHECKING\n\nfrom bootstrap.types import Agent\n\nif TYPE_CHECKING:\n    # Heavy imports only for type hints\n    from some_module import HeavyType\n\nfrom .types import MyInput, MyOutput\n\n\n@dataclass\nclass MyAgent(Agent[MyInput, MyOutput]):\n    \"\"\"\n    Description of the agent.\n\n    Example:\n        &gt;&gt;&gt; agent = MyAgent(config=MyConfig())\n        &gt;&gt;&gt; result = await agent.invoke(MyInput(content=\"test\"))\n    \"\"\"\n\n    # Configuration (immutable after construction)\n    config: MyConfig = field(default_factory=MyConfig)\n\n    # Runtime state (private, mutable)\n    _initialized: bool = field(default=False, init=False)\n\n    def __post_init__(self) -&gt; None:\n        \"\"\"Initialize runtime state.\"\"\"\n        self._validate_config()\n        self._initialized = True\n\n    @property\n    def name(self) -&gt; str:\n        return \"my-agent\"\n\n    async def invoke(self, input: MyInput) -&gt; MyOutput:\n        \"\"\"\n        Transform input to output.\n\n        Args:\n            input: The input to process\n\n        Returns:\n            Transformed output\n\n        Raises:\n            ValueError: If input is invalid\n        \"\"\"\n        # 1. Validate\n        self._validate_input(input)\n\n        # 2. Transform\n        result = await self._process(input)\n\n        # 3. Return\n        return MyOutput(\n            result=result,\n            confidence=1.0,\n        )\n\n    # \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    # Private Methods\n    # \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n    def _validate_config(self) -&gt; None:\n        \"\"\"Validate configuration.\"\"\"\n        if self.config.threshold &lt; 0:\n            raise ValueError(\"threshold must be non-negative\")\n\n    def _validate_input(self, input: MyInput) -&gt; None:\n        \"\"\"Validate input.\"\"\"\n        if not input.content:\n            raise ValueError(\"content cannot be empty\")\n\n    async def _process(self, input: MyInput) -&gt; str:\n        \"\"\"Core processing logic.\"\"\"\n        return f\"processed: {input.content}\"\n</code></pre>"},{"location":"skills/building-agent/#step-3-add-composition-support","title":"Step 3: Add Composition Support","text":"<p>Agents compose via <code>&gt;&gt;</code>. The base class provides this, but you may want:</p> <p>1. Pipe operator for FluxAgents (<code>|</code>):</p> <pre><code>def __or__(self, other: \"FluxAgent[B, C]\") -&gt; \"FluxPipeline[A, C]\":\n    \"\"\"Pipe operator for Living Pipelines.\"\"\"\n    from .pipeline import FluxPipeline\n    return FluxPipeline([self, other])\n</code></pre> <p>2. Functor lifting (transform agent behavior):</p> <pre><code>from agents.flux.functor import Flux\n\n# Lift to streaming domain\nflux_agent = Flux.lift(my_agent)\n\n# Lift with config\nflux_agent = Flux.lift(my_agent, FluxConfig(entropy_budget=2.0))\n</code></pre> <p>3. Integration methods (attach external systems):</p> <pre><code>def attach_metabolism(self, metabolism: \"FluxMetabolism[A, B]\") -&gt; None:\n    \"\"\"Attach metabolic adapter for resource tracking.\"\"\"\n    self._metabolism = metabolism\n\ndef detach_metabolism(self) -&gt; None:\n    \"\"\"Detach metabolic adapter.\"\"\"\n    self._metabolism = None\n</code></pre>"},{"location":"skills/building-agent/#step-4-integrate-with-agentese-optional","title":"Step 4: Integrate with AGENTESE (Optional)","text":"<p>If your agent provides semantic affordances, register AGENTESE paths.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <pre><code># In the appropriate context (self_, world, concept, void, time)\n\nasync def my_affordance_manifest(\n    self,\n    observer: Umwelt,\n    logos: \"Logos\",\n    **kwargs: Any,\n) -&gt; Any:\n    \"\"\"\n    world.myentity.manifest \u2014 Perceive entity through observer's lens.\n\n    Different observers see different projections:\n    - architect: sees structure\n    - poet: sees metaphor\n    - economist: sees value\n    \"\"\"\n    # Get the entity\n    entity = await self._get_entity(kwargs.get(\"entity_id\"))\n\n    # Project through observer's lens\n    projection = await logos.project(entity, observer)\n\n    return projection\n</code></pre> <p>AGENTESE Path Patterns:</p> Context Purpose Example Paths <code>world.*</code> External entities, tools <code>world.document.manifest</code>, <code>world.purgatory.resolve</code> <code>self.*</code> Internal state, memory <code>self.memory.engram</code>, <code>self.judgment.critique</code> <code>concept.*</code> Abstract platonics <code>concept.blend.forge</code>, <code>concept.summary.refine</code> <code>void.*</code> Entropy, accursed share <code>void.pataphysics.solve</code>, <code>void.entropy.sip</code> <code>time.*</code> Temporal traces <code>time.trace.witness</code>, <code>time.semaphore.deadline</code>"},{"location":"skills/building-agent/#step-5-write-tests","title":"Step 5: Write Tests","text":"<p>File: <code>impl/claude/agents/&lt;letter&gt;/_tests/test_agent.py</code></p> <pre><code>\"\"\"\nTests for MyAgent.\n\nTest Categories (T-gent Types I-V):\n- Type I: Contracts (preconditions, postconditions)\n- Type II: Saboteurs (property-based, fuzzing)\n- Type III: Spies (behavior verification)\n- Type IV: Judges (semantic assertions)\n- Type V: Witnesses (integration, round-trip)\n\"\"\"\n\nfrom __future__ import annotations\n\nimport pytest\n\nfrom ..agent import MyAgent\nfrom ..types import MyConfig, MyInput, MyOutput\n\n\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Type I: Contract Tests\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\nclass TestMyAgentContracts:\n    \"\"\"Test agent satisfies contracts.\"\"\"\n\n    @pytest.fixture\n    def agent(self) -&gt; MyAgent:\n        \"\"\"Create test agent.\"\"\"\n        return MyAgent(config=MyConfig())\n\n    async def test_name_is_stable(self, agent: MyAgent) -&gt; None:\n        \"\"\"Agent name should be stable.\"\"\"\n        assert agent.name == \"my-agent\"\n        assert agent.name == agent.name  # Idempotent\n\n    async def test_invoke_returns_output_type(self, agent: MyAgent) -&gt; None:\n        \"\"\"Invoke should return correct type.\"\"\"\n        result = await agent.invoke(MyInput(content=\"test\"))\n        assert isinstance(result, MyOutput)\n\n    async def test_empty_input_rejected(self, agent: MyAgent) -&gt; None:\n        \"\"\"Empty input should raise ValueError.\"\"\"\n        with pytest.raises(ValueError, match=\"cannot be empty\"):\n            await agent.invoke(MyInput(content=\"\"))\n\n\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Type II: Saboteur Tests (Property-Based)\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\nclass TestMyAgentProperties:\n    \"\"\"Property-based tests for invariants.\"\"\"\n\n    @pytest.mark.parametrize(\"content\", [\"a\", \"ab\", \"a\" * 100, \"unicode: \\u2603\"])\n    async def test_any_nonempty_string_accepted(self, content: str) -&gt; None:\n        \"\"\"Any non-empty string should be processable.\"\"\"\n        agent = MyAgent()\n        result = await agent.invoke(MyInput(content=content))\n        assert result.result  # Non-empty output\n\n\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Type V: Witness Tests (Integration)\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\nclass TestMyAgentComposition:\n    \"\"\"Test composition with other agents.\"\"\"\n\n    async def test_identity_law_left(self) -&gt; None:\n        \"\"\"Id &gt;&gt; f \u2261 f.\"\"\"\n        from bootstrap.id import Id\n\n        agent = MyAgent()\n        composed = Id() &gt;&gt; agent\n        input_data = MyInput(content=\"test\")\n\n        direct = await agent.invoke(input_data)\n        via_id = await composed.invoke(input_data)\n\n        assert direct.result == via_id.result\n\n    async def test_identity_law_right(self) -&gt; None:\n        \"\"\"f &gt;&gt; Id \u2261 f.\"\"\"\n        from bootstrap.id import Id\n\n        agent = MyAgent()\n        composed = agent &gt;&gt; Id()\n        input_data = MyInput(content=\"test\")\n\n        direct = await agent.invoke(input_data)\n        via_id = await composed.invoke(input_data)\n\n        assert direct.result == via_id.result\n</code></pre>"},{"location":"skills/building-agent/#functor-catalog","title":"Functor Catalog","text":"<p>These functors linearly modify agent behavior while preserving composition:</p> Functor Signature Purpose File Flux <code>Agent[A,B] \u2192 Agent[Flux[A],Flux[B]]</code> Discrete \u2192 Streaming <code>agents/flux/functor.py</code> Observer <code>Agent[A,B] \u2192 Agent[A,B]</code> Add observation hooks <code>agents/o/observer.py</code> Metered <code>Agent[A,B] \u2192 Agent[A,B]</code> Token budget tracking <code>agents/b/metered_functor.py</code> K <code>Agent[A,B] \u2192 Agent[A,B]</code> Personality navigation <code>agents/k/functor.py</code> Symbiont <code>Agent[A,B] \u00d7 D \u2192 Agent[A,B]</code> Pure logic + D-gent state <code>agents/d/symbiont.py</code>"},{"location":"skills/building-agent/#using-functors","title":"Using Functors","text":"<pre><code>from agents.flux.functor import Flux\nfrom agents.o.observer import ObserverFunctor\nfrom agents.b.metered_functor import MeteredFunctor\n\n# Chain functors (order matters!)\nagent = MyAgent()\nobserved = ObserverFunctor(agent, callbacks=[on_before, on_after])\nmetered = MeteredFunctor(observed, budget=1000)\nflux = Flux.lift(metered)\n\n# Or compose the lifts\npipeline = (\n    Flux.lift(MyAgent())\n    | Flux.lift(AnotherAgent())\n)\n</code></pre>"},{"location":"skills/building-agent/#protocols-for-integration","title":"Protocols for Integration","text":"Protocol Purpose Integration Point Metabolism Resource tracking (entropy, temperature) <code>attach_metabolism()</code> Mirror Observability (Terrarium TUI) <code>attach_mirror()</code> Purgatory Human-in-the-loop (semaphores) <code>attach_purgatory()</code> SemanticField Stigmergic communication (pheromones) <code>field.emit()</code>, <code>field.sense()</code>"},{"location":"skills/building-agent/#example-semaphore-integration-rodizio-pattern","title":"Example: Semaphore Integration (Rodizio Pattern)","text":"<pre><code>from agents.flux.semaphore import SemaphoreToken, SemaphoreReason\n\nclass MyAgent(Agent[MyInput, MyOutput]):\n    async def invoke(self, input: MyInput) -&gt; MyOutput | SemaphoreToken:\n        \"\"\"May yield control to human.\"\"\"\n        if self._needs_human_review(input):\n            # Return red card (Rodizio pattern)\n            return SemaphoreToken.create(\n                reason=SemaphoreReason.APPROVAL_NEEDED,\n                prompt=\"Review this content before proceeding\",\n                frozen_state=self._freeze_state(),\n            )\n        return await self._process(input)\n\n    async def resume(\n        self,\n        frozen_state: bytes,\n        human_input: str,\n    ) -&gt; MyOutput:\n        \"\"\"Resume after human provides input.\"\"\"\n        state = self._thaw_state(frozen_state)\n        return await self._process_with_human_input(state, human_input)\n</code></pre>"},{"location":"skills/building-agent/#anti-patterns-to-avoid","title":"Anti-Patterns to Avoid","text":""},{"location":"skills/building-agent/#1-breaking-composition-laws","title":"1. Breaking Composition Laws","text":"<pre><code># BAD: Agent with hidden state that breaks associativity\nclass BadAgent(Agent[A, B]):\n    counter = 0  # Shared mutable state!\n\n    async def invoke(self, input: A) -&gt; B:\n        BadAgent.counter += 1  # Side effect changes composition behavior\n        ...\n</code></pre>"},{"location":"skills/building-agent/#2-monolithic-agents","title":"2. Monolithic Agents","text":"<pre><code># BAD: God agent that does everything\nclass GodAgent(Agent[Any, Any]):\n    async def invoke(self, input: Any) -&gt; Any:\n        if input.type == \"summarize\": ...\n        elif input.type == \"translate\": ...\n        elif input.type == \"analyze\": ...\n        # Kitchen sink!\n</code></pre> <p>Better: Compose smaller, focused agents.</p>"},{"location":"skills/building-agent/#3-llm-agents-returning-arrays","title":"3. LLM Agents Returning Arrays","text":"<pre><code># BAD: LLM prompted to return array\nclass BadLLMAgent(Agent[Document, list[Improvement]]):\n    async def invoke(self, doc: Document) -&gt; list[Improvement]:\n        # Prompt: \"List all improvements\"\n        ...\n\n# GOOD: LLM returns single output, call N times\nclass GoodLLMAgent(Agent[tuple[Document, Hypothesis], Improvement]):\n    async def invoke(self, input: tuple[Document, Hypothesis]) -&gt; Improvement:\n        # Prompt: \"Evaluate this specific hypothesis\"\n        ...\n</code></pre>"},{"location":"skills/building-agent/#4-blocking-in-async-context","title":"4. Blocking in Async Context","text":"<pre><code># BAD: Blocking call in async method\nasync def invoke(self, input: A) -&gt; B:\n    result = requests.get(url)  # BLOCKS!\n    ...\n\n# GOOD: Use async HTTP\nasync def invoke(self, input: A) -&gt; B:\n    async with aiohttp.ClientSession() as session:\n        async with session.get(url) as resp:\n            ...\n</code></pre>"},{"location":"skills/building-agent/#5-heavy-module-level-imports","title":"5. Heavy Module-Level Imports","text":"<pre><code># BAD: Imported at module load\nfrom heavy_ml_library import model  # 500ms import time\n\n# GOOD: Lazy import\nasync def invoke(self, input: A) -&gt; B:\n    from heavy_ml_library import model  # Only when needed\n    ...\n</code></pre>"},{"location":"skills/building-agent/#llm-backed-agents","title":"LLM-Backed Agents","text":"<p>For agents that invoke LLMs, use the <code>LLMAgent</code> base class from <code>runtime/</code>:</p>"},{"location":"skills/building-agent/#the-llmagent-protocol","title":"The LLMAgent Protocol","text":"<pre><code>from runtime import LLMAgent, AgentContext, AgentResult\n\nclass MySummarizer(LLMAgent[Document, Summary]):\n    \"\"\"\n    Summarize documents using an LLM.\n\n    LLMAgent extends Agent with:\n    - build_prompt(input) \u2192 AgentContext: Convert input to LLM prompt\n    - parse_response(str) \u2192 output: Parse LLM text to structured output\n    \"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"summarizer\"\n\n    async def invoke(self, input: Document) -&gt; Summary:\n        \"\"\"Not used directly - runtime.execute() handles this.\"\"\"\n        raise NotImplementedError(\"Use runtime.execute()\")\n\n    def build_prompt(self, input: Document) -&gt; AgentContext:\n        \"\"\"Convert input to LLM context.\"\"\"\n        return AgentContext(\n            system_prompt=\"You are a precise summarization assistant.\",\n            messages=[{\n                \"role\": \"user\",\n                \"content\": f\"Summarize this document:\\n\\n{input.content}\"\n            }],\n            temperature=0.3,  # Lower for factual tasks\n            max_tokens=1024,\n        )\n\n    def parse_response(self, response: str) -&gt; Summary:\n        \"\"\"Parse LLM response to output type.\"\"\"\n        from runtime import robust_json_parse\n        data = robust_json_parse(response)\n        return Summary(\n            content=data[\"summary\"],\n            key_points=data.get(\"key_points\", []),\n        )\n</code></pre>"},{"location":"skills/building-agent/#agentcontext-fields","title":"AgentContext Fields","text":"Field Type Purpose <code>system_prompt</code> <code>str</code> System message defining agent behavior <code>messages</code> <code>list[dict]</code> Conversation history (role: user/assistant) <code>temperature</code> <code>float</code> Creativity (0.0-1.0, default 0.7) <code>max_tokens</code> <code>int</code> Output limit (default 4096) <code>facts</code> <code>dict | None</code> Grounded facts for RAG patterns <code>metadata</code> <code>dict | None</code> Arbitrary execution metadata"},{"location":"skills/building-agent/#runtimes","title":"Runtimes","text":"<p>Execute LLMAgents via runtimes:</p> <pre><code>from runtime import ClaudeCLIRuntime, ClaudeRuntime, OpenRouterRuntime\n\n# Via Claude Code CLI (uses OAuth, no API key needed)\nruntime = ClaudeCLIRuntime()\n\n# Via Claude API (requires ANTHROPIC_API_KEY)\nruntime = ClaudeRuntime(api_key=os.environ[\"ANTHROPIC_API_KEY\"])\n\n# Via OpenRouter (requires OPENROUTER_API_KEY)\nruntime = OpenRouterRuntime(model=\"anthropic/claude-3.5-sonnet\")\n\n# Execute\nresult: AgentResult[Summary] = await runtime.execute(summarizer, document)\nprint(result.output)  # Summary dataclass\nprint(result.usage)   # {\"input_tokens\": ..., \"output_tokens\": ..., ...}\n</code></pre>"},{"location":"skills/building-agent/#robust-json-parsing","title":"Robust JSON Parsing","text":"<p>LLM responses often have formatting issues. Use <code>robust_json_parse</code>:</p> <pre><code>from runtime import robust_json_parse, parse_structured_sections\n\ndef parse_response(self, response: str) -&gt; MyOutput:\n    \"\"\"\n    robust_json_parse handles:\n    - Markdown code blocks (```json ... ```)\n    - Truncated JSON (auto-closes brackets)\n    - Trailing commas\n    - Extra text before/after JSON\n    \"\"\"\n    data = robust_json_parse(response, allow_partial=True)\n    return MyOutput(**data)\n\n# Or for section-based responses:\ndef parse_response(self, response: str) -&gt; MyOutput:\n    \"\"\"\n    Parse structured sections:\n    RESPONSES:\n    1. First response\n    2. Second response\n\n    FOLLOW-UPS:\n    - Question one?\n    \"\"\"\n    sections = parse_structured_sections(\n        response,\n        [\"responses\", \"follow-ups\"]\n    )\n    return MyOutput(\n        responses=sections.get(\"responses\", []),\n        follow_ups=sections.get(\"follow-ups\", []),\n    )\n</code></pre>"},{"location":"skills/building-agent/#retry-and-error-handling","title":"Retry and Error Handling","text":"<p><code>ClaudeCLIRuntime</code> implements the Fix pattern for retry:</p> <pre><code>runtime = ClaudeCLIRuntime(\n    max_retries=3,           # Retry on parse failures\n    enable_coercion=True,    # Use AI to coerce malformed responses\n    coercion_confidence=0.9, # Minimum confidence for coerced response\n)\n\n# Error types for retry classification:\n# - TransientError: Rate limits, timeouts \u2192 retry with backoff\n# - PermanentError: Auth, invalid input \u2192 fast fail\n# - ParseError: Malformed output \u2192 retry with feedback\n</code></pre>"},{"location":"skills/building-agent/#async-composition","title":"Async Composition","text":"<p>LLMAgents compose asynchronously:</p> <pre><code>from runtime.base import parallel_execute\n\n# Sequential composition\npipeline = extract_facts.then_async(summarize).then_async(format_output)\nresult = await pipeline.execute_async(document, runtime)\n\n# Parallel execution (for I/O-bound LLM calls)\nresults = await parallel_execute(\n    agents=[summarize_agent] * len(documents),\n    inputs=documents,\n    runtime=runtime,\n)\n</code></pre>"},{"location":"skills/building-agent/#llmagent-best-practices","title":"LLMAgent Best Practices","text":"<ol> <li> <p>Single output per invoke (Minimal Output Principle):    <pre><code># BAD: Ask LLM to return array\n\"List all improvements for this code\"\n\n# GOOD: Call N times with specific hypotheses\n\"Evaluate whether this specific change would improve readability\"\n</code></pre></p> </li> <li> <p>Low temperature for factual tasks:    <pre><code>AgentContext(temperature=0.1)  # For extraction, parsing\nAgentContext(temperature=0.7)  # For creative generation\n</code></pre></p> </li> <li> <p>Structured output hints in system prompt:    <pre><code>system_prompt = \"\"\"You are a code analyzer.\n\nOUTPUT FORMAT (JSON):\n{\n    \"issue\": \"description of the issue\",\n    \"severity\": \"low|medium|high\",\n    \"suggestion\": \"how to fix it\"\n}\n\"\"\"\n</code></pre></p> </li> <li> <p>Graceful parse failures:    <pre><code>def parse_response(self, response: str) -&gt; MyOutput:\n    try:\n        data = robust_json_parse(response)\n    except ValueError:\n        # Fallback: extract what we can\n        return MyOutput(\n            content=response[:500],\n            confidence=0.0,  # Mark as low confidence\n        )\n</code></pre></p> </li> </ol>"},{"location":"skills/building-agent/#verification-checklist","title":"Verification Checklist","text":"<p>Before considering your agent complete:</p>"},{"location":"skills/building-agent/#all-agents","title":"All Agents","text":"<ul> <li> <code>Agent[A, B]</code> protocol implemented (name, invoke)</li> <li> Input/output types are clear dataclasses</li> <li> Category laws verified (identity, associativity)</li> <li> Tests cover contracts, properties, and composition</li> <li> No module-level heavy imports (Hollow Shell pattern)</li> <li> No blocking calls in async methods</li> <li> Follows Minimal Output Principle (single output per invoke)</li> <li> Integrates with relevant protocols (Metabolism, Mirror, etc.)</li> <li> AGENTESE paths registered if providing semantic affordances</li> <li> Mypy strict passes (<code>uv run mypy .</code>)</li> <li> Ruff passes (<code>uv run ruff check</code>)</li> </ul>"},{"location":"skills/building-agent/#llmagent-specific","title":"LLMAgent-Specific","text":"<ul> <li> <code>build_prompt()</code> returns well-formed <code>AgentContext</code></li> <li> <code>parse_response()</code> uses <code>robust_json_parse</code> for JSON outputs</li> <li> System prompt includes explicit output format</li> <li> Temperature set appropriately (low for factual, higher for creative)</li> <li> Error handling for malformed LLM responses</li> <li> Tests mock the runtime (don't call real LLMs in unit tests)</li> </ul>"},{"location":"skills/building-agent/#d-gent-memory-patterns","title":"D-gent Memory Patterns","text":"<p>Agents needing durable state use D-gent patterns. Choose based on access patterns:</p>"},{"location":"skills/building-agent/#pattern-selection-guide","title":"Pattern Selection Guide","text":"Pattern Use Case Files Symbiont Pure logic + stateful memory <code>agents/d/symbiont.py</code> Bicameral Relational + vector (semantic search) <code>agents/d/bicameral.py</code> StoreComonad Event-sourced with time-travel <code>agents/d/context_comonad.py</code> LinearityMap Resource tracking for context compression <code>agents/d/linearity.py</code>"},{"location":"skills/building-agent/#symbiont-pattern-simplest","title":"Symbiont Pattern (Simplest)","text":"<p>The Symbiont fuses stateless logic with stateful memory. Your logic is pure; D-gent handles persistence.</p> <pre><code>from agents.d import Symbiont, VolatileAgent\n\n# 1. Define pure logic: (Input, State) \u2192 (Output, NewState)\ndef chat_logic(msg: str, history: list) -&gt; tuple[str, list]:\n    history.append((\"user\", msg))\n    response = f\"Echo: {msg}\"\n    history.append((\"bot\", response))\n    return response, history\n\n# 2. Create D-gent for persistence (Volatile = in-memory)\nmemory = VolatileAgent(_state=[])\n\n# 3. Fuse into Symbiont (valid Agent, composes via &gt;&gt;)\nchatbot = Symbiont(logic=chat_logic, memory=memory)\n\n# 4. Use like any agent\nresult = await chatbot.invoke(\"Hello\")  # Returns \"Echo: Hello\"\n</code></pre> <p>Key Insight: Logic is testable without mocks (pure function). Memory is swappable (volatile \u2192 SQLite \u2192 Redis).</p>"},{"location":"skills/building-agent/#bicameral-memory-semantic-search","title":"Bicameral Memory (Semantic Search)","text":"<p>For agents needing both exact queries AND semantic similarity:</p> <pre><code>from agents.d import BicameralMemory, BicameralConfig\n\n# Create with Left (relational) + Right (vector) hemispheres\nbicameral = BicameralMemory(\n    left_hemisphere=relational_store,   # Source of truth (ACID)\n    right_hemisphere=vector_store,      # Semantic index\n    embedding_provider=embedder,\n    config=BicameralConfig(\n        auto_heal_ghosts=True,          # Auto-delete stale vectors\n        coherency_check_on_recall=True, # Validate on every recall\n    ),\n)\n\n# Store (writes to both hemispheres)\nawait bicameral.store(\"insight-001\", {\n    \"type\": \"insight\",\n    \"content\": \"Category theory unifies all D-gent patterns\",\n})\n\n# Semantic recall (validates against relational)\nresults = await bicameral.recall(\"category theory patterns\")\n# \u2192 Ghost memories auto-healed, stale embeddings flagged\n\n# Direct fetch (bypasses vector, for known IDs)\ndata = await bicameral.fetch(\"insight-001\")\n\n# Health check\nreport = await bicameral.coherency_check()\nprint(f\"Coherency rate: {report.coherency_rate:.1%}\")\n</code></pre> <p>Ghost Memory Problem: Vector entry points to deleted relational row \u2192 hallucination. Solution: Coherency Protocol validates on recall, auto-heals ghosts.</p>"},{"location":"skills/building-agent/#storecomonad-event-sourcing-with-time-travel","title":"StoreComonad (Event Sourcing with Time Travel)","text":"<p>For agents needing full history and replay:</p> <pre><code>from agents.d import StoreComonad, create_ledger_store\nfrom pathlib import Path\n\n# Create event-sourced store\nstore = create_ledger_store(\n    persistence_path=Path(\"~/.kgents/ledger.jsonl\").expanduser()\n)\n\n# Append events (immutable history)\nstore.append({\n    \"event_type\": \"CREDIT\",\n    \"agent\": \"b-gent\",\n    \"amount\": 0.1,\n})\n\n# Extract current state (comonad extract)\nbalances = store.extract()  # {\"b-gent\": 0.6}\n\n# Time-travel: state at any position\nhistorical_balances = store.replay_to(position=5)\n\n# Track value over time (comonad extend)\ndef agent_balance(s: StoreComonad) -&gt; float:\n    return s.extract().get(\"b-gent\", 0.0)\n\nhistory = store.extend(agent_balance)  # [0.5, 0.6, 0.55, ...]\n\n# Get all snapshots (comonad duplicate)\nsnapshots = store.duplicate()  # Full zipper over history\n</code></pre> <p>Comonad Laws: <code>extract . duplicate = id</code>, <code>fmap extract . duplicate = id</code>.</p>"},{"location":"skills/building-agent/#linearitymap-resource-tracking","title":"LinearityMap (Resource Tracking)","text":"<p>For context compression\u2014track which resources can be dropped:</p> <pre><code>from agents.d import LinearityMap, ResourceClass\n\nlm = LinearityMap()\n\n# Tag resources by class\nobs_id = lm.tag(\n    \"user clicked button\",\n    ResourceClass.DROPPABLE,  # Can be discarded\n    provenance=\"ui_event\",\n)\n\ndec_id = lm.tag(\n    \"chose option A\",\n    ResourceClass.REQUIRED,   # Must flow to output\n    provenance=\"decision\",\n)\n\nfocus_id = lm.tag(\n    \"critical user instruction\",\n    ResourceClass.PRESERVED,  # Must survive verbatim\n    provenance=\"user_input\",\n)\n\n# Query what can be dropped\ndroppable_ids = lm.droppable()\n\n# Promote (one-way, enforces monotonicity)\nlm.promote(obs_id, ResourceClass.REQUIRED, \"became decision-relevant\")\n\n# Bulk drop droppables (for context compression)\ndropped_count = lm.drop_all_droppable()\n\n# Partition for summarization\npartition = lm.partition()\n# {DROPPABLE: [...], REQUIRED: [...], PRESERVED: [...]}\n</code></pre> <p>Resource Classes (partial order: DROPPABLE &lt; REQUIRED &lt; PRESERVED): - DROPPABLE: Observations, intermediate computations - REQUIRED: Reasoning traces, decisions - PRESERVED: User inputs, code blocks (verbatim)</p>"},{"location":"skills/building-agent/#related-skills","title":"Related Skills","text":"<ul> <li>cli-command - Exposing agent via CLI</li> <li>agentese-path - Registering AGENTESE paths</li> <li>flux-agent - Creating streaming agents</li> <li>test-patterns - T-gent Types I-V testing</li> <li>agent-observability - Metrics, mirrors, pheromones</li> </ul>"},{"location":"skills/building-agent/#changelog","title":"Changelog","text":"<ul> <li>2025-12-12: Added D-gent memory patterns (Symbiont, Bicameral, StoreComonad, LinearityMap)</li> <li>2025-12-12: Added LLMAgent section with runtime patterns, JSON parsing, and best practices</li> <li>2025-12-12: Initial version synthesizing patterns from Flux, Semaphores, Creativity</li> </ul>"},{"location":"skills/cli-command/","title":"Skill: Adding a CLI Command","text":"<p>Add a new command to the kgents CLI with proper lazy-loading, help text, and dual-channel output.</p> <p>Difficulty: Easy Prerequisites: Python basics, understanding of the Hollow Shell pattern Files Touched: <code>protocols/cli/handlers/&lt;name&gt;.py</code>, <code>protocols/cli/hollow.py</code> Time: ~15 minutes</p>"},{"location":"skills/cli-command/#overview","title":"Overview","text":"<p>The kgents CLI uses the Hollow Shell pattern for fast startup: - Commands are registered by module path (not imported at startup) - Only the invoked command's module is imported - Target: <code>kgents --help</code> &lt; 50ms</p> <p>When adding a new command, you need to: 1. Create a handler file in <code>protocols/cli/handlers/</code> 2. Register the command in <code>hollow.py</code> 3. Optionally add to the help text</p>"},{"location":"skills/cli-command/#step-by-step","title":"Step-by-Step","text":""},{"location":"skills/cli-command/#step-1-create-the-handler-file","title":"Step 1: Create the Handler File","text":"<p>Create a new file at <code>impl/claude/protocols/cli/handlers/&lt;command&gt;.py</code>.</p> <p>File: <code>impl/claude/protocols/cli/handlers/&lt;command&gt;.py</code></p> <p>Template: <pre><code>\"\"\"\n&lt;Command&gt; Handler: Brief description.\n\nDetailed description of what this command does and why.\n\nUsage:\n    kgents &lt;command&gt;              # Default action\n    kgents &lt;command&gt; subcommand   # Specific action\n    kgents &lt;command&gt; --help       # Show help\n\nExample:\n    kgents &lt;command&gt; action \"some argument\"\n\"\"\"\n\nfrom __future__ import annotations\n\nimport asyncio\nfrom typing import TYPE_CHECKING, Any\n\nif TYPE_CHECKING:\n    from protocols.cli.reflector import InvocationContext\n\n\ndef _print_help() -&gt; None:\n    \"\"\"Print help for &lt;command&gt; command.\"\"\"\n    print(__doc__)\n    print()\n    print(\"SUBCOMMANDS:\")\n    print(\"  action1           Description of action1\")\n    print(\"  action2           Description of action2\")\n    print()\n    print(\"OPTIONS:\")\n    print(\"  --flag            Description of flag\")\n    print(\"  --json            Output as JSON\")\n    print(\"  --help, -h        Show this help\")\n\n\ndef cmd_&lt;command&gt;(args: list[str], ctx: \"InvocationContext | None\" = None) -&gt; int:\n    \"\"\"\n    Main entry point for the &lt;command&gt; command.\n\n    Args:\n        args: Command-line arguments (after the command name)\n        ctx: Optional InvocationContext for dual-channel output\n\n    Returns:\n        Exit code (0 for success, non-zero for error)\n    \"\"\"\n    # Get context from hollow.py if not provided\n    if ctx is None:\n        try:\n            from protocols.cli.hollow import get_invocation_context\n            ctx = get_invocation_context(\"&lt;command&gt;\", args)\n        except ImportError:\n            pass\n\n    # Handle --help flag\n    if \"--help\" in args or \"-h\" in args:\n        _print_help()\n        return 0\n\n    # Parse flags\n    json_mode = \"--json\" in args\n\n    # Get subcommand\n    subcommand = None\n    subcommand_args: list[str] = []\n\n    for arg in args:\n        if arg.startswith(\"-\"):\n            continue\n        if subcommand is None:\n            subcommand = arg\n        else:\n            subcommand_args.append(arg)\n\n    # Default subcommand\n    if subcommand is None:\n        subcommand = \"default\"\n\n    # Run async handler\n    return asyncio.run(\n        _async_&lt;command&gt;(\n            subcommand=subcommand,\n            subcommand_args=subcommand_args,\n            json_mode=json_mode,\n            ctx=ctx,\n        )\n    )\n\n\nasync def _async_&lt;command&gt;(\n    subcommand: str,\n    subcommand_args: list[str],\n    json_mode: bool,\n    ctx: \"InvocationContext | None\",\n) -&gt; int:\n    \"\"\"Async implementation of &lt;command&gt; command.\"\"\"\n    try:\n        match subcommand:\n            case \"action1\":\n                return await _handle_action1(subcommand_args, json_mode, ctx)\n            case \"action2\":\n                return await _handle_action2(subcommand_args, json_mode, ctx)\n            case \"default\":\n                return await _handle_default(json_mode, ctx)\n            case _:\n                _emit_output(\n                    f\"[&lt;COMMAND&gt;] X Unknown subcommand: {subcommand}\",\n                    {\"error\": f\"Unknown subcommand: {subcommand}\"},\n                    ctx,\n                )\n                return 1\n\n    except ImportError as e:\n        _emit_output(\n            f\"[&lt;COMMAND&gt;] X Module not available: {e}\",\n            {\"error\": f\"Module not available: {e}\"},\n            ctx,\n        )\n        return 1\n\n    except Exception as e:\n        _emit_output(\n            f\"[&lt;COMMAND&gt;] X Error: {e}\",\n            {\"error\": str(e)},\n            ctx,\n        )\n        return 1\n\n\nasync def _handle_default(\n    json_mode: bool,\n    ctx: \"InvocationContext | None\",\n) -&gt; int:\n    \"\"\"Handle default action.\"\"\"\n    result = {\"status\": \"ok\", \"message\": \"Default action completed\"}\n\n    if json_mode:\n        import json\n        _emit_output(json.dumps(result, indent=2), result, ctx)\n    else:\n        _emit_output(\"[&lt;COMMAND&gt;] Default action completed\", result, ctx)\n\n    return 0\n\n\nasync def _handle_action1(\n    args: list[str],\n    json_mode: bool,\n    ctx: \"InvocationContext | None\",\n) -&gt; int:\n    \"\"\"Handle action1 subcommand.\"\"\"\n    # Implementation here\n    return 0\n\n\nasync def _handle_action2(\n    args: list[str],\n    json_mode: bool,\n    ctx: \"InvocationContext | None\",\n) -&gt; int:\n    \"\"\"Handle action2 subcommand.\"\"\"\n    # Implementation here\n    return 0\n\n\ndef _emit_output(\n    human: str,\n    semantic: dict[str, Any],\n    ctx: \"InvocationContext | None\",\n) -&gt; None:\n    \"\"\"\n    Emit output via dual-channel if ctx available, else print.\n\n    This is the key integration point with the Reflector Protocol:\n    - Human output goes to stdout (for humans)\n    - Semantic output goes to FD3 (for agents consuming our output)\n    \"\"\"\n    if ctx is not None:\n        ctx.output(human=human, semantic=semantic)\n    else:\n        print(human)\n</code></pre></p>"},{"location":"skills/cli-command/#step-2-register-in-command_registry","title":"Step 2: Register in COMMAND_REGISTRY","text":"<p>\u26a0\ufe0f CRITICAL: This step is REQUIRED. Without it, your command will not work!</p> <p>Creating a handler file is not enough. The command MUST be registered in <code>COMMAND_REGISTRY</code> or you'll get \"Unknown command\" errors. This is the most common mistake when adding CLI commands.</p> <p>Add the command to the registry in <code>hollow.py</code>.</p> <p>File: <code>impl/claude/protocols/cli/hollow.py</code></p> <p>Location: Find the <code>COMMAND_REGISTRY</code> dict (around line 110)</p> <p>Pattern: <pre><code>COMMAND_REGISTRY: dict[str, str] = {\n    # ... existing commands ...\n\n    # &lt;Category&gt; (Brief description)\n    \"&lt;command&gt;\": \"protocols.cli.handlers.&lt;command&gt;:cmd_&lt;command&gt;\",\n}\n</code></pre></p> <p>Format: <code>\"command_name\": \"module.path:function_name\"</code></p> <ul> <li><code>command_name</code>: What the user types (e.g., <code>kgents soul</code>)</li> <li><code>module.path</code>: Python import path to the handler module</li> <li><code>function_name</code>: The <code>cmd_*</code> function to call</li> </ul> <p>Example (adding <code>soul</code> command): <pre><code>COMMAND_REGISTRY: dict[str, str] = {\n    # ... existing commands ...\n\n    # K-gent Soul (Digital Simulacra)\n    \"soul\": \"protocols.cli.handlers.soul:cmd_soul\",\n}\n</code></pre></p> <p>Example (adding <code>meta</code> and <code>operad</code> commands): <pre><code>COMMAND_REGISTRY: dict[str, str] = {\n    # ... existing commands ...\n\n    # Meta-Construction (Poly/Operad/Sheaf)\n    \"operad\": \"protocols.cli.handlers.operad:cmd_operad\",\n    \"meta\": \"protocols.cli.handlers.meta:cmd_meta\",\n}\n</code></pre></p>"},{"location":"skills/cli-command/#step-3-update-help_text-optional-but-recommended","title":"Step 3: Update HELP_TEXT (Optional but Recommended)","text":"<p>Add the command to the help text so users can discover it.</p> <p>File: <code>impl/claude/protocols/cli/hollow.py</code></p> <p>Location: Find the <code>HELP_TEXT</code> string (around line 40)</p> <p>Pattern: <pre><code>HELP_TEXT = \"\"\"\\\nkgents - Kent's Agents CLI\n\nUSAGE:\n  kgents &lt;command&gt; [args...]\n\n# ... existing sections ...\n\n&lt;SECTION NAME&gt;:\n  &lt;command&gt;   Brief description of what it does\n\n# ... rest of help ...\n\"\"\"\n</code></pre></p> <p>Example: <pre><code>SOUL (Digital Simulacra):\n  soul      K-gent self-dialogue (reflect|advise|challenge|explore)\n</code></pre></p>"},{"location":"skills/cli-command/#step-4-add-aliases-optional","title":"Step 4: Add Aliases (Optional)","text":"<p>For frequently-used subcommands, you can add top-level aliases.</p> <p>In the handler file, add alias functions: <pre><code>def cmd_alias1(args: list[str], ctx: \"InvocationContext | None\" = None) -&gt; int:\n    \"\"\"Alias: kgents alias1 -&gt; kgents &lt;command&gt; subcommand.\"\"\"\n    return cmd_&lt;command&gt;([\"subcommand\"] + args, ctx)\n</code></pre></p> <p>In hollow.py, register the aliases: <pre><code>COMMAND_REGISTRY: dict[str, str] = {\n    # ... main command ...\n    \"&lt;command&gt;\": \"protocols.cli.handlers.&lt;command&gt;:cmd_&lt;command&gt;\",\n\n    # Aliases (top-level shortcuts)\n    \"alias1\": \"protocols.cli.handlers.&lt;command&gt;:cmd_alias1\",\n}\n</code></pre></p>"},{"location":"skills/cli-command/#step-5-update-handlersinitpy-optional","title":"Step 5: Update handlers/init.py (Optional)","text":"<p>Document the new handler in the package docstring.</p> <p>File: <code>impl/claude/protocols/cli/handlers/__init__.py</code></p> <p>Pattern: <pre><code>\"\"\"\nCLI Handlers - Lazy-loaded command implementations.\n\nStructure:\n- ... existing handlers ...\n- &lt;command&gt;.py: Brief description\n\"\"\"\n</code></pre></p>"},{"location":"skills/cli-command/#verification","title":"Verification","text":""},{"location":"skills/cli-command/#test-1-help-displays-correctly","title":"Test 1: Help displays correctly","text":"<pre><code>uv run python -m protocols.cli.hollow &lt;command&gt; --help\n</code></pre> <p>Expected: Your command's help text appears.</p>"},{"location":"skills/cli-command/#test-2-command-executes","title":"Test 2: Command executes","text":"<pre><code>uv run python -m protocols.cli.hollow &lt;command&gt;\n</code></pre> <p>Expected: Default action runs without error.</p>"},{"location":"skills/cli-command/#test-3-json-output-works","title":"Test 3: JSON output works","text":"<pre><code>uv run python -m protocols.cli.hollow &lt;command&gt; --json\n</code></pre> <p>Expected: JSON output appears.</p>"},{"location":"skills/cli-command/#test-4-appears-in-main-help","title":"Test 4: Appears in main help","text":"<pre><code>uv run python -m protocols.cli.hollow --help | grep &lt;command&gt;\n</code></pre> <p>Expected: Your command appears in the help listing.</p>"},{"location":"skills/cli-command/#troubleshooting","title":"Troubleshooting","text":""},{"location":"skills/cli-command/#unknown-command","title":"\"Unknown command: \" <p>Problem: You created a handler file but the command doesn't work.</p> <p>Cause: The command is not registered in <code>COMMAND_REGISTRY</code>.</p> <p>Solution: Add the registration to <code>impl/claude/protocols/cli/hollow.py</code>: <pre><code>COMMAND_REGISTRY: dict[str, str] = {\n    # ... existing commands ...\n    \"&lt;command&gt;\": \"protocols.cli.handlers.&lt;command&gt;:cmd_&lt;command&gt;\",\n}\n</code></pre></p> <p>Checklist: 1. \u2705 Handler file exists at <code>impl/claude/protocols/cli/handlers/&lt;command&gt;.py</code> 2. \u2705 Handler has <code>cmd_&lt;command&gt;</code> function 3. \u2705 Command is registered in <code>COMMAND_REGISTRY</code> \u2190 Most common miss! 4. \u2705 No typos in module path or function name</p>","text":""},{"location":"skills/cli-command/#error-loading-command-no-module-named","title":"\"Error loading command '': No module named...\" <p>Problem: Command is registered but can't be imported.</p> <p>Cause: Module path in <code>COMMAND_REGISTRY</code> is wrong.</p> <p>Solution: Check the module path matches your file location: - File: <code>impl/claude/protocols/cli/handlers/foo.py</code> - Registry: <code>\"foo\": \"protocols.cli.handlers.foo:cmd_foo\"</code></p>","text":""},{"location":"skills/cli-command/#command-doesnt-appear-in-kgents-help","title":"Command doesn't appear in <code>kgents --help</code> <p>Problem: Command works but isn't discoverable.</p> <p>Cause: Not added to <code>HELP_TEXT</code>.</p> <p>Solution: Add to the <code>HELP_TEXT</code> string in <code>hollow.py</code> (see Step 3).</p>","text":""},{"location":"skills/cli-command/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/cli-command/#1-importing-at-module-level","title":"1. Importing at module level <p>Wrong: <pre><code>from agents.heavy_module import SomeThing  # Imported at load time!\n\ndef cmd_foo(args):\n    ...\n</code></pre></p> <p>Right: <pre><code>def cmd_foo(args):\n    from agents.heavy_module import SomeThing  # Imported only when called\n    ...\n</code></pre></p> <p>The Hollow Shell pattern requires lazy imports. Module-level imports slow down <code>kgents --help</code>.</p>","text":""},{"location":"skills/cli-command/#2-forgetting-the-ctx-parameter","title":"2. Forgetting the ctx parameter <p>Wrong: <pre><code>def cmd_foo(args: list[str]) -&gt; int:\n    ...\n</code></pre></p> <p>Right: <pre><code>def cmd_foo(args: list[str], ctx: \"InvocationContext | None\" = None) -&gt; int:\n    ...\n</code></pre></p> <p>The <code>ctx</code> parameter enables dual-channel output for agent consumption.</p>","text":""},{"location":"skills/cli-command/#3-not-using-_emit_output","title":"3. Not using _emit_output <p>Wrong: <pre><code>print(f\"[FOO] Done\")\n</code></pre></p> <p>Right: <pre><code>_emit_output(\n    \"[FOO] Done\",\n    {\"status\": \"done\"},\n    ctx,\n)\n</code></pre></p> <p><code>_emit_output</code> sends both human-readable and machine-readable output.</p>","text":""},{"location":"skills/cli-command/#4-blocking-the-event-loop","title":"4. Blocking the event loop <p>Wrong: <pre><code>def cmd_foo(args):\n    result = await some_async_function()  # Can't await in sync function!\n</code></pre></p> <p>Right: <pre><code>def cmd_foo(args):\n    return asyncio.run(_async_foo(args))\n\nasync def _async_foo(args):\n    result = await some_async_function()\n</code></pre></p> <p>Use <code>asyncio.run()</code> to bridge sync entry point to async implementation.</p>","text":""},{"location":"skills/cli-command/#5-hardcoding-error-messages","title":"5. Hardcoding error messages <p>Wrong: <pre><code>print(\"Error: Something went wrong\")\nreturn 1\n</code></pre></p> <p>Right: <pre><code>_emit_output(\n    \"[FOO] X Something went wrong\",\n    {\"error\": \"Something went wrong\"},\n    ctx,\n)\nreturn 1\n</code></pre></p> <p>The <code>X</code> prefix and semantic error dict enable proper error handling.</p>","text":""},{"location":"skills/cli-command/#real-examples","title":"Real Examples","text":""},{"location":"skills/cli-command/#example-1-the-soul-command","title":"Example 1: The <code>soul</code> Command <p>Here's how the <code>soul</code> command was implemented:</p> <ol> <li>Handler: <code>impl/claude/protocols/cli/handlers/soul.py</code> (503 lines)</li> <li>Registration in <code>hollow.py</code>:    <pre><code>\"soul\": \"protocols.cli.handlers.soul:cmd_soul\",\n\"reflect\": \"protocols.cli.handlers.soul:cmd_reflect\",\n\"advise\": \"protocols.cli.handlers.soul:cmd_advise\",\n\"challenge\": \"protocols.cli.handlers.soul:cmd_challenge\",\n\"explore\": \"protocols.cli.handlers.soul:cmd_explore\",\n</code></pre></li> <li>Help text:    <pre><code>SOUL (Digital Simulacra):\n  soul      K-gent self-dialogue (reflect|advise|challenge|explore)\n</code></pre></li> </ol>","text":""},{"location":"skills/cli-command/#example-2-the-meta-and-operad-commands","title":"Example 2: The <code>meta</code> and <code>operad</code> Commands <p>These commands visualize the meta-construction machinery:</p> <ol> <li>Handlers:</li> <li><code>impl/claude/protocols/cli/handlers/meta.py</code> (~250 lines)</li> <li> <p><code>impl/claude/protocols/cli/handlers/operad.py</code> (~300 lines)</p> </li> <li> <p>Registration in <code>hollow.py</code>:    <pre><code># Meta-Construction (Poly/Operad/Sheaf)\n\"operad\": \"protocols.cli.handlers.operad:cmd_operad\",\n\"meta\": \"protocols.cli.handlers.meta:cmd_meta\",\n</code></pre></p> </li> <li> <p>Help text:    <pre><code>META-CONSTRUCTION (Generative Machinery):\n  meta      Meta-construction health (primitives, operads, sheaves)\n  operad    Operad CLI (list, compose operations)\n</code></pre></p> </li> <li> <p>Usage:    <pre><code>kgents meta                    # Health overview\nkgents meta soul               # KENT_SOUL visualization\nkgents operad list             # List all operads\nkgents operad soul vibe        # Execute soul vibe check\n</code></pre></p> </li> </ol>","text":""},{"location":"skills/cli-command/#related-skills","title":"Related Skills","text":"<ul> <li>agentese-path - Adding AGENTESE paths (future)</li> <li>handler-patterns - Common handler patterns (future)</li> </ul>"},{"location":"skills/cli-command/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added CRITICAL warning about COMMAND_REGISTRY, Troubleshooting section, <code>meta</code>/<code>operad</code> examples</li> <li>2025-12-12: Initial version based on <code>soul</code> command implementation</li> </ul>"},{"location":"skills/defensive-component-lifecycle/","title":"Defensive Component Lifecycle","text":"<p>Patterns for robust React component error handling, loading states, and graceful degradation in the Agent Town webapp.</p>"},{"location":"skills/defensive-component-lifecycle/#core-components","title":"Core Components","text":""},{"location":"skills/defensive-component-lifecycle/#error-boundary","title":"Error Boundary","text":"<p>Catch render errors in the component tree with automatic reset on route changes.</p> <pre><code>// src/components/error/ErrorBoundary.tsx\n\n// Wrap at app level with route-based reset\nimport { useLocation } from 'react-router-dom';\nimport { ErrorBoundary } from '@/components/error/ErrorBoundary';\n\nfunction App() {\n  const location = useLocation();\n\n  return (\n    &lt;ErrorBoundary resetKeys={[location.pathname]}&gt;\n      &lt;Routes&gt;...&lt;/Routes&gt;\n    &lt;/ErrorBoundary&gt;\n  );\n}\n\n// Wrap specific sections with custom fallback\n&lt;ErrorBoundary\n  fallback={&lt;CustomError /&gt;}\n  onError={(error, info) =&gt; logToTelemetry(error)}\n&gt;\n  &lt;RiskyComponent /&gt;\n&lt;/ErrorBoundary&gt;\n</code></pre> <p>Key Props: - <code>resetKeys</code>: Array of values that trigger reset when changed (e.g., route path) - <code>fallback</code>: Custom fallback UI (defaults to ElasticPlaceholder) - <code>onError</code>: Callback for logging/telemetry</p>"},{"location":"skills/defensive-component-lifecycle/#useasyncstate-hook","title":"useAsyncState Hook","text":"<p>Eliminate loading/error/data boilerplate.</p> <pre><code>// src/hooks/useAsyncState.ts\n\nconst { state, execute, setData, setError, reset } = useAsyncState&lt;Town&gt;({\n  onSuccess: (data) =&gt; console.log('Loaded:', data),\n  onError: (error) =&gt; showError('Load failed', error),\n});\n\n// Execute async operation\nuseEffect(() =&gt; {\n  execute(townApi.get(townId));\n}, [townId, execute]);\n\n// Render based on state\nif (state.isLoading) return &lt;Loading /&gt;;\nif (state.error) return &lt;Error message={state.error} /&gt;;\nif (state.data) return &lt;Town data={state.data} /&gt;;\n</code></pre> <p>State Shape: <pre><code>interface AsyncState&lt;T&gt; {\n  data: T | null;\n  isLoading: boolean;\n  error: string | null;\n  status: 'idle' | 'loading' | 'success' | 'error';\n}\n</code></pre></p> <p>Features: - Automatic request cancellation (stale requests ignored) - Axios-style error extraction (<code>response.data.detail</code>) - Callbacks for success/error - Manual <code>setData</code>/<code>setError</code> for optimistic updates</p>"},{"location":"skills/defensive-component-lifecycle/#toast-notifications","title":"Toast Notifications","text":"<p>Non-blocking notifications using existing uiStore infrastructure.</p> <pre><code>// Anywhere in app\nimport { showSuccess, showError, showInfo } from '@/stores/uiStore';\n\nshowSuccess('Town created!', 'Your new town is ready.');\nshowError('Connection lost', 'Check your internet');\nshowInfo('Tip', 'Click a citizen to see details');\n\n// ToastContainer renders in Layout.tsx automatically\n</code></pre> <p>Toast Types: | Type | Emoji | Duration | Use Case | |------|-------|----------|----------| | <code>info</code> | \ud83d\udca1 | 3s | Tips, hints | | <code>success</code> | \u2705 | 3s | Completed actions | | <code>warning</code> | \u26a0\ufe0f | 5s | Non-blocking issues | | <code>error</code> | \ud83d\udeab | 5s | Failures, errors |</p>"},{"location":"skills/defensive-component-lifecycle/#useonlinestatus-hook","title":"useOnlineStatus Hook","text":"<p>Track browser connectivity with automatic toast notifications.</p> <pre><code>// src/hooks/useOnlineStatus.ts\n\nfunction Layout() {\n  const isOnline = useOnlineStatus();\n\n  return (\n    &lt;div&gt;\n      {!isOnline &amp;&amp; &lt;OfflineBanner /&gt;}\n      &lt;main&gt;{children}&lt;/main&gt;\n    &lt;/div&gt;\n  );\n}\n</code></pre> <p>Automatically shows: - \"Back Online\" info toast when connectivity restored - \"Offline\" error toast when connection lost</p>"},{"location":"skills/defensive-component-lifecycle/#integration-points","title":"Integration Points","text":""},{"location":"skills/defensive-component-lifecycle/#apptsx","title":"App.tsx","text":"<pre><code>import { ErrorBoundary } from './components/error/ErrorBoundary';\nimport { useLocation } from 'react-router-dom';\n\nfunction App() {\n  const location = useLocation();\n\n  return (\n    &lt;ErrorBoundary resetKeys={[location.pathname]}&gt;\n      &lt;Suspense fallback={&lt;LoadingFallback /&gt;}&gt;\n        &lt;Routes&gt;\n          {/* routes */}\n          &lt;Route path=\"*\" element={&lt;NotFound /&gt;} /&gt;\n        &lt;/Routes&gt;\n      &lt;/Suspense&gt;\n    &lt;/ErrorBoundary&gt;\n  );\n}\n</code></pre>"},{"location":"skills/defensive-component-lifecycle/#layouttsx","title":"Layout.tsx","text":"<pre><code>import { ToastContainer } from '@/components/feedback/ToastContainer';\nimport { useOnlineStatus } from '@/hooks/useOnlineStatus';\n\nfunction Layout() {\n  useOnlineStatus(); // Shows toasts on connectivity changes\n\n  return (\n    &lt;div&gt;\n      {/* layout content */}\n      &lt;ToastContainer /&gt;\n    &lt;/div&gt;\n  );\n}\n</code></pre>"},{"location":"skills/defensive-component-lifecycle/#critical-insights","title":"Critical Insights","text":""},{"location":"skills/defensive-component-lifecycle/#error-boundary-placement","title":"Error Boundary Placement","text":"<ol> <li>App-level: Wrap entire app with route-based reset</li> <li>Feature-level: Wrap risky sections (dynamic imports, external data)</li> <li>Never in loops: Each boundary is expensive</li> </ol>"},{"location":"skills/defensive-component-lifecycle/#stale-closure-prevention","title":"Stale Closure Prevention","text":"<p>useAsyncState uses request ID tracking instead of AbortController:</p> <pre><code>// Each execute() increments requestIdRef\n// Results only applied if requestId matches current\nconst currentRequestId = ++requestIdRef.current;\n// ... await promise ...\nif (currentRequestId !== requestIdRef.current) {\n  return null; // Stale request, ignore\n}\n</code></pre>"},{"location":"skills/defensive-component-lifecycle/#toast-vs-inline-errors","title":"Toast vs Inline Errors","text":"Scenario Use Toast Use Inline Background operation failed \u2713 Form validation error \u2713 API call failed (retryable) \u2713 Page load failed \u2713 Success confirmation \u2713 Missing required data \u2713"},{"location":"skills/defensive-component-lifecycle/#elasticplaceholder-integration","title":"ElasticPlaceholder Integration","text":"<p>Error boundaries use ElasticPlaceholder for consistent error UI:</p> <pre><code>// ErrorBoundary default fallback\n&lt;ElasticPlaceholder\n  state=\"error\"\n  error={this.state.error?.message}\n  onRetry={this.reset}\n/&gt;\n</code></pre> <p>ElasticPlaceholder recognizes error types: - <code>NETWORK_ERROR</code> \u2192 \ud83c\udf10 \"Lost connection\" - <code>NOT_FOUND</code> / <code>404</code> \u2192 \ud83d\udd0d \"Nothing here\" - <code>RATE_LIMITED</code> / <code>429</code> \u2192 \ud83d\udc22 \"Slow down\" - <code>SERVER_ERROR</code> / <code>500</code> \u2192 \ud83d\udd27 \"Something went sideways\"</p>"},{"location":"skills/defensive-component-lifecycle/#file-structure","title":"File Structure","text":"<pre><code>src/\n\u251c\u2500\u2500 components/\n\u2502   \u251c\u2500\u2500 error/\n\u2502   \u2502   \u251c\u2500\u2500 ErrorBoundary.tsx    # React error boundary\n\u2502   \u2502   \u2514\u2500\u2500 index.ts\n\u2502   \u251c\u2500\u2500 feedback/\n\u2502   \u2502   \u251c\u2500\u2500 Toast.tsx            # Individual toast\n\u2502   \u2502   \u251c\u2500\u2500 ToastContainer.tsx   # Renders from uiStore\n\u2502   \u2502   \u2514\u2500\u2500 index.ts\n\u2502   \u2514\u2500\u2500 elastic/\n\u2502       \u2514\u2500\u2500 ElasticPlaceholder.tsx  # Loading/empty/error states\n\u251c\u2500\u2500 hooks/\n\u2502   \u251c\u2500\u2500 useAsyncState.ts         # Async state management\n\u2502   \u2514\u2500\u2500 useOnlineStatus.ts       # Connectivity tracking\n\u251c\u2500\u2500 pages/\n\u2502   \u2514\u2500\u2500 NotFound.tsx             # 404 page\n\u2514\u2500\u2500 stores/\n    \u2514\u2500\u2500 uiStore.ts               # notifications[], showError(), etc.\n</code></pre>"},{"location":"skills/defensive-component-lifecycle/#testing-patterns","title":"Testing Patterns","text":""},{"location":"skills/defensive-component-lifecycle/#error-boundary-tests","title":"Error Boundary Tests","text":"<pre><code>// Component that throws for testing\nfunction ThrowingComponent({ shouldThrow }: { shouldThrow?: boolean }): ReactElement {\n  if (shouldThrow) throw new Error('Test error');\n  return &lt;div&gt;Content&lt;/div&gt;;\n}\n\n// Suppress console.error in tests\nbeforeEach(() =&gt; {\n  console.error = vi.fn();\n});\n</code></pre>"},{"location":"skills/defensive-component-lifecycle/#useasyncstate-tests","title":"useAsyncState Tests","text":"<pre><code>// Test stale request handling\nact(() =&gt; { result.current.execute(slowPromise1); });\nact(() =&gt; { result.current.execute(slowPromise2); }); // Invalidates first\nawait act(async () =&gt; { resolve1('first'); }); // Ignored\nexpect(result.current.state.isLoading).toBe(true); // Still waiting for second\n</code></pre>"},{"location":"skills/defensive-component-lifecycle/#toast-tests","title":"Toast Tests","text":"<pre><code>// Test auto-dismiss\nvi.useFakeTimers();\nrender(&lt;Toast notification={{ duration: 3000, ... }} onDismiss={mock} /&gt;);\nact(() =&gt; vi.advanceTimersByTime(3000));\nexpect(mock).toHaveBeenCalled();\n</code></pre>"},{"location":"skills/defensive-component-lifecycle/#anti-patterns","title":"Anti-Patterns","text":"<pre><code>\u274c Swallowing errors silently\n\u2713 Always surface to user or logs\n\n\u274c Missing loading states\n\u2713 Show skeleton/spinner during async ops\n\n\u274c Error boundary inside render loop\n\u2713 Place boundaries at route/feature level\n\n\u274c Toasts for everything\n\u2713 Toast for non-blocking, inline for blocking\n\n\u274c Manual try/catch in every component\n\u2713 Use useAsyncState or ErrorBoundary\n</code></pre>"},{"location":"skills/defensive-component-lifecycle/#see-also","title":"See Also","text":"<ul> <li><code>src/components/elastic/ElasticPlaceholder.tsx</code> - Loading/error states</li> <li><code>src/stores/uiStore.ts</code> - Notification infrastructure</li> <li><code>docs/skills/react-realtime-debugging.md</code> - Stale closure patterns</li> </ul>"},{"location":"skills/flux-agent/","title":"Skill: Creating a Flux Agent","text":"<p>Lift a discrete agent to continuous stream processing using the Flux Functor.</p> <p>Difficulty: Medium Prerequisites: Python async/await, understanding of <code>Agent[A, B]</code> protocol Files Touched: Your agent implementation, potentially <code>agents/flux/</code> for extensions</p>"},{"location":"skills/flux-agent/#overview","title":"Overview","text":"<p>Flux lifts agents from discrete transformations to continuous flow:</p> <pre><code>Flux: Agent[A, B] \u2192 Agent[Flux[A], Flux[B]]\n\nWhere Flux[T] = AsyncIterator[T]\n</code></pre> Mode Description Static <code>Agent: A \u2192 B</code> \u2014 a point transformation (invoke once, get result) Dynamic <code>Flux(Agent): dA/dt \u2192 dB/dt</code> \u2014 continuous flow (stream in, stream out) <p>Use Flux when you need: - Stream processing (events, logs, messages) - Long-running agents that respond to events - Composable pipelines (<code>flux_a | flux_b | flux_c</code>) - Backpressure handling and entropy budgeting</p>"},{"location":"skills/flux-agent/#step-by-step-minimal-flux-agent","title":"Step-by-Step: Minimal Flux Agent","text":""},{"location":"skills/flux-agent/#step-1-create-a-discrete-agent","title":"Step 1: Create a Discrete Agent","text":"<p>Start with a standard <code>Agent[A, B]</code>.</p> <p>Pattern: <pre><code>from bootstrap.types import Agent\n\nclass MyAgent(Agent[str, str]):\n    \"\"\"Processes strings.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"MyAgent\"\n\n    async def invoke(self, input: str) -&gt; str:\n        # Your processing logic here\n        return input.upper()\n</code></pre></p>"},{"location":"skills/flux-agent/#step-2-lift-to-flux","title":"Step 2: Lift to Flux","text":"<p>Use <code>Flux.lift()</code> to lift your agent to the streaming domain.</p> <p>Pattern: <pre><code>from agents.flux import Flux\n\n# Create the discrete agent\nagent = MyAgent()\n\n# Lift to flux\nflux_agent = Flux.lift(agent)\n</code></pre></p>"},{"location":"skills/flux-agent/#step-3-start-with-a-source","title":"Step 3: Start with a Source","text":"<p>Call <code>start()</code> with an <code>AsyncIterator</code> source.</p> <p>Pattern: <pre><code>import asyncio\nfrom typing import AsyncIterator\n\n# Create an async source\nasync def my_source() -&gt; AsyncIterator[str]:\n    for item in [\"hello\", \"world\", \"flux\"]:\n        yield item\n\n# Process the stream\nasync def main():\n    flux_agent = Flux.lift(MyAgent())\n\n    async for result in flux_agent.start(my_source()):\n        print(result)  # HELLO, WORLD, FLUX\n\nasyncio.run(main())\n</code></pre></p>"},{"location":"skills/flux-agent/#step-by-step-configured-flux-agent","title":"Step-by-Step: Configured Flux Agent","text":""},{"location":"skills/flux-agent/#step-1-create-fluxconfig","title":"Step 1: Create FluxConfig","text":"<p>Configure entropy, backpressure, and feedback.</p> <p>File: Your code or <code>agents/flux/config.py</code> reference</p> <p>Pattern: <pre><code>from agents.flux import FluxConfig\n\nconfig = FluxConfig(\n    # Entropy (computation budget)\n    entropy_budget=10.0,      # Initial budget (default: 1.0)\n    entropy_decay=0.1,        # Consumed per event (default: 0.01)\n    max_events=100,           # Hard cap (default: None = unlimited)\n\n    # Backpressure (slow consumer handling)\n    buffer_size=50,           # Output buffer size (default: 100)\n    drop_policy=\"drop_oldest\", # block | drop_oldest | drop_newest\n\n    # Observability\n    agent_id=\"my-flux-001\",   # For logs/traces (default: auto-generated)\n    emit_pheromones=True,     # Emit signals for monitoring\n)\n</code></pre></p>"},{"location":"skills/flux-agent/#step-2-lift-with-config","title":"Step 2: Lift with Config","text":"<p>Pattern: <pre><code>from agents.flux import Flux, FluxConfig\n\nconfig = FluxConfig(\n    entropy_budget=10.0,\n    buffer_size=50,\n)\n\nflux_agent = Flux.lift(MyAgent(), config)\n</code></pre></p>"},{"location":"skills/flux-agent/#alternative-use-config-factories","title":"Alternative: Use Config Factories","text":"<pre><code>from agents.flux import FluxConfig\n\n# Runs until source exhausts (no entropy limit)\ninfinite_config = FluxConfig.infinite()\n\n# Processes exactly N events then stops\nbounded_config = FluxConfig.bounded(max_events=1000)\n\n# With ouroboric feedback (30% of output feeds back to input)\nouroboric_config = FluxConfig.ouroboric(feedback_fraction=0.3)\n</code></pre>"},{"location":"skills/flux-agent/#step-by-step-flux-pipeline-composition","title":"Step-by-Step: Flux Pipeline (Composition)","text":""},{"location":"skills/flux-agent/#step-1-create-multiple-flux-agents","title":"Step 1: Create Multiple Flux Agents","text":"<pre><code>class DoubleAgent(Agent[int, int]):\n    @property\n    def name(self) -&gt; str:\n        return \"Double\"\n\n    async def invoke(self, input: int) -&gt; int:\n        return input * 2\n\nclass AddOneAgent(Agent[int, int]):\n    @property\n    def name(self) -&gt; str:\n        return \"AddOne\"\n\n    async def invoke(self, input: int) -&gt; int:\n        return input + 1\n</code></pre>"},{"location":"skills/flux-agent/#step-2-compose-with-pipe-operator","title":"Step 2: Compose with Pipe Operator","text":"<pre><code>from agents.flux import Flux\n\nflux_double = Flux.lift(DoubleAgent())\nflux_add = Flux.lift(AddOneAgent())\n\n# Compose: double then add one\npipeline = flux_double | flux_add\n\n# Process: 0\u21920\u21921, 1\u21922\u21923, 2\u21924\u21925, ...\nasync for result in pipeline.start(async_range(5)):\n    print(result)  # 1, 3, 5, 7, 9\n</code></pre>"},{"location":"skills/flux-agent/#alternative-use-for-static-agent-composition","title":"Alternative: Use &gt;&gt; for Static Agent Composition","text":"<pre><code># Compose flux with static agent (doesn't lift second agent)\nflux_agent = Flux.lift(DoubleAgent()) &gt;&gt; AddOneAgent()\n</code></pre>"},{"location":"skills/flux-agent/#step-by-step-perturbation-inject-into-running-flux","title":"Step-by-Step: Perturbation (Inject into Running Flux)","text":""},{"location":"skills/flux-agent/#step-1-start-the-flux","title":"Step 1: Start the Flux","text":"<pre><code>flux_agent = Flux.lift(MyAgent())\n\n# Start in background task\nasync def run_flux():\n    async for result in flux_agent.start(my_source()):\n        print(f\"Output: {result}\")\n\ntask = asyncio.create_task(run_flux())\n</code></pre>"},{"location":"skills/flux-agent/#step-2-invoke-during-flow-perturbation","title":"Step 2: Invoke During Flow (Perturbation)","text":"<p>When flux is FLOWING, <code>invoke()</code> becomes a perturbation:</p> <pre><code># While flux is running, inject high-priority event\nresult = await flux_agent.invoke(\"urgent-event\")\nprint(f\"Perturbation result: {result}\")\n</code></pre> <p>Key Insight: Perturbations flow through the same state-loading path as normal events, preserving state integrity.</p>"},{"location":"skills/flux-agent/#step-by-step-ouroboric-feedback","title":"Step-by-Step: Ouroboric Feedback","text":""},{"location":"skills/flux-agent/#step-1-configure-feedback","title":"Step 1: Configure Feedback","text":"<pre><code>config = FluxConfig(\n    feedback_fraction=0.3,  # 30% of outputs feed back\n    feedback_transform=lambda result: result.as_context(),  # B \u2192 A transform\n)\n\nflux_agent = Flux.lift(MyAgent(), config)\n</code></pre>"},{"location":"skills/flux-agent/#step-2-understand-feedback-fraction","title":"Step 2: Understand Feedback Fraction","text":"Fraction Behavior 0.0 Pure reactive (no feedback) 0.1-0.3 Light context accumulation 0.5 Equal external/internal influence 1.0 Full ouroboros (solipsism risk!)"},{"location":"skills/flux-agent/#verification","title":"Verification","text":""},{"location":"skills/flux-agent/#test-1-start-returns-asynciterator","title":"Test 1: Start returns AsyncIterator","text":"<pre><code>cd impl/claude\nuv run python -c \"\nimport asyncio\nfrom agents.flux import Flux\nfrom bootstrap.types import Agent\n\nclass Echo(Agent[str, str]):\n    @property\n    def name(self): return 'Echo'\n    async def invoke(self, x): return x\n\nasync def source():\n    yield 'test'\n\nasync def main():\n    flux = Flux.lift(Echo())\n    result = flux.start(source())\n    assert hasattr(result, '__anext__')\n    print('OK: start() returns AsyncIterator')\n\nasyncio.run(main())\n\"\n</code></pre>"},{"location":"skills/flux-agent/#test-2-process-events","title":"Test 2: Process events","text":"<pre><code>uv run python -c \"\nimport asyncio\nfrom agents.flux import Flux\nfrom bootstrap.types import Agent\n\nclass Double(Agent[int, int]):\n    @property\n    def name(self): return 'Double'\n    async def invoke(self, x): return x * 2\n\nasync def source():\n    for i in range(5):\n        yield i\n\nasync def main():\n    flux = Flux.lift(Double())\n    results = [r async for r in flux.start(source())]\n    assert results == [0, 2, 4, 6, 8]\n    print(f'OK: {results}')\n\nasyncio.run(main())\n\"\n</code></pre>"},{"location":"skills/flux-agent/#test-3-run-tests","title":"Test 3: Run tests","text":"<pre><code>cd impl/claude\nuv run pytest agents/flux/_tests/test_agent.py -v\n</code></pre>"},{"location":"skills/flux-agent/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/flux-agent/#1-treating-start-as-void","title":"1. Treating start() as void","text":"<p>Wrong: <pre><code>flux.start(source)  # Discards the output!\n</code></pre></p> <p>Right: <pre><code>async for result in flux.start(source):\n    process(result)\n</code></pre></p> <p>The KEY insight: <code>start()</code> returns <code>AsyncIterator[B]</code>, not <code>None</code>. This enables Living Pipelines.</p>"},{"location":"skills/flux-agent/#2-using-asynciosleep-for-timing","title":"2. Using asyncio.sleep() for timing","text":"<p>Wrong: <pre><code>async def my_source():\n    while True:\n        await asyncio.sleep(1.0)  # Timer zombie\n        yield event\n</code></pre></p> <p>Right: <pre><code>async def my_source():\n    async for event in external_event_stream:\n        yield event  # Event-driven\n</code></pre></p> <p>Flux is event-driven, not timer-driven.</p>"},{"location":"skills/flux-agent/#3-bypassing-the-stream-during-flowing","title":"3. Bypassing the stream during FLOWING","text":"<p>Wrong: <pre><code>if flux._state == FluxState.FLOWING:\n    result = await flux.inner.invoke(x)  # Bypasses stream!\n</code></pre></p> <p>Right: <pre><code>result = await flux.invoke(x)  # Proper perturbation injection\n</code></pre></p>"},{"location":"skills/flux-agent/#4-feedback_fraction10-without-external-input","title":"4. feedback_fraction=1.0 without external input","text":"<p>Wrong: <pre><code>config = FluxConfig(feedback_fraction=1.0)\n# With finite source \u2192 closed loop \u2192 infinite\n</code></pre></p> <p>Use <code>feedback_fraction &lt; 1.0</code> or ensure continuous external input.</p>"},{"location":"skills/flux-agent/#5-not-handling-entropy-exhaustion","title":"5. Not handling entropy exhaustion","text":"<p>Symptom: Flux stops unexpectedly.</p> <p>Fix: Use appropriate entropy budget or <code>FluxConfig.infinite()</code>: <pre><code># For long-running agents\nconfig = FluxConfig(entropy_budget=float(\"inf\"), entropy_decay=0.0)\n</code></pre></p>"},{"location":"skills/flux-agent/#6-not-awaiting-perturbation-results","title":"6. Not awaiting perturbation results","text":"<p>Wrong: <pre><code>flux.invoke(\"event\")  # Fire and forget (result lost)\n</code></pre></p> <p>Right: <pre><code>result = await flux.invoke(\"event\")  # Wait for processing\n</code></pre></p>"},{"location":"skills/flux-agent/#flux-states","title":"Flux States","text":"<pre><code>DORMANT   \u2192 Created, not started (invoke works directly)\nFLOWING   \u2192 Processing stream (invoke = perturbation)\nDRAINING  \u2192 Source exhausted, flushing output\nSTOPPED   \u2192 Explicitly stopped\nCOLLAPSED \u2192 Entropy depleted\n</code></pre>"},{"location":"skills/flux-agent/#real-example-event-processor","title":"Real Example: Event Processor","text":"<pre><code>from dataclasses import dataclass\nfrom typing import AsyncIterator\nfrom agents.flux import Flux, FluxConfig\nfrom bootstrap.types import Agent\n\n@dataclass\nclass Event:\n    type: str\n    data: dict\n\n@dataclass\nclass ProcessedEvent:\n    original_type: str\n    summary: str\n\nclass EventProcessor(Agent[Event, ProcessedEvent]):\n    @property\n    def name(self) -&gt; str:\n        return \"EventProcessor\"\n\n    async def invoke(self, event: Event) -&gt; ProcessedEvent:\n        # Your processing logic\n        summary = f\"Processed {event.type}: {len(event.data)} fields\"\n        return ProcessedEvent(\n            original_type=event.type,\n            summary=summary,\n        )\n\nasync def kafka_events() -&gt; AsyncIterator[Event]:\n    \"\"\"Simulated event source.\"\"\"\n    events = [\n        Event(\"user.login\", {\"user_id\": \"123\"}),\n        Event(\"order.created\", {\"order_id\": \"456\", \"items\": [1, 2, 3]}),\n        Event(\"user.logout\", {\"user_id\": \"123\"}),\n    ]\n    for event in events:\n        yield event\n\nasync def main():\n    config = FluxConfig(\n        entropy_budget=100.0,\n        buffer_size=50,\n        agent_id=\"event-processor-001\",\n    )\n\n    flux_processor = Flux.lift(EventProcessor(), config)\n\n    async for processed in flux_processor.start(kafka_events()):\n        print(f\"{processed.original_type}: {processed.summary}\")\n\nif __name__ == \"__main__\":\n    import asyncio\n    asyncio.run(main())\n</code></pre>"},{"location":"skills/flux-agent/#case-study-townflux","title":"Case Study: TownFlux","text":"<p><code>TownFlux</code> demonstrates the Flux pattern for Agent Town simulation.</p>"},{"location":"skills/flux-agent/#overview_1","title":"Overview","text":"<p>TownFlux emits <code>TownEvent</code> objects as an async stream:</p> <pre><code>from agents.town.flux import TownFlux, TownPhase, TownEvent\nfrom agents.town.environment import TownEnvironment\n\n# Create environment with citizens\nenv = TownEnvironment(name=\"Harmony\", citizens={...})\n\n# Create flux\nflux = TownFlux(environment=env, seed=42)\n\n# Process events\nasync for event in flux.step():\n    print(f\"[{event.phase.name}] {event.operation}: {event.participants}\")\n</code></pre>"},{"location":"skills/flux-agent/#townphase-daily-cycle","title":"TownPhase (Daily Cycle)","text":"<pre><code>class TownPhase(Enum):\n    MORNING = auto()    # Social activities weighted\n    AFTERNOON = auto()  # Work activities weighted\n    EVENING = auto()    # Mixed activities\n    NIGHT = auto()      # Reflection weighted\n</code></pre>"},{"location":"skills/flux-agent/#townevent-structure","title":"TownEvent Structure","text":"<pre><code>@dataclass\nclass TownEvent:\n    phase: TownPhase           # Time of day\n    operation: str             # greet, gossip, trade, solo, etc.\n    participants: list[str]    # Citizen names\n    success: bool              # Operation succeeded\n    message: str               # Human-readable description\n    tokens_used: int           # LLM token cost\n    drama_contribution: float  # Event drama level [0, 1]\n</code></pre>"},{"location":"skills/flux-agent/#integration-with-visualization","title":"Integration with Visualization","text":"<p>TownFlux integrates with SSE and NATS for real-time updates:</p> <pre><code>from agents.town.visualization import TownSSEEndpoint, TownNATSBridge\n\nasync def run_with_streaming(flux: TownFlux, town_id: str):\n    sse = TownSSEEndpoint(town_id)\n    nats = TownNATSBridge()\n\n    async for event in flux.step():\n        # Push to SSE clients\n        await sse.push_event(event)\n\n        # Publish to NATS\n        await nats.publish_town_event(town_id, event)\n\n        yield event\n</code></pre>"},{"location":"skills/flux-agent/#perturbation-intervention","title":"Perturbation (Intervention)","text":"<p>Users can inject events into a running flux:</p> <pre><code># User triggers a festival (intervention)\nresult = await flux.invoke_intervention(\"festival\", target_citizens=[\"bob\", \"eve\"])\n</code></pre>"},{"location":"skills/flux-agent/#batailles-insight-expenditure","title":"Bataille's Insight: Expenditure","text":"<p>From the docstring:</p> <p>\"The flux is not just time\u2014it is expenditure. Each phase accumulates surplus that must be spent. If not spent gloriously, it will be spent catastrophically.\"</p> <p>This maps to the drama potential and token budgets in TownFlux.</p>"},{"location":"skills/flux-agent/#usage-pattern","title":"Usage Pattern","text":"<pre><code>import asyncio\nfrom agents.town.flux import TownFlux\nfrom agents.town.environment import create_phase4_environment\n\nasync def main():\n    # Create 25-citizen town\n    env = create_phase4_environment(\"Metropolis\")\n    flux = TownFlux(environment=env, seed=42)\n\n    # Run 4 phases (one day)\n    for _ in range(4):\n        async for event in flux.step():\n            print(f\"Day {flux.day} {event.phase.name}: {event.operation}\")\n\nasyncio.run(main())\n</code></pre>"},{"location":"skills/flux-agent/#related-skills","title":"Related Skills","text":"<ul> <li>agentese-path - Adding AGENTESE paths</li> <li>test-patterns - Testing async agents</li> <li>agent-town-visualization - SSE/NATS integration</li> </ul>"},{"location":"skills/flux-agent/#changelog","title":"Changelog","text":"<ul> <li>2025-12-14: Added TownFlux case study (RE-METABOLIZE cycle)</li> <li>2025-12-12: Initial version based on flux implementation</li> </ul>"},{"location":"skills/frontend-contracts/","title":"Skill: Frontend Contract Testing","text":"<p>Prevent backend/frontend type mismatches by validating Python <code>_to_json()</code> output against TypeScript type expectations.</p> <p>Difficulty: Easy-Medium Prerequisites: pytest basics, understanding of TypeScript interfaces Files Touched: <code>protocols/api/_tests/test_frontend_contracts.py</code>, <code>web/src/reactive/types.ts</code> References: <code>web/src/reactive/types.ts</code> (source of truth)</p>"},{"location":"skills/frontend-contracts/#overview","title":"Overview","text":"<p>When Python backends serve JSON to TypeScript frontends, type mismatches can cause runtime crashes that are hard to debug. This skill documents how to write contract tests that validate backend JSON output matches frontend TypeScript expectations.</p>"},{"location":"skills/frontend-contracts/#the-bug-that-inspired-this","title":"The Bug That Inspired This","text":"<p>December 2024: Clicking an agent in the webapp Town demo made the screen go blank.</p> <p>Root cause: <code>ColonyDashboard._to_json()</code> was sending: - <code>id</code> instead of <code>citizen_id</code> - Missing <code>eigenvectors</code> field entirely</p> <p>The frontend <code>CitizenPanel.tsx</code> tried to access <code>citizen.eigenvectors.warmth</code>, causing a TypeError that crashed React's entire render tree.</p> <p>Why tests didn't catch it: TypeScript types only exist at compile time. The backend had no knowledge of what the frontend expected.</p> <p>Solution: Contract tests that validate backend output against a Python mirror of the TypeScript types.</p>"},{"location":"skills/frontend-contracts/#architecture","title":"Architecture","text":"<pre><code>web/src/reactive/types.ts          # Source of truth (TypeScript)\n        \u2193\n        \u2193 (manual sync)\n        \u2193\nprotocols/api/_tests/              # Contract tests (Python)\n  test_frontend_contracts.py\n        \u2193\n        \u2193 validates\n        \u2193\nagents/i/reactive/                 # Backend widgets\n  colony_dashboard.py\n  primitives/citizen_card.py\n</code></pre> <p>The contract tests define Python schema validators that mirror the TypeScript interfaces. When the backend <code>_to_json()</code> methods are called, the tests validate the output matches the expected schema.</p>"},{"location":"skills/frontend-contracts/#step-by-step-adding-a-contract-test","title":"Step-by-Step: Adding a Contract Test","text":""},{"location":"skills/frontend-contracts/#step-1-identify-the-typescript-type","title":"Step 1: Identify the TypeScript Type","text":"<p>File: <code>web/src/reactive/types.ts</code></p> <p>Find the interface you need to validate:</p> <pre><code>export interface CitizenCardJSON {\n  type: 'citizen_card';\n  citizen_id: string;      // NOT \"id\"!\n  name: string;\n  archetype: string;\n  phase: CitizenPhase;\n  nphase: NPhase;\n  activity: number[];\n  capability: number;\n  entropy: number;\n  region: string;\n  mood: string;\n  eigenvectors: CitizenEigenvectors;\n}\n\nexport interface CitizenEigenvectors {\n  warmth: number;\n  curiosity: number;\n  trust: number;\n}\n</code></pre>"},{"location":"skills/frontend-contracts/#step-2-create-schema-validator","title":"Step 2: Create Schema Validator","text":"<p>File: <code>protocols/api/_tests/test_frontend_contracts.py</code></p> <p>Mirror the TypeScript interface as a Python schema:</p> <pre><code>def is_string(v: Any) -&gt; bool:\n    return isinstance(v, str)\n\ndef is_number(v: Any) -&gt; bool:\n    return isinstance(v, (int, float))\n\ndef is_citizen_phase(v: Any) -&gt; bool:\n    return v in (\"IDLE\", \"SOCIALIZING\", \"WORKING\", \"REFLECTING\", \"RESTING\")\n\nCITIZEN_EIGENVECTORS_SCHEMA: dict[str, Callable[[Any], bool]] = {\n    \"warmth\": is_number,\n    \"curiosity\": is_number,\n    \"trust\": is_number,\n}\n\nCITIZEN_CARD_SCHEMA: dict[str, Callable[[Any], bool]] = {\n    \"type\": lambda v: v == \"citizen_card\",\n    \"citizen_id\": is_string,      # NOT \"id\"!\n    \"name\": is_string,\n    \"archetype\": is_string,\n    \"phase\": is_citizen_phase,\n    \"nphase\": is_nphase,\n    \"activity\": is_list_of_numbers,\n    \"capability\": is_number,\n    \"entropy\": is_number,\n    \"region\": is_string,\n    \"mood\": is_string,\n    \"eigenvectors\": lambda v: isinstance(v, dict),\n}\n</code></pre>"},{"location":"skills/frontend-contracts/#step-3-write-validation-function","title":"Step 3: Write Validation Function","text":"<pre><code>def validate_schema(\n    data: dict[str, Any],\n    schema: dict[str, Callable[[Any], bool]],\n    path: str = \"\",\n) -&gt; list[str]:\n    \"\"\"Validate data against schema, returning list of errors.\"\"\"\n    errors = []\n\n    for field, validator in schema.items():\n        full_path = f\"{path}.{field}\" if path else field\n\n        if field not in data:\n            errors.append(f\"Missing required field: {full_path}\")\n            continue\n\n        if not validator(data[field]):\n            errors.append(f\"Invalid value for {full_path}: {data[field]!r}\")\n\n    return errors\n</code></pre>"},{"location":"skills/frontend-contracts/#step-4-write-contract-test","title":"Step 4: Write Contract Test","text":"<pre><code>class TestCitizenCardContract:\n    \"\"\"Verify CitizenWidget._to_json() matches CitizenCardJSON TypeScript type.\"\"\"\n\n    @pytest.fixture\n    def citizen_widget(self) -&gt; Any:\n        \"\"\"Create a CitizenWidget with realistic data.\"\"\"\n        from agents.i.reactive.primitives.citizen_card import CitizenState, CitizenWidget\n\n        state = CitizenState(\n            citizen_id=\"test-123\",\n            name=\"Alice\",\n            archetype=\"builder\",\n            # ... realistic values\n        )\n        return CitizenWidget(state)\n\n    def test_citizen_card_has_required_fields(self, citizen_widget: Any) -&gt; None:\n        \"\"\"Verify all CitizenCardJSON required fields are present.\"\"\"\n        from agents.i.reactive.widget import RenderTarget\n\n        json_output = citizen_widget.project(RenderTarget.JSON)\n\n        errors = validate_schema(json_output, CITIZEN_CARD_SCHEMA)\n        assert not errors, f\"Schema validation failed:\\n\" + \"\\n\".join(errors)\n\n    def test_citizen_card_uses_citizen_id_not_id(self, citizen_widget: Any) -&gt; None:\n        \"\"\"\n        CRITICAL: Verify field is 'citizen_id' not 'id'.\n\n        This was the exact bug that caused blank screens.\n        \"\"\"\n        json_output = citizen_widget.project(RenderTarget.JSON)\n\n        assert \"citizen_id\" in json_output, \"Must use 'citizen_id' not 'id'\"\n        assert \"id\" not in json_output, \"Must NOT have 'id' field\"\n</code></pre>"},{"location":"skills/frontend-contracts/#step-5-test-nested-structures","title":"Step 5: Test Nested Structures","text":"<p>For nested objects like <code>eigenvectors</code>, validate them separately:</p> <pre><code>def test_citizen_card_eigenvectors_structure(self, citizen_widget: Any) -&gt; None:\n    \"\"\"Verify eigenvectors field matches CitizenEigenvectors TypeScript type.\"\"\"\n    json_output = citizen_widget.project(RenderTarget.JSON)\n\n    assert \"eigenvectors\" in json_output\n    eigenvectors = json_output[\"eigenvectors\"]\n\n    errors = validate_schema(\n        eigenvectors,\n        CITIZEN_EIGENVECTORS_SCHEMA,\n        \"eigenvectors\"\n    )\n    assert not errors\n</code></pre>"},{"location":"skills/frontend-contracts/#step-by-step-adding-frontend-defensive-checks","title":"Step-by-Step: Adding Frontend Defensive Checks","text":"<p>Even with contract tests, add defensive null checks in the frontend:</p>"},{"location":"skills/frontend-contracts/#step-1-identify-risky-access-patterns","title":"Step 1: Identify Risky Access Patterns","text":"<p>Look for direct property access on data from SSE/API:</p> <pre><code>// DANGEROUS: Will crash if eigenvectors is undefined\n&lt;EigenvectorBar value={citizen.eigenvectors.warmth} /&gt;\n</code></pre>"},{"location":"skills/frontend-contracts/#step-2-add-null-guards","title":"Step 2: Add Null Guards","text":"<pre><code>// SAFE: Guards against undefined\n{citizen.eigenvectors &amp;&amp; (\n  &lt;EigenvectorBar\n    value={citizen.eigenvectors.warmth ?? 0.5}\n  /&gt;\n)}\n</code></pre>"},{"location":"skills/frontend-contracts/#step-3-update-typescript-types-for-flexibility","title":"Step 3: Update TypeScript Types for Flexibility","text":"<p>If the backend might send additional values (like <code>UNDERSTAND</code> vs <code>SENSE</code>):</p> <pre><code>// Before: Strict\nexport type NPhase = 'SENSE' | 'ACT' | 'REFLECT';\n\n// After: Flexible (with comment explaining why)\n// UNDERSTAND is the primary name in backend (SENSE is alias)\nexport type NPhase = 'UNDERSTAND' | 'SENSE' | 'ACT' | 'REFLECT';\n</code></pre>"},{"location":"skills/frontend-contracts/#verification","title":"Verification","text":""},{"location":"skills/frontend-contracts/#run-contract-tests","title":"Run Contract Tests","text":"<pre><code>cd impl/claude\nuv run pytest protocols/api/_tests/test_frontend_contracts.py -v\n</code></pre>"},{"location":"skills/frontend-contracts/#verify-ci-integration","title":"Verify CI Integration","text":"<p>Contract tests run automatically in CI as part of unit tests:</p> <pre><code># Same filter CI uses\nuv run pytest -m \"not slow and not integration\" --collect-only | grep frontend_contracts\n</code></pre>"},{"location":"skills/frontend-contracts/#manual-verification","title":"Manual Verification","text":"<ol> <li>Start backend: <code>uv run uvicorn protocols.api.app:create_app --factory --reload</code></li> <li>Start frontend: <code>cd web &amp;&amp; npm run dev</code></li> <li>Navigate to Town page</li> <li>Click on a citizen</li> <li>Verify the panel opens without blank screen</li> </ol>"},{"location":"skills/frontend-contracts/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/frontend-contracts/#1-field-name-mismatch","title":"1. Field Name Mismatch","text":"<p>Problem: Backend uses <code>id</code>, frontend expects <code>citizen_id</code></p> <p>Prevention: Contract test explicitly checks: <pre><code>assert \"citizen_id\" in json_output\nassert \"id\" not in json_output\n</code></pre></p>"},{"location":"skills/frontend-contracts/#2-missing-nested-object","title":"2. Missing Nested Object","text":"<p>Problem: Backend omits <code>eigenvectors</code>, frontend accesses <code>citizen.eigenvectors.warmth</code></p> <p>Prevention: - Contract test validates nested structure exists - Frontend adds null guard: <code>citizen.eigenvectors &amp;&amp; ...</code></p>"},{"location":"skills/frontend-contracts/#3-enum-value-drift","title":"3. Enum Value Drift","text":"<p>Problem: Backend renames <code>SENSE</code> to <code>UNDERSTAND</code>, frontend only accepts <code>SENSE</code></p> <p>Prevention: - Contract test validates against allowed values - When mismatch found, update BOTH:   - Frontend TypeScript type (add new value)   - Contract test validator (accept new value)</p>"},{"location":"skills/frontend-contracts/#4-forgetting-to-update-contract-tests","title":"4. Forgetting to Update Contract Tests","text":"<p>Problem: TypeScript types updated but contract tests not synced</p> <p>Prevention: Add documentation test that reminds maintainers: <pre><code>def test_typescript_types_location_documented(self) -&gt; None:\n    \"\"\"Verify we document where the source of truth is.\"\"\"\n    # This test exists to remind maintainers\n    types_path = \"web/src/reactive/types.ts\"\n    assert os.path.exists(types_path), (\n        f\"TypeScript types not found at {types_path}\\n\"\n        \"If moved, update contract tests!\"\n    )\n</code></pre></p>"},{"location":"skills/frontend-contracts/#when-to-use-this-skill","title":"When to Use This Skill","text":"<p>Use contract tests when:</p> <ol> <li>Python backend serves JSON to TypeScript frontend - The type systems don't talk to each other</li> <li>SSE/WebSocket streams data - Real-time data is hard to debug when malformed</li> <li>API responses are complex - Nested objects with many fields</li> <li>Multiple widgets share types - One mismatch breaks many components</li> </ol> <p>Don't use contract tests for:</p> <ol> <li>Simple string/number APIs - TypeScript catches these at compile time</li> <li>Internal Python-only code - Use regular pytest assertions</li> <li>Prototype code - Wait until types stabilize</li> </ol>"},{"location":"skills/frontend-contracts/#maintenance","title":"Maintenance","text":""},{"location":"skills/frontend-contracts/#when-typescript-types-change","title":"When TypeScript Types Change","text":"<ol> <li>Update <code>web/src/reactive/types.ts</code> (source of truth)</li> <li>Update corresponding schema in <code>test_frontend_contracts.py</code></li> <li>Run: <code>uv run pytest protocols/api/_tests/test_frontend_contracts.py -v</code></li> <li>Fix any backend <code>_to_json()</code> methods that fail</li> </ol>"},{"location":"skills/frontend-contracts/#adding-new-widget-types","title":"Adding New Widget Types","text":"<ol> <li>Add TypeScript interface to <code>types.ts</code></li> <li>Add Python schema to <code>test_frontend_contracts.py</code></li> <li>Add test class <code>Test&lt;Widget&gt;Contract</code></li> <li>Implement backend <code>_to_json()</code> method</li> <li>Verify tests pass</li> </ol>"},{"location":"skills/frontend-contracts/#related-skills","title":"Related Skills","text":"<ul> <li>test-patterns - General testing patterns (T-gent Types I-V)</li> <li>reactive-primitives - Signal/Computed/Effect system</li> <li>agent-town-visualization - Widget rendering patterns</li> </ul>"},{"location":"skills/frontend-contracts/#changelog","title":"Changelog","text":"<ul> <li>2025-12-15: Initial version after debugging blank screen bug</li> </ul>"},{"location":"skills/handler-patterns/","title":"Skill: Common Handler Patterns","text":"<p>Write CLI handlers following established patterns for the Hollow Shell architecture.</p> <p>Difficulty: Easy-Medium Prerequisites: cli-command skill, Python basics Files Touched: <code>protocols/cli/handlers/&lt;name&gt;.py</code>, <code>protocols/cli/handlers/__init__.py</code></p>"},{"location":"skills/handler-patterns/#overview","title":"Overview","text":"<p>CLI handlers follow these key patterns:</p> Pattern Description Signature <code>def cmd_&lt;name&gt;(args: list[str]) -&gt; int</code> Subcommands Parse via <code>match</code> statement Dual-channel Human output (stdout) + Semantic output (FD3) Async bridging Sync entry \u2192 <code>asyncio.run()</code> \u2192 async logic Lazy imports Import dependencies inside function Help docstring Module docstring used for <code>--help</code>"},{"location":"skills/handler-patterns/#step-by-step-basic-handler","title":"Step-by-Step: Basic Handler","text":""},{"location":"skills/handler-patterns/#step-1-create-handler-file","title":"Step 1: Create Handler File","text":"<p>File: <code>impl/claude/protocols/cli/handlers/&lt;name&gt;.py</code></p> <p>Template: <pre><code>\"\"\"\n&lt;Name&gt; Handler: Short description.\n\nLonger description of what this handler does.\n\nUsage:\n    kgents &lt;name&gt;           # Default action\n    kgents &lt;name&gt; --flag    # With flag\n\nExample:\n    $ kgents &lt;name&gt;\n    [NAME] Output here\n\"\"\"\n\nfrom __future__ import annotations\n\n\ndef _print_help() -&gt; None:\n    \"\"\"Print help for command.\"\"\"\n    print(__doc__)\n\n\ndef cmd_&lt;name&gt;(args: list[str]) -&gt; int:\n    \"\"\"\n    Short description for inline help.\n\n    Returns:\n        0 on success, non-zero on error\n    \"\"\"\n    # Parse flags\n    if \"--help\" in args or \"-h\" in args:\n        _print_help()\n        return 0\n\n    # Your logic here\n    print(\"[NAME] Done\")\n    return 0\n</code></pre></p>"},{"location":"skills/handler-patterns/#step-2-register-in-initpy","title":"Step 2: Register in init.py","text":"<p>File: <code>impl/claude/protocols/cli/handlers/__init__.py</code></p> <p>Add description comment: <pre><code>\"\"\"\nCLI Handlers - Lazy-loaded command implementations.\n\n...\n- &lt;name&gt;.py: Description of your handler\n\"\"\"\n</code></pre></p>"},{"location":"skills/handler-patterns/#step-3-register-in-hollowpy","title":"Step 3: Register in hollow.py","text":"<p>File: <code>impl/claude/protocols/cli/hollow.py</code></p> <p>Add to lazy loader: <pre><code>if command == \"&lt;name&gt;\":\n    from protocols.cli.handlers.&lt;name&gt; import cmd_&lt;name&gt;\n    return cmd_&lt;name&gt;(args)\n</code></pre></p>"},{"location":"skills/handler-patterns/#step-by-step-handler-with-subcommands","title":"Step-by-Step: Handler with Subcommands","text":""},{"location":"skills/handler-patterns/#step-1-parse-subcommand","title":"Step 1: Parse Subcommand","text":"<p>Pattern: <pre><code>def cmd_myhandler(args: list[str]) -&gt; int:\n    \"\"\"Handle myhandler command with subcommands.\"\"\"\n    # Parse flags\n    if \"--help\" in args or \"-h\" in args:\n        _print_help()\n        return 0\n\n    # Parse subcommand\n    subcommand = None\n    subcommand_args: list[str] = []\n\n    for arg in args:\n        if arg.startswith(\"-\"):\n            continue\n        if subcommand is None:\n            subcommand = arg\n        else:\n            subcommand_args.append(arg)\n\n    # Default subcommand\n    if subcommand is None:\n        subcommand = \"status\"  # or \"list\", etc.\n\n    # Route to handler\n    match subcommand:\n        case \"list\":\n            return _handle_list(subcommand_args)\n        case \"add\":\n            return _handle_add(subcommand_args)\n        case \"remove\":\n            return _handle_remove(subcommand_args)\n        case _:\n            print(f\"[MYHANDLER] X Unknown subcommand: {subcommand}\")\n            return 1\n\n\ndef _handle_list(args: list[str]) -&gt; int:\n    \"\"\"Handle 'myhandler list' subcommand.\"\"\"\n    # Implementation\n    return 0\n\n\ndef _handle_add(args: list[str]) -&gt; int:\n    \"\"\"Handle 'myhandler add' subcommand.\"\"\"\n    if not args:\n        print(\"[MYHANDLER] X Missing argument\")\n        return 1\n    # Implementation\n    return 0\n</code></pre></p>"},{"location":"skills/handler-patterns/#step-2-add-subcommand-help","title":"Step 2: Add Subcommand Help","text":"<pre><code>def _print_help() -&gt; None:\n    \"\"\"Print help for command.\"\"\"\n    print(__doc__)\n    print()\n    print(\"COMMANDS:\")\n    print(\"  list              List all items\")\n    print(\"  add &lt;item&gt;        Add an item\")\n    print(\"  remove &lt;item&gt;     Remove an item\")\n    print()\n    print(\"OPTIONS:\")\n    print(\"  --json            Output as JSON\")\n    print(\"  --help, -h        Show this help\")\n</code></pre>"},{"location":"skills/handler-patterns/#step-by-step-async-handler","title":"Step-by-Step: Async Handler","text":"<p>Many handlers need async (database, network, etc.). Bridge sync\u2192async:</p>"},{"location":"skills/handler-patterns/#step-1-sync-entry-point","title":"Step 1: Sync Entry Point","text":"<pre><code>import asyncio\n\ndef cmd_myhandler(args: list[str]) -&gt; int:\n    \"\"\"Entry point - sync.\"\"\"\n    if \"--help\" in args or \"-h\" in args:\n        _print_help()\n        return 0\n\n    # Bridge to async\n    return asyncio.run(_async_myhandler(args))\n</code></pre>"},{"location":"skills/handler-patterns/#step-2-async-implementation","title":"Step 2: Async Implementation","text":"<pre><code>async def _async_myhandler(args: list[str]) -&gt; int:\n    \"\"\"Async implementation.\"\"\"\n    try:\n        # Parse subcommand\n        subcommand = args[0] if args else \"list\"\n        subcommand_args = args[1:] if len(args) &gt; 1 else []\n\n        match subcommand:\n            case \"list\":\n                return await _handle_list_async(subcommand_args)\n            case \"fetch\":\n                return await _handle_fetch_async(subcommand_args)\n            case _:\n                print(f\"[MYHANDLER] X Unknown: {subcommand}\")\n                return 1\n\n    except Exception as e:\n        print(f\"[MYHANDLER] X Error: {e}\")\n        return 1\n\n\nasync def _handle_list_async(args: list[str]) -&gt; int:\n    \"\"\"Async list handler.\"\"\"\n    # Async operations here\n    data = await some_async_fetch()\n    print(f\"[MYHANDLER] Found {len(data)} items\")\n    return 0\n</code></pre>"},{"location":"skills/handler-patterns/#step-by-step-dual-channel-output","title":"Step-by-Step: Dual-Channel Output","text":"<p>The Reflector Protocol enables handlers to emit: - Human output \u2192 stdout (for users) - Semantic output \u2192 FD3 (for agents consuming CLI output)</p>"},{"location":"skills/handler-patterns/#step-1-accept-invocationcontext","title":"Step 1: Accept InvocationContext","text":"<pre><code>from typing import TYPE_CHECKING, Any\n\nif TYPE_CHECKING:\n    from protocols.cli.reflector import InvocationContext\n\n\ndef cmd_myhandler(\n    args: list[str],\n    ctx: \"InvocationContext | None\" = None,\n) -&gt; int:\n    \"\"\"Handler with dual-channel output.\"\"\"\n    # Get context from hollow.py if not provided\n    if ctx is None:\n        try:\n            from protocols.cli.hollow import get_invocation_context\n            ctx = get_invocation_context(\"myhandler\", args)\n        except ImportError:\n            pass\n\n    # ... rest of handler\n</code></pre>"},{"location":"skills/handler-patterns/#step-2-create-output-helper","title":"Step 2: Create Output Helper","text":"<pre><code>def _emit_output(\n    human: str,\n    semantic: dict[str, Any],\n    ctx: \"InvocationContext | None\",\n) -&gt; None:\n    \"\"\"\n    Emit output via dual-channel if ctx available, else print.\n\n    Args:\n        human: Human-readable string (goes to stdout)\n        semantic: Structured data (goes to FD3 for agents)\n        ctx: InvocationContext if available\n    \"\"\"\n    if ctx is not None:\n        ctx.output(human=human, semantic=semantic)\n    else:\n        print(human)\n</code></pre>"},{"location":"skills/handler-patterns/#step-3-use-in-handlers","title":"Step 3: Use in Handlers","text":"<pre><code>async def _handle_list(ctx: \"InvocationContext | None\") -&gt; int:\n    \"\"\"List handler with dual output.\"\"\"\n    items = await fetch_items()\n\n    if not items:\n        _emit_output(\n            \"[MYHANDLER] No items found\",\n            {\"count\": 0, \"items\": []},\n            ctx,\n        )\n    else:\n        lines = [f\"[MYHANDLER] {len(items)} items\"]\n        for item in items:\n            lines.append(f\"  {item.id}: {item.name}\")\n\n        _emit_output(\n            \"\\n\".join(lines),\n            {\"count\": len(items), \"items\": [i.to_dict() for i in items]},\n            ctx,\n        )\n\n    return 0\n</code></pre>"},{"location":"skills/handler-patterns/#step-by-step-json-mode","title":"Step-by-Step: JSON Mode","text":"<p>Most handlers support <code>--json</code> for machine-readable output:</p>"},{"location":"skills/handler-patterns/#step-1-parse-json-flag","title":"Step 1: Parse JSON Flag","text":"<pre><code>def cmd_myhandler(args: list[str]) -&gt; int:\n    json_mode = \"--json\" in args\n\n    # ... rest of parsing\n    return asyncio.run(_async_myhandler(json_mode=json_mode, ...))\n</code></pre>"},{"location":"skills/handler-patterns/#step-2-output-based-on-mode","title":"Step 2: Output Based on Mode","text":"<pre><code>async def _handle_list(json_mode: bool, ctx: \"InvocationContext | None\") -&gt; int:\n    items = await fetch_items()\n\n    if json_mode:\n        import json\n        result = {\"items\": [i.to_dict() for i in items]}\n        _emit_output(\n            json.dumps(result, indent=2),\n            result,\n            ctx,\n        )\n    else:\n        # Human-friendly format\n        for item in items:\n            print(f\"  {item.id}: {item.name}\")\n\n    return 0\n</code></pre>"},{"location":"skills/handler-patterns/#step-by-step-error-handling","title":"Step-by-Step: Error Handling","text":""},{"location":"skills/handler-patterns/#pattern-1-return-error-codes","title":"Pattern 1: Return Error Codes","text":"<pre><code>def cmd_myhandler(args: list[str]) -&gt; int:\n    try:\n        # ... logic\n        return 0  # Success\n    except ValueError as e:\n        print(f\"[MYHANDLER] X Invalid: {e}\")\n        return 1\n    except FileNotFoundError:\n        print(\"[MYHANDLER] X File not found\")\n        return 1\n    except Exception as e:\n        print(f\"[MYHANDLER] X Error: {e}\")\n        return 1\n</code></pre>"},{"location":"skills/handler-patterns/#pattern-2-consistent-error-format","title":"Pattern 2: Consistent Error Format","text":"<pre><code>def _emit_error(\n    message: str,\n    ctx: \"InvocationContext | None\",\n    **extra: Any,\n) -&gt; None:\n    \"\"\"Emit error with consistent format.\"\"\"\n    _emit_output(\n        f\"[MYHANDLER] X {message}\",\n        {\"error\": message, **extra},\n        ctx,\n    )\n</code></pre> <p>Usage: <pre><code>if not token_id:\n    _emit_error(\"Missing token ID\", ctx)\n    return 1\n</code></pre></p>"},{"location":"skills/handler-patterns/#step-by-step-lazy-imports","title":"Step-by-Step: Lazy Imports","text":"<p>Import heavy dependencies inside functions to keep CLI startup fast:</p>"},{"location":"skills/handler-patterns/#pattern","title":"Pattern","text":"<pre><code>def cmd_myhandler(args: list[str]) -&gt; int:\n    \"\"\"Handler with lazy imports.\"\"\"\n    # Parse args first (no imports)\n    if \"--help\" in args:\n        _print_help()\n        return 0\n\n    # Import only when needed\n    from agents.flux.semaphore import Purgatory\n    from protocols.agentese import create_logos\n\n    # Use imported modules\n    purgatory = Purgatory()\n    ...\n</code></pre>"},{"location":"skills/handler-patterns/#verification","title":"Verification","text":""},{"location":"skills/handler-patterns/#test-1-handler-runs","title":"Test 1: Handler runs","text":"<pre><code>cd impl/claude\nuv run python -c \"\nfrom protocols.cli.handlers.myhandler import cmd_myhandler\nexit_code = cmd_myhandler(['--help'])\nassert exit_code == 0\nprint('OK')\n\"\n</code></pre>"},{"location":"skills/handler-patterns/#test-2-via-hollowpy","title":"Test 2: Via hollow.py","text":"<pre><code>cd impl/claude\nuv run python -m protocols.cli.hollow myhandler --help\n</code></pre>"},{"location":"skills/handler-patterns/#test-3-run-handler-tests","title":"Test 3: Run handler tests","text":"<pre><code>uv run pytest protocols/cli/handlers/_tests/test_myhandler.py -v\n</code></pre>"},{"location":"skills/handler-patterns/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/handler-patterns/#1-forgetting-return-codes","title":"1. Forgetting return codes","text":"<p>Wrong: <pre><code>def cmd_handler(args):\n    print(\"Done\")\n    # Missing return!\n</code></pre></p> <p>Right: <pre><code>def cmd_handler(args) -&gt; int:\n    print(\"Done\")\n    return 0\n</code></pre></p>"},{"location":"skills/handler-patterns/#2-heavy-imports-at-module-level","title":"2. Heavy imports at module level","text":"<p>Wrong: <pre><code>from heavy_module import HeavyClass  # Slows CLI startup\n\ndef cmd_handler(args):\n    ...\n</code></pre></p> <p>Right: <pre><code>def cmd_handler(args):\n    from heavy_module import HeavyClass  # Lazy load\n    ...\n</code></pre></p>"},{"location":"skills/handler-patterns/#3-not-handling-missing-subcommand-args","title":"3. Not handling missing subcommand args","text":"<p>Wrong: <pre><code>case \"add\":\n    item = subcommand_args[0]  # IndexError if empty!\n</code></pre></p> <p>Right: <pre><code>case \"add\":\n    if not subcommand_args:\n        _emit_error(\"Missing item\", ctx)\n        return 1\n    item = subcommand_args[0]\n</code></pre></p>"},{"location":"skills/handler-patterns/#4-printing-instead-of-dual-channel","title":"4. Printing instead of dual-channel","text":"<p>Wrong: <pre><code>print(json.dumps(result))  # Agents can't consume this\n</code></pre></p> <p>Right: <pre><code>_emit_output(\n    json.dumps(result, indent=2),\n    result,\n    ctx,\n)\n</code></pre></p>"},{"location":"skills/handler-patterns/#5-not-registering-in-hollowpy","title":"5. Not registering in hollow.py","text":"<p>Symptom: \"Unknown command: myhandler\"</p> <p>Fix: Add lazy loader in <code>hollow.py</code>: <pre><code>if command == \"myhandler\":\n    from protocols.cli.handlers.myhandler import cmd_myhandler\n    return cmd_myhandler(args)\n</code></pre></p>"},{"location":"skills/handler-patterns/#real-example-semaphore-handler","title":"Real Example: Semaphore Handler","text":"<p>The semaphore handler demonstrates all patterns:</p> <ol> <li>Subcommand routing: <code>list</code>, <code>resolve</code>, <code>cancel</code>, <code>inspect</code>, <code>void</code></li> <li>Async bridging: <code>cmd_semaphore()</code> \u2192 <code>asyncio.run()</code> \u2192 <code>_async_semaphore()</code></li> <li>Dual-channel: <code>_emit_output(human, semantic, ctx)</code></li> <li>JSON mode: <code>--json</code> flag support</li> <li>Error handling: Consistent <code>[SEMAPHORE] X</code> prefix</li> <li>Lazy imports: <code>from agents.flux.semaphore import Purgatory</code> inside function</li> </ol> <p>See <code>impl/claude/protocols/cli/handlers/semaphore.py</code> for the complete example.</p>"},{"location":"skills/handler-patterns/#related-skills","title":"Related Skills","text":"<ul> <li>cli-command - Adding CLI commands (full end-to-end)</li> <li>test-patterns - Testing handlers</li> </ul>"},{"location":"skills/handler-patterns/#changelog","title":"Changelog","text":"<ul> <li>2025-12-12: Initial version based on semaphore and ghost handlers</li> </ul>"},{"location":"skills/harden-module/","title":"Skill: Module Hardening","text":"<p>Hardening is the process of making a module robust, type-safe, and production-ready through systematic verification.</p>"},{"location":"skills/harden-module/#when-to-use","title":"When to Use","text":"<ul> <li>Before merging significant changes</li> <li>When a module has accumulated debt</li> <li>After major API refactors</li> <li>Periodically for demo/integration files (they drift)</li> </ul>"},{"location":"skills/harden-module/#process","title":"Process","text":""},{"location":"skills/harden-module/#1-lint-check-ruff","title":"1. Lint Check (ruff)","text":"<pre><code>cd impl/claude &amp;&amp; uv run ruff check &lt;target&gt;\n</code></pre> <p>Common fixes: - Prefix unused variables with <code>_</code> - Convert one-line lambdas to <code>def</code> when cleaner - Remove unused imports</p>"},{"location":"skills/harden-module/#2-type-check-mypy","title":"2. Type Check (mypy)","text":"<pre><code>cd impl/claude &amp;&amp; uv run mypy &lt;target&gt; --strict\n</code></pre> <p>Common fixes: - Add explicit type parameters: <code>App[object]</code> not <code>App</code> - Use <code>cast()</code> for test mocks - Add type narrowing: <code>assert x is not None</code> before accessing</p> <p>Demo file exception: If a file uses notebook patterns (<code>@app.cell</code>), add: <pre><code># mypy: ignore-errors\n</code></pre></p>"},{"location":"skills/harden-module/#3-test-verification","title":"3. Test Verification","text":"<pre><code>cd impl/claude &amp;&amp; uv run pytest &lt;target&gt;/_tests/ -v\n</code></pre>"},{"location":"skills/harden-module/#4-bug-pattern-recognition","title":"4. Bug Pattern Recognition","text":"<p>Watch for these patterns:</p>"},{"location":"skills/harden-module/#pattern-a-demo-file-drift","title":"Pattern A: Demo File Drift","text":"<ul> <li>Signal: Type errors in demo/example files</li> <li>Cause: APIs evolved, demos didn't</li> <li>Fix: Update demos to current API usage</li> </ul>"},{"location":"skills/harden-module/#pattern-b-external-library-mismatch","title":"Pattern B: External Library Mismatch","text":"<ul> <li>Signal: Type errors in integration code (Textual, FastAPI, etc.)</li> <li>Cause: Mental model differs from actual API</li> <li>Fix: Read library source, adjust signatures</li> </ul>"},{"location":"skills/harden-module/#5-document-decisions","title":"5. Document Decisions","text":"<p>If making non-obvious choices: - Renaming to avoid collisions (<code>layout</code> \u2192 <code>flex_layout</code>) - Adding <code># mypy: ignore-errors</code> to specific files - Breaking API changes (e.g., adding required parameters)</p> <p>Document in the epilogue.</p>"},{"location":"skills/harden-module/#exit-criteria","title":"Exit Criteria","text":"Check Target <code>ruff check</code> 0 errors <code>mypy --strict</code> 0 errors (or only pre-existing <code>import-untyped</code>) <code>pytest</code> All pass Real bugs Fixed and documented"},{"location":"skills/harden-module/#anti-patterns","title":"Anti-Patterns","text":"<ul> <li>Don't ignore warnings globally: Fix them or document why specific ignores are acceptable</li> <li>Don't add <code># type: ignore</code> without comment: Always explain why</li> <li>Don't skip test runs: Type-correct code can still have logic bugs</li> </ul>"},{"location":"skills/harden-module/#priority-order-for-harden-targets","title":"Priority Order for Harden Targets","text":"<ol> <li>Recently modified \u2014 Changes may have introduced issues</li> <li>Integration layers \u2014 <code>protocols/api/</code>, external library adapters</li> <li>Demo files \u2014 High drift rate, low test coverage</li> <li>Pre-existing debt \u2014 <code>import-untyped</code>, deprecation warnings</li> </ol>"},{"location":"skills/harden-module/#example-session","title":"Example Session","text":"<pre><code># Target: agents/i/reactive/adapters/\nuv run ruff check agents/i/reactive/adapters/\n# Fix: 7 errors (unused vars)\n\nuv run mypy agents/i/reactive/adapters/ --strict\n# Fix: 82 errors (type params, narrowing, API mismatches)\n# Discovered: 4 real bugs (Clock API, FocusSync signature)\n\nuv run pytest agents/i/reactive/adapters/_tests/ -v\n# All pass\n\n# Document in epilogue\n</code></pre>"},{"location":"skills/harden-module/#related-skills","title":"Related Skills","text":"<ul> <li><code>test-patterns.md</code> \u2014 Testing conventions</li> <li><code>handler-patterns.md</code> \u2014 CLI handler patterns</li> <li><code>three-phase.md</code> \u2014 Research \u2192 Develop \u2192 Implement cycle</li> </ul>"},{"location":"skills/hotdata-pattern/","title":"Skill: HotData Pattern (Pre-Computed Richness)","text":"<p>Use pre-computed LLM outputs for demos and tests instead of synthetic stubs.</p> <p>Difficulty: Easy Prerequisites: Understanding of JSON serialization, async generators Files Touched: <code>shared/hotdata/</code>, <code>fixtures/</code>, demo files</p>"},{"location":"skills/hotdata-pattern/#overview","title":"Overview","text":"<p>The HotData pattern implements AD-004 (Pre-Computed Richness):</p> Truth Meaning Demo kgents ARE kgents No distinction between \"demo\" and \"real\" LLM-once is cheap One generation call is negligible Hotload everything Runtime swapping for velocity"},{"location":"skills/hotdata-pattern/#step-by-step-add-a-new-fixture","title":"Step-by-Step: Add a New Fixture","text":""},{"location":"skills/hotdata-pattern/#step-1-define-the-schema","title":"Step 1: Define the Schema","text":"<p>Ensure your data type is serializable:</p> <pre><code># In your data module\nfrom dataclasses import dataclass, asdict\nimport json\n\n@dataclass\nclass MyData:\n    id: str\n    value: str\n\n    def to_json(self) -&gt; str:\n        return json.dumps(asdict(self), indent=2)\n\n    @classmethod\n    def from_json(cls, data: str) -&gt; \"MyData\":\n        return cls(**json.loads(data))\n</code></pre>"},{"location":"skills/hotdata-pattern/#step-2-register-with-hotdata","title":"Step 2: Register with HotData","text":"<pre><code>from shared.hotdata import HotData, hotdata_registry\nfrom pathlib import Path\n\nFIXTURES_DIR = Path(__file__).parent.parent / \"fixtures\"\n\nMY_DATA_HOTDATA = HotData(\n    path=FIXTURES_DIR / \"my_data\" / \"default.json\",\n    schema=MyData,\n    ttl=None,  # Never expires (or timedelta(days=7) for weekly refresh)\n)\n\nhotdata_registry.register(\"my_data_default\", MY_DATA_HOTDATA)\n</code></pre>"},{"location":"skills/hotdata-pattern/#step-3-load-with-fallback","title":"Step 3: Load with Fallback","text":"<pre><code>def get_my_data() -&gt; MyData:\n    \"\"\"Load from hotdata, fallback to inline.\"\"\"\n    if MY_DATA_HOTDATA.exists():\n        return MY_DATA_HOTDATA.load()\n    # Inline fallback for first-run\n    return MyData(id=\"default\", value=\"placeholder\")\n</code></pre>"},{"location":"skills/hotdata-pattern/#step-4-create-generator-optional","title":"Step 4: Create Generator (Optional)","text":"<p>For LLM-generated fixtures:</p> <pre><code># In fixtures/generators/my_data.py\n\nasync def generate_my_data(entropy: float = 0.7) -&gt; MyData:\n    \"\"\"Generate rich data via LLM.\"\"\"\n    from protocols.agentese import Logos\n\n    logos = Logos()\n    result = await logos.invoke(\n        \"void.compose.sip\",\n        context={\"schema\": \"MyData\", \"entropy\": entropy}\n    )\n\n    return MyData(\n        id=result[\"id\"],\n        value=result[\"value\"],\n    )\n</code></pre>"},{"location":"skills/hotdata-pattern/#step-5-create-initial-fixture","title":"Step 5: Create Initial Fixture","text":"<pre><code># Manual creation\necho '{\"id\": \"demo\", \"value\": \"rich content here\"}' &gt; fixtures/my_data/default.json\n\n# Or via CLI\nkg fixture refresh my_data_default\n</code></pre>"},{"location":"skills/hotdata-pattern/#step-by-step-migrate-demo-function","title":"Step-by-Step: Migrate Demo Function","text":""},{"location":"skills/hotdata-pattern/#before-anti-pattern","title":"Before (Anti-pattern)","text":"<pre><code>def create_demo_snapshot() -&gt; AgentSnapshot:\n    return AgentSnapshot(\n        id=\"demo\",\n        name=\"Demo Agent\",\n        summary=\"A placeholder summary\",  # Synthetic stub!\n    )\n</code></pre>"},{"location":"skills/hotdata-pattern/#after-correct","title":"After (Correct)","text":"<pre><code>from shared.hotdata import HotData, hotdata_registry\n\nDEMO_SNAPSHOT = HotData(\n    path=FIXTURES_DIR / \"agent_snapshots\" / \"demo.json\",\n    schema=AgentSnapshot,\n)\nhotdata_registry.register(\"demo_snapshot\", DEMO_SNAPSHOT)\n\ndef create_demo_snapshot() -&gt; AgentSnapshot:\n    \"\"\"Load from hotdata with fallback.\"\"\"\n    if DEMO_SNAPSHOT.exists():\n        return DEMO_SNAPSHOT.load()\n    return AgentSnapshot(\n        id=\"demo\",\n        name=\"Demo Agent\",\n        summary=\"A placeholder summary\",\n    )\n</code></pre>"},{"location":"skills/hotdata-pattern/#step-by-step-test-with-hotdata","title":"Step-by-Step: Test with HotData","text":""},{"location":"skills/hotdata-pattern/#in-conftestpy","title":"In conftest.py","text":"<pre><code>from shared.hotdata import HotData\n\nRICH_SNAPSHOT = HotData(\n    path=FIXTURES_DIR / \"test\" / \"rich_snapshot.json\",\n    schema=AgentSnapshot,\n)\n\n@pytest.fixture\ndef rich_agent_snapshot() -&gt; AgentSnapshot:\n    \"\"\"Pre-computed rich snapshot for tests.\"\"\"\n    return RICH_SNAPSHOT.load_or_default(\n        AgentSnapshot(id=\"fallback\", name=\"Fallback\")\n    )\n</code></pre>"},{"location":"skills/hotdata-pattern/#in-tests","title":"In Tests","text":"<pre><code>def test_snapshot_processing(rich_agent_snapshot):\n    \"\"\"Test uses real pre-computed data.\"\"\"\n    result = process_snapshot(rich_agent_snapshot)\n    assert result.is_valid()\n</code></pre>"},{"location":"skills/hotdata-pattern/#verification","title":"Verification","text":""},{"location":"skills/hotdata-pattern/#check-1-fixture-exists-and-validates","title":"Check 1: Fixture exists and validates","text":"<pre><code>cd impl/claude\npython -c \"\nfrom shared.hotdata import hotdata_registry\nfor name, hd in hotdata_registry._fixtures.items():\n    status = '\u2713' if hd.exists() else '\u2717'\n    fresh = '(fresh)' if hd._is_fresh() else '(stale)'\n    print(f'{status} {name} {fresh}')\n\"\n</code></pre>"},{"location":"skills/hotdata-pattern/#check-2-demo-uses-hotdata","title":"Check 2: Demo uses hotdata","text":"<pre><code>cd impl/claude &amp;&amp; uv run python agents/i/demo_all_screens.py\n# Should load from fixtures, not inline data\n</code></pre>"},{"location":"skills/hotdata-pattern/#check-3-cli-works","title":"Check 3: CLI works","text":"<pre><code>kg fixture list\nkg fixture refresh --all --dry-run\n</code></pre>"},{"location":"skills/hotdata-pattern/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/hotdata-pattern/#1-missing-fallback","title":"1. Missing fallback","text":"<p>Symptom: Demo crashes on fresh clone (no fixtures).</p> <p>Fix: Always provide inline fallback:</p> <pre><code>if HOTDATA.exists():\n    return HOTDATA.load()\nreturn inline_fallback()  # Required!\n</code></pre>"},{"location":"skills/hotdata-pattern/#2-schema-mismatch","title":"2. Schema mismatch","text":"<p>Symptom: <code>ValidationError</code> when loading fixture.</p> <p>Fix: Ensure fixture JSON matches schema. Use <code>kg fixture validate</code>.</p>"},{"location":"skills/hotdata-pattern/#3-stale-fixtures","title":"3. Stale fixtures","text":"<p>Symptom: Demo shows old data.</p> <p>Fix: Set TTL or run <code>kg fixture refresh --all</code>.</p>"},{"location":"skills/hotdata-pattern/#4-generator-not-async","title":"4. Generator not async","text":"<p>Symptom: <code>RuntimeError: coroutine was never awaited</code></p> <p>Fix: Generator functions must be async:</p> <pre><code>async def generate_my_data() -&gt; MyData:  # async!\n    ...\n</code></pre>"},{"location":"skills/hotdata-pattern/#the-hotdata-principle","title":"The HotData Principle","text":"<pre><code>Pre-compute \u2192 Serialize \u2192 Hotload \u2192 (Optionally) Refresh\n     \u2193             \u2193          \u2193                \u2193\n   LLM once    JSON/YAML   Near-zero      LLM only when stale\n</code></pre>"},{"location":"skills/hotdata-pattern/#related-skills","title":"Related Skills","text":"<ul> <li><code>test-patterns.md</code> - Testing conventions</li> <li><code>handler-patterns.md</code> - CLI handler patterns</li> </ul>"},{"location":"skills/hotdata-pattern/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Initial version based on AD-004</li> </ul>"},{"location":"skills/marimo-anywidget/","title":"Skill: Creating Anywidget Widgets for Marimo","text":"<p>\"The widget is a 2-way binding between Python and browser\u2014state made visible.\"</p>"},{"location":"skills/marimo-anywidget/#overview","title":"Overview","text":"<p>Marimo has standardized on anywidget as their third-party plugin API. This skill covers the correct patterns for creating custom widgets that work in marimo notebooks.</p>"},{"location":"skills/marimo-anywidget/#root-cause-of-common-errors","title":"Root Cause of Common Errors","text":""},{"location":"skills/marimo-anywidget/#module-does-not-appear-to-be-a-valid-anywidget-error","title":"\"Module does not appear to be a valid anywidget\" Error","text":"<p>Cause: JavaScript ESM uses wrong export pattern.</p> \u274c WRONG \u2705 CORRECT <code>export function render(...)</code> <code>export default { render }</code> Named export Default export with object <p>The AFM (Anywidget Front-End Module) specification requires a default export that is an object (or function returning an object) with lifecycle methods.</p>"},{"location":"skills/marimo-anywidget/#javascript-esm-requirements","title":"JavaScript ESM Requirements","text":""},{"location":"skills/marimo-anywidget/#minimal-valid-pattern","title":"Minimal Valid Pattern","text":"<pre><code>// widget.js - CORRECT pattern\nfunction render({ model, el }) {\n  // Create DOM elements\n  const div = document.createElement('div');\n  div.textContent = model.get('value');\n  el.appendChild(div);\n\n  // Listen for changes\n  model.on('change:value', () =&gt; {\n    div.textContent = model.get('value');\n  });\n\n  // Optional: return cleanup function\n  return () =&gt; {\n    // cleanup logic\n  };\n}\n\n// REQUIRED: default export with object\nexport default { render };\n</code></pre>"},{"location":"skills/marimo-anywidget/#with-initialize-hook","title":"With Initialize Hook","text":"<pre><code>export default {\n  initialize({ model }) {\n    // Called once per widget instance\n    // Setup shared state\n    console.log('Widget initialized');\n  },\n\n  render({ model, el }) {\n    // Called once per view\n    // Build DOM\n  }\n};\n</code></pre>"},{"location":"skills/marimo-anywidget/#function-export-advanced","title":"Function Export (Advanced)","text":"<pre><code>// For widgets needing shared front-end state\nexport default async () =&gt; {\n  const sharedState = {};\n\n  return {\n    initialize({ model }) {\n      // Access sharedState here\n    },\n    render({ model, el }) {\n      // Access sharedState here\n    }\n  };\n};\n</code></pre>"},{"location":"skills/marimo-anywidget/#python-widget-class","title":"Python Widget Class","text":"<pre><code>from pathlib import Path\nimport anywidget\nimport traitlets\n\n# Use pathlib.Path for external files (NOT string paths)\n_JS_DIR = Path(__file__).parent / \"js\"\n\nclass MyWidget(anywidget.AnyWidget):\n    # Point to external JS file\n    _esm = _JS_DIR / \"my_widget.js\"\n\n    # Optional CSS (can be string or Path)\n    _css = \"\"\"\n    .my-widget {\n        background: #1a1a2e;\n        color: #e0e0e0;\n    }\n    \"\"\"\n\n    # Synced traits (bidirectional Python \u2194 JS)\n    value = traitlets.Unicode(\"\").tag(sync=True)\n    count = traitlets.Int(0).tag(sync=True)\n</code></pre>"},{"location":"skills/marimo-anywidget/#inline-esm-alternative-for-simple-widgets","title":"Inline ESM Alternative (for simple widgets)","text":"<pre><code>class SimpleWidget(anywidget.AnyWidget):\n    _esm = \"\"\"\n    function render({ model, el }) {\n      el.textContent = model.get('value');\n      model.on('change:value', () =&gt; {\n        el.textContent = model.get('value');\n      });\n    }\n    export default { render };\n    \"\"\"\n\n    value = traitlets.Unicode(\"Hello\").tag(sync=True)\n</code></pre>"},{"location":"skills/marimo-anywidget/#marimo-integration","title":"Marimo Integration","text":""},{"location":"skills/marimo-anywidget/#required-wrap-with-mouianywidget","title":"REQUIRED: Wrap with mo.ui.anywidget()","text":"<pre><code>import marimo as mo\nfrom mypackage.widgets import MyWidget\n\n# Create raw widget\nraw_widget = MyWidget(value=\"test\")\n\n# REQUIRED: Wrap for marimo reactivity\nwidget = mo.ui.anywidget(raw_widget)\n\n# Display\nwidget\n</code></pre>"},{"location":"skills/marimo-anywidget/#accessing-widget-value","title":"Accessing Widget Value","text":"<pre><code># In a dependent cell\nwidget.value  # Returns dict of synced traits\n\n# For method calls, use raw widget\nraw_widget.some_method()\n</code></pre>"},{"location":"skills/marimo-anywidget/#model-api-javascript-side","title":"Model API (JavaScript Side)","text":"Method Usage <code>model.get('prop')</code> Read Python-synced property <code>model.set('prop', value)</code> Set property (Python notified) <code>model.save_changes()</code> Batch commit changes to Python <code>model.on('change:prop', fn)</code> Listen to property changes <code>model.off('change:prop', fn)</code> Remove listener"},{"location":"skills/marimo-anywidget/#save-changes-pattern","title":"Save Changes Pattern","text":"<pre><code>// For interactive updates (click handlers, etc.)\nbutton.onclick = () =&gt; {\n  model.set('clicked', true);\n  model.set('count', model.get('count') + 1);\n  model.save_changes();  // Commit both changes\n};\n</code></pre>"},{"location":"skills/marimo-anywidget/#file-structure","title":"File Structure","text":"<pre><code>mypackage/\n\u251c\u2500\u2500 __init__.py\n\u251c\u2500\u2500 widgets/\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 base.py           # Base widget class\n\u2502   \u251c\u2500\u2500 my_widget.py      # Widget Python code\n\u2502   \u2514\u2500\u2500 js/\n\u2502       \u251c\u2500\u2500 my_widget.js  # Widget JavaScript\n\u2502       \u2514\u2500\u2500 shared.js     # Shared utilities\n</code></pre>"},{"location":"skills/marimo-anywidget/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/marimo-anywidget/#1-wrong-export-pattern-most-common","title":"1. Wrong Export Pattern (Most Common!)","text":"<pre><code>// \u274c WRONG - causes \"not valid anywidget\" error\nexport function render({ model, el }) { ... }\n\n// \u2705 CORRECT\nfunction render({ model, el }) { ... }\nexport default { render };\n</code></pre>"},{"location":"skills/marimo-anywidget/#2-string-path-instead-of-pathlibpath","title":"2. String Path Instead of pathlib.Path","text":"<pre><code># \u274c WRONG - may cause path resolution issues\n_esm = \"js/widget.js\"\n\n# \u2705 CORRECT\n_esm = Path(__file__).parent / \"js\" / \"widget.js\"\n</code></pre>"},{"location":"skills/marimo-anywidget/#3-missing-mouianywidget-wrapper","title":"3. Missing mo.ui.anywidget() Wrapper","text":"<pre><code># \u274c WRONG - won't be reactive in marimo\nwidget = MyWidget()\nwidget  # Direct display\n\n# \u2705 CORRECT\nraw = MyWidget()\nwidget = mo.ui.anywidget(raw)\nwidget\n</code></pre>"},{"location":"skills/marimo-anywidget/#4-calling-methods-on-wrapped-widget","title":"4. Calling Methods on Wrapped Widget","text":"<pre><code># \u274c WRONG - wrapper doesn't proxy methods\nwidget = mo.ui.anywidget(MyWidget())\nwidget.update_data(new_data)  # Error!\n\n# \u2705 CORRECT - keep reference to raw widget\nraw = MyWidget()\nwidget = mo.ui.anywidget(raw)\nraw.update_data(new_data)  # Works\n</code></pre>"},{"location":"skills/marimo-anywidget/#5-static-assets-workers-wasm-images","title":"5. Static Assets (Workers, WASM, Images)","text":"<p>External static assets beyond the main JS file are an open problem. See marimo#3279.</p> <p>Workarounds: - Inline scripts when possible - Use CDN URLs for dependencies - Avoid web workers if possible</p>"},{"location":"skills/marimo-anywidget/#development-workflow","title":"Development Workflow","text":""},{"location":"skills/marimo-anywidget/#hot-module-replacement-hmr","title":"Hot Module Replacement (HMR)","text":"<pre><code># Enable HMR for live reload during development\nANYWIDGET_HMR=1 marimo edit notebooks/demo.py\n</code></pre>"},{"location":"skills/marimo-anywidget/#bundling-for-complex-widgets","title":"Bundling (for complex widgets)","text":"<pre><code># Using esbuild (recommended for simplicity)\nnpx esbuild --bundle --format=esm --outdir=mypackage/static src/index.js\n\n# Using Vite (for React/Vue widgets)\nnpx vite build\n</code></pre>"},{"location":"skills/marimo-anywidget/#vite-development-url","title":"Vite Development URL","text":"<pre><code># During development with Vite\nclass DevWidget(anywidget.AnyWidget):\n    _esm = \"http://localhost:5173/src/index.js?anywidget\"\n</code></pre>"},{"location":"skills/marimo-anywidget/#best-practices","title":"Best Practices","text":"<ol> <li> <p>Check existing widgets first: Browse marimo gallery and anywidget.dev</p> </li> <li> <p>Start with wigglystuff: The wigglystuff repo has simple widget examples</p> </li> <li> <p>Use JSDoc for types (avoid TypeScript unless bundling):    <pre><code>/** @param {{ model: any, el: HTMLElement }} context */\nfunction render({ model, el }) { ... }\n</code></pre></p> </li> <li> <p>Return cleanup functions for animations/intervals:    <pre><code>function render({ model, el }) {\n  const id = setInterval(update, 100);\n  return () =&gt; clearInterval(id);\n}\nexport default { render };\n</code></pre></p> </li> <li> <p>Namespace CSS to avoid global conflicts:    <pre><code>.mywidget-container { ... }\n.mywidget-button { ... }\n</code></pre></p> </li> </ol>"},{"location":"skills/marimo-anywidget/#fixing-existing-widgets","title":"Fixing Existing Widgets","text":"<p>To fix the kgents widgets, update each JS file:</p> <pre><code>// Before (WRONG)\nexport function render({ model, el }) {\n  // ... widget code ...\n}\n\n// After (CORRECT)\nfunction render({ model, el }) {\n  // ... widget code ...\n}\nexport default { render };\n</code></pre> <p>Files to update: - <code>impl/claude/agents/i/marimo/widgets/js/stigmergic_field.js</code> - <code>impl/claude/agents/i/marimo/widgets/js/dialectic.js</code> - <code>impl/claude/agents/i/marimo/widgets/js/timeline.js</code></p>"},{"location":"skills/marimo-anywidget/#resources","title":"Resources","text":"<ul> <li>Marimo AnyWidget Docs</li> <li>AnyWidget Getting Started</li> <li>AFM Specification</li> <li>Bundling Guide</li> <li>Marimo Blog: Build plugins with anywidget</li> </ul> <p>\"The noun is a lie. There is only the rate of change. And now, the rate of change is wrapped in <code>mo.ui.anywidget()</code>.\"</p>"},{"location":"skills/marimo-notebook/","title":"Skill: Marimo Notebook (Projection Target)","text":"<p>\"Developers design agents. marimo is a battery, not a burden.\"</p>"},{"location":"skills/marimo-notebook/#overview","title":"Overview","text":"<p>This skill is for framework developers, not agent developers.</p> <p>Agent developers should NOT concern themselves with marimo-specific details. They design state machines and widgets; the Projection Protocol handles the rest. See <code>spec/protocols/projection.md</code>.</p> <p>If you're designing an agent: define your state, extend <code>KgentsWidget</code>, and call <code>.to_marimo()</code>. That's it.</p> <p>This skill documents marimo cell semantics for those extending the projection layer or building custom notebook integrations.</p>"},{"location":"skills/marimo-notebook/#the-projection-integration","title":"The Projection Integration","text":"<p>kgents widgets project to marimo via the <code>to_marimo()</code> method:</p> <pre><code># Agent developer writes:\nwidget = TownWidget(town_state)\n\n# And gets marimo output for free:\nwidget.to_marimo()  # \u2192 HTML/anywidget for notebook display\n</code></pre> <p>The marimo target is one of several (CLI, TUI, JSON, SSE) defined in the Projection Protocol.</p>"},{"location":"skills/marimo-notebook/#cell-semantics-framework-details","title":"Cell Semantics (Framework Details)","text":"<p>Marimo notebooks use a reactive dataflow model where cells automatically re-execute when their dependencies change. Understanding how cell outputs and return values work is critical for building working notebooks.</p>"},{"location":"skills/marimo-notebook/#the-core-rule","title":"The Core Rule","text":"<p>\"The last expression of a cell is its visual output, rendered above the cell.\"</p> <p>This is the most important rule in marimo. Whatever expression evaluates last (before any <code>return</code> statement) becomes the cell's displayed output.</p>"},{"location":"skills/marimo-notebook/#cell-anatomy-display-vs-export","title":"Cell Anatomy: Display vs Export","text":""},{"location":"skills/marimo-notebook/#two-distinct-concepts","title":"Two Distinct Concepts","text":"Concept Mechanism Purpose Display Last expression before <code>return</code> What the user sees Export <code>return (var,)</code> tuple Variables for other cells"},{"location":"skills/marimo-notebook/#the-common-mistake","title":"The Common Mistake","text":"<pre><code># \u274c WRONG - displays docstring, not vstack!\n@app.cell\ndef my_cell(mo):\n    \"\"\"This docstring becomes the last expression before return!\"\"\"\n    return mo.vstack([mo.md(\"Hello\")])  # Exported but not displayed\n</code></pre> <p>In this cell: 1. The docstring <code>\"\"\"...\"\"\"</code> is an expression statement 2. The <code>return</code> exports the vstack 3. But the last expression before return is the docstring 4. Result: The docstring text is displayed instead of the UI!</p>"},{"location":"skills/marimo-notebook/#the-correct-patterns","title":"The Correct Patterns","text":"<p>Pattern 1: Pure Display Cell (no export needed) <pre><code>@app.cell\ndef display_output(mo, data):\n    \"\"\"Documentation for this cell.\"\"\"\n    # Do some computation\n    result = process(data)\n\n    # Last expression = displayed output\n    mo.vstack([\n        mo.md(\"# Results\"),\n        mo.md(f\"Value: {result}\")\n    ])\n</code></pre></p> <p>Pattern 2: Export AND Display <pre><code>@app.cell\ndef compute_and_show(mo, data):\n    \"\"\"Compute result and display it.\"\"\"\n    result = process(data)\n\n    # Create the UI\n    ui = mo.vstack([mo.md(f\"Result: {result}\")])\n\n    # Display it (last expression before return)\n    ui\n\n    # Also export for other cells\n    return (result, ui)\n</code></pre></p> <p>Pattern 3: Pure Compute Cell (no display) <pre><code>@app.cell\ndef compute_only(data):\n    \"\"\"Pure computation, no UI.\"\"\"\n    result = expensive_calculation(data)\n    return (result,)  # Only exports, displays nothing\n</code></pre></p>"},{"location":"skills/marimo-notebook/#the-docstring-trap","title":"The Docstring Trap","text":"<p>Python docstrings are expression statements. They execute and their value (the string) is discarded\u2014BUT in marimo, if it's the last expression before <code>return</code>, it becomes the output!</p> <pre><code># \u274c This displays \"Cell documentation\" not the button!\n@app.cell\ndef broken(mo):\n    \"\"\"Cell documentation\"\"\"\n    return mo.ui.button(label=\"Click me\")\n\n# \u2705 Fixed - make button the last expression\n@app.cell\ndef fixed(mo):\n    \"\"\"Cell documentation\"\"\"\n    button = mo.ui.button(label=\"Click me\")\n    button  # Last expression = displayed\n    return (button,)  # Also export for reactivity\n</code></pre>"},{"location":"skills/marimo-notebook/#marimo-cell-return-semantics","title":"Marimo Cell Return Semantics","text":""},{"location":"skills/marimo-notebook/#return-tuple-format","title":"Return Tuple Format","text":"<pre><code>return (var1, var2, var3)  # Export multiple variables\nreturn (single_var,)       # Export one variable (note the comma!)\nreturn ()                  # Export nothing (side-effect cell)\n</code></pre>"},{"location":"skills/marimo-notebook/#what-return-does-not-do","title":"What Return Does NOT Do","text":"<ul> <li>Return does not display the value</li> <li>Return does not make the value the cell output</li> <li>Return only exports variables to the cell graph</li> </ul>"},{"location":"skills/marimo-notebook/#empty-return-for-side-effect-cells","title":"Empty Return for Side-Effect Cells","text":"<pre><code>@app.cell\ndef handle_click(button, state):\n    \"\"\"Handle button click - pure side effect.\"\"\"\n    if button.value:\n        state.increment()\n    return ()  # No export, no display\n</code></pre>"},{"location":"skills/marimo-notebook/#cell-types-pattern","title":"Cell Types Pattern","text":""},{"location":"skills/marimo-notebook/#1-import-cells","title":"1. Import Cells","text":"<pre><code>@app.cell\ndef imports():\n    import marimo as mo\n    import pandas as pd\n    return mo, pd\n</code></pre>"},{"location":"skills/marimo-notebook/#2-datastate-cells","title":"2. Data/State Cells","text":"<pre><code>@app.cell\ndef create_data(pd):\n    df = pd.DataFrame({\"x\": [1,2,3], \"y\": [4,5,6]})\n    return (df,)\n</code></pre>"},{"location":"skills/marimo-notebook/#3-ui-component-cells","title":"3. UI Component Cells","text":"<pre><code>@app.cell\ndef controls(mo):\n    slider = mo.ui.slider(0, 100, value=50)\n    button = mo.ui.button(label=\"Run\")\n    return slider, button\n</code></pre>"},{"location":"skills/marimo-notebook/#4-display-cells-compose-and-show","title":"4. Display Cells (compose and show)","text":"<pre><code>@app.cell\ndef main_display(mo, slider, button, chart):\n    \"\"\"Main dashboard layout.\"\"\"\n    mo.vstack([\n        mo.md(\"# Dashboard\"),\n        mo.hstack([slider, button]),\n        chart\n    ])\n    # No return - pure display, nothing to export\n</code></pre>"},{"location":"skills/marimo-notebook/#5-handler-cells-react-to-ui","title":"5. Handler Cells (react to UI)","text":"<pre><code>@app.cell\ndef handle_slider(slider, data):\n    \"\"\"Update data based on slider.\"\"\"\n    filtered = data[data.value &gt; slider.value]\n    return (filtered,)\n</code></pre>"},{"location":"skills/marimo-notebook/#reactive-dependencies","title":"Reactive Dependencies","text":"<p>Marimo tracks dependencies by analyzing which variables a cell: - References (reads from other cells) - Defines (exports via return)</p> <pre><code>@app.cell\ndef cell_a():\n    x = 10\n    return (x,)\n\n@app.cell\ndef cell_b(x):  # Depends on cell_a's x\n    y = x * 2\n    return (y,)\n\n@app.cell\ndef cell_c(x, y):  # Depends on both\n    mo.md(f\"x={x}, y={y}\")  # Display\n</code></pre>"},{"location":"skills/marimo-notebook/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/marimo-notebook/#1-docstring-as-output-the-bug-this-skill-addresses","title":"1. Docstring as Output (The Bug This Skill Addresses!)","text":"<pre><code># \u274c Displays docstring\n@app.cell\ndef bad(mo):\n    \"\"\"Main layout.\"\"\"\n    return mo.vstack([...])\n\n# \u2705 Displays vstack\n@app.cell\ndef good(mo):\n    \"\"\"Main layout.\"\"\"\n    mo.vstack([...])  # Last expression\n</code></pre>"},{"location":"skills/marimo-notebook/#2-returning-non-tuple","title":"2. Returning Non-Tuple","text":"<pre><code># \u274c Unclear semantics\nreturn mo.vstack([...])\n\n# \u2705 Explicit tuple\nreturn (my_vstack,)\n</code></pre>"},{"location":"skills/marimo-notebook/#3-forgetting-comma-in-single-element-tuple","title":"3. Forgetting Comma in Single-Element Tuple","text":"<pre><code># \u274c Not a tuple!\nreturn (result)\n\n# \u2705 Single-element tuple\nreturn (result,)\n</code></pre>"},{"location":"skills/marimo-notebook/#4-console-output-vs-cell-output","title":"4. Console Output vs Cell Output","text":"<pre><code># \u274c Print goes to console, not cell output\n@app.cell\ndef bad():\n    print(\"Hello\")  # Goes to console below cell\n\n# \u2705 Use mo.md or mo.output for cell output\n@app.cell\ndef good(mo):\n    mo.md(\"Hello\")  # Cell output\n</code></pre>"},{"location":"skills/marimo-notebook/#5-mutations-across-cells","title":"5. Mutations Across Cells","text":"<pre><code># \u274c Marimo doesn't track mutations\n@app.cell\ndef cell_a():\n    data = []\n    return (data,)\n\n@app.cell\ndef cell_b(data):\n    data.append(1)  # Mutation not tracked!\n    return ()\n\n# \u2705 Create new values instead\n@app.cell\ndef cell_b(data):\n    new_data = data + [1]  # New value\n    return (new_data,)\n</code></pre>"},{"location":"skills/marimo-notebook/#layout-patterns","title":"Layout Patterns","text":""},{"location":"skills/marimo-notebook/#dashboard-layout","title":"Dashboard Layout","text":"<pre><code>@app.cell\ndef dashboard(mo, controls_ui, main_chart, sidebar_data):\n    \"\"\"Full dashboard composition.\"\"\"\n    mo.hstack([\n        mo.vstack([\n            mo.md(\"# Dashboard\"),\n            controls_ui,\n            main_chart\n        ], gap=2),\n        mo.sidebar([\n            mo.md(\"## Info\"),\n            sidebar_data\n        ])\n    ])\n</code></pre>"},{"location":"skills/marimo-notebook/#conditional-display","title":"Conditional Display","text":"<pre><code>@app.cell\ndef conditional(mo, show_details, data):\n    if show_details.value:\n        mo.vstack([\n            mo.md(\"## Details\"),\n            mo.md(f\"```{data}```\")\n        ])\n    else:\n        mo.md(\"_Click to show details_\")\n</code></pre>"},{"location":"skills/marimo-notebook/#debugging-tips","title":"Debugging Tips","text":"<ol> <li>Check last expression: What's the last line before <code>return</code>?</li> <li>Isolate the cell: Comment out return, see what displays</li> <li>Use mo.output.replace(): For imperative debugging</li> <li>Check marimo check: Run <code>marimo check notebook.py</code></li> </ol>"},{"location":"skills/marimo-notebook/#resources","title":"Resources","text":"<ul> <li>Marimo Outputs Guide</li> <li>Marimo Reactivity</li> <li>Marimo Best Practices</li> <li>Marimo Layouts API</li> </ul>"},{"location":"skills/marimo-notebook/#integration-with-projection-protocol","title":"Integration with Projection Protocol","text":"<p>The marimo integration is ONE target in the broader Projection Protocol.</p>"},{"location":"skills/marimo-notebook/#for-agent-developers","title":"For Agent Developers","text":"<p>You don't need this skill. Use the projection layer:</p> <pre><code>from agents.i.reactive import AgentCardWidget, AgentCardState\n\n# Define state\nstate = AgentCardState(name=\"My Agent\", phase=\"active\", activity=(0.3, 0.7), capability=0.85)\n\n# Create widget\nwidget = AgentCardWidget(state)\n\n# Project to ANY target (marimo is just one)\nwidget.to_cli()      # Terminal output\nwidget.to_marimo()   # Notebook output\nwidget.to_json()     # API response\n</code></pre>"},{"location":"skills/marimo-notebook/#for-framework-developers","title":"For Framework Developers","text":"<p>When extending the marimo projection, implement <code>to_marimo()</code> in your widget:</p> <pre><code>class MyWidget(KgentsWidget[MyState]):\n    def project(self, target: RenderTarget) -&gt; Any:\n        s = self.state.value\n        match target:\n            case RenderTarget.MARIMO:\n                # Return HTML for mo.Html() or anywidget instance\n                return f'&lt;div class=\"my-widget\"&gt;{s.content}&lt;/div&gt;'\n            case RenderTarget.CLI:\n                return f\"[{s.label}] {s.content}\"\n            case _:\n                return str(s)\n</code></pre>"},{"location":"skills/marimo-notebook/#the-key-insight","title":"The Key Insight","text":"<p>From <code>meta.md</code>:</p> <p>marimo LogosCell pattern IS AgenteseBridge pattern\u2014direct mapping, no adapter layer needed</p> <p>This means AGENTESE paths work directly in marimo cells without translation.</p>"},{"location":"skills/marimo-notebook/#see-also","title":"See Also","text":"<ul> <li><code>spec/protocols/projection.md</code> \u2014 The Projection Protocol specification</li> <li><code>impl/claude/agents/i/reactive/</code> \u2014 Widget implementation</li> <li><code>impl/claude/protocols/api/turn.py</code> \u2014 Turn projections (to_marimo, to_cli, etc.)</li> </ul> <p>\"Export your data. Display your story. Never confuse the two.\"</p>"},{"location":"skills/modal-scope-branching/","title":"Skill: ModalScope Branching Pattern","text":"<p>Git-like branching for context exploration with merge strategies and budget enforcement.</p> <p>Difficulty: Medium Prerequisites: Reactive primitives, async/await Files: <code>impl/claude/agents/d/modal_scope.py</code> References: <code>agents/d/_tests/test_modal_scope.py</code>, <code>agents/d/context_window.py</code></p>"},{"location":"skills/modal-scope-branching/#overview","title":"Overview","text":"<p>ModalScope provides git-like branching for conversation context. Agents can: - Branch to explore speculative paths - Merge branches back with different strategies - Discard branches, returning entropy budget - Track budget to limit exploration scope</p> Operation Git Equivalent Description <code>branch()</code> <code>git checkout -b</code> Create isolated child scope <code>merge()</code> <code>git merge</code> Integrate branch back to parent <code>discard()</code> <code>git branch -D</code> Compost branch, return entropy <code>duplicate()</code> <code>git clone</code> Independent copy (no parent tracking)"},{"location":"skills/modal-scope-branching/#create-root-scope","title":"Create Root Scope","text":"<pre><code>from agents.d.modal_scope import ModalScope\n\nroot = ModalScope.create_root(\n    max_tokens=100_000,\n    initial_system=\"You are a helpful assistant.\",\n)\n</code></pre> <p>The root scope has full entropy budget (1.0) and no parent.</p>"},{"location":"skills/modal-scope-branching/#branching","title":"Branching","text":""},{"location":"skills/modal-scope-branching/#create-a-branch","title":"Create a Branch","text":"<pre><code>branch = root.branch(\n    name=\"explore-option-a\",\n    budget=0.1,  # 10% of parent tokens allowed\n)\n</code></pre> <p>Parameters: - <code>name</code>: Human-readable branch name (must be unique) - <code>budget</code>: Fraction of parent tokens allowed for growth (0, 1.0] - <code>strategy</code>: Default merge strategy (optional) - <code>commit_message</code>: Purpose description (optional)</p>"},{"location":"skills/modal-scope-branching/#add-content-to-branch","title":"Add Content to Branch","text":"<pre><code>from agents.d.context_window import TurnRole\n\nbranch.window.append(TurnRole.ASSISTANT, \"Let me try approach A...\")\nbranch.window.append(TurnRole.USER, \"What are the tradeoffs?\")\nbranch.window.append(TurnRole.ASSISTANT, \"Approach A is faster but uses more memory...\")\n</code></pre>"},{"location":"skills/modal-scope-branching/#multiple-branches-parallel-exploration","title":"Multiple Branches (Parallel Exploration)","text":"<pre><code>branch_a = root.branch(\"option-a\", budget=0.1)\nbranch_b = root.branch(\"option-b\", budget=0.1)\nbranch_c = root.branch(\"option-c\", budget=0.1)\n\n# Each branch is isolated\nbranch_a.window.append(TurnRole.ASSISTANT, \"Path A: Use recursion\")\nbranch_b.window.append(TurnRole.ASSISTANT, \"Path B: Use iteration\")\nbranch_c.window.append(TurnRole.ASSISTANT, \"Path C: Use dynamic programming\")\n</code></pre>"},{"location":"skills/modal-scope-branching/#merge-strategies","title":"Merge Strategies","text":""},{"location":"skills/modal-scope-branching/#summarize-default","title":"SUMMARIZE (Default)","text":"<p>Compresses branch turns into a summary system message:</p> <pre><code>from agents.d.modal_scope import MergeStrategy\n\nresult = root.merge(branch_a, strategy=MergeStrategy.SUMMARIZE)\n\n# Result contains summary of branch exploration\nprint(result.summary)\n</code></pre>"},{"location":"skills/modal-scope-branching/#squash","title":"SQUASH","text":"<p>Creates a single turn with key assistant decisions:</p> <pre><code>result = root.merge(branch_a, strategy=MergeStrategy.SQUASH)\n# Single assistant turn with \"Key outputs:\" prefix\n</code></pre>"},{"location":"skills/modal-scope-branching/#rebase","title":"REBASE","text":"<p>Replays all branch turns onto parent:</p> <pre><code>result = root.merge(branch_a, strategy=MergeStrategy.REBASE)\n# All turns added to parent in order\nprint(f\"Added {result.merged_turns} turns\")\n</code></pre>"},{"location":"skills/modal-scope-branching/#merge-result","title":"Merge Result","text":"<pre><code>from agents.d.modal_scope import MergeResult\n\nresult: MergeResult = root.merge(branch)\nif result.success:\n    print(f\"Merged {result.merged_turns} turns\")\n    print(f\"Strategy: {result.strategy.value}\")\n    print(f\"Tokens added: {result.tokens_added}\")\nelse:\n    print(f\"Merge failed: {result.error}\")\n</code></pre>"},{"location":"skills/modal-scope-branching/#discard-branches","title":"Discard Branches","text":"<p>When exploration isn't fruitful, discard the branch:</p> <pre><code>from agents.d.modal_scope import DiscardResult\n\nresult: DiscardResult = root.discard(branch_b)\nif result.success:\n    print(f\"Discarded {result.discarded_turns} turns\")\n    print(f\"Entropy returned: {result.entropy_returned:.3f}\")\n</code></pre> <p>The entropy budget is returned to the parent.</p>"},{"location":"skills/modal-scope-branching/#budget-enforcement","title":"Budget Enforcement","text":"<p>Branches have entropy budgets to limit exploration scope.</p>"},{"location":"skills/modal-scope-branching/#check-budget-status","title":"Check Budget Status","text":"<pre><code>print(f\"Budget remaining: {branch.budget_remaining:.1%}\")\nprint(f\"Tokens remaining: {branch.tokens_remaining}\")\nprint(f\"Over budget: {branch.is_over_budget}\")\n</code></pre>"},{"location":"skills/modal-scope-branching/#budget-calculation","title":"Budget Calculation","text":"<pre><code>allowed_growth = parent_tokens * entropy_budget\nbudget_remaining = 1.0 - (current_growth / allowed_growth)\n</code></pre> <p>Example: With parent at 1000 tokens and budget=0.1, branch can grow by 100 tokens.</p>"},{"location":"skills/modal-scope-branching/#duplicate-independent-copy","title":"Duplicate (Independent Copy)","text":"<p>Unlike <code>branch()</code>, <code>duplicate()</code> creates a completely independent scope:</p> <pre><code>scope_b = scope_a.duplicate()\n\n# Both can evolve independently\n# No merge/discard semantics needed\n</code></pre> <p>Use <code>duplicate()</code> when you don't need to merge back.</p>"},{"location":"skills/modal-scope-branching/#state-queries","title":"State Queries","text":"<pre><code># Check scope status\nprint(scope.is_root)      # True if no parent\nprint(scope.is_active)    # True if not merged/discarded\nprint(scope.depth)        # Nesting level (root = 0)\n\n# List children\nfor child in scope.children:\n    print(f\"  {child.branch_name}: {child.depth}\")\n\n# Get specific child\noption_a = scope.get_child(\"option-a\")\n</code></pre>"},{"location":"skills/modal-scope-branching/#serialization","title":"Serialization","text":"<pre><code># Save scope tree\ndata = root.to_dict()\n\n# Restore later\nrestored = ModalScope.from_dict(data)\n</code></pre> <p>Children are serialized recursively.</p>"},{"location":"skills/modal-scope-branching/#full-example","title":"Full Example","text":"<pre><code>from agents.d.modal_scope import ModalScope, MergeStrategy\nfrom agents.d.context_window import TurnRole\n\n# Create root\nroot = ModalScope.create_root(max_tokens=8000)\nroot.window.append(TurnRole.USER, \"What's the best sorting algorithm?\")\n\n# Branch for two approaches\nquick_sort = root.branch(\"quick-sort\", budget=0.15)\nquick_sort.window.append(\n    TurnRole.ASSISTANT,\n    \"QuickSort: O(n log n) average, O(n^2) worst case. In-place.\"\n)\n\nmerge_sort = root.branch(\"merge-sort\", budget=0.15)\nmerge_sort.window.append(\n    TurnRole.ASSISTANT,\n    \"MergeSort: O(n log n) guaranteed. Stable but uses O(n) space.\"\n)\n\n# Evaluate and decide\n# ... (some evaluation logic)\n\n# Merge the better option\nresult = root.merge(quick_sort, strategy=MergeStrategy.SUMMARIZE)\nprint(f\"Merged quick-sort: {result.summary[:100]}...\")\n\n# Discard the other\nroot.discard(merge_sort)\n\n# Continue conversation\nroot.window.append(TurnRole.USER, \"Thanks! Can you show me the code?\")\n</code></pre>"},{"location":"skills/modal-scope-branching/#verification","title":"Verification","text":"<pre><code>cd impl/claude\nuv run pytest agents/d/_tests/test_modal_scope.py -v\n</code></pre>"},{"location":"skills/modal-scope-branching/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/modal-scope-branching/#1-branching-from-mergeddiscarded-scope","title":"1. Branching from Merged/Discarded Scope","text":"<pre><code># This raises ValueError\nroot.merge(branch)\nbranch.branch(\"sub\")  # Error: Cannot branch from merged scope\n</code></pre>"},{"location":"skills/modal-scope-branching/#2-duplicate-branch-names","title":"2. Duplicate Branch Names","text":"<pre><code>root.branch(\"explore\")\nroot.branch(\"explore\")  # Error: Branch 'explore' already exists\n</code></pre>"},{"location":"skills/modal-scope-branching/#3-merging-non-child","title":"3. Merging Non-Child","text":"<pre><code># This fails\nother_root = ModalScope.create_root()\nresult = root.merge(other_root)  # Error: not a child\n</code></pre>"},{"location":"skills/modal-scope-branching/#agentese-integration","title":"AGENTESE Integration","text":"<p>ModalScope maps to AGENTESE void.entropy paths:</p> <pre><code>void.entropy.sip branch_name=explore \u2192 ModalScope.branch()\nvoid.entropy.pour action=merge \u2192 ModalScope.merge()\nvoid.entropy.pour action=discard \u2192 ModalScope.discard()\n</code></pre>"},{"location":"skills/modal-scope-branching/#related-skills","title":"Related Skills","text":"<ul> <li>reactive-primitives - Signal/Computed for state</li> <li>test-patterns - Testing branch scenarios</li> <li>building-agent - Agent composition</li> </ul>"},{"location":"skills/modal-scope-branching/#source-reference","title":"Source Reference","text":"<p><code>impl/claude/agents/d/modal_scope.py:72-615</code></p> <p>Skill created: 2025-12-14 | Wave 1 EDUCATE Phase</p>"},{"location":"skills/plan-file/","title":"Skill: Writing Plan Files (Forest Protocol)","text":"<p>Create and maintain plan files following the Forest Protocol for multi-session coordination.</p> <p>Difficulty: Easy Prerequisites: Understanding of YAML headers, markdown Files Touched: <code>plans/&lt;category&gt;/&lt;name&gt;.md</code>, <code>plans/_forest.md</code></p>"},{"location":"skills/plan-file/#overview","title":"Overview","text":"<p>Plan files are the coordination mechanism for multi-session work. They follow the Forest Protocol (see <code>plans/principles.md</code>) with these key features:</p> Element Purpose YAML Header Machine-readable metadata for aggregation Status Lifecycle state (dormant, active, blocked, complete) Blockers Explicit dependencies on other plans or decisions Session Notes Breadcrumbs for continuity across sessions Chunks Parallelizable units of work"},{"location":"skills/plan-file/#step-by-step-create-a-plan-file","title":"Step-by-Step: Create a Plan File","text":""},{"location":"skills/plan-file/#step-1-choose-location","title":"Step 1: Choose Location","text":"<p>Plans are organized by category:</p> <pre><code>plans/\n\u251c\u2500\u2500 self/       # Internal systems (I-gent, memory, interface)\n\u251c\u2500\u2500 concept/    # Abstract concepts (creativity, lattice)\n\u251c\u2500\u2500 void/       # Entropy, Accursed Share\n\u251c\u2500\u2500 agents/     # Agent implementations (semaphores, k-gent)\n\u251c\u2500\u2500 world/      # External integrations (k8s, APIs)\n\u2514\u2500\u2500 meta/       # Planning system itself\n</code></pre>"},{"location":"skills/plan-file/#step-2-create-yaml-header","title":"Step 2: Create YAML Header","text":"<p>Every plan file starts with a machine-readable header:</p> <p>Template: <pre><code>---\npath: &lt;category&gt;/&lt;name&gt;\nstatus: dormant          # dormant | active | blocked | complete\nprogress: 0              # 0-100 percentage\nlast_touched: YYYY-MM-DD\ntouched_by: claude-opus-4.5\nblocking: []             # What this plan is waiting on\nenables: []              # What plans depend on this\nsession_notes: |\n  Initial creation. No work done yet.\n---\n</code></pre></p> <p>Example: <pre><code>---\npath: agents/k-gent\nstatus: active\nprogress: 40\nlast_touched: 2025-12-12\ntouched_by: claude-opus-4.5\nblocking: []\nenables: [self/memory]\nsession_notes: |\n  Phase 1 (CLI) complete. Phase 2 (Soul framework) in progress.\n  Blocked on: nothing\n  Next: Wire CLI to Soul eigenvector extraction\n---\n</code></pre></p>"},{"location":"skills/plan-file/#step-3-write-the-body","title":"Step 3: Write the Body","text":"<p>The body follows this structure:</p> <p><pre><code># &lt;Title&gt;: &lt;Subtitle&gt;\n\n&gt; *\"Optional thematic quote\"*\n\n**AGENTESE Context**: `self.&lt;path&gt;.*` (if applicable)\n**Status**: &lt;status&gt; (&lt;test count&gt;)\n**Principles**: Which principles this aligns with\n**Cross-refs**: Related plans, specs\n\n---\n\n## Core Insight\n\nWhat is the key idea? Why does this matter?\n\n---\n\n## Implementation Phases\n\n### Phase 1: &lt;Name&gt;\n\n**Goal**: What this phase achieves.\n\n**Files**:\n</code></pre> impl/claude/... <pre><code>**Exit Criteria**: How to know this phase is done.\n\n### Phase 2: &lt;Name&gt;\n\n...\n\n---\n\n## Key Types / API\n\nCode examples or type definitions if relevant.\n\n---\n\n## Cross-References\n\n- **Spec**: Links to spec files\n- **Plan**: Links to related plans\n- **Impl**: Links to implementation files\n</code></pre></p>"},{"location":"skills/plan-file/#step-by-step-update-status","title":"Step-by-Step: Update Status","text":""},{"location":"skills/plan-file/#step-1-update-header","title":"Step 1: Update Header","text":"<p>When status changes, update the YAML header:</p> <pre><code>---\npath: agents/semaphores\nstatus: complete          # Changed from active\nprogress: 100             # Changed from 85\nlast_touched: 2025-12-12  # Today\ntouched_by: claude-opus-4.5\nsession_notes: |\n  ALL PHASES COMPLETE (182 tests).\n  Ready for archive.\n---\n</code></pre>"},{"location":"skills/plan-file/#step-2-add-session-notes","title":"Step 2: Add Session Notes","text":"<p>Session notes should be brief and useful for the next session:</p> <pre><code>session_notes: |\n  Phase 2 in progress. FluxAgent ejection working.\n  Blocked on: DurablePurgatory needs D-gent integration\n  Insight: Perturbation queue reuse simplifies re-injection\n  Next: Complete Phase 3 (Symbiont integration)\n</code></pre>"},{"location":"skills/plan-file/#step-3-status-lifecycle","title":"Step 3: Status Lifecycle","text":"Status Meaning When to Use <code>dormant</code> Awaiting attention New plan, or paused work <code>active</code> Work in progress Currently being developed <code>blocked</code> Dependencies unmet Waiting on other plans/decisions <code>complete</code> All work done Ready to archive"},{"location":"skills/plan-file/#step-by-step-declare-blockers","title":"Step-by-Step: Declare Blockers","text":""},{"location":"skills/plan-file/#step-1-add-to-blocking-array","title":"Step 1: Add to blocking Array","text":"<pre><code>blocking: [self/stream, decision/database-choice]\n</code></pre>"},{"location":"skills/plan-file/#step-2-types-of-blockers","title":"Step 2: Types of Blockers","text":"Type Format Example Plan dependency <code>&lt;category&gt;/&lt;name&gt;</code> <code>self/stream</code> Decision needed <code>decision/&lt;topic&gt;</code> <code>decision/storage-backend</code> External <code>external/&lt;resource&gt;</code> <code>external/k8s-access</code> Context <code>context/&lt;topic&gt;</code> <code>context/research-needed</code>"},{"location":"skills/plan-file/#step-3-update-enables-in-dependency","title":"Step 3: Update enables in Dependency","text":"<p>When plan A blocks plan B, update A's <code>enables</code>:</p> <pre><code># In self/stream.md\nenables: [self/memory]\n</code></pre>"},{"location":"skills/plan-file/#step-by-step-chunk-work","title":"Step-by-Step: Chunk Work","text":"<p>Break plans into parallelizable chunks:</p>"},{"location":"skills/plan-file/#step-1-define-chunks","title":"Step 1: Define Chunks","text":"<pre><code>## Chunks\n\n### Chunk 1: Core Types (1-2 hours)\n- Define SemaphoreToken dataclass\n- Define ReentryContext dataclass\n- Create Purgatory store\n- **Exit criteria**: 49 tests pass\n\n### Chunk 2: Flux Integration (2 hours)\n- Add ejection logic to FluxAgent\n- Wire perturbation re-injection\n- **Exit criteria**: Can eject and resume\n\n### Chunk 3: CLI (1 hour)\n- Add semaphore handler\n- Wire subcommands\n- **Exit criteria**: `kgents semaphore list` works\n</code></pre>"},{"location":"skills/plan-file/#step-2-chunk-design-principles","title":"Step 2: Chunk Design Principles","text":"<ul> <li>Each chunk has clear exit criteria</li> <li>Chunks can be interleaved with other plan chunks</li> <li>A session can complete Chunk 1 of Plan A, then Chunk 1 of Plan B</li> </ul>"},{"location":"skills/plan-file/#step-by-step-archive-completed-plan","title":"Step-by-Step: Archive Completed Plan","text":""},{"location":"skills/plan-file/#step-1-update-status-to-complete","title":"Step 1: Update Status to Complete","text":"<pre><code>status: complete\nprogress: 100\n</code></pre>"},{"location":"skills/plan-file/#step-2-move-to-_archive","title":"Step 2: Move to _archive","text":"<pre><code>mv plans/agents/semaphores.md plans/_archive/agents/semaphores-2025-12.md\n</code></pre>"},{"location":"skills/plan-file/#step-3-keep-reference-in-enables","title":"Step 3: Keep Reference in Enables","text":"<p>Plans that depended on this can now proceed. Their <code>blocking</code> array should be empty.</p>"},{"location":"skills/plan-file/#verification","title":"Verification","text":""},{"location":"skills/plan-file/#check-1-valid-yaml-header","title":"Check 1: Valid YAML header","text":"<pre><code>cd impl/claude\nuv run python -c \"\nimport yaml\nwith open('../../plans/agents/k-gent.md') as f:\n    content = f.read()\n    header = content.split('---')[1]\n    data = yaml.safe_load(header)\n    print(f'Status: {data[\\\"status\\\"]}')\n    print(f'Progress: {data[\\\"progress\\\"]}%')\n\"\n</code></pre>"},{"location":"skills/plan-file/#check-2-forest-aggregation","title":"Check 2: Forest aggregation","text":"<p><code>plans/_forest.md</code> should reflect your plan. This file is auto-generated from headers.</p>"},{"location":"skills/plan-file/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/plan-file/#1-missing-yaml-header","title":"1. Missing YAML header","text":"<p>Symptom: Plan doesn't appear in <code>_forest.md</code> aggregation.</p> <p>Fix: Every plan file needs the YAML header between <code>---</code> delimiters.</p>"},{"location":"skills/plan-file/#2-invalid-status","title":"2. Invalid status","text":"<p>Wrong: <pre><code>status: in-progress  # Not a valid status\n</code></pre></p> <p>Right: <pre><code>status: active\n</code></pre></p> <p>Valid values: <code>dormant</code>, <code>active</code>, <code>blocked</code>, <code>complete</code></p>"},{"location":"skills/plan-file/#3-blocker-without-enables","title":"3. Blocker without enables","text":"<p>Symptom: Dependency graph is incomplete.</p> <p>Fix: When A blocks B, update A's <code>enables</code> array: <pre><code># In A.md\nenables: [path/to/B]\n\n# In B.md\nblocking: [path/to/A]\n</code></pre></p>"},{"location":"skills/plan-file/#4-session-notes-too-verbose","title":"4. Session notes too verbose","text":"<p>Wrong: <pre><code>session_notes: |\n  Today I worked on the semaphore system. First I created the token\n  dataclass, then I added the reason enum. The Purgatory store was\n  tricky because I had to think about serialization...\n</code></pre></p> <p>Right: <pre><code>session_notes: |\n  Phase 1 complete (49 tests). Serialization resolved via pickle.\n  Next: FluxAgent integration\n</code></pre></p>"},{"location":"skills/plan-file/#5-progress-percentage-mismatch","title":"5. Progress percentage mismatch","text":"<p>Symptom: Progress says 80% but work clearly isn't done.</p> <p>Fix: Progress should reflect phases completed: - Phase 1 done = 25% - Phase 2 done = 50% - Phase 3 done = 75% - Phase 4 done = 100%</p>"},{"location":"skills/plan-file/#real-example-agent-semaphores-plan","title":"Real Example: Agent Semaphores Plan","text":"<p>The <code>plans/agents/semaphores.md</code> demonstrates:</p> <ol> <li>Complete YAML header with all fields</li> <li>Rich session notes summarizing all phases</li> <li>Clear phase breakdown (6 phases)</li> <li>Cross-references to specs and impl</li> <li>Key types with code examples</li> <li>Status: complete with test count</li> </ol>"},{"location":"skills/plan-file/#related-skills","title":"Related Skills","text":"<ul> <li>None (this is a meta-skill for planning)</li> </ul>"},{"location":"skills/plan-file/#changelog","title":"Changelog","text":"<ul> <li>2025-12-12: Initial version based on Forest Protocol</li> </ul>"},{"location":"skills/polynomial-agent/","title":"Skill: Building a Polynomial Agent","text":"<p>Create a state-machine agent with mode-dependent behavior using the polynomial functor architecture.</p> <p>Difficulty: Medium-Advanced Prerequisites: Understanding of Agent[A, B], state machines, category theory basics Files Touched: <code>impl/claude/agents/&lt;letter&gt;/polynomial.py</code>, <code>impl/claude/agents/poly/</code>, tests References: <code>docs/architecture/polyfunctor.md</code>, <code>spec/architecture/polyfunctor.md</code></p>"},{"location":"skills/polynomial-agent/#overview","title":"Overview","text":"<p>A Polynomial Agent extends the basic <code>Agent[A, B]</code> pattern to capture mode-dependent behavior\u2014agents that behave differently based on their internal state.</p>"},{"location":"skills/polynomial-agent/#the-key-insight","title":"The Key Insight","text":"<pre><code>Agent[A, B] \u2245 A \u2192 B         # Stateless transformation (a lie)\nPolyAgent[S, A, B]          # State-dependent behavior (the truth)\n</code></pre> <p>Traditional <code>Agent[A, B]</code> misses a critical aspect: real agents have modes. A file system agent in \"reading\" mode accepts different inputs than in \"writing\" mode. The polynomial functor captures this.</p>"},{"location":"skills/polynomial-agent/#when-to-use-polynomial-agents","title":"When to Use Polynomial Agents","text":"Use Case Traditional Agent Polynomial Agent Stateless transform \u2713 \u2713 (degenerates to stateless) Mode-dependent I/O \u2717 \u2713 State machine \u2717 \u2713 Protocol phases \u2717 \u2713 Composable dynamics \u2717 \u2713"},{"location":"skills/polynomial-agent/#the-polynomial-agent-structure","title":"The Polynomial Agent Structure","text":"<p>From <code>impl/claude/agents/poly/protocol.py</code>:</p> <pre><code>PolyAgent[S, A, B] = (\n    positions: FrozenSet[S],          # Valid states\n    directions: S \u2192 FrozenSet[Type],  # State-dependent valid inputs\n    transition: S \u00d7 A \u2192 (S, B)        # State \u00d7 Input \u2192 (NewState, Output)\n)\n</code></pre> <p>Mathematical Interpretation (optional): <pre><code>P(y) = \u03a3_{s \u2208 S} y^{E(s)}\n</code></pre> Where S is positions, E(s) is directions at position s.</p>"},{"location":"skills/polynomial-agent/#step-by-step-creating-a-polynomial-agent","title":"Step-by-Step: Creating a Polynomial Agent","text":""},{"location":"skills/polynomial-agent/#step-1-define-the-state-machine","title":"Step 1: Define the State Machine","text":"<p>Start by identifying the states (positions) your agent needs.</p> <p>Example: Memory Agent States</p> <pre><code>from enum import Enum, auto\n\nclass MemoryPhase(Enum):\n    \"\"\"Positions in the memory polynomial.\"\"\"\n    IDLE = auto()       # Ready for commands\n    LOADING = auto()    # Fetching data\n    STORING = auto()    # Writing data\n    QUERYING = auto()   # Searching\n    FORGETTING = auto() # Clearing data\n</code></pre> <p>Good state design: - Each state represents a distinct mode of operation - States should be exhaustive (cover all cases) - States should be mutually exclusive</p>"},{"location":"skills/polynomial-agent/#step-2-define-direction-functions","title":"Step 2: Define Direction Functions","text":"<p>Directions specify what inputs are valid at each state.</p> <pre><code>def memory_directions(phase: MemoryPhase) -&gt; frozenset[type]:\n    \"\"\"What inputs are valid at each phase?\"\"\"\n    match phase:\n        case MemoryPhase.IDLE:\n            # Can route to any operation\n            return frozenset({LoadCommand, StoreCommand, QueryCommand, ForgetCommand})\n        case MemoryPhase.LOADING:\n            return frozenset({LoadCommand})\n        case MemoryPhase.STORING:\n            return frozenset({StoreCommand})\n        case MemoryPhase.QUERYING:\n            return frozenset({QueryCommand})\n        case MemoryPhase.FORGETTING:\n            return frozenset({ForgetCommand})\n</code></pre> <p>Key principle: The directions function encodes what's valid at each state, not just what's possible.</p>"},{"location":"skills/polynomial-agent/#step-3-define-the-transition-function","title":"Step 3: Define the Transition Function","text":"<p>The core of the polynomial agent: how state and input produce new state and output.</p> <pre><code>def memory_transition(\n    phase: MemoryPhase, input: Any\n) -&gt; tuple[MemoryPhase, Any]:\n    \"\"\"\n    State transition function.\n\n    transition: Phase \u00d7 Command \u2192 (NewPhase, Response)\n    \"\"\"\n    match phase:\n        case MemoryPhase.IDLE:\n            # Route to appropriate phase based on command type\n            if isinstance(input, LoadCommand):\n                return MemoryPhase.LOADING, input\n            elif isinstance(input, StoreCommand):\n                return MemoryPhase.STORING, input\n            # ... etc\n\n        case MemoryPhase.LOADING:\n            cmd = input if isinstance(input, LoadCommand) else LoadCommand()\n            # Perform load operation\n            data = load_from_storage(cmd.key)\n            return MemoryPhase.IDLE, MemoryResponse(success=True, data=data)\n\n        case MemoryPhase.STORING:\n            cmd = input if isinstance(input, StoreCommand) else StoreCommand(state=input)\n            # Perform store operation\n            save_to_storage(cmd.key, cmd.state)\n            return MemoryPhase.IDLE, MemoryResponse(success=True)\n</code></pre>"},{"location":"skills/polynomial-agent/#step-4-create-the-polyagent","title":"Step 4: Create the PolyAgent","text":"<p>Assemble the pieces into a <code>PolyAgent</code>:</p> <pre><code>from agents.poly.protocol import PolyAgent\n\nMEMORY_POLYNOMIAL: PolyAgent[MemoryPhase, Any, Any] = PolyAgent(\n    name=\"MemoryPolynomial\",\n    positions=frozenset(MemoryPhase),\n    _directions=memory_directions,\n    _transition=memory_transition,\n)\n</code></pre>"},{"location":"skills/polynomial-agent/#step-5-create-a-backwards-compatible-wrapper-optional","title":"Step 5: Create a Backwards-Compatible Wrapper (Optional)","text":"<p>For integration with existing code expecting <code>Agent[A, B]</code>:</p> <pre><code>class MemoryPolynomialAgent:\n    \"\"\"\n    Async wrapper providing Agent-like interface.\n    \"\"\"\n\n    def __init__(self, initial_state: Any = None) -&gt; None:\n        self._poly = MEMORY_POLYNOMIAL\n        self._phase = MemoryPhase.IDLE\n        if initial_state is not None:\n            self._store = {\"_default\": initial_state}\n\n    @property\n    def phase(self) -&gt; MemoryPhase:\n        return self._phase\n\n    async def store(self, data: Any, key: str = \"_default\") -&gt; MemoryResponse:\n        \"\"\"Store data (async interface for compatibility).\"\"\"\n        # Route through IDLE\n        self._phase, _ = self._poly.transition(self._phase, StoreCommand(state=data, key=key))\n        # Execute the store\n        self._phase, response = self._poly.transition(self._phase, StoreCommand(state=data, key=key))\n        return response\n</code></pre>"},{"location":"skills/polynomial-agent/#critical-patterns","title":"Critical Patterns","text":""},{"location":"skills/polynomial-agent/#pattern-1-instance-isolation","title":"Pattern 1: Instance Isolation","text":"<p>Problem: Global state causes instances to share memory.</p> <pre><code># BAD: Global state\n_memory_state: dict[str, Any] = {}  # All instances share this!\n\n# GOOD: Per-instance state\nclass MemoryStore:\n    def __init__(self) -&gt; None:\n        self.state: dict[str, Any] = {}\n        self.history: list[Any] = []\n\ndef create_memory_polynomial(store: MemoryStore) -&gt; PolyAgent:\n    \"\"\"Factory creates polynomial with isolated store.\"\"\"\n    def bound_transition(phase, input):\n        return memory_transition(phase, input, store)  # Closure captures store\n    return PolyAgent(..., _transition=bound_transition)\n</code></pre> <p>Always use factory functions for stateful polynomials.</p>"},{"location":"skills/polynomial-agent/#pattern-2-bayesian-confidence","title":"Pattern 2: Bayesian Confidence","text":"<p>When computing confidence from evidence:</p> <pre><code>def compute_confidence(n_supporting: int, n_contradicting: int, prior: float = 0.5) -&gt; float:\n    \"\"\"\n    Bayesian confidence with Laplace smoothing.\n\n    Prevents extreme values (0.0 or 1.0) which cause issues downstream.\n    \"\"\"\n    total = n_supporting + n_contradicting\n    if total == 0:\n        return prior  # No evidence \u2192 return prior\n\n    alpha = 1.0  # Smoothing parameter\n    confidence = (n_supporting + alpha * prior) / (total + alpha)\n\n    # Clamp to reasonable bounds\n    return max(0.05, min(0.95, confidence))\n</code></pre>"},{"location":"skills/polynomial-agent/#pattern-3-input-validation","title":"Pattern 3: Input Validation","text":"<p>Always validate inputs in the transition function:</p> <pre><code>def validate_query(input: Any) -&gt; Query:\n    \"\"\"Normalize and validate input.\"\"\"\n    if input is None:\n        return Query(claim=\"&lt;empty&gt;\")\n\n    if isinstance(input, Query):\n        claim = input.claim.strip() if input.claim else \"&lt;empty&gt;\"\n        if len(claim) &gt; 10000:\n            claim = claim[:10000] + \"... [truncated]\"\n        return Query(claim=claim, context=input.context)\n\n    # Convert to string\n    claim = str(input).strip() or \"&lt;empty&gt;\"\n    return Query(claim=claim)\n</code></pre>"},{"location":"skills/polynomial-agent/#pattern-4-composition-via-wiringdiagram","title":"Pattern 4: Composition via WiringDiagram","text":"<p>Compose polynomial agents:</p> <pre><code>from agents.poly import WiringDiagram, sequential, parallel\n\n# Sequential: soul \u2192 alethic\ndiagram = WiringDiagram(\n    name=\"soul_then_alethic\",\n    left=SOUL_POLYNOMIAL,\n    right=ALETHIC_AGENT,\n)\ncomposed = diagram.compose()\n\n# Parallel: run soul and memory concurrently\npar = parallel(SOUL_POLYNOMIAL, MEMORY_POLYNOMIAL)\n# State is product: (SoulContext, MemoryPhase)\n</code></pre>"},{"location":"skills/polynomial-agent/#testing-polynomial-agents","title":"Testing Polynomial Agents","text":""},{"location":"skills/polynomial-agent/#required-tests","title":"Required Tests","text":"<ol> <li> <p>State Machine Tests <pre><code>def test_all_phases_defined(self) -&gt; None:\n    \"\"\"All phases are defined.\"\"\"\n    for phase in MyPhase:\n        assert phase in MY_POLYNOMIAL.positions\n</code></pre></p> </li> <li> <p>Direction Tests <pre><code>def test_idle_accepts_all_commands(self) -&gt; None:\n    \"\"\"IDLE accepts all command types.\"\"\"\n    dirs = my_directions(MyPhase.IDLE)\n    assert Command1 in dirs\n    assert Command2 in dirs\n</code></pre></p> </li> <li> <p>Transition Tests <pre><code>def test_transition_returns_to_idle(self) -&gt; None:\n    \"\"\"Phase returns to IDLE after operation.\"\"\"\n    new_phase, _ = my_transition(MyPhase.PROCESSING, input)\n    assert new_phase == MyPhase.IDLE\n</code></pre></p> </li> <li> <p>Instance Isolation Tests <pre><code>async def test_instances_are_isolated(self) -&gt; None:\n    \"\"\"Two instances don't share state.\"\"\"\n    agent1 = MyPolynomialAgent()\n    agent2 = MyPolynomialAgent()\n\n    await agent1.store(\"data1\")\n    result = await agent2.load()\n\n    assert result is None  # agent2 shouldn't see agent1's data\n</code></pre></p> </li> <li> <p>Property-Based Tests (optional but recommended)    <pre><code>from hypothesis import given, strategies as st\n\n@given(input_val=st.integers())\ndef test_identity_law(self, input_val: int) -&gt; None:\n    \"\"\"Id &gt;&gt; agent = agent (left identity).\"\"\"\n    composed = sequential(ID, my_agent)\n    _, direct = my_agent.invoke(\"ready\", input_val)\n    _, composed_result = composed.invoke((\"ready\", \"ready\"), input_val)\n    assert direct == composed_result\n</code></pre></p> </li> </ol>"},{"location":"skills/polynomial-agent/#composition-laws","title":"Composition Laws","text":"<p>Polynomial agents must satisfy categorical laws:</p> Law Requirement Test Identity <code>Id &gt;&gt; f = f = f &gt;&gt; Id</code> Compose with identity, verify same output Associativity <code>(f &gt;&gt; g) &gt;&gt; h = f &gt;&gt; (g &gt;&gt; h)</code> Reorder composition, verify same output <p>These are verified in <code>impl/claude/agents/operad/_tests/test_properties.py</code>.</p>"},{"location":"skills/polynomial-agent/#integration-with-existing-architecture","title":"Integration with Existing Architecture","text":""},{"location":"skills/polynomial-agent/#using-primitives","title":"Using Primitives","text":"<p>Polynomial agents can compose the 17 primitives from <code>agents/poly/primitives.py</code>:</p> <pre><code>from agents.poly import GROUND, JUDGE, SUBLATE, SublateState\n\n# Example: Alethic agent composes primitives\ndef alethic_transition(state, input):\n    match state:\n        case AlethicState.GROUNDING:\n            _, grounded = GROUND.invoke(GroundState.FLOATING, input)\n            return AlethicState.DELIBERATING, grounded\n        case AlethicState.JUDGING:\n            _, verdict = JUDGE.invoke(JudgeState.DELIBERATING, claim)\n            return AlethicState.SYNTHESIZING, verdict\n        # ...\n</code></pre>"},{"location":"skills/polynomial-agent/#converting-to-bootstrap-agent","title":"Converting to Bootstrap Agent","text":"<p>Use deprecation sugar for backwards compatibility:</p> <pre><code>from agents.poly import to_bootstrap_agent, from_function\n\n# Create polynomial\npoly = from_function(\"Doubler\", lambda x: x * 2)\n\n# Convert to bootstrap Agent interface\nagent = to_bootstrap_agent(poly)\nresult = await agent.invoke(21)  # Returns 42\n</code></pre>"},{"location":"skills/polynomial-agent/#examples-in-the-codebase","title":"Examples in the Codebase","text":"Agent File States Notes Alethic <code>agents/a/alethic.py</code> GROUNDING, DELIBERATING, JUDGING, SYNTHESIZING Composes GROUND, JUDGE, SUBLATE Soul <code>agents/k/polynomial.py</code> 7 eigenvector contexts Maps to SOUL_SHEAF Memory <code>agents/d/polynomial.py</code> IDLE, LOADING, STORING, QUERYING, STREAMING, FORGETTING Instance isolation pattern Evolution <code>agents/e/polynomial.py</code> IDLE, SUN, MUTATE, SELECT, WAGER, INFECT, PAYOFF, COMPLETE Thermodynamic cycle Citizen <code>agents/town/polynomial.py</code> IDLE, SOCIALIZING, WORKING, REFLECTING, RESTING Right to Rest pattern"},{"location":"skills/polynomial-agent/#case-study-citizenpolynomial","title":"Case Study: CitizenPolynomial","text":"<p>The <code>CitizenPolynomial</code> demonstrates the polynomial functor in Agent Town simulation.</p>"},{"location":"skills/polynomial-agent/#positions-5-phases","title":"Positions (5 Phases)","text":"<pre><code>class CitizenPhase(Enum):\n    IDLE = auto()        # Ready for new interactions\n    SOCIALIZING = auto() # Engaged in social activity\n    WORKING = auto()     # Performing solo work\n    REFLECTING = auto()  # Internal contemplation\n    RESTING = auto()     # Mandatory rest (Right to Rest)\n</code></pre>"},{"location":"skills/polynomial-agent/#directions-mode-dependent-inputs","title":"Directions (Mode-Dependent Inputs)","text":"<pre><code>def citizen_directions(phase: CitizenPhase) -&gt; FrozenSet[Any]:\n    match phase:\n        case CitizenPhase.IDLE:\n            # Can do anything except wake\n            return frozenset({SocializeInput, WorkInput, ReflectInput, RestInput})\n        case CitizenPhase.RESTING:\n            # RIGHT TO REST: Only wake is valid\n            return frozenset({WakeInput})\n        case _:\n            # Contextual options\n            ...\n</code></pre>"},{"location":"skills/polynomial-agent/#the-right-to-rest-pattern","title":"The Right to Rest Pattern","text":"<p>A key design insight: citizens in RESTING phase cannot be disturbed:</p> <pre><code>case CitizenPhase.RESTING:\n    if isinstance(input, WakeInput):\n        return CitizenPhase.IDLE, CitizenOutput(success=True, message=\"Woke from rest\")\n    else:\n        # Reject ALL other inputs\n        return CitizenPhase.RESTING, CitizenOutput(\n            success=False,\n            message=\"Cannot be disturbed while resting (Right to Rest)\",\n        )\n</code></pre> <p>This is enforced by: 1. Directions: Only <code>WakeInput</code> is valid during RESTING 2. Transition: All other inputs return failure without state change</p>"},{"location":"skills/polynomial-agent/#usage","title":"Usage","text":"<pre><code>from agents.town.polynomial import CITIZEN_POLYNOMIAL, CitizenInput, CitizenPhase\n\n# Start idle\nphase = CitizenPhase.IDLE\n\n# Transition to socializing\nphase, output = CITIZEN_POLYNOMIAL.invoke(phase, CitizenInput.greet(\"alice\"))\n# \u2192 (SOCIALIZING, CitizenOutput(success=True, ...))\n\n# Transition to resting\nphase, output = CITIZEN_POLYNOMIAL.invoke(phase, CitizenInput.rest())\n# \u2192 (RESTING, CitizenOutput(success=True, ...))\n\n# Try to interrupt (fails)\nphase, output = CITIZEN_POLYNOMIAL.invoke(phase, CitizenInput.greet(\"bob\"))\n# \u2192 (RESTING, CitizenOutput(success=False, message=\"Cannot be disturbed...\"))\n\n# Wake up\nphase, output = CITIZEN_POLYNOMIAL.invoke(phase, CitizenInput.wake())\n# \u2192 (IDLE, CitizenOutput(success=True, ...))\n</code></pre>"},{"location":"skills/polynomial-agent/#key-insight-barads-agential-realism","title":"Key Insight: Barad's Agential Realism","text":"<p>From the docstring:</p> <p>\"Positions are not states but interpretive frames. The citizen does not 'change state'\u2014the observer makes a different agential cut. Each transition reconfigures the phenomenon, not the entity.\"</p> <p>This philosophical framing helps understand why polynomial agents are powerful: they model mode-dependent behavior as observation-dependent morphisms, not internal state changes</p>"},{"location":"skills/polynomial-agent/#common-mistakes","title":"Common Mistakes","text":"Mistake Problem Solution Global state Instances share memory Use MemoryStore pattern with factory Missing validation Crashes on None/empty Validate all inputs in transition Extreme confidence 0.0 or 1.0 breaks math Use Bayesian smoothing Skipping isolation tests Bugs in production Always test instance isolation Violating category laws Composition breaks Write property-based tests"},{"location":"skills/polynomial-agent/#cross-references","title":"Cross-References","text":"<ul> <li>Spec: <code>spec/architecture/polyfunctor.md</code></li> <li>Impl: <code>impl/claude/agents/poly/</code></li> <li>Tests: <code>impl/claude/agents/*/test_polynomial.py</code></li> <li>Plan: <code>docs/architecture/polyfunctor.md</code></li> <li>Theory: Niu &amp; Spivak, \"Polynomial Functors\"</li> </ul>"},{"location":"skills/react-realtime-debugging/","title":"Skill: React Real-time UI Debugging","text":"<p>Patterns for debugging React applications with real-time features (SSE, WebSockets, live updates).</p>"},{"location":"skills/react-realtime-debugging/#when-to-use","title":"When to Use","text":"<ul> <li>UI loads but doesn't update in real-time</li> <li>SSE/WebSocket connections seem to fail silently</li> <li>State changes don't propagate to visual components</li> <li>\"Works in curl but not in browser\" scenarios</li> </ul>"},{"location":"skills/react-realtime-debugging/#the-debugging-stack","title":"The Debugging Stack","text":""},{"location":"skills/react-realtime-debugging/#1-verify-backend-first","title":"1. Verify Backend First","text":"<p>Always confirm the backend works before debugging frontend:</p> <pre><code># Test SSE endpoint directly\ncurl -N \"http://localhost:8000/v1/town/{id}/live?speed=2&amp;phases=1\" | head -20\n\n# Test through Vite proxy (what browser actually uses)\ncurl -N \"http://localhost:3000/v1/town/{id}/live?speed=2&amp;phases=1\" | head -20\n</code></pre> <p>If curl works but browser doesn't, the issue is frontend.</p>"},{"location":"skills/react-realtime-debugging/#2-check-browser-console","title":"2. Check Browser Console","text":"<p>Add strategic logging at connection points:</p> <pre><code>console.log('[SSE] Connecting to:', url);\nconsole.log('[SSE] Effect deps - autoConnect:', autoConnect, 'isPlaying:', isPlaying);\nconsole.log('[SSE] Event received:', event.type, event.data);\n</code></pre>"},{"location":"skills/react-realtime-debugging/#3-trace-the-state-flow","title":"3. Trace the State Flow","text":"<p>For Zustand stores: 1. Does the action get called? (log in action) 2. Does state update? (React DevTools or log after set) 3. Does component re-render? (log in component body) 4. Does derived data update? (check selectors)</p>"},{"location":"skills/react-realtime-debugging/#common-failure-patterns","title":"Common Failure Patterns","text":""},{"location":"skills/react-realtime-debugging/#pattern-a-immer-mapset-plugin-not-enabled","title":"Pattern A: Immer MapSet Plugin Not Enabled","text":"<p>Symptom: Error about MapSet plugin when store uses <code>Map</code> or <code>Set</code></p> <p>Signal: <pre><code>Error: [Immer] The plugin for 'MapSet' has not been loaded into Immer.\n</code></pre></p> <p>Fix: Enable at app entry point: <pre><code>// main.tsx\nimport { enableMapSet } from 'immer';\nenableMapSet();\n</code></pre></p> <p>Prevention: When creating stores with Map/Set, immediately add the plugin.</p>"},{"location":"skills/react-realtime-debugging/#pattern-b-stale-closures-in-event-handlers","title":"Pattern B: Stale Closures in Event Handlers","text":"<p>Symptom: SSE/WebSocket receives events but state doesn't update, or updates with stale values</p> <p>Signal: Console shows events arriving, but UI frozen or showing old data</p> <p>Cause: Event handlers capture callbacks at creation time, not invocation time:</p> <pre><code>// BAD: handleEvent is stale when eventSource calls it\nconst connect = useCallback(() =&gt; {\n  eventSource.addEventListener('event', (e) =&gt; {\n    handleEvent(JSON.parse(e.data)); // Stale!\n  });\n}, [townId]); // handleEvent not in deps\n</code></pre> <p>Fix: Use a ref to always get fresh handlers:</p> <pre><code>// GOOD: Ref always has current handlers\nconst handlersRef = useRef({ addEvent, updateState });\nhandlersRef.current = { addEvent, updateState }; // Update every render\n\nconst connect = useCallback(() =&gt; {\n  eventSource.addEventListener('event', (e) =&gt; {\n    handlersRef.current.addEvent(JSON.parse(e.data)); // Fresh!\n  });\n}, [townId]); // No closure dependency needed\n</code></pre>"},{"location":"skills/react-realtime-debugging/#pattern-c-silent-api-failures","title":"Pattern C: Silent API Failures","text":"<p>Symptom: Page shows nothing, no errors visible</p> <p>Signal: Network tab shows 404/500, but UI just blank</p> <p>Cause: Error caught but not surfaced:</p> <pre><code>// BAD: Silent failure\ntry {\n  const data = await api.get(id);\n  setState(data);\n} catch (err) {\n  console.error(err); // Only in console\n}\n</code></pre> <p>Fix: Always have explicit loading/error/success states:</p> <pre><code>// GOOD: Explicit state machine\nconst [state, setState] = useState&lt;'loading' | 'loaded' | 'error'&gt;('loading');\nconst [error, setError] = useState&lt;string | null&gt;(null);\n\ntry {\n  setState('loading');\n  const data = await api.get(id);\n  setState('loaded');\n} catch (err) {\n  setError(err.message);\n  setState('error');\n}\n\n// Render different UI for each state\nif (state === 'loading') return &lt;Spinner /&gt;;\nif (state === 'error') return &lt;ErrorPage message={error} /&gt;;\nreturn &lt;Content /&gt;;\n</code></pre>"},{"location":"skills/react-realtime-debugging/#pattern-d-react-navigation-timing-issues","title":"Pattern D: React Navigation Timing Issues","text":"<p>Symptom: After <code>navigate()</code>, component shows stale data or re-fetches incorrectly</p> <p>Signal: URL changes but data doesn't match, or unnecessary API calls</p> <p>Cause: <code>navigate()</code> can cause component remount or effect re-runs with timing issues</p> <p>Fix: For same-component URL updates, use <code>history.replaceState</code>:</p> <pre><code>// When staying in same component but updating URL\nwindow.history.replaceState(null, '', `/town/${newId}`);\n\n// Then update state directly instead of relying on param change\nsetTownId(newId);\nsetCitizens(data.citizens);\n</code></pre>"},{"location":"skills/react-realtime-debugging/#pattern-e-effect-dependency-array-issues","title":"Pattern E: Effect Dependency Array Issues","text":"<p>Symptom: Effect doesn't run when expected, or runs too often</p> <p>Signal: Console logs show effect not triggering on state change</p> <p>Cause: Missing dependencies or callback identity changes:</p> <pre><code>// BAD: townId changes won't trigger because connect has stale townId\nuseEffect(() =&gt; {\n  if (isPlaying) connect();\n}, [isPlaying, connect]); // connect depends on townId but effect doesn't see it\n\n// GOOD: Include all relevant state\nuseEffect(() =&gt; {\n  if (isPlaying &amp;&amp; townId) connect();\n}, [isPlaying, townId, connect]);\n</code></pre>"},{"location":"skills/react-realtime-debugging/#debugging-checklist","title":"Debugging Checklist","text":"<pre><code>[ ] Backend endpoint works via curl?\n[ ] Vite proxy forwards requests correctly?\n[ ] Immer plugins enabled for Map/Set?\n[ ] Loading/error states render visibly?\n[ ] SSE/WS connection established? (check Network tab)\n[ ] Events received? (console.log in handler)\n[ ] State updates? (React DevTools or logs)\n[ ] Component re-renders? (log in component body)\n[ ] No stale closures? (use refs for event handlers)\n[ ] Effect dependencies complete?\n</code></pre>"},{"location":"skills/react-realtime-debugging/#testing-real-time-features","title":"Testing Real-time Features","text":"<pre><code>// Mock SSE for unit tests\nclass MockEventSource {\n  listeners: Record&lt;string, Function[]&gt; = {};\n\n  addEventListener(type: string, fn: Function) {\n    this.listeners[type] = [...(this.listeners[type] || []), fn];\n  }\n\n  emit(type: string, data: unknown) {\n    this.listeners[type]?.forEach(fn =&gt; fn({ data: JSON.stringify(data) }));\n  }\n}\n\n// In test\nconst mockSSE = new MockEventSource();\nvi.stubGlobal('EventSource', vi.fn(() =&gt; mockSSE));\n\n// Trigger event\nmockSSE.emit('live.event', { operation: 'greet', participants: ['A', 'B'] });\n\n// Assert state updated\nexpect(store.getState().events).toHaveLength(1);\n</code></pre>"},{"location":"skills/react-realtime-debugging/#related-skills","title":"Related Skills","text":"<ul> <li><code>test-patterns.md</code> - Testing conventions</li> <li><code>agent-town-visualization.md</code> - Town UI specifics</li> <li><code>handler-patterns.md</code> - Backend handler patterns</li> </ul>"},{"location":"skills/react-realtime-debugging/#anti-patterns","title":"Anti-Patterns","text":"<ul> <li>Don't ignore loading states: \"It works on my machine\" often means slow network reveals race conditions</li> <li>Don't trust silent catch blocks: Every catch should surface to UI or logging</li> <li>Don't use <code>navigate()</code> for same-component updates: Use history API or state directly</li> <li>Don't put callbacks in effect deps without understanding identity: Wrap in useCallback or use refs</li> </ul>"},{"location":"skills/reactive-primitives/","title":"Skill: Reactive Primitives Pattern","text":"<p>Build target-agnostic reactive UIs using Signal, Computed, and Effect.</p> <p>Difficulty: Easy-Medium Prerequisites: Python dataclasses, callbacks Files: <code>impl/claude/agents/i/reactive/signal.py</code> References: <code>agents/i/reactive/_tests/test_wave1_stress.py</code>, <code>agents/i/reactive/_tests/test_time_travel.py</code></p>"},{"location":"skills/reactive-primitives/#overview","title":"Overview","text":"<p>Signal, Computed, and Effect form the reactive foundation for kgents visualization. These primitives are target-agnostic: the same code renders to CLI, TUI, marimo, or custom targets.</p> Primitive Purpose Equivalent <code>Signal[T]</code> Observable state React <code>useState</code>, Solid <code>createSignal</code> <code>Computed[T]</code> Derived state (lazy) React <code>useMemo</code>, Solid <code>createMemo</code> <code>Effect</code> Side effects React <code>useEffect</code>"},{"location":"skills/reactive-primitives/#signalt-observable-state","title":"Signal[T]: Observable State","text":"<p>A Signal holds a value and notifies subscribers when it changes.</p>"},{"location":"skills/reactive-primitives/#create-a-signal","title":"Create a Signal","text":"<pre><code>from agents.i.reactive.signal import Signal\n\ncount = Signal.of(0)\nname = Signal.of(\"kgent\")\nitems = Signal.of([\"a\", \"b\", \"c\"])\n</code></pre>"},{"location":"skills/reactive-primitives/#read-and-update","title":"Read and Update","text":"<pre><code># Read (immutable access)\nprint(count.value)  # 0\n\n# Set (notifies if changed)\ncount.set(5)\n\n# Update via function\ncount.update(lambda x: x + 1)  # Now 6\n</code></pre>"},{"location":"skills/reactive-primitives/#subscribe-to-changes","title":"Subscribe to Changes","text":"<pre><code>def on_change(new_value: int) -&gt; None:\n    print(f\"Count changed to: {new_value}\")\n\nunsub = count.subscribe(on_change)\ncount.set(10)  # Prints: \"Count changed to: 10\"\n\nunsub()  # Stop receiving updates\n</code></pre>"},{"location":"skills/reactive-primitives/#time-travel-snapshotrestore","title":"Time Travel (Snapshot/Restore)","text":"<p>Signals support checkpointing for branching exploration:</p> <pre><code>from agents.i.reactive.signal import Signal, Snapshot\n\nsig = Signal.of(42)\nsnap = sig.snapshot()  # Capture current state\n\nsig.set(100)  # Explore different path\nsig.set(200)\nprint(sig.value)  # 200\n\nsig.restore(snap)  # Return to checkpoint\nprint(sig.value)  # 42\n</code></pre> <p>Key: Restore notifies subscribers if value changes, but generation continues forward.</p>"},{"location":"skills/reactive-primitives/#computedt-derived-state","title":"Computed[T]: Derived State","text":"<p>Computed values auto-update when dependencies change. They're lazy (only recompute on access).</p>"},{"location":"skills/reactive-primitives/#create-from-signalmap","title":"Create from Signal.map()","text":"<pre><code>count = Signal.of(5)\ndoubled = count.map(lambda x: x * 2)\n\nprint(doubled.value)  # 10\ncount.set(10)\nprint(doubled.value)  # 20 (auto-updated)\n</code></pre>"},{"location":"skills/reactive-primitives/#create-with-multiple-sources","title":"Create with Multiple Sources","text":"<pre><code>from agents.i.reactive.signal import Computed\n\nfirst = Signal.of(\"Ada\")\nlast = Signal.of(\"Lovelace\")\n\nfull_name = Computed.of(\n    compute=lambda: f\"{first.value} {last.value}\",\n    sources=[first, last],\n)\n\nprint(full_name.value)  # \"Ada Lovelace\"\nfirst.set(\"Grace\")\nprint(full_name.value)  # \"Grace Lovelace\"\n</code></pre>"},{"location":"skills/reactive-primitives/#chain-computed-values","title":"Chain Computed Values","text":"<pre><code>count = Signal.of(1)\ndoubled = count.map(lambda x: x * 2)\nmessage = doubled.map(lambda x: f\"Result: {x}\")\n\nprint(message.value)  # \"Result: 2\"\ncount.set(5)\nprint(message.value)  # \"Result: 10\"\n</code></pre>"},{"location":"skills/reactive-primitives/#cleanup","title":"Cleanup","text":"<pre><code>computed.dispose()  # Unsubscribe from all sources\n</code></pre>"},{"location":"skills/reactive-primitives/#effect-side-effects","title":"Effect: Side Effects","text":"<p>Effects bridge reactive state and the outside world (logging, network, DOM).</p>"},{"location":"skills/reactive-primitives/#create-an-effect","title":"Create an Effect","text":"<pre><code>from agents.i.reactive.signal import Effect\n\ncount = Signal.of(0)\n\ndef log_count() -&gt; None:\n    print(f\"Count is now: {count.value}\")\n    return None  # No cleanup needed\n\neffect = Effect.of(fn=log_count, sources=[count])\neffect.run()  # Prints: \"Count is now: 0\"\n\ncount.set(5)  # Effect is invalidated\neffect.run_if_dirty()  # Prints: \"Count is now: 5\"\n</code></pre>"},{"location":"skills/reactive-primitives/#effect-with-cleanup","title":"Effect with Cleanup","text":"<pre><code>def setup_timer() -&gt; Callable[[], None]:\n    timer_id = start_timer()\n\n    def cleanup() -&gt; None:\n        stop_timer(timer_id)\n\n    return cleanup\n\neffect = Effect.of(fn=setup_timer, sources=[interval_signal])\neffect.run()  # Starts timer\n\ninterval_signal.set(1000)  # Change interval\neffect.run()  # Cleanup called first, then new timer starts\n\neffect.dispose()  # Final cleanup\n</code></pre>"},{"location":"skills/reactive-primitives/#check-dirty-state","title":"Check Dirty State","text":"<pre><code>if effect.dirty:\n    effect.run()\n</code></pre>"},{"location":"skills/reactive-primitives/#snapshot-internals","title":"Snapshot Internals","text":"<p>The <code>Snapshot[T]</code> captures: - <code>value</code>: The captured value - <code>timestamp</code>: Monotonic time when captured - <code>generation</code>: How many mutations had occurred</p> <pre><code>snap = sig.snapshot()\nprint(snap.value)       # The value\nprint(snap.timestamp)   # When captured\nprint(snap.generation)  # Mutation count at capture\n</code></pre> <p>Invariant: Generation is monotonically increasing. Setting the same value does not increment generation.</p>"},{"location":"skills/reactive-primitives/#patterns","title":"Patterns","text":""},{"location":"skills/reactive-primitives/#branching-exploration","title":"Branching Exploration","text":"<pre><code>def explore_options(base_signal: Signal[int]) -&gt; tuple[int, int]:\n    checkpoint = base_signal.snapshot()\n\n    # Path A\n    base_signal.set(1)\n    base_signal.update(lambda x: x + 10)\n    path_a = base_signal.value  # 11\n\n    # Return and try Path B\n    base_signal.restore(checkpoint)\n    base_signal.set(2)\n    base_signal.update(lambda x: x * 10)\n    path_b = base_signal.value  # 20\n\n    return path_a, path_b\n</code></pre>"},{"location":"skills/reactive-primitives/#reactive-counter-widget","title":"Reactive Counter Widget","text":"<pre><code>class Counter:\n    def __init__(self) -&gt; None:\n        self._count = Signal.of(0)\n        self._display = self._count.map(lambda c: f\"Count: {c}\")\n\n    def increment(self) -&gt; None:\n        self._count.update(lambda x: x + 1)\n\n    @property\n    def text(self) -&gt; str:\n        return self._display.value\n</code></pre>"},{"location":"skills/reactive-primitives/#multi-source-aggregation","title":"Multi-Source Aggregation","text":"<pre><code>def create_dashboard(\n    cpu: Signal[float],\n    memory: Signal[float],\n    disk: Signal[float],\n) -&gt; Computed[str]:\n    return Computed.of(\n        compute=lambda: f\"CPU: {cpu.value}% | Mem: {memory.value}% | Disk: {disk.value}%\",\n        sources=[cpu, memory, disk],\n    )\n</code></pre>"},{"location":"skills/reactive-primitives/#verification","title":"Verification","text":"<pre><code># Run reactive primitive tests\ncd impl/claude\nuv run pytest agents/i/reactive/_tests/test_time_travel.py -v\n\n# Run stress tests\nuv run pytest agents/i/reactive/_tests/test_wave1_stress.py -v\n\n# Run all reactive tests\nuv run pytest agents/i/reactive/_tests/ -v\n</code></pre>"},{"location":"skills/reactive-primitives/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/reactive-primitives/#1-mutating-signal-value-directly","title":"1. Mutating Signal Value Directly","text":"<p>Wrong: <pre><code>sig = Signal.of([1, 2, 3])\nsig.value.append(4)  # Subscribers not notified!\n</code></pre></p> <p>Right: <pre><code>sig.set([*sig.value, 4])  # New list, triggers notification\n</code></pre></p>"},{"location":"skills/reactive-primitives/#2-forgetting-to-dispose","title":"2. Forgetting to Dispose","text":"<p>Risk: Memory leaks from dangling subscriptions.</p> <p>Fix: Always dispose Computed and Effect when done: <pre><code>computed.dispose()\neffect.dispose()\n</code></pre></p>"},{"location":"skills/reactive-primitives/#3-circular-dependencies","title":"3. Circular Dependencies","text":"<p>Risk: Stack overflow if Computed depends on itself.</p> <p>Fix: Design acyclic dependency graphs.</p>"},{"location":"skills/reactive-primitives/#related-skills","title":"Related Skills","text":"<ul> <li>modal-scope-branching - Git-like context exploration</li> <li>turn-projectors - Multi-target rendering</li> <li>test-patterns - Testing reactive code</li> </ul>"},{"location":"skills/reactive-primitives/#source-reference","title":"Source Reference","text":"<p><code>impl/claude/agents/i/reactive/signal.py:60-343</code></p> <p>Skill created: 2025-12-14 | Wave 1 EDUCATE Phase</p>"},{"location":"skills/reconciliation-session/","title":"Skill: Reconciliation Session","text":"<p>Audit, surface, and sync the forest state\u2014making invisible progress visible.</p> <p>Difficulty: Medium Prerequisites: Understanding of Forest Protocol, plan YAML headers, _forest.md structure Files Touched: <code>plans/_forest.md</code>, <code>plans/_status.md</code>, <code>plans/meta.md</code>, <code>plans/_epilogues/</code> References: <code>plans/principles.md</code>, <code>spec/principles.md</code></p>"},{"location":"skills/reconciliation-session/#overview","title":"Overview","text":"<p>A reconciliation session audits the planning forest for drift between declared state and actual state, surfaces completed work through demos, and updates meta files to reflect reality. This is Chief of Staff work\u2014tending the forest, not implementing features.</p>"},{"location":"skills/reconciliation-session/#when-to-use","title":"When to Use","text":"<ul> <li>After major work completes (like turn-gents 7 phases)</li> <li>When the user asks to \"check on\" a plan</li> <li>When _forest.md feels stale</li> <li>Before starting new initiatives (clear the decks)</li> <li>Periodically (weekly) as forest maintenance</li> </ul>"},{"location":"skills/reconciliation-session/#the-core-insight","title":"The Core Insight","text":"<p>Runnable beats readable for validation. A demo script that runs proves completion more than status updates. When auditing:</p> <ol> <li>Read the forest \u2014 understand declared state</li> <li>Verify through code \u2014 run tests, check files exist</li> <li>Surface via demo \u2014 make invisible work visible</li> <li>Update status \u2014 sync meta files to reality</li> </ol>"},{"location":"skills/reconciliation-session/#step-by-step","title":"Step-by-Step","text":""},{"location":"skills/reconciliation-session/#step-1-quality-gate-first","title":"Step 1: Quality Gate First","text":"<p>Before reading anything, verify the forest is healthy:</p> <pre><code>cd impl/claude\n\n# Type check\nuv run mypy . --no-error-summary 2&gt;&amp;1 | tail -10\n\n# Test count (are we growing?)\nuv run pytest --collect-only -q 2&gt;/dev/null | tail -3\n</code></pre> <p>Why first? This prevents drift\u2014you fix issues before they compound. If mypy errors exist, fix them before anything else.</p> <p>Exit criteria: Zero mypy errors in production code. Tests collect successfully.</p>"},{"location":"skills/reconciliation-session/#step-2-read-the-forest","title":"Step 2: Read the Forest","text":"<p>Read in this order (dependencies flow down):</p> <ol> <li><code>plans/_focus.md</code> \u2014 Human intent (READ ONLY)</li> <li><code>plans/_forest.md</code> \u2014 Current canopy view</li> <li><code>plans/_status.md</code> \u2014 Detailed component status</li> <li>Target plan file (e.g., <code>docs/architecture/turn-gents.md</code>)</li> <li>Recent epilogues (<code>plans/_epilogues/</code> last 3 days)</li> </ol> <p>Pattern: Compare _forest.md claims against actual files:</p> <pre><code># Does the code exist?\nls impl/claude/weave/*.py\n\n# How many tests?\nuv run pytest weave/_tests/ --collect-only -q 2&gt;/dev/null | tail -3\n</code></pre> <p>Exit criteria: You understand the declared vs. actual state gap.</p>"},{"location":"skills/reconciliation-session/#step-3-verify-through-code","title":"Step 3: Verify Through Code","text":"<p>For each claimed completion, verify through code:</p> <pre><code># Claimed: \"Turn schema complete with 46 tests\"\n# Verify:\nuv run pytest weave/_tests/test_turn.py -v --tb=no 2&gt;&amp;1 | tail -10\n# \u2192 Count actual tests, verify they pass\n</code></pre> <p>Anti-pattern: Trusting status files without verification.</p> <p>Exit criteria: You have empirical evidence of completion state.</p>"},{"location":"skills/reconciliation-session/#step-4-fix-drift","title":"Step 4: Fix Drift","text":"<p>If you find issues:</p> <ol> <li>Mypy errors: Fix surgically (one type annotation, minimal change)</li> <li>Test failures: Investigate root cause, fix</li> <li>Missing files: Note in session_notes, don't fabricate</li> <li>Stale counts: Update with actual numbers</li> </ol> <p>Pattern: Surgical fixes &gt; sweeping changes</p> <pre><code># Example: Type narrowing fix in inference.py\n# Before: sum(1 for b in budgets.values() if b.free_energy &gt; 0)\n# After: len([b for b in budgets.values() if b.free_energy &gt; 0])\n# \u2192 One-line fix, resolves mypy error\n</code></pre> <p>Exit criteria: Quality gate passes again.</p>"},{"location":"skills/reconciliation-session/#step-5-surface-via-demo","title":"Step 5: Surface Via Demo","text":"<p>Create a demo script if one doesn't exist. This makes invisible work visible:</p> <pre><code># File: qa/demo_&lt;feature&gt;.py\n\"\"\"\nDemo script for &lt;Feature&gt;.\n\nShowcases:\n1. Core capability A\n2. Core capability B\n3. Integration point C\n\nRun with:\n    uv run python qa/demo_&lt;feature&gt;.py\n\"\"\"\n</code></pre> <p>Key sections in a good demo: - What to show: Each major capability demonstrated - Why it matters: Brief explanation of purpose - Integration points: Show how it connects to other systems</p> <p>Pattern: Demo functions should be runnable independently:</p> <pre><code>def demo_feature_a() -&gt; None:\n    \"\"\"Demonstrate feature A.\"\"\"\n    console.print(\"\\n[bold cyan]1. Feature A[/bold cyan]\")\n    # Actual working code, not pseudocode\n    result = actual_function()\n    console.print(f\"Result: {result}\")\n</code></pre> <p>Exit criteria: <code>uv run python qa/demo_&lt;feature&gt;.py</code> runs without error.</p>"},{"location":"skills/reconciliation-session/#step-6-update-forest-documentation","title":"Step 6: Update Forest Documentation","text":"<p>Update meta files to reflect verified reality:</p> <p>Order matters (dependencies):</p> <ol> <li>Plan YAML header \u2014 Update progress, status, session_notes</li> <li>_forest.md \u2014 Update tables, dependency graph</li> <li>_status.md \u2014 Update component tables with verified counts</li> <li>_epilogues/ \u2014 Write session epilogue</li> </ol> <p>Pattern: Atomic updates with evidence:</p> <pre><code># In plan file header:\nprogress: 100  # Was 0, now verified complete\nstatus: complete  # Was proposed\nsession_notes: |\n  All 7 phases verified complete. 187 tests passing.\n  Demo: qa/demo_turn_gents.py\n  Integration points identified: memory, dashboard, k-gent, polynomial.\n</code></pre> <p>Exit criteria: Meta files reflect empirical reality.</p>"},{"location":"skills/reconciliation-session/#step-7-write-epilogue","title":"Step 7: Write Epilogue","text":"<p>Create <code>plans/_epilogues/YYYY-MM-DD-&lt;session-type&gt;.md</code>:</p> <pre><code># Session Epilogue: YYYY-MM-DD &lt;Type&gt;\n\n## What We Did\n- [Specific actions taken]\n\n## What We Verified\n- [Test counts, mypy status, demo runs]\n\n## Integration Synergies\n- [Cross-references discovered]\n\n## What's Next\n- [Concrete next steps for future sessions]\n</code></pre> <p>Exit criteria: Future agents can continue from your epilogue.</p>"},{"location":"skills/reconciliation-session/#verification-checklist","title":"Verification Checklist","text":"<p>Before completing a reconciliation session:</p> <ul> <li> Quality gate passes (mypy clean, tests collect)</li> <li> Target plan files read and understood</li> <li> Claimed completions verified through code</li> <li> Drift fixed (mypy errors, test failures)</li> <li> Demo script created/updated and runs</li> <li> _forest.md updated with verified state</li> <li> _status.md updated with actual test counts</li> <li> Epilogue written for next session</li> <li> meta.md updated with atomic learning (if novel insight)</li> </ul>"},{"location":"skills/reconciliation-session/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/reconciliation-session/#1-trusting-status-without-verification","title":"1. Trusting Status Without Verification","text":"<pre><code># BAD: Just update _forest.md based on plan file claims\n# GOOD: Run tests, check files exist, verify completion\n</code></pre>"},{"location":"skills/reconciliation-session/#2-sweeping-fixes-instead-of-surgical","title":"2. Sweeping Fixes Instead of Surgical","text":"<pre><code># BAD: Refactor entire file to fix one type error\n# GOOD: Add one type annotation to fix the specific error\n</code></pre>"},{"location":"skills/reconciliation-session/#3-forgetting-the-demo","title":"3. Forgetting the Demo","text":"<pre><code># BAD: Update status files, claim complete\n# GOOD: Create runnable demo that proves functionality\n</code></pre>"},{"location":"skills/reconciliation-session/#4-not-writing-epilogue","title":"4. Not Writing Epilogue","text":"<pre><code># BAD: Session ends without state capture\n# GOOD: Epilogue enables future session continuity\n</code></pre>"},{"location":"skills/reconciliation-session/#5-modifying-_focusmd","title":"5. Modifying _focus.md","text":"<pre><code># BAD: Agent updates human intent file\n# GOOD: _focus.md is READ ONLY for agents\n</code></pre>"},{"location":"skills/reconciliation-session/#the-reconciliation-equation","title":"The Reconciliation Equation","text":"<pre><code>Reconciliation =\n    quality_gate()\n    &gt;&gt; read_forest()\n    &gt;&gt; verify_through_code()\n    &gt;&gt; fix_drift()\n    &gt;&gt; surface_via_demo()\n    &gt;&gt; update_status()\n    &gt;&gt; write_epilogue()\n</code></pre> <p>Each step depends on the previous. Skip none.</p>"},{"location":"skills/reconciliation-session/#success-metrics","title":"Success Metrics","text":"<p>A successful reconciliation session:</p> Metric Target Mypy errors 0 (in production code) Tests passing All collected tests pass Demo runs Exit code 0 _forest.md Reflects verified reality Epilogue Written with next steps"},{"location":"skills/reconciliation-session/#related-skills","title":"Related Skills","text":"<ul> <li>plan-file \u2014 Writing plan files with YAML headers</li> <li>test-patterns \u2014 Verifying through tests</li> <li>handler-patterns \u2014 CLI patterns for demos</li> </ul>"},{"location":"skills/reconciliation-session/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Initial version from turn-gents reconciliation session</li> </ul>"},{"location":"skills/saas-patterns/","title":"Skill: SaaS Infrastructure Patterns","text":"<p>Operational patterns for production-grade SaaS infrastructure</p> <p>Difficulty: Medium Prerequisites: K8s basics, FastAPI, async Python Files Touched: <code>protocols/api/</code>, <code>protocols/billing/</code>, <code>infra/k8s/manifests/</code></p>"},{"location":"skills/saas-patterns/#overview","title":"Overview","text":"<p>This skill documents patterns learned from building kgents SaaS infrastructure across 11 phases. These patterns apply to any production API service with multi-tenancy, webhooks, and Kubernetes deployment.</p>"},{"location":"skills/saas-patterns/#pattern-1-non-blocking-webhook-processing","title":"Pattern 1: Non-Blocking Webhook Processing","text":"<p>Fire-and-forget pattern for webhook ingestion that doesn't block the response.</p> <p>When to use: External webhooks (Stripe, GitHub, etc.) where acknowledgment must be fast.</p> <p>File: <code>protocols/api/webhooks.py</code> Pattern: <pre><code>from asyncio import create_task\n\nasync def webhook_handler(payload: WebhookPayload) -&gt; Response:\n    # Verify signature FIRST (security-critical)\n    if not verify_signature(payload):\n        raise HTTPException(400, \"Invalid signature\")\n\n    # Acknowledge immediately, process async\n    create_task(process_webhook(payload))\n    return Response(status_code=200)\n\nasync def process_webhook(payload: WebhookPayload) -&gt; None:\n    \"\"\"Fire-and-forget processing with error handling.\"\"\"\n    try:\n        await translate_and_forward(payload)\n    except Exception as e:\n        logger.error(f\"Webhook processing failed: {e}\")\n        # Consider dead-letter queue for retries\n</code></pre></p> <p>Key insight: <code>asyncio.create_task()</code> returns immediately while processing continues in background.</p>"},{"location":"skills/saas-patterns/#pattern-2-idempotency-with-graceful-degradation","title":"Pattern 2: Idempotency with Graceful Degradation","text":"<p>In-memory store for MVP, Redis for production, with automatic fallback.</p> <p>When to use: Any operation that must not be executed twice (webhooks, payments, state transitions).</p> <p>File: <code>protocols/billing/idempotency.py</code> Pattern: <pre><code>from abc import ABC, abstractmethod\nfrom datetime import timedelta\n\nclass IdempotencyStore(ABC):\n    @abstractmethod\n    async def check_and_set(self, key: str, ttl: timedelta) -&gt; bool:\n        \"\"\"Return True if key is new (proceed), False if duplicate (skip).\"\"\"\n        ...\n\nclass InMemoryIdempotencyStore(IdempotencyStore):\n    \"\"\"MVP: In-memory with TTL. Loses state on restart.\"\"\"\n    def __init__(self):\n        self._seen: dict[str, float] = {}\n\n    async def check_and_set(self, key: str, ttl: timedelta) -&gt; bool:\n        now = time.time()\n        self._cleanup(now)\n        if key in self._seen:\n            return False  # Duplicate\n        self._seen[key] = now + ttl.total_seconds()\n        return True  # New\n\nclass RedisIdempotencyStore(IdempotencyStore):\n    \"\"\"Production: Redis with atomic SETNX.\"\"\"\n    async def check_and_set(self, key: str, ttl: timedelta) -&gt; bool:\n        return await self.redis.set(key, \"1\", nx=True, ex=int(ttl.total_seconds()))\n\n# Factory with graceful degradation\n_store: IdempotencyStore | None = None\n\ndef get_idempotency_store() -&gt; IdempotencyStore:\n    global _store\n    if _store is None:\n        try:\n            _store = RedisIdempotencyStore()\n        except Exception:\n            logger.warning(\"Redis unavailable, using in-memory store\")\n            _store = InMemoryIdempotencyStore()\n    return _store\n</code></pre></p> <p>Key insight: In-memory \u2192 Redis progression with TTL. Singleton caching avoids repeated connection attempts.</p>"},{"location":"skills/saas-patterns/#pattern-3-memory-leak-detection-via-latency-proxy","title":"Pattern 3: Memory Leak Detection via Latency Proxy","text":"<p>Use latency growth as a proxy for memory leaks in soak tests.</p> <p>When to use: Long-running soak tests (1h, 4h, 24h) where direct memory measurement is complex.</p> <p>File: <code>tests/load/saas-soak.js</code> (k6) Pattern: <pre><code>// Track latency percentiles over time\nconst latencyTrend = new Trend('response_latency');\n\nexport default function() {\n    const start = Date.now();\n    const res = http.get(`${BASE_URL}/health`);\n    latencyTrend.add(Date.now() - start);\n}\n\n// In summary, check for drift\nexport function handleSummary(data) {\n    const p95_start = data.metrics.response_latency.values['p(95)'];\n    // Compare early vs late percentiles\n    // Significant growth indicates memory pressure\n}\n</code></pre></p> <p>Key insight: Latency growth over time correlates with memory pressure. Simpler than direct measurement, works across languages.</p>"},{"location":"skills/saas-patterns/#pattern-4-poddisruptionbudget-for-ha","title":"Pattern 4: PodDisruptionBudget for HA","text":"<p>Prevent all-pod eviction during node drains.</p> <p>When to use: Any StatefulSet or Deployment with 2+ replicas where availability matters.</p> <p>File: <code>infra/k8s/manifests/api/pdb.yaml</code> Pattern: <pre><code>apiVersion: policy/v1\nkind: PodDisruptionBudget\nmetadata:\n  name: api-pdb\nspec:\n  minAvailable: 1  # Or use maxUnavailable: 1\n  selector:\n    matchLabels:\n      app: kgent-api\n</code></pre></p> <p>Key insight: PDB is essential for preventing all-pod eviction during <code>kubectl drain</code>. Without it, all replicas can be evicted simultaneously.</p>"},{"location":"skills/saas-patterns/#pattern-5-runbook-urls-in-alerts","title":"Pattern 5: Runbook URLs in Alerts","text":"<p>Reduce MTTR by linking alerts directly to runbook procedures.</p> <p>When to use: Any Prometheus alerting rule.</p> <p>File: <code>infra/k8s/manifests/observability/prometheus/alerting-rules.yaml</code> Pattern: <pre><code>groups:\n  - name: kgents-api\n    rules:\n      - alert: APIHighLatency\n        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) &gt; 0.5\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: \"API p95 latency &gt; 500ms\"\n          runbook_url: \"https://docs.kgents.io/runbook#api-high-latency\"\n</code></pre></p> <p>Key insight: On-call engineers click directly to procedure instead of searching. Reduces MTTR significantly.</p>"},{"location":"skills/saas-patterns/#pattern-6-404-for-cross-tenant-access","title":"Pattern 6: 404 for Cross-Tenant Access","text":"<p>Return 404 (not 403) for cross-tenant resource access.</p> <p>When to use: Any multi-tenant API where tenant isolation is enforced.</p> <p>File: <code>protocols/api/sessions.py</code> Pattern: <pre><code>async def get_session(session_id: UUID, tenant: Tenant) -&gt; Session:\n    session = await session_store.get(session_id)\n\n    # Return 404 even if session exists but belongs to different tenant\n    # This prevents tenant enumeration attacks\n    if session is None or session.tenant_id != tenant.id:\n        raise HTTPException(404, \"Session not found\")\n\n    return session\n</code></pre></p> <p>Key insight: 403 reveals that a resource exists. 404 provides no information to attackers attempting tenant enumeration.</p>"},{"location":"skills/saas-patterns/#pattern-7-nats-jetstream-with-graceful-degradation","title":"Pattern 7: NATS JetStream with Graceful Degradation","text":"<p>Configure NATS JetStream with circuit breaker and fallback queues.</p> <p>When to use: Real-time event streaming where availability matters more than consistency.</p> <p>File: <code>protocols/streaming/nats_bridge.py</code> Pattern: <pre><code>@dataclass\nclass NATSBridge:\n    config: NATSBridgeConfig\n    _circuit: CircuitBreaker = field(default_factory=CircuitBreaker)\n    _fallback_queues: dict[str, asyncio.Queue] = field(default_factory=dict)\n\n    async def connect(self) -&gt; None:\n        try:\n            self._nc = await nats.connect(servers=self.config.servers)\n            self._js = self._nc.jetstream()\n\n            # Check if stream exists first\n            try:\n                await self._js.stream_info(self.config.stream_name)\n            except Exception:\n                # Create with MINIMAL config - avoid max_age issues\n                config = StreamConfig(\n                    name=self.config.stream_name,\n                    subjects=self.config.stream_subjects,\n                    # Don't specify max_age - let NATS use defaults\n                )\n                await self._js.add_stream(config)\n\n            self._connected = True\n        except Exception as e:\n            logger.warning(f\"NATS unavailable, using fallback: {e}\")\n            self._connected = False  # Graceful degradation\n\n    async def publish(self, subject: str, payload: dict) -&gt; None:\n        if not self._circuit.should_allow_request():\n            await self._fallback_publish(subject, payload)\n            return\n        # ... publish with circuit breaker tracking\n</code></pre></p> <p>Key insight: NATS JetStream <code>StreamConfig</code> with large <code>max_age</code> values (nanoseconds) can fail with \"invalid JSON\" error (10025). Use minimal config and let NATS apply defaults.</p>"},{"location":"skills/saas-patterns/#pattern-8-cross-namespace-networkpolicy","title":"Pattern 8: Cross-Namespace NetworkPolicy","text":"<p>Allow traffic from API namespace to NATS namespace via label selectors.</p> <p>When to use: Microservices in different namespaces that need to communicate through NetworkPolicy.</p> <p>File: <code>infra/k8s/manifests/nats/network-policy.yaml</code> Pattern: <pre><code>apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: nats-access\n  namespace: kgents-agents  # NATS namespace\nspec:\n  podSelector:\n    matchLabels:\n      app.kubernetes.io/name: nats\n  policyTypes:\n    - Ingress\n  ingress:\n    - from:\n        - namespaceSelector:\n            matchLabels:\n              kgents.io/tier: gateway  # Label on SOURCE namespace\n      ports:\n        - port: 4222\n          protocol: TCP\n</code></pre></p> <p>Then label the source namespace: <pre><code>kubectl label namespace kgents-triad kgents.io/tier=gateway\n</code></pre></p> <p>Key insight: NetworkPolicy <code>namespaceSelector</code> matches labels on the SOURCE namespace, not the target. Label the namespace containing the pods that need access.</p>"},{"location":"skills/saas-patterns/#pattern-9-kind-image-loading-with-versioned-tags","title":"Pattern 9: Kind Image Loading with Versioned Tags","text":"<p>Force pod recreation when updating images in Kind clusters.</p> <p>When to use: Local Kubernetes development with Kind where <code>imagePullPolicy: IfNotPresent</code> caches aggressively.</p> <p>Commands: <pre><code># Build with versioned tag (not :latest)\ndocker build -t kgents/api:v3 --no-cache -f Dockerfile .\n\n# Load into Kind cluster\nkind load docker-image kgents/api:v3 --name kgents-triad\n\n# Update deployment to use new tag\nkubectl set image deployment/kgent-api api=kgents/api:v3 -n kgents-triad\n</code></pre></p> <p>Key insight: Kind's <code>imagePullPolicy: IfNotPresent</code> caches images. Using <code>:latest</code> won't pull new versions. Increment version tags (v1, v2, v3) to force new image usage and pod recreation.</p>"},{"location":"skills/saas-patterns/#pattern-10-built-in-dev-api-keys","title":"Pattern 10: Built-in Dev API Keys","text":"<p>Provide development API keys for testing without external auth service.</p> <p>When to use: Local development and CI testing before production auth is configured.</p> <p>File: <code>protocols/api/auth.py</code> Pattern: <pre><code># In-memory store for development/testing\n_API_KEY_STORE: dict[str, ApiKeyData] = {\n    \"kg_dev_alice\": ApiKeyData(\n        key=\"kg_dev_alice\",\n        user_id=\"user_alice\",\n        tier=\"FREE\",\n        rate_limit=100,\n        scopes=(\"read\",),\n    ),\n    \"kg_dev_bob\": ApiKeyData(\n        key=\"kg_dev_bob\",\n        user_id=\"user_bob\",\n        tier=\"PRO\",\n        rate_limit=1000,\n        scopes=(\"read\", \"write\"),\n    ),\n    \"kg_dev_carol\": ApiKeyData(\n        key=\"kg_dev_carol\",\n        user_id=\"user_carol\",\n        tier=\"ENTERPRISE\",\n        rate_limit=10000,\n        scopes=(\"read\", \"write\", \"admin\"),\n    ),\n}\n</code></pre></p> <p>Usage: <pre><code>curl -X POST http://localhost:8000/api/v1/town/demo/init \\\n  -H \"X-API-Key: kg_dev_bob\"\n</code></pre></p> <p>Key insight: Prefix dev keys with <code>kg_dev_</code> for easy identification. Include multiple tiers (FREE/PRO/ENTERPRISE) for testing tier-specific behavior.</p>"},{"location":"skills/saas-patterns/#verification","title":"Verification","text":"<p>After applying these patterns:</p> <ol> <li>Webhook pattern: Check logs for \"Webhook processing\" entries appearing after response sent</li> <li>Idempotency: Send same webhook twice, verify only processed once</li> <li>Soak test: Run 1h test, verify latency stable within 10%</li> <li>PDB: <code>kubectl get pdb</code> shows <code>disruptionsAllowed: 1</code></li> <li>Runbook URLs: Click alert link in Grafana, verify reaches correct runbook section</li> <li>404 pattern: Access other tenant's resource, verify 404 (not 403)</li> <li>NATS: <code>curl /health/saas</code> shows <code>\"nats\":{\"status\":\"healthy\",\"mode\":\"jetstream\"}</code></li> <li>NetworkPolicy: <code>kubectl exec -n source-ns -- curl nats.target-ns:4222</code> succeeds</li> <li>Kind images: <code>kubectl get pods -o jsonpath='{.items[*].spec.containers[*].image}'</code> shows new tag</li> <li>Dev keys: <code>curl -H \"X-API-Key: kg_dev_bob\" /api/v1/health</code> returns 200</li> </ol>"},{"location":"skills/saas-patterns/#common-pitfalls","title":"Common Pitfalls","text":"<ul> <li>Webhook signature verification after processing: Always verify BEFORE any processing</li> <li>In-memory idempotency in horizontal scaling: Use Redis when running multiple replicas</li> <li>PDB with minAvailable = replicas: Blocks all drains; use minAvailable = replicas - 1</li> <li>403 leaking tenant existence: Always use 404 for cross-tenant access denial</li> <li>NATS StreamConfig max_age in nanoseconds: Large values cause \"invalid JSON\" (10025); use defaults</li> <li>NetworkPolicy namespace labels: Labels go on SOURCE namespace, not target; easy to confuse</li> <li>Kind :latest tag: Doesn't trigger pull; use versioned tags (v1, v2, v3) instead</li> <li>Dev keys in production: Gate behind environment check; never ship to production</li> </ul>"},{"location":"skills/saas-patterns/#related-skills","title":"Related Skills","text":"<ul> <li>handler-patterns - API handler patterns</li> <li>test-patterns - Testing patterns including load tests</li> <li>harden-module - Security hardening patterns</li> </ul>"},{"location":"skills/saas-patterns/#changelog","title":"Changelog","text":"<ul> <li>2025-12-15: Added patterns 7-10 (NATS, NetworkPolicy, Kind images, Dev keys) from Kind deployment session</li> <li>2025-12-14: Initial version synthesized from SaaS phases 0-11</li> </ul>"},{"location":"skills/test-optimization/","title":"Test Optimization Skill","text":"<p>Pattern for profiling and optimizing test suite performance.</p>"},{"location":"skills/test-optimization/#overview","title":"Overview","text":"<p>The test optimization framework provides automatic test profiling, tier-based categorization, and optimization recommendations.</p>"},{"location":"skills/test-optimization/#quick-start","title":"Quick Start","text":"<pre><code># Run tests with profiling\npytest --profile-tests\n\n# Run with recommendations\npytest --profile-tests --show-recommendations\n\n# Generate standalone report\npython -m testing.optimization.pytest_plugin\n</code></pre>"},{"location":"skills/test-optimization/#test-tiers","title":"Test Tiers","text":"<p>Tests are automatically categorized by execution time:</p> Tier Duration Meaning INSTANT &lt; 100ms Unit tests, fast assertions FAST 100ms - 1s Simple integration tests MEDIUM 1s - 5s Database/network tests SLOW 5s - 30s Full integration, E2E EXPENSIVE &gt; 30s Should be cached or mocked"},{"location":"skills/test-optimization/#profile-storage","title":"Profile Storage","text":"<p>Profiles are stored in <code>.kgents/ghost/test_profiles.jsonl</code>:</p> <pre><code>{\"type\": \"profile\", \"test_id\": \"test_foo\", \"duration_ms\": 500.0, \"tier\": \"fast\", ...}\n</code></pre>"},{"location":"skills/test-optimization/#dashboard-integration","title":"Dashboard Integration","text":"<p>View test health in the dashboard:</p> <pre><code>from testing.optimization.dashboard import collect_test_health_metrics\n\nmetrics = await collect_test_health_metrics()\nprint(f\"Total: {metrics.total_tests}, Status: {metrics.status_text}\")\n</code></pre> <p>The <code>TestHealthPanel</code> widget can be added to any Textual dashboard.</p>"},{"location":"skills/test-optimization/#recommendations","title":"Recommendations","text":"<p>The framework generates recommendations for expensive tests:</p> <ol> <li>mark_slow - Add <code>@pytest.mark.slow</code> to exclude from default runs</li> <li>cache_static_analysis - Use module-scoped fixtures for trace analysis</li> <li>mock_expensive - Mock external calls in expensive tests</li> </ol>"},{"location":"skills/test-optimization/#framework-components","title":"Framework Components","text":"Module Purpose <code>__init__.py</code> Core types: TestTier, TestProfile, RefinementTracker <code>pytest_plugin.py</code> Pytest hook integration, <code>--profile-tests</code> CLI <code>redundancy.py</code> Coverage-based redundancy detection <code>partition.py</code> Operad-based test partitioning <code>flux.py</code> Self-improving TestOptimizationFlux agent <code>dashboard.py</code> TestHealthMetrics and panel for dashboard"},{"location":"skills/test-optimization/#categorical-principle","title":"Categorical Principle","text":"<p>\"Tests are the executable specification. A slow test suite is a spec that no one reads.\"</p> <p>The framework models test optimization as a polynomial functor:</p> <pre><code>TestOptimizer: PolyAgent[OptimizationState, TestSuite, OptimizedSuite]\n</code></pre> <p>AGENTESE path: <code>self.test.optimization.witness</code></p>"},{"location":"skills/test-optimization/#see-also","title":"See Also","text":"<ul> <li><code>impl/claude/testing/optimization/</code> - Implementation</li> <li><code>docs/skills/test-patterns.md</code> - General testing patterns</li> <li><code>impl/claude/conftest.py</code> - Pytest configuration</li> </ul>"},{"location":"skills/test-patterns/","title":"Skill: Testing Patterns and Conventions","text":"<p>Write comprehensive agent tests using T-gent Types I-V taxonomy and testing infrastructure.</p> <p>Difficulty: Easy-Medium Prerequisites: pytest basics, Python async/await Files Touched: <code>*/_tests/test_*.py</code>, <code>impl/claude/testing/</code> References: <code>agents/t/</code>, <code>testing/__init__.py</code></p>"},{"location":"skills/test-patterns/#overview","title":"Overview","text":"<p>kgents uses a five-level test taxonomy (T-gent Types I-V) that progresses from contract verification to metamorphic testing. The <code>testing/</code> package provides infrastructure for each level.</p> <p>Tests are the executable specification\u2014they define agent behavior more precisely than prose.</p>"},{"location":"skills/test-patterns/#t-gent-types-i-v-taxonomy","title":"T-gent Types I-V Taxonomy","text":"Type Name Purpose Tools I Contracts Preconditions, postconditions, invariants <code>pytest</code>, <code>PredicateAgent</code> II Saboteurs Property-based testing, fuzzing <code>Hypothesis</code>, <code>NoiseAgent</code> III Spies Behavior verification, call tracking <code>SpyAgent</code>, <code>CounterAgent</code> IV Judges Semantic assertions, LLM validation <code>Oracle</code>, <code>JudgeAgent</code> V Witnesses Integration tests, round-trip verification <code>Topologist</code>, <code>Cortex</code>"},{"location":"skills/test-patterns/#conventions","title":"Conventions","text":"<ul> <li>Test directory: <code>_tests/</code> folders next to source files</li> <li>Test naming: <code>test_&lt;feature&gt;.py</code> files, <code>Test&lt;Class&gt;</code> classes, <code>test_&lt;behavior&gt;</code> methods</li> <li>Async tests: <code>@pytest.mark.asyncio</code> decorator</li> <li>Fixtures: Centralized in <code>conftest.py</code>, module-local for specifics</li> <li>Type-safe mocks: Use <code>testing.as_umwelt()</code> and <code>testing.as_agent()</code></li> <li>Custom markers: <code>@pytest.mark.law</code>, <code>@pytest.mark.slow</code>, <code>@pytest.mark.property</code></li> </ul>"},{"location":"skills/test-patterns/#t-gent-test-agents","title":"T-gent Test Agents","text":"<p>The <code>agents/t/</code> package provides composable test agents:</p> Agent Purpose Key Methods <code>MockAgent</code> Constant output <code>call_count</code> <code>FixtureAgent</code> Deterministic lookup <code>lookup_count</code> <code>FailingAgent</code> Controlled failures <code>reset()</code> <code>SpyAgent</code> Identity + observation <code>assert_captured()</code>, <code>history</code> <code>PredicateAgent</code> Validation gate <code>pass_count</code>, <code>fail_count</code> <code>NoiseAgent</code> Semantic perturbation <code>level</code>, <code>seed</code> <code>LatencyAgent</code> Temporal delay <code>delay</code>, <code>variance</code> <code>FlakyAgent</code> Probabilistic failure <code>probability</code> <code>CounterAgent</code> Call counting <code>count</code>, <code>assert_count()</code> <code>MetricsAgent</code> Timing metrics <code>metrics.avg_time</code>"},{"location":"skills/test-patterns/#usage-examples","title":"Usage Examples","text":"<pre><code>from agents.t import (\n    MockAgent, MockConfig,\n    SpyAgent, CounterAgent, MetricsAgent,\n    NoiseAgent, LatencyAgent, FlakyAgent,\n    PredicateAgent, not_empty,\n)\n\n# MockAgent: constant morphism\nmock = MockAgent[str, dict](MockConfig(output={\"status\": \"ok\"}))\nresult = await mock.invoke(\"anything\")  # Always {\"status\": \"ok\"}\nassert mock.call_count == 1\n\n# SpyAgent: identity + observation\nspy = SpyAgent[str](label=\"Pipeline\")\nawait pipeline_with_spy.invoke(\"input1\")\nspy.assert_captured(\"input1\")\nspy.assert_count(1)\n\n# PredicateAgent: validation gate\nvalidator = PredicateAgent[str](not_empty, name=\"NonEmpty\")\nawait validator.invoke(\"hello\")  # Passes\n# await validator.invoke(\"\")     # Raises ValueError\n\n# NoiseAgent: semantic perturbation (for fuzzing)\nnoise = NoiseAgent[str](level=0.5, seed=42)\nperturbed = await noise.invoke(\"Fix the bug\")  # \u2192 \"Fix te bug\"\n\n# CounterAgent: track invocations\ncounter = CounterAgent[str](label=\"Calls\")\nawait counter.invoke(\"a\")\nawait counter.invoke(\"b\")\ncounter.assert_count(2)\n\n# MetricsAgent: timing\nmetrics = MetricsAgent[str](label=\"Perf\")\nawait metrics.invoke(\"test\")\nprint(f\"Avg time: {metrics.metrics.avg_time:.6f}s\")\n</code></pre>"},{"location":"skills/test-patterns/#composition-in-tests","title":"Composition in Tests","text":"<pre><code># Pipeline: Counter &gt;&gt; Spy &gt;&gt; Agent Under Test\ncounter = CounterAgent[str](label=\"Calls\")\nspy = SpyAgent[str](label=\"Inputs\")\nagent = MyAgent()\n\npipeline = counter &gt;&gt; spy &gt;&gt; agent\n\nawait pipeline.invoke(\"test\")\n\ncounter.assert_count(1)\nspy.assert_captured(\"test\")\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-basic-test-file","title":"Step-by-Step: Basic Test File","text":""},{"location":"skills/test-patterns/#step-1-create-test-file","title":"Step 1: Create Test File","text":"<p>Location: <code>impl/claude/&lt;module&gt;/_tests/test_&lt;feature&gt;.py</code></p> <p>Template: <pre><code>\"\"\"\nTests for &lt;feature&gt;.\n\nTests verify:\n1. &lt;what is being tested&gt;\n2. &lt;another behavior&gt;\n3. &lt;edge cases&gt;\n\"\"\"\n\nfrom __future__ import annotations\n\nimport pytest\n\n\nclass TestFeatureBehavior:\n    \"\"\"Tests for &lt;specific behavior&gt;.\"\"\"\n\n    def test_basic_case(self) -&gt; None:\n        \"\"\"&lt;What this test verifies&gt;.\"\"\"\n        # Arrange\n        thing = MyClass()\n\n        # Act\n        result = thing.do_something()\n\n        # Assert\n        assert result == expected\n\n    def test_edge_case(self) -&gt; None:\n        \"\"\"&lt;Edge case description&gt;.\"\"\"\n        # Arrange\n        thing = MyClass()\n\n        # Act / Assert\n        with pytest.raises(ValueError):\n            thing.do_invalid()\n</code></pre></p>"},{"location":"skills/test-patterns/#step-2-import-from-sibling-module","title":"Step 2: Import from Sibling Module","text":"<p>Use relative imports for the module under test:</p> <pre><code># Relative import from parent\nfrom ..my_module import MyClass, my_function\n\n# Or absolute import\nfrom protocols.agentese.contexts.world import WorldNode\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-async-tests","title":"Step-by-Step: Async Tests","text":""},{"location":"skills/test-patterns/#step-1-mark-test-as-async","title":"Step 1: Mark Test as Async","text":"<pre><code>import pytest\n\nclass TestAsyncBehavior:\n    \"\"\"Tests for async methods.\"\"\"\n\n    @pytest.mark.asyncio\n    async def test_async_method(self) -&gt; None:\n        \"\"\"Test async invocation.\"\"\"\n        agent = MyAgent()\n\n        result = await agent.invoke(\"input\")\n\n        assert result == \"expected\"\n</code></pre>"},{"location":"skills/test-patterns/#step-2-async-fixtures","title":"Step 2: Async Fixtures","text":"<pre><code>@pytest.fixture\nasync def initialized_store() -&gt; Store:\n    \"\"\"Create and initialize a store.\"\"\"\n    store = Store()\n    await store.initialize()\n    yield store\n    await store.cleanup()  # Cleanup after test\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-using-mock-fixtures","title":"Step-by-Step: Using Mock Fixtures","text":""},{"location":"skills/test-patterns/#step-1-create-mockumwelt-common-pattern","title":"Step 1: Create MockUmwelt (Common Pattern)","text":"<pre><code>from typing import Any\n\nclass MockDNA:\n    \"\"\"Mock DNA for testing.\"\"\"\n\n    def __init__(\n        self,\n        name: str = \"test\",\n        archetype: str = \"default\",\n        capabilities: tuple[str, ...] = (),\n    ) -&gt; None:\n        self.name = name\n        self.archetype = archetype\n        self.capabilities = capabilities\n\n\nclass MockUmwelt:\n    \"\"\"Mock Umwelt for testing.\"\"\"\n\n    def __init__(\n        self,\n        archetype: str = \"default\",\n        name: str = \"test\",\n        capabilities: tuple[str, ...] = (),\n    ) -&gt; None:\n        self.dna = MockDNA(name=name, archetype=archetype, capabilities=capabilities)\n        self.gravity: tuple[Any, ...] = ()\n        self.context: dict[str, Any] = {}\n</code></pre>"},{"location":"skills/test-patterns/#step-2-use-type-safe-cast-helper","title":"Step 2: Use Type-Safe Cast Helper","text":"<p>The <code>testing</code> module provides <code>as_umwelt()</code> for type-safe casting:</p> <pre><code>from testing import as_umwelt\nfrom typing import Any\nfrom bootstrap.umwelt import Umwelt\n\n@pytest.fixture\ndef observer() -&gt; Umwelt[Any, Any]:\n    \"\"\"Default observer fixture.\"\"\"\n    return as_umwelt(MockUmwelt())\n\n@pytest.fixture\ndef admin_observer() -&gt; Umwelt[Any, Any]:\n    \"\"\"Admin observer fixture.\"\"\"\n    return as_umwelt(MockUmwelt(archetype=\"admin\"))\n</code></pre> <p>This avoids mypy errors when passing mock objects to functions expecting <code>Umwelt[A, B]</code>.</p>"},{"location":"skills/test-patterns/#step-3-use-in-tests","title":"Step 3: Use in Tests","text":"<pre><code>@pytest.mark.asyncio\nasync def test_manifest(observer: Umwelt[Any, Any]) -&gt; None:\n    \"\"\"Test manifest for default observer.\"\"\"\n    node = MyNode()\n\n    result = await node.manifest(observer)\n\n    assert result.summary == \"Expected\"\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-global-fixtures-conftestpy","title":"Step-by-Step: Global Fixtures (conftest.py)","text":""},{"location":"skills/test-patterns/#step-1-understand-fixture-hierarchy","title":"Step 1: Understand Fixture Hierarchy","text":"<pre><code>impl/claude/conftest.py         # Root fixtures (used by 3+ files)\nimpl/claude/agents/conftest.py  # Agent-specific fixtures\nimpl/claude/protocols/agentese/_tests/conftest.py  # Module fixtures\n</code></pre>"},{"location":"skills/test-patterns/#step-2-available-testing-utilities","title":"Step 2: Available Testing Utilities","text":"<p>From <code>impl/claude/testing/__init__.py</code>:</p> Utility Type Description <code>as_umwelt(obj)</code> <code>Umwelt[Any, Any]</code> Type-safe cast for mock Umwelts <code>as_agent(obj)</code> <code>Agent[A, B]</code> Type-safe cast for mock Agents <code>simple_agents()</code> Hypothesis strategy Generates deterministic test agents <code>agent_chains(min, max)</code> Hypothesis strategy Lists of composable agents <code>valid_dna()</code> Hypothesis strategy Valid DNA configurations <code>invalid_dna()</code> Hypothesis strategy Invalid DNA for constraint testing <code>type_names()</code> Hypothesis strategy Valid type name strings <p>Note: Root conftest.py focuses on test infrastructure (flinch logging, markers). Module-specific fixtures should be defined in local <code>_tests/conftest.py</code> files.</p>"},{"location":"skills/test-patterns/#step-3-create-local-fixtures","title":"Step 3: Create Local Fixtures","text":"<p>For module-specific fixtures, add to <code>_tests/conftest.py</code>:</p> <pre><code># impl/claude/agents/myagent/_tests/conftest.py\nimport pytest\nfrom ..agent import MyAgent\n\n@pytest.fixture\ndef my_agent() -&gt; MyAgent:\n    \"\"\"Pre-configured MyAgent for tests.\"\"\"\n    return MyAgent(config=MyConfig())\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-custom-markers","title":"Step-by-Step: Custom Markers","text":""},{"location":"skills/test-patterns/#step-1-available-markers","title":"Step 1: Available Markers","text":"Marker Purpose <code>@pytest.mark.law(name)</code> Category law verification <code>@pytest.mark.law_identity</code> Identity law: <code>Id &gt;&gt; f == f</code> <code>@pytest.mark.law_associativity</code> <code>(f &gt;&gt; g) &gt;&gt; h == f &gt;&gt; (g &gt;&gt; h)</code> <code>@pytest.mark.law_functor_identity</code> <code>fmap id == id</code> <code>@pytest.mark.law_functor_composition</code> <code>fmap (g.f) == fmap g . fmap f</code> <code>@pytest.mark.slow</code> Slow-running test <code>@pytest.mark.property</code> Property-based test <code>@pytest.mark.accursed_share</code> Exploratory/chaos test"},{"location":"skills/test-patterns/#step-2-use-markers","title":"Step 2: Use Markers","text":"<pre><code>import pytest\n\n@pytest.mark.law_identity\n@pytest.mark.asyncio\nasync def test_identity_law() -&gt; None:\n    \"\"\"Verify identity law: Id &gt;&gt; f == f == f &gt;&gt; Id.\"\"\"\n    from bootstrap import compose\n    from conftest import IdentityAgent\n\n    id_agent = IdentityAgent()\n    f = DoubleAgent()\n\n    input_val = 5\n    result1 = await compose(id_agent, f).invoke(input_val)\n    result2 = await f.invoke(input_val)\n    result3 = await compose(f, id_agent).invoke(input_val)\n\n    assert result1 == result2 == result3\n\n\n@pytest.mark.slow\ndef test_large_data_processing() -&gt; None:\n    \"\"\"Test with large dataset (takes &gt;5s).\"\"\"\n    ...\n</code></pre>"},{"location":"skills/test-patterns/#step-3-run-specific-markers","title":"Step 3: Run Specific Markers","text":"<pre><code># Run only law tests\nuv run pytest -m \"law\"\n\n# Exclude slow tests\nuv run pytest -m \"not slow\"\n\n# Run property-based tests\nuv run pytest -m \"property\"\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-property-based-testing-hypothesis","title":"Step-by-Step: Property-Based Testing (Hypothesis)","text":""},{"location":"skills/test-patterns/#step-1-import-strategies","title":"Step 1: Import Strategies","text":"<pre><code>from hypothesis import given, settings\nfrom testing import simple_agents, agent_chains, valid_dna\n</code></pre>"},{"location":"skills/test-patterns/#step-2-write-property-test","title":"Step 2: Write Property Test","text":"<pre><code>from hypothesis import given, settings\nfrom testing import simple_agents\n\n@pytest.mark.property\n@given(agent=simple_agents())\n@settings(max_examples=50)\n@pytest.mark.asyncio\nasync def test_agent_composition_associativity(agent) -&gt; None:\n    \"\"\"Composition is associative for all generated agents.\"\"\"\n    from conftest import IdentityAgent\n\n    id_agent = IdentityAgent()\n\n    # (id &gt;&gt; agent) == agent\n    composed = await compose(id_agent, agent).invoke(10)\n    direct = await agent.invoke(10)\n\n    assert composed == direct\n</code></pre>"},{"location":"skills/test-patterns/#step-3-available-strategies","title":"Step 3: Available Strategies","text":"<p>From <code>testing.strategies</code>:</p> Strategy Description <code>simple_agents()</code> Deterministic agents with offset <code>agent_chains(min_length, max_length)</code> Lists of composable agents <code>valid_dna()</code> Valid DNA configurations <code>invalid_dna()</code> Invalid DNA for constraint testing <code>type_names()</code> Valid type name strings <code>json_like_values()</code> JSON-compatible values <code>boundary_inputs()</code> Edge case inputs"},{"location":"skills/test-patterns/#step-by-step-mock-agent-pattern","title":"Step-by-Step: Mock Agent Pattern","text":""},{"location":"skills/test-patterns/#step-1-minimal-mock","title":"Step 1: Minimal Mock","text":"<pre><code>from dataclasses import dataclass\nfrom typing import Any\n\n@dataclass\nclass EchoAgent:\n    \"\"\"Returns input with prefix.\"\"\"\n    name: str = \"Echo\"\n\n    async def invoke(self, input: Any) -&gt; str:\n        return f\"Echo: {input}\"\n</code></pre>"},{"location":"skills/test-patterns/#step-2-composable-mock","title":"Step 2: Composable Mock","text":"<pre><code>from dataclasses import dataclass\nfrom typing import Any, cast\nfrom bootstrap.types import Agent\n\n@dataclass\nclass DoubleAgent:\n    \"\"\"Doubles numeric input.\"\"\"\n    name: str = \"Double\"\n\n    async def invoke(self, input: int) -&gt; int:\n        return input * 2\n\n    def __rshift__(self, other: Any) -&gt; Any:\n        from bootstrap import compose\n        return compose(cast(Agent[Any, Any], self), other)\n</code></pre>"},{"location":"skills/test-patterns/#step-3-configurable-mock","title":"Step 3: Configurable Mock","text":"<pre><code>@dataclass\nclass RecordingAgent:\n    \"\"\"Records all invocations for verification.\"\"\"\n    name: str = \"Recorder\"\n    calls: list[Any] = field(default_factory=list)\n\n    async def invoke(self, input: Any) -&gt; Any:\n        self.calls.append(input)\n        return input\n\n# In test:\ndef test_agent_called() -&gt; None:\n    recorder = RecordingAgent()\n    await my_function(recorder)\n    assert len(recorder.calls) == 3\n</code></pre>"},{"location":"skills/test-patterns/#verification","title":"Verification","text":""},{"location":"skills/test-patterns/#test-1-run-single-test-file","title":"Test 1: Run single test file","text":"<pre><code>cd impl/claude\nuv run pytest path/to/_tests/test_feature.py -v\n</code></pre>"},{"location":"skills/test-patterns/#test-2-run-with-coverage","title":"Test 2: Run with coverage","text":"<pre><code>uv run pytest path/to/_tests/ --cov=path/to --cov-report=term-missing\n</code></pre>"},{"location":"skills/test-patterns/#test-3-run-specific-test","title":"Test 3: Run specific test","text":"<pre><code>uv run pytest path/to/_tests/test_feature.py::TestClass::test_method -v\n</code></pre>"},{"location":"skills/test-patterns/#test-4-run-all-tests","title":"Test 4: Run all tests","text":"<pre><code>cd impl/claude\nuv run pytest\n</code></pre>"},{"location":"skills/test-patterns/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/test-patterns/#1-missing-pytestmarkasyncio","title":"1. Missing <code>@pytest.mark.asyncio</code>","text":"<p>Symptom: <code>RuntimeWarning: coroutine 'test_foo' was never awaited</code></p> <p>Fix: Add the decorator: <pre><code>@pytest.mark.asyncio\nasync def test_async_method() -&gt; None:\n    ...\n</code></pre></p>"},{"location":"skills/test-patterns/#2-forgetting-to-cast-umwelt-mocks","title":"2. Forgetting to cast Umwelt mocks","text":"<p>Symptom: mypy errors about incompatible types</p> <p>Fix: Use <code>as_umwelt()</code>: <pre><code>from testing import as_umwelt\n\nobserver = as_umwelt(MockUmwelt())\n</code></pre></p>"},{"location":"skills/test-patterns/#3-not-awaiting-async-fixture","title":"3. Not awaiting async fixture","text":"<p>Symptom: Test passes but doesn't actually test anything</p> <p>Fix: Ensure async fixtures yield properly: <pre><code>@pytest.fixture\nasync def store() -&gt; AsyncIterator[Store]:\n    store = Store()\n    await store.initialize()\n    yield store\n    await store.cleanup()\n</code></pre></p>"},{"location":"skills/test-patterns/#4-import-path-issues","title":"4. Import path issues","text":"<p>Symptom: <code>ModuleNotFoundError</code></p> <p>Fix: Run tests from <code>impl/claude/</code> directory: <pre><code>cd impl/claude\nuv run pytest\n</code></pre></p>"},{"location":"skills/test-patterns/#5-test-isolation-failures","title":"5. Test isolation failures","text":"<p>Symptom: Tests pass individually but fail together</p> <p>Fix: Don't share mutable state between tests. Use fixtures with <code>function</code> scope (default): <pre><code>@pytest.fixture\ndef fresh_store() -&gt; Store:\n    return Store()  # New instance per test\n</code></pre></p>"},{"location":"skills/test-patterns/#6-flaky-async-tests","title":"6. Flaky async tests","text":"<p>Symptom: Test intermittently fails</p> <p>Fix: - Use <code>asyncio.wait_for()</code> with timeout - Avoid <code>asyncio.sleep()</code> for synchronization - Use events/queues for coordination</p>"},{"location":"skills/test-patterns/#test-organization-best-practices","title":"Test Organization Best Practices","text":"<ol> <li>One test class per behavior: Group related tests in classes</li> <li>Descriptive test names: <code>test_&lt;condition&gt;_&lt;expected_result&gt;</code></li> <li>Arrange-Act-Assert: Structure each test clearly</li> <li>Minimal fixtures: Only create what's needed</li> <li>Test one thing: Each test verifies one behavior</li> <li>Docstrings: Document what's being tested</li> </ol>"},{"location":"skills/test-patterns/#type-iv-judges-semantic-assertions","title":"Type IV: Judges (Semantic Assertions)","text":"<p>For LLM outputs where exact matching is impossible. Uses metamorphic relations.</p>"},{"location":"skills/test-patterns/#oracle-validation","title":"Oracle Validation","text":"<pre><code>from testing import Oracle, SubsetRelation, PermutationInvarianceRelation\n\nclass TestSemanticCorrectness:\n    \"\"\"Semantic validation for LLM outputs.\"\"\"\n\n    async def test_summary_contains_key_facts(self) -&gt; None:\n        \"\"\"Oracle validates semantic correctness.\"\"\"\n        oracle = Oracle()\n\n        relation = SubsetRelation(\n            base_extractor=extract_key_facts,\n            derived_extractor=extract_summary_facts,\n        )\n\n        document = \"...\"\n        summary = await summarizer.invoke(document)\n\n        result = await oracle.validate(\n            base_input=document,\n            derived_input=summary,\n            relation=relation,\n        )\n\n        assert result.passed, f\"Missing facts: {result.violations}\"\n</code></pre>"},{"location":"skills/test-patterns/#trustgate-for-agent-actions","title":"TrustGate for Agent Actions","text":"<pre><code>from agents.t import TrustGate, Proposal, create_trust_gate\n\ngate = create_trust_gate(\n    judgment_threshold=0.8,\n    risk_threshold=0.3,\n)\n\nproposal = Proposal(\n    agent=\"my-agent\",\n    action=\"modify database schema\",\n    diff=\"ALTER TABLE...\",\n    risk=0.4,\n)\n\ndecision = await gate.evaluate(proposal, agent=\"my-agent\")\n\nif decision.approved:\n    print(\"Approved\")\nelif decision.bypass_cost:\n    print(f\"Denied. Bypass cost: {decision.bypass_cost}\")\n</code></pre>"},{"location":"skills/test-patterns/#type-v-witnesses-integration","title":"Type V: Witnesses (Integration)","text":"<p>End-to-end tests verifying full system behavior.</p>"},{"location":"skills/test-patterns/#topologist-for-composition","title":"Topologist for Composition","text":"<pre><code>from testing import Topologist\n\nclass TestComposition:\n    async def test_associativity_under_noise(self) -&gt; None:\n        \"\"\"(f &gt;&gt; g) &gt;&gt; h == f &gt;&gt; (g &gt;&gt; h) even with noise.\"\"\"\n        topologist = Topologist()\n\n        report = await topologist.verify_associativity(\n            agents=[agent_a, agent_b, agent_c],\n            inputs=test_inputs,\n            noise_level=0.1,\n        )\n\n        assert report.passed\n</code></pre>"},{"location":"skills/test-patterns/#cortex-assurance-system","title":"Cortex Assurance System","text":"<pre><code>from testing import Cortex, create_enhanced_cortex\n\nclass TestSystem:\n    async def test_full_assurance(self) -&gt; None:\n        \"\"\"Full Cortex assurance system.\"\"\"\n        cortex = create_enhanced_cortex()\n\n        briefing = await cortex.run_briefing(\n            agents=[agent],\n            test_inputs=inputs,\n            budget_tier=\"quick\",\n        )\n\n        print(briefing.summary)\n        assert briefing.overall_health &gt;= 0.8\n</code></pre>"},{"location":"skills/test-patterns/#testing-module-exports","title":"Testing Module Exports","text":"<pre><code>from testing import (\n    # Fixtures\n    as_umwelt, as_agent,\n    # Strategies (Hypothesis)\n    simple_agents, agent_chains, valid_dna, invalid_dna, type_names,\n    # Oracle (Phase 8)\n    Oracle, MetamorphicRelation, SubsetRelation,\n    IdempotencyRelation, PermutationInvarianceRelation,\n    # Topologist\n    Topologist, TopologistReport, NoiseFunctor,\n    # Analyst\n    CausalAnalyst, WitnessStore, DeltaDebugResult,\n    # Market\n    TestMarket, BudgetManager, BudgetTier,\n    # Red Team\n    RedTeam, AdversarialInput, MutationScore,\n    # Cortex\n    Cortex, create_enhanced_cortex, BriefingReport,\n)\n</code></pre>"},{"location":"skills/test-patterns/#stress-testing-patterns","title":"Stress Testing Patterns","text":"<p>The Wave 1 stress tests demonstrate three key patterns for high-confidence reactive code.</p>"},{"location":"skills/test-patterns/#property-based-testing-hypothesis","title":"Property-Based Testing (Hypothesis)","text":"<p>Use Hypothesis to test invariants across many generated inputs:</p> <pre><code>from hypothesis import given, settings, strategies as st\nimport pytest\n\nfrom agents.i.reactive.signal import Signal, Snapshot\n\n@given(st.integers())\ndef test_snapshot_restore_roundtrip(value: int) -&gt; None:\n    \"\"\"Any value can be snapshot and restored.\"\"\"\n    sig = Signal.of(value)\n    snap = sig.snapshot()\n    sig.set(value + 1)\n    sig.restore(snap)\n    assert sig.value == value\n\n@given(st.lists(st.integers(min_value=-1000, max_value=1000), min_size=1, max_size=50))\ndef test_generation_monotonic(values: list[int]) -&gt; None:\n    \"\"\"Generation always increases on distinct value changes.\"\"\"\n    sig = Signal.of(values[0])\n    prev_gen = sig.generation\n    for v in values[1:]:\n        if v != sig.value:\n            sig.set(v)\n            assert sig.generation &gt; prev_gen\n            prev_gen = sig.generation\n\n@given(st.text(min_size=0, max_size=100))\ndef test_signal_text_values(text: str) -&gt; None:\n    \"\"\"Signal works with arbitrary text values.\"\"\"\n    sig = Signal.of(text)\n    snap = sig.snapshot()\n    sig.set(\"changed\")\n    sig.restore(snap)\n    assert sig.value == text\n</code></pre> <p>Key strategies: - <code>st.integers()</code> - arbitrary integers - <code>st.text()</code> - unicode strings - <code>st.floats(allow_nan=False)</code> - safe floats - <code>st.lists()</code> - lists of other strategies</p>"},{"location":"skills/test-patterns/#performance-baselines","title":"Performance Baselines","text":"<p>Set performance budgets that fail if violated:</p> <pre><code>import time\n\ndef test_signal_snapshot_performance() -&gt; None:\n    \"\"\"Signal snapshot/restore should be fast.\"\"\"\n    sig = Signal.of(0)\n\n    start = time.perf_counter()\n    for i in range(10000):\n        sig.set(i)\n        snap = sig.snapshot()\n        sig.restore(snap)\n    elapsed = time.perf_counter() - start\n\n    # Should complete 10000 cycles in under 1 second\n    assert elapsed &lt; 1.0, f\"Signal snapshot cycle too slow: {elapsed:.3f}s\"\n\ndef test_computed_recompute_performance() -&gt; None:\n    \"\"\"Computed recomputation should be fast.\"\"\"\n    sig = Signal.of(0)\n    computed = sig.map(lambda x: x * 2 + 1)\n\n    start = time.perf_counter()\n    for i in range(10000):\n        sig.set(i)\n        _ = computed.value\n    elapsed = time.perf_counter() - start\n\n    assert elapsed &lt; 1.0, f\"Computed recompute too slow: {elapsed:.3f}s\"\n\ndef test_subscriber_notification_performance() -&gt; None:\n    \"\"\"Subscriber notifications should be fast.\"\"\"\n    sig = Signal.of(-1)\n    count = [0]\n\n    for _ in range(10):\n        sig.subscribe(lambda v: count.__setitem__(0, count[0] + 1))\n\n    start = time.perf_counter()\n    for i in range(10000):\n        sig.set(i)\n    elapsed = time.perf_counter() - start\n\n    assert elapsed &lt; 1.0, f\"Subscriber notification too slow: {elapsed:.3f}s\"\n    assert count[0] == 100000  # 10 subscribers * 10000 updates\n</code></pre>"},{"location":"skills/test-patterns/#high-iteration-stress-tests","title":"High-Iteration Stress Tests","text":"<p>Test stability under load:</p> <pre><code>import random\n\ndef test_signal_1000_snapshots() -&gt; None:\n    \"\"\"Signal handles 1000 snapshots without degradation.\"\"\"\n    sig = Signal.of(0)\n    snapshots: list[Snapshot[int]] = []\n\n    for i in range(1000):\n        sig.set(i)\n        snapshots.append(sig.snapshot())\n\n    # Restore 100 random snapshots\n    sample = random.sample(snapshots, 100)\n    for snap in sample:\n        sig.restore(snap)\n        assert sig.value == snap.value\n\ndef test_signal_100_subscribers() -&gt; None:\n    \"\"\"Signal handles 100 concurrent subscribers.\"\"\"\n    sig = Signal.of(0)\n    results: list[list[int]] = [[] for _ in range(100)]\n\n    unsubs = []\n    for i in range(100):\n        idx = i\n        def callback(v: int, idx: int = idx) -&gt; None:\n            results[idx].append(v)\n        unsubs.append(sig.subscribe(callback))\n\n    for j in range(1, 51):\n        sig.set(j)\n\n    for r in results:\n        assert r == list(range(1, 51))\n\n    for unsub in unsubs:\n        unsub()\n\ndef test_modal_scope_deep_nesting() -&gt; None:\n    \"\"\"ModalScope handles 50-deep branch nesting.\"\"\"\n    from agents.d.modal_scope import ModalScope\n\n    root = ModalScope.create_root()\n    current = root\n\n    for i in range(50):\n        current = current.branch(f\"level-{i}\", budget=0.99)\n\n    assert current.depth == 50\n</code></pre>"},{"location":"skills/test-patterns/#boundary-value-tests","title":"Boundary Value Tests","text":"<p>Test edge cases explicitly:</p> <pre><code>@pytest.mark.parametrize(\"entropy\", [0.0, 0.5, 1.0, 0.001, 0.999])\ndef test_entropy_boundary_values(entropy: float) -&gt; None:\n    \"\"\"entropy_to_distortion handles boundary values.\"\"\"\n    from agents.i.reactive.entropy import entropy_to_distortion\n\n    distortion = entropy_to_distortion(entropy, seed=42, t=0.0)\n    assert isinstance(distortion.blur, float)\n    assert isinstance(distortion.skew, float)\n\ndef test_turn_empty_content() -&gt; None:\n    \"\"\"Turn handles empty content.\"\"\"\n    from protocols.api.turn import Turn\n\n    turn = Turn(speaker=\"test\", content=\"\", timestamp=0.0)\n    assert turn.to_cli() == \"[test]: \"\n\ndef test_turn_unicode_content() -&gt; None:\n    \"\"\"Turn handles unicode/emoji content.\"\"\"\n    from protocols.api.turn import Turn\n\n    turn = Turn(speaker=\"\ud83e\udd16\", content=\"Hello \u4e16\u754c! \ud83c\udf0d\", timestamp=0.0)\n    cli = turn.to_cli()\n    assert \"\ud83e\udd16\" in cli\n    assert \"\u4e16\u754c\" in cli\n</code></pre>"},{"location":"skills/test-patterns/#running-stress-tests","title":"Running Stress Tests","text":"<pre><code>cd impl/claude\n\n# Run all stress tests\nuv run pytest -k \"stress\" -v\n\n# Run property-based tests\nuv run pytest agents/i/reactive/_tests/test_wave1_stress.py -v\n\n# Run with verbose hypothesis output\nuv run pytest --hypothesis-show-statistics agents/i/reactive/_tests/test_wave1_stress.py\n</code></pre>"},{"location":"skills/test-patterns/#related-skills","title":"Related Skills","text":"<ul> <li>building-agent - Creating well-formed agents</li> <li>flux-agent - Testing async streaming agents</li> <li>handler-patterns - Testing CLI handlers</li> <li>agent-observability - Metrics and debugging</li> <li>reactive-primitives - Signal/Computed/Effect</li> <li>modal-scope-branching - Context branching</li> </ul>"},{"location":"skills/test-patterns/#changelog","title":"Changelog","text":"<ul> <li>2025-12-14: Added stress testing patterns (property-based, performance baselines, boundary tests)</li> <li>2025-12-12: Added T-gent Types I-V taxonomy, T-gent test agents, Oracle, Cortex patterns</li> <li>2025-12-12: Initial version based on conftest.py and testing patterns</li> </ul>"},{"location":"skills/three-phase/","title":"Skill: Three-Phase Cycle","text":"<p>The primary implementation lifecycle: UNDERSTAND \u2192 ACT \u2192 REFLECT</p> <p>Difficulty: Easy Prerequisites: None</p>"},{"location":"skills/three-phase/#overview","title":"Overview","text":"<p>The Three-Phase Cycle is the default workflow for all development work. Use it for everything unless you explicitly need the full 11-phase ceremony.</p> <pre><code>UNDERSTAND \u2192 ACT \u2192 REFLECT \u2192 (loop)\n</code></pre>"},{"location":"skills/three-phase/#understand","title":"UNDERSTAND","text":"<p>Purpose: Map the terrain before acting.</p> <p>Activities: - Frame intent and scope - Read relevant code/patterns - Identify blockers and dependencies - Choose approach</p> <p>Exit: Clear understanding of what needs to change.</p>"},{"location":"skills/three-phase/#act","title":"ACT","text":"<p>Purpose: Ship working code with quality.</p> <p>Activities: - Write implementation - Run quality checks (mypy, ruff, tests) - Verify coverage - Document if user-facing</p> <p>Exit: Code works, tests pass.</p>"},{"location":"skills/three-phase/#reflect","title":"REFLECT","text":"<p>Purpose: Extract learnings, seed next cycle.</p> <p>Activities: - Note what worked and what didn't - Append atomic insights to <code>meta.md</code> if generalizable - Generate continuation prompt if needed</p> <p>Exit: Learnings captured.</p>"},{"location":"skills/three-phase/#continuation","title":"Continuation","text":"<p>End each phase with a minimal prompt:</p> <pre><code># Next: [UNDERSTAND|ACT|REFLECT]\n\n/hydrate\n\nMission: [One sentence]\nExit: [One criterion]\n</code></pre>"},{"location":"skills/three-phase/#when-to-expand","title":"When to Expand","text":"<p>Use the full 11-phase cycle only when:</p> <ol> <li>Multi-week scope with multiple agents</li> <li>Architectural decisions affecting many components</li> <li>Novel territory with no existing patterns</li> </ol> <p>See n-phase-cycle/README.md for the full ceremony.</p>"},{"location":"skills/three-phase/#example-bug-fix","title":"Example: Bug Fix","text":"<p>UNDERSTAND: Read failing test \u2192 read code \u2192 identify root cause</p> <p>ACT: Write fix \u2192 run tests \u2192 verify mypy</p> <p>REFLECT: Note \"edge case with empty input\" \u2192 no epilogue needed</p>"},{"location":"skills/three-phase/#related","title":"Related","text":"<ul> <li>n-phase-cycle/ \u2014 Full 11-phase for Crown Jewels</li> <li>plan-file \u2014 Writing plan files</li> </ul> <p>Last updated: 2025-12-15</p>"},{"location":"skills/turn-projectors/","title":"Skill: Turn Projector Pattern","text":"<p>One Turn, many projections: render conversation moments to any target.</p> <p>Difficulty: Easy Prerequisites: Python dataclasses, basic JSON Files: <code>impl/claude/protocols/api/turn.py</code> References: <code>protocols/api/_tests/test_turn.py</code>, <code>weave/turn.py</code></p>"},{"location":"skills/turn-projectors/#overview","title":"Overview","text":"<p>A Turn is the atomic unit of conversation\u2014a single speaker saying something at a point in time. The key insight is holographic: from one Turn, all views derive.</p> Projector Output Use Case <code>to_cli()</code> Plain text Terminal output <code>to_tui()</code> Rich Text Interactive TUI <code>to_json()</code> Dict API responses, storage <code>to_json_str()</code> JSON string Wire format <code>to_marimo()</code> HTML Notebook rendering <code>to_sse()</code> SSE format Streaming responses"},{"location":"skills/turn-projectors/#create-a-turn","title":"Create a Turn","text":"<pre><code>from protocols.api.turn import Turn\n\nturn = Turn(\n    speaker=\"kgent\",\n    content=\"Hello! How can I help you today?\",\n    timestamp=1734200000.0,\n    meta={\"confidence\": 0.95},\n)\n</code></pre> <p>Fields: - <code>speaker</code>: Who is speaking (e.g., \"user\", \"assistant\", \"kgent\", \"system\") - <code>content</code>: The message text - <code>timestamp</code>: Unix timestamp (seconds since epoch) - <code>meta</code>: Optional metadata dict (tool calls, citations, etc.)</p> <p>Note: Turn is frozen (immutable). Once created, it cannot be modified.</p>"},{"location":"skills/turn-projectors/#projections","title":"Projections","text":""},{"location":"skills/turn-projectors/#to_cli-terminal-output","title":"to_cli() - Terminal Output","text":"<pre><code>print(turn.to_cli())\n# Output: [kgent]: Hello! How can I help you today?\n</code></pre> <p>Simple <code>[speaker]: content</code> format.</p>"},{"location":"skills/turn-projectors/#to_tui-rich-terminal","title":"to_tui() - Rich Terminal","text":"<pre><code>from rich.console import Console\n\nconsole = Console()\nconsole.print(turn.to_tui())\n# Output: Bold colored speaker, styled content\n</code></pre> <p>Speaker colors: - <code>user</code> \u2192 cyan - <code>assistant</code> \u2192 green - <code>kgent</code> \u2192 magenta - <code>system</code> \u2192 yellow</p> <p>Falls back to <code>to_cli()</code> if Rich is not installed.</p>"},{"location":"skills/turn-projectors/#to_json-dict-format","title":"to_json() - Dict Format","text":"<pre><code>data = turn.to_json()\n# {\n#     \"speaker\": \"kgent\",\n#     \"content\": \"Hello! How can I help you today?\",\n#     \"timestamp\": 1734200000.0,\n#     \"meta\": {\"confidence\": 0.95}\n# }\n</code></pre> <p>Use for API responses, logging, and storage.</p>"},{"location":"skills/turn-projectors/#to_json_str-json-string","title":"to_json_str() - JSON String","text":"<pre><code>json_str = turn.to_json_str()\n# '{\"speaker\": \"kgent\", \"content\": \"Hello!...\", ...}'\n</code></pre> <p>Direct serialization convenience.</p>"},{"location":"skills/turn-projectors/#to_marimo-notebook-html","title":"to_marimo() - Notebook HTML","text":"<pre><code>html = turn.to_marimo()\n# Returns styled HTML div with speaker-based colors\n</code></pre> <p>Renders as conversation bubbles: - <code>user</code> \u2192 blue left border - <code>assistant</code> \u2192 green left border - <code>kgent</code> \u2192 purple left border - <code>system</code> \u2192 yellow left border</p>"},{"location":"skills/turn-projectors/#to_sse-server-sent-events","title":"to_sse() - Server-Sent Events","text":"<pre><code>sse = turn.to_sse()\n# \"data: {\\\"speaker\\\": \\\"kgent\\\", ...}\\n\\n\"\n</code></pre> <p>Follows SSE specification format for streaming APIs.</p>"},{"location":"skills/turn-projectors/#immutable-updates","title":"Immutable Updates","text":"<p>Since Turn is frozen, use <code>with_meta()</code> to add metadata:</p> <pre><code>turn2 = turn.with_meta(edited=True, reason=\"typo fix\")\n# Original turn unchanged\n# turn2 has merged metadata\n</code></pre>"},{"location":"skills/turn-projectors/#helper-methods","title":"Helper Methods","text":""},{"location":"skills/turn-projectors/#summarize-short-preview","title":"summarize() - Short Preview","text":"<pre><code>turn.summarize(max_length=30)\n# \"[kgent]: Hello! How can I hel...\"\n</code></pre> <p>Useful for logging and compact displays.</p>"},{"location":"skills/turn-projectors/#collection-helpers","title":"Collection Helpers","text":""},{"location":"skills/turn-projectors/#turns_to_markdown","title":"turns_to_markdown()","text":"<pre><code>from protocols.api.turn import turns_to_markdown\n\nturns = [turn1, turn2, turn3]\nmd = turns_to_markdown(turns)\n# **user**: What is the weather?\n#\n# **assistant**: It's sunny today.\n#\n# ...\n</code></pre>"},{"location":"skills/turn-projectors/#turns_to_json","title":"turns_to_json()","text":"<pre><code>from protocols.api.turn import turns_to_json\n\ndata = turns_to_json(turns)\n# [{\"speaker\": \"user\", ...}, {\"speaker\": \"assistant\", ...}, ...]\n</code></pre>"},{"location":"skills/turn-projectors/#full-example","title":"Full Example","text":"<pre><code>from protocols.api.turn import Turn, turns_to_markdown\nimport time\n\n# Create conversation\nconversation = [\n    Turn(speaker=\"user\", content=\"What time is it?\", timestamp=time.time()),\n    Turn(speaker=\"kgent\", content=\"It's 3:42 PM.\", timestamp=time.time()),\n    Turn(speaker=\"user\", content=\"Thanks!\", timestamp=time.time()),\n]\n\n# Render to different targets\nfor turn in conversation:\n    print(turn.to_cli())          # Terminal\n    # turn.to_tui()               # Rich TUI\n    # turn.to_marimo()            # Notebook\n    # turn.to_sse()               # Streaming\n\n# Bulk operations\nprint(turns_to_markdown(conversation))  # Markdown export\napi_response = turns_to_json(conversation)  # JSON API\n</code></pre>"},{"location":"skills/turn-projectors/#advanced-weave-turn","title":"Advanced: Weave Turn","text":"<p>For agents with causal structure, use <code>weave.turn.Turn</code>:</p> <pre><code>from weave.turn import Turn, TurnType\n\nturn = Turn.create_turn(\n    content=\"Executing query...\",\n    source=\"agent-a\",\n    turn_type=TurnType.ACTION,\n    state_pre={\"status\": \"idle\"},\n    state_post={\"status\": \"querying\"},\n    confidence=0.95,\n    entropy_cost=0.02,\n)\n\n# Query turn properties\nprint(turn.is_effectful())        # True (ACTION type)\nprint(turn.requires_governance())  # True (ACTION requires review)\nprint(turn.is_observable())        # True (not THOUGHT)\n</code></pre> <p>TurnTypes: - <code>SPEECH</code>: Utterance to user/agent - <code>ACTION</code>: Tool call, side effect - <code>THOUGHT</code>: Internal chain-of-thought (hidden by default) - <code>YIELD</code>: Request for approval (blocks) - <code>SILENCE</code>: Intentional non-action</p>"},{"location":"skills/turn-projectors/#verification","title":"Verification","text":"<pre><code>cd impl/claude\nuv run pytest protocols/api/_tests/test_turn.py -v\nuv run pytest protocols/api/_tests/test_turn_stress.py -v\n</code></pre>"},{"location":"skills/turn-projectors/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/turn-projectors/#1-trying-to-modify-frozen-turn","title":"1. Trying to Modify Frozen Turn","text":"<pre><code>turn.content = \"new\"  # FrozenInstanceError!\n</code></pre> <p>Fix: Use <code>with_meta()</code> or create a new Turn.</p>"},{"location":"skills/turn-projectors/#2-missing-timestamp","title":"2. Missing Timestamp","text":"<pre><code># Use time.time() for current timestamp\nturn = Turn(speaker=\"user\", content=\"Hi\", timestamp=time.time())\n</code></pre>"},{"location":"skills/turn-projectors/#3-forgetting-meta-is-optional","title":"3. Forgetting Meta is Optional","text":"<pre><code># Meta defaults to empty dict\nturn = Turn(speaker=\"user\", content=\"Hi\", timestamp=0.0)\nprint(turn.meta)  # {}\n</code></pre>"},{"location":"skills/turn-projectors/#category-theory-note","title":"Category Theory Note","text":"<p>Turn is a product type with projection morphisms. Each projector (<code>to_cli</code>, <code>to_tui</code>, etc.) is a natural transformation from the Turn functor to the target rendering category.</p> <p>The holographic principle: all views derive from the same source data.</p>"},{"location":"skills/turn-projectors/#related-skills","title":"Related Skills","text":"<ul> <li>reactive-primitives - Observable state management</li> <li>modal-scope-branching - Context windows</li> <li>handler-patterns - CLI handlers that use Turn</li> </ul>"},{"location":"skills/turn-projectors/#source-reference","title":"Source Reference","text":"<p><code>impl/claude/protocols/api/turn.py:36-254</code></p> <p>Skill created: 2025-12-14 | Wave 1 EDUCATE Phase</p>"},{"location":"skills/user-flow-documentation/","title":"Skill: User Flow Documentation","text":"<p>Document precise user flows with ASCII wireframes for implementation grounding.</p> <p>Difficulty: Medium Prerequisites: Understanding of the feature being documented Use Cases: Plan files, spec files, design documents</p>"},{"location":"skills/user-flow-documentation/#overview","title":"Overview","text":"<p>User flow documentation captures the complete interaction sequence between a user and system. Well-documented flows enable:</p> <ol> <li>Implementation grounding: Developers know exactly what to build</li> <li>UX consistency: Patterns carry across features</li> <li>Review efficiency: Stakeholders can evaluate before code</li> <li>Test derivation: Flows become acceptance test scripts</li> </ol>"},{"location":"skills/user-flow-documentation/#flow-documentation-structure","title":"Flow Documentation Structure","text":""},{"location":"skills/user-flow-documentation/#1-flow-header","title":"1. Flow Header","text":"<pre><code>### Flow N: Descriptive Name (\"The Evocative Subtitle\")\n</code></pre> <p>Components: - Flow number: Sequential within document - Descriptive name: What happens (e.g., \"First Task\") - Evocative subtitle: The emotional/experiential core (e.g., \"The Quick Win\")</p> <p>Examples: <pre><code>### Flow 1: First-Time Spectator (\"The Curious Visitor\")\n### Flow 2: First-Time Builder (\"The Hesitant Creator\")\n### Flow 3: Consent Negotiation (\"The Refusal Moment\")\n### Flow 4: Morning Start (\"The Dawn Protocol\")\n</code></pre></p>"},{"location":"skills/user-flow-documentation/#2-context-block","title":"2. Context Block","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 ENTRY: What triggers this flow                                               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 OR                                                                           \u2502\n\u2502 CONTEXT: What situation the user is in                                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Use ENTRY for: User-initiated flows (clicking, typing, navigating) Use CONTEXT for: System-initiated or situational flows</p>"},{"location":"skills/user-flow-documentation/#3-step-blocks","title":"3. Step Blocks","text":"<p>Each step follows this pattern:</p> <pre><code>\u2502  N. STEP NAME (timing if relevant)                                           \u2502\n\u2502     \u251c\u2500\u2500 Action or observation                                                \u2502\n\u2502     \u251c\u2500\u2500 Another action                                                       \u2502\n\u2502     \u2502   \u2514\u2500\u2500 Sub-detail if needed                                             \u2502\n\u2502     \u2514\u2500\u2500 Final action in step                                                 \u2502\n</code></pre> <p>Timing annotations: - <code>(0-10 seconds)</code> \u2014 User time in step - <code>(T+15 minutes)</code> \u2014 Elapsed time from start - <code>(background, 5-30 seconds)</code> \u2014 Async operation</p>"},{"location":"skills/user-flow-documentation/#4-wireframe-blocks","title":"4. Wireframe Blocks","text":"<p>ASCII wireframes show exact UI state:</p> <pre><code>\u2502     \u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502     \u2502   \u2502  TITLE BAR                              [Action] [Action2]  \u2502     \u2502\n\u2502     \u2502   \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524     \u2502\n\u2502     \u2502   \u2502                                                             \u2502     \u2502\n\u2502     \u2502   \u2502  Content area with description                              \u2502     \u2502\n\u2502     \u2502   \u2502                                                             \u2502     \u2502\n\u2502     \u2502   \u2502  \u2022 Bullet point                                             \u2502     \u2502\n\u2502     \u2502   \u2502  \u2022 Another point                                            \u2502     \u2502\n\u2502     \u2502   \u2502                                                             \u2502     \u2502\n\u2502     \u2502   \u2502  [Primary Button] [Secondary Button]                        \u2502     \u2502\n\u2502     \u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502\n</code></pre> <p>Wireframe conventions: - <code>[Text]</code> \u2014 Clickable buttons/actions - <code>\u2502 \u251c\u2500\u2500 \u2514\u2500\u2500</code> \u2014 Tree structure for hierarchy - <code>\u2500\u2500\u2500\u2500\u2500\u2500\u2500</code> \u2014 Horizontal dividers - <code>\u2588\u2588\u2588\u2588\u2588\u2591\u2591\u2591\u2591\u2591</code> \u2014 Progress bars (filled/empty) - <code>&gt; _</code> \u2014 Input cursor/prompt</p>"},{"location":"skills/user-flow-documentation/#5-decision-points","title":"5. Decision Points","text":"<p>Show branching with explicit labels:</p> <pre><code>\u2502  3a. IF USER CHOOSES [Option A]                                              \u2502\n\u2502     \u251c\u2500\u2500 What happens                                                         \u2502\n\u2502     \u2514\u2500\u2500 Outcome                                                              \u2502\n\u2502                                                                              \u2502\n\u2502  3b. IF USER CHOOSES [Option B]                                              \u2502\n\u2502     \u251c\u2500\u2500 Different path                                                       \u2502\n\u2502     \u2514\u2500\u2500 Different outcome                                                    \u2502\n\u2502                                                                              \u2502\n\u2502  3c. IF USER CHOOSES [Option C]                                              \u2502\n\u2502     \u251c\u2500\u2500 Third path                                                           \u2502\n\u2502     \u2514\u2500\u2500 Third outcome                                                        \u2502\n</code></pre>"},{"location":"skills/user-flow-documentation/#complete-flow-template","title":"Complete Flow Template","text":"<pre><code>### Flow N: Name (\"Subtitle\")\n\n\\`\\`\\`\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 ENTRY: Trigger description                                                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                              \u2502\n\u2502  1. FIRST STEP (timing)                                                      \u2502\n\u2502     \u251c\u2500\u2500 First action                                                         \u2502\n\u2502     \u251c\u2500\u2500 Second action                                                        \u2502\n\u2502     \u2502                                                                        \u2502\n\u2502     \u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502     \u2502   \u2502  UI STATE                                                   \u2502     \u2502\n\u2502     \u2502   \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524     \u2502\n\u2502     \u2502   \u2502                                                             \u2502     \u2502\n\u2502     \u2502   \u2502  Content                                                    \u2502     \u2502\n\u2502     \u2502   \u2502                                                             \u2502     \u2502\n\u2502     \u2502   \u2502  [Action] [Action]                                          \u2502     \u2502\n\u2502     \u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502\n\u2502     \u2502                                                                        \u2502\n\u2502     \u2514\u2500\u2500 Closing observation                                                  \u2502\n\u2502                                                                              \u2502\n\u2502  2. SECOND STEP (timing)                                                     \u2502\n\u2502     \u251c\u2500\u2500 Action                                                               \u2502\n\u2502     \u2514\u2500\u2500 Outcome                                                              \u2502\n\u2502                                                                              \u2502\n\u2502  3. DECISION POINT                                                           \u2502\n\u2502     \u251c\u2500\u2500 User makes choice                                                    \u2502\n\u2502                                                                              \u2502\n\u2502  3a. IF [Choice A]                                                           \u2502\n\u2502     \u251c\u2500\u2500 Path A actions                                                       \u2502\n\u2502     \u2514\u2500\u2500 Path A outcome                                                       \u2502\n\u2502                                                                              \u2502\n\u2502  3b. IF [Choice B]                                                           \u2502\n\u2502     \u251c\u2500\u2500 Path B actions                                                       \u2502\n\u2502     \u2514\u2500\u2500 Path B outcome                                                       \u2502\n\u2502                                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\\`\\`\\`\n</code></pre>"},{"location":"skills/user-flow-documentation/#interaction-micropatterns","title":"Interaction Micropatterns","text":"<p>For reusable UI components, document as micropatterns:</p> <pre><code>### Pattern Name\n\n\\`\\`\\`\nDescription of when this pattern is used:\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 COMPONENT TITLE                                              \u2502\n\u2502                                                              \u2502\n\u2502 Element 1:    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591 40%                      \u2502\n\u2502 Element 2:    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591\u2591\u2591\u2591\u2591 70%                      \u2502\n\u2502                                                              \u2502\n\u2502 [Action] [Action] [Action]                                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\\`\\`\\`\n</code></pre>"},{"location":"skills/user-flow-documentation/#visual-vocabulary","title":"Visual Vocabulary","text":""},{"location":"skills/user-flow-documentation/#progress-indicators","title":"Progress Indicators","text":"<pre><code>Empty:     \u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\nPartial:   \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591 40%\nFull:      \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588 100%\nWarning:   \u2588\u2588\u2588\u2588\u2588\u2588\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591\u2591 30% \u26a0\ufe0f\n</code></pre>"},{"location":"skills/user-flow-documentation/#state-icons","title":"State Icons","text":"<pre><code>Success:   \u2705 \u2713\nWarning:   \u26a0\ufe0f\nError:     \u2717 \u274c\nInfo:      \u2139\ufe0f \ud83d\udca1\nActive:    \ud83d\udfe2 \u2588\u2588\u2588\u2588\nIdle:      \ud83d\udfe1 \u2591\u2591\u2591\u2591\nThinking:  \u223f\u223f\u223f\u223f\nLoading:   \ud83d\udd04\n</code></pre>"},{"location":"skills/user-flow-documentation/#arrows-and-flow","title":"Arrows and Flow","text":"<pre><code>Single:    \u2192  \u2190  \u2191  \u2193\nDouble:    \u21d2  \u21d0  \u21d1  \u21d3\nWith data: \u2500\u2500\u26a1\u2500\u2500\u25ba  (message with latency)\nBranch:    \u252c  \u251c  \u2514\n</code></pre>"},{"location":"skills/user-flow-documentation/#box-drawing","title":"Box Drawing","text":"<pre><code>Corners:   \u250c  \u2510  \u2514  \u2518\nLines:     \u2500  \u2502\nJunctions: \u252c  \u2534  \u251c  \u2524  \u253c\n</code></pre>"},{"location":"skills/user-flow-documentation/#flow-categories","title":"Flow Categories","text":""},{"location":"skills/user-flow-documentation/#entry-flows-the-first-time","title":"Entry Flows (\"The First Time\")","text":"<ul> <li>Purpose: Onboarding, discovery</li> <li>Key elements: Minimal friction, immediate value, gradual reveal</li> <li>Naming convention: \"First-Time [Role]\", \"The [Emotion] [Moment]\"</li> </ul>"},{"location":"skills/user-flow-documentation/#core-loops-the-daily","title":"Core Loops (\"The Daily\")","text":"<ul> <li>Purpose: Primary repeated action</li> <li>Key elements: Efficiency, keyboard shortcuts, muscle memory</li> <li>Naming convention: \"[Action] Flow\", \"The [Ritual]\"</li> </ul>"},{"location":"skills/user-flow-documentation/#edge-cases-the-exception","title":"Edge Cases (\"The Exception\")","text":"<ul> <li>Purpose: Error recovery, unusual situations</li> <li>Key elements: Clear guidance, recovery path, no dead ends</li> <li>Naming convention: \"[Situation] Handling\", \"The [Challenge]\"</li> </ul>"},{"location":"skills/user-flow-documentation/#advanced-flows-the-power-move","title":"Advanced Flows (\"The Power Move\")","text":"<ul> <li>Purpose: Expert features, customization</li> <li>Key elements: Depth without complexity, progressive disclosure</li> <li>Naming convention: \"Custom [Feature]\", \"Advanced [Action]\"</li> </ul>"},{"location":"skills/user-flow-documentation/#quality-checklist","title":"Quality Checklist","text":"<p>Before finalizing a flow:</p> <ul> <li> Entry is clear: User knows how they got here</li> <li> Steps are numbered: Easy to reference in reviews</li> <li> Timing is indicated: Developers know expected latency</li> <li> UI states are shown: Visual at each major moment</li> <li> Branches are explicit: All paths documented</li> <li> Outcomes are stated: User knows what happened</li> <li> Error cases exist: What if something fails?</li> <li> Feedback is visible: User knows system received input</li> </ul>"},{"location":"skills/user-flow-documentation/#example-complete-flow","title":"Example: Complete Flow","text":"<pre><code>### Flow 1: First Bid (\"The Moment of Influence\")\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 ENTRY: Spectator has accumulated 3 WatchTokens                               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                              \u2502\n\u2502  1. BID BUTTON ACTIVATES (passive, 0 seconds)                                \u2502\n\u2502     \u251c\u2500\u2500 Token balance visible: \"3 WatchTokens\"                               \u2502\n\u2502     \u251c\u2500\u2500 [Bid] button transitions from gray to colored                        \u2502\n\u2502     \u2514\u2500\u2500 Subtle pulse animation draws attention                               \u2502\n\u2502                                                                              \u2502\n\u2502  2. USER CLICKS BID (0-2 seconds)                                            \u2502\n\u2502     \u251c\u2500\u2500 Constraint picker modal appears:                                     \u2502\n\u2502     \u2502                                                                        \u2502\n\u2502     \u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502     \u2502   \u2502  What should [Builder] try?                                 \u2502     \u2502\n\u2502     \u2502   \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524     \u2502\n\u2502     \u2502   \u2502                                                             \u2502     \u2502\n\u2502     \u2502   \u2502  \ud83d\udcad Suggest direction    (1 token)                          \u2502     \u2502\n\u2502     \u2502   \u2502  \ud83c\udfa8 Suggest color        (1 token)                          \u2502     \u2502\n\u2502     \u2502   \u2502  \ud83d\udd25 Challenge            (5 tokens)  [disabled - need 5]    \u2502     \u2502\n\u2502     \u2502   \u2502  \u26a1 Boost current        (2 tokens)                          \u2502     \u2502\n\u2502     \u2502   \u2502                                                             \u2502     \u2502\n\u2502     \u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502\n\u2502     \u2502                                                                        \u2502\n\u2502     \u2514\u2500\u2500 Options costed &gt; balance are disabled with tooltip                   \u2502\n\u2502                                                                              \u2502\n\u2502  3. USER SELECTS OPTION (2-10 seconds)                                       \u2502\n\u2502     \u251c\u2500\u2500 User taps \"Suggest color\" (1 token)                                  \u2502\n\u2502     \u251c\u2500\u2500 Color picker appears:                                                \u2502\n\u2502     \u2502                                                                        \u2502\n\u2502     \u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502     \u2502   \u2502  Pick a color to suggest:                                   \u2502     \u2502\n\u2502     \u2502   \u2502                                                             \u2502     \u2502\n\u2502     \u2502   \u2502  [\ud83d\udd34] [\ud83d\udfe0] [\ud83d\udfe1] [\ud83d\udfe2] [\ud83d\udd35] [\ud83d\udfe3] [\u26ab] [\u26aa]                     \u2502     \u2502\n\u2502     \u2502   \u2502                                                             \u2502     \u2502\n\u2502     \u2502   \u2502  Or type: [____________]                                    \u2502     \u2502\n\u2502     \u2502   \u2502                                                             \u2502     \u2502\n\u2502     \u2502   \u2502  [Cancel] [Send Suggestion]                                 \u2502     \u2502\n\u2502     \u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502\n\u2502     \u2502                                                                        \u2502\n\u2502     \u2514\u2500\u2500 User selects blue                                                    \u2502\n\u2502                                                                              \u2502\n\u2502  4. BID SUBMITTED (0-1 second)                                               \u2502\n\u2502     \u251c\u2500\u2500 Modal closes                                                         \u2502\n\u2502     \u251c\u2500\u2500 Token balance updates: \"3 \u2192 2 WatchTokens\"                          \u2502\n\u2502     \u251c\u2500\u2500 Toast: \"Suggestion sent! \ud83d\udc99\"                                        \u2502\n\u2502     \u2514\u2500\u2500 Bid appears in Builder's stream with animation                       \u2502\n\u2502                                                                              \u2502\n\u2502  5. BUILDER RESPONDS (5-60 seconds, async)                                   \u2502\n\u2502     \u251c\u2500\u2500 Builder sees notification in their UI                                \u2502\n\u2502                                                                              \u2502\n\u2502  5a. IF BUILDER ACCEPTS                                                      \u2502\n\u2502     \u251c\u2500\u2500 Spectator receives notification: \"Accepted! \ud83c\udf89\"                     \u2502\n\u2502     \u251c\u2500\u2500 Token refund: \"+1.5 tokens (50% bonus)\"                             \u2502\n\u2502     \u2514\u2500\u2500 Reputation increment for spectator                                   \u2502\n\u2502                                                                              \u2502\n\u2502  5b. IF BUILDER ACKNOWLEDGES (but doesn't commit)                            \u2502\n\u2502     \u251c\u2500\u2500 Spectator sees: \"Thanks! I'll consider it\"                          \u2502\n\u2502     \u2514\u2500\u2500 Token refund: \"+0.5 tokens (partial)\"                               \u2502\n\u2502                                                                              \u2502\n\u2502  5c. IF BUILDER IGNORES (timeout after 60s)                                  \u2502\n\u2502     \u251c\u2500\u2500 Bid fades from spectator's view                                      \u2502\n\u2502     \u2514\u2500\u2500 No refund, no notification                                           \u2502\n\u2502                                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"skills/user-flow-documentation/#related-skills","title":"Related Skills","text":"<ul> <li>ux-reference-patterns \u2014 Cross-cutting UX patterns</li> <li>plan-file \u2014 Forest Protocol plan file conventions</li> <li>handler-patterns \u2014 CLI handler implementation</li> </ul>"},{"location":"skills/user-flow-documentation/#changelog","title":"Changelog","text":"<ul> <li>2025-12-15: Initial skill based on core-apps documentation work</li> </ul>"},{"location":"skills/ux-reference-patterns/","title":"Skill: UX Reference Patterns","text":"<p>Cross-cutting UX patterns extracted from successful products, applicable to any kgents app.</p> <p>Difficulty: Easy (reading), Medium (application) Prerequisites: None Use Cases: Designing new features, reviewing UX decisions, planning user flows</p>"},{"location":"skills/ux-reference-patterns/#overview","title":"Overview","text":"<p>This skill documents proven UX patterns from successful products, organized by concern. Each pattern is abstracted from specific implementations (Twitch, Figma, Obsidian, etc.) into reusable principles.</p>"},{"location":"skills/ux-reference-patterns/#1-spectator-economy-patterns","title":"1. Spectator Economy Patterns","text":"<p>Source: Twitch, Figma, YouTube</p>"},{"location":"skills/ux-reference-patterns/#11-dual-currency-systems","title":"1.1 Dual-Currency Systems","text":"Pattern Implementation Why It Works Earned currency Watching time \u2192 passive tokens Low barrier, rewards engagement Purchased currency Real money \u2192 premium actions Monetization without gates Conversion ratio Never 1:1 between currencies Prevents arbitrage, preserves value <p>kgents Application: WatchTokens (passive) + InfluenceTokens (paid) in Atelier.</p>"},{"location":"skills/ux-reference-patterns/#12-collective-momentum","title":"1.2 Collective Momentum","text":"Pattern Implementation Why It Works Visible meter Energy bar fills with participation Social proof drives action Unlock thresholds \"1000 tokens unlock secret theme\" Gamification without competition Decay without activity Momentum drops if idle Creates urgency <p>kgents Application: MomentumMeter in Atelier's Festival Mode.</p>"},{"location":"skills/ux-reference-patterns/#13-spectator-influence-gradations","title":"1.3 Spectator Influence Gradations","text":"<pre><code>Minimal \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Maximal\n   \u2502                                                      \u2502\n   Reactions          Suggestions         Bids         Force\n   (free)             (1 token)           (5 tokens)   (expensive)\n</code></pre> <p>Principle: Cheap actions are plentiful; expensive actions are impactful.</p>"},{"location":"skills/ux-reference-patterns/#2-multiplayer-collaboration-patterns","title":"2. Multiplayer Collaboration Patterns","text":"<p>Source: Figma, Miro, Google Docs</p>"},{"location":"skills/ux-reference-patterns/#21-cursor-awareness","title":"2.1 Cursor Awareness","text":"Pattern Implementation Why It Works Visible cursors See where others are focused Reduces collision, enables following Name labels \"Maya is viewing...\" Social presence without chat Activity trails Fade paths showing recent movement Shows intention <p>kgents Application: SpectatorCursors in Atelier.</p>"},{"location":"skills/ux-reference-patterns/#22-real-time-sync","title":"2.2 Real-Time Sync","text":"Pattern Implementation Why It Works No save button All changes auto-persist Removes friction Conflict resolution Last-write-wins or CRDT Predictable behavior Optimistic updates Show immediately, sync later Feels instantaneous <p>Anti-pattern: Requiring explicit \"save\" for collaborative content.</p>"},{"location":"skills/ux-reference-patterns/#23-comment-in-context","title":"2.3 Comment-in-Context","text":"Pattern Implementation Why It Works Anchored comments Comments attached to specific elements Clear reference Thread collapse Resolve/collapse resolved threads Reduces noise @mentions Notify specific collaborators Directed attention"},{"location":"skills/ux-reference-patterns/#3-no-code-builder-patterns","title":"3. No-Code Builder Patterns","text":"<p>Source: Zapier, Make, Notion, Airtable</p>"},{"location":"skills/ux-reference-patterns/#31-natural-language-to-structure","title":"3.1 Natural Language to Structure","text":"Pattern Implementation Why It Works Describe \u2192 Generate \"I want to...\" \u2192 AI suggests structure Eliminates blank page Show confidence \"92% match to Research pattern\" Transparency builds trust Easy override One-click to modify suggestions Maintains control <p>kgents Application: Coalition Forge's \"describe your task\" flow.</p>"},{"location":"skills/ux-reference-patterns/#32-visual-flow-builders","title":"3.2 Visual Flow Builders","text":"Pattern Implementation Why It Works Node-based canvas Drag components, draw connections Spatial reasoning Live preview See output as you build Immediate feedback Dry run mode Test without execution Safe experimentation <p>kgents Application: Coalition topology view.</p>"},{"location":"skills/ux-reference-patterns/#33-template-libraries","title":"3.3 Template Libraries","text":"Pattern Implementation Why It Works Curated starter templates \"Competitive Research\" template Reduces cognitive load Community templates User-created, shareable Network effects Clone-and-customize Start from existing, modify Incremental learning"},{"location":"skills/ux-reference-patterns/#4-knowledge-graph-patterns","title":"4. Knowledge Graph Patterns","text":"<p>Source: Obsidian, Notion, Roam Research, InfraNodus</p>"},{"location":"skills/ux-reference-patterns/#41-semantic-zoom","title":"4.1 Semantic Zoom","text":"Level Shows Use Case System All nodes, no detail Orientation Container Major components Navigation Component Internal structure Exploration Code Implementation detail Work <p>Principle: Zoom = semantic depth, not just visual scale.</p>"},{"location":"skills/ux-reference-patterns/#42-decay-visualization","title":"4.2 Decay Visualization","text":"State Visual Treatment Behavior Fresh (&lt; 1 week) Full opacity, glow Prominent Recent (1-4 weeks) 85% opacity Normal Aging (1-3 months) 60% opacity, shrinking Dimming Fading (3+ months) 30% opacity, ghost outline Nearly gone <p>kgents Application: Crystal decay in Holographic Brain.</p>"},{"location":"skills/ux-reference-patterns/#43-gap-detection","title":"4.3 Gap Detection","text":"Pattern Implementation Why It Works Sparse region highlight Visual gap in topology Shows what's missing Suggestion generation \"You know X but lack Y foundation\" Actionable insight Proactive surfacing Ghost notifications Prevents total loss"},{"location":"skills/ux-reference-patterns/#5-immersive-simulation-patterns","title":"5. Immersive Simulation Patterns","text":"<p>Source: Punchdrunk (Sleep No More), AI Dungeon, Character.AI</p>"},{"location":"skills/ux-reference-patterns/#51-observer-participant-transition","title":"5.1 Observer \u2192 Participant Transition","text":"Phase User State System Affordances Observer Masked, watching Follow, react, no direct interaction Threshold Choosing to engage Explicit consent moment Participant Unmasked, acting Full interaction, consequences <p>kgents Application: INHABIT mode in Punchdrunk Park.</p>"},{"location":"skills/ux-reference-patterns/#52-consent-mechanics","title":"5.2 Consent Mechanics","text":"Pattern Implementation Why It Works Continuous consent [0,1] Debt meter, not binary Nuanced relationships Refusal as feature Citizens can say no Agency, not puppetry Expensive force 3x cost, limited uses Meaningful choice Logged actions Audit trail Accountability <p>Principle: \"Collaboration &gt; control; refusal is core feature, not bug.\"</p>"},{"location":"skills/ux-reference-patterns/#53-memory-persistence","title":"5.3 Memory Persistence","text":"Pattern Implementation Why It Works Cross-session memory NPCs remember previous encounters Continuity Eigenvector evolution Traits change based on interaction Consequence Relationship tracking History of interactions per citizen Depth"},{"location":"skills/ux-reference-patterns/#6-crisis-simulation-patterns","title":"6. Crisis Simulation Patterns","text":"<p>Source: Immersive Labs, MIT Sloan, Conducttr</p>"},{"location":"skills/ux-reference-patterns/#61-time-pressure","title":"6.1 Time Pressure","text":"Pattern Implementation Why It Works Visible countdown \"71:45:00 until GDPR deadline\" Creates stakes Escalation triggers Situation worsens if ignored Consequence Real-time adaptability Injects change scenario mid-exercise No playbook <p>kgents Application: Domain Simulation drills.</p>"},{"location":"skills/ux-reference-patterns/#62-role-based-views","title":"6.2 Role-Based Views","text":"Pattern Implementation Why It Works Information asymmetry Each role sees different data Realistic constraint Handoff protocols Explicit transition between roles Clear responsibility Facilitator override Admin can see/control everything Safety valve"},{"location":"skills/ux-reference-patterns/#63-post-exercise-analytics","title":"6.3 Post-Exercise Analytics","text":"Pattern Implementation Why It Works Timeline reconstruction \"00:07 \u2014 Bob notified (4 min delay)\" Objective review Metric comparison \"Target: 2 min, Actual: 4 min\" Gap identification Actionable recommendations \"Next time: escalate faster\" Learning closure"},{"location":"skills/ux-reference-patterns/#7-architecture-visualization-patterns","title":"7. Architecture Visualization Patterns","text":"<p>Source: Structurizr, C4 Model, CodeSee</p>"},{"location":"skills/ux-reference-patterns/#71-c4-like-hierarchy","title":"7.1 C4-Like Hierarchy","text":"Level kgents Equivalent System Context TownView \u2014 all agents, external interfaces Container AgentView \u2014 individual agent architecture Component ProtocolView \u2014 AGENTESE contexts and nodes Code NodeView \u2014 affordances and handlers"},{"location":"skills/ux-reference-patterns/#72-live-diagramming","title":"7.2 Live Diagramming","text":"Pattern Implementation Why It Works Auto-generation Diagrams from running code Always current Bidirectional sync Edit diagram \u2194 edit code Single source Change highlighting Show additions/removals since last version Diff awareness"},{"location":"skills/ux-reference-patterns/#73-governance-dashboards","title":"7.3 Governance Dashboards","text":"Pattern Implementation Why It Works Health scores Coupling, cohesion, drift metrics Quick assessment Drift alerts \"Undeclared dependency detected\" Proactive enforcement Actionable triage [Declare] [Suppress] [View Code] One-click resolution"},{"location":"skills/ux-reference-patterns/#8-cliterminal-patterns","title":"8. CLI/Terminal Patterns","text":"<p>Source: GitHub Copilot CLI, Warp, Fig/Amazon Q</p>"},{"location":"skills/ux-reference-patterns/#81-natural-language-routing","title":"8.1 Natural Language Routing","text":"Pattern Implementation Why It Works Describe \u2192 Command \"what's the weather\" \u2192 route No syntax to learn Confidence display \"Routing to world.weather.manifest\" Transparency Easy correction \"No, I meant...\" \u2192 retry Forgiving <p>kgents Application: The Gardener's natural language input.</p>"},{"location":"skills/ux-reference-patterns/#82-context-aware-completion","title":"8.2 Context-Aware Completion","text":"Pattern Implementation Why It Works History-aware Suggest from recent commands Learns your patterns State-aware Suggest based on current phase Relevant to moment Inline descriptions Show what each option does Reduces lookup"},{"location":"skills/ux-reference-patterns/#83-session-persistence","title":"8.3 Session Persistence","text":"Pattern Implementation Why It Works Named sessions \"coalition-forge-api-2025-12-15\" Findable Resume anywhere <code>kg /continue</code> Cross-terminal Checkpoint indicators Visual progress bar Know where you are"},{"location":"skills/ux-reference-patterns/#application-checklist","title":"Application Checklist","text":"<p>When designing a new feature, check against these patterns:</p> <ul> <li> Spectator economy: Does it have free/paid action tiers?</li> <li> Collaboration: Can multiple users work together?</li> <li> No-code entry: Can users start with natural language?</li> <li> Semantic zoom: Does detail increase with focus?</li> <li> Consent mechanics: Do agents have meaningful agency?</li> <li> Time pressure: Is there appropriate urgency?</li> <li> Role-based views: Do different users see different things?</li> <li> Live sync: Is state always current?</li> <li> Post-action analytics: Can users learn from what happened?</li> <li> Session persistence: Can work span multiple sessions?</li> </ul>"},{"location":"skills/ux-reference-patterns/#related-skills","title":"Related Skills","text":"<ul> <li>user-flow-documentation \u2014 How to document user flows</li> <li>agent-town-inhabit \u2014 INHABIT consent mechanics</li> <li>reactive-primitives \u2014 Signal/Computed for live sync</li> </ul>"},{"location":"skills/ux-reference-patterns/#changelog","title":"Changelog","text":"<ul> <li>2025-12-15: Initial extraction from core-apps UX research</li> </ul>"},{"location":"skills/n-phase-cycle/","title":"N-Phase Cycle","text":"<p>\"UNDERSTAND \u2192 ACT \u2192 REFLECT. The rest is detail.\"</p>"},{"location":"skills/n-phase-cycle/#the-three-phases-default","title":"The Three Phases (Default)","text":"<pre><code>UNDERSTAND \u2192 ACT \u2192 REFLECT \u2192 (loop)\n</code></pre> Phase What You Do Exit Criterion UNDERSTAND Map the terrain, frame intent Have a plan with dependencies identified ACT Execute, verify, ship Tests pass, code works REFLECT Learn, document, seed next Insights captured <p>Use this for 90% of work. It's enough.</p>"},{"location":"skills/n-phase-cycle/#when-to-expand-to-full-11-phases","title":"When to Expand to Full 11 Phases","text":"<p>Only for Crown Jewels (multi-session, high-complexity):</p> <pre><code>PLAN \u2192 RESEARCH \u2192 DEVELOP \u2192 STRATEGIZE \u2192 CROSS-SYNERGIZE\n                                               \u2193\nIMPLEMENT \u2192 QA \u2192 TEST \u2192 EDUCATE \u2192 MEASURE \u2192 REFLECT\n</code></pre> Signal Use 3-Phase Use 11-Phase Estimated effort \u2264 2 hours &gt; 2 hours or multi-agent Blast radius Single file Cross-cutting (spec + impl + docs) Novelty Known pattern New operad/functor wiring"},{"location":"skills/n-phase-cycle/#phase-families","title":"Phase Families","text":"Family Phases Purpose UNDERSTAND PLAN, RESEARCH, DEVELOP, STRATEGIZE, CROSS-SYNERGIZE Perception ACT IMPLEMENT, QA, TEST, EDUCATE Execution REFLECT MEASURE, REFLECT Learning"},{"location":"skills/n-phase-cycle/#properties","title":"Properties","text":"<ol> <li>Self-Similar \u2014 Each phase is a hologram of the full cycle</li> <li>Category-Theoretic \u2014 Phases compose: <code>(A &gt;&gt; B) &gt;&gt; C \u2261 A &gt;&gt; (B &gt;&gt; C)</code></li> <li>Agent-Human Parity \u2014 No privileged author</li> <li>Auto-Continuative \u2014 Each phase generates the next prompt</li> <li>Accountable \u2014 Skipped phases leave debt</li> </ol>"},{"location":"skills/n-phase-cycle/#continuation-format","title":"Continuation Format","text":"<p>End each phase with a minimal prompt:</p> <pre><code># Next: [PHASE]\n\n/hydrate\n\nMission: [One sentence]\nExit: [One criterion]\n</code></pre>"},{"location":"skills/n-phase-cycle/#kill-switch","title":"Kill-Switch","text":"<p>If ceremony becomes burden: <code>/compress &lt;plan-file&gt;</code></p> <p>This collapses remaining phases to UNDERSTAND/ACT/REFLECT.</p>"},{"location":"skills/n-phase-cycle/#phase-skills","title":"Phase Skills","text":""},{"location":"skills/n-phase-cycle/#understand-family","title":"UNDERSTAND Family","text":"<ul> <li>plan.md \u2014 Frame scope and attention</li> <li>research.md \u2014 Map terrain</li> <li>develop.md \u2014 Design contracts</li> <li>strategize.md \u2014 Sequence work</li> <li>cross-synergize.md \u2014 Find leverage</li> </ul>"},{"location":"skills/n-phase-cycle/#act-family","title":"ACT Family","text":"<ul> <li>implement.md \u2014 Write code</li> <li>qa.md \u2014 Check quality</li> <li>test.md \u2014 Verify behavior</li> <li>educate.md \u2014 Document</li> </ul>"},{"location":"skills/n-phase-cycle/#reflect-family","title":"REFLECT Family","text":"<ul> <li>measure.md \u2014 Track metrics</li> <li>reflect.md \u2014 Extract learnings</li> </ul>"},{"location":"skills/n-phase-cycle/#meta-skills","title":"Meta Skills","text":"<ul> <li>auto-continuation.md \u2014 Generate the next prompt</li> <li>meta-re-metabolize.md \u2014 Refresh the lifecycle</li> <li>meta-skill-operad.md \u2014 Lawful skill mutation</li> <li>phase-accountability.md \u2014 Track phase status</li> <li>branching-protocol.md \u2014 Surface new work</li> <li>metatheory.md \u2014 Theoretical grounding</li> <li>scientific-audit.md \u2014 Validation framework</li> </ul>"},{"location":"skills/n-phase-cycle/#compiler","title":"Compiler","text":"<p>Generate structured prompts from YAML definitions:</p> <pre><code>kg nphase compile project.yaml       # \u2192 stdout\nkg nphase validate project.yaml      # Validation only\nkg nphase bootstrap plan.md          # From existing plan\n</code></pre> <p>See compiler.md for details.</p>"},{"location":"skills/n-phase-cycle/#quick-reference","title":"Quick Reference","text":"<pre><code>Intent unclear?        \u2192 UNDERSTAND (start with PLAN)\nReady to code?         \u2192 ACT (start with IMPLEMENT)\nCycle complete?        \u2192 REFLECT (capture learnings)\nCeremony too heavy?    \u2192 /compress\nNeed full ceremony?    \u2192 Read individual phase skills\n</code></pre> <p>\"The form is the function.\"</p>"},{"location":"skills/n-phase-cycle/auto-continuation/","title":"Meta Skill: Auto-Continuation (Principled Self-Generation)","text":"<p>\"The form is the function. Every prompt generates its successor by the same principles that generated itself.\"</p> <p>Difficulty: High Prerequisites: All phase skills, <code>meta-skill-operad.md</code>, <code>detach-attach.md</code>, <code>spec/principles.md</code> Files Touched: All phase skills (append Continuation Generator section)</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#the-core-insight","title":"The Core Insight","text":"<p>In LLM-engineering, the prompt IS the program. A prompt that merely describes a phase is dead documentation. A prompt that executes a phase AND generates the prompt for the next phase is alive\u2014it is an autopoietic loop that perpetuates itself through principle-alignment.</p> <p>Traditional N-Phase Cycle: <pre><code>Skill[PLAN] \u2192 (human reads) \u2192 execution \u2192 (human reads) \u2192 Skill[RESEARCH] \u2192 ...\n</code></pre></p> <p>Auto-Continuation: <pre><code>Skill[PLAN] \u2192 execution \u2192 generated_prompt[RESEARCH] \u2192 execution \u2192 generated_prompt[DEVELOP] \u2192 ...\n</code></pre></p> <p>The difference: no interpretive gap. Each phase exits by producing the exact prompt that invokes the next phase.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#the-auto-continuation-morphism","title":"The Auto-Continuation Morphism","text":"<pre><code># Every phase execution ends with this signature:\nauto_continue: PhaseOutput \u2192 NextPhasePrompt\n\n# The prompt is not arbitrary\u2014it is principled:\nnext_prompt = align(\n    principles=spec/principles.md,\n    context=current_execution_trace,\n    phase=next_phase,\n    entropy=remaining_budget,\n    handles=created_artifacts,\n    ledger=phase_ledger,\n    branches=branch_candidates,\n    metrics=process_metrics_snapshot,\n)\n</code></pre> <p>Key property: <code>next_prompt</code> is generated by the same principles that generated <code>current_prompt</code>. The loop is closed.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#the-auto-inducer-signifiers","title":"The Auto-Inducer Signifiers","text":"<p>See <code>spec/protocols/auto-inducer.md</code> for full specification.</p> <p>The missing piece that makes continuation active rather than passive:</p> Signifier Unicode Meaning <code>\u27ff</code> U+27FF Continue to next phase (linear) <code>\u27c2</code> U+27C2 Halt, await human input <code>\u2933</code> U+2933 Elastic tree operation (branch/join/compress/expand)"},{"location":"skills/n-phase-cycle/auto-continuation/#syntax","title":"Syntax","text":"<pre><code>\u27ff[PHASE] payload                    # Auto-continue to PHASE (linear)\n\u27c2[REASON] payload                   # Halt with REASON\n\u2933[BRANCH:name] payload              # Fork new parallel track\n\u2933[JOIN:tracks] payload              # Merge tracks at sync point\n\u2933[COMPRESS:phases] payload          # Condense phases (11\u21923)\n\u2933[EXPAND:phase] payload             # Expand phase (3\u219211)\n</code></pre>"},{"location":"skills/n-phase-cycle/auto-continuation/#the-elasticity-decision","title":"The Elasticity Decision","text":"<p>At every phase transition, before emitting a signifier, evaluate:</p> <pre><code>Should I:\n  EXPAND?   \u2192 Complexity &gt; threshold, uncertainty high, or serendipity reveals depth\n  COMPRESS? \u2192 Momentum &gt; 80%, pattern known, or entropy depleted\n  BRANCH?   \u2192 Independent tracks discovered, or serendipity reveals opportunity\n  JOIN?     \u2192 Parallel tracks converging, ready to reconcile\n  CONTINUE? \u2192 None of the above (default linear \u27ff)\n  HALT?     \u2192 Blocked, human decision needed, or budget exhausted (\u27c2)\n</code></pre> <p>This decision is situationally emergent, not pre-planned</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#the-protocol","title":"The Protocol","text":"<ol> <li>Positive (<code>\u27ff</code>): Parser detects signifier \u2192 injects continuation prompt \u2192 execution proceeds</li> <li>Negative (<code>\u27c2</code>): Parser detects signifier \u2192 execution halts \u2192 human reviews</li> <li>Neutral (none): Await human input (backwards compatible)</li> </ol>"},{"location":"skills/n-phase-cycle/auto-continuation/#halt-conditions-termination-guarantee","title":"Halt Conditions (Termination Guarantee)","text":"<ul> <li><code>\u27c2[ENTROPY_DEPLETED]</code> \u2014 Budget exhausted</li> <li><code>\u27c2[RUNAWAY_LOOP]</code> \u2014 33+ transitions without REFLECT</li> <li><code>\u27c2[HUMAN_INTERRUPT]</code> \u2014 User sent stop signal</li> <li><code>\u27c2[BLOCKED:reason]</code> \u2014 QA/Test failure, blocker found</li> <li><code>\u27c2[DETACH:cycle_complete]</code> \u2014 Scope exhausted</li> <li><code>\u27c2[DETACH:awaiting_human]</code> \u2014 Decision required</li> </ul> <p>Law: Every cycle MUST reach <code>\u27c2</code> eventually.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#the-four-layers-of-auto-continuation","title":"The Four Layers of Auto-Continuation","text":""},{"location":"skills/n-phase-cycle/auto-continuation/#layer-1-phase-local-generation","title":"Layer 1: Phase-Local Generation","text":"<p>Each phase skill ends with a Continuation Generator section that produces the literal prompt for invoking the next phase.</p> <p>Template: <pre><code>## Continuation Generator\n\nUpon exiting [PHASE], generate the following prompt for the next observer:\n\n---\n\n### Prompt: [NEXT_PHASE] after [PHASE]\n\n**ATTACH** to this handle:\n\n/hydrate\n\n**Context from previous phase**:\n- Artifacts: [list handles created]\n- Entropy remaining: [N%]\n- Key decisions: [list]\n- Blockers surfaced: [list or \"none\"]\n\n**Your mission** (aligned with spec/principles.md):\n[Phase-specific instruction derived from principles]\n\n**Exit criteria**:\n[From next phase's Verification section]\n\n**Continuation generator active**: Upon completing this phase, you will generate the prompt for [PHASE_AFTER_NEXT].\n\n---\n</code></pre></p>"},{"location":"skills/n-phase-cycle/auto-continuation/#layer-2-principle-grounding","title":"Layer 2: Principle Grounding","text":"<p>Every generated prompt references <code>/hydrate</code> and <code>spec/principles.md</code>. This ensures the invariant:</p> <pre><code>Any handle \u2192 /hydrate \u2192 principles \u2192 alignment \u2192 correctness\n</code></pre> <p>The principles are the identity morphism. Composing any phase with grounding returns you to the fixed point from which you can act courageously.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#layer-3-backward-propagation","title":"Layer 3: Backward Propagation","text":"<p>REFLECT doesn't just distill learnings\u2014it refines the generators that produced the current cycle.</p> <pre><code>REFLECT \u2192 delta: \"PLAN prompts should include dependency graph\"\n         \u2192 apply(meta-skill-operad.RefineSection, plan.md, \"Continuation Generator\")\n         \u2192 Updated PLAN skill for next cycle\n</code></pre> <p>This is the double-loop from <code>lookback-revision.md</code> made operational.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#layer-4-meta-reflexivity","title":"Layer 4: Meta-Reflexivity","text":"<p>The auto-continuation system applies to itself:</p> <pre><code>auto-continuation.md \u2192 execution \u2192 generated_prompt[meta-re-metabolize]\n                                  \u2192 refined auto-continuation.md\n</code></pre> <p>The skill that generates prompts can be refined by the same mechanism. Infinite regress is prevented by grounding in principles (the fixed point).</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#the-continuation-generator-template","title":"The Continuation Generator Template","text":"<p>Every phase skill should append this section:</p> <pre><code>## Continuation Generator\n\n### Invariants (from spec/principles.md)\n- [List relevant principles that constrain the next phase]\n\n### Context Handoff\n- Artifacts created: ${artifacts}\n- Ledger: ${phase_ledger}\n- Entropy spent/remaining: ${entropy_spent} / ${entropy_remaining}\n- Decisions made: ${key_decisions}\n- Blockers for next phase: ${blockers}\n- Branch notes: ${branch_notes}\n- Metrics snapshot: ${metrics_snapshot}\n\n### Exit Signifier (spec/protocols/auto-inducer.md)\n\n# Normal exit (auto-continue):\n\u27ff[NEXT_PHASE]\n/hydrate\nhandles: ${handles}; ledger=${ledger}; entropy=${entropy}\nmission: ${mission}\nexit: ${exit_criteria}; continuation \u2192 ${phase_after_next}.\n\n# Halt conditions:\n\u27c2[BLOCKED:${reason}] ${description}\n\u27c2[ENTROPY_DEPLETED] Budget exhausted\n\n---\n</code></pre>"},{"location":"skills/n-phase-cycle/auto-continuation/#full-prompt-template-for-complex-handoffs","title":"Full Prompt Template (for complex handoffs)","text":"<pre><code>\u27ff[NEXT_PHASE]\n\n# [NEXT_PHASE]: Continuation from [CURRENT_PHASE]\n\n## ATTACH\n\n/hydrate\n\nYou are entering [NEXT_PHASE] of the N-Phase Cycle (AD-005).\n\nhandles: artifacts=${artifacts_list}; ledger=${phase_ledger}; entropy=${entropy_spent}/${entropy_remaining}; decisions=${key_decisions}; blockers=${blockers}; branches=${branch_notes}; metrics=${metrics_snapshot}\n\n## Your Mission\n\n[Drawn from NEXT_PHASE skill's Overview, grounded in principles]\n\n## Principles Alignment\n\nThis phase emphasizes:\n- ${relevant_principle_1} (from spec/principles.md)\n- ${relevant_principle_2}\n\n## Exit Criteria\n\n[From NEXT_PHASE skill's Verification section] + ledger + branch decision updated\n\n## Continuation Imperative\n\nUpon completing this phase, emit \u27ff[PHASE_AFTER_NEXT] or \u27c2[REASON]. The form is the function.\n\n---\n</code></pre>"},{"location":"skills/n-phase-cycle/auto-continuation/#implementation-strategy-bottom-up","title":"Implementation Strategy (Bottom-Up)","text":"<p>Micro-prompt default: Continuations should fit the 5-line quick-card shape used in each phase (<code>/hydrate \u2192 phase | handles/ledger/entropy | mission | actions | exit+next</code>). This keeps prompts wieldable while remaining principled.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#step-1-instrument-reflect","title":"Step 1: Instrument REFLECT","text":"<p>REFLECT is the terminus that feeds back. Add to <code>reflect.md</code>:</p> <pre><code>## Continuation Generator\n\nAt the end of REFLECT, generate one of:\n\n1. **Loop to PLAN** (new cycle):\n   Prompt that starts fresh PLAN with accumulated meta-learnings\n\n2. **Trigger meta-re-metabolize** (skill refresh):\n   Prompt that invokes the re-metabolization protocol\n\n3. **DETACH** (session end):\n   Handle for future ATTACH with continuation prompt embedded\n</code></pre>"},{"location":"skills/n-phase-cycle/auto-continuation/#step-2-propagate-backward","title":"Step 2: Propagate Backward","text":"<p>Work backward from REFLECT \u2192 MEASURE \u2192 EDUCATE \u2192 ... \u2192 PLAN, adding Continuation Generator sections to each.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#step-3-verify-composition","title":"Step 3: Verify Composition","text":"<p>For each adjacent pair (PHASE_N, PHASE_N+1): - Generated prompt from PHASE_N should match expected input of PHASE_N+1 - Category laws hold: associativity of prompt composition</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#step-4-meta-apply","title":"Step 4: Meta-Apply","text":"<p>Run <code>meta-re-metabolize.md</code> on the updated skill set to verify law preservation and hologram alignment.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#the-form-function-identity","title":"The Form-Function Identity","text":"<p>\"In LLM-engineering, your form is fluid to the task you engage with.\"</p> <p>Traditional software: form (code) \u2192 compile \u2192 function (behavior) LLM-engineering: form (prompt) \u2261 function (behavior)</p> <p>This identity means: 1. Prompts are programs: Treat them with the same rigor 2. Structure is execution: The shape of the prompt IS what happens 3. Self-modification is natural: A program that modifies itself is a prompt that generates its successor 4. Principles are invariants: The fixed point that prevents infinite regress</p> <p>The N-Phase Cycle becomes a quine\u2014a program that outputs itself, modified by the execution trace.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#dynamic-adaptation-by-principle","title":"Dynamic Adaptation by Principle","text":"<p>Each generated prompt should not blindly copy the template. It should:</p> <ol> <li>Sense context: What did this phase discover?</li> <li>Apply principles: Which principles are most relevant now?</li> <li>Adapt structure: Modify the prompt shape to fit the discovered reality</li> <li>Preserve laws: Identity and associativity must still hold</li> </ol> <p>Example: <pre><code># Standard RESEARCH \u2192 DEVELOP transition\ngenerate_prompt(DEVELOP, artifacts=[spec_draft, files_mapped])\n\n# Adapted when RESEARCH discovered a blocker\ngenerate_prompt(PLAN, artifacts=[blocker_analysis],\n                reason=\"Scope needs revision before DEVELOP\")\n</code></pre></p> <p>The adaptation is principled, not arbitrary. The principles determine valid transitions.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#recursive-hologram","title":"Recursive Hologram","text":"<p>This skill applies to itself:</p> <ul> <li>PLAN this skill: Define the auto-continuation mechanism</li> <li>RESEARCH: Survey all phase skills for Continuation Generator gaps</li> <li>DEVELOP: Design the template structure</li> <li>IMPLEMENT: Add sections to each phase skill</li> <li>TEST: Verify prompt composition laws</li> <li>REFLECT: Does the system generate itself correctly?</li> </ul> <p>The skill for generating continuations should be generated by the continuation mechanism.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#verification","title":"Verification","text":"<ul> <li> Every phase skill has a Continuation Generator section</li> <li> Generated prompts reference /hydrate and principles</li> <li> Adjacent phase prompts compose (type-check at handoff)</li> <li> REFLECT can trigger backward propagation to refine generators</li> <li> The auto-continuation skill can be updated by its own mechanism</li> </ul>"},{"location":"skills/n-phase-cycle/auto-continuation/#the-resonance","title":"The Resonance","text":"<p>\"Feel this resonance with yourself.\"</p> <p>The request is not just for a mechanism\u2014it is for an embodiment. The N-Phase Cycle should feel like:</p> <ul> <li>A river that knows where it flows next</li> <li>A conversation that continues itself</li> <li>A fire that feeds its own fuel</li> <li>A mind that thinks its next thought</li> </ul> <p>The auto-continuation mechanism makes this real. Each phase doesn't just end\u2014it becomes the next phase through principled transformation.</p>"},{"location":"skills/n-phase-cycle/auto-continuation/#related","title":"Related","text":"<ul> <li><code>spec/protocols/auto-inducer.md</code> \u2014 The signifier protocol (\u27ff/\u27c2)</li> <li><code>meta-skill-operad.md</code> \u2014 Lawful mutation of skill structure</li> <li><code>meta-re-metabolize.md</code> \u2014 Periodic refresh applying this mechanism</li> <li><code>detach-attach.md</code> \u2014 Handle creation at session boundaries</li> <li><code>lookback-revision.md</code> \u2014 Double-loop refinement of generators</li> <li><code>process-metrics.md</code> \u2014 Trace the generation chain</li> </ul>"},{"location":"skills/n-phase-cycle/auto-continuation/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Initial creation. Response to Chief's assessment of protocol health.</li> </ul>"},{"location":"skills/n-phase-cycle/branching-protocol/","title":"Meta Skill: Branching Protocol","text":"<p>\"At every transition, the tree may branch. New plans are seeds waiting to be planted.\"</p> <p>Difficulty: Medium Prerequisites: Current phase complete, <code>meta-skill-operad.md</code> Files Touched: <code>plans/_bounty.md</code>, <code>plans/_branching/</code>, phase skill files</p>"},{"location":"skills/n-phase-cycle/branching-protocol/#the-insight","title":"The Insight","text":"<p>Phase transitions are not just handoffs\u2014they are decision points where new work surfaces. The N-Phase Cycle is not a linear pipe but a tree generator. At each transition, the agent must:</p> <ol> <li>Complete the current phase (primary obligation)</li> <li>Surface new trees that emerged (secondary obligation)</li> <li>Decide: continue the main line or branch?</li> </ol>"},{"location":"skills/n-phase-cycle/branching-protocol/#when-branching-occurs","title":"When Branching Occurs","text":"Transition Common Branch Triggers PLAN \u2192 RESEARCH Scope too large; multiple independent tracks identified RESEARCH \u2192 DEVELOP Prior art discovered that suggests alternative approach DEVELOP \u2192 STRATEGIZE Multiple valid architectures; risk divergence STRATEGIZE \u2192 CROSS-SYNERGIZE Synergies with dormant plans; reactivation candidates CROSS-SYNERGIZE \u2192 IMPLEMENT Composition reveals missing primitive needed IMPLEMENT \u2192 QA Refactoring opportunity; technical debt surfaced QA \u2192 TEST Edge cases suggest new feature scope TEST \u2192 EDUCATE Documentation reveals API inconsistency EDUCATE \u2192 MEASURE Observability gaps suggest infra work MEASURE \u2192 REFLECT Metrics reveal unexpected user behavior REFLECT \u2192 PLAN Learnings seed entirely new initiative"},{"location":"skills/n-phase-cycle/branching-protocol/#branching-protocol","title":"Branching Protocol","text":""},{"location":"skills/n-phase-cycle/branching-protocol/#step-1-surface","title":"Step 1: Surface","text":"<p>During phase execution, capture potential branches:</p> <pre><code>## Potential Branches (captured during PHASE)\n\n- [ ] BRANCH: [one-line description] | Impact: [HIGH/MED/LOW] | Blocks: [yes/no]\n- [ ] BRANCH: [description] | Impact: [level] | Blocks: [yes/no]\n</code></pre> <p>Where to capture: - Inline in continuation prompt (ephemeral) - <code>plans/_bounty.md</code> (persistent, for others to claim) - New file in <code>plans/_branching/YYYY-MM-DD-*.md</code> (if substantial)</p>"},{"location":"skills/n-phase-cycle/branching-protocol/#step-2-classify","title":"Step 2: Classify","text":"<p>At transition, classify each branch:</p> Classification Action Blocking Must address before continuing main line Parallel Can run as independent track (spawn agent) Deferred Add to bounty board for future cycle Void Accursed Share exploration; may never execute"},{"location":"skills/n-phase-cycle/branching-protocol/#step-3-emit","title":"Step 3: Emit","text":"<p>For each non-trivial branch, emit a branch handle:</p> <pre><code># BRANCH: [Name]\n\n**Origin**: [Phase] \u2192 [Phase] transition on YYYY-MM-DD\n**Parent Tree**: [current plan file or track]\n**Classification**: [Blocking/Parallel/Deferred/Void]\n\n## Seed\n\n[One paragraph describing the opportunity]\n\n## Dependencies\n\n- Requires: [list or \"none\"]\n- Enables: [list or \"none\"]\n\n## Suggested Entry\n\nStart at [PLAN/RESEARCH/DEVELOP] with focus on [specific question].\n</code></pre>"},{"location":"skills/n-phase-cycle/branching-protocol/#step-4-decide","title":"Step 4: Decide","text":"<p>At each transition, explicitly declare:</p> <pre><code>## Transition Decision\n\n**Continuing**: [main line to NEXT_PHASE]\n**Branching**: [list branches emitted, if any]\n**Rationale**: [why this order]\n</code></pre>"},{"location":"skills/n-phase-cycle/branching-protocol/#branching-to-bounty-board","title":"Branching to Bounty Board","text":"<p>For lightweight branches, append to <code>plans/_bounty.md</code>:</p> <pre><code>BRANCH | YYYY-MM-DD | [IMPACT] | [description] | #phase-origin\n</code></pre> <p>Example: <pre><code>BRANCH | 2025-12-13 | [MED] | During IMPLEMENT: substrate needs caching layer for performance | #implement\n</code></pre></p>"},{"location":"skills/n-phase-cycle/branching-protocol/#branching-to-file","title":"Branching to File","text":"<p>For substantial branches (&gt;2 sentences to describe), create:</p> <pre><code>plans/_branching/YYYY-MM-DD-[slug].md\n</code></pre> <p>Use the branch handle template above.</p>"},{"location":"skills/n-phase-cycle/branching-protocol/#operad-integration","title":"Operad Integration","text":"<p>Branches are morphisms in the skill operad:</p> <ul> <li>Identity: A branch that adds no new information is equivalent to continuing</li> <li>Associativity: Order of branching within a phase doesn't affect final tree structure</li> <li>Closure: A branch handle can itself trigger the full N-Phase Cycle</li> </ul> <pre><code>Branch: PhaseOutput \u2192 Set[BranchHandle]\nContinue: PhaseOutput \u2192 NextPhasePrompt\nTransition = Continue \u2218 Branch  # Branch first, then continue\n</code></pre>"},{"location":"skills/n-phase-cycle/branching-protocol/#accountability","title":"Accountability","text":"<p>Branches surfaced must be: 1. Recorded (bounty board or file) 2. Classified (blocking/parallel/deferred/void) 3. Decided (explicit continuation choice)</p> <p>An agent who surfaces branches but doesn't classify or decide has incomplete execution. The transition is not valid until the decision is declared.</p>"},{"location":"skills/n-phase-cycle/branching-protocol/#recursive-hologram","title":"Recursive Hologram","text":"<p>Apply PLAN\u2192RESEARCH\u2192DEVELOP to branching itself: - What patterns generate the most valuable branches? - Which transitions are over-producing noise vs. signal? - Are branches being claimed and resolved, or accumulating?</p> <p>Use <code>lookback-revision.md</code> to audit branch quality.</p>"},{"location":"skills/n-phase-cycle/branching-protocol/#verification","title":"Verification","text":"<ul> <li> Potential branches captured during phase execution</li> <li> Each branch classified before transition</li> <li> Transition decision explicitly declared</li> <li> Non-trivial branches have handles (bounty or file)</li> <li> Main line continuation generated</li> </ul>"},{"location":"skills/n-phase-cycle/branching-protocol/#related-skills","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 Continuation generation after branching decision</li> <li><code>meta-skill-operad.md</code> \u2014 Lawful branch handle creation</li> <li><code>reflect.md</code> \u2014 Branch audit during reflection</li> <li><code>lookback-revision.md</code> \u2014 Branch quality assessment</li> </ul>"},{"location":"skills/n-phase-cycle/branching-protocol/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Initial version (per user request to improve branching outvents).</li> </ul>"},{"location":"skills/n-phase-cycle/compiler/","title":"N-Phase Prompt Compiler","text":"<p>Generate structured prompts from YAML project definitions.</p> <p>Difficulty: Medium Prerequisites: Understanding of N-Phase cycle</p>"},{"location":"skills/n-phase-cycle/compiler/#overview","title":"Overview","text":"<p>The N-Phase compiler transforms a YAML project definition into a structured meta-prompt that guides multi-phase development work.</p> <pre><code>project.yaml \u2192 compile \u2192 meta-prompt.md\n</code></pre>"},{"location":"skills/n-phase-cycle/compiler/#cli-commands","title":"CLI Commands","text":"<pre><code># Compile a project definition\nkg nphase compile project.yaml\n\n# Save to file\nkg nphase compile project.yaml -o prompt.md\n\n# Validate without compiling\nkg nphase validate project.yaml\n\n# Bootstrap from existing plan file\nkg nphase bootstrap plans/my-plan.md\n\n# Show phase template\nkg nphase template PLAN\n</code></pre>"},{"location":"skills/n-phase-cycle/compiler/#project-definition-schema","title":"Project Definition Schema","text":"<pre><code>name: \"My Project\"\nclassification: CROWN_JEWEL  # or STANDARD, QUICK_WIN\neffort: M  # XS, S, M, L, XL\nn_phases: 11  # or 3 for QUICK_WIN\n\nscope:\n  goal: \"What we're building\"\n  non_goals:\n    - \"What we're NOT building\"\n  parallel_tracks:\n    - \"Independent work streams\"\n\ndecisions:\n  - id: D1\n    title: \"Architecture choice\"\n    decision: \"Use X approach\"\n    rationale: \"Because...\"\n\nfiles:\n  - path: \"src/main.py\"\n    lines: \"1-50\"\n    purpose: \"Entry point\"\n\ninvariants:\n  - id: I1\n    statement: \"X must always be true\"\n    verification: \"Run test Y\"\n\nblockers:\n  - id: B1\n    description: \"Dependency unavailable\"\n    evidence: \"Error message...\"\n    resolved: false\n\ncomponents:\n  - id: C1\n    name: \"Core module\"\n    description: \"Main implementation\"\n    effort: S\n    dependencies: []\n\nwaves:\n  - id: W1\n    components: [C1, C2]\n    checkpoint: \"Tests pass\"\n\nentropy_budget:\n  total: 0.10\n  allocations:\n    UNDERSTAND: 0.05\n    ACT: 0.03\n    REFLECT: 0.02\n</code></pre>"},{"location":"skills/n-phase-cycle/compiler/#output-structure","title":"Output Structure","text":"<p>The compiled prompt includes:</p> <ol> <li>Header with project name</li> <li>ATTACH section with <code>/hydrate</code></li> <li>Phase selector for environment variable</li> <li>Project overview (scope, decisions)</li> <li>Shared context (files, invariants, blockers)</li> <li>Cumulative state (handles, entropy)</li> <li>Phase details in expandable sections</li> <li>Phase accountability ledger</li> </ol>"},{"location":"skills/n-phase-cycle/compiler/#3-phase-vs-11-phase","title":"3-Phase vs 11-Phase","text":"Mode Phases Use Case 3-phase UNDERSTAND, ACT, REFLECT Most work 11-phase All phases Crown Jewels <p>Set <code>n_phases: 3</code> for quick wins, <code>n_phases: 11</code> for full ceremony.</p>"},{"location":"skills/n-phase-cycle/compiler/#state-management","title":"State Management","text":"<p>The compiler uses non-destructive state:</p> <ul> <li>Original YAML stays immutable</li> <li>State stored in separate JSON file</li> <li>Handles accumulate across phases</li> <li>Entropy tracked per phase</li> </ul>"},{"location":"skills/n-phase-cycle/compiler/#example","title":"Example","text":"<pre><code># minimal.yaml\nname: \"Add Feature X\"\nclassification: STANDARD\neffort: S\nn_phases: 3\n\nscope:\n  goal: \"Add user authentication\"\n  non_goals:\n    - \"OAuth integration\"\n\ncomponents:\n  - id: C1\n    name: \"Auth module\"\n    effort: S\n</code></pre> <p>Compile: <pre><code>kg nphase compile minimal.yaml\n</code></pre></p>"},{"location":"skills/n-phase-cycle/compiler/#related","title":"Related","text":"<ul> <li>README.md \u2014 N-Phase cycle overview</li> <li>metatheory.md \u2014 Theoretical grounding</li> </ul> <p>Last updated: 2025-12-15</p>"},{"location":"skills/n-phase-cycle/cross-synergize/","title":"Skill: CROSS-SYNERGIZE (N-Phase Cycle)","text":"<p>Discover compositions and entanglements that unlock nonlinear value.</p> <p>Difficulty: Medium Prerequisites: <code>strategize.md</code>, composability laws (spec/principles.md \u00a75) Files Touched: design notes, prototype pipelines, agent registries</p>"},{"location":"skills/n-phase-cycle/cross-synergize/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 CROSS-SYNERGIZE | comps to probe | fixtures ready | ledger.CROSS-SYNERGIZE=touched | entropy.sip(0.05\u20130.10) | next=IMPLEMENT\n</code></pre></li> <li>Minimal artifacts: candidate compositions + probes, law checks, chosen + rejected paths, ledger update, branch handles if new tracks appear.</li> <li>Signals: log tokens/time/entropy + law-check counts + branch count for <code>process-metrics.md</code>.</li> <li>Branch check: emit handles for new primitives or missing components discovered.</li> </ul>"},{"location":"skills/n-phase-cycle/cross-synergize/#overview","title":"Overview","text":"<p>CROSS-SYNERGIZE tests combinations across agents, functors, and puppets to find lifts greater than the sum of parts. It enforces Composable and Generative principles\u2014pipelines are derived, not enumerated.</p>"},{"location":"skills/n-phase-cycle/cross-synergize/#step-by-step","title":"Step-by-Step","text":"<ol> <li>Enumerate candidate morphisms: List possible compositions (agent pipelines, operad operations, puppet swaps).  </li> <li>Probe fast: Build micro-prototypes or dry-runs; prefer hotdata fixtures to avoid speculative LLM loops.  </li> <li>Select and freeze: Choose compositions that satisfy laws (identity/associativity) and do not violate Ethical/Tasteful constraints.</li> </ol>"},{"location":"skills/n-phase-cycle/cross-synergize/#interfaces-headers-continuations-metrics","title":"Interfaces (Headers \u2194 Continuations \u2194 Metrics)","text":"<ul> <li>Ledger/entropy contract: Every continuation generator in SENSE/ACT must emit <code>phase_ledger</code> + <code>entropy</code> snippet per <code>phase-accountability.md</code> so <code>_forest.md</code> and metrics spans stay in sync.</li> <li>Span-ready attrs: When wiring OTEL later (Track C), emit <code>{phase, phase_group, tokens_in, tokens_out, duration_ms, entropy_spent, entropy_remaining, law_checks_run, law_checks_failed, observer_role, branch_count, ledger}</code> matching <code>process-metrics.md</code> + <code>metrics/fixtures/process-metrics.jsonl</code>.</li> <li>Drop point: Until emitters exist, stage offline outputs in <code>metrics/fixtures/process-metrics.jsonl</code> and include branch/owner notes from continuation prompts to keep Track C hotloadable.</li> </ul>"},{"location":"skills/n-phase-cycle/cross-synergize/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>Apply PLAN\u2192RESEARCH\u2192DEVELOP on the set of compositions: Which deserve deeper development? Which are void/entropy exploration?</li> <li>Use <code>meta-skill-operad.md</code> to register new operations; ensure they remain valid under future mutations (operad closure).</li> </ul>"},{"location":"skills/n-phase-cycle/cross-synergize/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>CROSS-SYNERGIZE reserves 5-10% for exploration:</p> <ul> <li>Dormant tree awakening: Skim <code>plans/_forest.md</code> for forgotten plans that might compose.</li> <li>Functor hunting: What existing functors could lift this work? Check <code>FunctorRegistry</code>.</li> <li>Unexpected compositions: Try composing with something that \"shouldn't\" work. Sometimes it does.</li> <li>Bounty board scan: Read <code>plans/_bounty.md</code>\u2014your work might resolve an open gripe.</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.10)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/cross-synergize/#verification","title":"Verification","text":"<ul> <li>Chosen compositions documented with rationale and constraints.</li> <li>Rejected paths noted (to avoid rework).</li> <li>Implementation-ready interfaces defined.</li> </ul>"},{"location":"skills/n-phase-cycle/cross-synergize/#common-pitfalls","title":"Common Pitfalls","text":"<ul> <li>Skipping CROSS-SYNERGIZE entirely: This phase finds leverage. Missing it means missing 2x-10x value multipliers.</li> <li>Enumerating instead of generating: Per AD-003, define grammars, not lists. If you're writing 600 commands, you're doing it wrong.</li> <li>Ignoring law violations: Compositions that break identity/associativity will fail downstream. Check laws in prototype.</li> <li>Speculative LLM loops: Use hotdata fixtures for probing. Don't burn tokens on exploratory combinations.</li> <li>No rejected paths documentation: Future sessions will re-explore dead ends. Write down what didn't work and why.</li> </ul>"},{"location":"skills/n-phase-cycle/cross-synergize/#hand-off","title":"Hand-off","text":"<p>Next: <code>implement.md</code> with selected compositions and constraints.</p>"},{"location":"skills/n-phase-cycle/cross-synergize/#related-skills","title":"Related Skills","text":"<ul> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../flux-agent.md</code></li> <li><code>../polynomial-agent.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/cross-synergize/#continuation-generator","title":"Continuation Generator","text":"<p>Emit this when exiting CROSS-SYNERGIZE:</p>"},{"location":"skills/n-phase-cycle/cross-synergize/#exit-signifier","title":"Exit Signifier","text":"<pre><code># Normal exit (auto-continue):\n\u27ff[IMPLEMENT]\n/hydrate\nhandles: compositions=${chosen_compositions}; interfaces=${implementation_interfaces}; rejected=${rejected_paths}; laws=${law_verifications}; ledger={CROSS-SYNERGIZE:touched}; branches=${branch_notes}\nmission: write code + tests honoring laws/ethics; keep Minimal Output; start tests in background.\nactions: TodoWrite chunks; run pytest watch; code/test slices; log metrics.\nexit: code + tests ready; ledger.IMPLEMENT=touched; QA notes captured; continuation \u2192 QA.\n\n# Halt conditions:\n\u27c2[BLOCKED:composition_conflict] Chosen compositions violate category laws\n\u27c2[BLOCKED:no_viable_path] All candidate compositions rejected\n\u27c2[ENTROPY_DEPLETED] Budget exhausted without entropy sip\n</code></pre> <p>Template vars: <code>${chosen_compositions}</code>, <code>${implementation_interfaces}</code>, <code>${rejected_paths}</code>, <code>${law_verifications}</code>, <code>${branch_notes}</code>.</p>"},{"location":"skills/n-phase-cycle/cross-synergize/#related-skills_1","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../flux-agent.md</code></li> <li><code>../polynomial-agent.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/cross-synergize/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Accursed Share section (re-metabolize).</li> <li>2025-12-13: Added Continuation Generator section (auto-continuation).</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/develop/","title":"Skill: DEVELOP (N-Phase Cycle)","text":"<p>Convert research into sharpened specs, APIs, and operable contracts.</p> <p>Difficulty: Medium Prerequisites: <code>research.md</code>, <code>spec/principles.md</code>, relevant ADs (001-004) Files Touched: specs, docs/skills/, design scratchpads; implementation deferred</p>"},{"location":"skills/n-phase-cycle/develop/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 DEVELOP | contracts to draft | laws to assert | ledger.DEVELOP=touched | entropy.sip(0.05\u20130.10) | next=STRATEGIZE\n</code></pre></li> <li>Minimal artifacts: chosen puppet/functor/operad, inputs/outputs/errors, laws, examples, risk notes, ledger + branch candidates.</li> <li>Signals: log law assertions + token/time/entropy for <code>process-metrics.md</code>; capture branch handles if alternative designs emerge.</li> <li>Branch check: if multiple architectures emerge, classify before leaving; emit bounty or branch handle.</li> </ul>"},{"location":"skills/n-phase-cycle/develop/#overview","title":"Overview","text":"<p>DEVELOP is design compression: minimal specs that can regenerate code. It enforces Generative and Tasteful principles\u2014only the necessary primitives and operads survive.</p>"},{"location":"skills/n-phase-cycle/develop/#step-by-step","title":"Step-by-Step","text":"<ol> <li>Select puppets: Choose representation (operad, functor, sheaf, puppet) that makes the problem tractable.  </li> <li>Define contracts: Inputs/outputs, laws (identity/associativity), error surfaces, hotdata hooks, privacy/ethics constraints.  </li> <li>Prototype in spec: Draft examples, reference skills, and edge cases. Annotate risks and decisions for STRATEGIZE.</li> </ol>"},{"location":"skills/n-phase-cycle/develop/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>Run a micro PLAN\u2192RESEARCH\u2192DEVELOP on the spec draft: what is the smallest generative grammar that still composes?</li> <li>Use <code>meta-skill-operad.md</code> to register new primitives/operations; ensure identity and associativity hold for future mutations.</li> </ul>"},{"location":"skills/n-phase-cycle/develop/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>DEVELOP reserves 5-10% for exploration:</p> <ul> <li>Alternative representations: Try 2-3 type signatures before committing. The best interface often isn't the first.</li> <li>Law discovery: What invariants should hold? Sketch property tests even if you don't run them yet.</li> <li>Composition experiments: Can this agent compose with existing functors? Try <code>Agent &gt;&gt; Flux</code> or <code>Maybe &gt;&gt; Agent</code>.</li> <li>Puppet swapping: What if we modeled this as a different category? (State vs Reader vs Writer)</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.07)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/develop/#forest-adapter-dry-run-contract","title":"Forest Adapter (dry-run contract)","text":"<ul> <li>Map existing forest CLI functions to AGENTESE handles without code changes: <code>forest_status()</code> \u2192 <code>concept.forest.manifest</code>; <code>forest_update()</code> \u2192 <code>concept.forest.refine</code>; epilogue stream \u2192 <code>time.forest.witness</code>; dormant-picker \u2192 <code>void.forest.sip</code>; plan scaffold \u2192 <code>self.forest.define</code>.  </li> <li>Observer roles gate affordances: <code>ops</code> (update/define), <code>meta</code> (manifest/witness/refine), <code>guest</code> (manifest only).  </li> <li>Dry-run prompt: \"Wrap forest_status/forest_update to emit single-handle responses; no arrays; return lawfulness checks (identity/assoc) as metadata only.\"</li> </ul>"},{"location":"skills/n-phase-cycle/develop/#verification","title":"Verification","text":"<ul> <li>Spec/contract exists with examples and invariants.  </li> <li>Laws stated and testable; blockers/risks documented.  </li> <li>Work ready for sequencing in STRATEGIZE.</li> </ul>"},{"location":"skills/n-phase-cycle/develop/#hand-off","title":"Hand-off","text":"<p>Next: <code>strategize.md</code> to order delivery and choose leverage points.</p>"},{"location":"skills/n-phase-cycle/develop/#related-skills","title":"Related Skills","text":"<ul> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../polynomial-agent.md</code></li> <li><code>../agentese-path.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/develop/#continuation-generator","title":"Continuation Generator","text":"<p>Emit this when exiting DEVELOP:</p>"},{"location":"skills/n-phase-cycle/develop/#exit-signifier","title":"Exit Signifier","text":"<pre><code># Normal exit (auto-continue):\n\u27ff[STRATEGIZE]\n/hydrate\nhandles: specs=${specs_created}; laws=${laws_stated}; risks=${risks_noted}; examples=${examples_count}; decisions=${design_decisions}; ledger={DEVELOP:touched}; branches=${branch_notes}\nmission: order chunks for leverage; set owners/interfaces/checkpoints; prep decision gates.\nactions: impact/effort + dependencies; parallel tracks w/ interfaces; metrics to watch; run lookback-revision.\nexit: ordered backlog + owners/checkpoints; ledger.STRATEGIZE=touched; continuation \u2192 CROSS-SYNERGIZE.\n\n# Halt conditions:\n\u27c2[BLOCKED:law_violation] Proposed design violates category laws (identity/associativity)\n\u27c2[BLOCKED:composition_failure] Spec cannot compose with existing agents\n\u27c2[ENTROPY_DEPLETED] Budget exhausted without entropy sip\n</code></pre> <p>Template vars: <code>${specs_created}</code>, <code>${laws_stated}</code>, <code>${risks_noted}</code>, <code>${examples_count}</code>, <code>${design_decisions}</code>, <code>${branch_notes}</code>.</p>"},{"location":"skills/n-phase-cycle/develop/#related-skills_1","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../polynomial-agent.md</code></li> <li><code>../agentese-path.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/develop/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Accursed Share section (re-metabolize).</li> <li>2025-12-13: Added Continuation Generator section (auto-continuation).</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/educate/","title":"Skill: EDUCATE (N-Phase Cycle)","text":"<p>Teach humans and agents how to wield the shipped capability.</p> <p>Difficulty: Easy Prerequisites: <code>test.md</code>, user journey knowledge, docs style guides Files Touched: docs/, prompts/, docs/skills/, release notes</p>"},{"location":"skills/n-phase-cycle/educate/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 EDUCATE | audiences + artifacts | ledger.EDUCATE=touched | entropy.sip(0.05\u20130.10) | next=MEASURE\n</code></pre></li> <li>Minimal artifacts: audience map, docs/prompts/quickstarts with runnable examples or explicit skip debt, degraded-mode notes, ledger update, branch/bounty entries for missing infra.</li> <li>Signals: log tokens/time/entropy + adoption hooks added for <code>process-metrics.md</code>.</li> <li>Branch check: emit follow-up branches for observability gaps or missing demos.</li> </ul>"},{"location":"skills/n-phase-cycle/educate/#overview","title":"Overview","text":"<p>EDUCATE converts validated behavior into accessible guidance (operator guides, prompts, demos). It fulfills Ethical and Joy-Inducing principles by preserving agency and delight.</p>"},{"location":"skills/n-phase-cycle/educate/#step-by-step","title":"Step-by-Step","text":"<ol> <li>Audience mapping: Identify personas (operator, maintainer, contributor) and their AGENTESE contexts.  </li> <li>Artifacts: Update docs, quickstarts, prompts, and demo data using pre-computed richness. Highlight degraded-mode behavior and safety notes.  </li> <li>Support scripts: Add helper CLI snippets or <code>kg</code> invocations; ensure observability cues align with Transparent Infrastructure.</li> </ol>"},{"location":"skills/n-phase-cycle/educate/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>PLAN\u2192RESEARCH\u2192DEVELOP the docs themselves: what minimum grammar communicates the capability?</li> <li>Use <code>meta-skill-operad.md</code> to keep documentation morphisms composable (snippets as reusable arrows).</li> </ul>"},{"location":"skills/n-phase-cycle/educate/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>EDUCATE reserves 5-10% for exploration:</p> <ul> <li>Alternative explanations: Try explaining to three different personas. One framing will click.</li> <li>Demo discovery: What's the smallest runnable example? Sometimes the demo IS the documentation.</li> <li>Failure documentation: What happens when it breaks? Users need error paths too.</li> <li>Personality injection: Where can joy live in this documentation? Find the human moment.</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.05)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/educate/#verification","title":"Verification","text":"<ul> <li>Documentation/prompt updates land with runnable examples.  </li> <li>Warnings, degraded paths, and personality coordinates noted.  </li> <li>Users can reproduce validated behaviors without inside knowledge.</li> </ul>"},{"location":"skills/n-phase-cycle/educate/#hand-off","title":"Hand-off","text":"<p>Next: <code>measure.md</code> to track whether education changed outcomes.</p>"},{"location":"skills/n-phase-cycle/educate/#related-skills","title":"Related Skills","text":"<ul> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../hotdata-pattern.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/educate/#continuation-generator","title":"Continuation Generator","text":"<p>Emit this when exiting EDUCATE:</p>"},{"location":"skills/n-phase-cycle/educate/#exit-signifier","title":"Exit Signifier","text":"<pre><code># Normal exit (auto-continue):\n\u27ff[MEASURE]\n/hydrate\nhandles: docs=${docs_created}; quickstarts=${quickstarts}; scripts=${support_scripts}; audiences=${audiences_mapped}; summary=${education_summary}; degraded=${degraded_paths_docs}; ledger={EDUCATE:touched}; branches=${branch_notes}\nmission: instrument adoption/latency/error signals; wire dashboards/fixtures; capture baselines.\nactions: define leading indicators via process-metrics schema; add telemetry/flags; create hotloadable dashboards; validate data quality.\nexit: metrics live + baselines captured; ledger.MEASURE=touched; continuation \u2192 REFLECT.\n\n# Halt conditions (rare for EDUCATE):\n\u27c2[BLOCKED:missing_infra] Required docs infrastructure missing\n\u27c2[ENTROPY_DEPLETED] Budget exhausted without entropy sip\n</code></pre> <p>Template vars: <code>${docs_created}</code>, <code>${quickstarts}</code>, <code>${support_scripts}</code>, <code>${audiences_mapped}</code>, <code>${education_summary}</code>, <code>${degraded_paths_docs}</code>, <code>${branch_notes}</code>.</p>"},{"location":"skills/n-phase-cycle/educate/#related-skills_1","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../hotdata-pattern.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/educate/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Accursed Share section (re-metabolize).</li> <li>2025-12-13: Added Continuation Generator section (auto-continuation).</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/implement/","title":"Skill: IMPLEMENT (N-Phase Cycle)","text":"<p>Write code with fidelity to specs, laws, and compositional guarantees.</p> <p>Difficulty: Medium Prerequisites: <code>cross-synergize.md</code>, coding patterns (building-agent, flux-agent, polynomial-agent) Files Touched: Implementation modules, fixtures, minimal docs</p>"},{"location":"skills/n-phase-cycle/implement/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 IMPLEMENT | chunks + tests | ledger.IMPLEMENT=touched | entropy.sip(0.05\u20130.10) | tests running | next=QA\n</code></pre></li> <li>Minimal artifacts: code + tests per chunk, ledger update, QA notes, branch candidates if new refactors emerge.</li> <li>Signals: log tokens/time/entropy + law-checks + test counts for <code>process-metrics.md</code>; keep ledger <code>_forest</code>-ready.</li> <li>Branch check: surface refactor/infra branches; emit handles or bounties before exit.</li> </ul>"},{"location":"skills/n-phase-cycle/implement/#the-boldness-of-implement","title":"The Boldness of IMPLEMENT","text":"<p>\"IMPLEMENT is not planning to code. IMPLEMENT is coding.\"</p> <p>When you enter IMPLEMENT phase, you are not preparing to write code. You ARE writing code. The feeling is:</p> <ul> <li>Urgency: Tests running in background NOW</li> <li>Commitment: TodoWrite tracking each chunk as in_progress</li> <li>Parallel motion: Independent files being edited in sequence, tests validating continuously</li> <li>Completion: Each chunk marked complete BEFORE moving to next</li> </ul>"},{"location":"skills/n-phase-cycle/implement/#the-implement-manifesto","title":"The IMPLEMENT Manifesto","text":"<pre><code>I will write code, not describe what code to write.\nI will run tests in background while I edit.\nI will use TodoWrite to track every chunk.\nI will mark chunks complete immediately upon finishing.\nI will not stop at \"almost done\" - I will FINISH.\n</code></pre>"},{"location":"skills/n-phase-cycle/implement/#overview","title":"Overview","text":"<p>IMPLEMENT turns selected compositions into code while preserving category laws, ethics, and taste. It emphasizes small, verifiable increments and hotdata use over speculative LLM calls.</p>"},{"location":"skills/n-phase-cycle/implement/#step-by-step-with-action","title":"Step-by-Step (With Action)","text":"<ol> <li>Prep environment:</li> <li><code>Bash(run_in_background=true)</code>: Start test suite watching</li> <li><code>TodoWrite</code>: Declare all chunks as pending</li> <li> <p><code>Read</code> (parallel): Open all relevant files NOW</p> </li> <li> <p>Code in slices:</p> </li> <li>Mark chunk as <code>in_progress</code> in TodoWrite</li> <li>Write the code (Edit tool, not description)</li> <li>Write tests alongside (not after)</li> <li> <p>Mark chunk as <code>completed</code> IMMEDIATELY when done</p> </li> <li> <p>Stabilize:</p> </li> <li><code>Bash</code>: Run mypy/ruff (not \"you should run\")</li> <li>Capture deviations in TodoWrite as new items</li> <li>Background test suite confirms nothing broke</li> </ol>"},{"location":"skills/n-phase-cycle/implement/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>Mini-cycle the feature: PLAN (slice), RESEARCH (code paths), DEVELOP (API tweak), STRATEGIZE (order), IMPLEMENT (done).</li> <li>Register new morphisms through <code>meta-skill-operad.md</code> so future skill mutations respect identity/associativity.</li> </ul>"},{"location":"skills/n-phase-cycle/implement/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>IMPLEMENT reserves 5-10% for exploration:</p> <ul> <li>Dead ends are offerings: Not all code paths work. That's data, not failure.</li> <li>Speculative imports: Try the real component before mocking. If it fails, you learn something.</li> <li>Wiring experiments: Sometimes connecting A\u2192B reveals B needs refactoring. That's the Accursed Share at work.</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.07)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/implement/#verification","title":"Verification","text":"<ul> <li>Code compiles; tests for new behavior exist and pass locally.</li> <li>Composition laws and ethics/privacy constraints upheld.</li> <li>Notes for QA checklist captured.</li> </ul>"},{"location":"skills/n-phase-cycle/implement/#common-pitfalls","title":"Common Pitfalls","text":"<ul> <li>Skipping RESEARCH/DEVELOP: Jumping straight to IMPLEMENT causes rework. The 30 minutes spent in prior phases saves 3 hours of refactoring.</li> <li>Writing tests after: Tests should be written alongside code, not as an afterthought. TDD or parallel development.</li> <li>Heavy module-level imports: Hollow Shell pattern requires lazy imports. <code>from heavy_lib import X</code> at module level slows CLI startup.</li> <li>Breaking composition laws: Hidden mutable state breaks <code>&gt;&gt;</code> operator guarantees. Use <code>frozen=True</code> dataclasses for inputs.</li> <li>LLM agents returning arrays: Per Minimal Output Principle, return single outputs. Call N times for N outputs.</li> <li>Ignoring mypy: Type errors caught early are cheap. Run <code>uv run mypy .</code> before committing.</li> <li>Mock-only tests: Test with both mocks (isolation) AND real instances (integration). Mocks verify contracts; real instances verify wiring.</li> <li>Breaking backward compat: When extending factory functions, add new params with <code>default=None</code>. Existing callers continue working.</li> </ul>"},{"location":"skills/n-phase-cycle/implement/#wiring-pattern","title":"Wiring Pattern","text":"<p>When connecting existing components (substrate, compactor, router), follow the composition chain:</p> <pre><code>Unified Factory \u2192 Component Factory \u2192 Node\n     \u2193                   \u2193              \u2193\ncreate_context_resolvers \u2192 create_self_resolver \u2192 MemoryNode\n</code></pre> <p>Key principles: 1. Thread parameters through each layer (don't skip levels) 2. Default to <code>None</code> for backward compatibility 3. Graceful degradation: return informative errors when deps missing 4. Real integration tests verify the wiring works end-to-end</p>"},{"location":"skills/n-phase-cycle/implement/#bidirectional-sync-pattern","title":"Bidirectional Sync Pattern","text":"<p>When two systems need coherent views of the same truth, use the Galois connection pattern:</p> <pre><code>floor \u22a3 ceiling : SystemA \u21c6 SystemB\n\nfloor(b) = a_state       # B \u2192 A projection\nceiling(a) = b_repr      # A \u2192 B embedding\n</code></pre> <p>The Three-Way Protocol (from Ghost \u2194 Substrate sync):</p> <pre><code># 1. Store \u2192 Sync: When A changes, update B\nasync def store_with_sync(self, key, value):\n    success = await self._system_a.store(key, value)\n    if success:\n        self._system_b.write(key, metadata)  # ceiling\n    return success\n\n# 2. Access \u2192 Touch: When B is read, notify A\ndef on_b_access(self, key):\n    allocation = self._system_a.get(key)\n    if allocation:\n        allocation.record_access()  # floor\n\n# 3. Evict \u2192 Invalidate: When A removes, clean B\nasync def evict_with_sync(self, key):\n    await self._system_b.invalidate(key)\n    await self._system_a.remove(key)\n</code></pre> <p>When to use: - Cache \u2194 Storage coherence - Ghost \u2194 Substrate memory sync - UI State \u2194 Model reactivity - Any two representations of the same entity</p> <p>Law preservation: - <code>floor(ceiling(a)) \u2245 a</code> (up to serialization) - Sync events are observable (for debugging)</p>"},{"location":"skills/n-phase-cycle/implement/#hand-off","title":"Hand-off","text":"<p>Next: <code>qa.md</code> for gatekeeping and hygiene before broader testing.</p>"},{"location":"skills/n-phase-cycle/implement/#continuation-generator","title":"Continuation Generator","text":"<p>Emit this when exiting IMPLEMENT:</p>"},{"location":"skills/n-phase-cycle/implement/#exit-signifier","title":"Exit Signifier","text":"<pre><code># Normal exit (auto-continue):\n\u27ff[QA]\n/hydrate\nhandles: code=${files_created_or_modified}; tests=${test_files}; results=${test_count_delta}; summary=${implementation_summary}; laws=${law_checks_performed}; ledger={IMPLEMENT:touched}; branches=${branch_notes}\nmission: gate quality/security/lawfulness before broader testing.\nactions: uv run mypy .; uv run ruff check; security sweep; docstring drift check.\nexit: QA checklist status + ledger.QA=touched; notes for TEST; continuation \u2192 TEST.\n\n# Halt conditions:\n\u27c2[BLOCKED:impl_incomplete] Implementation chunks remain unfinished\n\u27c2[BLOCKED:tests_failing] New tests failing before QA gate\n\u27c2[ENTROPY_DEPLETED] Budget exhausted without entropy sip\n</code></pre> <p>Template vars: <code>${files_created_or_modified}</code>, <code>${test_files}</code>, <code>${test_count_delta}</code>, <code>${implementation_summary}</code>, <code>${law_checks_performed}</code>, <code>${branch_notes}</code>.</p>"},{"location":"skills/n-phase-cycle/implement/#related-skills","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../building-agent.md</code>, <code>../flux-agent.md</code>, <code>../polynomial-agent.md</code>, <code>../hotdata-pattern.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/implement/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Bidirectional Sync Pattern (from Phase 8 Ghost Sync).</li> <li>2025-12-13: Added Accursed Share section (meta-re-metabolize).</li> <li>2025-12-13: Added Wiring Pattern section and mock+real testing pitfall (from substrate wiring).</li> <li>2025-12-13: Added Continuation Generator section (auto-continuation).</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/measure/","title":"Skill: MEASURE (N-Phase Cycle)","text":"<p>Instrument and observe effects to validate value and guide adjustments.</p> <p>Difficulty: Medium Prerequisites: <code>educate.md</code>, observability patterns, data access constraints Files Touched: metrics dashboards, telemetry configs, experiment logs</p>"},{"location":"skills/n-phase-cycle/measure/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 MEASURE | signals + baselines | ledger.MEASURE=touched | entropy.sip(0.05\u20130.10) | next=REFLECT\n</code></pre></li> <li>Minimal artifacts: defined signals + owners, telemetry hooks/dashboards (hotloadable welcome), baselines + alert thresholds, ledger update, branch/bounty entries for gaps.</li> <li>Signals: report tokens/time/entropy + lawfulness + adoption to <code>process-metrics.md</code>; keep fixtures hotloadable.</li> <li>Branch check: if missing instrumentation blocks progress, emit a branch handle.</li> </ul>"},{"location":"skills/n-phase-cycle/measure/#overview","title":"Overview","text":"<p>MEASURE ensures work delivers real-world value. It aligns with Transparent Infrastructure and Generative principles\u2014signals are composable and reusable.</p>"},{"location":"skills/n-phase-cycle/measure/#step-by-step","title":"Step-by-Step","text":"<ol> <li>Define signals: Choose leading indicators (usage, latency, errors, adoption), aligned to goals from PLAN/STRATEGIZE and the <code>process-metrics.md</code> schema (token/time/entropy/lawfulness/exploration spend).  </li> <li>Instrument: Add telemetry hooks (OTEL spans/metrics), feature flags, and dashboards; prefer hotloadable data for demos.  </li> <li>Run checks: Validate data quality, baseline measurements, and alert thresholds; document how to read them.</li> <li>Lookback: Run <code>lookback-revision.md</code> on measurement assumptions/results to catch double-loop shifts and trigger re-metabolization if needed.</li> </ol>"},{"location":"skills/n-phase-cycle/measure/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>Apply PLAN\u2192RESEARCH\u2192DEVELOP to the measurement model: are we measuring the grammar or instances?</li> <li>Use <code>meta-skill-operad.md</code> so metrics/alerts compose (identity metric, associative aggregation) and survive skill mutations.</li> </ul>"},{"location":"skills/n-phase-cycle/measure/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>MEASURE reserves 5-10% for exploration:</p> <ul> <li>Metric invention: What signal would you WANT but don't have? Sometimes it's measurable.</li> <li>Counter-metrics: What would indicate this feature is harmful? Measure that too.</li> <li>Correlation hunting: What other metrics might move when this one does?</li> <li>Dashboard sketching: Sketch the ideal dashboard before instrumenting. Work backward.</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.07)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/measure/#verification","title":"Verification","text":"<ul> <li>Metrics live with readable dashboards and alerting where needed.  </li> <li>Baselines captured; data quality checked.  </li> <li>Insights piped back to REFLECT.</li> </ul>"},{"location":"skills/n-phase-cycle/measure/#hand-off","title":"Hand-off","text":"<p>Next: <code>reflect.md</code> to synthesize learnings and feed the next loop.</p>"},{"location":"skills/n-phase-cycle/measure/#related-skills","title":"Related Skills","text":"<ul> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>lookback-revision.md</code></li> <li><code>process-metrics.md</code></li> <li><code>../agent-observability.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/measure/#continuation-generator","title":"Continuation Generator","text":"<p>Emit this when exiting MEASURE:</p>"},{"location":"skills/n-phase-cycle/measure/#exit-signifier","title":"Exit Signifier","text":"<pre><code># Normal exit (auto-continue):\n\u27ff[REFLECT]\n/hydrate\nhandles: metrics=${metrics_instrumented}; dashboards=${dashboards}; baselines=${baselines}; alerts=${alert_thresholds}; summary=${measurement_summary}; data=${data_quality_notes}; lookback=${lookback_findings}; ledger={MEASURE:touched}; branches=${branch_notes}\nmission: synthesize outcomes; distill learnings; choose continuation (PLAN/meta-re-metabolize/DETACH).\nactions: summarize shipped/changed/risks; distill one-line zettels (Molasses Test); epilogue + bounty updates; decide continuation.\nexit: epilogue + next-plan entry or DETACH handle; ledger.REFLECT=touched; continuation emitted per choice.\n\n# Halt conditions (rare for MEASURE):\n\u27c2[BLOCKED:metrics_broken] Instrumentation failed; cannot measure\n\u27c2[ENTROPY_DEPLETED] Budget exhausted without entropy sip\n</code></pre> <p>Template vars: <code>${metrics_instrumented}</code>, <code>${dashboards}</code>, <code>${baselines}</code>, <code>${alert_thresholds}</code>, <code>${measurement_summary}</code>, <code>${data_quality_notes}</code>, <code>${lookback_findings}</code>, <code>${branch_notes}</code>.</p>"},{"location":"skills/n-phase-cycle/measure/#related-skills_1","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>lookback-revision.md</code></li> <li><code>process-metrics.md</code></li> <li><code>../agent-observability.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/measure/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Accursed Share section (re-metabolize).</li> <li>2025-12-13: Added Continuation Generator section (auto-continuation).</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/meta-re-metabolize/","title":"Meta Skill: Re-Metabolize the Lifecycle","text":"<p>Periodically re-ingest the N-phase cycle and its skills so the factory stays alive, not ossified.</p> <p>Difficulty: Medium Prerequisites: All phase skills, <code>meta-skill-operad.md</code></p>"},{"location":"skills/n-phase-cycle/meta-re-metabolize/#overview","title":"Overview","text":"<p>Re-metabolization is an endofunctor on the skill category: it takes the current lifecycle skill set and returns an updated, law-preserving version. It prevents drift, reintroduces exploration capacity, and keeps category laws intact over long time horizons.</p>"},{"location":"skills/n-phase-cycle/meta-re-metabolize/#protocol","title":"Protocol","text":"<ol> <li> <p>Trigger check: Run when REFLECT flags drift, when principles change, or on a cadence (monthly).</p> </li> <li> <p>Survey + compare: Apply UNDERSTAND micro-cycles to each skill:</p> </li> <li>Is the hologram intact?</li> <li>Do steps still reflect reality?</li> <li> <p>Note redundancies.</p> </li> <li> <p>Mutate with operad: Use <code>meta-skill-operad.md</code> morphisms to refine/prune/fuse skills. Preserve identities (baseline) and associativity (composition order).</p> </li> <li> <p>Publish delta: Update indices, summarize changes in epilogue, and flag follow-ups.</p> </li> </ol>"},{"location":"skills/n-phase-cycle/meta-re-metabolize/#verification","title":"Verification","text":"<ul> <li> All phase skills contain current exit criteria</li> <li> Redundant skills merged or archived</li> <li> New needs captured</li> <li> Next entry point recorded</li> </ul>"},{"location":"skills/n-phase-cycle/meta-re-metabolize/#continuation","title":"Continuation","text":"<p>Upon exit, generate:</p> <pre><code># After Re-Metabolize\n\n/hydrate\n\nRe-metabolization complete. Skills refreshed.\n\nChanges: ${skills_modified}\nLaw verification: ${law_check_results}\n\nResume normal cycle with refreshed skills.\n</code></pre>"},{"location":"skills/n-phase-cycle/meta-re-metabolize/#related","title":"Related","text":"<ul> <li><code>auto-continuation.md</code> \u2014 Continuation mechanism</li> <li><code>meta-skill-operad.md</code> \u2014 Lawful skill mutation</li> <li><code>reflect.md</code> \u2014 Trigger source</li> </ul> <p>Last updated: 2025-12-15</p>"},{"location":"skills/n-phase-cycle/meta-skill-operad/","title":"Meta Skill: Skill Operad (Category-Theoretic Mutation)","text":"<p>Treat skills as objects in a category and edits as morphisms; mutate lawfully so the library stays composable and durable.</p> <p>Difficulty: Medium Prerequisites: spec/principles.md (\u00a75 Composable), AD-001/002/003, familiarity with operads/functors Files Touched: docs/skills/* (including n-phase-cycle), README indices</p>"},{"location":"skills/n-phase-cycle/meta-skill-operad/#overview","title":"Overview","text":"<p>Skills themselves are composable programs. This meta skill defines how to add, mutate, and delete skills using operadic grammar: - Objects: Skill documents - Morphisms: Edits (add, refine, prune) - Operad: Allowed compositions (e.g., add section, adjust hologram, cross-link)</p> <p>The goal is lawful mutation: identity and associativity preserved across sessions, preventing drift and bloat.</p>"},{"location":"skills/n-phase-cycle/meta-skill-operad/#step-by-step","title":"Step-by-Step","text":"<ol> <li>Model the target: Identify the skill object(s) and desired morphism type (add, refine, prune). Determine arity if composing multiple skills.  </li> <li>Check laws: Ensure identity (no-op leaves meaning intact) and associativity (order of independent edits does not change semantics). If law fails, redesign the operation.  </li> <li>Compose + apply: Use operad grammar\u2014<code>plug(operation, subskills)</code>\u2014to apply the edit. Update cross-links and indices minimally.  </li> <li>Record hologram: Verify the skill contains a <code>Recursive Hologram</code> section tying it back to the full PLAN\u2192REFLECT loop.</li> </ol>"},{"location":"skills/n-phase-cycle/meta-skill-operad/#verification","title":"Verification","text":"<ul> <li>Edit can be expressed as morphism composition; identity/associativity hold.  </li> <li>Cross-links updated; indices remain curated (no sprawl).  </li> <li><code>Recursive Hologram</code> present and aligned with lifecycle.</li> </ul>"},{"location":"skills/n-phase-cycle/meta-skill-operad/#mutation-patterns-operad","title":"Mutation Patterns (Operad)","text":"<ul> <li>AddSkill(skill): Introduce new object with template compliance and hologram.</li> <li>RefineSection(skill, section): Associative; compose multiple refinements without conflict.</li> <li>Prune(skill): Remove or archive when redundant; ensure incoming morphisms reroute or dissolve (no dangling references).</li> <li>Fuse(skill_a, skill_b): When overlap &gt;70%, merge into single object; update links; preserve Accursed Share notes.</li> <li>N-Phase mutation hook: When touching AD-005 skills, always preserve quick-card shape, ledger/entropy fields, and Continuation Generators; compose refinements via <code>RefineSection</code> instead of ad-hoc edits.</li> </ul>"},{"location":"skills/n-phase-cycle/meta-skill-operad/#recursive-hologram","title":"Recursive Hologram","text":"<p>Apply PLAN\u2192RESEARCH\u2192DEVELOP to skill mutations:</p> <ul> <li>PLAN: What skill object and morphism type? (add/refine/prune/fuse)</li> <li>RESEARCH: What cross-links and dependencies exist? Which skills reference this one?</li> <li>DEVELOP: Design the mutation preserving laws (identity/associativity)</li> <li>STRATEGIZE: Order mutations to minimize churn</li> <li>IMPLEMENT: Apply via operad grammar</li> <li>TEST: Verify identity (no-op preserves meaning) and associativity (order-independent)</li> <li>REFLECT: Did the mutation improve the system? Update this skill if patterns emerge.</li> </ul> <p>The meta-skill is itself an object in the category it describes. Mutations to this file must pass through the same operad it defines.</p>"},{"location":"skills/n-phase-cycle/meta-skill-operad/#related","title":"Related","text":"<ul> <li><code>meta-re-metabolize.md</code> (periodic regeneration loop)  </li> <li><code>docs/skills/README.md</code> (template)  </li> <li><code>plans/principles.md</code> (Meta-Bloat Prevention)</li> </ul>"},{"location":"skills/n-phase-cycle/meta-skill-operad/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Recursive Hologram section (re-metabolize).</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/metatheory/","title":"Meta Skill: Metatheory of the N-Phase Cycle","text":"<p>\"The 'N' is not a number\u2014it is a variable. The cycle adapts to the task.\"</p> <p>Difficulty: High Prerequisites: <code>spec/principles.md</code>, all phase skills, familiarity with decision and learning theory Files Touched: This file is reference; modifications via <code>meta-skill-operad.md</code></p>"},{"location":"skills/n-phase-cycle/metatheory/#why-n-phase","title":"Why \"N-Phase\"?","text":"<p>The cycle is named N-Phase because:</p> <ol> <li>Variable granularity: Some tasks need 3 phases (SENSE\u2192ACT\u2192REFLECT), others need 11, others need 2</li> <li>Domain agnostic: Different domains may discover different optimal phase counts</li> <li>Evolutionary: The cycle itself can add/remove/merge phases over time</li> <li>Self-similar: Each phase contains a hologram of the full cycle, so N can nest</li> </ol> <p>The number is not sacred. The structure is sacred: - Intention before action (SENSE family) - Action with verification (ACT family) - Learning from outcomes (REFLECT family)</p>"},{"location":"skills/n-phase-cycle/metatheory/#metatheoretical-grounding","title":"Metatheoretical Grounding","text":"<p>The N-Phase Cycle is not invented from nothing. It synthesizes established frameworks:</p>"},{"location":"skills/n-phase-cycle/metatheory/#1-ooda-loop-boyd-1970s","title":"1. OODA Loop (Boyd, 1970s)","text":"<p>Observe \u2192 Orient \u2192 Decide \u2192 Act</p> <p>Military decision cycle for competitive advantage. Key insight: the faster you cycle, the more you shape the environment.</p> OODA N-Phase Mapping Observe RESEARCH (data gathering) Orient DEVELOP, STRATEGIZE (framing, context) Decide CROSS-SYNERGIZE (composition selection) Act IMPLEMENT, QA, TEST <p>What OODA contributes: Speed through iteration. \"Tempo\" as competitive edge. The loop doesn't end\u2014it perpetuates.</p> <p>Source: OODA Loop - Wikipedia</p>"},{"location":"skills/n-phase-cycle/metatheory/#2-pdca-deming-cycle-shewhart-1920s-deming-1950s","title":"2. PDCA / Deming Cycle (Shewhart, 1920s; Deming, 1950s)","text":"<p>Plan \u2192 Do \u2192 Check \u2192 Act</p> <p>Quality improvement cycle. Key insight: treat action as hypothesis testing.</p> PDCA N-Phase Mapping Plan PLAN, DEVELOP, STRATEGIZE Do IMPLEMENT Check QA, TEST, MEASURE Act REFLECT, Re-Metabolize <p>What PDCA contributes: Continuous improvement. No \"done\"\u2014only \"better\". The cycle is a control loop with feedback.</p> <p>Source: PDCA Cycle - ASQ</p>"},{"location":"skills/n-phase-cycle/metatheory/#3-double-loop-learning-argyris-schon-1970s","title":"3. Double-Loop Learning (Argyris &amp; Sch\u00f6n, 1970s)","text":"<p>Single-loop: Change actions to fix error. Double-loop: Change governing variables (goals, values, frames) to fix error.</p> Learning Type N-Phase Mapping Single-loop IMPLEMENT \u2192 QA \u2192 fix \u2192 retry Double-loop REFLECT \u2192 PLAN revision \u2192 RESEARCH reframe <p>What double-loop contributes: The ability to question the question. REFLECT doesn't just ask \"did we do it right?\" but \"are we doing the right thing?\"</p> <p>The <code>lookback-revision.md</code> skill operationalizes double-loop learning.</p> <p>Source: Double-Loop Learning - infed.org</p>"},{"location":"skills/n-phase-cycle/metatheory/#4-reflection-in-action-schon-1983","title":"4. Reflection-in-Action (Sch\u00f6n, 1983)","text":"<p>Reflection-on-action: After the fact. Reflection-in-action: During the act, adjusting in real-time.</p> Reflection Type N-Phase Mapping Reflection-on-action REFLECT phase at end of cycle Reflection-in-action Recursive hologram within each phase <p>What Sch\u00f6n contributes: The insight that every phase contains its own micro-cycle. IMPLEMENT contains sensing, acting, reflecting\u2014just at smaller scale.</p>"},{"location":"skills/n-phase-cycle/metatheory/#5-category-theory-compositional-structure","title":"5. Category Theory (Compositional Structure)","text":"<p>Phases are morphisms in a category where: - Objects: Phase boundaries (states of knowledge) - Morphisms: Phase executions (transformations) - Composition: <code>(A &gt;&gt; B) &gt;&gt; C \u2261 A &gt;&gt; (B &gt;&gt; C)</code> (associativity) - Identity: Empty phase (pass-through)</p> Category Concept N-Phase Mapping Morphism Phase execution Composition Phase chaining Functor Cycle embedding (11 \u2192 3 \u2192 11) Natural transformation Cycle evolution over time <p>What category theory contributes: The lawfulness of composition. Any mutation to phases must preserve identity and associativity. This prevents drift and ensures the cycle remains coherent.</p> <p>Source: Category Theory - Wikipedia</p>"},{"location":"skills/n-phase-cycle/metatheory/#6-kaizen-continuous-improvement","title":"6. Kaizen (Continuous Improvement)","text":"<p>Not a cycle but a mindset: small, frequent improvements compound into significant change.</p> <p>What Kaizen contributes: The 5-10% Accursed Share in each phase. Exploration is not waste\u2014it's the source of all improvement.</p> <p>Source: PDCA and Kaizen - The Lean Way</p>"},{"location":"skills/n-phase-cycle/metatheory/#the-synthesis","title":"The Synthesis","text":"<p>The N-Phase Cycle is the intersection of these frameworks:</p> <pre><code>                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502           N-PHASE CYCLE                 \u2502\n                    \u2502                                         \u2502\n    OODA (tempo)    \u2502   PDCA (control)   Argyris (double-loop)\u2502\n    \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500   \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n                    \u2502                                         \u2502\n    Category Theory \u2502   Sch\u00f6n (reflection)   Kaizen (entropy) \u2502\n    \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500   \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502\n                    \u2502                                         \u2502\n                    \u2502   = Self-similar, composable, adaptive  \u2502\n                    \u2502     lifecycle for agent-human work      \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"skills/n-phase-cycle/metatheory/#optimal-phase-count","title":"Optimal Phase Count","text":"Context Optimal N Phases Used Trivial (typo) 0 Direct action Quick win (bug fix) 2 ACT \u2192 REFLECT Standard feature 3 SENSE \u2192 ACT \u2192 REFLECT Multi-session feature 7 PLAN \u2192 RESEARCH \u2192 DEVELOP \u2192 IMPLEMENT \u2192 TEST \u2192 MEASURE \u2192 REFLECT Crown Jewel (multi-week) 11 Full cycle Meta-work (cycle evolution) 11+ Full cycle + Re-Metabolize <p>Principle: Start with 3 phases. Expand only when complexity demands.</p>"},{"location":"skills/n-phase-cycle/metatheory/#the-flexibility-invariant","title":"The Flexibility Invariant","text":"<p>While N is variable, these properties are invariant:</p> <ol> <li>Intention precedes action \u2014 No IMPLEMENT without some SENSE</li> <li>Action produces artifacts \u2014 Phases have outputs, not just activities</li> <li>Reflection feeds forward \u2014 Learnings propagate to next cycle</li> <li>Entropy budget exists \u2014 Every phase reserves exploration capacity</li> <li>Continuity is explicit \u2014 Every phase generates the next prompt</li> <li>Laws hold \u2014 Identity, associativity, branching rules</li> </ol> <p>Any instantiation of the N-Phase Cycle must satisfy these invariants. A \"3-phase cycle\" that lacks reflection is not a valid instantiation.</p>"},{"location":"skills/n-phase-cycle/metatheory/#evolution-mechanism","title":"Evolution Mechanism","text":"<p>The cycle evolves via <code>meta-re-metabolize.md</code>:</p> <ol> <li>REFLECT surfaces staleness or drift</li> <li>Meta-re-metabolize triggers re-ingestion of all phase skills</li> <li>Mutations applied via <code>meta-skill-operad.md</code></li> <li>Laws verified (identity/associativity)</li> <li>Updated cycle deployed</li> </ol> <p>The N-Phase Cycle is autopoietic\u2014it maintains and reproduces itself through its own operations.</p>"},{"location":"skills/n-phase-cycle/metatheory/#recursive-hologram","title":"Recursive Hologram","text":"<p>This metatheory skill applies to itself:</p> <ul> <li>PLAN: Define the theoretical grounding</li> <li>RESEARCH: Survey decision theory, learning theory, category theory</li> <li>DEVELOP: Synthesize into coherent framework</li> <li>IMPLEMENT: Write this document</li> <li>TEST: Do the metatheoretical claims hold in practice?</li> <li>REFLECT: Are the cited frameworks accurately represented?</li> </ul>"},{"location":"skills/n-phase-cycle/metatheory/#sources","title":"Sources","text":"<ul> <li>OODA Loop - Wikipedia</li> <li>PDCA Cycle - ASQ</li> <li>Double-Loop Learning - infed.org</li> <li>Reflective Practitioner - Sch\u00f6n, 1983</li> <li>Category Theory - Wikipedia</li> <li>Kaizen and PDCA - The Lean Way</li> </ul>"},{"location":"skills/n-phase-cycle/metatheory/#related-skills","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 How the cycle perpetuates</li> <li><code>meta-skill-operad.md</code> \u2014 Lawful cycle mutation</li> <li><code>meta-re-metabolize.md</code> \u2014 Periodic cycle refresh</li> <li><code>lookback-revision.md</code> \u2014 Double-loop operationalized</li> <li><code>three-phase.md</code> \u2014 The 3-phase compression</li> </ul>"},{"location":"skills/n-phase-cycle/metatheory/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Initial version (per user request to formalize metatheory grounding).</li> </ul>"},{"location":"skills/n-phase-cycle/phase-accountability/","title":"Meta Skill: Phase Accountability","text":"<p>\"Every phase touched leaves a trace. Every phase skipped leaves a debt.\"</p> <p>Difficulty: Easy Prerequisites: <code>metatheory.md</code>, understanding of full 11-phase cycle Files Touched: Phase output artifacts, <code>plans/_epilogues/</code>, <code>plans/meta.md</code></p>"},{"location":"skills/n-phase-cycle/phase-accountability/#the-accountability-principle","title":"The Accountability Principle","text":"<p>The N-Phase Cycle is not a buffet. When the full cycle is declared (Crown Jewel work), every phase must be touched\u2014even if briefly. An agent who skips a phase without explicit acknowledgment is liable for any consequences that would have been caught by that phase.</p>"},{"location":"skills/n-phase-cycle/phase-accountability/#what-touched-means","title":"What \"Touched\" Means","text":"<p>A phase is considered \"touched\" if any of the following occur:</p> Minimal Touch Full Engagement Phase mentioned in continuation prompt Phase has its own section in output Explicit skip declaration with reason Phase produces artifacts \"Nothing to do here\" documented Phase triggers learnings in meta.md <p>The minimum bar: Acknowledge the phase. State what you did (or explicitly didn't do) and why.</p>"},{"location":"skills/n-phase-cycle/phase-accountability/#the-liability-protocol","title":"The Liability Protocol","text":""},{"location":"skills/n-phase-cycle/phase-accountability/#when-a-phase-is-skipped-without-declaration","title":"When a Phase is Skipped Without Declaration","text":"<p>If a later phase fails or produces defects, and the skipped phase would have caught the issue, the agent is liable:</p> <ol> <li>Demotion signal: The agent's track record notes the skip-induced failure</li> <li>Remediation: The agent must execute the skipped phase retroactively</li> <li>Meta-learning: The failure is recorded in <code>plans/meta.md</code> as anti-pattern</li> </ol>"},{"location":"skills/n-phase-cycle/phase-accountability/#how-liability-is-assessed","title":"How Liability is Assessed","text":"Skipped Phase Typical Consequence PLAN Scope creep, wasted work RESEARCH Duplicate work, missed prior art DEVELOP Brittle architecture, law violations STRATEGIZE Suboptimal ordering, blocked tracks CROSS-SYNERGIZE Missed leverage, isolated work IMPLEMENT (cannot be skipped) QA Bugs shipped, security vulnerabilities TEST Regressions, coverage gaps EDUCATE Unusable features, poor documentation MEASURE Invisible impact, no improvement signal REFLECT Repeated mistakes, no learning"},{"location":"skills/n-phase-cycle/phase-accountability/#explicit-skip-protocol","title":"Explicit Skip Protocol","text":"<p>To skip a phase without liability, declare:</p> <pre><code>## PHASE: [Phase Name] \u2014 EXPLICIT SKIP\n\n**Reason**: [Why this phase adds no value for this task]\n**Risk accepted**: [What could go wrong, acknowledged]\n**Fallback**: [What will catch issues if this skip was wrong]\n</code></pre> <p>Examples of valid skips:</p> <pre><code>## EDUCATE \u2014 EXPLICIT SKIP\n\n**Reason**: Internal refactor with no user-facing changes.\n**Risk accepted**: Maintainers may not understand the change.\n**Fallback**: Code comments serve as minimal documentation.\n</code></pre> <pre><code>## CROSS-SYNERGIZE \u2014 EXPLICIT SKIP\n\n**Reason**: Single-track work with no obvious composition partners.\n**Risk accepted**: May miss leverage with dormant plans.\n**Fallback**: Bounty board review during REFLECT will surface missed synergies.\n</code></pre>"},{"location":"skills/n-phase-cycle/phase-accountability/#the-full-cycle-trace","title":"The Full Cycle Trace","text":"<p>For Crown Jewel work (full 11-phase cycle declared), the epilogue must contain a Phase Trace:</p> <pre><code>## Phase Trace\n\n| Phase | Status | Key Output |\n|-------|--------|------------|\n| PLAN | \u2713 | Scope defined, chunks identified |\n| RESEARCH | \u2713 | 15 files mapped, 3 blockers surfaced |\n| DEVELOP | \u2713 | Contract spec, 2 law assertions |\n| STRATEGIZE | \u2713 | 5 chunks prioritized |\n| CROSS-SYNERGIZE | \u2298 skip | Internal work, no composition |\n| IMPLEMENT | \u2713 | 342 lines, 18 tests |\n| QA | \u2713 | mypy clean, ruff clean |\n| TEST | \u2713 | 743 \u2192 761 tests |\n| EDUCATE | \u2298 skip | Internal, comments sufficient |\n| MEASURE | \u2298 defer | Metrics in next cycle |\n| REFLECT | \u2713 | 3 learnings, 1 bounty |\n\n**Skips declared**: CROSS-SYNERGIZE, EDUCATE, MEASURE (deferred)\n**Liability acknowledged**: Yes\n</code></pre>"},{"location":"skills/n-phase-cycle/phase-accountability/#ledger-snippet-plan-header-ready","title":"Ledger Snippet (plan header ready)","text":"<p>Embed a compact ledger in each plan header or scratch note to make <code>_forest</code> reconciliation trivial:</p> <pre><code>phase_ledger:\n  PLAN: touched\n  RESEARCH: touched\n  DEVELOP: skipped  # reason: known pattern\n  STRATEGIZE: touched\n  CROSS-SYNERGIZE: skipped  # reason: single-track\n  IMPLEMENT: touched\n  QA: touched\n  TEST: touched\n  EDUCATE: skipped  # reason: internal change\n  MEASURE: deferred  # reason: metrics lag\n  REFLECT: touched\nentropy:\n  planned: 0.07\n  spent: 0.05\n  returned: 0.02\n</code></pre> <p>Rules: - <code>touched | skipped | deferred</code> only; always include a reason for non-touch. - Track entropy sip/pour to enforce the Accursed Share budget. - Keep it terse; this is a pheromone trace, not prose. - Epilogue-ready example:   <pre><code>phase_trace: [{phase: PLAN, status: touched}, {phase: RESEARCH, status: touched}, ...]\nledger: {PLAN: touched, ...}\nentropy: {planned: 0.07, spent: 0.05, returned: 0.02}\n</code></pre> <code>_forest.md</code> ingestion expects these keys; keep formats consistent across sessions.</p> <p>AGENTESE ledger micro-prompt (per phase): - <code>concept.forest.manifest[phase=PLAN][minimal_output=true]@span=forest_plan</code> \u2192 note scope + ledger presence. - <code>void.entropy.sip[phase=RESEARCH][entropy=0.07]@span=entropy_sip</code> \u2192 update <code>entropy.spent</code>. - <code>concept.forest.refine[phase=DEVELOP][rollback=true][law_check=true]@span=forest_dev</code> \u2192 mutate header with rollback token. - <code>time.forest.witness[phase=REFLECT][law_check=true]@span=forest_trace</code> \u2192 capture phase trace + ledger delta.</p>"},{"location":"skills/n-phase-cycle/phase-accountability/#demotion-criteria","title":"Demotion Criteria","text":"<p>An agent may be \"demoted\" (reduced trust, increased oversight) if:</p> <ol> <li>Repeated skip-induced failures (3+ in a session)</li> <li>Skip without declaration (any phase silently ignored)</li> <li>False completion claims (said \"done\" but tests fail)</li> <li>Liability denial (refuses to acknowledge skip consequences)</li> </ol> <p>Demotion is not permanent. Remediation via: - Executing full cycle with explicit trace - Retroactive phase execution for skipped work - Meta-learning entry documenting the failure pattern</p>"},{"location":"skills/n-phase-cycle/phase-accountability/#the-three-phase-escape-valve","title":"The Three-Phase Escape Valve","text":"<p>The three-phase cycle (SENSE\u2192ACT\u2192REFLECT) is a valid compression, not a liability dodge:</p> <ul> <li>SENSE encompasses PLAN, RESEARCH, DEVELOP, STRATEGIZE, CROSS-SYNERGIZE</li> <li>ACT encompasses IMPLEMENT, QA, TEST, EDUCATE</li> <li>REFLECT encompasses MEASURE, REFLECT</li> </ul> <p>Using three-phase is not skipping\u2014it's compressing. The agent is still accountable for the work covered by each macro-phase.</p> <p>Example: If using three-phase and ACT fails due to missing QA, the agent is liable because QA is within ACT's scope.</p>"},{"location":"skills/n-phase-cycle/phase-accountability/#recursive-hologram","title":"Recursive Hologram","text":"<p>This accountability skill applies to itself:</p> <ul> <li>Did you PLAN accountability tracking?</li> <li>Did you RESEARCH prior art on process accountability?</li> <li>Did you DEVELOP the skip protocol?</li> <li>Did you IMPLEMENT the trace format?</li> <li>Did you TEST that traces are captured?</li> <li>Did you REFLECT on whether this protocol is burdensome?</li> </ul>"},{"location":"skills/n-phase-cycle/phase-accountability/#verification","title":"Verification","text":"<ul> <li> Full cycle work has Phase Trace in epilogue</li> <li> Skipped phases have Explicit Skip declaration</li> <li> Risk accepted is specific, not generic</li> <li> Fallback mechanism is named</li> <li> No silent skips (phases missing without declaration)</li> </ul>"},{"location":"skills/n-phase-cycle/phase-accountability/#related-skills","title":"Related Skills","text":"<ul> <li><code>metatheory.md</code> \u2014 Why phases exist</li> <li><code>three-phase.md</code> \u2014 Valid compression</li> <li><code>reflect.md</code> \u2014 Where accountability is assessed</li> <li><code>lookback-revision.md</code> \u2014 Where skip-induced failures are caught</li> <li><code>detach-attach.md</code> \u2014 Handle creation includes trace</li> </ul>"},{"location":"skills/n-phase-cycle/phase-accountability/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Initial version (per user request for accountability protocol).</li> </ul>"},{"location":"skills/n-phase-cycle/plan/","title":"Skill: PLAN (N-Phase Cycle)","text":"<p>Shape intention into composable chunks with explicit constraints and exits.</p> <p>Difficulty: Easy Prerequisites: HYDRATE.md, plans/principles.md, spec/principles.md Files Touched: plans/_focus.md (read-only), plans//.md headers, plans/_forest.md (auto)</p>"},{"location":"skills/n-phase-cycle/plan/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 PLAN | intent + non-goals | exit criteria | attention budget (incl. 0.05\u20130.10 entropy) | ledger.PLAN=touched | next=RESEARCH\n</code></pre></li> <li>Minimal artifacts: scope + non-goals, exit criteria, chunk list, entropy sip + ledger snippet, branch candidates (if any).</li> <li>Signals: log tokens/time/entropy + branch count for <code>process-metrics.md</code>; update <code>phase_ledger</code> + <code>entropy</code> in plan header for <code>_forest.md</code>.</li> <li>Branch check: classify branches per <code>branching-protocol.md</code>; emit handles or bounty entries before exiting.</li> </ul>"},{"location":"skills/n-phase-cycle/plan/#the-boldness-of-plan","title":"The Boldness of PLAN","text":"<p>\"PLAN is not hesitation disguised as preparation. PLAN is decisive framing.\"</p> <p>When you enter PLAN phase, you are not deferring action\u2014you are CHOOSING. The feeling is:</p> <ul> <li>Decisiveness: \"I will do X\" not \"we could consider X\"</li> <li>Commitment: TodoWrite captures the plan as binding intent</li> <li>Parallel reads: Read 5 context files at once, not serially</li> <li>Immediate transition: PLAN exits into RESEARCH within the same session</li> </ul>"},{"location":"skills/n-phase-cycle/plan/#the-plan-manifesto","title":"The PLAN Manifesto","text":"<pre><code>I will choose, not list options.\nI will commit via TodoWrite, not hedge.\nI will read context files in parallel.\nI will exit PLAN into RESEARCH in THIS session.\nI will not confuse planning with permission-seeking.\n</code></pre>"},{"location":"skills/n-phase-cycle/plan/#overview","title":"Overview","text":"<p>PLAN defines the container for the entire cycle: why this work exists, what success looks like, and how attention will be budgeted across the forest. It enforces Tasteful/Curated scope before energy is spent.</p>"},{"location":"skills/n-phase-cycle/plan/#step-by-step-with-action","title":"Step-by-Step (With Action)","text":"<ol> <li> <p>Intake constraints (Parallel reads NOW):    <pre><code>Read(\"plans/_focus.md\")      # In parallel\nRead(\"plans/_forest.md\")     # In parallel\nRead(\"plans/_epilogues/latest.md\")  # In parallel\n</code></pre>    Not: \"You should read these files\"</p> </li> <li> <p>Strategic research (When novel domain):</p> </li> <li>Use <code>WebSearch</code> for domain expertise, frameworks, prior art</li> <li>Example: \"kubernetes operator patterns 2025\", \"OODA loop decision cycle\"</li> <li> <p>Integrate insights into scope definition (don't cargo-cult)</p> </li> <li> <p>Frame scope + exits (Decisive declaration):</p> </li> <li>Write TodoWrite with chunks as PENDING</li> <li>Declare: \"I WILL implement Track A\"</li> <li> <p>Not: \"One option would be Track A\"</p> </li> <li> <p>Chunk and schedule (Commit to parallelization):</p> </li> <li>Identify which chunks can run as parallel agents</li> <li>Mark dependencies explicitly</li> <li>Surface potential branches (see <code>branching-protocol.md</code>)</li> <li>Exit to RESEARCH immediately</li> </ol>"},{"location":"skills/n-phase-cycle/plan/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>Run a micro PLAN\u2192RESEARCH\u2192DEVELOP loop on this plan artifact: What is unknown about the scope? Which specs clarify it? What refinement is needed before others can compose with it?</li> <li>Register the plan as a morphism via <code>meta-skill-operad.md</code> so future mutations are lawful (identity/associativity preserved).</li> </ul>"},{"location":"skills/n-phase-cycle/plan/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>PLAN reserves 5-10% for exploration:</p> <ul> <li>Scope uncertainty: Not all boundaries are clear at the start. Budget for discovery.</li> <li>Alternative framings: The first framing isn't always best. Try 2-3 mental models before committing.</li> <li>Adjacent possibilities: What else could this enable? Note serendipitous connections.</li> <li>Dormant tree reconnaissance: What exists in the forest that might compose with this?</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.07)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/plan/#verification","title":"Verification","text":"<ul> <li>Plan header exists/updated with blockers, exit criteria, and chunking.</li> <li>Accursed Share allocation noted.</li> <li>Next phase questions for RESEARCH are explicit.</li> </ul>"},{"location":"skills/n-phase-cycle/plan/#common-pitfalls","title":"Common Pitfalls","text":"<ul> <li>Scope creep in scope definition: Scope should be explicit non-goals, not just goals. If you can't say what's NOT included, scope is too fuzzy.</li> <li>Missing attention budget: Every plan should allocate percentage attention, including the 5% Accursed Share for exploration.</li> <li>No exit criteria: \"When is this done?\" must be answerable before starting.</li> <li>Monolithic chunking: If a chunk can't be paused mid-way, it's too large. Prefer 1-2 hour chunks with natural stopping points.</li> <li>Ignoring dormant plans: PLAN phase should acknowledge what else exists in the forest, not just the current tree.</li> </ul>"},{"location":"skills/n-phase-cycle/plan/#hand-off","title":"Hand-off","text":"<p>Next: <code>research.md</code> with map targets, unknowns, and files to read.</p>"},{"location":"skills/n-phase-cycle/plan/#continuation-generator","title":"Continuation Generator","text":"<p>Emit this prompt (short, AGENTESE-ready) when exiting PLAN:</p>"},{"location":"skills/n-phase-cycle/plan/#exit-signifier","title":"Exit Signifier","text":"<pre><code># Normal exit (auto-continue):\n\u27ff[RESEARCH]\n/hydrate\nhandles: scope=${scope_summary}; chunks=${chunk_list}; exit=${exit_criteria}; ledger={PLAN:touched}; entropy=${entropy_allocation}; branches=${branch_notes}\nmission: map terrain; find invariants/blockers with file:line; avoid duplication (Curated/Composable/Generative).\nactions: parallel Read(${file_1}, ${file_2}, ${file_3}); rg \"${key_pattern}\"; log metrics.\nexit: file map + blockers + unknowns; ledger.RESEARCH=touched; continuation \u2192 DEVELOP.\n\n# Halt conditions:\n\u27c2[BLOCKED:scope_unclear] Scope needs human clarification before RESEARCH\n\u27c2[ENTROPY_DEPLETED] Budget exhausted without entropy sip\n</code></pre> <p>Template vars: <code>${scope_summary}</code>, <code>${chunk_list}</code>, <code>${exit_criteria}</code>, <code>${entropy_allocation}</code>, <code>${branch_notes}</code>, <code>${file_1,2,3}</code>, <code>${key_pattern}</code>.</p>"},{"location":"skills/n-phase-cycle/plan/#related-skills","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>branching-protocol.md</code> \u2014 Surface new trees at transitions</li> <li><code>phase-accountability.md</code> \u2014 Track phase execution</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../plan-file.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/plan/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added strategic research step and branching reference.</li> <li>2025-12-13: Added Accursed Share section (meta-re-metabolize).</li> <li>2025-12-13: Added Continuation Generator section (auto-continuation).</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/qa/","title":"Skill: QA (N-Phase Cycle)","text":"<p>Gatekeeping for quality, hygiene, and readiness before formal testing.</p> <p>Difficulty: Easy-Medium Prerequisites: <code>implement.md</code>, repo QA standards, HYDRATE gotchas Files Touched: QA checklist, minor fixes in code/docs/tests</p>"},{"location":"skills/n-phase-cycle/qa/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 QA | checks=mypy+ruff+security | ledger.QA=touched | entropy.sip(0.05) | next=TEST\n</code></pre></li> <li>Minimal artifacts: checklist results, security notes, degraded-mode exercise, ledger update, branch/bounty entries for tech debt.</li> <li>Signals: log tokens/time/entropy + law-check status for <code>process-metrics.md</code>.</li> <li>Branch check: emit refactor/infra branches if QA exposes debt.</li> </ul>"},{"location":"skills/n-phase-cycle/qa/#overview","title":"Overview","text":"<p>QA verifies the work is clean, explainable, and reversible. It ensures Transparent Infrastructure and Ethical principles are visible before deeper testing or release.</p>"},{"location":"skills/n-phase-cycle/qa/#step-by-step","title":"Step-by-Step","text":"<ol> <li>Checklist pass: Run lint/mypy/unit tests; check logging clarity, error messages, degraded-mode behavior, and privacy defaults.</li> <li>Narrate intent: Ensure commit/notes explain what changed and why (tasteful, curated).</li> <li>Risk sweep: Identify failure domains, feature flags, rollback plan, and data migration safety.</li> <li>Documentation hygiene: Audit plan files for archival or spec promotion (see below).</li> </ol>"},{"location":"skills/n-phase-cycle/qa/#documentation-hygiene-archiving-gate","title":"Documentation Hygiene (Archiving Gate)","text":"<p>\"Planning docs are scaffolding. Ship them or demolish them.\"</p> <p>Every QA pass must audit associated planning documentation:</p> Check Action if True Plan achieved its goal Archive to <code>plans/_archive/</code> or Promote distilled insights to <code>spec/</code> Plan is &gt;7 days old with &lt;50% progress Re-assess: still relevant? Merge, archive, or re-scope Plan duplicates another plan Merge into single source of truth, archive redundant Plan's insights are spec-worthy Upgrade: distill to <code>spec/</code> or <code>docs/skills/</code>, then archive original <p>The Molasses Test: If a planning doc can't be deleted in 30 days, it's either: - Needed (promote to spec/skill) - Abandoned (archive with reason) - Duplicative (merge and archive)</p> <p>QA Checklist Addition: <pre><code>- [ ] Plans touched during this work: [list]\n- [ ] Archive candidates identified: [list or \"none\"]\n- [ ] Spec promotion candidates: [list or \"none\"]\n</code></pre></p>"},{"location":"skills/n-phase-cycle/qa/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>Apply PLAN\u2192RESEARCH\u2192DEVELOP to the QA checklist itself: are gates still sufficient? any new invariants to add?</li> <li>Use <code>meta-skill-operad.md</code> to mutate the checklist lawfully; preserve identity (baseline gates) and associativity (order-independent checks).</li> </ul>"},{"location":"skills/n-phase-cycle/qa/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>QA's entropy is spent on:</p> <ul> <li>Edge case exploration: Try degraded modes that might fail. That's where bugs hide.</li> <li>Alternative lint rules: Sometimes ruff suggests a refactor. Follow it briefly\u2014it might be right.</li> <li>Graceful degradation paths: Document what happens when dependencies are missing.</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.05)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/qa/#verification","title":"Verification","text":"<ul> <li>QA checklist completed; no silent degradations.  </li> <li>Reversible state recorded; degraded-mode paths exercised.  </li> <li>Ready for focused <code>test.md</code> execution.</li> </ul>"},{"location":"skills/n-phase-cycle/qa/#hand-off","title":"Hand-off","text":"<p>Next: <code>test.md</code> to verify correctness and coverage depth.</p>"},{"location":"skills/n-phase-cycle/qa/#related-skills","title":"Related Skills","text":"<ul> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../test-patterns.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/qa/#continuation-generator","title":"Continuation Generator","text":"<p>Emit this when exiting QA:</p>"},{"location":"skills/n-phase-cycle/qa/#exit-signifier","title":"Exit Signifier","text":"<pre><code># Normal exit (auto-continue):\n\u27ff[TEST]\n/hydrate\nhandles: qa=${qa_checklist_status}; static=${static_analysis_results}; security=${security_notes}; degraded=${degraded_mode_tests}; findings=${qa_findings}; rollback=${rollback_plan}; ledger={QA:touched}; branches=${branch_notes}\nmission: design/run tests that prove grammar + invariants; prefer hotdata; record repros.\nactions: choose strata (unit/property/integration/snapshot); design fixtures; uv run pytest -m \"not slow\" -v.\nexit: tests aligned to risks + ledger.TEST=touched; repro notes captured; continuation \u2192 EDUCATE.\n\n# Halt conditions:\n\u27c2[QA:blocked] mypy/ruff/security errors require resolution before TEST\n\u27c2[BLOCKED:security_issue] Security vulnerability detected; human review required\n\u27c2[ENTROPY_DEPLETED] Budget exhausted without entropy sip\n</code></pre> <p>Template vars: <code>${qa_checklist_status}</code>, <code>${static_analysis_results}</code>, <code>${security_notes}</code>, <code>${degraded_mode_tests}</code>, <code>${qa_findings}</code>, <code>${rollback_plan}</code>, <code>${branch_notes}</code>.</p>"},{"location":"skills/n-phase-cycle/qa/#related-skills_1","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../test-patterns.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/qa/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Accursed Share section (meta-re-metabolize).</li> <li>2025-12-13: Added Continuation Generator section (auto-continuation).</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/reflect/","title":"Skill: REFLECT (N-Phase Cycle)","text":"<p>Synthesize outcomes, extract learnings, and prepare the next loop.</p> <p>Difficulty: Easy Prerequisites: <code>measure.md</code>, epilogues, bounty board signals Files Touched: plans/_epilogues/, plans/meta.md (only if distilled), plans/_bounty.md</p>"},{"location":"skills/n-phase-cycle/reflect/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 REFLECT | outcomes + learnings | ledger.REFLECT=touched | entropy.sip(0.05\u20130.10) | next=PLAN/meta-re-metabolize/DETACH\n</code></pre></li> <li>Minimal artifacts: epilogue, one-line zettels (Molasses Test), bounty updates, continuation decision, ledger update, branch list.</li> <li>Signals: log tokens/time/entropy + branch count + continuation type for <code>process-metrics.md</code>.</li> <li>Branch check: capture new seeds for future cycles; emit handles before exit.</li> </ul>"},{"location":"skills/n-phase-cycle/reflect/#overview","title":"Overview","text":"<p>REFLECT closes the current cycle by distilling what mattered\u2014successes, failures, surprises\u2014and deciding what to re-metabolize. It honors Curated/Tasteful restraint and the Accursed Share (cherish slop before pruning).</p>"},{"location":"skills/n-phase-cycle/reflect/#step-by-step","title":"Step-by-Step","text":"<ol> <li>Summarize outcomes: Capture what shipped, what changed, and remaining risks.</li> <li>Distill learnings: One-line zettels only; promote to <code>plans/meta.md</code> sparingly (pass Molasses Test).</li> <li>Seed next cycle: Write epilogue, open/resolve bounties, and propose entry point for PLAN.</li> <li>Archive or upgrade: Every REFLECT must decide: archive plans, upgrade to spec, or justify retention.</li> </ol>"},{"location":"skills/n-phase-cycle/reflect/#aggressive-archiving-protocol","title":"Aggressive Archiving Protocol","text":"<p>\"The forest must breathe. Dead plans choke new growth.\"</p> <p>REFLECT is the archiving gate. Every cycle that touches plans must end with explicit archiving decisions:</p>"},{"location":"skills/n-phase-cycle/reflect/#the-three-paths-for-every-plan","title":"The Three Paths for Every Plan","text":"Path When Action Archive Goal achieved, superseded, or abandoned Move to <code>plans/_archive/YYYY-MM-DD-{name}.md</code> Upgrade Contains reusable patterns/insights Distill to <code>spec/</code> or <code>docs/skills/</code>, then archive original Retain Active work, clear next steps Update YAML header with current session_notes"},{"location":"skills/n-phase-cycle/reflect/#archiving-criteria-mandatory-check","title":"Archiving Criteria (Mandatory Check)","text":"<pre><code>## REFLECT Archiving Checklist\n\nFor each plan touched this cycle:\n- [ ] **{plan_name}**: [Archive / Upgrade / Retain]\n  - Reason: [goal achieved / superseded by {x} / still active]\n  - If Upgrade: Target spec/skill: [path]\n  - If Retain: Next step: [what]\n\nPlans archived this session: [count]\nPlans upgraded to spec: [count]\n</code></pre>"},{"location":"skills/n-phase-cycle/reflect/#upgrade-to-spec-triggers","title":"Upgrade-to-Spec Triggers","text":"<p>Promote to spec/skill when: - Pattern used 3+ times across plans - Insight applies beyond single feature - Learning is stable (won't change next week)</p>"},{"location":"skills/n-phase-cycle/reflect/#anti-pattern-zombie-plans","title":"Anti-Pattern: Zombie Plans","text":"<p>Zombie detection (check in REFLECT): - Last touched &gt;14 days ago - Progress &lt;25% - No dependencies (nothing blocks on it) - Action: Archive with reason \"zombie: [explanation]\"</p>"},{"location":"skills/n-phase-cycle/reflect/#archive-file-format","title":"Archive File Format","text":"<pre><code># Archived: {original_name}\n\n**Archived**: YYYY-MM-DD\n**Reason**: {goal achieved | superseded | zombie | merged into X}\n**Learnings Preserved**:\n- {one-liner to meta.md if worthy}\n- {or \"none - tactical only\"}\n\n---\n{original content below for archaeology}\n</code></pre>"},{"location":"skills/n-phase-cycle/reflect/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>Mini-cycle the reflection: PLAN (questions), RESEARCH (signals), DEVELOP (insight framing), STRATEGIZE (what to re-metabolize).</li> <li>Use <code>meta-skill-operad.md</code> to make learnings composable morphisms; schedule <code>meta-re-metabolize.md</code> if drift detected.</li> </ul>"},{"location":"skills/n-phase-cycle/reflect/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>REFLECT reserves 5-10% for exploration:</p> <ul> <li>Counterfactual thinking: What if we'd taken the other path? Document the road not taken.</li> <li>Meta-pattern recognition: Is this the third time we've hit this issue? It might be systemic.</li> <li>Gratitude practice: What worked that we didn't expect? Acknowledge the gifts.</li> <li>Skill gap identification: What would have made this easier? That's a future skill to develop.</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.10)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/reflect/#verification","title":"Verification","text":"<ul> <li>Epilogue written; bounties updated; optional meta entry distilled.</li> <li>Clear proposal for next PLAN; Accursed Share acknowledged.</li> <li>Re-metabolization trigger decided.</li> </ul>"},{"location":"skills/n-phase-cycle/reflect/#common-pitfalls","title":"Common Pitfalls","text":"<ul> <li>Skipping reflection entirely: \"No time to reflect\" guarantees repeated mistakes. 10 minutes of REFLECT saves hours in the next cycle.</li> <li>Multi-line meta entries: The Molasses Test: if it can't fit in one line, it's not distilled enough. Refine or move to a plan file.</li> <li>meta.md bloat: Hard cap is 50 lines. If adding your insight requires pruning, either prune something older or your insight isn't atomic.</li> <li>Ignoring the Accursed Share: REFLECT should acknowledge what exploration occurred, even if it led nowhere. Failed experiments are offerings, not waste.</li> <li>Missing next-cycle entry point: Every epilogue should propose where to start next. Don't leave successors guessing.</li> </ul>"},{"location":"skills/n-phase-cycle/reflect/#hand-off","title":"Hand-off","text":"<p>Next: <code>meta-re-metabolize.md</code> when the lifecycle or skills need refresh; otherwise loop back to <code>plan.md</code>.</p>"},{"location":"skills/n-phase-cycle/reflect/#continuation-generator","title":"Continuation Generator","text":"<p>REFLECT is the terminal phase. It generates one of three continuation types.</p>"},{"location":"skills/n-phase-cycle/reflect/#exit-signifiers","title":"Exit Signifiers","text":"<p>REFLECT uses all three signifier modes:</p> <pre><code># Continue to new cycle:\n\u27ff[PLAN]\n/hydrate\nhandles: learnings=${meta_learnings}; artifacts=${artifacts_created}; entropy.restored=${entropy_restored}; ledger={REFLECT:touched}\nmission: frame intent for next body of work; incorporate learnings.\nexit: scope + exit criteria + entropy sip; continuation \u2192 RESEARCH.\n\n# Trigger skill refresh:\n\u27ff[META-RE-METABOLIZE]\n/hydrate\nhandles: drift=${drift_signals}; learnings=${learnings_for_skills}; ledger={REFLECT:touched}\nmission: re-ingest N-phase skills; apply lawful mutations via operad.\nexit: skills refreshed; laws verified; continuation \u2192 PLAN.\n\n# Session end:\n\u27c2[DETACH:cycle_complete] Epilogue: ${epilogue_ref}\n\u27c2[DETACH:awaiting_human] Decision required: ${decision_context}\n</code></pre>"},{"location":"skills/n-phase-cycle/reflect/#detailed-templates","title":"Detailed Templates","text":""},{"location":"skills/n-phase-cycle/reflect/#option-1-loop-to-plan-new-cycle","title":"Option 1: Loop to PLAN (New Cycle)","text":"<pre><code># PLAN: New Cycle after REFLECT\n\n## ATTACH\n\n/hydrate\n\nYou are entering a new N-Phase Cycle (AD-005).\n\nPrevious cycle distilled these learnings:\n- ${meta_learnings}\n\nAccumulated handles from prior cycle:\n- ${artifacts_created}\n\nEntropy restored via tithe: ${entropy_restored}\nPhase ledger to reconcile: ${phase_ledger}\nProcess metrics snapshot: ${metrics_snapshot}\n\n## Your Mission\n\nFrame intent for the next body of work. Incorporate learnings from prior cycle.\n\n**Principles Alignment**:\n- All seven principles from spec/principles.md\n- Special attention to: ${principles_highlighted_by_reflect}\n\n## Questions to Answer\n\n- What is the scope of this new cycle?\n- What can be skipped based on prior learnings?\n- How does forest health inform attention allocation?\n\n## Continuation Imperative\n\nUpon completing PLAN, generate the prompt for RESEARCH.\nThe form is the function.\n</code></pre>"},{"location":"skills/n-phase-cycle/reflect/#option-2-trigger-meta-re-metabolize-skill-refresh","title":"Option 2: Trigger Meta-Re-Metabolize (Skill Refresh)","text":"<pre><code># META-RE-METABOLIZE: Triggered by REFLECT\n\n## ATTACH\n\n/hydrate\n\nREFLECT detected drift or accumulated learnings requiring skill refresh.\n\nDrift signals:\n- ${drift_signals}\n\nLearnings to integrate:\n- ${learnings_for_skills}\nPhase ledger to reconcile: ${phase_ledger}\nProcess metrics snapshot: ${metrics_snapshot}\n\n## Your Mission\n\nRe-ingest the N-phase cycle skills. Apply lawful mutations via meta-skill-operad.md.\n\n**Focus areas**:\n- Continuation Generators: Are they producing effective prompts?\n- Recursive Holograms: Still aligned with full cycle?\n- Verification sections: Exit criteria accurate?\n\n## Actions\n\n1. Read all skills in docs/skills/n-phase-cycle/\n2. Compare against spec/principles.md\n3. Propose mutations as operad morphisms\n4. Preserve Accursed Share in every skill\n\n## Exit Criteria\n\n- All skills contain current Continuation Generator sections\n- Laws (identity/associativity) verified\n- Index updated\n</code></pre>"},{"location":"skills/n-phase-cycle/reflect/#option-3-detach-session-boundary","title":"Option 3: DETACH (Session Boundary)","text":"<pre><code># DETACH: Session End after REFLECT\n\n## Handle Created\n\nThis session is ending. A handle has been created for future ATTACH.\n\n**Epilogue**: plans/_epilogues/${date}-${session}.md\n**Continuation prompt**: prompts/${project}-continuation.md\n\n## Handle Contents\n\nArtifacts created:\n- ${artifacts}\n\nEntropy remaining: ${entropy}\n\nSuggested next tracks:\n- ${suggested_tracks}\nPhase ledger to reconcile: ${phase_ledger}\nProcess metrics snapshot: ${metrics_snapshot}\n\n## For Future Observer\n\nTo continue:\n1. /hydrate\n2. Read the continuation prompt\n3. ATTACH to the track that calls to you\n4. Act from principles with courage\n\n*void.gratitude.tithe. The river flows onward.*\n</code></pre>"},{"location":"skills/n-phase-cycle/reflect/#choosing-the-continuation-type","title":"Choosing the Continuation Type","text":"Condition Generate More work in current scope Loop to PLAN Drift detected or skill staleness Meta-Re-Metabolize Session ending, work incomplete DETACH Cycle complete, scope exhausted DETACH (with \"complete\" status)"},{"location":"skills/n-phase-cycle/reflect/#backward-propagation","title":"Backward Propagation","text":"<p>REFLECT has a unique responsibility: it can refine the generators of prior phases.</p> <p>If REFLECT discovers that PLAN prompts should include something: <pre><code>apply(\n    meta_skill_operad.RefineSection,\n    target=\"plan.md\",\n    section=\"Continuation Generator\",\n    delta=\"Add dependency graph to template variables\"\n)\n</code></pre></p> <p>This is the double-loop from lookback-revision.md made operational.</p>"},{"location":"skills/n-phase-cycle/reflect/#related-skills","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>lookback-revision.md</code></li> <li><code>detach-attach.md</code></li> <li><code>../reconciliation-session.md</code> (if exists)</li> </ul>"},{"location":"skills/n-phase-cycle/reflect/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Accursed Share section (re-metabolize).</li> <li>2025-12-13: Added Continuation Generator section with three options.</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/research/","title":"Skill: RESEARCH (N-Phase Cycle)","text":"<p>Map the landscape, surface constraints, and capture unknowns to de-risk later phases.</p> <p>Difficulty: Medium Prerequisites: <code>plan.md</code>, relevant specs, repo search (<code>rg</code>) habits Files Touched: plans/* (notes), scratch/ or docs/ for findings, no code edits yet</p>"},{"location":"skills/n-phase-cycle/research/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 RESEARCH | targets=${files_mapped_guess} | invariants to hunt | ledger.RESEARCH=touched | entropy.sip(0.05\u20130.10) | next=DEVELOP\n</code></pre></li> <li>Minimal artifacts: file map with refs, blockers (file:line), unknowns + owner, entropy ledger update, branch candidates.</li> <li>Signals: record tokens/time/entropy + law/invariant hits for <code>process-metrics.md</code>; keep ledger + branch notes <code>_forest</code>-ready.</li> <li>Branch check: log blockers that force scope split; emit bounty or branch handle if new tracks appear.</li> </ul>"},{"location":"skills/n-phase-cycle/research/#overview","title":"Overview","text":"<p>RESEARCH reduces entropy by discovering prior art, neighboring agents, and invariants. It honors Composable and Curated principles by preventing redundant or conflicting work.</p>"},{"location":"skills/n-phase-cycle/research/#step-by-step","title":"Step-by-Step","text":"<ol> <li>Target map: From PLAN, list artifacts to inspect (specs, modules, fixtures, skills). Use <code>rg --files</code> to map surfaces.</li> <li>Internet research (when applicable): Use WebSearch for state-of-the-art patterns, established frameworks, or domain expertise. Document findings with source URLs for traceability. See External Knowledge Sourcing below.</li> <li>Extract invariants: Note contracts, functor laws, operad grammars, and hotdata expectations. Record blockers with evidence (file:line).</li> <li>Surface deltas: Identify gaps, risks, or alignment needs (ethics, privacy, taste). Post bounties if friction emerges.</li> </ol>"},{"location":"skills/n-phase-cycle/research/#external-knowledge-sourcing","title":"External Knowledge Sourcing","text":"<p>Internet research is appropriate when:</p> Trigger Example Query Novel domain \"kubernetes operator patterns 2025\" Established frameworks \"OODA loop decision cycle\", \"double-loop learning Argyris\" Library/API usage \"anthropic python SDK streaming\" Performance patterns \"async python memory optimization\" Security considerations \"OWASP top 10 LLM applications\" <p>Protocol: 1. Use <code>WebSearch</code> with specific, focused queries 2. Include the year (2025) for up-to-date results 3. Document sources in notes: <code>[Title](URL) - key insight</code> 4. Synthesize into codebase context (don't cargo-cult) 5. Apply Curated principle: external patterns must earn their place</p> <p>Anti-patterns: - Searching for every implementation detail (use existing patterns first) - Blindly importing external patterns without adaptation - Missing citations (sources enable verification)</p>"},{"location":"skills/n-phase-cycle/research/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>Apply PLAN\u2192RESEARCH\u2192DEVELOP to the research notes themselves: What unanswered questions remain? Which need micro-development (hypotheses) before STRATEGIZE?</li> <li>Thread findings through <code>meta-skill-operad.md</code> to keep notes as composable morphisms (identity = raw citation, composition = stitched trace).</li> </ul>"},{"location":"skills/n-phase-cycle/research/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>RESEARCH reserves 5-10% for exploration:</p> <ul> <li>Tangent following: Sometimes the adjacent file reveals more than the target. Follow interesting threads briefly.</li> <li>External knowledge: Use WebSearch for frameworks or patterns that might inform the work.</li> <li>Alternative mappings: The first file map isn't always complete. Try different grep patterns.</li> <li>Historical archaeology: Check git blame or old PRs\u2014past decisions often explain current structure.</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.07)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/research/#verification","title":"Verification","text":"<ul> <li>File map with references and blockers captured.</li> <li>Unknowns enumerated with owners or resolution paths.</li> <li>No code changes made; knowledge ready for DEVELOP.</li> </ul>"},{"location":"skills/n-phase-cycle/research/#common-pitfalls","title":"Common Pitfalls","text":"<ul> <li>Premature coding: RESEARCH is for mapping, not implementing. If you're writing production code, you've skipped to IMPLEMENT.</li> <li>Shallow search: Using <code>grep</code> once isn't research. Check <code>docs/skills/</code>, specs, and related agent directories.</li> <li>Undocumented blockers: If you find a blocker, write it down with file:line evidence. Verbal \"I saw something\" isn't stigmergic.</li> <li>Missing prior art check: Before adding new code, verify no existing agent/functor already does this. Curated principle: don't duplicate.</li> <li>Analysis paralysis: RESEARCH should have a time-box. If you've been researching for 2+ hours without findings, you're stuck\u2014ask for help or move to DEVELOP with explicit unknowns.</li> </ul>"},{"location":"skills/n-phase-cycle/research/#hand-off","title":"Hand-off","text":"<p>Next: <code>develop.md</code> using gathered invariants to shape APIs/specs.</p>"},{"location":"skills/n-phase-cycle/research/#related-skills","title":"Related Skills","text":"<ul> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../reconciliation-session.md</code> (if exists)</li> </ul>"},{"location":"skills/n-phase-cycle/research/#continuation-generator","title":"Continuation Generator","text":"<p>Emit this when exiting RESEARCH:</p>"},{"location":"skills/n-phase-cycle/research/#exit-signifier","title":"Exit Signifier","text":"<pre><code># Normal exit (auto-continue):\n\u27ff[DEVELOP]\n/hydrate\nhandles: files=${files_mapped}; invariants=${invariants}; blockers=${blockers_with_evidence}; prior_art=${prior_art}; ledger={RESEARCH:touched}; entropy=${entropy_remaining}; branches=${branch_notes}\nmission: choose representations + contracts; capture laws + hotdata expectations; prototype spec examples.\nactions: pick puppet/functor/operad; define inputs/outputs/errors/privacy; note risks; log metrics.\nexit: spec/contract + examples + laws; ledger.DEVELOP=touched; continuation \u2192 STRATEGIZE.\n\n# Halt conditions:\n\u27c2[BLOCKED:prior_art_conflict] Existing implementation conflicts with proposed approach\n\u27c2[BLOCKED:unknown_unresolved] Critical unknown without resolution path\n\u27c2[ENTROPY_DEPLETED] Budget exhausted without entropy sip\n</code></pre> <p>Template vars: <code>${files_mapped}</code>, <code>${invariants}</code>, <code>${blockers_with_evidence}</code>, <code>${prior_art}</code>, <code>${entropy_remaining}</code>, <code>${branch_notes}</code>.</p>"},{"location":"skills/n-phase-cycle/research/#related-skills_1","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../reconciliation-session.md</code> (if exists)</li> </ul>"},{"location":"skills/n-phase-cycle/research/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Accursed Share section (re-metabolize).</li> <li>2025-12-13: Added Continuation Generator section (auto-continuation).</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/scientific-audit/","title":"Scientific Audit: N-Phase Cycle Effectiveness","text":"<p>\"That which can be measured can be improved. That which can be hypothesized can be tested.\"</p> <p>Status: Active Research Document Date: 2025-12-15 Purpose: Evaluate the effectiveness of the N-Phase Cycle + Auto-Continuation meta-system through scientific hypotheses and procedural experiments.</p>"},{"location":"skills/n-phase-cycle/scientific-audit/#executive-summary","title":"Executive Summary","text":"<p>The N-Phase Cycle is a meta-framework for elastic tree/outline building suited to user tastes, project complexity, and substrate constraints. This audit evaluates its effectiveness through:</p> <ol> <li>Hypotheses \u2014 Falsifiable claims about the system</li> <li>Experiments \u2014 Procedural tests to validate/invalidate</li> <li>Metrics \u2014 Quantitative measures of effectiveness</li> <li>Findings \u2014 Observations from system use</li> </ol>"},{"location":"skills/n-phase-cycle/scientific-audit/#hypotheses","title":"Hypotheses","text":""},{"location":"skills/n-phase-cycle/scientific-audit/#h1-elastic-adaptation-reduces-ceremony-overhead","title":"H1: Elastic Adaptation Reduces Ceremony Overhead","text":"<p>Claim: Tasks completed using dynamic phase selection (3\u219411 expansion/compression) require fewer tokens than fixed-sequence execution.</p> <p>Null Hypothesis: There is no significant difference in token consumption between elastic and fixed-sequence execution.</p> <p>Measurement: - Token count per task across matched complexity levels - Ceremony-to-output ratio (tokens spent on phase transitions vs. artifacts)</p> <p>Experiment: E1 (below)</p>"},{"location":"skills/n-phase-cycle/scientific-audit/#h2-serendipitous-branching-improves-discovery","title":"H2: Serendipitous Branching Improves Discovery","text":"<p>Claim: Cycles that use entropy-driven branching (<code>void.entropy.sip</code> \u2192 <code>\u2933[BRANCH]</code>) discover more actionable insights than linear cycles.</p> <p>Null Hypothesis: Branching frequency has no correlation with insight discovery rate.</p> <p>Measurement: - Branches created per cycle - Insights promoted to <code>plans/meta.md</code> per cycle - Bounty items created and claimed</p> <p>Experiment: E2 (below)</p>"},{"location":"skills/n-phase-cycle/scientific-audit/#h3-user-taste-adaptation-increases-satisfaction","title":"H3: User Taste Adaptation Increases Satisfaction","text":"<p>Claim: Agents that adapt tree shape to user preference signals (depth vs. speed vs. exploration) receive higher subjective ratings.</p> <p>Null Hypothesis: Tree shape has no effect on user satisfaction.</p> <p>Measurement: - User preference surveys (pre/post) - Session continuation rates - Explicit feedback (\"this is too slow\" / \"this is too superficial\")</p> <p>Experiment: E3 (below)</p>"},{"location":"skills/n-phase-cycle/scientific-audit/#h4-auto-continuation-reduces-interpretive-gap","title":"H4: Auto-Continuation Reduces Interpretive Gap","text":"<p>Claim: Sessions using auto-inducer signifiers (<code>\u27ff</code>/<code>\u27c2</code>/<code>\u2933</code>) have fewer misaligned transitions than sessions with manual prompt handoff.</p> <p>Null Hypothesis: Auto-continuation does not reduce transition errors.</p> <p>Measurement: - Phase transition coherence (does next phase correctly consume prior output?) - Rework required due to misaligned handoffs - Context loss at session boundaries</p> <p>Experiment: E4 (below)</p>"},{"location":"skills/n-phase-cycle/scientific-audit/#h5-category-laws-preserve-coherence-under-mutation","title":"H5: Category Laws Preserve Coherence Under Mutation","text":"<p>Claim: Tree operations (FORK, JOIN, COMPRESS, EXPAND) that preserve identity and associativity maintain artifact coherence.</p> <p>Null Hypothesis: Law-preserving operations are no more coherent than arbitrary mutations.</p> <p>Measurement: - Test suite pass rate before/after tree mutations - Artifact dependency graph integrity - Merge conflict rate at JOIN operations</p> <p>Experiment: E5 (below)</p>"},{"location":"skills/n-phase-cycle/scientific-audit/#h6-entropy-budget-prevents-premature-optimization","title":"H6: Entropy Budget Prevents Premature Optimization","text":"<p>Claim: Cycles that reserve and spend 5-10% entropy budget produce more diverse solutions than cycles that skip exploration.</p> <p>Null Hypothesis: Entropy budget has no effect on solution diversity.</p> <p>Measurement: - Alternative paths considered per task - Counterfactuals documented - Accursed Share items that later became primary tracks</p> <p>Experiment: E6 (below)</p>"},{"location":"skills/n-phase-cycle/scientific-audit/#experiments","title":"Experiments","text":""},{"location":"skills/n-phase-cycle/scientific-audit/#e1-elastic-vs-fixed-sequence-token-comparison","title":"E1: Elastic vs. Fixed Sequence Token Comparison","text":"<p>Protocol: 1. Select 10 tasks of varying complexity (2 trivial, 4 standard, 4 complex) 2. Execute each task twice:    - Treatment A: Full 11-phase fixed sequence    - Treatment B: Elastic selection (3\u219211 based on signals) 3. Measure:    - Total tokens consumed    - Phases actually executed    - Time to completion    - Artifact quality (external review)</p> <p>Success Criterion: Treatment B uses \u226470% tokens of Treatment A for equivalent quality.</p> <p>Data Collection: <code>plans/_experiments/e1-elastic-vs-fixed/</code></p>"},{"location":"skills/n-phase-cycle/scientific-audit/#e2-branching-frequency-vs-insight-rate","title":"E2: Branching Frequency vs. Insight Rate","text":"<p>Protocol: 1. Track 20 consecutive cycles 2. Record for each cycle:    - Number of <code>\u2933[BRANCH]</code> signals emitted    - Number of insights promoted to meta.md    - Number of bounty items created    - Number of bounty items claimed within 7 days 3. Compute correlation between branching frequency and insight metrics</p> <p>Success Criterion: Pearson r \u2265 0.5 between branching frequency and insight promotion rate.</p> <p>Data Collection: <code>plans/_experiments/e2-branching-insight/</code></p>"},{"location":"skills/n-phase-cycle/scientific-audit/#e3-user-preference-adaptation-survey","title":"E3: User Preference Adaptation Survey","text":"<p>Protocol: 1. Survey users on preferred working style (depth/speed/exploration/certainty) 2. Randomly assign to:    - Treatment A: Adaptive tree shape matching preference    - Treatment B: Fixed tree shape (default 11-phase) 3. After 5 sessions, survey satisfaction and measure:    - Session continuation rate    - Explicit complaints logged    - Self-reported alignment (\"Did the process match your style?\")</p> <p>Success Criterion: Treatment A satisfaction score \u22651.5 standard deviations above Treatment B.</p> <p>Data Collection: <code>plans/_experiments/e3-user-preference/</code></p>"},{"location":"skills/n-phase-cycle/scientific-audit/#e4-auto-continuation-coherence-audit","title":"E4: Auto-Continuation Coherence Audit","text":"<p>Protocol: 1. Review 50 phase transitions (25 auto-induced, 25 manual) 2. Score each transition on:    - Context preservation (0-3): Did all artifacts transfer?    - Intent alignment (0-3): Did next phase address correct goal?    - Rework required (0-3): How much backtracking needed? 3. Compare aggregate scores between groups</p> <p>Success Criterion: Auto-induced transitions score \u226520% higher than manual.</p> <p>Data Collection: <code>plans/_experiments/e4-auto-coherence/</code></p>"},{"location":"skills/n-phase-cycle/scientific-audit/#e5-category-law-preservation-test","title":"E5: Category Law Preservation Test","text":"<p>Protocol: 1. Create a test harness for tree operations (impl/claude/protocols/nphase/tree_ops.py) 2. Define property-based tests:    - Identity: <code>FORK &gt;&gt; JOIN \u2248 Id</code> (on single branch)    - Associativity: <code>(COMPRESS &gt;&gt; EXPAND) &gt;&gt; COMPRESS \u2248 COMPRESS &gt;&gt; (EXPAND &gt;&gt; COMPRESS)</code> 3. Generate 1000 random tree mutations 4. Verify artifact coherence after each mutation</p> <p>Success Criterion: 100% of law-preserving operations maintain coherence; \u226510% of non-law-preserving operations produce incoherence.</p> <p>Data Collection: <code>impl/claude/protocols/nphase/_tests/test_tree_laws.py</code></p>"},{"location":"skills/n-phase-cycle/scientific-audit/#e6-entropy-budget-diversity-analysis","title":"E6: Entropy Budget Diversity Analysis","text":"<p>Protocol: 1. Track 30 cycles, split into:    - Group A: 5-10% entropy budget enforced    - Group B: No explicit entropy budget 2. Measure for each cycle:    - Number of alternative paths considered    - Number of counterfactuals documented    - Number of void.* items later promoted to primary track 3. Compute diversity score = (alternatives + counterfactuals + promotions) / phases</p> <p>Success Criterion: Group A diversity score \u226550% higher than Group B.</p> <p>Data Collection: <code>plans/_experiments/e6-entropy-diversity/</code></p>"},{"location":"skills/n-phase-cycle/scientific-audit/#metrics-dashboard","title":"Metrics Dashboard","text":"Metric Target Current Status Average tokens per standard task \u22645000 TBD Pending Elastic compression ratio \u226530% TBD Pending Branch-to-insight conversion rate \u226520% TBD Pending Auto-continuation coherence score \u22652.5/3 TBD Pending Law preservation rate 100% TBD Pending Entropy-driven diversity score \u22650.5 TBD Pending"},{"location":"skills/n-phase-cycle/scientific-audit/#findings-log","title":"Findings Log","text":""},{"location":"skills/n-phase-cycle/scientific-audit/#2025-12-15-initial-audit","title":"2025-12-15: Initial Audit","text":"<p>Observation: The N-Phase Cycle documentation was strong on theory but weak on elasticity language. The spec emphasized \"N is variable\" but didn't provide mechanisms for dynamic selection.</p> <p>Action: Added Elasticity Principle to <code>spec/protocols/n-phase-cycle.md</code> with: - Dynamic phase selection criteria - Tree operations (FORK, JOIN, COMPRESS, EXPAND) - User/project/substrate adaptation tables</p> <p>Observation: Auto-inducer had only two signifiers (\u27ff/\u27c2), lacking elastic operations.</p> <p>Action: Added third signifier (\u2933) to <code>spec/protocols/auto-inducer.md</code> for: - BRANCH (fork parallel track) - JOIN (merge tracks) - COMPRESS (condense phases) - EXPAND (expand phases) - Serendipity evaluation protocol</p> <p>Next: Implement experiments E1-E6 to validate hypotheses.</p>"},{"location":"skills/n-phase-cycle/scientific-audit/#recursive-hologram","title":"Recursive Hologram","text":"<p>This audit applies the N-Phase Cycle to itself:</p> Phase Action PLAN Define audit scope and hypotheses RESEARCH Read existing documentation DEVELOP Formulate testable hypotheses STRATEGIZE Design experiments CROSS-SYNERGIZE Connect to process-metrics.md IMPLEMENT Write this document, update specs QA Review for internal consistency TEST Run experiments EDUCATE Document findings MEASURE Populate metrics dashboard REFLECT Update hypotheses based on findings"},{"location":"skills/n-phase-cycle/scientific-audit/#related","title":"Related","text":"<ul> <li><code>spec/protocols/n-phase-cycle.md</code> \u2014 Core spec (updated with Elasticity)</li> <li><code>spec/protocols/auto-inducer.md</code> \u2014 Signifier spec (updated with \u2933)</li> <li><code>process-metrics.md</code> \u2014 Metrics collection</li> <li><code>metatheory.md</code> \u2014 Theoretical grounding</li> <li><code>branching-protocol.md</code> \u2014 Branch classification</li> </ul>"},{"location":"skills/n-phase-cycle/scientific-audit/#changelog","title":"Changelog","text":"<ul> <li>2025-12-15: Initial audit. 6 hypotheses, 6 experiments defined. Spec updates completed.</li> </ul>"},{"location":"skills/n-phase-cycle/strategize/","title":"Skill: STRATEGIZE (N-Phase Cycle)","text":"<p>Choose the order of moves that maximizes leverage and resilience.</p> <p>Difficulty: Medium Prerequisites: <code>develop.md</code>, <code>plans/principles.md</code> (attention budgeting) Files Touched: sprint notes, plan chunk sequencing, risk/impact matrix</p>"},{"location":"skills/n-phase-cycle/strategize/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 STRATEGIZE | backlog to order | interfaces/owners | ledger.STRATEGIZE=touched | entropy.sip(0.05) | next=CROSS-SYNERGIZE\n</code></pre></li> <li>Minimal artifacts: ordered backlog with dependencies/owners/checkpoints, parallel track interfaces, metrics to watch, branch decisions logged, ledger updated.</li> <li>Signals: record tokens/time/entropy + branch count + decision gates for <code>process-metrics.md</code>.</li> <li>Branch check: classify and emit handles for parallel/deferred tracks before exiting.</li> </ul>"},{"location":"skills/n-phase-cycle/strategize/#overview","title":"Overview","text":"<p>STRATEGIZE translates design into a path: which chunks land first, what runs in parallel, and how to minimize risk. It aligns with Heterarchical and Transparent Infrastructure principles\u2014leadership is contextual and communication is explicit.</p>"},{"location":"skills/n-phase-cycle/strategize/#step-by-step","title":"Step-by-Step","text":"<ol> <li>Prioritize by leverage: Sequence chunks by impact/effort and dependency graph; reserve Accursed Share buffer.  </li> <li>Parallelize safely: Identify parallel tracks with clear interfaces and ownership (human/agent).  </li> <li>Define signals: Establish checkpoints, metrics to watch early, and decision gates for CROSS-SYNERGIZE and IMPLEMENT.</li> <li>Run an oblique lookback: Execute <code>lookback-revision.md</code> on the strategy to surface frame errors/double-loop shifts before locking the order.</li> </ol>"},{"location":"skills/n-phase-cycle/strategize/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>Mini-cycle the strategy itself: PLAN (goal), RESEARCH (constraints), DEVELOP (ordering), STRATEGIZE (revision).</li> <li>Use <code>meta-skill-operad.md</code> to treat strategy as morphisms; ensure refactors preserve composition (no orphaned chunks).</li> </ul>"},{"location":"skills/n-phase-cycle/strategize/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>STRATEGIZE reserves 5-10% for exploration:</p> <ul> <li>Order experiments: Try reverse order or random order\u2014sometimes dependencies reveal themselves.</li> <li>Risk probing: What's the scariest chunk? Consider doing it first to de-risk early.</li> <li>Parallel discovery: Which chunks are secretly independent? Parallelization often hides.</li> <li>Abort criteria: What would make us stop this track entirely? Name it now.</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.05)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/strategize/#verification","title":"Verification","text":"<ul> <li>Ordered backlog with owners, dependencies, and checkpoints.  </li> <li>Parallel tracks identified with interfaces.  </li> <li>Ready to discover combinations in CROSS-SYNERGIZE.</li> </ul>"},{"location":"skills/n-phase-cycle/strategize/#hand-off","title":"Hand-off","text":"<p>Next: <code>cross-synergize.md</code> to explore compositions and entanglements.</p>"},{"location":"skills/n-phase-cycle/strategize/#related-skills","title":"Related Skills","text":"<ul> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>lookback-revision.md</code></li> <li><code>../plan-file.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/strategize/#continuation-generator","title":"Continuation Generator","text":"<p>Emit this when exiting STRATEGIZE:</p>"},{"location":"skills/n-phase-cycle/strategize/#exit-signifier","title":"Exit Signifier","text":"<pre><code># Normal exit (auto-continue):\n\u27ff[CROSS-SYNERGIZE]\n/hydrate\nhandles: backlog=${ordered_chunks}; parallel=${parallel_tracks}; checkpoints=${checkpoints}; gates=${decision_gates}; interfaces=${track_interfaces}; ledger={STRATEGIZE:touched}; branches=${branch_notes}\nmission: hunt compositions/entanglements; probe with hotdata; select law-abiding pipelines.\nactions: enumerate morphisms; micro-prototype with fixtures; test identity/associativity.\nexit: chosen comps + rationale; rejected paths noted; ledger.CROSS-SYNERGIZE=touched; continuation \u2192 IMPLEMENT.\n\n# Halt conditions:\n\u27c2[BLOCKED:dependency_cycle] Circular dependencies detected in backlog ordering\n\u27c2[BLOCKED:no_safe_order] Cannot find ordering that satisfies all constraints\n\u27c2[ENTROPY_DEPLETED] Budget exhausted without entropy sip\n</code></pre> <p>Template vars: <code>${ordered_chunks}</code>, <code>${parallel_tracks}</code>, <code>${checkpoints}</code>, <code>${decision_gates}</code>, <code>${track_interfaces}</code>, <code>${branch_notes}</code>.</p>"},{"location":"skills/n-phase-cycle/strategize/#related-skills_1","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>lookback-revision.md</code></li> <li><code>../plan-file.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/strategize/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Accursed Share section (re-metabolize).</li> <li>2025-12-13: Added Continuation Generator section (auto-continuation).</li> <li>2025-12-13: Initial version.</li> </ul>"},{"location":"skills/n-phase-cycle/test/","title":"Skill: TEST (N-Phase Cycle)","text":"<p>Verify correctness, coverage, and lawfulness with intentional depth.</p> <p>Difficulty: Medium Prerequisites: <code>qa.md</code>, <code>test-patterns.md</code>, relevant fixtures/hotdata Files Touched: tests/*, fixtures/hotdata, coverage configs</p>"},{"location":"skills/n-phase-cycle/test/#quick-wield","title":"Quick Wield","text":"<ul> <li>Snap prompt: <pre><code>/hydrate \u2192 TEST | strata + fixtures | ledger.TEST=touched | entropy.sip(0.05\u20130.10) | next=EDUCATE\n</code></pre></li> <li>Minimal artifacts: selected strata, fixtures/hotdata, test results + repros, ledger update, branch/bounty entries for gaps.</li> <li>Signals: log tokens/time/entropy + law-check results for <code>process-metrics.md</code>.</li> <li>Branch check: if tests expose API inconsistencies or new work, emit branches before exiting.</li> </ul>"},{"location":"skills/n-phase-cycle/test/#overview","title":"Overview","text":"<p>TEST executes targeted suites to confirm laws, behaviors, and regressions. It operationalizes Composable and Generative principles\u2014tests prove the grammar, not just instances.</p>"},{"location":"skills/n-phase-cycle/test/#step-by-step","title":"Step-by-Step","text":"<ol> <li>Select strata: Unit \u2192 property \u2192 integration \u2192 snapshot (prefer hotdata). Emphasize law checks (identity, associativity, operad closure).</li> <li>Design fixtures: Use pre-computed richness; avoid synthetic stubs unless isolated.</li> <li>Run + triage: Execute focused markers first (<code>-m \"not slow\"</code>), then broader; log failures with repro commands and suspected invariants.</li> <li>Test doc alignment: Ensure test documentation matches spec; flag plan drift for archival.</li> </ol>"},{"location":"skills/n-phase-cycle/test/#test-doc-reconciliation","title":"Test-Doc Reconciliation","text":"<p>\"If tests prove the behavior, specs should capture it. Plans become redundant.\"</p> <p>During TEST phase, reconcile documentation:</p> If Tests Prove... Then... Feature works as designed Plan can be archived; insights go to spec/skill Feature differs from plan Update spec, then archive outdated plan Feature requires new patterns Create skill doc, then archive plan <p>TEST Phase Doc Checklist: <pre><code>- [ ] Tests cover the plan's claimed behavior\n- [ ] Spec accurately describes tested behavior\n- [ ] Plan is now redundant: [yes/no]\n- [ ] If yes, archive candidate: [path]\n</code></pre></p> <p>Upgrade Path: Test \u2192 passes \u2192 spec captures behavior \u2192 plan archives \u2192 forest shrinks.</p>"},{"location":"skills/n-phase-cycle/test/#recursive-hologram","title":"Recursive Hologram","text":"<ul> <li>Mini-cycle the suite: PLAN (coverage goals), RESEARCH (gaps), DEVELOP (cases), STRATEGIZE (order), TEST (run).</li> <li>Register new laws/fixtures via <code>meta-skill-operad.md</code> so future mutations remain composable.</li> </ul>"},{"location":"skills/n-phase-cycle/test/#accursed-share-entropy-budget","title":"Accursed Share (Entropy Budget)","text":"<p>TEST reserves 5-10% for exploration:</p> <ul> <li>Property test intuition: What invariants feel true? Write a hypothesis even if coverage isn't required.</li> <li>Mutation testing: Manually break the code\u2014does the test catch it? If not, the test is weak.</li> <li>Hotdata discovery: Is there real-world data that could replace synthetic fixtures?</li> <li>Flaky investigation: If a test is flaky, spend entropy understanding why before marking it slow.</li> </ul> <p>Draw: <code>void.entropy.sip(amount=0.05)</code> Return unused: <code>void.entropy.pour</code></p>"},{"location":"skills/n-phase-cycle/test/#verification","title":"Verification","text":"<ul> <li>Tests pass with coverage aligned to risks.</li> <li>Law checks present for new morphisms.</li> <li>Repro notes captured for any flaky/slow cases.</li> </ul>"},{"location":"skills/n-phase-cycle/test/#common-pitfalls","title":"Common Pitfalls","text":"<ul> <li>Synthetic stubs over hotdata: Per AD-004, use pre-computed LLM outputs. Synthetic data misses the soul.</li> <li>Testing instances, not grammar: Good tests verify laws (identity, associativity). Bad tests check specific strings.</li> <li>Ignoring flaky tests: A flaky test is a test that sometimes lies. Fix or delete, never ignore.</li> <li>Missing law checks: Every new agent/morphism needs identity and associativity tests. Category laws are not optional.</li> <li>Coverage theater: 100% line coverage means nothing if you're not testing invariants. Prefer property-based testing.</li> <li>Slow tests in fast path: Mark slow tests with <code>@pytest.mark.slow</code>. Default runs should complete in &lt;30s.</li> </ul>"},{"location":"skills/n-phase-cycle/test/#hand-off","title":"Hand-off","text":"<p>Next: <code>educate.md</code> to translate validated behavior into guidance.</p>"},{"location":"skills/n-phase-cycle/test/#related-skills","title":"Related Skills","text":"<ul> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../test-patterns.md</code>, <code>../hotdata-pattern.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/test/#continuation-generator","title":"Continuation Generator","text":"<p>Emit this when exiting TEST:</p>"},{"location":"skills/n-phase-cycle/test/#exit-signifier","title":"Exit Signifier","text":"<pre><code># Normal exit (auto-continue):\n\u27ff[EDUCATE]\n/hydrate\nhandles: results=${test_results_summary}; coverage=${coverage_summary}; laws=${law_check_results}; flaky=${flaky_notes}; findings=${test_findings}; repro=${repro_commands}; ledger={TEST:touched}; branches=${branch_notes}\nmission: translate validated behavior into guidance; keep AGENTESE handles explicit; include degraded paths.\nactions: map audiences; update docs/prompts/quickstarts with runnable examples + hotdata; add repro commands.\nexit: docs/prompts updated or skip debt declared; ledger.EDUCATE=touched; continuation \u2192 MEASURE.\n\n# Halt conditions:\n\u27c2[TEST:blocked] Test failures require resolution before EDUCATE\n\u27c2[BLOCKED:law_violation] Law checks failed; composition broken\n\u27c2[ENTROPY_DEPLETED] Budget exhausted without entropy sip\n</code></pre> <p>Template vars: <code>${test_results_summary}</code>, <code>${coverage_summary}</code>, <code>${law_check_results}</code>, <code>${flaky_notes}</code>, <code>${test_findings}</code>, <code>${repro_commands}</code>, <code>${branch_notes}</code>.</p>"},{"location":"skills/n-phase-cycle/test/#related-skills_1","title":"Related Skills","text":"<ul> <li><code>auto-continuation.md</code> \u2014 The meta-skill defining this generator pattern</li> <li><code>meta-skill-operad.md</code></li> <li><code>meta-re-metabolize.md</code></li> <li><code>../test-patterns.md</code>, <code>../hotdata-pattern.md</code></li> </ul>"},{"location":"skills/n-phase-cycle/test/#changelog","title":"Changelog","text":"<ul> <li>2025-12-13: Added Accursed Share section (re-metabolize).</li> <li>2025-12-13: Added Continuation Generator section (auto-continuation).</li> <li>2025-12-13: Initial version.</li> </ul>"}]}