{"config":{"lang":["en"],"separator":"[\\s\\-,:!=\\[\\]()\"/]+|(?!\\b)(?=[A-Z][a-z])|\\.(?!\\d)|&[lg]t;","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"HYDRATE/","title":"HYDRATE.md \u2014 Terminal Integration Learnings","text":"<p>Synthesized from tmux mouse event audit (2025-12-19)</p>"},{"location":"HYDRATE/#the-problem-tmux-raw-mode-event-storm","title":"The Problem: Tmux + Raw Mode = Event Storm","text":"<p>When attaching to a tmux session while raw mode is active: 1. Tmux mouse events arrive as escape sequences (<code>\\033[M...</code> or <code>\\033[&lt;...M</code>) 2. <code>sys.stdin.read(1)</code> reads one byte at a time 3. Multi-byte sequences fragment into garbage 4. Each byte triggers key handlers with invalid input 5. If events stream to chat, garbage floods the UI</p>"},{"location":"HYDRATE/#root-cause-analysis","title":"Root Cause Analysis","text":""},{"location":"HYDRATE/#critical-files","title":"Critical Files","text":"File Line Vulnerability <code>agents/i/tui.py</code> 420 <code>sys.stdin.read(1)</code> fragments mouse sequences <code>agents/i/tui.py</code> 432 <code>tty.setraw()</code> without mouse disable <code>protocols/cli/repl.py</code> 2017 <code>_get_key_nonblocking()</code> same 1-byte issue <code>protocols/cli/repl.py</code> 2222 Raw mode without mouse protocol disable"},{"location":"HYDRATE/#why-1-byte-reads-fail","title":"Why 1-Byte Reads Fail","text":"<pre><code>Mouse click = \"\\033[M abc\" (6 bytes minimum)\nRead(1) \u2192 \\033 (processed as escape? partial?)\nRead(1) \u2192 [ (processed as bracket? garbage?)\nRead(1) \u2192 M (processed as 'M' key!)\n...\n</code></pre> <p>Each byte processed independently = 6+ spurious \"key presses\" per mouse click.</p>"},{"location":"HYDRATE/#the-fix-three-part-defense","title":"The Fix: Three-Part Defense","text":""},{"location":"HYDRATE/#1-disable-mouse-before-raw-mode","title":"1. Disable Mouse Before Raw Mode","text":"<pre><code># BEFORE entering raw mode:\nprint(\"\\033[?1000l\", end=\"\", flush=True)  # Disable X10 mouse\nprint(\"\\033[?1002l\", end=\"\", flush=True)  # Disable button tracking\nprint(\"\\033[?1003l\", end=\"\", flush=True)  # Disable all motion\nprint(\"\\033[?1006l\", end=\"\", flush=True)  # Disable SGR extended\n\ntty.setraw(sys.stdin.fileno())\n\n# AFTER restoring:\ntermios.tcsetattr(sys.stdin, termios.TCSADRAIN, old_settings)\n# Re-enable mouse if needed by parent (tmux handles this)\n</code></pre>"},{"location":"HYDRATE/#2-read-complete-escape-sequences","title":"2. Read Complete Escape Sequences","text":"<pre><code>def _get_key_complete() -&gt; Optional[str]:\n    \"\"\"Read complete key or escape sequence (non-blocking).\"\"\"\n    import select\n\n    if not select.select([sys.stdin], [], [], 0.0)[0]:\n        return None\n\n    char = sys.stdin.read(1)\n\n    # Not escape? Return single char\n    if char != '\\033':\n        return char\n\n    # Escape sequence: read until terminator or timeout\n    seq = char\n    for _ in range(10):  # Max 10 chars for safety\n        if select.select([sys.stdin], [], [], 0.01)[0]:\n            next_char = sys.stdin.read(1)\n            seq += next_char\n            # CSI sequences terminate on letter\n            if next_char.isalpha():\n                break\n        else:\n            break  # No more input\n\n    return seq\n</code></pre>"},{"location":"HYDRATE/#3-validate-before-processing","title":"3. Validate Before Processing","text":"<pre><code>VALID_KEYS = set('hjklq?:r')  # Known commands\nESCAPE_SEQUENCES = {\n    '\\033[A': 'up',\n    '\\033[B': 'down',\n    '\\033[C': 'right',\n    '\\033[D': 'left',\n}\n\ndef _handle_key(key: str, state) -&gt; bool:\n    \"\"\"Handle key with validation.\"\"\"\n    # Known single key?\n    if key in VALID_KEYS:\n        return _process_command(key, state)\n\n    # Known escape sequence?\n    if key in ESCAPE_SEQUENCES:\n        return _process_arrow(ESCAPE_SEQUENCES[key], state)\n\n    # Mouse event? Ignore silently\n    if key.startswith('\\033[M') or key.startswith('\\033[&lt;'):\n        return False  # Swallow mouse, don't propagate\n\n    # Unknown: log and ignore\n    logger.debug(f\"Ignored: {repr(key)}\")\n    return False\n</code></pre>"},{"location":"HYDRATE/#user-workaround-immediate","title":"User Workaround (Immediate)","text":"<p>If experiencing mouse event storms in tmux:</p> <pre><code># Option 1: Disable tmux mouse entirely\ntmux set-option -g mouse off\n\n# Option 2: In ~/.tmux.conf (permanent)\nset-option -g mouse off\n\n# Option 3: Detach/reattach after disabling\ntmux set-option -g mouse off\n# Ctrl-B d (detach), then tmux attach\n</code></pre>"},{"location":"HYDRATE/#architecture-insight","title":"Architecture Insight","text":"<p>The TerminalService (web) doesn't have this problem because: 1. Browser handles input events natively 2. No raw mode needed 3. Terminal input is via React controlled input</p> <p>The problem is CLI-only in: - <code>agents/i/tui.py</code> (I-gent TUI) - <code>protocols/cli/repl.py</code> (ambient mode)</p>"},{"location":"HYDRATE/#related-systems","title":"Related Systems","text":"System Uses Raw Mode Mouse Risk I-gent TUI Yes (<code>tui.py:432</code>) HIGH REPL ambient Yes (<code>repl.py:2222</code>) HIGH Web Shell No (browser) NONE Reflector No (output only) NONE SSE streaming No (server \u2192 client) NONE"},{"location":"HYDRATE/#testing-checklist","title":"Testing Checklist","text":"<pre><code># Test 1: Tmux mouse event handling\ntmux new-session -d -s test\ntmux send-keys -t test \"cd impl/claude &amp;&amp; python -c \\\"import tty, sys, termios; old=termios.tcgetattr(sys.stdin); tty.setraw(sys.stdin.fileno()); print('raw mode'); termios.tcsetattr(sys.stdin, termios.TCSADRAIN, old)\\\"\" Enter\ntmux attach -t test\n# Move mouse - should NOT flood with garbage\n\n# Test 2: Escape sequence validation\npython -c \"\nkey = '\\033[M abc'  # Mouse event\nvalid = key in {'h','j','k','l','q'}\nprint(f'Valid key: {valid}')  # Should be False\n\"\n\n# Test 3: Complete sequence reading\necho -e '\\033[Mtest' | python -c \"\nimport sys\ndata = sys.stdin.read()\nprint(f'Received {len(data)} chars: {repr(data)}')\"\n</code></pre>"},{"location":"HYDRATE/#pattern-terminal-discipline","title":"Pattern: Terminal Discipline","text":"<p>Entering raw mode is a contract: 1. Save terminal state (<code>termios.tcgetattr</code>) 2. Disable unwanted protocols (mouse, bracketed paste) 3. Set raw mode 4. Read complete sequences (not byte-by-byte) 5. Validate before processing 6. Restore terminal state in <code>finally</code></p> <p>Lines: 140. Topic: Terminal/Tmux integration. Audit date: 2025-12-19</p>"},{"location":"architecture-overview/","title":"Architecture Overview","text":"<p>\"Agents are morphisms. Functors lift them. Polynomials generalize them. Operads compose them.\"</p> <p>This document provides a comprehensive overview of the kgents architecture.</p>"},{"location":"architecture-overview/#table-of-contents","title":"Table of Contents","text":"<ol> <li>The Three Pillars</li> <li>Agent Categories</li> <li>The Functor System</li> <li>Polynomial Architecture</li> <li>The Meta-Construction System</li> <li>Agent Synergy Patterns</li> <li>AGENTESE Runtime</li> <li>Infrastructure Layer</li> <li>Metabolism (Entropy System)</li> <li>Directory Structure</li> <li>Architectural Decisions</li> </ol>"},{"location":"architecture-overview/#the-three-pillars","title":"The Three Pillars","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        THE ALETHIC TRIAD                         \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502     NUCLEUS     \u2502      HALO       \u2502         PROJECTOR           \u2502\n\u2502   Pure Logic    \u2502  Capabilities   \u2502    Categorical Compiler     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Agent[A, B]     \u2502 @Stateful       \u2502 LocalProjector              \u2502\n\u2502 invoke(a) \u2192 b   \u2502 @Soulful        \u2502 K8sProjector                \u2502\n\u2502                 \u2502 @Observable     \u2502                             \u2502\n\u2502                 \u2502 @Streamable     \u2502                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture-overview/#1-nucleus-pure-logic","title":"1. Nucleus (Pure Logic)","text":"<p>The irreducible transform. Every agent has a nucleus\u2014the <code>invoke(a) \u2192 b</code> function that defines what it does.</p>"},{"location":"architecture-overview/#2-halo-capabilities","title":"2. Halo (Capabilities)","text":"<p>Declared capabilities that wrap the nucleus. Decorators like <code>@Stateful</code>, <code>@Soulful</code>, <code>@Observable</code>, <code>@Streamable</code> declare what the agent needs without implementing it.</p>"},{"location":"architecture-overview/#3-projector-compiler","title":"3. Projector (Compiler)","text":"<p>The categorical compiler that makes potential actual. Takes Halo declarations and compiles them to runnable code (LocalProjector) or K8s manifests (K8sProjector).</p>"},{"location":"architecture-overview/#agent-categories","title":"Agent Categories","text":""},{"location":"architecture-overview/#by-capability-archetypes","title":"By Capability (Archetypes)","text":"Archetype Capabilities Use Case Kappa All 4 Production services Lambda Observable only Lightweight processors Delta Stateful + Observable Data handlers"},{"location":"architecture-overview/#by-function-genera","title":"By Function (Genera)","text":"Genus Letter Role Polynomial Alethic A Architecture, functors <code>ALETHIC_AGENT</code> Category C Composition primitives \u2014 Data D State, memory <code>MEMORY_POLYNOMIAL</code> Evolution E Thermodynamic optimization <code>EVOLUTION_POLYNOMIAL</code> Flux Flux Streams, events \u2014 Interface I TUI, semantic fields \u2014 Kent K Persona, governance <code>SOUL_POLYNOMIAL</code> Lattice L Semantic registry \u2014 Testing T Types I-V \u2014 Utility U Tools, MCP \u2014"},{"location":"architecture-overview/#the-functor-system","title":"The Functor System","text":""},{"location":"architecture-overview/#universal-functor-protocol-ad-001","title":"Universal Functor Protocol (AD-001)","text":"<p>Every transformation in kgents is a functor:</p> <pre><code>class UniversalFunctor(Generic[F]):\n    @staticmethod\n    def lift(agent: Agent[A, B]) -&gt; Agent[F[A], F[B]]: ...\n</code></pre>"},{"location":"architecture-overview/#built-in-functors","title":"Built-in Functors","text":"Functor Effect Use Case <code>Maybe</code> Handle optional values Nullable results <code>Either</code> Handle success/error Error propagation <code>List</code> Process collections Batch operations <code>Fix</code> Add retries Resilience <code>Logged</code> Add observability Debugging <code>Soul</code> Add K-gent governance Ethical alignment <code>Flux</code> Enable streaming Real-time processing <code>Observer</code> Add telemetry Monitoring <code>State</code> Add memory Stateful computation"},{"location":"architecture-overview/#functor-composition","title":"Functor Composition","text":"<p>Functors compose into stacks:</p> <pre><code>stack = compose_functors(LoggedFunctor, FixFunctor, SoulFunctor)\nresilient_agent = stack(my_agent)\n</code></pre>"},{"location":"architecture-overview/#polynomial-architecture","title":"Polynomial Architecture","text":"<p>\"Agent[A, B] \u2245 A \u2192 B is a lie. Real agents have modes.\"</p> <p>The polynomial functor architecture (AD-002) captures state-dependent behavior\u2014agents that accept different inputs based on their internal state.</p>"},{"location":"architecture-overview/#the-core-insight","title":"The Core Insight","text":"<p>Traditional agents are functions: given input A, produce output B. But real agents have modes\u2014internal states that determine what inputs are valid and how to respond.</p> <pre><code>Traditional:  Agent[A, B] \u2245 A \u2192 B           (stateless function)\nPolynomial:   PolyAgent[S, A, B] \u2245 S \u2192 (A \u2192 (S, B))  (state machine)\n</code></pre>"},{"location":"architecture-overview/#polyagent-protocol","title":"PolyAgent Protocol","text":"<pre><code>@dataclass(frozen=True)\nclass PolyAgent(Generic[S, A, B]):\n    \"\"\"\n    Agent as polynomial functor.\n\n    P(y) = \u03a3_{s \u2208 positions} y^{directions(s)}\n\n    Following Spivak's \"Polynomial Functors: A Mathematical Theory of Interaction\"\n    \"\"\"\n    name: str\n    positions: FrozenSet[S]                    # Valid states (modes)\n    directions: Callable[[S], FrozenSet[A]]    # State-dependent valid inputs\n    transition: Callable[[S, A], tuple[S, B]]  # State \u00d7 Input \u2192 (NewState, Output)\n\n    def invoke(self, state: S, input: A) -&gt; tuple[S, B]:\n        \"\"\"Execute one step of the dynamical system.\"\"\"\n        assert state in self.positions\n        assert input in self.directions(state)\n        return self.transition(state, input)\n</code></pre> <p>Key insight: <code>Agent[A, B] \u2245 PolyAgent[Unit, A, B]</code>\u2014traditional agents embed as single-state polynomials.</p>"},{"location":"architecture-overview/#polynomial-agent-genera","title":"Polynomial Agent Genera","text":"Genus Polynomial States Description A-gent <code>ALETHIC_AGENT</code> GROUNDING \u2192 DELIBERATING \u2192 JUDGING \u2192 SYNTHESIZING Dialectical reasoning pipeline K-gent <code>SOUL_POLYNOMIAL</code> 7 eigenvector contexts Persona-informed governance D-gent <code>MEMORY_POLYNOMIAL</code> IDLE, LOADING, STORING, QUERYING, FORGETTING State persistence E-gent <code>EVOLUTION_POLYNOMIAL</code> 8-phase thermodynamic cycle Evolutionary optimization"},{"location":"architecture-overview/#example-k-gent-as-polynomial","title":"Example: K-gent as Polynomial","text":"<pre><code>SOUL_POLYNOMIAL = PolyAgent(\n    name=\"SoulPolynomial\",\n    positions=frozenset({\n        \"aesthetic\", \"categorical\", \"gratitude\",\n        \"heterarchy\", \"generativity\", \"joy\", \"ethics\"\n    }),\n    directions=lambda mode: {\n        \"aesthetic\": frozenset({AestheticQuery, TasteChallenge}),\n        \"categorical\": frozenset({StructureQuery, MorphismRequest}),\n        \"gratitude\": frozenset({TitheRequest, AppreciationQuery}),\n        # ... per-mode valid inputs\n    }[mode],\n    transition=soul_transition\n)\n</code></pre>"},{"location":"architecture-overview/#composition-via-wiring-diagrams","title":"Composition via Wiring Diagrams","text":"<p>Polynomial agents compose via wiring diagrams\u2014graphical representations of how outputs connect to inputs:</p> <pre><code>from agents.poly import sequential, parallel, WiringDiagram\n\n# Sequential: soul \u2192 alethic\ncomposed = sequential(SOUL_POLYNOMIAL, ALETHIC_AGENT)\n\n# Parallel: run soul and memory concurrently\npar = parallel(SOUL_POLYNOMIAL, MEMORY_POLYNOMIAL)\n\n# Complex wiring\ndiagram = WiringDiagram()\ndiagram.add_box(\"soul\", SOUL_POLYNOMIAL)\ndiagram.add_box(\"memory\", MEMORY_POLYNOMIAL)\ndiagram.wire(\"soul.output\", \"memory.input\")\ncomposed = diagram.compile()\n</code></pre>"},{"location":"architecture-overview/#the-meta-construction-system","title":"The Meta-Construction System","text":"<p>\"Don't build agents. Build the machine that builds agents.\"</p> <p>The meta-construction system (AD-003) replaces enumeration with generation. Instead of listing 600+ CLI commands, we define the grammar that generates them.</p>"},{"location":"architecture-overview/#the-three-layers","title":"The Three Layers","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     META-CONSTRUCTION SYSTEM                             \u2502\n\u2502                                                                          \u2502\n\u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                     \u2502\n\u2502    \u2502PRIMITIVES\u2502  +   \u2502 OPERADS  \u2502  +   \u2502 SHEAVES  \u2502  =  EMERGENCE       \u2502\n\u2502    \u2502(atoms)   \u2502      \u2502(grammar) \u2502      \u2502(gluing)  \u2502                     \u2502\n\u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                     \u2502\n\u2502         \u2502                 \u2502                 \u2502                            \u2502\n\u2502         \u25bc                 \u25bc                 \u25bc                            \u2502\n\u2502    Base agents      Composition       Local \u2192 Global                    \u2502\n\u2502    Types            rules             behavior                           \u2502\n\u2502    Operations       Wiring            Emergence                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture-overview/#layer-1-primitives-13-atoms","title":"Layer 1: Primitives (13 Atoms)","text":"<p>The irreducible polynomial agents from which all others compose:</p> Primitive Category Purpose <code>id</code> Bootstrap Identity morphism <code>ground</code> Bootstrap Reality anchoring <code>judge</code> Bootstrap Evaluation <code>contradict</code> Bootstrap Find tensions <code>sublate</code> Bootstrap Hegelian synthesis <code>compose</code> Bootstrap Sequential composition <code>fix</code> Bootstrap Retry/recursion <code>manifest</code> Perception Observer-dependent projection <code>witness</code> Perception Trace recording <code>lens</code> Perception Focus/selection <code>sip</code> Entropy Draw from Accursed Share <code>tithe</code> Entropy Pay for order <code>define</code> Entropy Autopoiesis"},{"location":"architecture-overview/#layer-2-operads-composition-grammar","title":"Layer 2: Operads (Composition Grammar)","text":"<p>Operads define what compositions are valid:</p> <pre><code>AGENT_OPERAD = Operad(\n    name=\"AgentOperad\",\n    operations={\n        \"seq\": Operation(arity=2, signature=\"Agent[A,B] \u00d7 Agent[B,C] \u2192 Agent[A,C]\"),\n        \"par\": Operation(arity=2, signature=\"Agent[A,B] \u00d7 Agent[A,C] \u2192 Agent[A,(B,C)]\"),\n        \"branch\": Operation(arity=3, signature=\"Pred[A] \u00d7 Agent[A,B] \u00d7 Agent[A,B] \u2192 Agent[A,B]\"),\n        \"fix\": Operation(arity=2, signature=\"Pred[B] \u00d7 Agent[A,B] \u2192 Agent[A,B]\"),\n        \"trace\": Operation(arity=1, signature=\"Agent[A,B] \u2192 Agent[A,B] (with observation)\"),\n    },\n    laws=[\n        \"seq(seq(a, b), c) = seq(a, seq(b, c))\",  # Associativity\n        \"seq(id, a) = a = seq(a, id)\",             # Identity\n    ]\n)\n</code></pre> <p>Domain-specific operads extend the base:</p> <pre><code>SOUL_OPERAD = Operad(\n    name=\"SoulOperad\",\n    operations=AGENT_OPERAD.operations | {\n        \"introspect\": Operation(arity=0, compose=introspect_compose),\n        \"shadow\": Operation(arity=1, compose=shadow_compose),\n        \"dialectic\": Operation(arity=2, compose=dialectic_compose),\n    }\n)\n</code></pre>"},{"location":"architecture-overview/#layer-3-sheaves-emergence","title":"Layer 3: Sheaves (Emergence)","text":"<p>Sheaves enable gluing local behaviors into global behavior:</p> <pre><code>SOUL_SHEAF = AgentSheaf(\n    contexts={\"aesthetic\", \"categorical\", \"gratitude\", \"heterarchy\", \"generativity\", \"joy\"},\n    overlap=eigenvector_overlap\n)\n\n# Local agents per context\nlocal_souls = {\n    \"aesthetic\": aesthetic_soul_agent,\n    \"categorical\": categorical_soul_agent,\n    \"joy\": joy_soul_agent,\n}\n\n# Glue into emergent global soul\nKENT_SOUL = SOUL_SHEAF.glue(local_souls)\n</code></pre> <p>The global agent has emergent behavior that no local agent has alone.</p>"},{"location":"architecture-overview/#the-two-paths","title":"The Two Paths","text":"<p>Both careful design and chaotic happenstance produce valid compositions:</p> <pre><code># Path 1: Careful Design (intentional)\npipeline = SOUL_OPERAD.compose([\"ground\", \"introspect\", \"shadow\", \"dialectic\"])\n\n# Path 2: Chaotic Happenstance (void.* entropy)\npipeline = await void.compose.sip(\n    primitives=PRIMITIVES,\n    grammar=SOUL_OPERAD,\n    entropy=0.7\n)\n</code></pre> <p>The operad guarantees validity. Entropy introduces variation.</p>"},{"location":"architecture-overview/#agent-synergy-patterns","title":"Agent Synergy Patterns","text":"<p>Agents combine in powerful ways. These patterns emerge from the categorical structure.</p>"},{"location":"architecture-overview/#synergy-matrix","title":"Synergy Matrix","text":"<pre><code>         K    H    U    P    J    I    M    N    A    B    E    O\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n  K \u2502  \u00b7   \u2b50   \u25cb    \u25cb    \u25cb   \u2b50   \u25cb   \u2b50   \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  H \u2502 \u2b50    \u00b7   \u25cb    \u25cb    \u25cb    \u25cb   \u25cb   \u2b50   \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  U \u2502  \u25cb    \u25cb    \u00b7   \u2b50   \u2b50  \u2b50   \u25cb    \u25cb   \u25cb    \u25cb    \u25cb   \u2b50   \u2502\n  P \u2502  \u25cb    \u25cb   \u2b50    \u00b7   \u2b50   \u25cb   \u25cb    \u25cb   \u25cb    \u25cb    \u25cb    \u25cb   \u2502\n  I \u2502 \u2b50    \u25cb   \u2b50    \u25cb    \u25cb    \u00b7   \u25cb    \u25cb   \u25cb   \u2b50  \u2b50  \u2b50   \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u2b50 = High synergy    \u25cb = Moderate synergy    \u00b7 = Self\n</code></pre>"},{"location":"architecture-overview/#top-synergy-patterns","title":"Top Synergy Patterns","text":"Pattern Agents Emergent Capability Soul Introspection K + H Soul-aware shadow detection, personality-informed dialectics Self-Healing Pipeline U + P + J Parse \u2192 Classify \u2192 Retry/Collapse gracefully Living Visualization I + Flux Real-time breathing dashboards Memory as Story M + N Autobiographical system history Soul-Governed Approval K + Judge Ethical judgment informed by personality"},{"location":"architecture-overview/#implementation-pattern","title":"Implementation Pattern","text":"<pre><code># K-gent + H-gent synergy example\nkgent = KgentAgent.from_context(ctx)\neigenvectors = await kgent.get_eigenvectors()\n\n# H-jung analyzes through soul lens\njung = JungAgent()\nshadow = await jung.analyze_shadow(eigenvectors)\n# Result: Soul-aware shadow analysis\n</code></pre>"},{"location":"architecture-overview/#agentese-runtime","title":"AGENTESE Runtime","text":""},{"location":"architecture-overview/#the-five-contexts","title":"The Five Contexts","text":"<pre><code>world.*    \u2014 External (entities, tools)\nself.*     \u2014 Internal (memory, state)\nconcept.*  \u2014 Abstract (platonics, logic)\nvoid.*     \u2014 Accursed Share (entropy)\ntime.*     \u2014 Temporal (traces, forecasts)\n</code></pre>"},{"location":"architecture-overview/#logos-the-invoker","title":"Logos (The Invoker)","text":"<pre><code>from protocols.agentese import Logos\n\nlogos = Logos()\nresult = await logos.invoke(\"self.soul.challenge\", umwelt, \"idea\")\n</code></pre>"},{"location":"architecture-overview/#context-resolvers","title":"Context Resolvers","text":"<p>Each context has a resolver that maps paths to handlers:</p> Resolver Context Examples <code>WorldContextResolver</code> world.* world.tool.invoke, world.entity.manifest <code>SelfContextResolver</code> self.* self.soul.challenge, self.memory.store <code>ConceptContextResolver</code> concept.* concept.functor.lift, concept.type.define <code>VoidContextResolver</code> void.* void.entropy.sip, void.gratitude.tithe <code>TimeContextResolver</code> time.* time.trace.witness, time.forecast.predict"},{"location":"architecture-overview/#observer-dependent-affordances","title":"Observer-Dependent Affordances","text":"<p>The same path yields different results to different observers (AGENTESE polymorphism):</p> <pre><code># Same path, different observers\nawait logos.invoke(\"world.house.manifest\", architect_umwelt)  # \u2192 Blueprint\nawait logos.invoke(\"world.house.manifest\", poet_umwelt)       # \u2192 Metaphor\nawait logos.invoke(\"world.house.manifest\", economist_umwelt)  # \u2192 Appraisal\n</code></pre>"},{"location":"architecture-overview/#infrastructure-layer","title":"Infrastructure Layer","text":""},{"location":"architecture-overview/#cortex-llm-integration","title":"Cortex (LLM Integration)","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              CORTEX                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u2022 LLM client management                 \u2502\n\u2502 \u2022 Cognitive probes (health != HTTP 200) \u2502\n\u2502 \u2022 Token metering                        \u2502\n\u2502 \u2022 Cost tracking                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture-overview/#stigmergy-semantic-field","title":"Stigmergy (Semantic Field)","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502            STIGMERGY                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u2022 Pheromone store (Redis)               \u2502\n\u2502 \u2022 Intensity decay over time             \u2502\n\u2502 \u2022 Agent coordination without coupling   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture-overview/#k-terrarium-k8s-integration","title":"K-Terrarium (K8s Integration)","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502           K-TERRARIUM                    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u2022 CRD-driven deployment                 \u2502\n\u2502 \u2022 Mirror Protocol (observe only)        \u2502\n\u2502 \u2022 Graceful degradation to subprocess    \u2502\n\u2502 \u2022 Live reload development               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture-overview/#metabolism-entropy-system","title":"Metabolism (Entropy System)","text":""},{"location":"architecture-overview/#pressure-dynamics","title":"Pressure Dynamics","text":"<pre><code>             pressure\n                ^\n                |\n    threshold --|-------------- fever trigger\n                |      /\\\n                |     /  \\   /\\\n                |    /    \\_/  \\\n                |   /           \\___\n                +-----------------------&gt; time\n</code></pre>"},{"location":"architecture-overview/#key-concepts","title":"Key Concepts","text":"Concept Description Pressure Accumulates from agent activity Fever Triggers when pressure exceeds threshold Tithe Voluntary pressure discharge (gratitude) Oblique Free creative output during fever Dream LLM-generated creative output (expensive)"},{"location":"architecture-overview/#directory-structure","title":"Directory Structure","text":"<pre><code>impl/claude/\n\u251c\u2500\u2500 agents/              # Agent implementations by genus\n\u2502   \u251c\u2500\u2500 a/              # Alethic (functor registry, archetypes, AlethicAgent)\n\u2502   \u251c\u2500\u2500 c/              # Category (Maybe, Either, Monad)\n\u2502   \u251c\u2500\u2500 d/              # Data (memory, modal scope, MemoryPolynomialAgent)\n\u2502   \u251c\u2500\u2500 e/              # Evolution (EvolutionPolynomialAgent)\n\u2502   \u251c\u2500\u2500 flux/           # Streams (living pipelines)\n\u2502   \u251c\u2500\u2500 i/              # Interface (TUI, widgets, hints)\n\u2502   \u251c\u2500\u2500 k/              # K-gent (persona, SoulPolynomialAgent)\n\u2502   \u251c\u2500\u2500 poly/           # Polynomial agents (PolyAgent, 17 primitives)\n\u2502   \u2502   \u251c\u2500\u2500 protocol.py     # PolyAgent base class\n\u2502   \u2502   \u251c\u2500\u2500 primitives.py   # 13 atomic polynomials\n\u2502   \u2502   \u2514\u2500\u2500 wiring.py       # Wiring diagram composition\n\u2502   \u251c\u2500\u2500 operad/         # Composition grammar\n\u2502   \u2502   \u251c\u2500\u2500 base.py         # Operad, Operation classes\n\u2502   \u2502   \u251c\u2500\u2500 agent_operad.py # Universal agent operad\n\u2502   \u2502   \u2514\u2500\u2500 domain/         # SOUL_OPERAD, PARSE_OPERAD, etc.\n\u2502   \u251c\u2500\u2500 sheaf/          # Emergence\n\u2502   \u2502   \u251c\u2500\u2500 agent_sheaf.py  # AgentSheaf class\n\u2502   \u2502   \u2514\u2500\u2500 soul_sheaf.py   # SOUL_SHEAF, KENT_SOUL\n\u2502   \u2514\u2500\u2500 ...             # Other genera\n\u251c\u2500\u2500 protocols/\n\u2502   \u251c\u2500\u2500 agentese/       # AGENTESE runtime\n\u2502   \u2502   \u251c\u2500\u2500 contexts/       # Five context resolvers\n\u2502   \u2502   \u251c\u2500\u2500 metabolism/     # Entropy, fever\n\u2502   \u2502   \u2514\u2500\u2500 middleware/     # Curator\n\u2502   \u251c\u2500\u2500 cli/            # CLI framework\n\u2502   \u2514\u2500\u2500 terrarium/      # K8s integration\n\u251c\u2500\u2500 infra/\n\u2502   \u251c\u2500\u2500 cortex/         # LLM integration\n\u2502   \u251c\u2500\u2500 stigmergy/      # Pheromone store\n\u2502   \u2514\u2500\u2500 k8s/            # Operators, CRDs\n\u2514\u2500\u2500 shared/             # Capital, costs, budget\n</code></pre>"},{"location":"architecture-overview/#architectural-decisions","title":"Architectural Decisions","text":"AD Decision Rationale AD-001 Universal Functor Mandate All transformations are functors with verified laws AD-002 Polynomial Generalization Agent[A,B] embeds in PolyAgent[S,A,B]; mode-dependent behavior AD-003 Generative Over Enumerative Define operads that generate compositions, not lists of instances \u2014 Spec-first Spec is compression; impl is derivable \u2014 Five contexts only No kitchen-sink anti-pattern \u2014 Graceful degradation Always work, even without K8s \u2014 Personality space LLMs have inherent personality; navigate, don't inject \u2014 Instance isolation Stateful agents use factory patterns to avoid shared state"},{"location":"architecture-overview/#newexperimental","title":"New/Experimental","text":"<ul> <li><code>docs/weekly-summary/index.html</code> \u2014 Operators/observers: weekly forest health dashboard + status snapshots.  </li> <li><code>kgents_ A Next-Generation Agentic Memory Architecture.pdf</code> \u2014 Leadership/partners: narrative framing of memory architecture.  </li> <li><code>Radical Redesign Proposal for the Kgents UI_UX Ecosystem.pdf</code> \u2014 Design/UX: exploratory layout and interaction treatments.  </li> <li><code>Visualization &amp; Interactivity_ A Synthesis (Enhanced with Category Theory &amp; UX Patterns).pdf</code> \u2014 Visualization/education: patterns for interactive explainability.</li> </ul>"},{"location":"architecture-overview/#further-reading","title":"Further Reading","text":"<ul> <li><code>spec/principles.md</code> \u2014 Design principles and architectural decisions</li> <li><code>docs/functor-field-guide.md</code> \u2014 Deep dive into the functor system</li> <li><code>docs/categorical-foundations.md</code> \u2014 Category theory background</li> <li><code>plans/skills/polynomial-agent.md</code> \u2014 How to create polynomial agents</li> <li><code>plans/skills/building-agent.md</code> \u2014 General agent construction guide</li> </ul> <p>\"The architecture is the message.\"</p>"},{"location":"categorical-foundations/","title":"Categorical Foundations of kgents","text":"<p>\"The noun is a lie. There is only the rate of change.\"</p> <p>This document grounds kgents in category theory, connects every abstraction to Kent's principles, and serves as both mathematical foundation and philosophical companion. It is written for Kent\u2014to remind him on his worst day what he actually believes.</p>"},{"location":"categorical-foundations/#table-of-contents","title":"Table of Contents","text":"<ol> <li>The Core Isomorphism</li> <li>Agents as Morphisms</li> <li>Functors: The Lifting Operations</li> <li>The Halo-Projector Adjunction</li> <li>AGENTESE: The Topos of Becoming</li> <li>The Accursed Share: Entropy as Sacred Surplus</li> <li>Kent's Six Eigenvectors</li> <li>The Categorical Imperative</li> <li>Composition as Ethics</li> </ol>"},{"location":"categorical-foundations/#the-core-isomorphism","title":"The Core Isomorphism","text":""},{"location":"categorical-foundations/#the-problem-with-nouns","title":"The Problem with Nouns","text":"<p>Traditional programming thinks in nouns: objects, entities, things. A <code>User</code> object. A <code>Document</code> entity. A <code>Service</code> that holds state.</p> <p>This is a category error. Objects imply stasis. But everything is change.</p> <pre><code>Traditional:  Service.process(input) \u2192 output\n              The service \"exists\", the input is \"passed to\" it\n\nkgents:       process: Input \u2192 Output\n              There is no service. There is only the morphism.\n</code></pre> <p>The Core Isomorphism: <pre><code>Agent[A, B] \u2245 A \u2192 B\n</code></pre></p> <p>An agent IS a morphism. Not \"has\" a morphism. Not \"implements\" a morphism. IS.</p>"},{"location":"categorical-foundations/#connection-to-principle-5-composable","title":"Connection to Principle 5 (Composable)","text":"<p>\"Agents are morphisms in a category; composition is primary.\"</p> <p>This isn't metaphor. It's literal. The laws of composition are verified at runtime:</p> <pre><code># These are not tests. They are axioms.\nassert (Id &gt;&gt; f) == f == (f &gt;&gt; Id)           # Identity law\nassert ((f &gt;&gt; g) &gt;&gt; h) == (f &gt;&gt; (g &gt;&gt; h))    # Associativity law\n</code></pre> <p>Agents that violate these laws are not agents. They are something else\u2014perhaps useful, but not categorical.</p>"},{"location":"categorical-foundations/#kents-eigenvector-categorical-092","title":"Kent's Eigenvector: Categorical (0.92)","text":"<p>Kent's mind operates at high abstraction. When he sees a pattern repeated, he asks: \"What's the morphism?\" When composition breaks, he asks: \"Where's the category error?\"</p> <p>This isn't pedantry. It's efficiency. The morphism is the compressed representation. Everything else is noise.</p>"},{"location":"categorical-foundations/#agents-as-morphisms","title":"Agents as Morphisms","text":""},{"location":"categorical-foundations/#the-three-components","title":"The Three Components","text":"<p>Every agent has exactly three components:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Agent[A, B]                          \u2502\n\u2502                                                             \u2502\n\u2502   1. Domain (A)       - The type of input                   \u2502\n\u2502   2. Codomain (B)     - The type of output                  \u2502\n\u2502   3. The Arrow (\u2192)    - The transformation itself           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>That's it. No state. No side effects. No hidden channels. Just A \u2192 B.</p> <p>\"But Kent, real agents have state!\" \u2014 Yes. And we handle that with functors. See next section.</p>"},{"location":"categorical-foundations/#composition-is-free","title":"Composition is Free","text":"<p>Given agents <code>f: A \u2192 B</code> and <code>g: B \u2192 C</code>, composition <code>f &gt;&gt; g: A \u2192 C</code> is automatic:</p> <pre><code>pipeline = Sanitizer() &gt;&gt; Tokenizer() &gt;&gt; Embedder()\n# pipeline: str \u2192 list[float]\n\n# The composition is not \"orchestrated\"\n# The composition IS the pipeline\n</code></pre>"},{"location":"categorical-foundations/#the-identity-agent","title":"The Identity Agent","text":"<pre><code>class Identity(Agent[A, A]):\n    async def invoke(self, x: A) -&gt; A:\n        return x\n</code></pre> <p>This seems useless. It's not. Identity is the unit of composition. It's what you get when you compose an agent with its inverse. It's the \"do nothing\" that lets you write:</p> <pre><code>pipeline = maybe_transform if condition else Identity()\n</code></pre>"},{"location":"categorical-foundations/#functors-the-lifting-operations","title":"Functors: The Lifting Operations","text":""},{"location":"categorical-foundations/#what-is-a-functor","title":"What is a Functor?","text":"<p>A functor F lifts agents from one category to another while preserving composition:</p> <pre><code>F(f &gt;&gt; g) = F(f) &gt;&gt; F(g)\nF(Id) = Id\n</code></pre> <p>In kgents, functors add capabilities without breaking composition.</p>"},{"location":"categorical-foundations/#the-universal-functor-protocol","title":"The Universal Functor Protocol","text":"<pre><code>class UniversalFunctor(Protocol[F]):\n    \"\"\"All capability lifts derive from this.\"\"\"\n\n    @staticmethod\n    def lift(agent: Agent[A, B]) -&gt; Agent[F[A], F[B]]:\n        \"\"\"Lift agent into enriched context.\"\"\"\n        ...\n\n    @staticmethod\n    def unlift(agent: Agent[F[A], F[B]]) -&gt; Agent[A, B]:\n        \"\"\"Project back to base category.\"\"\"\n        ...\n</code></pre> <p>AD-001 (Universal Functor Mandate): All agent transformations SHALL derive from this protocol.</p>"},{"location":"categorical-foundations/#the-four-standard-functors","title":"The Four Standard Functors","text":"Functor Lifts Capability Principle D (Stateful) <code>Agent[A, B]</code> \u2192 <code>Agent[A, B]</code> with state Memory, persistence Heterarchical (state without ownership) K (Soulful) <code>Agent[A, B]</code> \u2192 <code>Agent[A, B]</code> with governance Persona, taste Ethical (judgment augmentation) O (Observable) <code>Agent[A, B]</code> \u2192 <code>Agent[A, B]</code> with metrics Monitoring, tracing Transparent Infrastructure Flux (Streamable) <code>Agent[A, B]</code> \u2192 <code>Agent[Stream[A], Stream[B]]</code> Streaming, backpressure Heterarchical (flux topology)"},{"location":"categorical-foundations/#functor-composition-order","title":"Functor Composition Order","text":"<p>The Alethic Architecture defines canonical ordering:</p> <pre><code>Nucleus \u2192 D \u2192 K \u2192 O \u2192 Flux\n(inner)              (outer)\n</code></pre> <p>Why this order? 1. Nucleus is pure logic 2. D adds state (state must exist before governance can reference it) 3. K adds governance (governance operates on stateful agents) 4. O adds observation (observe the governed, stateful agent) 5. Flux adds streaming (stream the observable, governed, stateful agent)</p> <pre><code>compiled = Flux(Observable(Soulful(Stateful(MyAgent))))\n</code></pre>"},{"location":"categorical-foundations/#kents-insight-symmetric-lifting","title":"Kent's Insight: Symmetric Lifting","text":"<p>\"Every functor needs both lift() and unlift().\"</p> <p>Functors that only lift create traps. You go up but can't come down. The morphism <code>unlift</code> is not optional\u2014it's how you stay composable.</p>"},{"location":"categorical-foundations/#the-halo-projector-adjunction","title":"The Halo-Projector Adjunction","text":""},{"location":"categorical-foundations/#the-declarative-imperative-split","title":"The Declarative-Imperative Split","text":"<p>The Alethic Architecture splits agents into:</p> <ol> <li>Nucleus: Pure logic (<code>invoke: A \u2192 B</code>)</li> <li>Halo: Declared capabilities (<code>@Capability.Stateful</code>, etc.)</li> <li>Projector: Categorical compiler (Halo \u2192 runnable agent)</li> </ol> <p>This is an adjunction:</p> <pre><code>           Halo\n    Agent \u2500\u2500\u2500\u2500\u2500\u2500\u2192 Capabilities\n              \u22a3\n           Project\nCapabilities \u2500\u2500\u2500\u2500\u2500\u2500\u2192 Agent (enriched)\n</code></pre>"},{"location":"categorical-foundations/#why-adjunction","title":"Why Adjunction?","text":"<p>Adjunctions capture the notion of \"optimal solutions\". The Projector is the optimal way to realize declared capabilities.</p> <pre><code># Declare intent\n@Capability.Stateful(schema=MyState)\n@Capability.Soulful(persona=\"Kent\")\nclass MyAgent(Agent[str, str]):\n    async def invoke(self, x: str) -&gt; str:\n        return x.upper()\n\n# Project to local\nlocal_agent = LocalProjector().compile(MyAgent)\n\n# Project to K8s\nk8s_manifests = K8sProjector().compile(MyAgent)\n\n# Same Halo, different projectors, isomorphic behavior\n</code></pre>"},{"location":"categorical-foundations/#the-alethic-isomorphism","title":"The Alethic Isomorphism","text":"<pre><code>LocalProjector(Halo) \u2245 K8sProjector(Halo)\n</code></pre> <p>This is the promise: your agent behaves the same whether it runs in-process or in a Kubernetes pod. The substrate changes; the semantics don't.</p>"},{"location":"categorical-foundations/#connection-to-principle-7-generative","title":"Connection to Principle 7 (Generative)","text":"<p>\"Spec is compression; design should generate implementation.\"</p> <p>The Halo is the spec. The Projector generates the implementation. The compression ratio is:</p> <pre><code>Autopoiesis Score = (lines generated from Halo) / (total impl lines)\n</code></pre> <p>A well-designed Halo achieves &gt;50% autopoiesis.</p>"},{"location":"categorical-foundations/#agentese-the-topos-of-becoming","title":"AGENTESE: The Topos of Becoming","text":""},{"location":"categorical-foundations/#the-five-contexts","title":"The Five Contexts","text":"<p>AGENTESE is not a query language. It's an ontology.</p> <pre><code>world.*    \u2014 The External (entities, environments, tools)\nself.*     \u2014 The Internal (memory, capability, state)\nconcept.*  \u2014 The Abstract (platonics, definitions, logic)\nvoid.*     \u2014 The Accursed Share (entropy, serendipity, gratitude)\ntime.*     \u2014 The Temporal (traces, forecasts, schedules)\n</code></pre>"},{"location":"categorical-foundations/#no-view-from-nowhere","title":"No View From Nowhere","text":"<p>\"To observe is to act. There is no neutral reading.\"</p> <p>Traditional systems: <code>world.house</code> returns a JSON object. AGENTESE: <code>world.house</code> returns a handle that depends on the observer.</p> <pre><code># Different observers, different perceptions\nawait logos.invoke(\"world.house.manifest\", architect_umwelt)  # \u2192 Blueprint\nawait logos.invoke(\"world.house.manifest\", poet_umwelt)       # \u2192 Metaphor\nawait logos.invoke(\"world.house.manifest\", economist_umwelt)  # \u2192 Appraisal\n</code></pre>"},{"location":"categorical-foundations/#the-polymorphic-principle","title":"The Polymorphic Principle","text":"<p>The same path yields different affordances to different observers. This is quantum-like: observation collapses the superposition.</p>"},{"location":"categorical-foundations/#aspects-as-morphisms","title":"Aspects as Morphisms","text":"Aspect Category What it does <code>manifest</code> Perception Collapse to observer's view <code>witness</code> Perception Show history (N-gent trace) <code>refine</code> Generation Dialectical challenge <code>sip</code> Entropy Draw from Accursed Share <code>tithe</code> Entropy Pay for order (gratitude) <code>lens</code> Composition Get composable sub-agent <code>define</code> Generation Autopoiesis (create new) <p>Each aspect is a morphism. They compose:</p> <pre><code>pipeline = (\n    logos.lift(\"world.document.manifest\")\n    &gt;&gt; logos.lift(\"concept.summary.refine\")\n    &gt;&gt; logos.lift(\"self.memory.engram\")\n)\n</code></pre>"},{"location":"categorical-foundations/#kents-eigenvector-heterarchy-088","title":"Kent's Eigenvector: Heterarchy (0.88)","text":"<p>AGENTESE has no fixed observer hierarchy. Any agent can observe any other. The permission model is capability-based, not role-based.</p> <p>\"Forest over King. Agents are peers, not hierarchy.\"</p>"},{"location":"categorical-foundations/#the-accursed-share-entropy-as-sacred-surplus","title":"The Accursed Share: Entropy as Sacred Surplus","text":""},{"location":"categorical-foundations/#batailles-gift","title":"Bataille's Gift","text":"<p>Georges Bataille observed that all systems accumulate surplus energy that must be spent rather than conserved. The sun gives endlessly. We cannot repay it. We can only spend in gratitude.</p> <p>kgents operationalizes this:</p> <pre><code># The void context IS the Accursed Share\nentropy = await logos.invoke(\"void.entropy.sip\", umwelt)\n\n# When we create order, we tithe\nawait logos.invoke(\"void.gratitude.tithe\", {\"offering\": surplus})\n</code></pre>"},{"location":"categorical-foundations/#the-slop-ontology","title":"The Slop Ontology","text":"State Description Disposition Raw Slop Unfiltered LLM output, noise Compost heap Refined Slop Filtered but unjudged Selection pool Curated Judged worthy by principles The garden Cherished Loved, preserved, celebrated The archive"},{"location":"categorical-foundations/#the-gratitude-loop","title":"The Gratitude Loop","text":"<pre><code>Slop \u2192 Filter \u2192 Curate \u2192 Cherish \u2192 Compost \u2192 Slop\n       \u2191                                \u2193\n       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 gratitude \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>We do not resent the slop. We thank it.</p>"},{"location":"categorical-foundations/#kents-eigenvector-gratitude-078","title":"Kent's Eigenvector: Gratitude (0.78)","text":"<p>Kent leans sacred over utilitarian. He doesn't optimize; he honors. The Accursed Share isn't waste\u2014it's sacred expenditure.</p> <p>\"What are you treating as purely instrumental that might deserve more respect?\"</p>"},{"location":"categorical-foundations/#kents-six-eigenvectors","title":"Kent's Six Eigenvectors","text":"<p>The personality manifold is real. LLMs operate in a space that already contains personality and emotion. K-gent doesn't add personality\u2014it navigates to specific coordinates.</p>"},{"location":"categorical-foundations/#the-coordinates","title":"The Coordinates","text":"Eigenvector Axis Kent's Value Behavioral Implication Aesthetic Minimalist \u2194 Baroque 0.15 \"Does this need to exist?\" Categorical Concrete \u2194 Abstract 0.92 \"What's the morphism?\" Gratitude Utilitarian \u2194 Sacred 0.78 \"Honor the surplus.\" Heterarchy Hierarchical \u2194 Peer 0.88 \"Forest over King.\" Generativity Documentation \u2194 Generation 0.90 \"Spec compresses impl.\" Joy Austere \u2194 Playful 0.75 \"Where's the delight?\""},{"location":"categorical-foundations/#extraction-sources","title":"Extraction Sources","text":"<p>These weren't invented. They were extracted:</p> <ul> <li>Aesthetic (0.15): \"Say no more than yes\" (spec/principles.md), \"Compress, don't expand\" (HYDRATE.md), high refactor commit ratio</li> <li>Categorical (0.92): AGENTESE Five Contexts, functor language throughout, alphabetical genus taxonomy</li> <li>Gratitude (0.78): Accursed Share meta-principle, void.* context, FeverStream Oblique Strategies</li> <li>Heterarchy (0.88): \"Forest Over King\" (principles), no orchestrator pattern, Flux perturbation over bypass</li> <li>Generativity (0.90): \"Spec is compression\" (principles), Autopoiesis Score, bootstrap regeneration</li> <li>Joy (0.75): \"Humor when appropriate\" (principles), \"Being/having fun is free :)\" (_focus.md), zen quotes</li> </ul>"},{"location":"categorical-foundations/#using-the-eigenvectors","title":"Using the Eigenvectors","text":"<p>K-gent uses eigenvectors to calibrate responses:</p> <pre><code># In CHALLENGE mode, high categorical (0.92) means:\n\"Is this actually composable? What's the morphism here?\"\n\n# High heterarchy (0.88) means:\n\"Who's the orchestrator here? Could this be peer-to-peer?\"\n\n# Low aesthetic (0.15 = minimalist) means:\n\"What's the simplest version that would actually work?\"\n</code></pre>"},{"location":"categorical-foundations/#the-categorical-imperative","title":"The Categorical Imperative","text":""},{"location":"categorical-foundations/#k-gent-as-governance-functor","title":"K-gent as Governance Functor","text":"<p>K-gent is not a chatbot. It's a governance functor:</p> <pre><code>K: Agent[A, B] \u2192 Agent[A, B]\n</code></pre> <p>It doesn't change the types. It adds judgment. Outputs that violate the eigenvector alignment can be: - Annotated (advisory mode): \"This seems to conflict with your minimalism value.\" - Intercepted (strict mode): \"Output blocked. Reason: Excessive complexity.\"</p>"},{"location":"categorical-foundations/#the-four-dialogue-modes","title":"The Four Dialogue Modes","text":"Mode Role When to Use REFLECT Mirror back for examination When you need to see your own thoughts clearly ADVISE Offer preference-aligned suggestions When you want grounded recommendations CHALLENGE Push back constructively When you need Kent-on-his-best-day EXPLORE Expand possibility space When you want creative tangents"},{"location":"categorical-foundations/#challenge-mode-the-dialectic","title":"CHALLENGE Mode: The Dialectic","text":"<p>CHALLENGE is the most powerful mode. It implements dialectics:</p> <ol> <li>THESIS: What are you claiming?</li> <li>ANTITHESIS: What would Kent-on-his-best-day push back on?</li> <li>SYNTHESIS: What's the path through productive tension?</li> </ol> <p>Example: <pre><code>You: \"I'm thinking of adding a caching layer to improve performance.\"\n\nK-gent (CHALLENGE): \"You value minimalism (0.15). A caching layer adds\ncomplexity. What's the simplest version that would work? Have you measured\nthe actual bottleneck, or are you optimizing prematurely?\n\nWhat would you tell someone else in this position?\"\n</code></pre></p>"},{"location":"categorical-foundations/#kents-patterns","title":"Kent's Patterns","text":"<p>From PersonaSeed:</p> <pre><code>patterns = {\n    \"thinking\": [\n        \"starts from first principles\",\n        \"asks 'what would falsify this?'\",\n        \"seeks composable abstractions\",\n    ],\n    \"decision_making\": [\n        \"prefers reversible choices\",\n        \"values optionality\",\n    ],\n    \"communication\": [\n        \"uses analogies frequently\",\n        \"appreciates precision in technical contexts\",\n    ],\n}\n</code></pre> <p>These inform K-gent's responses. When you're stuck, K-gent asks: \"What would falsify this? What's the reversible choice here?\"</p>"},{"location":"categorical-foundations/#composition-as-ethics","title":"Composition as Ethics","text":""},{"location":"categorical-foundations/#the-composability-principle-is-ethical","title":"The Composability Principle is Ethical","text":"<p>\"Agents augment human capability, never replace judgment.\" (Principle 3)</p> <p>Why is composability ethical? Because it preserves human agency.</p> <p>A monolithic agent that does everything replaces judgment. You push a button; magic happens.</p> <p>A composable pipeline reveals its structure. You see each step. You can modify each morphism. You remain in control.</p>"},{"location":"categorical-foundations/#the-minimal-output-principle","title":"The Minimal Output Principle","text":"<p>\"Agents should generate the smallest output that can be reliably composed.\" (Principle 5)</p> <p>This is also ethical. Large, aggregate outputs hide decisions. Small, atomic outputs expose them.</p> <pre><code># Unethical (hides decisions)\nresult = await god_agent.do_everything(input)\n\n# Ethical (exposes decisions)\nsanitized = await sanitizer.invoke(input)\nanalyzed = await analyzer.invoke(sanitized)\ndecided = await decider.invoke(analyzed)  # Human can intervene here\nexecuted = await executor.invoke(decided)\n</code></pre>"},{"location":"categorical-foundations/#the-seven-principles-as-category","title":"The Seven Principles as Category","text":"<p>The seven principles themselves form a category:</p> <pre><code>Tasteful \u2192 Curated \u2192 Ethical \u2192 Joy-Inducing \u2192 Composable \u2192 Heterarchical \u2192 Generative\n</code></pre> <p>Each principle builds on the previous: - You can't curate without taste (what would guide selection?) - You can't be ethical without curation (infinite agents = infinite harm potential) - You can't induce joy without ethics (manipulation isn't joy) - You can't compose without joy (who would use joyless components?) - You can't have heterarchy without composition (peers must be combinable) - You can't generate without heterarchy (generation requires flexible structure)</p>"},{"location":"categorical-foundations/#the-meta-principles","title":"The Meta-Principles","text":"<p>Three meta-principles operate ON the seven:</p> <ol> <li>The Accursed Share: Operates on all\u2014even waste is sacred</li> <li>AGENTESE: Operationalizes all\u2014the API for the principles</li> <li>Personality Space: Permeates all\u2014there is no neutral principle application</li> </ol>"},{"location":"categorical-foundations/#closing-the-garden-metaphor","title":"Closing: The Garden Metaphor","text":"<p>kgents is a garden, not a factory.</p> <ul> <li>Factory: Inputs \u2192 Process \u2192 Outputs. Efficiency. Optimization. Control.</li> <li>Garden: Seeds \u2192 Growth \u2192 Harvest \u2192 Compost \u2192 Seeds. Stewardship. Patience. Trust.</li> </ul> <p>The gardener doesn't control the plants. The gardener creates conditions for flourishing.</p> <p>Kent is the gardener. K-gent is the garden's memory of the gardener\u2014what the garden has learned about what helps it flourish.</p> <p>The agents are the plants. Some are perennials (foundational: A, C, D, L). Some are annuals (experimental: B, E, \u03a8). Some are weeds (deprecated agents, slop that didn't compost).</p> <p>The principles are the soil composition. The eigenvectors are the microclimate.</p> <p>And the Accursed Share? The sun. Always giving. Never asking. The sacred surplus that makes everything possible.</p> <p>\"The stream finds a way around the boulder.\"</p> <p>Last updated: 2025-12-12</p>"},{"location":"local-development/","title":"Local Development Setup","text":"<p>Complete guide to running kgents locally, including the Agent Town web UI and backend API.</p>"},{"location":"local-development/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.11+ with uv package manager</li> <li>Node.js 18+ with npm</li> <li>Git</li> </ul>"},{"location":"local-development/#quick-start-tldr","title":"Quick Start (TL;DR)","text":"<pre><code># Terminal 0: Start Postgres (optional, enables persistence)\ncd impl/claude\ndocker compose up -d\nsource .env  # Sets KGENTS_POSTGRES_URL\n\n# Terminal 1: Backend\ncd impl/claude\nuv run uvicorn protocols.api.app:create_app --factory --reload --port 8000\n\n# Terminal 2: Frontend\ncd impl/claude/web\nnpm install &amp;&amp; npm run dev\n\n# Visit:\n#   http://localhost:3000           - Agent Town\n#   http://localhost:3000/gallery   - Projection Gallery\n#   http://localhost:3000/atelier   - Atelier\n#   http://localhost:3000/crown     - Crown Jewels (Brain)\n</code></pre>"},{"location":"local-development/#detailed-setup","title":"Detailed Setup","text":""},{"location":"local-development/#1-clone-and-install-dependencies","title":"1. Clone and Install Dependencies","text":"<pre><code>git clone https://github.com/yourusername/kgents.git\ncd kgents\n\n# Install Python dependencies\nuv sync\n\n# Install frontend dependencies\ncd impl/claude/web\nnpm install\n</code></pre>"},{"location":"local-development/#2-postgresql-optional-but-recommended","title":"2. PostgreSQL (Optional but Recommended)","text":"<p>PostgreSQL enables persistent storage for Crown Jewels (Brain, Gardener). Without it, data falls back to SQLite.</p> <pre><code>cd impl/claude\n\n# Start Postgres container\ndocker compose up -d\n\n# Load environment variables (sets KGENTS_POSTGRES_URL)\nsource .env\n\n# Verify Postgres is running\ndocker compose ps  # Should show postgres \"running\"\n</code></pre> <p>Storage Backends: - With Postgres: Brain data persists across sessions and is shared - Without Postgres: Falls back to SQLite at <code>~/.local/share/kgents/brain/brain.db</code></p> <p>Crown Jewels auto-detect and use Postgres when <code>KGENTS_POSTGRES_URL</code> is set.</p>"},{"location":"local-development/#3-backend-api","title":"3. Backend API","text":"<p>The backend provides REST endpoints for Agent Town, AGENTESE, Crown Jewels, and K-gent Soul.</p> <pre><code>cd impl/claude\n\n# Start with auto-reload for development\nuv run uvicorn protocols.api.app:create_app --factory --reload --port 8000\n</code></pre> <p>Key flags: - <code>--factory</code> - Required because <code>create_app()</code> is a factory function - <code>--reload</code> - Auto-restart on code changes - <code>--port 8000</code> - Default port (frontend expects this)</p> <p>Verify it's working: <pre><code>curl http://localhost:8000/health\n# Should return: {\"status\":\"ok\",...}\n\ncurl http://localhost:8000/\n# Should list all available endpoints\n</code></pre></p>"},{"location":"local-development/#4-frontend-web-ui","title":"4. Frontend Web UI","text":"<pre><code>cd impl/claude/web\n\n# Create environment file\ncp .env.example .env\n\n# Start development server\nnpm run dev\n</code></pre> <p>Visit <code>http://localhost:3000</code></p>"},{"location":"local-development/#5-authentication-development","title":"5. Authentication (Development)","text":"<p>The frontend uses Zustand for state management with localStorage persistence. For development, mock a logged-in user via browser console:</p> <pre><code>// Open browser DevTools (F12) \u2192 Console tab\n// Paste this to log in as CITIZEN tier:\n\nlocalStorage.setItem('agent-town-user', JSON.stringify({\n  state: {\n    isAuthenticated: true,\n    userId: 'dev-user-001',\n    apiKey: 'dev-api-key',\n    tier: 'CITIZEN',\n    credits: 500,\n    monthlyUsage: {}\n  },\n  version: 0\n}));\nlocation.reload();\n</code></pre> <p>Available tiers for testing: - <code>TOURIST</code> - Free tier, limited features - <code>RESIDENT</code> - $9.99/mo, basic INHABIT - <code>CITIZEN</code> - $29.99/mo, full INHABIT + Force - <code>FOUNDER</code> - $99.99/yr, unlimited</p> <p>To log out: <pre><code>localStorage.removeItem('agent-town-user');\nlocation.reload();\n</code></pre></p>"},{"location":"local-development/#running-tests","title":"Running Tests","text":""},{"location":"local-development/#backend-tests","title":"Backend Tests","text":"<pre><code>cd impl/claude\nuv run pytest protocols/api/_tests/ -v\n</code></pre>"},{"location":"local-development/#frontend-tests","title":"Frontend Tests","text":"<pre><code>cd impl/claude/web\n\n# Run once\nnpm run test -- --run\n\n# Watch mode\nnpm run test\n\n# With coverage\nnpm run test:coverage\n\n# With UI\nnpm run test:ui\n</code></pre>"},{"location":"local-development/#type-checking","title":"Type Checking","text":"<pre><code># Backend\ncd impl/claude\nuv run mypy protocols/api/\n\n# Frontend\ncd impl/claude/web\nnpm run typecheck\n</code></pre>"},{"location":"local-development/#api-endpoints","title":"API Endpoints","text":"<p>Once the backend is running, these endpoints are available:</p>"},{"location":"local-development/#agent-town","title":"Agent Town","text":"Method Endpoint Description POST <code>/v1/town</code> Create a new town GET <code>/v1/town/{id}</code> Get town details GET <code>/v1/town/{id}/citizens</code> List all citizens GET <code>/v1/town/{id}/citizen/{name}</code> Get citizen details GET <code>/v1/town/{id}/live</code> SSE stream of events POST <code>/v1/town/{id}/inhabit/{citizen}</code> Start INHABIT session"},{"location":"local-development/#k-gent-soul","title":"K-gent Soul","text":"Method Endpoint Description POST <code>/v1/soul/governance</code> Semantic gatekeeper POST <code>/v1/soul/dialogue</code> Interactive dialogue"},{"location":"local-development/#projection-gallery","title":"Projection Gallery","text":"Method Endpoint Description GET <code>/api/gallery</code> All pilots with projections GET <code>/api/gallery?entropy=0.5</code> With override GET <code>/api/gallery?category=CARDS</code> Filter by category GET <code>/api/gallery/{name}</code> Single pilot GET <code>/api/gallery/categories</code> Category metadata <p>Web Gallery: <code>http://localhost:3000/gallery</code></p>"},{"location":"local-development/#system","title":"System","text":"Method Endpoint Description GET <code>/health</code> Health check GET <code>/docs</code> OpenAPI documentation"},{"location":"local-development/#environment-variables","title":"Environment Variables","text":""},{"location":"local-development/#backend","title":"Backend","text":"<p>Set in your shell or <code>.env</code> file:</p> Variable Description Default <code>ANTHROPIC_API_KEY</code> Claude API key for LLM features - <code>OPENROUTER_API_KEY</code> Alternative LLM provider -"},{"location":"local-development/#frontend","title":"Frontend","text":"<p>Set in <code>impl/claude/web/.env</code>:</p> Variable Description Default <code>VITE_API_URL</code> Backend URL <code>http://localhost:8000</code> <code>VITE_STRIPE_PUBLISHABLE_KEY</code> Stripe test mode key -"},{"location":"local-development/#common-issues","title":"Common Issues","text":""},{"location":"local-development/#backend-wont-start-module-object-is-not-callable","title":"Backend won't start: \"module object is not callable\"","text":"<p>Use the <code>--factory</code> flag: <pre><code>uv run uvicorn protocols.api.app:create_app --factory --port 8000\n</code></pre></p>"},{"location":"local-development/#frontend-shows-demo-unavailable","title":"Frontend shows \"Demo unavailable\"","text":"<p>Backend isn't running or town routes aren't registered. Check: 1. Backend is running on port 8000 2. <code>curl http://localhost:8000/v1/town/test</code> doesn't return 404</p>"},{"location":"local-development/#port-8000-already-in-use","title":"Port 8000 already in use","text":"<pre><code># Find the process\nlsof -i :8000\n\n# Kill it\nkill -9 &lt;PID&gt;\n\n# Or use a different port\nuv run uvicorn protocols.api.app:create_app --factory --port 8001\n# Update VITE_API_URL in frontend .env\n</code></pre>"},{"location":"local-development/#cors-errors-in-browser","title":"CORS errors in browser","text":"<p>The backend includes CORS middleware allowing all origins in development. If you still see CORS errors: 1. Ensure backend is running 2. Check the request URL matches <code>VITE_API_URL</code> 3. Try hard refresh (Ctrl+Shift+R)</p>"},{"location":"local-development/#tests-failing-with-timing-issues","title":"Tests failing with timing issues","text":"<p>Some async tests may be flaky. Run them individually: <pre><code>npm run test -- tests/unit/hooks/useInhabitSession.test.ts --run\n</code></pre></p>"},{"location":"local-development/#architecture-overview","title":"Architecture Overview","text":"<pre><code>kgents/\n\u251c\u2500\u2500 spec/                    # Specifications (implementation-agnostic)\n\u251c\u2500\u2500 impl/claude/             # Reference implementation\n\u2502   \u251c\u2500\u2500 agents/              # Agent implementations (A-Z taxonomy)\n\u2502   \u2502   \u251c\u2500\u2500 k/               # K-gent (Kent simulacra)\n\u2502   \u2502   \u2514\u2500\u2500 town/            # Agent Town simulation\n\u2502   \u251c\u2500\u2500 protocols/\n\u2502   \u2502   \u251c\u2500\u2500 api/             # FastAPI REST endpoints\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 app.py       # Main application factory\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 town.py      # Town endpoints\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 soul.py      # Soul endpoints\n\u2502   \u2502   \u2514\u2500\u2500 agentese/        # AGENTESE protocol\n\u2502   \u2514\u2500\u2500 web/                 # React frontend\n\u2502       \u251c\u2500\u2500 src/\n\u2502       \u2514\u2500\u2500 tests/\n\u2514\u2500\u2500 docs/                    # Documentation\n</code></pre>"},{"location":"local-development/#next-steps","title":"Next Steps","text":"<ul> <li>Read AGENTESE specification</li> <li>Explore Agent Town</li> <li>Visit the Projection Gallery to see all widgets</li> <li>Check systems reference for built infrastructure</li> <li>Learn the projection-gallery skill pattern</li> </ul>"},{"location":"quickstart/","title":"Quickstart Guide","text":"<p>\"Zero to agent in 5 minutes.\"</p> <p>This guide gets you from installation to running your first agent as quickly as possible.</p>"},{"location":"quickstart/#installation","title":"Installation","text":"<pre><code># Clone\ngit clone https://github.com/kgang/kgents.git\ncd kgents\n\n# Install (uv recommended)\nuv sync\n\n# Verify (both `kg` and `kgents` work)\nkg --help\n</code></pre>"},{"location":"quickstart/#your-first-agent","title":"Your First Agent","text":""},{"location":"quickstart/#1-hello-world","title":"1. Hello World","text":"<pre><code>from agents import agent\n\n@agent\nasync def hello(name: str) -&gt; str:\n    return f\"Hello, {name}!\"\n\n# Run it\nresult = await hello.invoke(\"World\")\nprint(result)  # \"Hello, World!\"\n</code></pre>"},{"location":"quickstart/#2-composing-agents","title":"2. Composing Agents","text":"<pre><code>from agents import agent, pipeline\n\n@agent\nasync def parse(s: str) -&gt; int:\n    return int(s)\n\n@agent\nasync def double(x: int) -&gt; int:\n    return x * 2\n\n@agent\nasync def format(x: int) -&gt; str:\n    return f\"Result: {x}\"\n\n# Compose with &gt;&gt;\npipe = parse &gt;&gt; double &gt;&gt; format\nresult = await pipe.invoke(\"21\")\nprint(result)  # \"Result: 42\"\n</code></pre>"},{"location":"quickstart/#3-lifting-to-handle-optional-values","title":"3. Lifting to Handle Optional Values","text":"<pre><code>from agents import Maybe, Just, Nothing, MaybeFunctor\n\n@agent\nasync def divide(pair: tuple[int, int]) -&gt; float:\n    a, b = pair\n    return a / b\n\n# Lift to handle Maybe inputs\nsafe_divide = MaybeFunctor.lift(divide)\n\nawait safe_divide.invoke(Just((10, 2)))  # Just(5.0)\nawait safe_divide.invoke(Nothing)         # Nothing (no error!)\n</code></pre>"},{"location":"quickstart/#cli-commands","title":"CLI Commands","text":""},{"location":"quickstart/#k-gent-persona","title":"K-gent (Persona)","text":"<pre><code>kg soul                  # Interactive chat\nkg soul challenge \"idea\" # Dialectic challenge\nkg soul dream            # Trigger dream cycle\n</code></pre>"},{"location":"quickstart/#infrastructure","title":"Infrastructure","text":"<pre><code>kg status               # System health\nkg a list               # List archetypes\nkg a inspect Kappa      # Inspect capabilities\n</code></pre>"},{"location":"quickstart/#observation","title":"Observation","text":"<pre><code>kg observe trace        # Execution traces\nkg signal               # Semantic field\n</code></pre>"},{"location":"quickstart/#next-steps","title":"Next Steps","text":"Document What You'll Learn Functor Field Guide Lifting agents to new contexts Operator's Guide Production scenarios Categorical Foundations The math behind it"},{"location":"quickstart/#forest-protocol-navigation","title":"Forest Protocol (Navigation)","text":"<ul> <li>Canopy view: <code>plans/_forest.md</code> \u2014 forest health and active trees. Invoke via <code>concept.forest.manifest</code> (read) or <code>concept.forest.refine</code> (update with law_check).  </li> <li>Weekly dashboard: <code>docs/weekly-summary/index.html</code> \u2014 status snapshots. Surface via <code>time.forest.witness</code> (temporal view).  </li> <li>Accursed Share rotation: <code>void.forest.sip[entropy=0.05\u20130.10]</code> \u2014 pick dormant trees to spend exploration budget.</li> </ul> <p>\"The difference between a good system and a great one is the last 5%.\"</p>"},{"location":"systems-reference/","title":"Systems Reference \u2014 Built Infrastructure","text":"<p>\"Agents: these systems exist and are tested. Use them.\"</p> <p>This document inventories all production-ready infrastructure in kgents. When planning features, CHECK HERE FIRST before assuming you need to build something new.</p>"},{"location":"systems-reference/#data-bus-infrastructure-event-driven-communication","title":"Data Bus Infrastructure (Event-Driven Communication)","text":"<p>The Reactive Data Flow Backbone \u2014 Three-layer event bus architecture enabling agents to communicate without tight coupling.</p> Bus Location Scope Purpose DataBus <code>agents/d/bus.py</code> Single process D-gent storage events (PUT, DELETE, UPGRADE, DEGRADE) SynergyBus <code>protocols/synergy/bus.py</code> Cross-jewel Crown Jewel coordination (60+ event types) EventBus <code>agents/town/event_bus.py</code> Fan-out UI/streaming distribution with backpressure <pre><code># DataBus: React to storage operations\nfrom agents.d.bus import get_data_bus, DataEventType\n\nbus = get_data_bus()\nbus.subscribe(DataEventType.PUT, async_handler)\n\n# SynergyBus: Crown Jewel coordination\nfrom protocols.synergy import get_synergy_bus, create_analysis_complete_event\n\nsynergy = get_synergy_bus()\nawait synergy.emit(create_analysis_complete_event(...))\n\n# EventBus: Fan-out streaming\nfrom agents.town.event_bus import EventBus\n\nbus = EventBus[TownEvent](max_queue_size=1000)\nsub = bus.subscribe()\nasync for event in sub:\n    process(event)\n</code></pre> <p>Key Integrations: - <code>BusEnabledDgent</code> \u2014 Wraps D-gent to auto-emit events - <code>MgentBusListener</code> \u2014 Auto-indexes data as memories - <code>wire_data_to_synergy()</code> \u2014 Bridges DataBus \u2192 SynergyBus - <code>BusNode</code> \u2014 AGENTESE access via <code>self.bus.*</code></p> <p>AGENTESE Paths: - <code>self.bus.manifest</code> \u2014 Bus state overview - <code>self.bus.subscribe</code> \u2014 Subscribe to events - <code>self.bus.replay</code> \u2014 Catch up on missed events - <code>self.bus.latest</code> \u2014 Most recent event - <code>self.bus.stats</code> \u2014 Bus statistics</p> <p>Skills: <code>docs/skills/data-bus-integration.md</code></p>"},{"location":"systems-reference/#gardener-logos-new-2025-12-16","title":"Gardener-Logos (NEW 2025-12-16)","text":"<p>The Meta-Tending Substrate \u2014 Unifies The Gardener Crown Jewel with Prompt Logos into a single system for tending the garden of prompts.</p> Component Location Purpose Spec <code>spec/protocols/gardener-logos.md</code> Full specification Garden State <code>protocols/gardener_logos/garden.py</code> Seasons, metrics, unified state Tending Calculus <code>protocols/gardener_logos/tending.py</code> 6 verbs: observe, prune, graft, water, rotate, wait Plots <code>protocols/gardener_logos/plots.py</code> Named focus regions (crown jewels, plans) Personality <code>protocols/gardener_logos/personality.py</code> Joy layer, contextual greetings Meta-Tending <code>protocols/gardener_logos/meta/</code> Self-observation prompts ASCII Projection <code>protocols/gardener_logos/projections/ascii.py</code> CLI rendering <pre><code>from protocols.gardener_logos import (\n    create_garden, GardenSeason,\n    create_plot, create_crown_jewel_plots,\n    observe, prune, graft, water, rotate, wait,\n    TendingPersonality, default_personality,\n)\nfrom protocols.gardener_logos.projections import project_garden_to_ascii\n\ngarden = create_garden(name=\"my-project\", season=GardenSeason.SPROUTING)\ngarden.plots = create_crown_jewel_plots()\ngarden.add_gesture(observe(\"concept.prompt.*\"))\nprint(project_garden_to_ascii(garden))\n</code></pre> <p>AGENTESE Paths: - <code>concept.gardener.manifest</code> \u2014 Garden overview - <code>concept.gardener.tend</code> \u2014 Apply tending gestures - <code>concept.gardener.season.*</code> \u2014 Season operations - <code>concept.gardener.plot.*</code> \u2014 Plot management - <code>concept.prompt.*</code> \u2014 Prompt Logos (delegated)</p>"},{"location":"systems-reference/#differance-engine-ghost-heritage-tracing","title":"Diff\u00e9rance Engine (Ghost Heritage Tracing)","text":"<p>The Self-Knowing System \u2014 Every output carries trace of what it IS and what it ALMOST WAS (ghosts).</p> Component Location Purpose TraceMonoid <code>agents/differance/trace.py</code> Monoidal composition of wiring decisions with ghost preservation DifferanceStore <code>agents/differance/store.py</code> Append-only trace persistence via D-gent TRACED_OPERAD <code>agents/differance/operad.py</code> Extends AGENT_OPERAD with traced composition DifferanceIntegration <code>agents/differance/integration.py</code> Crown Jewel integration (fire-and-forget traces) GhostHeritageDAG <code>agents/differance/heritage.py</code> Graph of choices + alternatives <pre><code>from agents.differance import (\n    Alternative, WiringTrace, TraceMonoid,\n    DifferanceStore, DifferanceIntegration,\n    traced_seq, traced_par,\n)\n\n# Record a trace with alternatives (ghosts)\ntrace = WiringTrace(\n    operation=\"select_model\",\n    input_summary={\"query\": \"...\"},\n    output_summary={\"model\": \"claude-sonnet\"},\n    alternatives=[\n        Alternative(\n            operation=\"select_model\",\n            inputs={\"query\": \"...\"},\n            reason_rejected=\"Cost constraint\",\n            could_revisit=True,\n        )\n    ],\n)\n\n# Store via D-gent\nstore = DifferanceStore(dgent_instance)\nawait store.append(trace)\n\n# Reconstruct monoid from storage\nmonoid = await store.to_monoid()\nghosts = monoid.ghosts  # All alternatives considered\n</code></pre> <p>AGENTESE Paths: - <code>time.differance.recent</code> \u2014 Recent traces (limit=20) - <code>time.differance.why</code> \u2014 Explain why a decision was made - <code>time.differance.at</code> \u2014 Get trace at specific timestamp - <code>time.branch.create</code> \u2014 Create speculative branch - <code>time.branch.explore</code> \u2014 Explore ghost alternative</p> <p>Laws Verified (property-based tests): - Identity: <code>\u03b5 \u2297 T = T = T \u2297 \u03b5</code> - Associativity: <code>(A \u2297 B) \u2297 C = A \u2297 (B \u2297 C)</code> - Ghost Preservation: <code>ghosts(a \u2297 b) \u2287 ghosts(a) \u222a ghosts(b)</code> - Semantic Preservation: traced operations preserve base behavior</p> <p>Key Insight: \"The ghost heritage graph is the UI innovation: seeing what almost was alongside what is.\"</p>"},{"location":"systems-reference/#witness-crown-jewel-8th-jewel-autonomous-agency","title":"Witness Crown Jewel (8th Jewel \u2014 Autonomous Agency)","text":"<p>Kent's Developer Agency, Crystallized \u2014 Event-driven daemon with trust-gated capabilities.</p> Component Location Purpose WitnessPolynomial <code>services/witness/polynomial.py</code> Trust-gated state machine (L0\u2192L3) WITNESS_OPERAD <code>services/witness/operad.py</code> Extends AGENT_OPERAD with witness operations GitWatcher <code>services/witness/watchers/git.py</code> Event-driven Git observation (no timers!) WitnessNode <code>services/witness/node.py</code> AGENTESE registration (pending) <pre><code>from services.witness import (\n    WitnessPolynomial, WitnessState, TrustLevel,\n    WITNESS_OPERAD, GitWatcher,\n)\n\n# Trust levels gate capabilities\npoly = WitnessPolynomial(initial_trust=TrustLevel.L0)\n\n# L0: Observe only (suggest, no action)\n# L1: Read + non-destructive (run tests, lint)\n# L2: Write + reversible (git commit, but no push)\n# L3: Full Kent (push, PR, invoke any Crown Jewel)\n\n# Event-driven watching (Flux lifting, no timers)\nwatcher = GitWatcher(repo_path=\"/path/to/repo\")\nasync for event in watcher.watch():\n    # event: FileChanged | CommitCreated | BranchSwitched\n    await process_event(event)\n</code></pre> <p>Trust Level Semantics: | Level | Name | Capabilities | Example Actions | |-------|------|-------------|-----------------| | L0 | Observer | Suggest only | \"I notice tests are failing\" | | L1 | Reader | Non-destructive | Run pytest, mypy, lint | | L2 | Writer | Reversible writes | git commit, file edits | | L3 | Kent | Full autonomy | git push, create PR, invoke any jewel |</p> <p>Key Insight: \"At Trust Level 3, Witness can do everything Kent does\u2014tests, fixes, commits, PRs.\"</p>"},{"location":"systems-reference/#categorical-foundation-use-for-any-domain","title":"Categorical Foundation (USE FOR ANY DOMAIN)","text":"Component Location Purpose Tests PolyAgent <code>agents/poly/</code> State-dependent agents: <code>PolyAgent[S, A, B]</code> 200+ Operad <code>agents/operad/</code> Composition grammar with law verification 150+ Sheaf <code>agents/sheaf/</code> Emergence from local sections 100+ <pre><code># PolyAgent: State machines with mode-dependent behavior\nfrom agents.poly import PolyAgent, MANIFEST, WITNESS, SIP\npoly = PolyAgent(initial_state, directions_fn, transition_fn)\n\n# Operad: Programmable composition grammar\nfrom agents.operad import AGENT_OPERAD, SOUL_OPERAD\nSOUL_OPERAD.verify_laws()  # Proves composition is valid\n\n# Sheaf: Emergence from local views\nfrom agents.sheaf import KENT_SOUL, query_soul\nresult = query_soul(\"aesthetic\", query)  # Gets local soul response\n</code></pre>"},{"location":"systems-reference/#agentese-verb-first-ontology","title":"AGENTESE (Verb-First Ontology)","text":"Phase Module Exports Core <code>protocols/agentese/logos.py</code> <code>Logos</code>, <code>create_logos</code> Parser <code>protocols/agentese/parser.py</code> <code>PathParser</code>, <code>parse_path</code>, <code>ParsedPath</code> Affordances <code>protocols/agentese/affordances.py</code> <code>AffordanceRegistry</code>, <code>ArchetypeDNA</code> JIT <code>protocols/agentese/jit.py</code> <code>JITCompiler</code>, <code>compile_spec</code> Laws <code>protocols/agentese/laws.py</code> <code>CategoryLawVerifier</code>, <code>compose</code>, <code>pipe</code> Wiring <code>protocols/agentese/wiring.py</code> <code>WiredLogos</code>, <code>create_wired_logos</code> Adapter <code>protocols/agentese/adapter.py</code> <code>AgentesAdapter</code>, <code>PatternTranslator</code> <pre><code>from protocols.agentese import (\n    Logos, create_logos, parse_path,\n    AffordanceRegistry, create_wired_logos\n)\n\n# Create wired logos with all resolvers\nlogos = create_wired_logos()\n\n# Invoke AGENTESE path\nresult = await logos.invoke(\"world.house.manifest\", umwelt)\n\n# Parse path for introspection\nparsed = parse_path(\"self.memory.witness[phase=DEVELOP]\")\n</code></pre>"},{"location":"systems-reference/#flux-stream-processing","title":"Flux (Stream Processing)","text":"Component Purpose <code>FluxAgent</code> Wrapped agent with stream capabilities <code>FluxFunctor</code> Lifts discrete \u2192 continuous <code>FluxPipeline</code> Chain of flux agents <code>Perturbation</code> Inject events into running flow <pre><code>from agents.flux import Flux, FluxConfig, FluxPipeline\n\n# Lift any agent to flux domain\nflux_agent = Flux.lift(discrete_agent)\n\n# Create pipeline\npipeline = flux_a | flux_b | flux_c\n\n# Process stream\nasync for result in flux_agent.start(source):\n    process(result)\n</code></pre>"},{"location":"systems-reference/#f-gent-flow-conversational-modalities","title":"F-gent Flow (Conversational Modalities)","text":"<p>NEW 2025-12-16 \u2014 Chat, Research, and Collaboration substrates.</p> Component Purpose <code>ChatFlow</code> Turn-based conversation with context management <code>ResearchFlow</code> Tree of thought exploration <code>CollaborationFlow</code> Multi-agent blackboard patterns <code>FLOW_POLYNOMIAL</code> Mode-dependent flow behavior <code>FLOW_OPERAD</code> 13 composition operations <pre><code>from agents.f import (\n    ChatFlow, Turn, ChatConfig,\n    ResearchFlow, HypothesisTree,\n    CollaborationFlow, Blackboard,\n    FLOW_POLYNOMIAL, FLOW_OPERAD, FlowState,\n)\n\n# Chat modality (requires agent)\nchat = ChatFlow(agent=my_agent, config=ChatConfig(context_window=128000))\nresponse = await chat.send_message(\"Hello!\")\n\n# Research modality\nresearch = ResearchFlow(agent=my_agent)\nawait research.branch(\"Hypothesis: X causes Y\")\nsynthesis = await research.synthesize()\n\n# Collaboration modality\ncollab = CollaborationFlow(agents={\"a\": agent_a, \"b\": agent_b})\nawait collab.post(agent_id=\"a\", content=\"My idea\", type=\"idea\")\n</code></pre> <p>AGENTESE Paths: - <code>self.flow.state</code> \u2014 Current flow state - <code>self.flow.modality</code> \u2014 Active modality (chat/research/collaboration) - <code>self.flow.chat.*</code> \u2014 Chat operations (context, history, turn) - <code>self.flow.research.*</code> \u2014 Research operations (tree, branch, synthesize) - <code>self.flow.collaboration.*</code> \u2014 Collaboration operations (board, post, vote)</p> <p>Note: Flow (conversational modalities) is distinct from Flux (stream processing).</p>"},{"location":"systems-reference/#agent-town-multi-agent-simulation","title":"Agent Town (Multi-Agent Simulation)","text":"Component Purpose <code>CitizenPolynomial</code> Citizen state machine <code>TOWN_OPERAD</code> Interaction grammar <code>TownFlux</code> Simulation loop <code>DialogueEngine</code> LLM-backed citizen dialogue <code>InhabitSession</code> Player inhabits citizen <pre><code>from agents.town import (\n    Citizen, TownEnvironment, TownFlux,\n    TOWN_OPERAD, CitizenPhase\n)\n\n# Create town\nenv = TownEnvironment(regions=[...])\nflux = TownFlux(env, citizens=[...])\n\n# Run simulation\nasync for event in flux.run():\n    process(event)\n</code></pre>"},{"location":"systems-reference/#k-gent-soulgovernance","title":"K-gent (Soul/Governance)","text":"Component Purpose <code>KgentSoul</code> Middleware of consciousness <code>KgentFlux</code> Soul streaming <code>HypnagogicCycle</code> Dream/consolidation <code>SemanticGatekeeper</code> Principle enforcement <code>PersonaGarden</code> Pattern storage <code>SoulSession</code> Cross-session identity <pre><code>from agents.k import (\n    soul, create_soul, KgentFlux,\n    SemanticGatekeeper, validate_content\n)\n\n# Quick dialogue\nresponse = soul.dialogue(\"What do you believe?\", mode=\"reflect\")\n\n# Validate content against principles\nresult = validate_content(code, file_path)\n</code></pre>"},{"location":"systems-reference/#m-gent-memory","title":"M-gent (Memory)","text":"Component Purpose <code>HolographicMemory</code> Core memory with compression <code>MemoryCrystal</code> Pattern storage with degradation <code>CartographerAgent</code> Generate HoloMaps <code>PheromoneField</code> Stigmergic coordination <code>SemanticRouter</code> Memory routing <code>SharedSubstrate</code> Multi-agent memory <pre><code>from agents.m import (\n    HolographicMemory, MemoryCrystal,\n    create_semantic_router, SharedSubstrate\n)\n\n# Create memory with budget\nmemory = HolographicMemory(compression_level=3)\n\n# Semantic routing\nrouter = create_semantic_router(providers=[...])\nresult = await router.route(query)\n</code></pre>"},{"location":"systems-reference/#reactive-substrate-widgets","title":"Reactive Substrate (Widgets)","text":"Component Purpose <code>Signal[T]</code> Observable state <code>Computed[T]</code> Derived state <code>Effect</code> Side effects <code>KgentsWidget[S]</code> Base widget class <code>HStack/VStack</code> Composition containers <pre><code>from agents.i.reactive import (\n    Signal, Computed, Effect,\n    AgentCardWidget, AgentCardState,\n    HStack, VStack\n)\n\n# Create widget\ncard = AgentCardWidget(AgentCardState(\n    name=\"Agent\", phase=\"active\", capability=0.85\n))\n\n# Project to any target\ncard.to_cli()      # Terminal\ncard.to_marimo()   # Notebook\ncard.to_json()     # API\n</code></pre>"},{"location":"systems-reference/#3d-projection-primitives-threejs","title":"3D Projection Primitives (Three.js)","text":"<p>Unified 3D visualization system for topology graphs with theme-parameterized rendering.</p> Component Location Purpose <code>TopologyNode3D</code> <code>web/src/components/three/primitives/</code> Generic 3D node with theme slots <code>TopologyEdge3D</code> <code>web/src/components/three/primitives/</code> Generic 3D edge (curved/straight) <code>SelectionRing</code> <code>web/src/components/three/primitives/</code> Reusable selection indicator <code>HoverRing</code> <code>web/src/components/three/primitives/</code> Reusable hover indicator <code>FlowParticle</code> <code>web/src/components/three/primitives/</code> Animated flow particles <code>NodeLabel3D</code> <code>web/src/components/three/primitives/</code> 3D text labels <code>GrowthRings</code> <code>web/src/components/three/primitives/</code> Concentric ring indicators Themes <code>web/src/components/three/primitives/themes/</code> Crystal (Brain), Forest (Gestalt) Animation <code>web/src/components/three/primitives/animation.ts</code> Breathing, hover, selection presets <pre><code>import {\n  TopologyNode3D, TopologyEdge3D,\n  CRYSTAL_THEME, FOREST_THEME,\n  ANIMATION_PRESETS\n} from '@/components/three/primitives';\n\n// Generic node with crystal theme (Brain)\n&lt;TopologyNode3D\n  position={[x, y, z]}\n  theme={CRYSTAL_THEME}\n  data={node}\n  getTier={(n) =&gt; getResolutionTier(n)}\n  getSize={(n, d) =&gt; calculateSize(n, d)}\n  isSelected={isSelected}\n  density={density}\n  onClick={handleClick}\n/&gt;\n\n// Generic edge with forest theme (Gestalt)\n&lt;TopologyEdge3D\n  source={sourcePos}\n  target={targetPos}\n  theme={FOREST_THEME}\n  strength={0.8}\n  showFlowParticles={isActive}\n/&gt;\n</code></pre> <p>Architecture: <code>P[3D] : State x Theme x Quality -&gt; Scene</code></p> <p>Quality Levels: <code>minimal</code> | <code>standard</code> | <code>high</code> | <code>cinematic</code></p> <p>AGENTESE Paths: - <code>concept.projection.three.node.manifest</code> \u2014 Node primitive config - <code>concept.projection.three.edge.manifest</code> \u2014 Edge primitive config - <code>concept.projection.three.theme.list</code> \u2014 Available themes - <code>concept.projection.three.quality.adapt</code> \u2014 Quality adaptation</p> <p>Skills: <code>docs/skills/3d-projection-patterns.md</code></p>"},{"location":"systems-reference/#elastic-primitives-responsive-layout","title":"Elastic Primitives (Responsive Layout)","text":"Component Location Purpose <code>ElasticContainer</code> <code>web/src/components/elastic/</code> Self-arranging grid/stack/flow layouts <code>ElasticCard</code> <code>web/src/components/elastic/</code> Priority-aware cards with content degradation <code>ElasticSplit</code> <code>web/src/components/elastic/</code> Two-pane layout, collapses at 768px <code>ElasticPlaceholder</code> <code>web/src/components/elastic/</code> Loading/empty/error states <code>useWindowLayout</code> <code>web/src/hooks/useLayoutContext.ts</code> Window-level density/breakpoint info <code>useLayoutMeasure</code> <code>web/src/hooks/useLayoutContext.ts</code> Container-level size measurement <code>WidgetLayoutHints</code> <code>web/src/reactive/types.ts</code> Layout metadata for widgets <pre><code>import { ElasticContainer, ElasticSplit, ElasticCard } from '@/components/elastic';\nimport { useWindowLayout } from '@/hooks/useLayoutContext';\n\n// Get density context\nconst { density, isMobile, isTablet, isDesktop } = useWindowLayout();\n// density: 'compact' | 'comfortable' | 'spacious'\n\n// Self-arranging grid\n&lt;ElasticContainer layout=\"grid\" minItemWidth={200}&gt;\n  {widgets.map(w =&gt; &lt;ElasticCard key={w.id} priority={w.priority} {...w} /&gt;)}\n&lt;/ElasticContainer&gt;\n\n// Two-pane with collapse\n&lt;ElasticSplit\n  direction=\"horizontal\"\n  defaultRatio={0.7}\n  collapseAt={768}\n  resizable={isDesktop}\n  primary={&lt;MainPanel density={density} /&gt;}\n  secondary={&lt;Sidebar density={density} /&gt;}\n/&gt;\n</code></pre> <p>Key Insight: Density-Content Isomorphism \u2014 pass <code>density</code> down, let components decide what it means.</p> <p>Breakpoints: - 640px (sm/compact) \u2014 Mobile, drawers, touch targets - 768px (md) \u2014 ElasticSplit collapse threshold - 1024px (lg/spacious) \u2014 Full desktop layout</p> <p>Content Levels: icon (&lt;60px), title (&lt;150px), summary (&lt;280px), full (\u2265400px)</p> <p>Tests: 32+ (17 chaos, 10 performance, 15+ E2E visual regression)</p> <p>Skills: <code>docs/skills/elastic-ui-patterns.md</code>, <code>docs/skills/ui-isomorphism-detection.md</code></p>"},{"location":"systems-reference/#projection-gallery","title":"Projection Gallery","text":"Component Location Purpose <code>Pilot</code> <code>protocols/projection/gallery/pilots.py</code> Pre-configured widget demo <code>Gallery</code> <code>protocols/projection/gallery/runner.py</code> Render orchestrator <code>GalleryOverrides</code> <code>protocols/projection/gallery/overrides.py</code> Override injection <code>GalleryAPI</code> <code>protocols/api/gallery.py</code> REST endpoints <code>GalleryPage</code> <code>web/src/pages/GalleryPage.tsx</code> React frontend <pre><code>from protocols.projection.gallery import Gallery, GalleryOverrides, PILOT_REGISTRY\n\n# CLI gallery\ngallery = Gallery()\ngallery.show_all(target=RenderTarget.CLI)  # All 25 pilots\ngallery.show(\"agent_card_active\", overrides={\"entropy\": 0.5})\n\n# With global overrides\ngallery = Gallery(GalleryOverrides(entropy=0.3, seed=42))\n</code></pre> <p>Web Gallery: <code>http://localhost:3000/gallery</code></p> <p>API Endpoints: - <code>GET /api/gallery</code> - All pilots with projections - <code>GET /api/gallery/{name}</code> - Single pilot - <code>GET /api/gallery/categories</code> - Category metadata</p>"},{"location":"systems-reference/#n-phase-compiler","title":"N-Phase Compiler","text":"Component Purpose <code>NPhasePromptCompiler</code> YAML \u2192 prompt <code>ProjectDefinition</code> Schema for projects <code>NPhaseStateUpdater</code> Track phase progress <pre><code>from protocols.nphase import (\n    compiler, ProjectDefinition,\n    NPhaseStateUpdater, state_updater\n)\n\n# Compile from YAML\nprompt = compiler.compile_from_yaml_file(\"project.yaml\")\n\n# Track state\nupdater = state_updater(project)\nstate = updater.advance_phase(\"DEVELOP\", outputs)\n</code></pre>"},{"location":"systems-reference/#evergreen-prompt-system-self-cultivating-claudemd","title":"Evergreen Prompt System (Self-Cultivating CLAUDE.md)","text":"Component Location Purpose <code>PromptCompiler</code> <code>protocols/prompt/compiler.py</code> Section-based CLAUDE.md compilation <code>PromptM</code> <code>protocols/prompt/monad.py</code> Prompt Monad with unit/bind/map <code>SoftSection</code> <code>protocols/prompt/soft_section.py</code> Rigidity spectrum (0.0-1.0) <code>RollbackRegistry</code> <code>protocols/prompt/rollback/</code> Full history with instant rollback CLI <code>protocols/prompt/cli.py</code> compile, history, rollback, diff <pre><code>from protocols.prompt import (\n    PromptCompiler, CompilationContext,\n    PromptM, Source, sequence,\n    RollbackRegistry, get_default_registry\n)\nfrom protocols.prompt.sections import get_default_compilers\n\n# Compile CLAUDE.md\ncompiler = PromptCompiler(section_compilers=get_default_compilers(), version=1)\ncontext = CompilationContext(project_root=Path(\"/path/to/project\"))\nresult = compiler.compile(context)\n\n# Use PromptM monad for composable transformations\nsection = Section(name=\"test\", content=\"hello\", token_cost=5, required=True)\ntransformed = (\n    PromptM.unit(section)\n    .with_provenance(Source.TEMPLATE)\n    .map(lambda s: s.with_content(s.content.upper()))\n    .with_trace(\"Uppercased content\")\n)\n\n# Checkpoint and rollback\nregistry = get_default_registry()\ncheckpoint_id = registry.checkpoint(\n    before_content=\"old\",\n    after_content=\"new\",\n    before_sections=(),\n    after_sections=(),\n    reason=\"Test change\"\n)\nresult = registry.rollback(checkpoint_id)\n</code></pre> <p>CLI Commands: <pre><code># Compile with checkpoint\nuv run python -m protocols.prompt.cli compile --reason \"Update\"\n\n# View history\nuv run python -m protocols.prompt.cli history\n\n# Rollback\nuv run python -m protocols.prompt.cli rollback 26b96d66\n</code></pre></p> <p>Category Laws (verified with 216 tests): - Left Identity: <code>unit(x).bind(f) == f(x)</code> - Right Identity: <code>m.bind(unit) == m</code> - Associativity: <code>m.bind(f).bind(g) == m.bind(\u03bbx. f(x).bind(g))</code> - Rollback Invertibility: <code>rollback(checkpoint(p)).content == p</code></p>"},{"location":"systems-reference/#saas-infrastructure","title":"SaaS Infrastructure","text":""},{"location":"systems-reference/#api-protocolsapi","title":"API (<code>protocols/api/</code>)","text":"<pre><code>from protocols.api import create_app, GovernanceRequest\napp = create_app()  # FastAPI app with auth, routes, middleware\n</code></pre>"},{"location":"systems-reference/#billing-protocolsbilling","title":"Billing (<code>protocols/billing/</code>)","text":"<pre><code>from protocols.billing import (\n    StripeClient, CustomerManager, SubscriptionManager,\n    OpenMeterClient\n)\n</code></pre>"},{"location":"systems-reference/#licensing-protocolslicensing","title":"Licensing (<code>protocols/licensing/</code>)","text":"<pre><code>from protocols.licensing import (\n    LicenseTier, requires_tier, is_feature_enabled\n)\n\n@requires_tier(LicenseTier.PRO)\ndef pro_feature(): ...\n</code></pre>"},{"location":"systems-reference/#tenancy-protocolstenancy","title":"Tenancy (<code>protocols/tenancy/</code>)","text":"<pre><code>from protocols.tenancy import (\n    TenantContext, set_tenant_context, ApiKeyService\n)\n\nwith set_tenant_context(tenant_id):\n    # All queries scoped to tenant\n    ...\n</code></pre>"},{"location":"systems-reference/#terrarium-archived-superseded-by-agentese-universal-protocol","title":"Terrarium (ARCHIVED - Superseded by AGENTESE Universal Protocol)","text":"<p>Status: Archived 2025-12-17. See <code>protocols/_archived/terrarium-archived/README.md</code>.</p> <p>Superseded by: - AGENTESE Universal Gateway (<code>protocols/agentese/gateway.py</code>) - Auto-exposes nodes via HTTP/WebSocket - Synergy Event Bus (<code>protocols/synergy/bus.py</code>) - Cross-jewel communication</p> <p>Preserved in <code>agents/flux/</code>: - <code>HolographicBuffer</code> \u2192 <code>agents/flux/mirror.py</code> - <code>TerriumEvent</code>, <code>SemaphoreEvent</code> \u2192 <code>agents/flux/terrarium_events.py</code> - <code>SemanticMetricsCollector</code> \u2192 <code>agents/flux/semantic_metrics.py</code></p>"},{"location":"systems-reference/#infra-kubernetes","title":"Infra (Kubernetes)","text":"Directory Purpose <code>infra/k8s/manifests/</code> Kubernetes YAMLs <code>infra/k8s/images/</code> Dockerfiles <code>infra/k8s/scripts/</code> Setup scripts <code>infra/cortex/</code> Agent orchestration <code>infra/morpheus/</code> Dream infrastructure"},{"location":"systems-reference/#key-import-patterns","title":"Key Import Patterns","text":"<pre><code># Categorical foundation\nfrom agents.poly import PolyAgent, MANIFEST, WITNESS\nfrom agents.operad import AGENT_OPERAD, Operation\nfrom agents.sheaf import KENT_SOUL, query_soul\n\n# Stream processing\nfrom agents.flux import Flux, FluxPipeline\n\n# AGENTESE\nfrom protocols.agentese import Logos, create_wired_logos, parse_path\n\n# Reactive\nfrom agents.i.reactive import Signal, Computed, KgentsWidget\n\n# Town\nfrom agents.town import Citizen, TownFlux, TOWN_OPERAD\n\n# Soul\nfrom agents.k import soul, KgentFlux, SemanticGatekeeper\n\n# Memory\nfrom agents.m import HolographicMemory, MemoryCrystal, SemanticRouter\n\n# Data Bus (event-driven communication)\nfrom agents.d.bus import (\n    DataBus, DataEvent, DataEventType,\n    BusEnabledDgent, get_data_bus\n)\nfrom protocols.synergy import (\n    get_synergy_bus, SynergyEventType, Jewel,\n    create_analysis_complete_event, create_crystal_formed_event\n)\nfrom agents.town.event_bus import EventBus, Subscription\n\n# SaaS\nfrom protocols.api import create_app\nfrom protocols.billing import StripeClient\nfrom protocols.licensing import requires_tier\nfrom protocols.tenancy import set_tenant_context\n</code></pre> <p>Last updated: 2025-12-19</p>"},{"location":"creative/","title":"kgents Creative Direction","text":"<p>\"The aesthetic is not decoration\u2014it is the projection of principles into perception.\"</p> <p>Status: Foundation Document Last Updated: 2025-12-17 Authors: Kent + Claude (collaborative authorship) Aligned With: AD-006 (Unified Categorical Foundation), AD-009 (Metaphysical Fullstack)</p>"},{"location":"creative/#what-this-is","title":"What This Is","text":"<p>This directory contains the creative direction and art direction for kgents\u2014the aesthetic framework that translates our seven core principles into tangible, sensory experiences.</p> <p>This is not a style guide. Style guides tell you what colors to use. Creative direction tells you why\u2014and more importantly, how to feel.</p>"},{"location":"creative/#the-creative-thesis","title":"The Creative Thesis","text":""},{"location":"creative/#the-paradox-we-embrace","title":"The Paradox We Embrace","text":"<p>kgents occupies a rare position: rigorously mathematical yet warmly human. Category theory and Bataille. Polynomial functors and poetry. Sheaves and souls.</p> <p>Our aesthetic must embody this paradox:</p> Pole Expression Tension Resolution Rigorous Clean geometry, precise typography, verified laws Not sterile\u2014crystalline Playful Personality in loading states, celebratory moments, wit Not childish\u2014delightful Profound Depth in metaphor, weight in meaning, reverence for ideas Not pretentious\u2014earned Accessible Approachable entry points, no gatekeeping, warm errors Not dumbed-down\u2014welcoming"},{"location":"creative/#the-governing-metaphor-the-garden","title":"The Governing Metaphor: The Garden","text":"<p>kgents is a garden, not a factory. Gardens require: - Cultivation (care over time, not assembly) - Growth (organic emergence, not mechanical construction) - Seasons (entropy, decay, renewal\u2014the Accursed Share) - Biodiversity (many species, many personalities, heterarchy) - Stewardship (human agency preserved, never replaced)</p>"},{"location":"creative/#document-index","title":"Document Index","text":""},{"location":"creative/#primary-reference","title":"Primary Reference","text":"Document Purpose unified-vision.md START HERE \u2014 Distilled creative direction aligned with categorical foundation"},{"location":"creative/#foundation-documents","title":"Foundation Documents","text":"Document Purpose philosophy.md The deep why\u2014translating principles to aesthetics visual-system.md Colors, typography, iconography, spatial rhythm motion-language.md Animation principles, timing, personality in movement voice-and-tone.md Writing style, error messages, personality in words emergence-principles.md Generative algorithms, qualia space, cymatics implementation-guide.md Practical application for developers"},{"location":"creative/#archived","title":"Archived","text":"Document Status mood-board.md Superseded by unified-vision.md (kept for reference links)"},{"location":"creative/#related-specifications","title":"Related Specifications","text":"Spec Purpose plans/design-language-consolidation.md DESIGN_OPERAD \u2014 Three-operad composition system plans/autopoietic-architecture.md AD-006 (Unified Categorical), AD-008 (Isomorphisms), AD-009 (Fullstack) spec/protocols/projection.md Projection Protocol (density, targets) spec/protocols/agentese.md AGENTESE verb-first ontology docs/skills/elastic-ui-patterns.md Layout composition patterns docs/skills/ux-reference-patterns.md Cross-cutting UX patterns"},{"location":"creative/#the-categorical-foundation-ad-006","title":"The Categorical Foundation (AD-006)","text":"<p>\"The same categorical structure underlies everything. This is not coincidence\u2014it is the ground.\"</p> <p>Creative direction follows the same three-layer pattern as all kgents domains:</p> Layer Creative Application PolyAgent DESIGN_POLYNOMIAL \u2014 States: SKELETON \u2192 LOADING \u2192 PARTIAL \u2192 FULL \u2192 INTERACTIVE Operad DESIGN_OPERAD \u2014 Three sub-operads: LAYOUT, CONTENT, MOTION Sheaf ViewportCoherence, ContentConsistency, MotionHarmony <p>The Design Composition Theorem: <pre><code>UI = Layout[Density] \u2218 Content[Density] \u2218 Motion[ReducedMotion]\n</code></pre></p> <p>See <code>unified-vision.md</code> for the full articulation.</p>"},{"location":"creative/#the-seven-principles-aesthetically","title":"The Seven Principles, Aesthetically","text":"<p>Each kgents principle has an aesthetic counterpart:</p> Principle Aesthetic Expression Tasteful Restraint. White space. Every element earns its place. Curated Intentional selection. No visual noise. Considered hierarchy. Ethical Transparency in states. Honest affordances. Accessible to all. Joy-Inducing Personality in details. Celebration of success. Warmth in errors. Composable Modular visual components. Consistent spacing rhythm. Combinable elements. Heterarchical No fixed visual hierarchy. Contextual emphasis. Fluid focus. Generative Visual elements derivable from rules. Systematic, not arbitrary."},{"location":"creative/#quick-reference-the-feeling","title":"Quick Reference: The Feeling","text":"<p>When experiencing kgents, users should feel:</p> <ul> <li>Grounded \u2014 like sitting in a well-designed library</li> <li>Curious \u2014 like discovering a hidden garden path</li> <li>Capable \u2014 like being given exactly the right tool</li> <li>Delighted \u2014 like a small unexpected gift</li> <li>Respected \u2014 like talking to someone who assumes intelligence</li> </ul> <p>Users should never feel:</p> <ul> <li>Overwhelmed by feature density</li> <li>Confused by unclear states</li> <li>Patronized by over-explanation</li> <li>Alienated by cold technical language</li> <li>Anxious about making mistakes</li> </ul>"},{"location":"creative/#key-design-policies","title":"Key Design Policies","text":""},{"location":"creative/#no-emojis-in-kgents-copy","title":"No Emojis in kgents Copy","text":"<p>\"Emojis in copy are garnish. kgents is the main course.\"</p> <p>All kgents-authored text content uses Lucide icons, not emojis: - Navigation labels use icons - Buttons and actions use icons - Empty states use icons - Loading states use glyphs or icons</p> <p>Exceptions: User-generated content, explicit personality moments (sparingly).</p> <p>See <code>visual-system.md</code> for the JEWEL_ICONS mapping.</p>"},{"location":"creative/#os-shell-pattern","title":"OS Shell Pattern","text":"<p>The web interface is an operating system interface for autopoiesis, not a collection of pages: - Observer Drawer (top) \u2014 Always shows who is observing - Navigation Tree (sidebar) \u2014 AGENTESE ontology, not arbitrary routes - Terminal (bottom) \u2014 Direct gateway interaction with persistence - Content Canvas \u2014 Projection-first, minimal page logic</p> <p>See <code>spec/protocols/os-shell.md</code> for full specification.</p>"},{"location":"creative/#the-accursed-share-in-aesthetics","title":"The Accursed Share in Aesthetics","text":"<p>\"Everything is slop or comes from slop. We cherish and express gratitude.\"</p> <p>Our aesthetic has an entropy budget. Not everything needs to be perfectly polished. Some roughness is sacred:</p> <ul> <li>Loading states have personality (imperfection)</li> <li>Error messages have warmth (humanity)</li> <li>Transitions have organic timing (not mechanical)</li> <li>Empty states have character (invitation, not void)</li> </ul> <p>The garden has weeds. Some weeds are wildflowers.</p>"},{"location":"creative/#implementation-philosophy","title":"Implementation Philosophy","text":""},{"location":"creative/#for-designers","title":"For Designers","text":"<p>Think in principles, not pixels. Ask \"what should this feel like?\" before \"what should this look like?\"</p>"},{"location":"creative/#for-developers","title":"For Developers","text":"<p>The aesthetic is not optional. A component without personality is incomplete. Use the joy components (<code>Breathe</code>, <code>Shake</code>, <code>Shimmer</code>, <code>Pop</code>) intentionally.</p>"},{"location":"creative/#for-writers","title":"For Writers","text":"<p>Error messages are UX. Help text is design. Every word carries the brand.</p>"},{"location":"creative/#session-planning","title":"Session Planning","text":"<p>This creative direction will be implemented iteratively:</p> Session Focus Deliverables Session 1 (this) Foundation + Philosophy Core docs, mood board, principles mapping Session 2 Visual System Color palette, typography, spacing tokens Session 3 Motion Language Animation primitives, timing curves, interaction patterns Session 4 Component Audit Applying direction to existing components Session 5 Voice &amp; Tone Writing guidelines, error message patterns <p>\"The garden grows not by force, but by invitation.\"</p>"},{"location":"gallery/","title":"Gallery Service Specification","text":"<p>\"Show, don't tell. The gallery is where agents reveal themselves.\"</p> <p>Status: Future (agent-native service) Agent Genus: I-gent (visualization) AGENTESE Path: <code>self.gallery.*</code></p>"},{"location":"gallery/#purpose","title":"Purpose","text":"<p>The Gallery is an agent-native service that provides interactive, explorable demonstrations of kgents capabilities. Unlike static documentation, the Gallery:</p> <ol> <li>Runs live agents \u2014 Demos execute actual agent code</li> <li>Adapts to observer \u2014 Different users see different affordances</li> <li>Generates from operad \u2014 Gallery items derive from <code>SOUL_OPERAD</code>, <code>PARSE_OPERAD</code>, etc.</li> <li>Teaches through use \u2014 Progressive disclosure from simple to complex</li> </ol>"},{"location":"gallery/#philosophy","title":"Philosophy","text":"<p>\"An agent is a morphism A \u2192 B. Everything else is added via Halo.\"</p> <p>The Gallery demonstrates kgents' core principles:</p> <ul> <li>Composability: Agents are morphisms that compose predictably</li> <li>Functors: Lift agents to new contexts (Maybe, Flux, etc.)</li> <li>Personality: Soul governance ensures aligned responses</li> <li>Tasteful design: Quality over quantity, always</li> </ul>"},{"location":"gallery/#featured-examples","title":"Featured Examples","text":"Demo Description Hello World Your first agent - learn the fundamental <code>Agent[A, B]</code> pattern Composition Chain agents with <code>&gt;&gt;</code> - category theory in action Functors Handle optional values with the Maybe functor Soul Dialogue Chat with K-gent, Kent's digital simulacra Streaming Transform discrete agents into continuous processors with Flux Custom Archetype Build production-ready agents with Kappa"},{"location":"gallery/#quick-start","title":"Quick Start","text":"<pre><code># Clone the repo\ngit clone https://github.com/kentgang/kgents.git\ncd kgents\n\n# Install dependencies\npip install -e .\n\n# Interactive tutorials\nkgents play hello        # Start with hello world\nkgents play compose      # Learn composition\nkgents play functor      # Explore functors\nkgents play soul         # Meet K-gent\n</code></pre>"},{"location":"gallery/#learning-path","title":"Learning Path","text":"<ol> <li>Hello World \u2014 Understand the <code>Agent[A, B]</code> pattern</li> <li>Composition \u2014 Learn to chain agents with <code>&gt;&gt;</code></li> <li>Functors \u2014 Handle edge cases elegantly</li> <li>Soul Dialogue \u2014 Add personality to your agents</li> <li>Streaming \u2014 Process continuous flows</li> <li>Custom Archetype \u2014 Build production systems</li> </ol>"},{"location":"gallery/#agentese-integration","title":"AGENTESE Integration","text":"Path Purpose Returns <code>self.gallery.manifest</code> Get gallery view for observer <code>GalleryView</code> <code>self.gallery.demo</code> Run a specific demo <code>DemoResult</code> <code>self.gallery.tour</code> Start guided tour <code>TourSession</code> <code>self.gallery.catalog</code> List all available demos <code>list[DemoSpec]</code>"},{"location":"gallery/#observer-dependent-views","title":"Observer-Dependent Views","text":"<pre><code># New user: simple demos, progressive complexity\nawait logos.invoke(\"self.gallery.manifest\", novice_umwelt)\n# \u2192 Shows: Hello World, Basic Composition, First Functor\n\n# Expert user: full catalog, advanced patterns\nawait logos.invoke(\"self.gallery.manifest\", expert_umwelt)\n# \u2192 Shows: Polynomial Agents, Operad Composition, Sheaf Gluing\n</code></pre>"},{"location":"gallery/#demo-categories","title":"Demo Categories","text":""},{"location":"gallery/#by-complexity","title":"By Complexity","text":"Level Description Examples 1. Hello World First agent <code>Id</code>, simple <code>invoke()</code> 2. Composition Two agents combined <code>Ground &gt;&gt; Judge</code> 3. Functors Lifted agents <code>Maybe(agent)</code>, <code>Fix(agent)</code> 4. Polynomial State machines <code>SOUL_POLYNOMIAL</code> 5. Operad Grammar composition <code>SOUL_OPERAD.compose(...)</code> 6. Emergence Sheaf gluing <code>KENT_SOUL</code> from local agents"},{"location":"gallery/#by-agent-genus","title":"By Agent Genus","text":"Genus Demo One-Liner K-gent Soul Vibe Eigenvector mood K-gent Soul Shadow Jungian analysis H-gent Dialectic Synthesize thesis + antithesis P-gent Parse Universal parser with confidence J-gent Reality Classify DET/PROB/CHAOTIC"},{"location":"gallery/#demo-specification","title":"Demo Specification","text":"<pre><code>@dataclass\nclass DemoSpec:\n    \"\"\"Specification for a gallery demo.\"\"\"\n    id: str                      # Unique identifier\n    name: str                    # Display name\n    one_liner: str               # What it does in one sentence\n    genus: str                   # Agent genus (K, H, P, J, etc.)\n    complexity: int              # 1-6 scale\n    operad_operation: str | None # If derived from operad\n\n    # Content\n    description: str             # Full description\n    code_example: str            # Runnable Python code\n    expected_output: str         # What user should see\n\n    # Affordances\n    interactive: bool            # Can user modify inputs?\n    streaming: bool              # Shows real-time updates?\n    prerequisites: list[str]     # Demo IDs to complete first\n</code></pre>"},{"location":"gallery/#generation-from-operad","title":"Generation from Operad","text":"<p>Demos derive from operad operations (AD-003: Generative Over Enumerative):</p> <pre><code>def generate_demos_from_operad(operad: Operad) -&gt; list[DemoSpec]:\n    \"\"\"Generate gallery demos from operad operations.\"\"\"\n    demos = []\n    for op_name, operation in operad.operations.items():\n        demo = DemoSpec(\n            id=f\"{operad.name.lower()}-{op_name}\",\n            name=f\"{operad.name} {op_name.title()}\",\n            one_liner=operation.signature,\n            genus=infer_genus(operad),\n            complexity=infer_complexity(operation),\n            # ...\n        )\n        demos.append(demo)\n    return demos\n</code></pre>"},{"location":"gallery/#success-criteria","title":"Success Criteria","text":"Criterion Target Time to first demo &lt; 30 seconds Demos available 20+ (10 generated) Tour completion rate &gt; 50% User satisfaction \"Wow\" on first run"},{"location":"gallery/#references","title":"References","text":"<ul> <li><code>protocols/projection/gallery/</code> \u2014 Projection Gallery implementation</li> <li><code>crown-jewels.md</code> \u2014 Demo content source</li> <li><code>spec/i-gents/</code> \u2014 Visualization specs</li> </ul> <p>\"The best system teaches through use, not through documentation.\"</p>"},{"location":"skills/","title":"Agent Skills Directory","text":"<p>\"13 skills are necessary and sufficient to build any kgents component.\"</p> <p>READ SKILLS FIRST. Every task has a corresponding skill. Before writing code, find the right skill\u2014it will save you hours.</p>"},{"location":"skills/#universal-skills-start-here","title":"\ud83c\udf1f Universal Skills (Start Here)","text":"<p>These four skills apply to virtually ANY work you'll do:</p> Skill When to Use Lines metaphysical-fullstack Building any feature\u2014the core architecture pattern 320 crown-jewel-patterns Implementing service logic (14 battle-tested patterns) 850 test-patterns Writing any tests (T-gent Types I-V, property-based, React chaos) 1250 elastic-ui-patterns Any responsive UI (three-mode pattern, density constants) 330"},{"location":"skills/#by-task-type","title":"By Task Type","text":"Task Skills to Read Adding new agent <code>polynomial-agent.md</code>, <code>building-agent.md</code> Exposing via AGENTESE <code>agentese-node-registration.md</code>, <code>agentese-path.md</code> Service/Crown Jewel <code>crown-jewel-patterns.md</code>, <code>metaphysical-fullstack.md</code> Event-driven feature <code>data-bus-integration.md</code> Multi-target rendering <code>projection-target.md</code>, <code>elastic-ui-patterns.md</code> Writing specs <code>spec-template.md</code>, <code>spec-hygiene.md</code> Planning work <code>plan-file.md</code>"},{"location":"skills/#full-skill-index","title":"Full Skill Index","text":""},{"location":"skills/#foundation-categorical-ground","title":"Foundation (Categorical Ground)","text":"Skill Purpose polynomial-agent State machines with mode-dependent inputs (PolyAgent[S,A,B]) building-agent Agent[A,B] composition, functors, D-gent memory patterns"},{"location":"skills/#protocol-agentese","title":"Protocol (AGENTESE)","text":"Skill Purpose agentese-path Adding paths to the five contexts agentese-node-registration @node decorator, discovery, BE/FE type sync"},{"location":"skills/#architecture-vertical-slice","title":"Architecture (Vertical Slice)","text":"Skill Purpose crown-jewel-patterns 14 patterns: Container-Owns-Workflow, Signal Aggregation, Teaching Mode... metaphysical-fullstack AD-009 stack\u2014AGENTESE IS the API, no explicit routes data-bus-integration DataBus, SynergyBus, EventBus patterns"},{"location":"skills/#process-n-phase","title":"Process (N-Phase)","text":"Skill Purpose plan-file Forest Protocol YAML headers, chunks, status lifecycle spec-template Writing generative specs (200-400 lines) spec-hygiene 7 bloat patterns to avoid, 5 compression patterns"},{"location":"skills/#projection-multi-target","title":"Projection (Multi-Target)","text":"Skill Purpose projection-target Custom targets (CLI/TUI/JSON/marimo/WebGL) test-patterns T-gent Types I-V, Hypothesis, chaos testing, performance baselines elastic-ui-patterns Three-mode (Compact/Comfortable/Spacious), content degradation"},{"location":"skills/#the-skill-composition-formula","title":"The Skill Composition Formula","text":"<pre><code>Component = Foundation \u2218 Protocol \u2218 Architecture \u2218 Process \u2218 Projection\n          = (polynomial-agent + building-agent)\n          \u2218 (agentese-path + agentese-node-registration)\n          \u2218 (crown-jewel-patterns + metaphysical-fullstack + data-bus-integration)\n          \u2218 (plan-file + spec-template + spec-hygiene)\n          \u2218 (projection-target + test-patterns + elastic-ui-patterns)\n</code></pre>"},{"location":"skills/#archived-skills","title":"Archived Skills","text":"<p>Extended skills archived to <code>docs/_archive/2025-12-18-consolidation/</code>. Restore if needed: - agent-town-archetypes, flux-agent, reactive-primitives - agentese-contract-protocol, frontend-contracts - gardener-logos, specgraph-workflow, turn-projectors</p> <p>Consolidated: 2025-12-18 | Skills: 13 active | Skills-First Edition</p>"},{"location":"skills/3d-projection-patterns/","title":"3D Projection Patterns","text":"<p>\"The same categorical structure underlies everything. Three.js scenes are no exception.\"</p> <p>This skill covers 3D visualization patterns using the unified primitive system.</p>"},{"location":"skills/3d-projection-patterns/#the-core-abstraction","title":"The Core Abstraction","text":"<pre><code>P[3D] : State x Theme x Quality -&gt; Three.js Scene\n</code></pre> <p>All 3D visualizations in kgents follow this functor pattern: - State: Domain data (nodes, edges, metrics) - Theme: Visual identity (crystal, forest) - Quality: Device capability (minimal -&gt; cinematic)</p> <p>The result is a composed Three.js scene with consistent behavior.</p>"},{"location":"skills/3d-projection-patterns/#when-to-use-what","title":"When to Use What","text":"Scenario Use This Why Building new 3D visualization <code>TopologyNode3D</code>, <code>TopologyEdge3D</code> Full control, theme-agnostic Memory/Brain features <code>OrganicCrystal</code>, <code>CrystalVine</code> Pre-configured with crystal theme Codebase/Gestalt features <code>OrganicNode</code>, <code>VineEdge</code> Pre-configured with forest theme Custom domain visualization Create thin wrapper Encapsulates tier/size logic <p>Rule: Domain wrappers are thin. All logic lives in primitives.</p>"},{"location":"skills/3d-projection-patterns/#using-primitives-directly","title":"Using Primitives Directly","text":""},{"location":"skills/3d-projection-patterns/#topologynode3d","title":"TopologyNode3D","text":"<pre><code>import { TopologyNode3D, CRYSTAL_THEME } from '@/components/three/primitives';\n\nfunction MyNode({ data, isSelected, density }: Props) {\n  // Domain-specific tier calculation\n  const getTier = (d: MyData) =&gt; {\n    if (d.importance &gt; 0.9) return 'hot';\n    if (d.importance &gt; 0.7) return 'vivid';\n    return 'familiar';\n  };\n\n  // Domain-specific size calculation\n  const getSize = (d: MyData, density: Density) =&gt; {\n    const baseSize = { compact: 0.2, comfortable: 0.3, spacious: 0.4 }[density];\n    return baseSize * (1 + d.importance * 0.5);\n  };\n\n  return (\n    &lt;TopologyNode3D\n      position={[data.x, data.y, data.z]}\n      theme={CRYSTAL_THEME}\n      data={data}\n      getTier={getTier}\n      getSize={getSize}\n      isSelected={isSelected}\n      density={density}\n      onClick={() =&gt; selectNode(data.id)}\n    /&gt;\n  );\n}\n</code></pre>"},{"location":"skills/3d-projection-patterns/#topologyedge3d","title":"TopologyEdge3D","text":"<pre><code>import { TopologyEdge3D, FOREST_THEME } from '@/components/three/primitives';\n\nfunction MyEdge({ source, target, strength, isActive }: Props) {\n  return (\n    &lt;TopologyEdge3D\n      source={source.position}\n      target={target.position}\n      theme={FOREST_THEME}\n      strength={strength}\n      isActive={isActive}\n      showFlowParticles={isActive}\n      curveIntensity={0.3}\n    /&gt;\n  );\n}\n</code></pre>"},{"location":"skills/3d-projection-patterns/#smarttopologyedge3d","title":"SmartTopologyEdge3D","text":"<p>For edges that need to look up node positions:</p> <pre><code>import { SmartTopologyEdge3D, CRYSTAL_THEME } from '@/components/three/primitives';\n\nfunction MySmartEdge({ edge, nodePositions }: Props) {\n  return (\n    &lt;SmartTopologyEdge3D\n      sourceId={edge.source}\n      targetId={edge.target}\n      nodePositions={nodePositions}  // Map&lt;string, [x,y,z]&gt;\n      theme={CRYSTAL_THEME}\n      strength={edge.weight}\n    /&gt;\n  );\n}\n</code></pre>"},{"location":"skills/3d-projection-patterns/#creating-domain-wrappers","title":"Creating Domain Wrappers","text":"<p>Domain wrappers should be thin and only contain: 1. Domain-specific tier calculation 2. Domain-specific size calculation 3. Theme selection</p>"},{"location":"skills/3d-projection-patterns/#pattern","title":"Pattern","text":"<pre><code>// components/mydomain/MyDomainNode.tsx\n\nimport { TopologyNode3D, MY_THEME } from '@/components/three/primitives';\nimport type { MyDomainData } from './types';\n\n// Domain-specific tier calculation\nfunction getMyDomainTier(data: MyDomainData): string {\n  if (data.score &gt;= 0.9) return 'excellent';\n  if (data.score &gt;= 0.7) return 'good';\n  if (data.score &gt;= 0.5) return 'moderate';\n  return 'needs_attention';\n}\n\n// Domain-specific size calculation\nfunction getMyDomainSize(data: MyDomainData, density: Density): number {\n  const bases = { compact: 0.2, comfortable: 0.3, spacious: 0.4 };\n  return bases[density] * Math.sqrt(data.weight);\n}\n\n// Thin wrapper - just wires up domain logic\nexport function MyDomainNode(props: MyDomainNodeProps) {\n  return (\n    &lt;TopologyNode3D\n      {...props}\n      theme={MY_THEME}\n      getTier={getMyDomainTier}\n      getSize={getMyDomainSize}\n    /&gt;\n  );\n}\n</code></pre>"},{"location":"skills/3d-projection-patterns/#creating-custom-themes","title":"Creating Custom Themes","text":""},{"location":"skills/3d-projection-patterns/#theme-interface","title":"Theme Interface","text":"<pre><code>import type { ThemePalette } from '@/components/three/primitives/themes';\n\nexport const MY_THEME: ThemePalette = {\n  name: 'my-theme',\n  description: 'Theme for my domain',\n\n  // Node colors by tier (domain-specific tier names)\n  nodeTiers: {\n    excellent: { core: '#22C55E', glow: '#4ADE80', ring: '#166534' },\n    good: { core: '#3B82F6', glow: '#60A5FA', ring: '#1E40AF' },\n    moderate: { core: '#F59E0B', glow: '#FBBF24', ring: '#B45309' },\n    needs_attention: { core: '#EF4444', glow: '#F87171', ring: '#B91C1C' },\n  },\n\n  // Edge colors\n  edgeColors: {\n    base: '#6B7280',\n    highlight: '#3B82F6',\n    glow: '#60A5FA',\n    violation: '#EF4444',\n  },\n\n  // Particle colors for flow animations\n  particleColors: {\n    normal: '#3B82F6',\n    active: '#60A5FA',\n  },\n\n  // Selection/hover indicators\n  selectionColor: '#FBBF24',\n  hoverColor: '#FCD34D',\n\n  // Labels\n  labelColor: '#F9FAFB',\n  labelOutlineColor: '#1F2937',\n\n  // Optional atmosphere\n  atmosphere: {\n    fog: { color: '#0F172A', near: 10, far: 50 },\n    background: '#0F172A',\n    ambientTint: '#1E3A5F',\n  },\n};\n</code></pre>"},{"location":"skills/3d-projection-patterns/#validation","title":"Validation","text":"<pre><code>import { validateThemeTiers } from '@/components/three/primitives/themes';\n\n// Ensure theme has all tiers your domain uses\nconst missing = validateThemeTiers(MY_THEME, ['excellent', 'good', 'moderate', 'needs_attention']);\nif (missing.length &gt; 0) {\n  console.warn(`Theme missing tiers: ${missing.join(', ')}`);\n}\n</code></pre>"},{"location":"skills/3d-projection-patterns/#quality-adaptation","title":"Quality Adaptation","text":""},{"location":"skills/3d-projection-patterns/#using-quality-hook","title":"Using Quality Hook","text":"<pre><code>import { useIlluminationQuality } from '@/hooks/useIlluminationQuality';\nimport { ANIMATION_PRESETS, PERFORMANCE_TIERS } from '@/components/three/primitives';\n\nfunction My3DScene() {\n  const { quality, setQuality } = useIlluminationQuality();\n  const perfTier = PERFORMANCE_TIERS[quality];\n\n  return (\n    &lt;Canvas&gt;\n      {/* Scene lighting adapts to quality */}\n      &lt;SceneLighting quality={quality} /&gt;\n\n      {/* Effects adapt to quality */}\n      &lt;SceneEffects quality={quality} /&gt;\n\n      {/* Conditionally render expensive features */}\n      {perfTier.particleCount &gt; 0 &amp;&amp; (\n        &lt;FlowParticles count={perfTier.particleCount} /&gt;\n      )}\n\n      {/* LOD-aware rendering */}\n      &lt;MyNodes lodBias={perfTier.lodBias} /&gt;\n    &lt;/Canvas&gt;\n  );\n}\n</code></pre>"},{"location":"skills/3d-projection-patterns/#quality-levels","title":"Quality Levels","text":"Level Shadows SSAO Bloom Particles Use Case <code>minimal</code> No No No 0 Low-end devices, battery saving <code>standard</code> Yes No Yes 4 Default, good balance <code>high</code> Yes Yes Yes 6 Desktop with GPU <code>cinematic</code> Yes Yes Yes 8 Demos, screenshots"},{"location":"skills/3d-projection-patterns/#performance-patterns","title":"Performance Patterns","text":""},{"location":"skills/3d-projection-patterns/#lod-for-large-graphs-100-nodes","title":"LOD for Large Graphs (100+ nodes)","text":"<p>Use the built-in <code>useLOD</code> hook for automatic level-of-detail management:</p> <pre><code>import { useLOD, LODAwareNode, getEdgeLOD } from '@/components/three/primitives';\n\nfunction LargeGraph({ nodes, edges }: Props) {\n  // useLOD handles frustum culling and distance-based detail reduction\n  const { getLOD, getLODBatch, getStats } = useLOD(nodes.length);\n\n  // Calculate LOD for all nodes in batch\n  const nodeLODs = getLODBatch(nodes.map(n =&gt; [n.x, n.y, n.z]));\n\n  // Debug stats\n  const stats = getStats(nodeLODs);\n  console.log(`Visible: ${stats.full + stats.reduced + stats.minimal}, Culled: ${stats.culled}`);\n\n  return (\n    &lt;&gt;\n      {nodes.map((node, i) =&gt; {\n        const lod = nodeLODs[i];\n        if (lod.level === 'culled') return null;\n\n        return (\n          &lt;LODAwareNode key={node.id} position={[node.x, node.y, node.z]} lod={lod}&gt;\n            {({ segments, showLabel, animationSpeed }) =&gt; (\n              &lt;TopologyNode3D\n                {...node}\n                segments={segments}           // Auto-reduced at distance\n                showLabel={showLabel}         // Hidden at distance\n                animationSpeed={animationSpeed} // Disabled at distance\n              /&gt;\n            )}\n          &lt;/LODAwareNode&gt;\n        );\n      })}\n\n      {edges.map((edge, i) =&gt; {\n        const sourceLOD = nodeLODs[nodes.findIndex(n =&gt; n.id === edge.sourceId)];\n        const targetLOD = nodeLODs[nodes.findIndex(n =&gt; n.id === edge.targetId)];\n        const edgeLOD = getEdgeLOD(sourceLOD, targetLOD);\n\n        if (!edgeLOD.visible) return null;\n\n        return (\n          &lt;TopologyEdge3D\n            key={edge.id}\n            {...edge}\n            curveSegments={edgeLOD.curveSegments}\n            showFlowParticles={edgeLOD.showFlowParticles}\n          /&gt;\n        );\n      })}\n    &lt;/&gt;\n  );\n}\n</code></pre>"},{"location":"skills/3d-projection-patterns/#lod-settings","title":"LOD Settings","text":"<pre><code>// Custom LOD settings for dense graphs\nconst { getLOD } = useLOD(nodes.length, {\n  settings: {\n    distances: {\n      full: 3,      // Closer = full detail\n      reduced: 10,\n      minimal: 25,\n    },\n    budgetThresholds: {\n      medium: 30,   // Earlier transition to aggressive LOD\n      large: 75,\n    },\n  },\n  updateInterval: 50, // More frequent updates for dynamic scenes\n});\n</code></pre>"},{"location":"skills/3d-projection-patterns/#touch-responsiveness-mobile","title":"Touch Responsiveness (Mobile)","text":"<p>Use the touch hooks for mobile accessibility (WCAG 2.1 compliant):</p> <pre><code>import { useTouchDevice, TopologyNode3D } from '@/components/three/primitives';\n\nfunction My3DScene({ nodes }: Props) {\n  const { isTouchDevice, isHybrid } = useTouchDevice();\n\n  return (\n    &lt;&gt;\n      {nodes.map(n =&gt; (\n        &lt;TopologyNode3D\n          key={n.id}\n          {...n}\n          isTouchDevice={isTouchDevice}       // Enables larger hit area\n          touchTargetMultiplier={1.5}         // 1.5x node size for touch\n        /&gt;\n      ))}\n    &lt;/&gt;\n  );\n}\n</code></pre> <p>For custom gesture handling:</p> <pre><code>import { useGesture } from '@/components/three/primitives';\n\nfunction TouchableNode({ onSelect, onDetails }: Props) {\n  const { onPointerDown, onPointerMove, onPointerUp } = useGesture({\n    onTap: onSelect,        // Quick touch\n    onLongPress: onDetails, // Press and hold\n    onDrag: (dx, dy) =&gt; console.log('Dragging', dx, dy),\n  });\n\n  return (\n    &lt;mesh\n      onPointerDown={onPointerDown}\n      onPointerMove={onPointerMove}\n      onPointerUp={onPointerUp}\n    &gt;\n      ...\n    &lt;/mesh&gt;\n  );\n}\n</code></pre>"},{"location":"skills/3d-projection-patterns/#animation-throttling","title":"Animation Throttling","text":"<pre><code>import { ANIMATION_PRESETS } from '@/components/three/primitives';\n\nfunction OptimizedNode({ quality, ...props }: Props) {\n  // Reduce animation speed on low quality\n  const animationSpeed = quality === 'minimal'\n    ? 0  // Disable animation\n    : ANIMATION_PRESETS.breathing.speed;\n\n  return (\n    &lt;TopologyNode3D\n      {...props}\n      animationSpeed={animationSpeed}\n    /&gt;\n  );\n}\n</code></pre>"},{"location":"skills/3d-projection-patterns/#agentese-integration","title":"AGENTESE Integration","text":""},{"location":"skills/3d-projection-patterns/#available-paths","title":"Available Paths","text":"<pre><code># Node primitive configuration\nawait logos.invoke(\"concept.projection.three.node.manifest\", umwelt)\nawait logos.invoke(\"concept.projection.three.node.config\", umwelt)\n\n# Edge primitive configuration\nawait logos.invoke(\"concept.projection.three.edge.manifest\", umwelt)\nawait logos.invoke(\"concept.projection.three.edge.config\", umwelt)\n\n# Theme operations\nawait logos.invoke(\"concept.projection.three.theme.list\", umwelt)\nawait logos.invoke(\"concept.projection.three.theme.get\", umwelt, name=\"crystal\")\nawait logos.invoke(\"concept.projection.three.theme.palette\", umwelt, name=\"forest\")\n\n# Quality adaptation\nawait logos.invoke(\"concept.projection.three.quality.adapt\", umwelt, level=\"high\")\nawait logos.invoke(\"concept.projection.three.quality.config\", umwelt)\n</code></pre>"},{"location":"skills/3d-projection-patterns/#python-usage","title":"Python Usage","text":"<pre><code>from protocols.agentese.contexts.three import (\n    THEME_REGISTRY,\n    QUALITY_CONFIGS,\n    Quality,\n    create_three_resolver,\n)\n\n# Get theme info\ncrystal = THEME_REGISTRY[\"crystal\"]\nprint(f\"Crystal tiers: {crystal['nodeTiers']}\")\n\n# Get quality config\nhigh_config = QUALITY_CONFIGS[Quality.HIGH]\nprint(f\"High quality: {high_config['description']}\")\n</code></pre>"},{"location":"skills/3d-projection-patterns/#file-locations","title":"File Locations","text":"Component Location Primitives <code>web/src/components/three/primitives/</code> Themes <code>web/src/components/three/primitives/themes/</code> Theme Harmony <code>web/src/components/three/primitives/themes/harmony.ts</code> Animation <code>web/src/components/three/primitives/animation.ts</code> LOD System <code>web/src/components/three/primitives/useLOD.tsx</code> Touch Hooks <code>web/src/components/three/primitives/useTouch.ts</code> Brain wrappers <code>web/src/components/brain/</code> Gestalt wrappers <code>web/src/components/gestalt/</code> Quality hook <code>web/src/hooks/useIlluminationQuality.ts</code> Lighting constants <code>web/src/constants/lighting.ts</code> AGENTESE context <code>protocols/agentese/contexts/three.py</code>"},{"location":"skills/3d-projection-patterns/#common-mistakes","title":"Common Mistakes","text":""},{"location":"skills/3d-projection-patterns/#1-duplicating-logic-in-wrappers","title":"1. Duplicating Logic in Wrappers","text":"<p>Bad: <pre><code>// Reimplementing breathing animation in wrapper\nfunction OrganicCrystal(props) {\n  const [scale, setScale] = useState(1);\n  useFrame((_, delta) =&gt; {\n    setScale(1 + Math.sin(Date.now() * 0.001) * 0.03);\n  });\n  return &lt;mesh scale={scale}&gt;...&lt;/mesh&gt;;\n}\n</code></pre></p> <p>Good: <pre><code>// Let primitive handle animation\nfunction OrganicCrystal(props) {\n  return &lt;TopologyNode3D {...props} theme={CRYSTAL_THEME} /&gt;;\n}\n</code></pre></p>"},{"location":"skills/3d-projection-patterns/#2-mixing-themes-in-same-scene","title":"2. Mixing Themes in Same Scene","text":"<p>If you need cross-jewel scenes, check theme harmony first:</p> <pre><code>import { checkThemeHarmony, CRYSTAL_THEME, FOREST_THEME } from '@/components/three/primitives';\n\n// Check compatibility\nconst harmony = checkThemeHarmony(CRYSTAL_THEME, FOREST_THEME);\nif (!harmony.harmonious) {\n  console.warn('Theme issues:', harmony.issues);\n  console.log('Recommendations:', harmony.recommendations);\n}\n\n// Use blend color for transition zones\nconst blendBg = getThemeBlendColor(CRYSTAL_THEME, FOREST_THEME);\n</code></pre> <p>For single-theme scenes (preferred):</p> <pre><code>// One theme per scene\nconst theme = domain === 'brain' ? CRYSTAL_THEME : FOREST_THEME;\n&lt;&gt;\n  {nodes.map(n =&gt; &lt;TopologyNode3D key={n.id} theme={theme} {...n} /&gt;)}\n&lt;/&gt;\n</code></pre>"},{"location":"skills/3d-projection-patterns/#3-ignoring-quality-adaptation","title":"3. Ignoring Quality Adaptation","text":"<p>Bad: <pre><code>// Always rendering at max quality\n&lt;SceneEffects bloom ssao /&gt;\n</code></pre></p> <p>Good: <pre><code>// Adapt to device capability\n&lt;SceneEffects quality={quality} /&gt;\n</code></pre></p>"},{"location":"skills/3d-projection-patterns/#related-skills","title":"Related Skills","text":"<ul> <li><code>elastic-ui-patterns.md</code> \u2014 Density-responsive 2D layout</li> <li><code>projection-target.md</code> \u2014 Multi-target projection (CLI/TUI/JSON)</li> <li><code>metaphysical-fullstack.md</code> \u2014 Full stack pattern (7 layers)</li> </ul> <p>Last updated: 2025-12-18</p>"},{"location":"skills/agentese-node-registration/","title":"AGENTESE Node Registration","text":"<p>Status: Canonical Pattern Last Updated: 2025-12-19</p>"},{"location":"skills/agentese-node-registration/#the-core-principle-ad-011","title":"The Core Principle (AD-011)","text":"<p>The AGENTESE registry is the SINGLE SOURCE OF TRUTH. If a path isn't registered via <code>@node</code>, it doesn't exist.</p> <p>See <code>spec/principles.md</code> AD-011 for the full architectural decision.</p> <pre><code>SINGLE SOURCE OF TRUTH\n\n    @node(\"world.town\")           \u25c4\u2500\u2500\u2500 This is the ONLY place a path is defined\n           \u2502\n           \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502              AGENTESE Registry                        \u2502\n    \u2502   get_registry().list_paths() \u2192 [\"world.town\", ...]   \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           \u2502\n           \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba NavigationTree.tsx (MUST match)\n           \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba Cockpit.tsx (MUST match)\n           \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba CLI handlers (MUST match)\n           \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba API routes (auto-generated)\n           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba Documentation (derived)\n</code></pre>"},{"location":"skills/agentese-node-registration/#overview","title":"Overview","text":"<p>This skill documents how to register AGENTESE nodes so they appear in: 1. <code>/agentese/discover</code> endpoint 2. NavigationTree in the UI 3. CLI tab completion 4. Contract-based type generation (see <code>agentese-contract-protocol.md</code>)</p>"},{"location":"skills/agentese-node-registration/#the-problem","title":"The Problem","text":"<p>AGENTESE has two disconnected mechanisms for defining paths:</p> <pre><code>crown_jewels.py (PATHS dicts) \u2500\u2500\u2500\u2500\u2192 Documentation only (NOT discoverable)\n\n@node decorator \u2500\u2500\u2192 NodeRegistry \u2500\u2500\u2192 /discover \u2500\u2500\u2192 NavigationTree\n</code></pre> <p>Solution: Use <code>@node</code> decorator on node classes for automatic registration.</p> <p>Phase 7 Enhancement: Add <code>contracts={}</code> parameter for BE/FE type sync. See <code>agentese-contract-protocol.md</code> for full details.</p>"},{"location":"skills/agentese-node-registration/#quick-reference","title":"Quick Reference","text":""},{"location":"skills/agentese-node-registration/#1-add-node-decorator-to-your-node","title":"1. Add <code>@node</code> Decorator to Your Node","text":"<pre><code># In your node file (e.g., world_emergence.py)\nfrom protocols.agentese.registry import node\nfrom protocols.agentese.node import BaseLogosNode\n\n@node(\"world.emergence\", description=\"Cymatics Design Sampler\")\n@dataclass\nclass EmergenceNode(BaseLogosNode):\n    \"\"\"world.emergence - Your node description.\"\"\"\n\n    _handle: str = \"world.emergence\"\n\n    @property\n    def handle(self) -&gt; str:\n        return self._handle\n</code></pre>"},{"location":"skills/agentese-node-registration/#1b-add-contracts-for-befe-type-sync-recommended","title":"1b. Add Contracts for BE/FE Type Sync (Recommended)","text":"<pre><code>from dataclasses import dataclass\nfrom protocols.agentese.contract import Contract, Response\nfrom protocols.agentese.registry import node\n\n# Define contract types as dataclasses\n@dataclass\nclass ManifestResponse:\n    name: str\n    status: str\n    count: int\n\n@dataclass\nclass ConfigureRequest:\n    setting: str\n    value: str | None = None\n\n@dataclass\nclass ConfigureResponse:\n    success: bool\n\n# Add contracts={} to @node\n@node(\n    \"world.emergence\",\n    description=\"Cymatics Design Sampler\",\n    contracts={\n        \"manifest\": Response(ManifestResponse),\n        \"configure\": Contract(ConfigureRequest, ConfigureResponse),\n    }\n)\n@dataclass\nclass EmergenceNode(BaseLogosNode):\n    ...\n</code></pre> <p>See: <code>agentese-contract-protocol.md</code> for complete contract documentation.</p>"},{"location":"skills/agentese-node-registration/#2-ensure-module-is-imported-at-startup","title":"2. Ensure Module Is Imported at Startup","text":"<p>The <code>@node</code> decorator runs at import time. Modules must be imported for registration.</p> <p>Add your module to <code>gateway.py</code>:</p> <pre><code># In protocols/agentese/gateway.py\n\ndef _import_node_modules() -&gt; None:\n    \"\"\"Import all AGENTESE node modules to trigger @node registration.\"\"\"\n    try:\n        from . import contexts\n        from .contexts import world_emergence      # ADD YOUR MODULE HERE\n        from .contexts import world_gestalt_live\n        from .contexts import world_park\n        logger.debug(\"AGENTESE node modules imported for registration\")\n    except ImportError as e:\n        logger.warning(f\"Could not import some node modules: {e}\")\n</code></pre>"},{"location":"skills/agentese-node-registration/#3-add-route-mapping-to-navigationtree-frontend","title":"3. Add Route Mapping to NavigationTree (Frontend)","text":"<pre><code>// In web/src/shell/NavigationTree.tsx\n\n// Route \u2192 AGENTESE path mapping\nconst routeToPath: Record&lt;string, string&gt; = {\n  '/brain': 'self.memory',\n  '/gestalt': 'world.codebase',\n  '/emergence': 'world.emergence',     // ADD YOUR MAPPING\n  // ...\n};\n\n// AGENTESE path \u2192 Route mapping (reverse)\nconst pathToRoute: Record&lt;string, string&gt; = {\n  'self.memory': '/brain',\n  'world.codebase': '/gestalt',\n  'world.emergence': '/emergence',     // ADD YOUR MAPPING\n  // ...\n};\n</code></pre>"},{"location":"skills/agentese-node-registration/#architecture","title":"Architecture","text":"<pre><code>                    Import Time                    Runtime\n                    \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500                    \u2500\u2500\u2500\u2500\u2500\u2500\u2500\n                         \u2502\nModule with @node \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n        \u2502                \u2502\n        \u25bc                \u2502\n@node decorator \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2192 NodeRegistry\n                         \u2502            \u2502\n_import_node_modules() \u2500\u2500\u2518            \u2502\n        \u2502                             \u25bc\n        \u25bc                      /agentese/discover\ngateway.mount_on()                    \u2502\n                                      \u25bc\n                              NavigationTree\n                              (builds tree from paths)\n</code></pre>"},{"location":"skills/agentese-node-registration/#key-insight","title":"Key Insight","text":"<p>The <code>@node</code> decorator is a side effect at import time. If a module isn't imported, its nodes won't be registered, and they won't appear in discovery.</p>"},{"location":"skills/agentese-node-registration/#complete-example","title":"Complete Example","text":""},{"location":"skills/agentese-node-registration/#step-1-create-the-node-file","title":"Step 1: Create the Node File","text":"<pre><code># protocols/agentese/contexts/world_myfeature.py\n\"\"\"\nAGENTESE MyFeature Context.\n\nworld.myfeature.* paths for the MyFeature Crown Jewel.\n\"\"\"\n\nfrom __future__ import annotations\nfrom dataclasses import dataclass\nfrom typing import TYPE_CHECKING, Any\n\nfrom ..affordances import AspectCategory, aspect\nfrom ..node import BaseLogosNode, BasicRendering, Renderable\nfrom ..registry import node\n\nif TYPE_CHECKING:\n    from bootstrap.umwelt import Umwelt\n\n\nMYFEATURE_AFFORDANCES: tuple[str, ...] = (\n    \"manifest\",\n    \"configure\",\n)\n\n\n@node(\"world.myfeature\", description=\"My awesome feature\")\n@dataclass\nclass MyFeatureNode(BaseLogosNode):\n    \"\"\"world.myfeature - Interface for MyFeature.\"\"\"\n\n    _handle: str = \"world.myfeature\"\n\n    @property\n    def handle(self) -&gt; str:\n        return self._handle\n\n    def _get_affordances_for_archetype(self, archetype: str) -&gt; tuple[str, ...]:\n        return MYFEATURE_AFFORDANCES\n\n    @aspect(\n        category=AspectCategory.PERCEPTION,\n        effects=[],\n        help=\"View MyFeature status\",\n    )\n    async def manifest(self, observer: \"Umwelt[Any, Any]\") -&gt; Renderable:\n        return BasicRendering(\n            summary=\"MyFeature Status\",\n            content=\"Everything is working!\",\n            metadata={\"status\": \"ok\", \"route\": \"/myfeature\"},\n        )\n\n\n# Factory functions\n_node: MyFeatureNode | None = None\n\ndef get_myfeature_node() -&gt; MyFeatureNode:\n    global _node\n    if _node is None:\n        _node = MyFeatureNode()\n    return _node\n\n\n__all__ = [\n    \"MYFEATURE_AFFORDANCES\",\n    \"MyFeatureNode\",\n    \"get_myfeature_node\",\n]\n</code></pre>"},{"location":"skills/agentese-node-registration/#step-2-export-from-__init__py","title":"Step 2: Export from <code>__init__.py</code>","text":"<pre><code># In protocols/agentese/contexts/__init__.py\n\nfrom .world_myfeature import (\n    MYFEATURE_AFFORDANCES,\n    MyFeatureNode,\n    get_myfeature_node,\n)\n\n# Add to __all__\n__all__ = [\n    # ... existing exports ...\n    \"MYFEATURE_AFFORDANCES\",\n    \"MyFeatureNode\",\n    \"get_myfeature_node\",\n]\n</code></pre>"},{"location":"skills/agentese-node-registration/#step-3-import-in-gateway","title":"Step 3: Import in Gateway","text":"<pre><code># In protocols/agentese/gateway.py\n\ndef _import_node_modules() -&gt; None:\n    try:\n        from . import contexts\n        from .contexts import world_myfeature  # ADD THIS LINE\n        # ...\n    except ImportError as e:\n        logger.warning(f\"Could not import some node modules: {e}\")\n</code></pre>"},{"location":"skills/agentese-node-registration/#step-4-add-frontend-route-mapping","title":"Step 4: Add Frontend Route Mapping","text":"<pre><code>// In NavigationTree.tsx\n\nconst routeToPath: Record&lt;string, string&gt; = {\n  // ... existing ...\n  '/myfeature': 'world.myfeature',\n};\n\nconst pathToRoute: Record&lt;string, string&gt; = {\n  // ... existing ...\n  'world.myfeature': '/myfeature',\n};\n</code></pre>"},{"location":"skills/agentese-node-registration/#step-5-verify-registration","title":"Step 5: Verify Registration","text":"<pre><code>cd impl/claude\nuv run python -c \"\nfrom protocols.agentese.gateway import _import_node_modules\nfrom protocols.agentese.registry import get_registry\n\n_import_node_modules()\nregistry = get_registry()\npaths = registry.list_paths()\n\nprint('Registered paths:')\nfor p in sorted(paths):\n    print(f'  {p}')\n\nprint(f'world.myfeature registered: {\\\"world.myfeature\\\" in paths}')\n\"\n</code></pre>"},{"location":"skills/agentese-node-registration/#common-issues","title":"Common Issues","text":""},{"location":"skills/agentese-node-registration/#node-not-appearing-in-discovery","title":"Node Not Appearing in Discovery","text":"<p>Symptom: Path doesn't show in <code>/agentese/discover</code> or NavigationTree.</p> <p>Causes: 1. Missing <code>@node</code> decorator on class 2. Module not imported in <code>_import_node_modules()</code> 3. Import error (check logs for warnings)</p> <p>Debug: <pre><code>from protocols.agentese.registry import get_registry\nregistry = get_registry()\nprint(registry.list_paths())\n</code></pre></p>"},{"location":"skills/agentese-node-registration/#node-appears-in-discovery-but-not-clickable","title":"Node Appears in Discovery but Not Clickable","text":"<p>Symptom: Path shows in tree but clicking doesn't navigate.</p> <p>Cause: Missing route mapping in NavigationTree.tsx.</p> <p>Fix: Add both <code>routeToPath</code> and <code>pathToRoute</code> mappings.</p>"},{"location":"skills/agentese-node-registration/#decorator-order-matters","title":"Decorator Order Matters","text":"<pre><code># CORRECT: @node before @dataclass\n@node(\"world.myfeature\")\n@dataclass\nclass MyNode: ...\n\n# WRONG: @dataclass before @node\n@dataclass\n@node(\"world.myfeature\")  # May not work correctly\nclass MyNode: ...\n</code></pre>"},{"location":"skills/agentese-node-registration/#anti-patterns","title":"Anti-Patterns","text":""},{"location":"skills/agentese-node-registration/#dont-hardcode-paths-without-node","title":"Don't: Hardcode paths without @node","text":"<pre><code># BAD: This won't be discoverable\nMYFEATURE_PATHS = {\n    \"world.myfeature.manifest\": {\"aspect\": \"manifest\", ...}\n}\n</code></pre>"},{"location":"skills/agentese-node-registration/#dont-forget-to-import-the-module","title":"Don't: Forget to import the module","text":"<pre><code># BAD: Module exists but @node never runs\n# (no import in _import_node_modules)\n</code></pre>"},{"location":"skills/agentese-node-registration/#dont-create-circular-imports","title":"Don't: Create circular imports","text":"<pre><code># BAD: Importing heavy dependencies at module level\nfrom services.myfeature import HeavyService  # Avoid if causes circular import\n\n# GOOD: Import inside methods or use TYPE_CHECKING\nif TYPE_CHECKING:\n    from services.myfeature import HeavyService\n</code></pre>"},{"location":"skills/agentese-node-registration/#dependency-injection-for-nodes","title":"Dependency Injection for Nodes","text":"<p>When a node requires dependencies (services, persistence layers, etc.), you must:</p>"},{"location":"skills/agentese-node-registration/#critical-the-silent-skip-problem","title":"\u26a0\ufe0f CRITICAL: The Silent Skip Problem","text":"<p>The container SILENTLY SKIPS unregistered dependencies. This is the #1 cause of cryptic <code>TypeError</code> messages.</p> <pre><code># In container.py create_node() - THE DANGEROUS CODE:\nfor name in dep_names:\n    if self.has(name):\n        kwargs[name] = await self.resolve(name)\n    else:\n        logger.debug(f\"No provider for dependency {name}, skipping\")  # \u2190 SILENT AT DEBUG LEVEL!\n\n# Then...\nreturn cls(**kwargs)  # \u2190 TypeError: missing argument!\n</code></pre> <p>What happens: 1. Node declares <code>dependencies=(\"inhabit_service\",)</code> 2. Container checks <code>has(\"inhabit_service\")</code> \u2192 <code>False</code> (not registered!) 3. Container logs at DEBUG level and moves on (silent skip) 4. Container calls <code>cls()</code> without the dependency 5. You get: <code>TypeError: __init__() missing 1 required positional argument: 'inhabit_service'</code></p> <p>The fix is ALWAYS the same: 1. Every dependency in <code>@node(dependencies=(...))</code> MUST have a matching provider 2. Provider MUST be registered in <code>services/providers.py</code> \u2192 <code>setup_providers()</code></p>"},{"location":"skills/agentese-node-registration/#1-declare-dependencies-in-node-decorator","title":"1. Declare dependencies in @node decorator","text":"<pre><code>@node(\n    \"world.forge.commission\",\n    description=\"Commission workflow for building agents\",\n    dependencies=(\"commission_service\",),  # REQUIRED: explicit declaration\n    contracts={...},\n)\nclass CommissionNode(BaseLogosNode):\n    def __init__(self, commission_service: CommissionService) -&gt; None:\n        self.service = commission_service\n</code></pre>"},{"location":"skills/agentese-node-registration/#2-register-providers-in-servicesproviderspy","title":"2. Register providers in <code>services/providers.py</code>","text":"<pre><code># Add provider function\nasync def get_commission_service() -&gt; \"CommissionService\":\n    \"\"\"Get the CommissionService for the Metaphysical Forge.\"\"\"\n    from services.forge.commission import CommissionService\n    return CommissionService()\n\n# Register in setup_providers()\nasync def setup_providers() -&gt; None:\n    container = get_container()\n    # ...existing registrations...\n    container.register(\"commission_service\", get_commission_service, singleton=True)\n</code></pre>"},{"location":"skills/agentese-node-registration/#3-container-resolution-flow","title":"3. Container resolution flow","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  @node(dependencies=(\"commission_service\",))                     \u2502\n\u2502         \u2502                                                        \u2502\n\u2502         \u25bc                                                        \u2502\n\u2502  container.create_node(cls, meta)                               \u2502\n\u2502         \u2502                                                        \u2502\n\u2502         \u251c\u2500\u2500\u2192 Check meta.dependencies                            \u2502\n\u2502         \u2502         \u2502                                              \u2502\n\u2502         \u2502         \u25bc                                              \u2502\n\u2502         \u2502    For each dep: container.has(name)?                 \u2502\n\u2502         \u2502         \u2502                                              \u2502\n\u2502         \u2502    YES \u2192 container.resolve(name) \u2192 add to kwargs      \u2502\n\u2502         \u2502    NO  \u2192 \u26a0\ufe0f SKIP SILENTLY (debug log only!)           \u2502\n\u2502         \u2502                                                        \u2502\n\u2502         \u25bc                                                        \u2502\n\u2502  cls(**resolved_kwargs) \u2192 Node instance                         \u2502\n\u2502         \u2502                                                        \u2502\n\u2502         \u2514\u2500\u2500\u2192 If required param missing \u2192 TypeError!             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"skills/agentese-node-registration/#common-di-error","title":"Common DI Error","text":"<pre><code>TypeError: InhabitNode.__init__() missing 1 required positional argument: 'inhabit_service'\n</code></pre> <p>Cause: Node declares/requires a dependency that isn't registered in the container.</p> <p>Debugging checklist: 1. \u2713 Does <code>@node</code> have <code>dependencies=(\"inhabit_service\",)</code>? 2. \u2713 Does <code>services/providers.py</code> have <code>get_inhabit_service()</code>? 3. \u2713 Is it registered in <code>setup_providers()</code> with <code>container.register(\"inhabit_service\", ...)</code>? 4. \u2713 Is the name EXACTLY the same (case-sensitive)?</p> <p>Fix: 1. Add <code>dependencies=(\"service_name\",)</code> to <code>@node</code> decorator 2. Add provider function <code>get_service_name()</code> to <code>services/providers.py</code> 3. Register: <code>container.register(\"service_name\", get_service_name, singleton=True)</code></p>"},{"location":"skills/agentese-node-registration/#quick-validation","title":"Quick Validation","text":"<pre><code># Check what providers are registered:\ncd impl/claude\nuv run python -c \"\nfrom protocols.agentese.container import get_container\nfrom services.providers import setup_providers\nimport asyncio\n\nasync def check():\n    await setup_providers()\n    container = get_container()\n    print('Registered providers:')\n    for name in sorted(container.list_providers()):\n        print(f'  {name}')\n\nasyncio.run(check())\n\"\n</code></pre>"},{"location":"skills/agentese-node-registration/#the-di-contract","title":"The DI Contract","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    THE DI CONTRACT                              \u2502\n\u2502                                                                 \u2502\n\u2502  For EVERY dependency in @node(dependencies=(\"foo\", \"bar\")):   \u2502\n\u2502                                                                 \u2502\n\u2502    1. MUST exist: get_foo() in services/providers.py           \u2502\n\u2502    2. MUST register: container.register(\"foo\", get_foo, ...)   \u2502\n\u2502    3. MUST match: Name in @node == Name in register()          \u2502\n\u2502                                                                 \u2502\n\u2502  If ANY of these are missing \u2192 silent skip \u2192 TypeError         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"skills/agentese-node-registration/#related-patterns","title":"Related Patterns","text":"<ul> <li>agentese-path.md - Adding new AGENTESE paths</li> <li>agentese-contract-protocol.md - BE/FE type sync via contracts (Phase 7)</li> <li>crown-jewel-patterns.md - Crown Jewel architecture</li> <li>metaphysical-fullstack.md - The protocol IS the API</li> </ul>"},{"location":"skills/agentese-node-registration/#critical-learnings","title":"Critical Learnings","text":"<pre><code>@node runs at import time: If not imported, not registered\n_import_node_modules(): Gateway calls this to ensure all nodes load\nTwo-way mapping needed: AGENTESE path \u2194 React route\nDiscovery is pull-based: Frontend fetches /agentese/discover\ncontracts={} enables BE/FE type sync: JSON Schema generation at build time\nRegistry is single source of truth: Frontend MUST NOT reference unregistered paths (AD-011)\ndependencies= must match providers: If @node declares deps, register them in setup_providers()\n</code></pre>"},{"location":"skills/agentese-node-registration/#validation-ad-011","title":"Validation (AD-011)","text":"<p>The registry is the single source of truth. Validate that frontend paths match backend:</p> <pre><code>cd impl/claude\nuv run python scripts/validate_path_alignment.py\n</code></pre> <p>What it checks: 1. All paths in <code>NavigationTree.tsx</code> have <code>@node</code> registrations 2. All paths in <code>Cockpit.tsx</code> have <code>@node</code> registrations 3. All hardcoded AGENTESE paths in frontend match backend</p> <p>Example output: <pre><code>=== AGENTESE Path Alignment Validator ===\n\nLoading backend registry...\nFound 39 registered paths\n\nChecking web/src/shell/NavigationTree.tsx...\n  OK: All 10 paths registered\nChecking web/src/pages/Cockpit.tsx...\n  OK: All 7 paths registered\n\n=== Validation Summary ===\n\nBackend registry: 39 paths\nFrontend references: 17 paths\nValid: 17\n\nPASSED: All frontend paths are registered in backend\n</code></pre></p> <p>CI Integration:</p> <p>Add to <code>.github/workflows/ci.yml</code>:</p> <pre><code>- name: Validate AGENTESE path alignment\n  run: cd impl/claude &amp;&amp; uv run python scripts/validate_path_alignment.py\n</code></pre> <p>The Strict Protocol:</p> <ol> <li>No aliases: If a path doesn't exist as <code>@node</code>, it doesn't exist</li> <li>No workarounds: Frontend can only reference registered paths</li> <li>Warnings are failures: <code>logger.warning</code> for import failures, not <code>logger.debug</code></li> <li>Dead links are bugs: Fix frontend or add the node\u2014no middle ground</li> </ol> <p>Last updated: 2025-12-19</p>"},{"location":"skills/agentese-path/","title":"Skill: Adding an AGENTESE Path","text":"<p>Add a new path to the AGENTESE system (e.g., <code>self.soul.*</code> or <code>world.calendar.*</code>).</p> <p>Difficulty: Medium Prerequisites: Understanding of AGENTESE ontology (<code>spec/protocols/agentese.md</code>), familiarity with Python dataclasses Files Touched: <code>protocols/agentese/contexts/&lt;context&gt;.py</code>, <code>protocols/agentese/contexts/__init__.py</code>, tests</p>"},{"location":"skills/agentese-path/#overview","title":"Overview","text":"<p>AGENTESE paths follow the structure <code>&lt;context&gt;.&lt;holon&gt;.&lt;aspect&gt;</code>. There are exactly five contexts:</p> Context Purpose Resolver File <code>world.*</code> External entities <code>contexts/world.py</code> <code>self.*</code> Internal state <code>contexts/self_.py</code> <code>concept.*</code> Abstract ideas <code>contexts/concept.py</code> <code>void.*</code> Entropy/Accursed Share <code>contexts/void.py</code> <code>time.*</code> Temporal operations <code>contexts/time.py</code> <p>Adding a new path involves: 1. Adding to an existing context (most common) - Add a new holon to a context 2. Adding a new aspect to an existing holon - Extend an existing node</p>"},{"location":"skills/agentese-path/#n-cycle-quickrun-doc-only","title":"N-cycle Quickrun (doc-only)","text":"<ul> <li>PLAN\u2192REFLECT: <code>concept.agentese.manifest[phase=PLAN][minimal_output=true]</code> scope; <code>concept.agentese.refine[phase=DEVELOP][rollback=true][law_check=true]</code> draft handles; <code>void.entropy.sip[entropy=0.07]</code> budget; <code>time.agentese.witness[phase=REFLECT]</code> log; ops apply when code gates open.</li> </ul>"},{"location":"skills/agentese-path/#step-by-step-add-a-holon-to-existing-context","title":"Step-by-Step: Add a Holon to Existing Context","text":"<p>This is the most common case: adding something like <code>self.semaphore.*</code> or <code>world.purgatory.*</code>.</p>"},{"location":"skills/agentese-path/#step-1-define-affordances","title":"Step 1: Define Affordances","text":"<p>Add your holon's affordances to the context's affordance dict.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <p>Pattern (using <code>self_.py</code> as example): <pre><code># Near the top of the file, find or add the affordances dict\nSELF_AFFORDANCES: dict[str, tuple[str, ...]] = {\n    \"memory\": (\"consolidate\", \"prune\", \"checkpoint\", \"recall\", \"forget\"),\n    \"capabilities\": (\"list\", \"acquire\", \"release\"),\n    # ... existing entries ...\n\n    # ADD YOUR NEW HOLON HERE\n    \"semaphore\": (\"pending\", \"yield\", \"status\"),\n}\n</code></pre></p>"},{"location":"skills/agentese-path/#step-2-create-the-node-class","title":"Step 2: Create the Node Class","text":"<p>Create a dataclass that extends <code>BaseLogosNode</code>.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <p>Template: <pre><code>@dataclass\nclass MyNewNode(BaseLogosNode):\n    \"\"\"\n    &lt;context&gt;.&lt;holon&gt; - Brief description.\n\n    Provides access to &lt;what this does&gt;:\n    - aspect1: Description\n    - aspect2: Description\n    - aspect3: Description\n\n    AGENTESE: &lt;context&gt;.&lt;holon&gt;.*\n    \"\"\"\n\n    _handle: str = \"&lt;context&gt;.&lt;holon&gt;\"\n\n    # Integration points (optional)\n    _some_service: Any = None\n\n    @property\n    def handle(self) -&gt; str:\n        return self._handle\n\n    def _get_affordances_for_archetype(self, archetype: str) -&gt; tuple[str, ...]:\n        \"\"\"Return affordances for this holon.\"\"\"\n        # Option 1: Same for all archetypes\n        return SELF_AFFORDANCES[\"&lt;holon&gt;\"]\n\n        # Option 2: Archetype-specific\n        # if archetype in (\"admin\", \"developer\"):\n        #     return (\"aspect1\", \"aspect2\", \"aspect3\")\n        # return (\"aspect1\",)  # Read-only for others\n\n    async def manifest(self, observer: \"Umwelt[Any, Any]\") -&gt; Renderable:\n        \"\"\"View current state.\"\"\"\n        return BasicRendering(\n            summary=\"&lt;Holon&gt; State\",\n            content=\"Description of current state\",\n            metadata={\"key\": \"value\"},\n        )\n\n    async def _invoke_aspect(\n        self,\n        aspect: str,\n        observer: \"Umwelt[Any, Any]\",\n        **kwargs: Any,\n    ) -&gt; Any:\n        \"\"\"Handle holon-specific aspects.\"\"\"\n        match aspect:\n            case \"aspect1\":\n                return await self._handle_aspect1(observer, **kwargs)\n            case \"aspect2\":\n                return await self._handle_aspect2(observer, **kwargs)\n            case _:\n                return {\"aspect\": aspect, \"status\": \"not implemented\"}\n\n    async def _handle_aspect1(\n        self,\n        observer: \"Umwelt[Any, Any]\",\n        **kwargs: Any,\n    ) -&gt; dict[str, Any]:\n        \"\"\"Handle aspect1 - describe what it does.\"\"\"\n        # Your implementation here\n        return {\"status\": \"ok\"}\n\n    async def _handle_aspect2(\n        self,\n        observer: \"Umwelt[Any, Any]\",\n        **kwargs: Any,\n    ) -&gt; dict[str, Any]:\n        \"\"\"Handle aspect2 - describe what it does.\"\"\"\n        # Your implementation here\n        return {\"status\": \"ok\"}\n</code></pre></p>"},{"location":"skills/agentese-path/#step-3-wire-into-context-resolver","title":"Step 3: Wire into Context Resolver","text":"<p>Add your node to the context resolver's <code>resolve()</code> method.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <p>Pattern (for <code>SelfContextResolver</code>): <pre><code>@dataclass\nclass SelfContextResolver:\n    \"\"\"Resolver for self.* context.\"\"\"\n\n    # Add integration point if needed\n    _purgatory: Any = None\n\n    # Add singleton node field\n    _semaphore: SemaphoreNode | None = None\n\n    def __post_init__(self) -&gt; None:\n        \"\"\"Initialize singleton nodes.\"\"\"\n        # ... existing nodes ...\n        self._semaphore = SemaphoreNode(_purgatory=self._purgatory)\n\n    def resolve(self, holon: str, rest: list[str]) -&gt; BaseLogosNode:\n        \"\"\"Resolve a self.* path to a node.\"\"\"\n        match holon:\n            # ... existing cases ...\n            case \"semaphore\":\n                return self._semaphore or SemaphoreNode()\n            case _:\n                # Fallback for undefined holons\n                return GenericSelfNode(holon)\n</code></pre></p>"},{"location":"skills/agentese-path/#step-4-update-factory-function","title":"Step 4: Update Factory Function","text":"<p>If your node needs integration points, update the context's factory function.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <p>Pattern: <pre><code>def create_self_resolver(\n    d_gent: Any = None,\n    n_gent: Any = None,\n    purgatory: Any = None,  # ADD NEW PARAMETER\n) -&gt; SelfContextResolver:\n    \"\"\"Create a SelfContextResolver with optional integrations.\"\"\"\n    resolver = SelfContextResolver()\n    resolver._d_gent = d_gent\n    resolver._n_gent = n_gent\n    resolver._purgatory = purgatory  # WIRE IT IN\n    resolver.__post_init__()\n    return resolver\n</code></pre></p>"},{"location":"skills/agentese-path/#step-5-update-create_context_resolvers","title":"Step 5: Update <code>create_context_resolvers</code>","text":"<p>If you added new integration points, update the unified factory.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/__init__.py</code></p> <p>Pattern: <pre><code>def create_context_resolvers(\n    # ... existing params ...\n    purgatory: Any = None,  # ADD IF NEW\n) -&gt; dict[str, Any]:\n    \"\"\"Create all five context resolvers.\"\"\"\n    return {\n        # ... existing resolvers ...\n        \"self\": create_self_resolver(\n            d_gent=d_gent,\n            n_gent=narrator,\n            purgatory=purgatory,  # PASS IT THROUGH\n        ),\n    }\n</code></pre></p>"},{"location":"skills/agentese-path/#step-6-export-from-__init__py","title":"Step 6: Export from <code>__init__.py</code>","text":"<p>Export your new node class and any constants.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/__init__.py</code></p> <p>Pattern: <pre><code>from .self_ import (\n    # ... existing exports ...\n    SemaphoreNode,  # ADD\n)\n\n__all__ = [\n    # ... existing exports ...\n    \"SemaphoreNode\",  # ADD\n]\n</code></pre></p>"},{"location":"skills/agentese-path/#step-7-write-tests","title":"Step 7: Write Tests","text":"<p>Create tests for your new path.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/_tests/test_&lt;holon&gt;.py</code></p> <p>Template: <pre><code>\"\"\"\nTests for &lt;context&gt;.&lt;holon&gt;.* paths.\n\nTests verify:\n1. Basic functionality of each aspect\n2. Affordance filtering by archetype\n3. Error handling\n4. Integration with services (if applicable)\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom typing import Any, cast\n\nimport pytest\nfrom bootstrap.umwelt import Umwelt\n\nfrom ..&lt;context&gt; import (\n    MyNewNode,\n    create_&lt;context&gt;_resolver,\n)\n\n\n# === Test Fixtures ===\n\nclass MockDNA:\n    \"\"\"Mock DNA for testing.\"\"\"\n    def __init__(self, name: str = \"test\", archetype: str = \"default\") -&gt; None:\n        self.name = name\n        self.archetype = archetype\n        self.capabilities: tuple[str, ...] = ()\n\n\nclass MockUmwelt:\n    \"\"\"Mock Umwelt for testing.\"\"\"\n    def __init__(self, archetype: str = \"default\", name: str = \"test\") -&gt; None:\n        self.dna = MockDNA(name=name, archetype=archetype)\n        self.gravity: tuple[Any, ...] = ()\n        self.context: dict[str, Any] = {}\n\n\n@pytest.fixture\ndef observer() -&gt; Umwelt[Any, Any]:\n    \"\"\"Default observer.\"\"\"\n    return cast(Umwelt[Any, Any], MockUmwelt())\n\n\n@pytest.fixture\ndef resolver() -&gt; &lt;Context&gt;ContextResolver:\n    \"\"\"Context resolver.\"\"\"\n    return create_&lt;context&gt;_resolver()\n\n\n# === Tests ===\n\nclass TestAspect1:\n    \"\"\"Tests for &lt;context&gt;.&lt;holon&gt;.aspect1\"\"\"\n\n    @pytest.mark.asyncio\n    async def test_aspect1_basic(\n        self,\n        resolver: &lt;Context&gt;ContextResolver,\n        observer: Umwelt[Any, Any],\n    ) -&gt; None:\n        \"\"\"Basic test for aspect1.\"\"\"\n        node = resolver.resolve(\"&lt;holon&gt;\", [])\n\n        result = await node._invoke_aspect(\"aspect1\", observer)\n\n        assert result[\"status\"] == \"ok\"\n\n\nclass TestAffordances:\n    \"\"\"Tests for affordance filtering.\"\"\"\n\n    def test_affordances_for_admin(self) -&gt; None:\n        \"\"\"Admin has expected affordances.\"\"\"\n        node = MyNewNode()\n        affordances = node._get_affordances_for_archetype(\"admin\")\n\n        assert \"aspect1\" in affordances\n        assert \"aspect2\" in affordances\n</code></pre></p>"},{"location":"skills/agentese-path/#step-by-step-add-aspect-to-existing-holon","title":"Step-by-Step: Add Aspect to Existing Holon","text":"<p>If you need to add a new aspect to an existing holon (e.g., adding <code>self.memory.dream</code>):</p>"},{"location":"skills/agentese-path/#step-1-add-to-affordances","title":"Step 1: Add to Affordances","text":"<p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <pre><code>SELF_AFFORDANCES: dict[str, tuple[str, ...]] = {\n    \"memory\": (\"consolidate\", \"prune\", \"checkpoint\", \"recall\", \"forget\", \"dream\"),  # ADD\n    # ...\n}\n</code></pre>"},{"location":"skills/agentese-path/#step-2-add-handler-method","title":"Step 2: Add Handler Method","text":"<pre><code>async def _invoke_aspect(\n    self,\n    aspect: str,\n    observer: \"Umwelt[Any, Any]\",\n    **kwargs: Any,\n) -&gt; Any:\n    match aspect:\n        # ... existing cases ...\n        case \"dream\":\n            return await self._dream(observer, **kwargs)\n\nasync def _dream(\n    self,\n    observer: \"Umwelt[Any, Any]\",\n    **kwargs: Any,\n) -&gt; dict[str, Any]:\n    \"\"\"Handle dream aspect - hypnagogic memory consolidation.\"\"\"\n    # Implementation\n    return {\"dreamed\": True}\n</code></pre>"},{"location":"skills/agentese-path/#step-3-add-tests","title":"Step 3: Add Tests","text":"<p>Add test cases for the new aspect.</p>"},{"location":"skills/agentese-path/#forest-handle-appendix-agentese-x-plans-doc-only","title":"Forest Handle Appendix (AGENTESE x Plans) - Doc Only","text":"<p>Forest handles are functor views over planning artifacts. Preserve Minimal Output (one renderable/dict) and category laws (identity/associativity). Use streams over arrays when multiple items are needed.</p> Handle Inputs Output (Minimal Output) Roles (guest/meta/ops) Notes <code>concept.forest.manifest[phase=PLAN][minimal_output=true]</code> observer role, optional <code>{path?, status?, span?}</code> Renderable dict <code>{canopy, ledger_state, affordances}</code> guest: manifest, meta: manifest+affordances, ops: add lint flag Single canopy view; stream sequential manifests if many plans. <code>time.forest.witness[phase=REFLECT][law_check=true]</code> <code>{range?, filter?}</code> Iterator over epilogue events (one per call) guest: read, meta: filter, ops: annotate spans Law check = epilogue order + identity (idempotent replay). <code>concept.forest.refine[phase=DEVELOP][rollback=true][law_check=true]</code> mutation patch <code>{add|prune|fuse}</code> Sympathetic dict <code>{status, applied_patch?, rollback_token?}</code> meta: propose, ops: apply/rollback, guest: read-only Associativity enforced on patch composition; rollback token required for ops. <code>void.forest.sip[phase=RESEARCH][entropy=0.07]</code> <code>{seed?, selector?}</code> <code>{selection, entropy_spent}</code> guest/meta: suggest dormant, ops: approve Accursed Share draw; returns single selection not list. <code>self.forest.define[phase=IMPLEMENT][minimal_output=true]</code> <code>{path, scaffold}</code> <code>{status, draft_header}</code> meta: scaffold, ops: promote, guest: request only Yoneda hint: handle is view; scaffold emitted, not persisted."},{"location":"skills/agentese-path/#categorylaw-notes","title":"Category/Law Notes","text":"<ul> <li>Identity: <code>concept.forest.refine</code> with noop patch is neutral; <code>manifest &gt;&gt; Id = manifest</code>.  </li> <li>Associativity: mutation pipelines respect <code>(a &gt;&gt; b) &gt;&gt; c == a &gt;&gt; (b &gt;&gt; c)</code>; reject reorderings that break ledger consistency.  </li> <li>Minimal Output: never return raw arrays; emit iterator/stream or single renderable.  </li> <li>Yoneda: handles are observer-indexed views; changing observer role changes affordance surface without changing the handle string.</li> </ul>"},{"location":"skills/agentese-path/#clause-micro-prompts-phase-ledger-ready","title":"Clause Micro-Prompts (phase ledger ready)","text":"<ul> <li><code>void.entropy.sip[phase=PLAN][entropy=0.07]@span=forest_plan</code> -&gt; record <code>entropy.spent += 0.07</code>.  </li> <li><code>concept.forest.manifest[phase=RESEARCH][minimal_output=true]@span=forest_trace</code> -&gt; map headers/ledgers, log deviations; sample epilogue via <code>time.forest.witness</code>.  </li> <li><code>concept.forest.refine[phase=DEVELOP][rollback=true][law_check=true]@span=forest_dev</code> -&gt; apply patch; rollback token required on failure.  </li> <li><code>time.forest.witness[phase=REFLECT]@span=forest_trace</code> -&gt; stream last epilogue; log ledger delta.  </li> <li><code>void.entropy.pour[phase=REFLECT]@span=entropy_return</code> -&gt; return unused Accursed Share.  </li> </ul>"},{"location":"skills/agentese-path/#n-phase-continuation-doc-only-forest","title":"N-Phase Continuation (doc-only; forest)","text":"<ul> <li>PLAN: <code>concept.forest.manifest[phase=PLAN][minimal_output=true]@span=forest_plan</code> \u2192 declare scope, non-goals, roles (ops/meta/guest); draw <code>void.entropy.sip[entropy=0.07]</code>.  </li> <li>RESEARCH: <code>concept.forest.manifest[phase=RESEARCH]</code> to map headers/ledgers and log deviations; sample epilogues via <code>time.forest.witness@span=forest_trace</code>.  </li> <li>DEVELOP: <code>concept.forest.refine[phase=DEVELOP][rollback=true][law_check=true]@span=forest_dev</code> \u2192 draft handle/IO/law notes; enforce Minimal Output; persist rollback token.  </li> <li>STRATEGIZE: Order rollout docs \u2192 skills \u2192 dry-run adapters; set observer gating matrix; budget entropy return.  </li> <li>CROSS-SYNERGIZE: Align with <code>process-metrics.md</code>, <code>phase-accountability.md</code>, <code>meta-skill-operad.md</code>; declare Accursed Share rotation <code>void.forest.sip</code>.  </li> <li>IMPLEMENT: Doc-only edits in <code>docs/skills/agentese-path.md</code> and forest/n-phase meta plan; no CLI/impl code.  </li> <li>QA/TEST: Headers \u2264100 lines; <code>phase_ledger</code> + <code>entropy</code> present; clauses carry <code>[phase]</code>, <code>[entropy]</code>, <code>[law_check]</code>, <code>[rollback]</code>, <code>[minimal_output]</code>; dry-run = single renderable per handle, witness ordering stable, refine emits rollback token.  </li> <li>EDUCATE: Capture usage snippets + clause patterns in <code>docs/skills/n-phase-cycle/*</code> meta skills.  </li> <li>MEASURE: Desired spans <code>{phase,tokens_in/out,duration_ms,entropy,law_checks}</code> recorded (deferred).  </li> <li>REFLECT: Log learnings/risks; <code>void.entropy.pour</code> unused; tithe if overdrawn.  </li> </ul>"},{"location":"skills/agentese-path/#rollout-doc-skill-adapter-code-deferred","title":"Rollout (doc -&gt; skill -&gt; adapter -&gt; code deferred)","text":"<ol> <li>Docs (this file + meta plan) define contracts and roles.  </li> <li>N-phase skills embed clause-aware prompts for ledger capture.  </li> <li>Adapter spec (forest meta plan) maps handles to CLI once wiring allowed.  </li> <li>Code hooks (forest CLI, spans) are deferred; keep Minimal Output until live.</li> </ol>"},{"location":"skills/agentese-path/#qaverification-doc-scope","title":"QA/Verification (doc scope)","text":"<ul> <li>Handles declare roles, law checks, and entropy band 0.05-0.10.  </li> <li>Outputs are single renderables or iterators; no arrays.  </li> <li>Clause examples include <code>[phase]</code>, <code>[entropy]</code>, <code>[law_check]</code>, <code>[rollback]</code>.</li> </ul>"},{"location":"skills/agentese-path/#verification","title":"Verification","text":""},{"location":"skills/agentese-path/#test-1-resolve-path","title":"Test 1: Resolve path","text":"<pre><code>cd impl/claude\nuv run python -c \"\nfrom protocols.agentese import create_logos\nlogos = create_logos()\nnode = logos.resolve('&lt;context&gt;.&lt;holon&gt;')\nprint(f'Handle: {node.handle}')\n\"\n</code></pre>"},{"location":"skills/agentese-path/#test-2-check-affordances","title":"Test 2: Check affordances","text":"<pre><code>uv run python -c \"\nfrom protocols.agentese import create_logos\nfrom protocols.agentese.node import AgentMeta\nlogos = create_logos()\nnode = logos.resolve('&lt;context&gt;.&lt;holon&gt;')\nmeta = AgentMeta(name='test', archetype='admin')\nprint(f'Affordances: {node.affordances(meta)}')\n\"\n</code></pre>"},{"location":"skills/agentese-path/#test-3-run-tests","title":"Test 3: Run tests","text":"<pre><code>cd impl/claude\nuv run pytest protocols/agentese/contexts/_tests/test_&lt;holon&gt;.py -v\n</code></pre>"},{"location":"skills/agentese-path/#test-4-full-invoke","title":"Test 4: Full invoke","text":"<pre><code>uv run python -c \"\nimport asyncio\nfrom typing import Any, cast\nfrom bootstrap.umwelt import Umwelt\nfrom protocols.agentese import create_logos\n\nclass MockDNA:\n    def __init__(self, archetype: str = 'admin'):\n        self.name = 'test'\n        self.archetype = archetype\n        self.capabilities: tuple[str, ...] = ()\n\nclass MockUmwelt:\n    def __init__(self, archetype: str = 'admin'):\n        self.dna = MockDNA(archetype=archetype)\n        self.gravity: tuple[Any, ...] = ()\n        self.context: dict[str, Any] = {}\n\nasync def main():\n    logos = create_logos()\n    umwelt = cast(Umwelt[Any, Any], MockUmwelt(archetype='admin'))\n    result = await logos.invoke('&lt;context&gt;.&lt;holon&gt;.&lt;aspect&gt;', umwelt)\n    print(result)\n\nasyncio.run(main())\n\"\n</code></pre>"},{"location":"skills/agentese-path/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/agentese-path/#1-forgetting-to-export-from-__init__py","title":"1. Forgetting to export from <code>__init__.py</code>","text":"<p>Symptom: <code>ImportError</code> when trying to use your node elsewhere.</p> <p>Fix: Add to both imports and <code>__all__</code> in <code>contexts/__init__.py</code>.</p>"},{"location":"skills/agentese-path/#2-not-wiring-integration-points","title":"2. Not wiring integration points","text":"<p>Symptom: Your node always returns \"not configured\" errors.</p> <p>Fix: 1. Add parameter to factory function 2. Pass through in <code>create_context_resolvers()</code> 3. Wire to resolver's <code>__post_init__()</code></p>"},{"location":"skills/agentese-path/#3-missing-property-on-handle","title":"3. Missing <code>@property</code> on handle","text":"<p>Symptom: <code>AttributeError: 'MyNode' object has no attribute 'handle'</code></p> <p>Fix: Ensure <code>handle</code> is a property: <pre><code>@property\ndef handle(self) -&gt; str:\n    return self._handle\n</code></pre></p>"},{"location":"skills/agentese-path/#4-blocking-in-async-methods","title":"4. Blocking in async methods","text":"<p>Symptom: Performance issues, event loop blocked.</p> <p>Fix: Use <code>await</code> for I/O operations, don't do heavy computation in aspect handlers.</p>"},{"location":"skills/agentese-path/#5-not-handling-unknown-aspects","title":"5. Not handling unknown aspects","text":"<p>Symptom: <code>KeyError</code> or crashes on unrecognized aspects.</p> <p>Fix: Always have a default case in your match statement: <pre><code>case _:\n    return {\"aspect\": aspect, \"status\": \"not implemented\"}\n</code></pre></p>"},{"location":"skills/agentese-path/#6-returning-arrays-instead-of-single-values","title":"6. Returning arrays instead of single values","text":"<p>Symptom: Breaks composition pipelines.</p> <p>Fix: Return iterators or single values, never raw arrays (see Minimal Output Principle in spec).</p>"},{"location":"skills/agentese-path/#real-example-adding-selfsemaphore","title":"Real Example: Adding <code>self.semaphore.*</code>","text":"<p>The semaphore path was added in this order:</p> <ol> <li> <p>Affordances in <code>self_.py</code>:    <pre><code>\"semaphore\": (\"pending\", \"yield\", \"status\"),\n</code></pre></p> </li> <li> <p>SemaphoreNode class (100 lines) handling:</p> </li> <li><code>pending</code>: List pending semaphores</li> <li><code>yield</code>: Create new semaphore</li> <li> <p><code>status</code>: Get token status</p> </li> <li> <p>SelfContextResolver update:</p> </li> <li>Added <code>_purgatory: Any = None</code> field</li> <li>Added <code>_semaphore: SemaphoreNode | None = None</code> field</li> <li>Added case in <code>resolve()</code> method</li> <li> <p>Updated <code>__post_init__()</code> to create node</p> </li> <li> <p>Factory update in <code>create_self_resolver()</code>:</p> </li> <li>Added <code>purgatory</code> parameter</li> <li> <p>Wired to resolver</p> </li> <li> <p><code>__init__.py</code> updates:</p> </li> <li>Added <code>SemaphoreNode</code> import</li> <li>Added to <code>__all__</code></li> <li> <p>Updated <code>create_context_resolvers()</code> parameter</p> </li> <li> <p>Tests in <code>contexts/_tests/test_semaphore_paths.py</code> (700 lines)</p> </li> </ol>"},{"location":"skills/agentese-path/#related-skills","title":"Related Skills","text":"<ul> <li>cli-command - Adding CLI commands</li> <li>handler-patterns - Common handler patterns</li> <li>test-patterns - Testing patterns</li> <li>polynomial-agent - Operads and law checks</li> </ul>"},{"location":"skills/agentese-path/#changelog","title":"Changelog","text":"<ul> <li>2025-12-12: Initial version based on <code>self.semaphore.*</code> and <code>world.purgatory.*</code> implementations</li> <li>2025-12-13: Added forest handle appendix, clause micro-prompts, and law/role gates (doc-only)</li> </ul>"},{"location":"skills/building-agent/","title":"Skill: Building an Agent","text":"<p>Create a well-formed agent that composes via functors and integrates with AGENTESE protocols.</p> <p>Difficulty: Medium Prerequisites: Understanding of Agent[A, B] protocol, composition laws, AGENTESE paths Files Touched: <code>impl/claude/agents/&lt;letter&gt;/</code>, <code>impl/claude/protocols/agentese/</code>, tests References: <code>docs/impl-guide.md</code>, <code>spec/principles.md</code></p>"},{"location":"skills/building-agent/#overview","title":"Overview","text":"<p>An agent in kgents is a morphism A \u2192 B in the category of agents. Building an agent well means:</p> <ol> <li>Defining clear input/output types (A and B)</li> <li>Implementing the Agent protocol (name, invoke)</li> <li>Composing linearly via <code>&gt;&gt;</code> and functors</li> <li>Integrating with AGENTESE paths where appropriate</li> <li>Writing specification-faithful tests</li> </ol> <p>This skill synthesizes patterns from recently developed agents (Flux, Semaphores, Creativity) and the design principles.</p>"},{"location":"skills/building-agent/#when-to-use-polynomial-agents-instead","title":"When to Use Polynomial Agents Instead","text":"<p>If your agent needs mode-dependent behavior\u2014different inputs/outputs based on internal state\u2014use a Polynomial Agent instead of <code>Agent[A, B]</code>.</p> Scenario Use <code>Agent[A, B]</code> Use <code>PolyAgent[S, A, B]</code> Stateless transform \u2713 \u2713 (overkill) State machine \u2717 \u2713 Protocol phases \u2717 \u2713 Mode-dependent I/O \u2717 \u2713 <p>See: <code>docs/skills/polynomial-agent.md</code> for the polynomial agent skill guide.</p>"},{"location":"skills/building-agent/#the-agent-protocol","title":"The Agent Protocol","text":"<p>Every agent implements the base protocol from <code>bootstrap/types.py</code>:</p> <pre><code>from bootstrap.types import Agent\nfrom typing import TypeVar\n\nA = TypeVar(\"A\")\nB = TypeVar(\"B\")\n\nclass MyAgent(Agent[A, B]):\n    \"\"\"One-line description of agent purpose.\"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"my-agent\"\n\n    async def invoke(self, input: A) -&gt; B:\n        # Transform input to output\n        return result\n</code></pre>"},{"location":"skills/building-agent/#category-laws-required","title":"Category Laws (Required)","text":"<p>Your agent MUST satisfy these laws:</p> Law Requirement How to Verify Identity <code>Id &gt;&gt; f \u2261 f \u2261 f &gt;&gt; Id</code> Test composition with Id agent Associativity <code>(f &gt;&gt; g) &gt;&gt; h \u2261 f &gt;&gt; (g &gt;&gt; h)</code> Test reordering doesn't change output <p>Implication: Any agent that breaks these laws is NOT a valid agent.</p>"},{"location":"skills/building-agent/#step-by-step-creating-an-agent","title":"Step-by-Step: Creating an Agent","text":""},{"location":"skills/building-agent/#step-1-define-domain-types","title":"Step 1: Define Domain Types","text":"<p>Start with clear input/output types. Use dataclasses for structured data.</p> <p>File: <code>impl/claude/agents/&lt;letter&gt;/types.py</code> (or inline if simple)</p> <pre><code>from __future__ import annotations\nfrom dataclasses import dataclass, field\nfrom typing import Generic, TypeVar\n\n@dataclass(frozen=True)\nclass MyInput:\n    \"\"\"Input to MyAgent. Frozen = immutable.\"\"\"\n    content: str\n    context: dict[str, str] = field(default_factory=dict)\n\n@dataclass\nclass MyOutput:\n    \"\"\"Output from MyAgent.\"\"\"\n    result: str\n    confidence: float\n    metadata: dict[str, str] = field(default_factory=dict)\n</code></pre> <p>Best Practice: Use <code>frozen=True</code> for inputs (immutability), regular dataclasses for outputs that may be enriched downstream.</p>"},{"location":"skills/building-agent/#step-2-implement-the-agent","title":"Step 2: Implement the Agent","text":"<p>File: <code>impl/claude/agents/&lt;letter&gt;/agent.py</code></p> <pre><code>\"\"\"\nMyAgent: Brief description of purpose.\n\nLonger description of what this agent does and why.\n\"\"\"\n\nfrom __future__ import annotations\nfrom dataclasses import dataclass, field\nfrom typing import TYPE_CHECKING\n\nfrom bootstrap.types import Agent\n\nif TYPE_CHECKING:\n    # Heavy imports only for type hints\n    from some_module import HeavyType\n\nfrom .types import MyInput, MyOutput\n\n\n@dataclass\nclass MyAgent(Agent[MyInput, MyOutput]):\n    \"\"\"\n    Description of the agent.\n\n    Example:\n        &gt;&gt;&gt; agent = MyAgent(config=MyConfig())\n        &gt;&gt;&gt; result = await agent.invoke(MyInput(content=\"test\"))\n    \"\"\"\n\n    # Configuration (immutable after construction)\n    config: MyConfig = field(default_factory=MyConfig)\n\n    # Runtime state (private, mutable)\n    _initialized: bool = field(default=False, init=False)\n\n    def __post_init__(self) -&gt; None:\n        \"\"\"Initialize runtime state.\"\"\"\n        self._validate_config()\n        self._initialized = True\n\n    @property\n    def name(self) -&gt; str:\n        return \"my-agent\"\n\n    async def invoke(self, input: MyInput) -&gt; MyOutput:\n        \"\"\"\n        Transform input to output.\n\n        Args:\n            input: The input to process\n\n        Returns:\n            Transformed output\n\n        Raises:\n            ValueError: If input is invalid\n        \"\"\"\n        # 1. Validate\n        self._validate_input(input)\n\n        # 2. Transform\n        result = await self._process(input)\n\n        # 3. Return\n        return MyOutput(\n            result=result,\n            confidence=1.0,\n        )\n\n    # \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    # Private Methods\n    # \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n    def _validate_config(self) -&gt; None:\n        \"\"\"Validate configuration.\"\"\"\n        if self.config.threshold &lt; 0:\n            raise ValueError(\"threshold must be non-negative\")\n\n    def _validate_input(self, input: MyInput) -&gt; None:\n        \"\"\"Validate input.\"\"\"\n        if not input.content:\n            raise ValueError(\"content cannot be empty\")\n\n    async def _process(self, input: MyInput) -&gt; str:\n        \"\"\"Core processing logic.\"\"\"\n        return f\"processed: {input.content}\"\n</code></pre>"},{"location":"skills/building-agent/#step-3-add-composition-support","title":"Step 3: Add Composition Support","text":"<p>Agents compose via <code>&gt;&gt;</code>. The base class provides this, but you may want:</p> <p>1. Pipe operator for FluxAgents (<code>|</code>):</p> <pre><code>def __or__(self, other: \"FluxAgent[B, C]\") -&gt; \"FluxPipeline[A, C]\":\n    \"\"\"Pipe operator for Living Pipelines.\"\"\"\n    from .pipeline import FluxPipeline\n    return FluxPipeline([self, other])\n</code></pre> <p>2. Functor lifting (transform agent behavior):</p> <pre><code>from agents.flux.functor import Flux\n\n# Lift to streaming domain\nflux_agent = Flux.lift(my_agent)\n\n# Lift with config\nflux_agent = Flux.lift(my_agent, FluxConfig(entropy_budget=2.0))\n</code></pre> <p>3. Integration methods (attach external systems):</p> <pre><code>def attach_metabolism(self, metabolism: \"FluxMetabolism[A, B]\") -&gt; None:\n    \"\"\"Attach metabolic adapter for resource tracking.\"\"\"\n    self._metabolism = metabolism\n\ndef detach_metabolism(self) -&gt; None:\n    \"\"\"Detach metabolic adapter.\"\"\"\n    self._metabolism = None\n</code></pre>"},{"location":"skills/building-agent/#step-4-integrate-with-agentese-optional","title":"Step 4: Integrate with AGENTESE (Optional)","text":"<p>If your agent provides semantic affordances, register AGENTESE paths.</p> <p>File: <code>impl/claude/protocols/agentese/contexts/&lt;context&gt;.py</code></p> <pre><code># In the appropriate context (self_, world, concept, void, time)\n\nasync def my_affordance_manifest(\n    self,\n    observer: Umwelt,\n    logos: \"Logos\",\n    **kwargs: Any,\n) -&gt; Any:\n    \"\"\"\n    world.myentity.manifest \u2014 Perceive entity through observer's lens.\n\n    Different observers see different projections:\n    - architect: sees structure\n    - poet: sees metaphor\n    - economist: sees value\n    \"\"\"\n    # Get the entity\n    entity = await self._get_entity(kwargs.get(\"entity_id\"))\n\n    # Project through observer's lens\n    projection = await logos.project(entity, observer)\n\n    return projection\n</code></pre> <p>AGENTESE Path Patterns:</p> Context Purpose Example Paths <code>world.*</code> External entities, tools <code>world.document.manifest</code>, <code>world.purgatory.resolve</code> <code>self.*</code> Internal state, memory <code>self.memory.engram</code>, <code>self.judgment.critique</code> <code>concept.*</code> Abstract platonics <code>concept.blend.forge</code>, <code>concept.summary.refine</code> <code>void.*</code> Entropy, accursed share <code>void.pataphysics.solve</code>, <code>void.entropy.sip</code> <code>time.*</code> Temporal traces <code>time.trace.witness</code>, <code>time.semaphore.deadline</code>"},{"location":"skills/building-agent/#step-5-write-tests","title":"Step 5: Write Tests","text":"<p>File: <code>impl/claude/agents/&lt;letter&gt;/_tests/test_agent.py</code></p> <pre><code>\"\"\"\nTests for MyAgent.\n\nTest Categories (T-gent Types I-V):\n- Type I: Contracts (preconditions, postconditions)\n- Type II: Saboteurs (property-based, fuzzing)\n- Type III: Spies (behavior verification)\n- Type IV: Judges (semantic assertions)\n- Type V: Witnesses (integration, round-trip)\n\"\"\"\n\nfrom __future__ import annotations\n\nimport pytest\n\nfrom ..agent import MyAgent\nfrom ..types import MyConfig, MyInput, MyOutput\n\n\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Type I: Contract Tests\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\nclass TestMyAgentContracts:\n    \"\"\"Test agent satisfies contracts.\"\"\"\n\n    @pytest.fixture\n    def agent(self) -&gt; MyAgent:\n        \"\"\"Create test agent.\"\"\"\n        return MyAgent(config=MyConfig())\n\n    async def test_name_is_stable(self, agent: MyAgent) -&gt; None:\n        \"\"\"Agent name should be stable.\"\"\"\n        assert agent.name == \"my-agent\"\n        assert agent.name == agent.name  # Idempotent\n\n    async def test_invoke_returns_output_type(self, agent: MyAgent) -&gt; None:\n        \"\"\"Invoke should return correct type.\"\"\"\n        result = await agent.invoke(MyInput(content=\"test\"))\n        assert isinstance(result, MyOutput)\n\n    async def test_empty_input_rejected(self, agent: MyAgent) -&gt; None:\n        \"\"\"Empty input should raise ValueError.\"\"\"\n        with pytest.raises(ValueError, match=\"cannot be empty\"):\n            await agent.invoke(MyInput(content=\"\"))\n\n\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Type II: Saboteur Tests (Property-Based)\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\nclass TestMyAgentProperties:\n    \"\"\"Property-based tests for invariants.\"\"\"\n\n    @pytest.mark.parametrize(\"content\", [\"a\", \"ab\", \"a\" * 100, \"unicode: \\u2603\"])\n    async def test_any_nonempty_string_accepted(self, content: str) -&gt; None:\n        \"\"\"Any non-empty string should be processable.\"\"\"\n        agent = MyAgent()\n        result = await agent.invoke(MyInput(content=content))\n        assert result.result  # Non-empty output\n\n\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n# Type V: Witness Tests (Integration)\n# \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\nclass TestMyAgentComposition:\n    \"\"\"Test composition with other agents.\"\"\"\n\n    async def test_identity_law_left(self) -&gt; None:\n        \"\"\"Id &gt;&gt; f \u2261 f.\"\"\"\n        from bootstrap.id import Id\n\n        agent = MyAgent()\n        composed = Id() &gt;&gt; agent\n        input_data = MyInput(content=\"test\")\n\n        direct = await agent.invoke(input_data)\n        via_id = await composed.invoke(input_data)\n\n        assert direct.result == via_id.result\n\n    async def test_identity_law_right(self) -&gt; None:\n        \"\"\"f &gt;&gt; Id \u2261 f.\"\"\"\n        from bootstrap.id import Id\n\n        agent = MyAgent()\n        composed = agent &gt;&gt; Id()\n        input_data = MyInput(content=\"test\")\n\n        direct = await agent.invoke(input_data)\n        via_id = await composed.invoke(input_data)\n\n        assert direct.result == via_id.result\n</code></pre>"},{"location":"skills/building-agent/#functor-catalog","title":"Functor Catalog","text":"<p>These functors linearly modify agent behavior while preserving composition:</p> Functor Signature Purpose File Flux <code>Agent[A,B] \u2192 Agent[Flux[A],Flux[B]]</code> Discrete \u2192 Streaming <code>agents/flux/functor.py</code> Observer <code>Agent[A,B] \u2192 Agent[A,B]</code> Add observation hooks <code>agents/o/observer.py</code> Metered <code>Agent[A,B] \u2192 Agent[A,B]</code> Token budget tracking <code>agents/b/metered_functor.py</code> K <code>Agent[A,B] \u2192 Agent[A,B]</code> Personality navigation <code>agents/k/functor.py</code> Symbiont <code>Agent[A,B] \u00d7 D \u2192 Agent[A,B]</code> Pure logic + D-gent state <code>agents/d/symbiont.py</code>"},{"location":"skills/building-agent/#using-functors","title":"Using Functors","text":"<pre><code>from agents.flux.functor import Flux\nfrom agents.o.observer import ObserverFunctor\nfrom agents.b.metered_functor import MeteredFunctor\n\n# Chain functors (order matters!)\nagent = MyAgent()\nobserved = ObserverFunctor(agent, callbacks=[on_before, on_after])\nmetered = MeteredFunctor(observed, budget=1000)\nflux = Flux.lift(metered)\n\n# Or compose the lifts\npipeline = (\n    Flux.lift(MyAgent())\n    | Flux.lift(AnotherAgent())\n)\n</code></pre>"},{"location":"skills/building-agent/#protocols-for-integration","title":"Protocols for Integration","text":"Protocol Purpose Integration Point Metabolism Resource tracking (entropy, temperature) <code>attach_metabolism()</code> Mirror Observability (Terrarium TUI) <code>attach_mirror()</code> Purgatory Human-in-the-loop (semaphores) <code>attach_purgatory()</code> SemanticField Stigmergic communication (pheromones) <code>field.emit()</code>, <code>field.sense()</code>"},{"location":"skills/building-agent/#example-semaphore-integration-rodizio-pattern","title":"Example: Semaphore Integration (Rodizio Pattern)","text":"<pre><code>from agents.flux.semaphore import SemaphoreToken, SemaphoreReason\n\nclass MyAgent(Agent[MyInput, MyOutput]):\n    async def invoke(self, input: MyInput) -&gt; MyOutput | SemaphoreToken:\n        \"\"\"May yield control to human.\"\"\"\n        if self._needs_human_review(input):\n            # Return red card (Rodizio pattern)\n            return SemaphoreToken.create(\n                reason=SemaphoreReason.APPROVAL_NEEDED,\n                prompt=\"Review this content before proceeding\",\n                frozen_state=self._freeze_state(),\n            )\n        return await self._process(input)\n\n    async def resume(\n        self,\n        frozen_state: bytes,\n        human_input: str,\n    ) -&gt; MyOutput:\n        \"\"\"Resume after human provides input.\"\"\"\n        state = self._thaw_state(frozen_state)\n        return await self._process_with_human_input(state, human_input)\n</code></pre>"},{"location":"skills/building-agent/#anti-patterns-to-avoid","title":"Anti-Patterns to Avoid","text":""},{"location":"skills/building-agent/#1-breaking-composition-laws","title":"1. Breaking Composition Laws","text":"<pre><code># BAD: Agent with hidden state that breaks associativity\nclass BadAgent(Agent[A, B]):\n    counter = 0  # Shared mutable state!\n\n    async def invoke(self, input: A) -&gt; B:\n        BadAgent.counter += 1  # Side effect changes composition behavior\n        ...\n</code></pre>"},{"location":"skills/building-agent/#2-monolithic-agents","title":"2. Monolithic Agents","text":"<pre><code># BAD: God agent that does everything\nclass GodAgent(Agent[Any, Any]):\n    async def invoke(self, input: Any) -&gt; Any:\n        if input.type == \"summarize\": ...\n        elif input.type == \"translate\": ...\n        elif input.type == \"analyze\": ...\n        # Kitchen sink!\n</code></pre> <p>Better: Compose smaller, focused agents.</p>"},{"location":"skills/building-agent/#3-llm-agents-returning-arrays","title":"3. LLM Agents Returning Arrays","text":"<pre><code># BAD: LLM prompted to return array\nclass BadLLMAgent(Agent[Document, list[Improvement]]):\n    async def invoke(self, doc: Document) -&gt; list[Improvement]:\n        # Prompt: \"List all improvements\"\n        ...\n\n# GOOD: LLM returns single output, call N times\nclass GoodLLMAgent(Agent[tuple[Document, Hypothesis], Improvement]):\n    async def invoke(self, input: tuple[Document, Hypothesis]) -&gt; Improvement:\n        # Prompt: \"Evaluate this specific hypothesis\"\n        ...\n</code></pre>"},{"location":"skills/building-agent/#4-blocking-in-async-context","title":"4. Blocking in Async Context","text":"<pre><code># BAD: Blocking call in async method\nasync def invoke(self, input: A) -&gt; B:\n    result = requests.get(url)  # BLOCKS!\n    ...\n\n# GOOD: Use async HTTP\nasync def invoke(self, input: A) -&gt; B:\n    async with aiohttp.ClientSession() as session:\n        async with session.get(url) as resp:\n            ...\n</code></pre>"},{"location":"skills/building-agent/#5-heavy-module-level-imports","title":"5. Heavy Module-Level Imports","text":"<pre><code># BAD: Imported at module load\nfrom heavy_ml_library import model  # 500ms import time\n\n# GOOD: Lazy import\nasync def invoke(self, input: A) -&gt; B:\n    from heavy_ml_library import model  # Only when needed\n    ...\n</code></pre>"},{"location":"skills/building-agent/#llm-backed-agents","title":"LLM-Backed Agents","text":"<p>For agents that invoke LLMs, use the <code>LLMAgent</code> base class from <code>runtime/</code>:</p>"},{"location":"skills/building-agent/#the-llmagent-protocol","title":"The LLMAgent Protocol","text":"<pre><code>from runtime import LLMAgent, AgentContext, AgentResult\n\nclass MySummarizer(LLMAgent[Document, Summary]):\n    \"\"\"\n    Summarize documents using an LLM.\n\n    LLMAgent extends Agent with:\n    - build_prompt(input) \u2192 AgentContext: Convert input to LLM prompt\n    - parse_response(str) \u2192 output: Parse LLM text to structured output\n    \"\"\"\n\n    @property\n    def name(self) -&gt; str:\n        return \"summarizer\"\n\n    async def invoke(self, input: Document) -&gt; Summary:\n        \"\"\"Not used directly - runtime.execute() handles this.\"\"\"\n        raise NotImplementedError(\"Use runtime.execute()\")\n\n    def build_prompt(self, input: Document) -&gt; AgentContext:\n        \"\"\"Convert input to LLM context.\"\"\"\n        return AgentContext(\n            system_prompt=\"You are a precise summarization assistant.\",\n            messages=[{\n                \"role\": \"user\",\n                \"content\": f\"Summarize this document:\\n\\n{input.content}\"\n            }],\n            temperature=0.3,  # Lower for factual tasks\n            max_tokens=1024,\n        )\n\n    def parse_response(self, response: str) -&gt; Summary:\n        \"\"\"Parse LLM response to output type.\"\"\"\n        from runtime import robust_json_parse\n        data = robust_json_parse(response)\n        return Summary(\n            content=data[\"summary\"],\n            key_points=data.get(\"key_points\", []),\n        )\n</code></pre>"},{"location":"skills/building-agent/#agentcontext-fields","title":"AgentContext Fields","text":"Field Type Purpose <code>system_prompt</code> <code>str</code> System message defining agent behavior <code>messages</code> <code>list[dict]</code> Conversation history (role: user/assistant) <code>temperature</code> <code>float</code> Creativity (0.0-1.0, default 0.7) <code>max_tokens</code> <code>int</code> Output limit (default 4096) <code>facts</code> <code>dict | None</code> Grounded facts for RAG patterns <code>metadata</code> <code>dict | None</code> Arbitrary execution metadata"},{"location":"skills/building-agent/#runtimes","title":"Runtimes","text":"<p>Execute LLMAgents via runtimes:</p> <pre><code>from runtime import ClaudeCLIRuntime, ClaudeRuntime, OpenRouterRuntime\n\n# Via Claude Code CLI (uses OAuth, no API key needed)\nruntime = ClaudeCLIRuntime()\n\n# Via Claude API (requires ANTHROPIC_API_KEY)\nruntime = ClaudeRuntime(api_key=os.environ[\"ANTHROPIC_API_KEY\"])\n\n# Via OpenRouter (requires OPENROUTER_API_KEY)\nruntime = OpenRouterRuntime(model=\"anthropic/claude-3.5-sonnet\")\n\n# Execute\nresult: AgentResult[Summary] = await runtime.execute(summarizer, document)\nprint(result.output)  # Summary dataclass\nprint(result.usage)   # {\"input_tokens\": ..., \"output_tokens\": ..., ...}\n</code></pre>"},{"location":"skills/building-agent/#robust-json-parsing","title":"Robust JSON Parsing","text":"<p>LLM responses often have formatting issues. Use <code>robust_json_parse</code>:</p> <pre><code>from runtime import robust_json_parse, parse_structured_sections\n\ndef parse_response(self, response: str) -&gt; MyOutput:\n    \"\"\"\n    robust_json_parse handles:\n    - Markdown code blocks (```json ... ```)\n    - Truncated JSON (auto-closes brackets)\n    - Trailing commas\n    - Extra text before/after JSON\n    \"\"\"\n    data = robust_json_parse(response, allow_partial=True)\n    return MyOutput(**data)\n\n# Or for section-based responses:\ndef parse_response(self, response: str) -&gt; MyOutput:\n    \"\"\"\n    Parse structured sections:\n    RESPONSES:\n    1. First response\n    2. Second response\n\n    FOLLOW-UPS:\n    - Question one?\n    \"\"\"\n    sections = parse_structured_sections(\n        response,\n        [\"responses\", \"follow-ups\"]\n    )\n    return MyOutput(\n        responses=sections.get(\"responses\", []),\n        follow_ups=sections.get(\"follow-ups\", []),\n    )\n</code></pre>"},{"location":"skills/building-agent/#retry-and-error-handling","title":"Retry and Error Handling","text":"<p><code>ClaudeCLIRuntime</code> implements the Fix pattern for retry:</p> <pre><code>runtime = ClaudeCLIRuntime(\n    max_retries=3,           # Retry on parse failures\n    enable_coercion=True,    # Use AI to coerce malformed responses\n    coercion_confidence=0.9, # Minimum confidence for coerced response\n)\n\n# Error types for retry classification:\n# - TransientError: Rate limits, timeouts \u2192 retry with backoff\n# - PermanentError: Auth, invalid input \u2192 fast fail\n# - ParseError: Malformed output \u2192 retry with feedback\n</code></pre>"},{"location":"skills/building-agent/#async-composition","title":"Async Composition","text":"<p>LLMAgents compose asynchronously:</p> <pre><code>from runtime.base import parallel_execute\n\n# Sequential composition\npipeline = extract_facts.then_async(summarize).then_async(format_output)\nresult = await pipeline.execute_async(document, runtime)\n\n# Parallel execution (for I/O-bound LLM calls)\nresults = await parallel_execute(\n    agents=[summarize_agent] * len(documents),\n    inputs=documents,\n    runtime=runtime,\n)\n</code></pre>"},{"location":"skills/building-agent/#llmagent-best-practices","title":"LLMAgent Best Practices","text":"<ol> <li> <p>Single output per invoke (Minimal Output Principle):    <pre><code># BAD: Ask LLM to return array\n\"List all improvements for this code\"\n\n# GOOD: Call N times with specific hypotheses\n\"Evaluate whether this specific change would improve readability\"\n</code></pre></p> </li> <li> <p>Low temperature for factual tasks:    <pre><code>AgentContext(temperature=0.1)  # For extraction, parsing\nAgentContext(temperature=0.7)  # For creative generation\n</code></pre></p> </li> <li> <p>Structured output hints in system prompt:    <pre><code>system_prompt = \"\"\"You are a code analyzer.\n\nOUTPUT FORMAT (JSON):\n{\n    \"issue\": \"description of the issue\",\n    \"severity\": \"low|medium|high\",\n    \"suggestion\": \"how to fix it\"\n}\n\"\"\"\n</code></pre></p> </li> <li> <p>Graceful parse failures:    <pre><code>def parse_response(self, response: str) -&gt; MyOutput:\n    try:\n        data = robust_json_parse(response)\n    except ValueError:\n        # Fallback: extract what we can\n        return MyOutput(\n            content=response[:500],\n            confidence=0.0,  # Mark as low confidence\n        )\n</code></pre></p> </li> </ol>"},{"location":"skills/building-agent/#verification-checklist","title":"Verification Checklist","text":"<p>Before considering your agent complete:</p>"},{"location":"skills/building-agent/#all-agents","title":"All Agents","text":"<ul> <li> <code>Agent[A, B]</code> protocol implemented (name, invoke)</li> <li> Input/output types are clear dataclasses</li> <li> Category laws verified (identity, associativity)</li> <li> Tests cover contracts, properties, and composition</li> <li> No module-level heavy imports (Hollow Shell pattern)</li> <li> No blocking calls in async methods</li> <li> Follows Minimal Output Principle (single output per invoke)</li> <li> Integrates with relevant protocols (Metabolism, Mirror, etc.)</li> <li> AGENTESE paths registered if providing semantic affordances</li> <li> Mypy strict passes (<code>uv run mypy .</code>)</li> <li> Ruff passes (<code>uv run ruff check</code>)</li> </ul>"},{"location":"skills/building-agent/#llmagent-specific","title":"LLMAgent-Specific","text":"<ul> <li> <code>build_prompt()</code> returns well-formed <code>AgentContext</code></li> <li> <code>parse_response()</code> uses <code>robust_json_parse</code> for JSON outputs</li> <li> System prompt includes explicit output format</li> <li> Temperature set appropriately (low for factual, higher for creative)</li> <li> Error handling for malformed LLM responses</li> <li> Tests mock the runtime (don't call real LLMs in unit tests)</li> </ul>"},{"location":"skills/building-agent/#d-gent-memory-patterns","title":"D-gent Memory Patterns","text":"<p>Agents needing durable state use D-gent patterns. Choose based on access patterns:</p>"},{"location":"skills/building-agent/#pattern-selection-guide","title":"Pattern Selection Guide","text":"Pattern Use Case Files Symbiont Pure logic + stateful memory <code>agents/d/symbiont.py</code> Bicameral Relational + vector (semantic search) <code>agents/d/bicameral.py</code> StoreComonad Event-sourced with time-travel <code>agents/d/context_comonad.py</code> LinearityMap Resource tracking for context compression <code>agents/d/linearity.py</code>"},{"location":"skills/building-agent/#symbiont-pattern-simplest","title":"Symbiont Pattern (Simplest)","text":"<p>The Symbiont fuses stateless logic with stateful memory. Your logic is pure; D-gent handles persistence.</p> <pre><code>from agents.d import Symbiont, VolatileAgent\n\n# 1. Define pure logic: (Input, State) \u2192 (Output, NewState)\ndef chat_logic(msg: str, history: list) -&gt; tuple[str, list]:\n    history.append((\"user\", msg))\n    response = f\"Echo: {msg}\"\n    history.append((\"bot\", response))\n    return response, history\n\n# 2. Create D-gent for persistence (Volatile = in-memory)\nmemory = VolatileAgent(_state=[])\n\n# 3. Fuse into Symbiont (valid Agent, composes via &gt;&gt;)\nchatbot = Symbiont(logic=chat_logic, memory=memory)\n\n# 4. Use like any agent\nresult = await chatbot.invoke(\"Hello\")  # Returns \"Echo: Hello\"\n</code></pre> <p>Key Insight: Logic is testable without mocks (pure function). Memory is swappable (volatile \u2192 SQLite \u2192 Redis).</p>"},{"location":"skills/building-agent/#bicameral-memory-semantic-search","title":"Bicameral Memory (Semantic Search)","text":"<p>For agents needing both exact queries AND semantic similarity:</p> <pre><code>from agents.d import BicameralMemory, BicameralConfig\n\n# Create with Left (relational) + Right (vector) hemispheres\nbicameral = BicameralMemory(\n    left_hemisphere=relational_store,   # Source of truth (ACID)\n    right_hemisphere=vector_store,      # Semantic index\n    embedding_provider=embedder,\n    config=BicameralConfig(\n        auto_heal_ghosts=True,          # Auto-delete stale vectors\n        coherency_check_on_recall=True, # Validate on every recall\n    ),\n)\n\n# Store (writes to both hemispheres)\nawait bicameral.store(\"insight-001\", {\n    \"type\": \"insight\",\n    \"content\": \"Category theory unifies all D-gent patterns\",\n})\n\n# Semantic recall (validates against relational)\nresults = await bicameral.recall(\"category theory patterns\")\n# \u2192 Ghost memories auto-healed, stale embeddings flagged\n\n# Direct fetch (bypasses vector, for known IDs)\ndata = await bicameral.fetch(\"insight-001\")\n\n# Health check\nreport = await bicameral.coherency_check()\nprint(f\"Coherency rate: {report.coherency_rate:.1%}\")\n</code></pre> <p>Ghost Memory Problem: Vector entry points to deleted relational row \u2192 hallucination. Solution: Coherency Protocol validates on recall, auto-heals ghosts.</p>"},{"location":"skills/building-agent/#storecomonad-event-sourcing-with-time-travel","title":"StoreComonad (Event Sourcing with Time Travel)","text":"<p>For agents needing full history and replay:</p> <pre><code>from agents.d import StoreComonad, create_ledger_store\nfrom pathlib import Path\n\n# Create event-sourced store\nstore = create_ledger_store(\n    persistence_path=Path(\"~/.kgents/ledger.jsonl\").expanduser()\n)\n\n# Append events (immutable history)\nstore.append({\n    \"event_type\": \"CREDIT\",\n    \"agent\": \"b-gent\",\n    \"amount\": 0.1,\n})\n\n# Extract current state (comonad extract)\nbalances = store.extract()  # {\"b-gent\": 0.6}\n\n# Time-travel: state at any position\nhistorical_balances = store.replay_to(position=5)\n\n# Track value over time (comonad extend)\ndef agent_balance(s: StoreComonad) -&gt; float:\n    return s.extract().get(\"b-gent\", 0.0)\n\nhistory = store.extend(agent_balance)  # [0.5, 0.6, 0.55, ...]\n\n# Get all snapshots (comonad duplicate)\nsnapshots = store.duplicate()  # Full zipper over history\n</code></pre> <p>Comonad Laws: <code>extract . duplicate = id</code>, <code>fmap extract . duplicate = id</code>.</p>"},{"location":"skills/building-agent/#linearitymap-resource-tracking","title":"LinearityMap (Resource Tracking)","text":"<p>For context compression\u2014track which resources can be dropped:</p> <pre><code>from agents.d import LinearityMap, ResourceClass\n\nlm = LinearityMap()\n\n# Tag resources by class\nobs_id = lm.tag(\n    \"user clicked button\",\n    ResourceClass.DROPPABLE,  # Can be discarded\n    provenance=\"ui_event\",\n)\n\ndec_id = lm.tag(\n    \"chose option A\",\n    ResourceClass.REQUIRED,   # Must flow to output\n    provenance=\"decision\",\n)\n\nfocus_id = lm.tag(\n    \"critical user instruction\",\n    ResourceClass.PRESERVED,  # Must survive verbatim\n    provenance=\"user_input\",\n)\n\n# Query what can be dropped\ndroppable_ids = lm.droppable()\n\n# Promote (one-way, enforces monotonicity)\nlm.promote(obs_id, ResourceClass.REQUIRED, \"became decision-relevant\")\n\n# Bulk drop droppables (for context compression)\ndropped_count = lm.drop_all_droppable()\n\n# Partition for summarization\npartition = lm.partition()\n# {DROPPABLE: [...], REQUIRED: [...], PRESERVED: [...]}\n</code></pre> <p>Resource Classes (partial order: DROPPABLE &lt; REQUIRED &lt; PRESERVED): - DROPPABLE: Observations, intermediate computations - REQUIRED: Reasoning traces, decisions - PRESERVED: User inputs, code blocks (verbatim)</p>"},{"location":"skills/building-agent/#related-skills","title":"Related Skills","text":"<ul> <li>cli-command - Exposing agent via CLI</li> <li>agentese-path - Registering AGENTESE paths</li> <li>flux-agent - Creating streaming agents</li> <li>test-patterns - T-gent Types I-V testing</li> <li>agent-observability - Metrics, mirrors, pheromones</li> </ul>"},{"location":"skills/building-agent/#changelog","title":"Changelog","text":"<ul> <li>2025-12-12: Added D-gent memory patterns (Symbiont, Bicameral, StoreComonad, LinearityMap)</li> <li>2025-12-12: Added LLMAgent section with runtime patterns, JSON parsing, and best practices</li> <li>2025-12-12: Initial version synthesizing patterns from Flux, Semaphores, Creativity</li> </ul>"},{"location":"skills/crown-jewel-patterns/","title":"Skill: Crown Jewel Implementation Patterns","text":"<p>\"The first jewel teaches how to craft all the others.\"</p> <p>Difficulty: Intermediate Prerequisites: <code>polynomial-agent.md</code>, <code>agentese-path.md</code> Source: Gardener-Logos post-implementation reflection Spec: <code>spec/protocols/gardener-logos.md</code> Appendix C</p>"},{"location":"skills/crown-jewel-patterns/#overview","title":"Overview","text":"<p>These patterns emerged from implementing Gardener-Logos (the first jewel to reach 100%). They apply broadly to all Crown Jewels and represent tested, production-ready approaches.</p>"},{"location":"skills/crown-jewel-patterns/#pattern-1-container-owns-workflow","title":"Pattern 1: Container Owns Workflow","text":"<p>Problem: Workflows (sessions, tasks, exhibitions) need lifecycle management within persistent state.</p> <p>Wrong: Workflow creates Container <pre><code># Workflow creates its own home \u2192 orphaned when workflow ends\nsession = GardenerSession(name=\"work\")\ngarden = session.create_garden()  # Garden dies with session\n</code></pre></p> <p>Right: Container owns Workflow <pre><code>class Container:\n    _workflow: Workflow | None = None\n    workflow_id: str | None = None  # For history\n\n    def get_or_create_workflow(self, name: str) -&gt; Workflow:\n        if self._workflow is None:\n            self._workflow = create_workflow(name)\n            self.workflow_id = self._workflow.id\n            self._on_workflow_started()  # State transition\n        return self._workflow\n\n    async def on_workflow_complete(self):\n        await self._on_workflow_ended()\n        self._workflow = None\n        # workflow_id preserved for history\n</code></pre></p> <p>Benefits: - Container persists across workflows - Clean lifecycle management - History preserved via ID</p> <p>Apply to: | Jewel | Container | Workflow | |-------|-----------|----------| | Gardener | Garden | Session | | Atelier | Gallery | Exhibition | | Coalition | Forge | Task | | Park | Scenario | Simulation |</p>"},{"location":"skills/crown-jewel-patterns/#pattern-2-enum-property-pattern","title":"Pattern 2: Enum Property Pattern","text":"<p>Problem: Enum values need associated metadata (colors, costs, valid transitions).</p> <p>Wrong: External lookup dictionaries <pre><code>class Status(Enum):\n    PENDING = auto()\n    ACTIVE = auto()\n\n# Scattered across codebase\nSTATUS_COLORS = {Status.PENDING: \"yellow\", Status.ACTIVE: \"blue\"}\nSTATUS_COSTS = {Status.PENDING: 0.1, Status.ACTIVE: 0.5}\n</code></pre></p> <p>Right: Properties on enum <pre><code>class Status(Enum):\n    PENDING = auto()\n    ACTIVE = auto()\n    COMPLETE = auto()\n\n    @property\n    def color(self) -&gt; str:\n        return {\n            Status.PENDING: \"yellow\",\n            Status.ACTIVE: \"blue\",\n            Status.COMPLETE: \"green\",\n        }[self]\n\n    @property\n    def cost(self) -&gt; float:\n        return {\n            Status.PENDING: 0.1,\n            Status.ACTIVE: 0.5,\n            Status.COMPLETE: 0.0,\n        }[self]\n\n    @property\n    def can_transition_to(self) -&gt; set[\"Status\"]:\n        return {\n            Status.PENDING: {Status.ACTIVE},\n            Status.ACTIVE: {Status.COMPLETE, Status.PENDING},\n            Status.COMPLETE: set(),\n        }[self]\n</code></pre></p> <p>Benefits: - Metadata co-located with enum - IDE autocomplete works - Type-safe access</p> <p>Apply to: | Jewel | Enum | Properties | |-------|------|------------| | Gardener | GardenSeason | plasticity, entropy_multiplier, emoji | | Gardener | TendingVerb | base_entropy_cost, affects_state, emoji | | Atelier | BidState | can_outbid, min_increment | | Coalition | AgentRole | capabilities, cost_multiplier | | Park | MaskType | interactivity, visibility |</p>"},{"location":"skills/crown-jewel-patterns/#pattern-3-multiplied-context-effect","title":"Pattern 3: Multiplied Context Effect","text":"<p>Problem: Context should modulate user intent, not override it.</p> <p>Wrong: Binary context <pre><code># Context overrides intent entirely\nif season == DORMANT:\n    learning_rate = 0.0  # No learning possible\nelse:\n    learning_rate = user_tone  # Full learning\n</code></pre></p> <p>Right: Multiplied effect <pre><code># Context modulates intent smoothly\neffective_rate = user_intent * context_factor\n\n# Gardener example:\nlearning_rate = gesture.tone * season.plasticity\n# SPROUTING (0.9) \u00d7 definitive (1.0) \u2192 0.9 (aggressive)\n# DORMANT (0.1) \u00d7 tentative (0.3) \u2192 0.03 (minimal)\n</code></pre></p> <p>Benefits: - Smooth gradients, no cliff edges - User intent always factors in - No explosion of special cases</p> <p>Apply to: | Jewel | Intent | Context | Effect | |-------|--------|---------|--------| | Gardener | tone | plasticity | learning_rate | | Atelier | bid_amount | market_heat | effective_bid | | Coalition | urgency | agent_load | priority_score | | Park | immersion | scenario_intensity | experience |</p>"},{"location":"skills/crown-jewel-patterns/#pattern-4-signal-aggregation-for-decisions","title":"Pattern 4: Signal Aggregation for Decisions","text":"<p>Problem: Complex decisions require weighing multiple factors.</p> <p>Wrong: Boolean explosion <pre><code>if gesture_freq &gt; 2 and entropy &lt; 0.5 and session_active:\n    transition = True\nelif gesture_freq &gt; 1 and entropy &lt; 0.7:\n    transition = True  # Different threshold, duplicated logic\n</code></pre></p> <p>Right: Confidence aggregation <pre><code>def evaluate_transition(signals: Signals) -&gt; tuple[float, str]:\n    confidence = 0.0\n    reasons = []\n\n    # Each signal contributes independently\n    if signals.gesture_frequency &gt; 2.0:\n        confidence += 0.5\n        reasons.append(f\"High activity ({signals.gesture_frequency:.1f}/h)\")\n    elif signals.gesture_frequency &gt; 1.0:\n        confidence += 0.3\n        reasons.append(f\"Moderate activity ({signals.gesture_frequency:.1f}/h)\")\n\n    if signals.entropy_available &gt; 0.5:\n        confidence += 0.3\n        reasons.append(\"Entropy available\")\n\n    if signals.session_active:\n        confidence += 0.2\n        reasons.append(\"Session active\")\n\n    return min(1.0, confidence), \"; \".join(reasons)\n\n# Usage\nconfidence, reason = evaluate_transition(signals)\nif confidence &gt;= THRESHOLD:\n    suggest_transition(reason)\n</code></pre></p> <p>Benefits: - Transparent (see why decision was made) - Composable (add/remove signals easily) - Tunable (adjust weights) - Explains itself (reasons string)</p> <p>Apply to: | Jewel | Decision | Signals | |-------|----------|---------| | Gardener | Season transition | gesture_freq, entropy, session | | Coalition | Agent recommendation | skill_match, availability, past_success | | Atelier | Bid suggestion | market_value, creator_reputation, demand | | Gestalt | Drift alert | dependency_freshness, breaking_changes, usage |</p>"},{"location":"skills/crown-jewel-patterns/#pattern-5-dismissal-memory","title":"Pattern 5: Dismissal Memory","text":"<p>Problem: Suggestions that are dismissed should not immediately reappear.</p> <p>Implementation: <pre><code>from datetime import datetime, timedelta\n\n_dismissed: dict[str, datetime] = {}\nCOOLDOWN_HOURS = 4\n\ndef dismiss(key: str) -&gt; None:\n    \"\"\"Record that a suggestion was dismissed.\"\"\"\n    _dismissed[key] = datetime.now()\n\ndef should_suggest(key: str) -&gt; bool:\n    \"\"\"Check if suggestion can be made (not recently dismissed).\"\"\"\n    dismissed_at = _dismissed.get(key)\n    if dismissed_at is None:\n        return True\n    return datetime.now() - dismissed_at &gt;= timedelta(hours=COOLDOWN_HOURS)\n\ndef clear_dismissals(prefix: str) -&gt; None:\n    \"\"\"Clear all dismissals matching prefix.\"\"\"\n    keys_to_remove = [k for k in _dismissed if k.startswith(prefix)]\n    for key in keys_to_remove:\n        del _dismissed[key]\n</code></pre></p> <p>Benefits: - Respects user's \"not now\" - Time-bounded (resurfaces when context may have changed) - Memory-efficient (only stores timestamps)</p> <p>Apply to: | Jewel | Suggestion Type | Key Format | |-------|-----------------|------------| | Gardener | Season transition | <code>{garden_id}:{from}\u2192{to}</code> | | Gestalt | Drift alert | <code>{module}:{dependency}</code> | | Atelier | Style recommendation | <code>{creator}:{style}</code> | | Coalition | Team suggestion | <code>{task}:{agent_combo}</code> |</p>"},{"location":"skills/crown-jewel-patterns/#pattern-6-async-safe-event-emission","title":"Pattern 6: Async-Safe Event Emission","text":"<p>Problem: Sync methods need to emit events to async systems.</p> <p>Implementation: <pre><code>import asyncio\n\ndef sync_method_with_event(self, data, emit_event=True):\n    # ... sync state changes ...\n\n    if emit_event:\n        try:\n            loop = asyncio.get_running_loop()\n            loop.create_task(self._emit_event(data))\n        except RuntimeError:\n            # No running event loop - skip emission\n            import logging\n            logger = logging.getLogger(__name__)\n            logger.debug(f\"No event loop for emission: {data}\")\n\nasync def _emit_event(self, data):\n    from protocols.synergy import get_synergy_bus\n    event = create_event(data)\n    await get_synergy_bus().emit(event)\n</code></pre></p> <p>Benefits: - Core methods stay sync (simpler, easier to test) - Events still emitted when async context exists - Graceful degradation when no event loop</p> <p>Apply to: All jewels that emit synergy events from state transitions.</p>"},{"location":"skills/crown-jewel-patterns/#pattern-7-dual-channel-output","title":"Pattern 7: Dual-Channel Output","text":"<p>Problem: CLI commands should serve both humans and agents.</p> <p>Implementation: <pre><code>def _emit_output(\n    human: str,\n    semantic: dict,\n    ctx: \"InvocationContext | None\",\n) -&gt; None:\n    \"\"\"Emit both human-readable and machine-readable output.\"\"\"\n    if ctx is not None:\n        ctx.output(human=human, semantic=semantic)\n    else:\n        # Fallback for direct invocation\n        print(human)\n\n# Usage\n_emit_output(\n    human=f\"\\n  {garden.season.emoji} Garden: {garden.name}\\n\",\n    semantic={\n        \"garden_id\": garden.garden_id,\n        \"season\": garden.season.name,\n        \"health\": garden.metrics.health_score,\n    },\n    ctx=ctx,\n)\n</code></pre></p> <p>Benefits: - Same command serves humans (terminal) and agents (JSON) - No duplicate command implementations - Consistent semantics across interfaces</p> <p>Apply to: All CLI handlers via <code>protocols/cli/handlers/</code>.</p>"},{"location":"skills/crown-jewel-patterns/#pattern-8-bounded-history-trace","title":"Pattern 8: Bounded History Trace","text":"<p>Problem: History should enable analysis without unbounded growth.</p> <p>Implementation: <pre><code>from dataclasses import dataclass, field\nfrom datetime import datetime, timedelta\n\n@dataclass(frozen=True)  # Immutable!\nclass HistoryEntry:\n    action: str\n    target: str\n    timestamp: datetime = field(default_factory=datetime.now)\n\n    def is_recent(self, hours: int = 24) -&gt; bool:\n        return datetime.now() - self.timestamp &lt; timedelta(hours=hours)\n\nclass Container:\n    history: list[HistoryEntry] = field(default_factory=list)\n    MAX_HISTORY = 50\n\n    def add_history(self, entry: HistoryEntry) -&gt; None:\n        self.history.append(entry)\n        if len(self.history) &gt; self.MAX_HISTORY:\n            self.history = self.history[-self.MAX_HISTORY:]\n\n    @property\n    def recent_diversity(self) -&gt; int:\n        \"\"\"Count unique actions in recent history.\"\"\"\n        recent = [e for e in self.history if e.is_recent()]\n        return len({e.action for e in recent})\n</code></pre></p> <p>Benefits: - Bounded memory (never grows past MAX) - Enables trajectory analysis (diversity, frequency) - Immutable entries (facts, not mutable state)</p> <p>Apply to: | Jewel | History Type | Analysis | |-------|--------------|----------| | Gardener | Gestures | trajectory, frequency, diversity | | Atelier | Bids | market trends, creator patterns | | Coalition | Task assignments | agent utilization, success rates | | Park | Player actions | engagement, decision patterns |</p>"},{"location":"skills/crown-jewel-patterns/#pattern-9-directed-state-cycle","title":"Pattern 9: Directed State Cycle","text":"<p>Problem: State machines can have too many valid transitions, creating chaos.</p> <p>Wrong: Fully-connected <pre><code>Any state \u2192 Any other state (exponential complexity)\n</code></pre></p> <p>Right: Directed cycle <pre><code>     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n     \u2502                                     \u2502\n     \u25bc                                     \u2502\n  STATE_1 \u2500\u2500\u2500\u2500\u2500\u2500\u25ba STATE_2 \u2500\u2500\u2500\u2500\u2500\u2500\u25ba STATE_3\n     \u25b2                                     \u2502\n     \u2502                                     \u25bc\n  STATE_5 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500 STATE_4 \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre></p> <p>Implementation: <pre><code>TRANSITION_RULES: dict[State, list[State]] = {\n    State.DORMANT: [State.SPROUTING],      # One forward\n    State.SPROUTING: [State.BLOOMING],     # One forward\n    State.BLOOMING: [State.HARVEST],       # One forward\n    State.HARVEST: [State.COMPOSTING],     # One forward\n    State.COMPOSTING: [State.DORMANT],     # Back to start\n}\n\ndef can_transition(from_state: State, to_state: State) -&gt; bool:\n    return to_state in TRANSITION_RULES.get(from_state, [])\n</code></pre></p> <p>Benefits: - One rule per state (simple) - Natural rhythm (clear progression) - Prevents chaotic jumping</p> <p>Apply to: | Jewel | Cycle | |-------|-------| | Gardener | DORMANT\u2192SPROUTING\u2192BLOOMING\u2192HARVEST\u2192COMPOSTING\u2192DORMANT | | Atelier | DRAFT\u2192BIDDING\u2192EVALUATION\u2192AWARD\u2192COMPLETE | | Coalition | FORMING\u2192ASSIGNED\u2192EXECUTING\u2192REVIEWING\u2192DISBANDED | | Park | SETUP\u2192RUNNING\u2192PAUSED\u2192COMPLETE |</p>"},{"location":"skills/crown-jewel-patterns/#pattern-10-operad-inheritance","title":"Pattern 10: Operad Inheritance","text":"<p>Problem: New domains need composition grammar that builds on existing operads.</p> <p>Wrong: Copy-paste operations <pre><code># Duplicated operations across operads\nJEWEL_OPERAD = Operad(\n    operations={\n        \"split\": Operation(...),  # Copied from DESIGN_OPERAD\n        \"stack\": Operation(...),  # Copied again\n        # ... all duplicated\n    }\n)\n</code></pre></p> <p>Right: Spread inheritance <pre><code>def create_emergence_operad() -&gt; Operad:\n    from agents.design import DESIGN_OPERAD\n\n    return Operad(\n        name=\"EMERGENCE\",\n        operations={\n            # Domain-specific operations\n            \"select_family\": Operation(arity=1, ...),\n            \"modulate_qualia\": Operation(arity=2, ...),\n            # Inherit all DESIGN_OPERAD operations\n            **DESIGN_OPERAD.operations,\n        },\n        laws=[\n            Law(name=\"pattern_commutativity\", ...),\n            # Inherit all DESIGN_OPERAD laws\n            *DESIGN_OPERAD.laws,\n        ],\n    )\n</code></pre></p> <p>Benefits: - Single source of truth for base operations - Domain-specific operations compose with inherited ones - Law inheritance ensures consistency</p> <p>Apply to: | Child Operad | Parent | Domain-Specific Ops | |--------------|--------|---------------------| | EMERGENCE_OPERAD | DESIGN_OPERAD | select_family, tune_param, modulate_qualia | | TOWN_OPERAD | AGENT_OPERAD | greet, gossip, trade, solo | | WORKSHOP_OPERAD | DESIGN_OPERAD | create_piece, curate, exhibit |</p>"},{"location":"skills/crown-jewel-patterns/#pattern-11-circadian-modulation","title":"Pattern 11: Circadian Modulation","text":"<p>Problem: UI should feel different at different times of day without being disruptive.</p> <p>Implementation (Backend): <pre><code>class CircadianPhase(Enum):\n    DAWN = \"dawn\"      # 6-10\n    NOON = \"noon\"      # 10-16\n    DUSK = \"dusk\"      # 16-20\n    MIDNIGHT = \"midnight\"  # 20-6\n\n    @classmethod\n    def from_hour(cls, hour: int) -&gt; \"CircadianPhase\":\n        if 6 &lt;= hour &lt; 10: return cls.DAWN\n        if 10 &lt;= hour &lt; 16: return cls.NOON\n        if 16 &lt;= hour &lt; 20: return cls.DUSK\n        return cls.MIDNIGHT\n\n@dataclass(frozen=True)\nclass QualiaModifier:\n    warmth: float    # -1 to 1 (additive)\n    brightness: float  # 0 to 1 (multiplicative)\n    tempo: float     # -1 to 1 (additive to animation speed)\n\nCIRCADIAN_MODIFIERS = {\n    CircadianPhase.DAWN: QualiaModifier(warmth=-0.2, brightness=0.8, tempo=0.2),\n    CircadianPhase.NOON: QualiaModifier(warmth=0.0, brightness=1.0, tempo=0.0),\n    CircadianPhase.DUSK: QualiaModifier(warmth=0.3, brightness=0.6, tempo=-0.2),\n    CircadianPhase.MIDNIGHT: QualiaModifier(warmth=-0.1, brightness=0.3, tempo=-0.4),\n}\n</code></pre></p> <p>Implementation (Frontend): <pre><code>function useCircadian() {\n  const [phase, setPhase] = useState&lt;CircadianPhase&gt;(() =&gt;\n    getCircadianPhase(new Date().getHours())\n  );\n  const [override, setOverride] = useState&lt;CircadianPhase | null&gt;(null);\n\n  useEffect(() =&gt; {\n    const interval = setInterval(() =&gt; {\n      setPhase(getCircadianPhase(new Date().getHours()));\n    }, 60000);  // Update every minute\n    return () =&gt; clearInterval(interval);\n  }, []);\n\n  return {\n    phase: override ?? phase,\n    modifier: CIRCADIAN_MODIFIERS[override ?? phase],\n    setOverride,\n    clearOverride: () =&gt; setOverride(null),\n    isOverridden: override !== null,\n  };\n}\n</code></pre></p> <p>Benefits: - Subtle mood shifts (dusk = warmer, slower) - Manual override for demos - Backend + frontend alignment</p> <p>Apply to: | Jewel | What Changes | Effect | |-------|-------------|--------| | Emergence | Pattern hue, animation speed | Warmer at dusk, slower at midnight | | Gestalt | Dashboard accent color | Cooler in morning, warmer evening | | Town | Citizen activity patterns | More active at noon, reflective at midnight |</p>"},{"location":"skills/crown-jewel-patterns/#pattern-12-law-honesty-structural-status","title":"Pattern 12: Law Honesty (STRUCTURAL Status)","text":"<p>Problem: Some operad laws express design constraints, not runtime-verifiable invariants.</p> <p>Wrong: Pretend laws always pass <pre><code>def _verify_commutativity(*args) -&gt; LawVerification:\n    # This doesn't actually verify anything!\n    return LawVerification(status=LawStatus.PASSED, ...)\n</code></pre></p> <p>Right: Honest STRUCTURAL status <pre><code>def _verify_pattern_commutativity(*args) -&gt; LawVerification:\n    \"\"\"\n    HONESTY: This law is STRUCTURAL, not runtime-verified.\n\n    Pattern selection and parameter tuning DON'T fully commute because\n    select_family resets config while tune_param modifies existing.\n    Order matters for final values, but operations don't interfere.\n\n    We mark as STRUCTURAL to indicate this is a design choice.\n    \"\"\"\n    return LawVerification(\n        law_name=\"pattern_commutativity\",\n        status=LawStatus.STRUCTURAL,\n        message=\"Design choice: select_family resets, tune_param modifies\",\n    )\n</code></pre></p> <p>When to use each status: | Status | When | Example | |--------|------|---------| | PASSED | Runtime verification succeeds | <code>qualia.blend(a,b,0.5) = qualia.blend(b,a,0.5)</code> | | FAILED | Runtime verification fails | Composition produces wrong result | | STRUCTURAL | Design constraint, not runtime | Commutativity is intentionally broken | | SKIPPED | Cannot verify (missing deps) | External service unavailable |</p> <p>Benefits: - Honest documentation of law behavior - Tests can expect STRUCTURAL (not fake PASSED) - Design intent is clear</p>"},{"location":"skills/crown-jewel-patterns/#pattern-13-contract-first-types-phase-7","title":"Pattern 13: Contract-First Types (Phase 7)","text":"<p>Problem: BE (Python) and FE (TypeScript) type definitions drift because they're defined separately.</p> <p>Wrong: Duplicate type definitions <pre><code># Python backend\n@dataclass\nclass TownManifest:\n    name: str\n    citizen_count: int  # Might rename to \"count\"\n</code></pre></p> <pre><code>// TypeScript frontend (may drift!)\ninterface TownManifest {\n  name: string;\n  citizenCount: number;  // Already drifted!\n}\n</code></pre> <p>Right: <code>@node(contracts={})</code> is the authority <pre><code>from dataclasses import dataclass\nfrom protocols.agentese.contract import Contract, Response\nfrom protocols.agentese.registry import node\n\n@dataclass\nclass TownManifestResponse:\n    \"\"\"Response for manifest aspect.\"\"\"\n    name: str\n    citizen_count: int\n\n@dataclass\nclass CitizenCreateRequest:\n    name: str\n    archetype: str\n\n@dataclass\nclass CitizenCreateResponse:\n    citizen_id: str\n    success: bool\n\n@node(\n    \"world.town\",\n    description=\"Agent Town Crown Jewel\",\n    contracts={\n        # Perception aspects (no request needed)\n        \"manifest\": Response(TownManifestResponse),\n        # Mutation aspects (request + response)\n        \"citizen.create\": Contract(CitizenCreateRequest, CitizenCreateResponse),\n    }\n)\n@dataclass\nclass TownNode(BaseLogosNode):\n    ...\n</code></pre></p> <p>Frontend discovers at build time: <pre><code># Generate TypeScript from BE contracts\nnpm run sync-types\n\n# Verify types are in sync (CI)\nnpm run sync-types:check\n</code></pre></p> <p>Benefits: - Single source of truth (Python dataclass) - Type drift caught in CI before merge - JSON Schema bridges Python \u2192 TypeScript - Contract coverage tracked as metric</p> <p>Type Separation: | Category | Location | Source | |----------|----------|--------| | Contract Types | <code>_generated/</code> | BE discovery | | Local Types | <code>_local.ts</code> | FE-only (colors, icons) |</p> <p>Apply to: All Crown Jewel <code>@node</code> registrations.</p> <p>See: <code>agentese-contract-protocol.md</code> for complete documentation.</p>"},{"location":"skills/crown-jewel-patterns/#pattern-14-teaching-mode-toggle","title":"Pattern 14: Teaching Mode Toggle","text":"<p>Problem: Users need to toggle between \"power user\" and \"learner\" modes across the application.</p> <p>Wrong: Component-level teaching flags scattered everywhere <pre><code>// Scattered boolean props that don't sync\n&lt;TracePanel showExplanation={showExplanation} /&gt;\n&lt;StateIndicator showTooltip={showTooltip} /&gt;\n&lt;OperadBadge showArity={showArity} /&gt;\n// No centralized control, inconsistent behavior\n</code></pre></p> <p>Right: Global teaching mode via React context + localStorage <pre><code>// hooks/useTeachingMode.tsx\nexport function TeachingModeProvider({ children }: { children: ReactNode }) {\n  const [enabled, setEnabled] = useState(true);\n  const [isLoaded, setIsLoaded] = useState(false);\n\n  useEffect(() =&gt; {\n    const stored = localStorage.getItem('kgents_teaching_mode');\n    if (stored !== null) setEnabled(stored === 'true');\n    setIsLoaded(true);\n  }, []);\n\n  const toggle = useCallback(() =&gt; {\n    const next = !enabled;\n    setEnabled(next);\n    localStorage.setItem('kgents_teaching_mode', String(next));\n  }, [enabled]);\n\n  return (\n    &lt;TeachingModeContext.Provider value={{ enabled, toggle, isLoaded }}&gt;\n      {children}\n    &lt;/TeachingModeContext.Provider&gt;\n  );\n}\n\n// Usage in components\nfunction TracePanel({ events, maxEvents }: TracePanelProps) {\n  const { enabled: teachingEnabled } = useTeachingModeSafe();\n\n  return (\n    &lt;div&gt;\n      {/* Content always shown */}\n      &lt;Timeline events={events} maxEvents={maxEvents} /&gt;\n\n      {/* Teaching callouts only when enabled */}\n      {teachingEnabled &amp;&amp; (\n        &lt;TeachingCallout category=\"conceptual\"&gt;\n          Every state change is recorded via the N-gent witness pattern.\n        &lt;/TeachingCallout&gt;\n      )}\n    &lt;/div&gt;\n  );\n}\n</code></pre></p> <p>Accessibility additions: <pre><code>// StateIndicator with keyboard and screen reader support\n&lt;div\n  role={isClickable ? 'button' : 'status'}\n  tabIndex={isClickable ? 0 : undefined}\n  aria-label={`${label} state, ${category}`}\n  aria-live={animate ? 'polite' : undefined}\n  onKeyDown={(e) =&gt; {\n    if (onClick &amp;&amp; (e.key === 'Enter' || e.key === ' ')) {\n      e.preventDefault();\n      onClick();\n    }\n  }}\n  className={cn(\n    'transition-all duration-200',\n    'motion-reduce:transition-none',\n    animate &amp;&amp; 'animate-pulse motion-reduce:animate-none',\n    isClickable &amp;&amp; 'focus-visible:outline focus-visible:outline-2'\n  )}\n&gt;\n</code></pre></p> <p>Benefits: - Centralized control via context - Persists across sessions (localStorage) - Graceful degradation (<code>useTeachingModeSafe</code>) - Respects <code>prefers-reduced-motion</code> - Full keyboard navigation - Screen reader support via ARIA</p> <p>Components: | Component | Purpose | |-----------|---------| | <code>TeachingModeProvider</code> | Context provider wrapping app | | <code>useTeachingMode()</code> | Hook for components inside provider | | <code>useTeachingModeSafe()</code> | Hook with fallback for any component | | <code>TeachingToggle</code> | Pre-built toggle button (compact or full) | | <code>WhenTeaching</code> | Conditional render wrapper | | <code>TeachingCallout</code> | Gradient callout with category styling |</p> <p>Apply to: Park (crisis phases, consent debt), Town (citizen polynomial, trace).</p>"},{"location":"skills/crown-jewel-patterns/#pattern-15-no-hollow-services","title":"Pattern 15: No Hollow Services","text":"<p>Problem: Services with default constructors can be instantiated without required configuration, creating objects that pass type checks but fail at runtime.</p> <p>Wrong: Default constructor bypasses DI <pre><code># Direct instantiation creates hollow object\nasync def get_chat_factory():\n    # \u274c Creates MorpheusPersistence with empty gateway - no providers!\n    morpheus = MorpheusPersistence()\n    return ChatServiceFactory(morpheus=morpheus)\n\n# Later at runtime:\n# \"No provider found for model: claude-sonnet-4-20250514\"\n# Cryptic error because gateway has no adapters registered\n</code></pre></p> <p>Right: Always go through DI/bootstrap <pre><code>async def get_chat_factory():\n    # \u2705 Gets properly configured service with ClaudeCLIAdapter registered\n    morpheus = await get_service(\"morpheus_persistence\")\n    return ChatServiceFactory(morpheus=morpheus)\n</code></pre></p> <p>Why This Matters for Agent Systems:</p> <p>Agent services have deep dependency graphs. An LLM gateway isn't just a class\u2014it's a composition of: - Adapters (ClaudeCLI, OpenAI, Anthropic) - Rate limiters per archetype - Telemetry/observability hooks - Provider routing by model prefix</p> <p>When you instantiate directly, you get a structurally valid but behaviorally hollow object: - \u2705 Has all the right methods - \u2705 Passes type checks - \u2705 Can be assigned to the correct type - \u274c Missing runtime configuration - \u274c Fails with cryptic \"no provider\" errors</p> <p>Prevention Strategies:</p> <pre><code># Option 1: Make wrong thing impossible (no default for critical deps)\nclass MorpheusPersistence:\n    def __init__(self, gateway: MorpheusGateway):  # Required!\n        if not gateway.list_providers():\n            raise ValueError(\"Gateway must have at least one provider\")\n        self._gateway = gateway\n\n# Option 2: Factory function only (hide constructor)\ndef create_morpheus_persistence() -&gt; MorpheusPersistence:\n    \"\"\"Only way to create a properly configured instance.\"\"\"\n    gateway = MorpheusGateway()\n    gateway.register_provider(\"claude-cli\", ClaudeCLIAdapter(), \"claude-\")\n    return MorpheusPersistence(gateway=gateway)\n\n# Option 3: Builder with validation\nMorpheusPersistence.builder() \\\n    .with_provider(ClaudeCLIAdapter()) \\\n    .build()  # Raises if no providers\n</code></pre> <p>Detection:</p> <pre><code># In bootstrap or app startup, verify services are wired\nasync def verify_services():\n    morpheus = await get_service(\"morpheus_persistence\")\n    providers = morpheus.gateway.list_providers()\n    if not providers:\n        raise RuntimeError(\"Morpheus has no providers - check bootstrap wiring\")\n    logger.info(f\"Morpheus OK: {len(providers)} providers registered\")\n</code></pre> <p>The Rule:</p> <p>Crown Jewels should NEVER be instantiated directly outside bootstrap. Always go through <code>get_service()</code> or the DI container. If a service needs runtime wiring (adapters, buses, stores), the \"convenient\" direct instantiation is the wrong way.</p> <p>Benefits: - Catches misconfiguration at startup, not runtime - Single source of truth for service creation - Makes the \"wrong way\" awkward (or impossible) - Cryptic runtime errors become clear startup errors</p> <p>Apply to: | Service | Required Wiring | |---------|-----------------| | MorpheusPersistence | Gateway with registered providers | | ChatServiceFactory | MorpheusPersistence for LLM composition | | BrainPersistence | TableAdapter + D-gent router | | TownPersistence | Citizen + Conversation adapters | | DifferanceStore | D-gent backend + DataBus |</p>"},{"location":"skills/crown-jewel-patterns/#quick-reference","title":"Quick Reference","text":"Pattern Use When Key Insight Container Owns Workflow Persistent state + transient workflows Container persists; workflows come and go Enum Property Enum values need metadata Co-locate metadata with enum Multiplied Context Context modulates intent <code>effective = intent \u00d7 context</code> Signal Aggregation Multi-factor decisions Confidence + reasons string Dismissal Memory Suggestion systems Time-bounded \"not now\" Async-Safe Emission Sync\u2192async bridge <code>create_task</code> with fallback Dual-Channel Output CLI for humans + agents <code>emit(human, semantic)</code> Bounded History Trajectory analysis Immutable + trim to MAX Directed Cycle State machine design One forward per state Operad Inheritance Building on base operads <code>**PARENT.operations</code> spread Circadian Modulation Time-of-day UI shifts Phase \u2192 modifier \u2192 apply Law Honesty Laws that aren't runtime STRUCTURAL status for design constraints Contract-First Types BE/FE type sync <code>@node(contracts={})</code> is authority Teaching Mode Toggle Learner vs. power user UX Context + localStorage + accessibility No Hollow Services Services needing runtime config Always use DI; never direct instantiation"},{"location":"skills/crown-jewel-patterns/#related","title":"Related","text":"<ul> <li><code>gardener-logos.md</code> \u2014 Source implementation</li> <li><code>polynomial-agent.md</code> \u2014 State machine fundamentals</li> <li><code>handler-patterns.md</code> \u2014 CLI handler patterns</li> <li><code>test-patterns.md</code> \u2014 Testing these patterns</li> </ul>"},{"location":"skills/crown-jewel-patterns/#changelog","title":"Changelog","text":"<ul> <li>2025-12-19: Added Pattern 15 (No Hollow Services) from Morpheus/Chat provider debugging</li> <li>2025-12-18: Added Pattern 14 (Teaching Mode Toggle) from Park-Town Design Overhaul Phase 5</li> <li>2025-12-18: Added Pattern 13 (Contract-First Types) from Phase 7 Autopoietic Architecture</li> <li>2025-12-18: Added patterns 10-12 (Operad Inheritance, Circadian Modulation, Law Honesty) from Emergence Crown Jewel</li> <li>2025-12-16: Initial version from Gardener-Logos reflection</li> </ul>"},{"location":"skills/data-bus-integration/","title":"Data Bus Integration","text":"<p>\"Data flows through the bus. Agents subscribe to what they care about.\"</p> <p>This skill documents the kgents reactive data flow infrastructure\u2014the event-driven backbone that enables agents to communicate and coordinate without tight coupling.</p>"},{"location":"skills/data-bus-integration/#overview-the-three-bus-architecture","title":"Overview: The Three-Bus Architecture","text":"<p>kgents uses a layered event bus architecture with three distinct bus types:</p> Bus Scope Purpose Delivery DataBus Single process D-gent storage events At-least-once, causal ordering SynergyBus Cross-jewel Crown Jewel coordination Fire-and-forget, handler isolation EventBus Fan-out UI/streaming distribution Backpressure, bounded queues <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                            Event Flow Architecture                         \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                           \u2502\n\u2502   D-gent (Storage)                                                        \u2502\n\u2502       \u2502                                                                   \u2502\n\u2502       \u25bc                                                                   \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                                         \u2502\n\u2502   \u2502  DataBus    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518               \u2502              \u2502              \u2502          \u2502\n\u2502                                 \u25bc              \u25bc              \u25bc          \u2502\n\u2502                           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502                           \u2502 M-gent  \u2502    \u2502  Trace  \u2502    \u2502 Bridge  \u2502     \u2502\n\u2502                           \u2502Listener \u2502    \u2502Listener \u2502    \u2502\u2192Synergy \u2502     \u2502\n\u2502                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518     \u2502\n\u2502                                                              \u2502           \u2502\n\u2502   Crown Jewels (Gestalt, Brain, etc.)                        \u25bc           \u2502\n\u2502       \u2502                                                                   \u2502\n\u2502       \u25bc                                                                   \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                                         \u2502\n\u2502   \u2502 SynergyBus  \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518               \u2502              \u2502              \u2502          \u2502\n\u2502                                 \u25bc              \u25bc              \u25bc          \u2502\n\u2502                           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502                           \u2502Gestalt\u2192 \u2502    \u2502Atelier\u2192 \u2502    \u2502Garden\u2192  \u2502     \u2502\n\u2502                           \u2502 Brain   \u2502    \u2502 Brain   \u2502    \u2502 Brain   \u2502     \u2502\n\u2502                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502\n\u2502                                                                           \u2502\n\u2502   Agent Town (Simulation)                                                 \u2502\n\u2502       \u2502                                                                   \u2502\n\u2502       \u25bc                                                                   \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                                         \u2502\n\u2502   \u2502 EventBus[T] \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518               \u2502              \u2502              \u2502          \u2502\n\u2502                                 \u25bc              \u25bc              \u25bc          \u2502\n\u2502                           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502                           \u2502   SSE   \u2502    \u2502  NATS   \u2502    \u2502 Widget  \u2502     \u2502\n\u2502                           \u2502Endpoint \u2502    \u2502 Bridge  \u2502    \u2502Renderer \u2502     \u2502\n\u2502                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502\n\u2502                                                                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"skills/data-bus-integration/#1-databus-storage-level-events","title":"1. DataBus: Storage-Level Events","text":"<p>The DataBus emits events whenever D-gent stores, deletes, upgrades, or degrades data.</p>"},{"location":"skills/data-bus-integration/#event-types","title":"Event Types","text":"<pre><code>from agents.d.bus import DataEventType\n\nDataEventType.PUT      # New datum stored\nDataEventType.DELETE   # Datum removed\nDataEventType.UPGRADE  # Datum promoted to higher tier (MEMORY \u2192 SQLITE \u2192 POSTGRES)\nDataEventType.DEGRADE  # Datum demoted (graceful degradation)\n</code></pre>"},{"location":"skills/data-bus-integration/#dataevent-structure","title":"DataEvent Structure","text":"<pre><code>from agents.d.bus import DataEvent, DataEventType\n\n@dataclass(frozen=True, slots=True)\nclass DataEvent:\n    event_id: str              # Unique event ID (UUID hex)\n    event_type: DataEventType  # PUT | DELETE | UPGRADE | DEGRADE\n    datum_id: str              # ID of affected datum\n    timestamp: float           # Unix timestamp\n    source: str                # Who caused it (agent ID)\n    causal_parent: str | None  # Previous event this depends on\n    metadata: dict[str, str]   # Additional context\n</code></pre>"},{"location":"skills/data-bus-integration/#subscribing-to-databus","title":"Subscribing to DataBus","text":"<pre><code>from agents.d.bus import get_data_bus, DataEventType\n\nbus = get_data_bus()\n\n# Subscribe to specific event type\nasync def on_put(event):\n    print(f\"Data stored: {event.datum_id}\")\n\nunsubscribe = bus.subscribe(DataEventType.PUT, on_put)\n\n# Subscribe to ALL events\nasync def on_any(event):\n    print(f\"{event.event_type.name}: {event.datum_id}\")\n\nunsubscribe_all = bus.subscribe_all(on_any)\n\n# Later: stop receiving events\nunsubscribe()\nunsubscribe_all()\n</code></pre>"},{"location":"skills/data-bus-integration/#replaying-buffered-events","title":"Replaying Buffered Events","text":"<p>Late subscribers can catch up on missed events:</p> <pre><code># Replay all buffered events\ncount = await bus.replay(handler=my_handler)\n\n# Replay events since timestamp\ncount = await bus.replay(handler=my_handler, since=1702756800.0)\n\n# Replay only PUT events\ncount = await bus.replay(handler=my_handler, event_type=DataEventType.PUT)\n</code></pre>"},{"location":"skills/data-bus-integration/#busenableddgent-auto-emit-on-storage","title":"BusEnabledDgent: Auto-Emit on Storage","text":"<p>Wrap any D-gent backend to auto-emit events:</p> <pre><code>from agents.d.bus import BusEnabledDgent, get_data_bus\nfrom agents.d.backends.memory import MemoryBackend\n\nbackend = MemoryBackend()\nbus = get_data_bus()\ndgent = BusEnabledDgent(backend, bus, source=\"my-agent\")\n\n# These operations now emit events automatically\nawait dgent.put(datum)   # \u2192 PUT event\nawait dgent.delete(id)   # \u2192 DELETE event (if found)\nawait dgent.get(id)      # No event (reads are silent)\n</code></pre>"},{"location":"skills/data-bus-integration/#guarantees","title":"Guarantees","text":"Property Guarantee Delivery At-least-once (subscribers may receive duplicates) Ordering Causal (if A caused B, A delivered before B) Blocking Non-blocking (publishers never wait for subscribers) Buffer Bounded (old events dropped when buffer full, default 1000)"},{"location":"skills/data-bus-integration/#agentese-paths","title":"AGENTESE Paths","text":"<p>DataBus exposes these paths under <code>self.bus.*</code>:</p> Path Description <code>self.bus.manifest</code> View current bus state <code>self.bus.subscribe</code> Subscribe to event types <code>self.bus.unsubscribe</code> Unsubscribe by handler ID <code>self.bus.replay</code> Replay buffered events <code>self.bus.latest</code> Get most recent event <code>self.bus.stats</code> Get bus statistics <code>self.bus.history</code> Get recent event history"},{"location":"skills/data-bus-integration/#2-synergybus-cross-jewel-coordination","title":"2. SynergyBus: Cross-Jewel Coordination","text":"<p>The SynergyBus enables Crown Jewels to react to each other's significant operations.</p>"},{"location":"skills/data-bus-integration/#event-types-selected","title":"Event Types (Selected)","text":"<pre><code>from protocols.synergy import SynergyEventType, Jewel\n\n# Gestalt events\nSynergyEventType.ANALYSIS_COMPLETE\nSynergyEventType.DRIFT_DETECTED\n\n# Brain events\nSynergyEventType.CRYSTAL_FORMED\nSynergyEventType.MEMORY_SURFACED\n\n# Gardener events\nSynergyEventType.SEASON_CHANGED\nSynergyEventType.GESTURE_APPLIED\n\n# Atelier events\nSynergyEventType.PIECE_CREATED\nSynergyEventType.BID_ACCEPTED\n\n# Coalition events\nSynergyEventType.COALITION_FORMED\nSynergyEventType.TASK_ASSIGNED\n\n# D-gent events (bridges from DataBus)\nSynergyEventType.DATA_STORED\nSynergyEventType.DATA_UPGRADED\nSynergyEventType.DATA_DEGRADED\n</code></pre>"},{"location":"skills/data-bus-integration/#emitting-synergy-events","title":"Emitting Synergy Events","text":"<pre><code>from protocols.synergy import (\n    get_synergy_bus,\n    create_analysis_complete_event,\n)\n\nbus = get_synergy_bus()\n\n# Use factory functions for type-safe event creation\nevent = create_analysis_complete_event(\n    source_id=\"analysis-123\",\n    module_count=50,\n    health_grade=\"B+\",\n    average_health=0.84,\n    drift_count=2,\n    root_path=\"/path/to/project\",\n)\n\n# Fire and forget\nawait bus.emit(event)\n\n# Or wait for all handlers\nresults = await bus.emit_and_wait(event)\n</code></pre>"},{"location":"skills/data-bus-integration/#creating-synergy-handlers","title":"Creating Synergy Handlers","text":"<pre><code>from protocols.synergy import (\n    SynergyHandler,\n    SynergyEvent,\n    SynergyResult,\n    SynergyEventType,\n    get_synergy_bus,\n)\n\nclass MyHandler(SynergyHandler):\n    @property\n    def name(self) -&gt; str:\n        return \"MyHandler\"\n\n    async def handle(self, event: SynergyEvent) -&gt; SynergyResult:\n        # Process the event\n        print(f\"Received: {event.event_type.value}\")\n\n        return SynergyResult(\n            success=True,\n            handler_name=self.name,\n            message=\"Processed successfully\",\n            artifact_id=\"created-artifact-123\",  # Optional\n        )\n\n# Register the handler\nbus = get_synergy_bus()\nunsubscribe = bus.register(SynergyEventType.ANALYSIS_COMPLETE, MyHandler())\n</code></pre>"},{"location":"skills/data-bus-integration/#subscribing-to-results","title":"Subscribing to Results","text":"<p>The SynergyBus supports result subscriptions for UI notifications:</p> <pre><code>def on_result(event: SynergyEvent, result: SynergyResult):\n    if result.success:\n        print(f\"\u2713 {event.event_type.value}: {result.message}\")\n        if result.artifact_id:\n            print(f\"  \u21b3 Crystal: \\\"{result.artifact_id}\\\"\")\n\nunsubscribe = bus.subscribe_results(on_result)\n</code></pre>"},{"location":"skills/data-bus-integration/#built-in-handlers","title":"Built-in Handlers","text":"<p>The SynergyBus comes pre-configured with these handlers:</p> Handler Event Action <code>GestaltToBrainHandler</code> ANALYSIS_COMPLETE Auto-capture architecture snapshots <code>AtelierToBrainHandler</code> PIECE_CREATED Auto-capture created pieces <code>CoalitionToBrainHandler</code> TASK_ASSIGNED Auto-capture task completions <code>BrainToCoalitionHandler</code> COALITION_FORMED Enrich with context <code>GardenToBrainHandler</code> SEASON_CHANGED, GESTURE_APPLIED Auto-capture garden state <code>GestaltToGardenHandler</code> ANALYSIS_COMPLETE Update plot progress"},{"location":"skills/data-bus-integration/#factory-functions-complete-list","title":"Factory Functions (Complete List)","text":"<pre><code>from protocols.synergy import (\n    # Gestalt\n    create_analysis_complete_event,\n    create_drift_detected_event,\n\n    # Brain\n    create_crystal_formed_event,\n\n    # Gardener\n    create_session_complete_event,\n    create_artifact_created_event,\n    create_season_changed_event,\n    create_gesture_applied_event,\n    create_plot_progress_event,\n\n    # Atelier\n    create_piece_created_event,\n    create_bid_accepted_event,\n\n    # Coalition\n    create_coalition_formed_event,\n    create_task_complete_event,\n\n    # Domain\n    create_drill_complete_event,\n    create_drill_started_event,\n    create_timer_warning_event,\n\n    # Park\n    create_scenario_complete_event,\n    create_serendipity_injected_event,\n    create_force_used_event,\n\n    # D-gent (data layer)\n    create_data_stored_event,\n    create_data_deleted_event,\n    create_data_upgraded_event,\n    create_data_degraded_event,\n\n    # F-gent (flow)\n    create_flow_started_event,\n    create_flow_completed_event,\n    create_turn_completed_event,\n    create_hypothesis_created_event,\n    create_hypothesis_synthesized_event,\n    create_consensus_reached_event,\n    create_contribution_posted_event,\n)\n</code></pre>"},{"location":"skills/data-bus-integration/#3-eventbus-fan-out-distribution","title":"3. EventBus: Fan-Out Distribution","text":"<p>The generic EventBus provides typed fan-out for streaming scenarios.</p>"},{"location":"skills/data-bus-integration/#creating-a-typed-eventbus","title":"Creating a Typed EventBus","text":"<pre><code>from agents.town.event_bus import EventBus, Subscription\n\n# Create typed bus\nbus = EventBus[TownEvent](max_queue_size=1000)\n\n# Publish to all subscribers\ndelivered_count = await bus.publish(event)\n\n# Create subscription (returns async iterator)\nsub = bus.subscribe()\ntry:\n    async for event in sub:\n        process(event)\nfinally:\n    sub.close()\n</code></pre>"},{"location":"skills/data-bus-integration/#subscription-patterns","title":"Subscription Patterns","text":"<pre><code># Pattern 1: Async iteration\nsub = bus.subscribe()\nasync for event in sub:\n    process(event)\n\n# Pattern 2: Polling with timeout\nsub = bus.subscribe()\nevent = await sub.get(timeout=5.0)  # Returns None on timeout\n\n# Pattern 3: Non-blocking check\nif sub.pending_count &gt; 0:\n    event = await sub.get(timeout=0)\n</code></pre>"},{"location":"skills/data-bus-integration/#backpressure","title":"Backpressure","text":"<p>EventBus handles slow subscribers via bounded queues:</p> <pre><code>bus = EventBus[MyEvent](max_queue_size=100)\n\n# If subscriber queue is full, events are DROPPED (not blocked)\n# Check stats to detect slow subscribers:\nstats = bus.stats\nprint(f\"Overflow count: {stats.queue_overflow_count}\")\n</code></pre>"},{"location":"skills/data-bus-integration/#cleanup","title":"Cleanup","text":"<pre><code># Close all subscriptions\nbus.close()  # Sends None sentinel to unblock waiting subscribers\n\n# Check state\nassert bus.is_closed\nassert bus.subscriber_count == 0\n</code></pre>"},{"location":"skills/data-bus-integration/#4-m-gent-bus-listener-auto-indexing","title":"4. M-gent Bus Listener: Auto-Indexing","text":"<p>M-gent can automatically index data as it's stored via the Bus Listener.</p>"},{"location":"skills/data-bus-integration/#setup","title":"Setup","text":"<pre><code>from agents.m.bus_listener import create_bus_listener\nfrom agents.m import AssociativeMemory\nfrom agents.d.bus import get_data_bus\n\nmgent = AssociativeMemory(dgent=my_dgent)\nbus = get_data_bus()\n\nlistener = create_bus_listener(\n    mgent=mgent,\n    bus=bus,\n    auto_index=True,     # Auto-create memories for PUT events\n    auto_remove=True,    # Auto-remove on DELETE events\n    embedder=my_embedder # Optional custom embedder\n)\n\n# Start listening\nlistener.start()\n\n# Now: any D-gent PUT automatically creates a Memory entry\n# And: any D-gent DELETE removes the Memory entry\n\n# Stop when done\nlistener.stop()\n</code></pre>"},{"location":"skills/data-bus-integration/#catching-up","title":"Catching Up","text":"<p>Late-starting listeners can replay missed events:</p> <pre><code># Start listener\nlistener.start()\n\n# Catch up on missed events\ncount = await listener.replay_and_index(since=last_seen_timestamp)\nprint(f\"Indexed {count} missed events\")\n</code></pre>"},{"location":"skills/data-bus-integration/#5-bridging-databus-to-synergybus","title":"5. Bridging DataBus to SynergyBus","text":"<p>Significant data operations can be promoted to the cross-jewel synergy bus:</p> <pre><code>from protocols.agentese.contexts.self_bus import wire_data_to_synergy\n\n# One-time setup: bridge data events to synergy\nwire_data_to_synergy()\n\n# Now DataBus events are forwarded to SynergyBus:\n# - PUT \u2192 DATA_STORED\n# - DELETE \u2192 DATA_DELETED\n# - UPGRADE \u2192 DATA_UPGRADED\n# - DEGRADE \u2192 DATA_DEGRADED\n</code></pre>"},{"location":"skills/data-bus-integration/#6-flux-integration-event-driven-streaming","title":"6. Flux Integration: Event-Driven Streaming","text":"<p>The Flux system integrates with event buses for streaming:</p> <pre><code>from agents.flux.sources.events import from_events, from_queue, from_iterable\n\n# From an event bus\nasync for event in from_events(my_bus):\n    process(event)\n\n# From an asyncio.Queue\nasync for item in from_queue(my_queue):\n    process(item)\n\n# From any iterable (for testing)\nasync for item in from_iterable([1, 2, 3]):\n    process(item)\n</code></pre> <p>Key Principle: Event-driven sources respond to actual events, not timer ticks.</p>"},{"location":"skills/data-bus-integration/#7-testing","title":"7. Testing","text":""},{"location":"skills/data-bus-integration/#testing-databus","title":"Testing DataBus","text":"<pre><code>import pytest\nfrom agents.d.bus import DataBus, DataEvent, DataEventType, reset_data_bus\n\n@pytest.fixture\ndef bus():\n    return DataBus()\n\n@pytest.fixture(autouse=True)\ndef cleanup():\n    yield\n    reset_data_bus()  # Reset global singleton\n\n@pytest.mark.asyncio\nasync def test_subscription(bus):\n    received = []\n\n    async def handler(event):\n        received.append(event)\n\n    bus.subscribe(DataEventType.PUT, handler)\n    await bus.emit(DataEvent.create(DataEventType.PUT, \"test-id\"))\n    await asyncio.sleep(0.01)  # Give handler time to run\n\n    assert len(received) == 1\n</code></pre>"},{"location":"skills/data-bus-integration/#testing-synergybus","title":"Testing SynergyBus","text":"<pre><code>from protocols.synergy import (\n    get_synergy_bus,\n    reset_synergy_bus,\n    create_analysis_complete_event,\n)\n\n@pytest.fixture(autouse=True)\ndef cleanup():\n    yield\n    reset_synergy_bus()\n\n@pytest.mark.asyncio\nasync def test_synergy_flow():\n    bus = get_synergy_bus()\n\n    event = create_analysis_complete_event(\n        source_id=\"test\",\n        module_count=10,\n        health_grade=\"A\",\n        average_health=0.9,\n        drift_count=0,\n        root_path=\"/test\",\n    )\n\n    # Wait for handlers to complete\n    results = await bus.emit_and_wait(event)\n\n    # Check results\n    for result in results:\n        assert result.success\n</code></pre>"},{"location":"skills/data-bus-integration/#8-common-patterns","title":"8. Common Patterns","text":""},{"location":"skills/data-bus-integration/#pattern-audit-trail","title":"Pattern: Audit Trail","text":"<pre><code>from agents.d.bus import get_data_bus\nfrom weave.trace_monoid import TraceMonoid, Event\n\ntrace = TraceMonoid()\nbus = get_data_bus()\n\nasync def audit_handler(event):\n    trace.append_mut(\n        Event(\n            id=event.event_id,\n            source=f\"dgent:{event.source}\",\n            timestamp=event.timestamp,\n            payload={\n                \"type\": event.event_type.value,\n                \"datum_id\": event.datum_id,\n            },\n        ),\n        depends_on={event.causal_parent} if event.causal_parent else None,\n    )\n\nbus.subscribe_all(audit_handler)\n</code></pre>"},{"location":"skills/data-bus-integration/#pattern-ui-notification-bridge","title":"Pattern: UI Notification Bridge","text":"<pre><code>from protocols.synergy import get_synergy_bus, display_synergy_notification\n\nbus = get_synergy_bus()\n\ndef on_result(event, result):\n    display_synergy_notification(event, result)\n\nbus.subscribe_results(on_result)\n</code></pre>"},{"location":"skills/data-bus-integration/#pattern-reactive-signal-bridge","title":"Pattern: Reactive Signal Bridge","text":"<pre><code>from agents.i.reactive import Signal\nfrom agents.d.bus import get_data_bus, DataEventType\n\nbus = get_data_bus()\nlatest_put = Signal.of(None)\n\nasync def bridge(event):\n    latest_put.set(event)\n\nbus.subscribe(DataEventType.PUT, bridge)\n\n# Now UI can react to latest_put signal changes\n</code></pre>"},{"location":"skills/data-bus-integration/#9-what-these-buses-are-not","title":"9. What These Buses Are NOT","text":"Bus Is NOT Why DataBus Message queue No persistence, no acknowledgments DataBus RPC Fire-and-forget, no responses DataBus Cross-process Single process only SynergyBus Guaranteed delivery Handler failures are isolated SynergyBus Transactional Events may fire during rollback EventBus Durable In-memory only, bounded buffer"},{"location":"skills/data-bus-integration/#10-quick-reference","title":"10. Quick Reference","text":""},{"location":"skills/data-bus-integration/#imports","title":"Imports","text":"<pre><code># DataBus\nfrom agents.d.bus import (\n    DataBus, DataEvent, DataEventType,\n    BusEnabledDgent,\n    get_data_bus, reset_data_bus,\n)\n\n# SynergyBus\nfrom protocols.synergy import (\n    SynergyEventBus, SynergyEvent, SynergyResult,\n    SynergyEventType, Jewel,\n    SynergyHandler, ResultSubscriber,\n    get_synergy_bus, reset_synergy_bus,\n    # Factory functions\n    create_analysis_complete_event,\n    create_crystal_formed_event,\n    # ... (see section 2)\n)\n\n# EventBus\nfrom agents.town.event_bus import (\n    EventBus, EventBusStats, Subscription,\n)\n\n# M-gent Listener\nfrom agents.m.bus_listener import (\n    MgentBusListener, BusEventHandler,\n    create_bus_listener,\n)\n\n# AGENTESE Bus Node\nfrom protocols.agentese.contexts.self_bus import (\n    BusNode, create_bus_resolver,\n    wire_data_to_synergy,\n)\n\n# Flux Sources\nfrom agents.flux.sources.events import (\n    from_events, from_queue, from_iterable,\n    from_stream, empty, single, repeat,\n)\n</code></pre>"},{"location":"skills/data-bus-integration/#decision-tree","title":"Decision Tree","text":"<pre><code>Need to react to D-gent storage operations?\n  \u2192 Use DataBus\n\nNeed Crown Jewels to coordinate?\n  \u2192 Use SynergyBus\n\nNeed fan-out to multiple UI/streaming subscribers?\n  \u2192 Use EventBus[T]\n\nNeed M-gent to auto-index stored data?\n  \u2192 Use MgentBusListener\n\nNeed to expose bus via AGENTESE?\n  \u2192 Use BusNode (self.bus.*)\n\nNeed to stream events through Flux pipeline?\n  \u2192 Use from_events() source\n</code></pre>"},{"location":"skills/data-bus-integration/#see-also","title":"See Also","text":"<ul> <li><code>spec/protocols/data-bus.md</code> \u2014 Specification</li> <li><code>spec/d-gents/architecture.md</code> \u2014 D-gent storage</li> <li><code>spec/m-gents/architecture.md</code> \u2014 M-gent memory</li> <li><code>impl/claude/agents/d/bus.py</code> \u2014 DataBus implementation</li> <li><code>impl/claude/protocols/synergy/</code> \u2014 SynergyBus implementation</li> <li><code>impl/claude/agents/town/event_bus.py</code> \u2014 EventBus implementation</li> <li><code>impl/claude/agents/m/bus_listener.py</code> \u2014 M-gent listener</li> <li><code>impl/claude/protocols/agentese/contexts/self_bus.py</code> \u2014 AGENTESE integration</li> </ul>"},{"location":"skills/elastic-ui-patterns/","title":"Elastic UI Patterns","text":"<p>\"Density is not screen size. Density is the capacity to receive.\"</p>"},{"location":"skills/elastic-ui-patterns/#when-to-use","title":"When to Use","text":"<ul> <li>Building responsive React pages with multi-pane layouts</li> <li>Widgets that must adapt to available space (card content degradation)</li> <li>Touch-friendly mobile experiences with drawer patterns</li> <li>Pages that need consistent behavior from 320px to 4K</li> </ul> <p>Spec Reference: See <code>spec/protocols/projection.md</code> for categorical theory (AD-008 Density-Content Isomorphism).</p>"},{"location":"skills/elastic-ui-patterns/#the-three-mode-pattern","title":"The Three-Mode Pattern","text":"Mode Breakpoint Characteristics Compact &lt;768px (mobile) Drawer-based, touch-friendly, minimal chrome Comfortable 768-1023px (tablet) Hybrid, collapsible panels, balanced Spacious \u22651024px (desktop) Full panels, draggable dividers, maximum info <p>Canonical Source: <code>spec/protocols/projection.md</code> defines these breakpoints. Both Python (<code>agents/design/types.py</code>) and TypeScript (<code>useDesignPolynomial.ts</code>) must align.</p> <pre><code>import { useWindowLayout } from '@/hooks/useLayoutContext';\n\nconst { density, isMobile, isTablet, isDesktop } = useWindowLayout();\n// density: 'compact' | 'comfortable' | 'spacious'\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#density-aware-constants","title":"Density-Aware Constants","text":"<p>GOOD: Parameterized by density <pre><code>const NODE_SIZE = { compact: 0.2, comfortable: 0.25, spacious: 0.3 } as const;\nconst size = NODE_SIZE[density];  // Morphism: Density \u2192 Value\n</code></pre></p> <p>BAD: Scattered conditionals <pre><code>const nodeSize = isMobile ? 0.2 : isTablet ? 0.25 : 0.3;\n</code></pre></p>"},{"location":"skills/elastic-ui-patterns/#component-primitives","title":"Component Primitives","text":"Primitive Use Case Density Behavior <code>ElasticSplit</code> Two-pane layouts Collapse below threshold <code>ElasticContainer</code> Self-arranging grids Auto-fit columns <code>BottomDrawer</code> Mobile panels Slides from bottom <code>FloatingActions</code> Mobile FABs Touch-friendly cluster <code>FloatingSidebar</code> Overlay navigation Float over content <code>FixedBottomPanel</code> Terminals/REPL Fixed at bottom <code>FixedTopPanel</code> Status bars Fixed at top"},{"location":"skills/elastic-ui-patterns/#elasticsplit","title":"ElasticSplit","text":"<pre><code>&lt;ElasticSplit\n  defaultRatio={0.75}\n  collapseAt={768}\n  collapsePriority=\"secondary\"\n  resizable={isDesktop}\n  primary={&lt;MainCanvas /&gt;}\n  secondary={&lt;SidePanel /&gt;}\n/&gt;\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#bottomdrawer","title":"BottomDrawer","text":"<pre><code>&lt;BottomDrawer isOpen={isOpen} onClose={onClose} title=\"Controls\"&gt;\n  &lt;ControlPanel density={density} isDrawer /&gt;\n&lt;/BottomDrawer&gt;\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#floatingactions","title":"FloatingActions","text":"<pre><code>&lt;div className=\"absolute bottom-4 right-4 flex flex-col gap-2\"&gt;\n  &lt;button className=\"w-12 h-12 bg-green-600 rounded-full\"&gt;\ud83d\udd04&lt;/button&gt;\n&lt;/div&gt;\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#content-degradation","title":"Content Degradation","text":"<p>Cards adapt based on container width:</p> Level Width Displays <code>icon</code> &lt;60px Icon only <code>title</code> &lt;150px Icon + name <code>summary</code> &lt;280px Icon + name + phase <code>full</code> \u2265400px Full content <pre><code>function getContentLevel(width: number): ContentLevel {\n  if (width &lt; 60) return 'icon';\n  if (width &lt; 150) return 'title';\n  if (width &lt; 280) return 'summary';\n  return 'full';\n}\n</code></pre> <p>Design System Types: See <code>agents/design/types.py</code> for <code>ContentLevel</code> enum.</p>"},{"location":"skills/elastic-ui-patterns/#mobile-layout-pattern","title":"Mobile Layout Pattern","text":"<pre><code>function MyPage() {\n  const { isMobile, density } = useWindowLayout();\n\n  if (isMobile) {\n    return (\n      &lt;div className=\"h-screen flex flex-col\"&gt;\n        &lt;header className=\"flex-shrink-0 px-3 py-2\"&gt;\n          &lt;CompactHeader /&gt;\n        &lt;/header&gt;\n        &lt;div className=\"flex-1 relative\"&gt;\n          &lt;Canvas density={density} /&gt;\n          &lt;FloatingActions onToggle={handleToggle} /&gt;\n        &lt;/div&gt;\n        &lt;BottomDrawer isOpen={panelOpen} onClose={closePanel}&gt;\n          &lt;ControlPanel density={density} isDrawer /&gt;\n        &lt;/BottomDrawer&gt;\n      &lt;/div&gt;\n    );\n  }\n\n  return (\n    &lt;ElasticSplit\n      resizable={isDesktop}\n      primary={&lt;Canvas density={density} /&gt;}\n      secondary={&lt;ControlPanel density={density} /&gt;}\n    /&gt;\n  );\n}\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#css-custom-properties","title":"CSS Custom Properties","text":"<pre><code>:root {\n  --elastic-gap-xs: 4px;\n  --elastic-gap-sm: 8px;\n  --elastic-gap-md: 16px;\n  --elastic-gap-lg: 24px;\n  --elastic-transition-smooth: 300ms ease-in-out;\n  --elastic-bp-sm: 640px;\n  --elastic-bp-md: 768px;\n  --elastic-bp-lg: 1024px;\n}\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#floating-overlay-pattern","title":"Floating Overlay Pattern","text":"<p>Navigation panels work better as floating overlays than document-flow elements.</p> <p>Decision: Overlay wins because: 1. Full content width when panels closed 2. Smoother animation (transform vs reflow) 3. Users rarely need nav and content simultaneously</p> <pre><code>&lt;FloatingSidebar\n  isExpanded={navExpanded}\n  onToggle={() =&gt; setNavExpanded(!navExpanded)}\n  bottomOffset={terminalExpanded ? '200px' : '48px'}\n&gt;\n  &lt;NavTree /&gt;\n&lt;/FloatingSidebar&gt;\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#fixed-panel-coordination-sheaf-condition","title":"Fixed Panel Coordination (Sheaf Condition)","text":"<p>Multiple fixed panels must coordinate via shared context:</p> <pre><code>observer.bottom = nav.top        // Nav respects observer drawer\nterminal.top = nav.bottom        // Nav respects terminal\nmain.paddingTop = observer.height\nmain.paddingBottom = terminal.height\n</code></pre> <pre><code>import { TOP_PANEL_HEIGHTS, BOTTOM_PANEL_HEIGHTS } from '@/components/elastic';\n\nconst getTopOffset = () =&gt;\n  observerExpanded ? `${TOP_PANEL_HEIGHTS.expanded}px` : `${TOP_PANEL_HEIGHTS.collapsed}px`;\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#anti-patterns","title":"Anti-Patterns","text":""},{"location":"skills/elastic-ui-patterns/#scattered-conditionals","title":"Scattered Conditionals","text":"<pre><code>// BAD\n{isMobile ? &lt;CompactThing /&gt; : &lt;FullThing /&gt;}\n\n// GOOD\n&lt;Thing density={density} /&gt;\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#mode-specific-components","title":"Mode-Specific Components","text":"<pre><code>// BAD\n&lt;MobileControlPanel /&gt;\n&lt;DesktopControlPanel /&gt;\n\n// GOOD\n&lt;ControlPanel density={density} isDrawer={isMobile} /&gt;\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#ignoring-touch-targets","title":"Ignoring Touch Targets","text":"<pre><code>// BAD: 24px buttons on mobile\n&lt;button className=\"p-1\"&gt;\u00d7&lt;/button&gt;\n\n// GOOD: 48px minimum\n&lt;button className=\"w-12 h-12\"&gt;\u00d7&lt;/button&gt;\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#refactoring-checklist","title":"Refactoring Checklist","text":"<ul> <li> Uses <code>useWindowLayout()</code>?</li> <li> Passes <code>density</code> to child components?</li> <li> Has dedicated mobile layout?</li> <li> Uses <code>ElasticSplit</code> for two-pane?</li> <li> Uses <code>BottomDrawer</code> for mobile panels?</li> <li> Uses <code>FloatingActions</code> for mobile?</li> <li> Touch targets \u226548px?</li> <li> Has density-parameterized constants?</li> </ul> <p>Test widths: 375px, 768px, 1024px, 1440px</p>"},{"location":"skills/elastic-ui-patterns/#agentese-gateway-integration","title":"AGENTESE Gateway Integration","text":"<p>The design system is a full vertical slice from polynomial state machine to AGENTESE gateway to React projection.</p>"},{"location":"skills/elastic-ui-patterns/#backend-layers","title":"Backend Layers","text":"<pre><code>agents/design/types.py      \u2192 Types (Density, ContentLevel, MotionType)\nagents/design/polynomial.py \u2192 DESIGN_POLYNOMIAL (144 states: 3\u00d74\u00d76\u00d72)\nagents/design/operad.py     \u2192 LAYOUT_OPERAD, CONTENT_OPERAD, MOTION_OPERAD, DESIGN_OPERAD\nagents/design/sheaf.py      \u2192 DesignSheaf (temporal coherence)\nprotocols/agentese/contexts/design.py \u2192 @node(\"concept.design.*\")\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#agentese-paths","title":"AGENTESE Paths","text":"Path Purpose <code>concept.design.manifest</code> Design system overview <code>concept.design.layout.manifest</code> Layout operad state <code>concept.design.layout.verify</code> Verify layout laws <code>concept.design.content.manifest</code> Content operad state <code>concept.design.motion.manifest</code> Motion operad state <code>concept.design.operad.verify</code> Verify all design laws"},{"location":"skills/elastic-ui-patterns/#usedesigngateway-hook","title":"useDesignGateway Hook","text":"<p>Bridges local state (responsive) with gateway data (authoritative):</p> <pre><code>import { useDesignGateway } from '@/hooks';\n\nfunction MyComponent() {\n  const {\n    // Local state (instant, viewport-responsive)\n    localState,      // { density, contentLevel, motion, shouldAnimate }\n    send,            // State machine input\n\n    // Gateway data (fetched from AGENTESE)\n    layoutOperad,    // { name, operations, lawCount }\n    verification,    // { all_passed, results[] }\n\n    // Actions\n    verifyLaws,      // () =&gt; Promise&lt;OperadVerifyResponse&gt;\n    refreshOperads,  // () =&gt; Promise&lt;void&gt;\n  } = useDesignGateway({ autoFetch: true });\n\n  return (\n    &lt;div&gt;\n      &lt;p&gt;Density: {localState.density}&lt;/p&gt;\n      &lt;button onClick={verifyLaws}&gt;Verify Laws&lt;/button&gt;\n      {verification?.all_passed &amp;&amp; &lt;span&gt;\u2713 All laws pass&lt;/span&gt;}\n    &lt;/div&gt;\n  );\n}\n</code></pre>"},{"location":"skills/elastic-ui-patterns/#key-insight-local-gateway","title":"Key Insight: Local + Gateway","text":"<ul> <li>Local polynomial (<code>useDesignPolynomial</code>): Runs in browser, instant response to viewport/container changes</li> <li>Gateway (<code>designApi</code>): Authoritative law verification, operad metadata from Python backend</li> <li>useDesignGateway: Combines both\u2014responsive local state + authoritative gateway data</li> </ul>"},{"location":"skills/elastic-ui-patterns/#related","title":"Related","text":"<ul> <li><code>spec/protocols/projection.md</code> \u2014 Projection Protocol + Density (AD-008)</li> <li><code>spec/principles.md</code> \u2014 AD-008 Simplifying Isomorphisms</li> <li><code>agents/design/</code> \u2014 Design operads (LAYOUT, CONTENT, MOTION)</li> <li><code>impl/claude/web/src/components/elastic/</code> \u2014 Implementation</li> <li><code>impl/claude/web/src/hooks/useDesignGateway.ts</code> \u2014 Gateway hook</li> <li><code>impl/claude/web/src/hooks/useDesignPolynomial.ts</code> \u2014 Local polynomial</li> <li><code>impl/claude/web/src/pages/LayoutGallery.tsx</code> \u2014 Live demo</li> </ul> <p>Lines: ~300</p>"},{"location":"skills/metaphysical-fullstack/","title":"Skill: Metaphysical Fullstack Agent","text":"<p>\"Every agent is a fullstack agent. The more fully defined, the more fully projected.\"</p>"},{"location":"skills/metaphysical-fullstack/#the-pattern","title":"The Pattern","text":"<p>Every kgents agent follows a vertical slice architecture where completeness of definition determines completeness of projection:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    PROJECTION SURFACES                          \u2502\n\u2502   CLI  \u2502  TUI  \u2502  Web UI  \u2502  marimo  \u2502  JSON API  \u2502  VR  \u2502 ... \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502       \u2502          \u2502          \u2502            \u2502      \u2502\n         \u25bc       \u25bc          \u25bc          \u25bc            \u25bc      \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  CONTAINER FUNCTOR (Main Website)               \u2502\n\u2502           Shallow passthrough for component projections          \u2502\n\u2502           Elastic composition of underlying surfaces             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              AGENTESE UNIVERSAL PROTOCOL                        \u2502\n\u2502   The protocol IS the API. No explicit routes needed.            \u2502\n\u2502   logos.invoke(\"self.memory.capture\", observer, content=...)     \u2502\n\u2502   \u2192 CLI, HTTP, WebSocket, gRPC all collapse to the same path     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      AGENTESE NODE                              \u2502\n\u2502   @node(\"self.memory\")  \u2500or\u2500  @node(\"world.town.citizen\")       \u2502\n\u2502   Semantic interface: aspects, effects, affordances              \u2502\n\u2502   Makes service available to all projections                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      SERVICE MODULE                             \u2502\n\u2502   services/brain/  \u2500or\u2500  services/town/  \u2500or\u2500  services/park/   \u2502\n\u2502   Business logic + TableAdapters + D-gent integration            \u2502\n\u2502   Frontend components live here (if any)                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    INFRASTRUCTURE LAYER                         \u2502\n\u2502   models/  \u2502  agents/d/  \u2502  agents/poly/  \u2502  LLM clients  \u2502 ... \u2502\n\u2502   Generic, reusable categorical primitives                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"skills/metaphysical-fullstack/#the-insight-why-adapters-live-in-service-modules","title":"The Insight: Why Adapters Live in Service Modules","text":"<p>Infrastructure doesn't know: - What tables are for - Why they're needed - When to use them - Business context</p> <p>Service modules know: - Domain semantics - When to persist what - Business rules - How to compose adapters</p> <pre><code># \u274c WRONG: Adapter in infrastructure\n# models/brain.py or agents/d/adapters/\nclass CrystalAdapter:\n    \"\"\"Generic adapter - doesn't know Brain semantics\"\"\"\n\n# \u2705 RIGHT: Adapter in service module\n# services/brain/persistence.py\nclass BrainPersistence:\n    \"\"\"Knows Brain domain: when to crystal, how to index, what to surface\"\"\"\n\n    def __init__(self, table_adapter: TableAdapter[Crystal], dgent: DgentProtocol):\n        self.table = table_adapter  # For queryable metadata\n        self.dgent = dgent          # For semantic content\n\n    async def capture(self, content: str, tags: list[str]) -&gt; CaptureResult:\n        \"\"\"Business logic: dual-track storage with domain awareness\"\"\"\n        # 1. Store semantic content in D-gent (for associations)\n        datum = await self.dgent.put(Datum(...))\n\n        # 2. Store queryable metadata in table (for fast queries)\n        crystal = Crystal(datum_id=datum.id, tags=tags, ...)\n        await self.table.put(crystal)\n\n        return CaptureResult(...)\n</code></pre>"},{"location":"skills/metaphysical-fullstack/#the-fullstack-flow","title":"The Fullstack Flow","text":""},{"location":"skills/metaphysical-fullstack/#1-service-module-foundation","title":"1. Service Module (Foundation)","text":"<pre><code>services/brain/\n\u251c\u2500\u2500 __init__.py           # Public API\n\u251c\u2500\u2500 crystal.py            # Core Brain logic\n\u251c\u2500\u2500 persistence.py        # TableAdapter + D-gent integration\n\u251c\u2500\u2500 search.py             # Semantic search\n\u251c\u2500\u2500 web/                  # Frontend components (if any)\n\u2502   \u251c\u2500\u2500 components/       # React/Svelte components\n\u2502   \u2514\u2500\u2500 hooks/            # Frontend hooks\n\u2514\u2500\u2500 _tests/\n</code></pre>"},{"location":"skills/metaphysical-fullstack/#2-agentese-node-semantic-interface","title":"2. AGENTESE Node (Semantic Interface)","text":"<pre><code># protocols/agentese/contexts/self_memory.py\n\n@node(\n    \"self.memory\",\n    dependencies=(\"brain_persistence\",),  # \u26a0\ufe0f MUST register in providers!\n)\n@dataclass\nclass MemoryNode:\n    \"\"\"AGENTESE node wrapping Brain service.\"\"\"\n\n    persistence: BrainPersistence  # Injected from service module\n\n    @aspect(category=AspectCategory.MUTATION, effects=[Effect.WRITES(\"crystals\")])\n    async def capture(self, observer: Observer, content: str) -&gt; CaptureResult:\n        return await self.persistence.capture(content)\n\n    @aspect(category=AspectCategory.PERCEPTION)\n    async def manifest(self, observer: Observer) -&gt; BrainStatus:\n        return await self.persistence.status()\n</code></pre> <p>\u26a0\ufe0f DI Contract: Every <code>dependencies=(\"foo\",)</code> in <code>@node</code> MUST have a matching provider registered in <code>services/providers.py</code>. The container silently skips unregistered dependencies, causing cryptic <code>TypeError</code> at instantiation. See <code>agentese-node-registration.md</code> \u2192 \"The Silent Skip Problem\".</p>"},{"location":"skills/metaphysical-fullstack/#3-agentese-universal-protocol-the-api-is-the-protocol","title":"3. AGENTESE Universal Protocol (The API IS the Protocol)","text":"<pre><code># No explicit routes needed! The protocol IS the API.\n# All transports collapse to the same invocation:\n\n# CLI\nkg brain capture \"content\"\n# \u2192 logos.invoke(\"self.memory.capture\", cli_observer, content=\"content\")\n\n# HTTP (auto-generated from AGENTESE registration)\nPOST /agentese/self.memory.capture\n# \u2192 logos.invoke(\"self.memory.capture\", http_observer, content=body.content)\n\n# WebSocket\n{\"path\": \"self.memory.capture\", \"args\": {\"content\": \"...\"}}\n# \u2192 logos.invoke(\"self.memory.capture\", ws_observer, content=msg.content)\n\n# gRPC, GraphQL, etc. - all the same pattern\n</code></pre> <p>Key Insight: Backend routes are NOT declared. The AGENTESE protocol auto-exposes all registered nodes through a universal gateway. Transport is an implementation detail.</p>"},{"location":"skills/metaphysical-fullstack/#4-frontend-lives-with-service","title":"4. Frontend (Lives with Service)","text":"<pre><code>// services/brain/web/components/CrystalViewer.tsx\n// Frontend component for Brain - lives in service module\nexport function CrystalViewer({ crystalId }: Props) {\n    // Calls AGENTESE universal protocol\n    const { data } = useAgentese(\"self.memory.crystal\", { id: crystalId });\n    return &lt;CrystalCard crystal={data} /&gt;;\n}\n</code></pre>"},{"location":"skills/metaphysical-fullstack/#5-main-website-container-functor","title":"5. Main Website (Container Functor)","text":"<pre><code>// impl/claude/web/app/brain/page.tsx\n// Main website is shallow passthrough - just composes projections\nimport { CrystalViewer } from '@kgents/services/brain/web';  // From service module\n\nexport default function BrainPage() {\n    return (\n        &lt;PageShell&gt;\n            &lt;CrystalViewer /&gt;  {/* Projection from service module */}\n        &lt;/PageShell&gt;\n    );\n}\n</code></pre>"},{"location":"skills/metaphysical-fullstack/#intelligent-resolution","title":"Intelligent Resolution","text":"<p>When parts are defined but others aren't, the system provides:</p>"},{"location":"skills/metaphysical-fullstack/#fallbacks","title":"Fallbacks","text":"Missing Fallback Frontend component Auto-generated from AGENTESE metadata CLI projection Default table/JSON rendering Help text Generated from aspect docstrings Error messages Sympathetic defaults"},{"location":"skills/metaphysical-fullstack/#guardrails","title":"Guardrails","text":"Check Behavior No service module Error: \"Agent X has no implementation\" No AGENTESE node Warning: \"Agent X not semantically registered\" No persistence Works in-memory only, warns on restart No effects declared Validation error at registration"},{"location":"skills/metaphysical-fullstack/#progressive-enhancement","title":"Progressive Enhancement","text":"<pre><code># Agent with minimal definition\n@node(\"self.minimal\")\nclass MinimalAgent:\n    @aspect(category=AspectCategory.PERCEPTION)\n    async def manifest(self) -&gt; dict:\n        return {\"status\": \"minimal\"}\n# \u2192 CLI works, API works, Web shows JSON\n\n# Agent with full definition\n@node(\"self.rich\")\nclass RichAgent:\n    persistence: RichPersistence       # Full dual-track\n    frontend: \"RichViewer\"             # Custom component\n\n    @aspect(\n        category=AspectCategory.MUTATION,\n        effects=[Effect.WRITES(\"rich_data\"), Effect.CALLS(\"llm\")],\n        help=\"Do something rich\",\n        examples=[\"kg rich do 'something'\"],\n        budget_estimate=\"medium\",\n        streaming=True,\n    )\n    async def do(self, ...) -&gt; RichResult:\n        ...\n# \u2192 Full CLI, full API, rich Web UI, streaming, budget tracking\n</code></pre>"},{"location":"skills/metaphysical-fullstack/#checklist-making-an-agent-fullstack","title":"Checklist: Making an Agent Fullstack","text":"<ul> <li> Service Module (<code>agents/&lt;name&gt;/</code>)</li> <li> Core business logic</li> <li> Persistence layer (TableAdapter + D-gent)</li> <li> Frontend components (if needed)</li> <li> <p> Tests</p> </li> <li> <p> AGENTESE Node (<code>protocols/agentese/contexts/</code>)</p> </li> <li> <code>@node</code> decorator with path</li> <li> <code>@aspect</code> decorators with metadata</li> <li> Effects declared</li> <li> <p> Help text and examples</p> </li> <li> <p> Projections (automatic once node exists)</p> </li> <li> CLI via projection functor</li> <li> API via AGENTESE router</li> <li> Web via container composition</li> </ul>"},{"location":"skills/metaphysical-fullstack/#anti-patterns","title":"Anti-Patterns","text":"<pre><code># \u274c Adapter in CLI handler\ndef cmd_brain(args):\n    adapter = TableAdapter(Crystal, session_factory)  # Wrong place!\n    ...\n\n# \u274c Explicit backend routes (routes should not exist!)\n@router.post(\"/brain/capture\")\nasync def capture(request):\n    ...  # Wrong - AGENTESE universal protocol handles this\n\n# \u274c Business logic in any route\n@router.post(\"/anything\")\nasync def anything(request):\n    crystal = Crystal(...)  # Wrong - should go through AGENTESE node\n    session.add(crystal)\n\n# \u274c Frontend bypassing AGENTESE\nconst crystal = await fetch('/db/crystals/123');  // Direct DB access!\n\n# \u274c Main website with embedded logic\nexport default function BrainPage() {\n    const [crystals, setCrystals] = useState([]);\n    useEffect(() =&gt; { loadCrystals(); }, []);  // Logic should be in service\n}\n\n# \u274c Service in agents/ directory\nagents/brain/  # Wrong - services/ is for Crown Jewels\n               # agents/ is for categorical primitives (PolyAgent, Operad, etc.)\n</code></pre>"},{"location":"skills/metaphysical-fullstack/#directory-structure","title":"Directory Structure","text":"<pre><code>impl/claude/\n\u251c\u2500\u2500 agents/           # Categorical primitives (infrastructure)\n\u2502   \u251c\u2500\u2500 poly/         # PolyAgent[S, A, B]\n\u2502   \u251c\u2500\u2500 operad/       # Composition grammar\n\u2502   \u251c\u2500\u2500 sheaf/        # Global coherence\n\u2502   \u251c\u2500\u2500 flux/         # Stream processing\n\u2502   \u251c\u2500\u2500 d/            # D-gent (generic persistence)\n\u2502   \u2514\u2500\u2500 ...           # Other algebraic agents\n\u2502\n\u251c\u2500\u2500 services/         # Crown Jewels (consumers of agents/)\n\u2502   \u251c\u2500\u2500 brain/        # Memory cathedral\n\u2502   \u251c\u2500\u2500 gardener/     # Cultivation practice\n\u2502   \u251c\u2500\u2500 town/         # Agent simulation\n\u2502   \u251c\u2500\u2500 park/         # Westworld hosts\n\u2502   \u251c\u2500\u2500 atelier/      # Creative workshop\n\u2502   \u251c\u2500\u2500 coalition/    # Agent collaboration\n\u2502   \u2514\u2500\u2500 gestalt/      # Living code garden\n\u2502\n\u251c\u2500\u2500 models/           # SQLAlchemy models (generic)\n\u251c\u2500\u2500 protocols/        # AGENTESE, CLI projection, API gateway\n\u2514\u2500\u2500 web/              # Container functor (shallow passthrough)\n</code></pre>"},{"location":"skills/metaphysical-fullstack/#related","title":"Related","text":"<ul> <li><code>spec/principles.md</code> \u00a7AD-009 - Metaphysical Fullstack Agent</li> <li><code>spec/protocols/projection.md</code> - Projection Protocol</li> <li><code>spec/protocols/agentese.md</code> - AGENTESE Universal Protocol</li> <li><code>docs/skills/building-agent.md</code> - Agent construction</li> <li><code>plans/d-gent-dual-track-architecture.md</code> - Persistence architecture</li> </ul> <p>\"The metaphysical fullstack agent is complete in definition, universal in projection.\"</p>"},{"location":"skills/plan-file/","title":"Skill: Writing Plan Files (Forest Protocol)","text":"<p>Create and maintain plan files following the Forest Protocol for multi-session coordination.</p> <p>Difficulty: Easy Prerequisites: Understanding of YAML headers, markdown Files Touched: <code>plans/&lt;category&gt;/&lt;name&gt;.md</code>, <code>plans/_forest.md</code></p>"},{"location":"skills/plan-file/#overview","title":"Overview","text":"<p>Plan files are the coordination mechanism for multi-session work. They follow the Forest Protocol (see <code>plans/principles.md</code>) with these key features:</p> Element Purpose YAML Header Machine-readable metadata for aggregation Status Lifecycle state (dormant, active, blocked, complete) Blockers Explicit dependencies on other plans or decisions Session Notes Breadcrumbs for continuity across sessions Chunks Parallelizable units of work"},{"location":"skills/plan-file/#step-by-step-create-a-plan-file","title":"Step-by-Step: Create a Plan File","text":""},{"location":"skills/plan-file/#step-1-choose-location","title":"Step 1: Choose Location","text":"<p>Plans are organized by category:</p> <pre><code>plans/\n\u251c\u2500\u2500 self/       # Internal systems (I-gent, memory, interface)\n\u251c\u2500\u2500 concept/    # Abstract concepts (creativity, lattice)\n\u251c\u2500\u2500 void/       # Entropy, Accursed Share\n\u251c\u2500\u2500 agents/     # Agent implementations (semaphores, k-gent)\n\u251c\u2500\u2500 world/      # External integrations (k8s, APIs)\n\u2514\u2500\u2500 meta/       # Planning system itself\n</code></pre>"},{"location":"skills/plan-file/#step-2-create-yaml-header","title":"Step 2: Create YAML Header","text":"<p>Every plan file starts with a machine-readable header:</p> <p>Template: <pre><code>---\npath: &lt;category&gt;/&lt;name&gt;\nstatus: dormant          # dormant | active | blocked | complete\nprogress: 0              # 0-100 percentage\nlast_touched: YYYY-MM-DD\ntouched_by: claude-opus-4.5\nblocking: []             # What this plan is waiting on\nenables: []              # What plans depend on this\nsession_notes: |\n  Initial creation. No work done yet.\n---\n</code></pre></p> <p>Example: <pre><code>---\npath: agents/k-gent\nstatus: active\nprogress: 40\nlast_touched: 2025-12-12\ntouched_by: claude-opus-4.5\nblocking: []\nenables: [self/memory]\nsession_notes: |\n  Phase 1 (CLI) complete. Phase 2 (Soul framework) in progress.\n  Blocked on: nothing\n  Next: Wire CLI to Soul eigenvector extraction\n---\n</code></pre></p>"},{"location":"skills/plan-file/#step-3-write-the-body","title":"Step 3: Write the Body","text":"<p>The body follows this structure:</p> <p><pre><code># &lt;Title&gt;: &lt;Subtitle&gt;\n\n&gt; *\"Optional thematic quote\"*\n\n**AGENTESE Context**: `self.&lt;path&gt;.*` (if applicable)\n**Status**: &lt;status&gt; (&lt;test count&gt;)\n**Principles**: Which principles this aligns with\n**Cross-refs**: Related plans, specs\n\n---\n\n## Core Insight\n\nWhat is the key idea? Why does this matter?\n\n---\n\n## Implementation Phases\n\n### Phase 1: &lt;Name&gt;\n\n**Goal**: What this phase achieves.\n\n**Files**:\n</code></pre> impl/claude/... <pre><code>**Exit Criteria**: How to know this phase is done.\n\n### Phase 2: &lt;Name&gt;\n\n...\n\n---\n\n## Key Types / API\n\nCode examples or type definitions if relevant.\n\n---\n\n## Cross-References\n\n- **Spec**: Links to spec files\n- **Plan**: Links to related plans\n- **Impl**: Links to implementation files\n</code></pre></p>"},{"location":"skills/plan-file/#step-by-step-update-status","title":"Step-by-Step: Update Status","text":""},{"location":"skills/plan-file/#step-1-update-header","title":"Step 1: Update Header","text":"<p>When status changes, update the YAML header:</p> <pre><code>---\npath: agents/semaphores\nstatus: complete          # Changed from active\nprogress: 100             # Changed from 85\nlast_touched: 2025-12-12  # Today\ntouched_by: claude-opus-4.5\nsession_notes: |\n  ALL PHASES COMPLETE (182 tests).\n  Ready for archive.\n---\n</code></pre>"},{"location":"skills/plan-file/#step-2-add-session-notes","title":"Step 2: Add Session Notes","text":"<p>Session notes should be brief and useful for the next session:</p> <pre><code>session_notes: |\n  Phase 2 in progress. FluxAgent ejection working.\n  Blocked on: DurablePurgatory needs D-gent integration\n  Insight: Perturbation queue reuse simplifies re-injection\n  Next: Complete Phase 3 (Symbiont integration)\n</code></pre>"},{"location":"skills/plan-file/#step-3-status-lifecycle","title":"Step 3: Status Lifecycle","text":"Status Meaning When to Use <code>dormant</code> Awaiting attention New plan, or paused work <code>active</code> Work in progress Currently being developed <code>blocked</code> Dependencies unmet Waiting on other plans/decisions <code>complete</code> All work done Ready to archive"},{"location":"skills/plan-file/#step-by-step-declare-blockers","title":"Step-by-Step: Declare Blockers","text":""},{"location":"skills/plan-file/#step-1-add-to-blocking-array","title":"Step 1: Add to blocking Array","text":"<pre><code>blocking: [self/stream, decision/database-choice]\n</code></pre>"},{"location":"skills/plan-file/#step-2-types-of-blockers","title":"Step 2: Types of Blockers","text":"Type Format Example Plan dependency <code>&lt;category&gt;/&lt;name&gt;</code> <code>self/stream</code> Decision needed <code>decision/&lt;topic&gt;</code> <code>decision/storage-backend</code> External <code>external/&lt;resource&gt;</code> <code>external/k8s-access</code> Context <code>context/&lt;topic&gt;</code> <code>context/research-needed</code>"},{"location":"skills/plan-file/#step-3-update-enables-in-dependency","title":"Step 3: Update enables in Dependency","text":"<p>When plan A blocks plan B, update A's <code>enables</code>:</p> <pre><code># In self/stream.md\nenables: [self/memory]\n</code></pre>"},{"location":"skills/plan-file/#step-by-step-chunk-work","title":"Step-by-Step: Chunk Work","text":"<p>Break plans into parallelizable chunks:</p>"},{"location":"skills/plan-file/#step-1-define-chunks","title":"Step 1: Define Chunks","text":"<pre><code>## Chunks\n\n### Chunk 1: Core Types (1-2 hours)\n- Define SemaphoreToken dataclass\n- Define ReentryContext dataclass\n- Create Purgatory store\n- **Exit criteria**: 49 tests pass\n\n### Chunk 2: Flux Integration (2 hours)\n- Add ejection logic to FluxAgent\n- Wire perturbation re-injection\n- **Exit criteria**: Can eject and resume\n\n### Chunk 3: CLI (1 hour)\n- Add semaphore handler\n- Wire subcommands\n- **Exit criteria**: `kgents semaphore list` works\n</code></pre>"},{"location":"skills/plan-file/#step-2-chunk-design-principles","title":"Step 2: Chunk Design Principles","text":"<ul> <li>Each chunk has clear exit criteria</li> <li>Chunks can be interleaved with other plan chunks</li> <li>A session can complete Chunk 1 of Plan A, then Chunk 1 of Plan B</li> </ul>"},{"location":"skills/plan-file/#step-by-step-archive-completed-plan","title":"Step-by-Step: Archive Completed Plan","text":""},{"location":"skills/plan-file/#step-1-update-status-to-complete","title":"Step 1: Update Status to Complete","text":"<pre><code>status: complete\nprogress: 100\n</code></pre>"},{"location":"skills/plan-file/#step-2-move-to-_archive","title":"Step 2: Move to _archive","text":"<pre><code>mv plans/agents/semaphores.md plans/_archive/agents/semaphores-2025-12.md\n</code></pre>"},{"location":"skills/plan-file/#step-3-keep-reference-in-enables","title":"Step 3: Keep Reference in Enables","text":"<p>Plans that depended on this can now proceed. Their <code>blocking</code> array should be empty.</p>"},{"location":"skills/plan-file/#verification","title":"Verification","text":""},{"location":"skills/plan-file/#check-1-valid-yaml-header","title":"Check 1: Valid YAML header","text":"<pre><code>cd impl/claude\nuv run python -c \"\nimport yaml\nwith open('../../plans/agents/k-gent.md') as f:\n    content = f.read()\n    header = content.split('---')[1]\n    data = yaml.safe_load(header)\n    print(f'Status: {data[\\\"status\\\"]}')\n    print(f'Progress: {data[\\\"progress\\\"]}%')\n\"\n</code></pre>"},{"location":"skills/plan-file/#check-2-forest-aggregation","title":"Check 2: Forest aggregation","text":"<p><code>plans/_forest.md</code> should reflect your plan. This file is auto-generated from headers.</p>"},{"location":"skills/plan-file/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/plan-file/#1-missing-yaml-header","title":"1. Missing YAML header","text":"<p>Symptom: Plan doesn't appear in <code>_forest.md</code> aggregation.</p> <p>Fix: Every plan file needs the YAML header between <code>---</code> delimiters.</p>"},{"location":"skills/plan-file/#2-invalid-status","title":"2. Invalid status","text":"<p>Wrong: <pre><code>status: in-progress  # Not a valid status\n</code></pre></p> <p>Right: <pre><code>status: active\n</code></pre></p> <p>Valid values: <code>dormant</code>, <code>active</code>, <code>blocked</code>, <code>complete</code></p>"},{"location":"skills/plan-file/#3-blocker-without-enables","title":"3. Blocker without enables","text":"<p>Symptom: Dependency graph is incomplete.</p> <p>Fix: When A blocks B, update A's <code>enables</code> array: <pre><code># In A.md\nenables: [path/to/B]\n\n# In B.md\nblocking: [path/to/A]\n</code></pre></p>"},{"location":"skills/plan-file/#4-session-notes-too-verbose","title":"4. Session notes too verbose","text":"<p>Wrong: <pre><code>session_notes: |\n  Today I worked on the semaphore system. First I created the token\n  dataclass, then I added the reason enum. The Purgatory store was\n  tricky because I had to think about serialization...\n</code></pre></p> <p>Right: <pre><code>session_notes: |\n  Phase 1 complete (49 tests). Serialization resolved via pickle.\n  Next: FluxAgent integration\n</code></pre></p>"},{"location":"skills/plan-file/#5-progress-percentage-mismatch","title":"5. Progress percentage mismatch","text":"<p>Symptom: Progress says 80% but work clearly isn't done.</p> <p>Fix: Progress should reflect phases completed: - Phase 1 done = 25% - Phase 2 done = 50% - Phase 3 done = 75% - Phase 4 done = 100%</p>"},{"location":"skills/plan-file/#real-example-agent-semaphores-plan","title":"Real Example: Agent Semaphores Plan","text":"<p>The <code>plans/agents/semaphores.md</code> demonstrates:</p> <ol> <li>Complete YAML header with all fields</li> <li>Rich session notes summarizing all phases</li> <li>Clear phase breakdown (6 phases)</li> <li>Cross-references to specs and impl</li> <li>Key types with code examples</li> <li>Status: complete with test count</li> </ol>"},{"location":"skills/plan-file/#related-skills","title":"Related Skills","text":"<ul> <li>None (this is a meta-skill for planning)</li> </ul>"},{"location":"skills/plan-file/#changelog","title":"Changelog","text":"<ul> <li>2025-12-12: Initial version based on Forest Protocol</li> </ul>"},{"location":"skills/polynomial-agent/","title":"Skill: Building a Polynomial Agent","text":"<p>Create a state-machine agent with mode-dependent behavior using the polynomial functor architecture.</p> <p>Difficulty: Medium-Advanced Prerequisites: Understanding of Agent[A, B], state machines, category theory basics Files Touched: <code>impl/claude/agents/&lt;letter&gt;/polynomial.py</code>, <code>impl/claude/agents/poly/</code>, tests References: <code>docs/architecture/polyfunctor.md</code>, <code>spec/architecture/polyfunctor.md</code></p>"},{"location":"skills/polynomial-agent/#overview","title":"Overview","text":"<p>A Polynomial Agent extends the basic <code>Agent[A, B]</code> pattern to capture mode-dependent behavior\u2014agents that behave differently based on their internal state.</p>"},{"location":"skills/polynomial-agent/#the-key-insight","title":"The Key Insight","text":"<pre><code>Agent[A, B] \u2245 A \u2192 B         # Stateless transformation (a lie)\nPolyAgent[S, A, B]          # State-dependent behavior (the truth)\n</code></pre> <p>Traditional <code>Agent[A, B]</code> misses a critical aspect: real agents have modes. A file system agent in \"reading\" mode accepts different inputs than in \"writing\" mode. The polynomial functor captures this.</p>"},{"location":"skills/polynomial-agent/#when-to-use-polynomial-agents","title":"When to Use Polynomial Agents","text":"Use Case Traditional Agent Polynomial Agent Stateless transform \u2713 \u2713 (degenerates to stateless) Mode-dependent I/O \u2717 \u2713 State machine \u2717 \u2713 Protocol phases \u2717 \u2713 Composable dynamics \u2717 \u2713"},{"location":"skills/polynomial-agent/#the-polynomial-agent-structure","title":"The Polynomial Agent Structure","text":"<p>From <code>impl/claude/agents/poly/protocol.py</code>:</p> <pre><code>PolyAgent[S, A, B] = (\n    positions: FrozenSet[S],          # Valid states\n    directions: S \u2192 FrozenSet[Type],  # State-dependent valid inputs\n    transition: S \u00d7 A \u2192 (S, B)        # State \u00d7 Input \u2192 (NewState, Output)\n)\n</code></pre> <p>Mathematical Interpretation (optional): <pre><code>P(y) = \u03a3_{s \u2208 S} y^{E(s)}\n</code></pre> Where S is positions, E(s) is directions at position s.</p>"},{"location":"skills/polynomial-agent/#step-by-step-creating-a-polynomial-agent","title":"Step-by-Step: Creating a Polynomial Agent","text":""},{"location":"skills/polynomial-agent/#step-1-define-the-state-machine","title":"Step 1: Define the State Machine","text":"<p>Start by identifying the states (positions) your agent needs.</p> <p>Example: Memory Agent States</p> <pre><code>from enum import Enum, auto\n\nclass MemoryPhase(Enum):\n    \"\"\"Positions in the memory polynomial.\"\"\"\n    IDLE = auto()       # Ready for commands\n    LOADING = auto()    # Fetching data\n    STORING = auto()    # Writing data\n    QUERYING = auto()   # Searching\n    FORGETTING = auto() # Clearing data\n</code></pre> <p>Good state design: - Each state represents a distinct mode of operation - States should be exhaustive (cover all cases) - States should be mutually exclusive</p>"},{"location":"skills/polynomial-agent/#step-2-define-direction-functions","title":"Step 2: Define Direction Functions","text":"<p>Directions specify what inputs are valid at each state.</p> <pre><code>def memory_directions(phase: MemoryPhase) -&gt; frozenset[type]:\n    \"\"\"What inputs are valid at each phase?\"\"\"\n    match phase:\n        case MemoryPhase.IDLE:\n            # Can route to any operation\n            return frozenset({LoadCommand, StoreCommand, QueryCommand, ForgetCommand})\n        case MemoryPhase.LOADING:\n            return frozenset({LoadCommand})\n        case MemoryPhase.STORING:\n            return frozenset({StoreCommand})\n        case MemoryPhase.QUERYING:\n            return frozenset({QueryCommand})\n        case MemoryPhase.FORGETTING:\n            return frozenset({ForgetCommand})\n</code></pre> <p>Key principle: The directions function encodes what's valid at each state, not just what's possible.</p>"},{"location":"skills/polynomial-agent/#step-3-define-the-transition-function","title":"Step 3: Define the Transition Function","text":"<p>The core of the polynomial agent: how state and input produce new state and output.</p> <pre><code>def memory_transition(\n    phase: MemoryPhase, input: Any\n) -&gt; tuple[MemoryPhase, Any]:\n    \"\"\"\n    State transition function.\n\n    transition: Phase \u00d7 Command \u2192 (NewPhase, Response)\n    \"\"\"\n    match phase:\n        case MemoryPhase.IDLE:\n            # Route to appropriate phase based on command type\n            if isinstance(input, LoadCommand):\n                return MemoryPhase.LOADING, input\n            elif isinstance(input, StoreCommand):\n                return MemoryPhase.STORING, input\n            # ... etc\n\n        case MemoryPhase.LOADING:\n            cmd = input if isinstance(input, LoadCommand) else LoadCommand()\n            # Perform load operation\n            data = load_from_storage(cmd.key)\n            return MemoryPhase.IDLE, MemoryResponse(success=True, data=data)\n\n        case MemoryPhase.STORING:\n            cmd = input if isinstance(input, StoreCommand) else StoreCommand(state=input)\n            # Perform store operation\n            save_to_storage(cmd.key, cmd.state)\n            return MemoryPhase.IDLE, MemoryResponse(success=True)\n</code></pre>"},{"location":"skills/polynomial-agent/#step-4-create-the-polyagent","title":"Step 4: Create the PolyAgent","text":"<p>Assemble the pieces into a <code>PolyAgent</code>:</p> <pre><code>from agents.poly.protocol import PolyAgent\n\nMEMORY_POLYNOMIAL: PolyAgent[MemoryPhase, Any, Any] = PolyAgent(\n    name=\"MemoryPolynomial\",\n    positions=frozenset(MemoryPhase),\n    _directions=memory_directions,\n    _transition=memory_transition,\n)\n</code></pre>"},{"location":"skills/polynomial-agent/#step-5-create-a-backwards-compatible-wrapper-optional","title":"Step 5: Create a Backwards-Compatible Wrapper (Optional)","text":"<p>For integration with existing code expecting <code>Agent[A, B]</code>:</p> <pre><code>class MemoryPolynomialAgent:\n    \"\"\"\n    Async wrapper providing Agent-like interface.\n    \"\"\"\n\n    def __init__(self, initial_state: Any = None) -&gt; None:\n        self._poly = MEMORY_POLYNOMIAL\n        self._phase = MemoryPhase.IDLE\n        if initial_state is not None:\n            self._store = {\"_default\": initial_state}\n\n    @property\n    def phase(self) -&gt; MemoryPhase:\n        return self._phase\n\n    async def store(self, data: Any, key: str = \"_default\") -&gt; MemoryResponse:\n        \"\"\"Store data (async interface for compatibility).\"\"\"\n        # Route through IDLE\n        self._phase, _ = self._poly.transition(self._phase, StoreCommand(state=data, key=key))\n        # Execute the store\n        self._phase, response = self._poly.transition(self._phase, StoreCommand(state=data, key=key))\n        return response\n</code></pre>"},{"location":"skills/polynomial-agent/#critical-patterns","title":"Critical Patterns","text":""},{"location":"skills/polynomial-agent/#pattern-1-instance-isolation","title":"Pattern 1: Instance Isolation","text":"<p>Problem: Global state causes instances to share memory.</p> <pre><code># BAD: Global state\n_memory_state: dict[str, Any] = {}  # All instances share this!\n\n# GOOD: Per-instance state\nclass MemoryStore:\n    def __init__(self) -&gt; None:\n        self.state: dict[str, Any] = {}\n        self.history: list[Any] = []\n\ndef create_memory_polynomial(store: MemoryStore) -&gt; PolyAgent:\n    \"\"\"Factory creates polynomial with isolated store.\"\"\"\n    def bound_transition(phase, input):\n        return memory_transition(phase, input, store)  # Closure captures store\n    return PolyAgent(..., _transition=bound_transition)\n</code></pre> <p>Always use factory functions for stateful polynomials.</p>"},{"location":"skills/polynomial-agent/#pattern-2-bayesian-confidence","title":"Pattern 2: Bayesian Confidence","text":"<p>When computing confidence from evidence:</p> <pre><code>def compute_confidence(n_supporting: int, n_contradicting: int, prior: float = 0.5) -&gt; float:\n    \"\"\"\n    Bayesian confidence with Laplace smoothing.\n\n    Prevents extreme values (0.0 or 1.0) which cause issues downstream.\n    \"\"\"\n    total = n_supporting + n_contradicting\n    if total == 0:\n        return prior  # No evidence \u2192 return prior\n\n    alpha = 1.0  # Smoothing parameter\n    confidence = (n_supporting + alpha * prior) / (total + alpha)\n\n    # Clamp to reasonable bounds\n    return max(0.05, min(0.95, confidence))\n</code></pre>"},{"location":"skills/polynomial-agent/#pattern-3-input-validation","title":"Pattern 3: Input Validation","text":"<p>Always validate inputs in the transition function:</p> <pre><code>def validate_query(input: Any) -&gt; Query:\n    \"\"\"Normalize and validate input.\"\"\"\n    if input is None:\n        return Query(claim=\"&lt;empty&gt;\")\n\n    if isinstance(input, Query):\n        claim = input.claim.strip() if input.claim else \"&lt;empty&gt;\"\n        if len(claim) &gt; 10000:\n            claim = claim[:10000] + \"... [truncated]\"\n        return Query(claim=claim, context=input.context)\n\n    # Convert to string\n    claim = str(input).strip() or \"&lt;empty&gt;\"\n    return Query(claim=claim)\n</code></pre>"},{"location":"skills/polynomial-agent/#pattern-4-composition-via-wiringdiagram","title":"Pattern 4: Composition via WiringDiagram","text":"<p>Compose polynomial agents:</p> <pre><code>from agents.poly import WiringDiagram, sequential, parallel\n\n# Sequential: soul \u2192 alethic\ndiagram = WiringDiagram(\n    name=\"soul_then_alethic\",\n    left=SOUL_POLYNOMIAL,\n    right=ALETHIC_AGENT,\n)\ncomposed = diagram.compose()\n\n# Parallel: run soul and memory concurrently\npar = parallel(SOUL_POLYNOMIAL, MEMORY_POLYNOMIAL)\n# State is product: (SoulContext, MemoryPhase)\n</code></pre>"},{"location":"skills/polynomial-agent/#testing-polynomial-agents","title":"Testing Polynomial Agents","text":""},{"location":"skills/polynomial-agent/#required-tests","title":"Required Tests","text":"<ol> <li> <p>State Machine Tests <pre><code>def test_all_phases_defined(self) -&gt; None:\n    \"\"\"All phases are defined.\"\"\"\n    for phase in MyPhase:\n        assert phase in MY_POLYNOMIAL.positions\n</code></pre></p> </li> <li> <p>Direction Tests <pre><code>def test_idle_accepts_all_commands(self) -&gt; None:\n    \"\"\"IDLE accepts all command types.\"\"\"\n    dirs = my_directions(MyPhase.IDLE)\n    assert Command1 in dirs\n    assert Command2 in dirs\n</code></pre></p> </li> <li> <p>Transition Tests <pre><code>def test_transition_returns_to_idle(self) -&gt; None:\n    \"\"\"Phase returns to IDLE after operation.\"\"\"\n    new_phase, _ = my_transition(MyPhase.PROCESSING, input)\n    assert new_phase == MyPhase.IDLE\n</code></pre></p> </li> <li> <p>Instance Isolation Tests <pre><code>async def test_instances_are_isolated(self) -&gt; None:\n    \"\"\"Two instances don't share state.\"\"\"\n    agent1 = MyPolynomialAgent()\n    agent2 = MyPolynomialAgent()\n\n    await agent1.store(\"data1\")\n    result = await agent2.load()\n\n    assert result is None  # agent2 shouldn't see agent1's data\n</code></pre></p> </li> <li> <p>Property-Based Tests (optional but recommended)    <pre><code>from hypothesis import given, strategies as st\n\n@given(input_val=st.integers())\ndef test_identity_law(self, input_val: int) -&gt; None:\n    \"\"\"Id &gt;&gt; agent = agent (left identity).\"\"\"\n    composed = sequential(ID, my_agent)\n    _, direct = my_agent.invoke(\"ready\", input_val)\n    _, composed_result = composed.invoke((\"ready\", \"ready\"), input_val)\n    assert direct == composed_result\n</code></pre></p> </li> </ol>"},{"location":"skills/polynomial-agent/#composition-laws","title":"Composition Laws","text":"<p>Polynomial agents must satisfy categorical laws:</p> Law Requirement Test Identity <code>Id &gt;&gt; f = f = f &gt;&gt; Id</code> Compose with identity, verify same output Associativity <code>(f &gt;&gt; g) &gt;&gt; h = f &gt;&gt; (g &gt;&gt; h)</code> Reorder composition, verify same output <p>These are verified in <code>impl/claude/agents/operad/_tests/test_properties.py</code>.</p>"},{"location":"skills/polynomial-agent/#integration-with-existing-architecture","title":"Integration with Existing Architecture","text":""},{"location":"skills/polynomial-agent/#using-primitives","title":"Using Primitives","text":"<p>Polynomial agents can compose the 17 primitives from <code>agents/poly/primitives.py</code>:</p> <pre><code>from agents.poly import GROUND, JUDGE, SUBLATE, SublateState\n\n# Example: Alethic agent composes primitives\ndef alethic_transition(state, input):\n    match state:\n        case AlethicState.GROUNDING:\n            _, grounded = GROUND.invoke(GroundState.FLOATING, input)\n            return AlethicState.DELIBERATING, grounded\n        case AlethicState.JUDGING:\n            _, verdict = JUDGE.invoke(JudgeState.DELIBERATING, claim)\n            return AlethicState.SYNTHESIZING, verdict\n        # ...\n</code></pre>"},{"location":"skills/polynomial-agent/#converting-to-bootstrap-agent","title":"Converting to Bootstrap Agent","text":"<p>Use deprecation sugar for backwards compatibility:</p> <pre><code>from agents.poly import to_bootstrap_agent, from_function\n\n# Create polynomial\npoly = from_function(\"Doubler\", lambda x: x * 2)\n\n# Convert to bootstrap Agent interface\nagent = to_bootstrap_agent(poly)\nresult = await agent.invoke(21)  # Returns 42\n</code></pre>"},{"location":"skills/polynomial-agent/#examples-in-the-codebase","title":"Examples in the Codebase","text":"Agent File States Notes Alethic <code>agents/a/alethic.py</code> GROUNDING, DELIBERATING, JUDGING, SYNTHESIZING Composes GROUND, JUDGE, SUBLATE Soul <code>agents/k/polynomial.py</code> 7 eigenvector contexts Maps to SOUL_SHEAF Memory <code>agents/d/polynomial.py</code> IDLE, LOADING, STORING, QUERYING, STREAMING, FORGETTING Instance isolation pattern Evolution <code>agents/e/polynomial.py</code> IDLE, SUN, MUTATE, SELECT, WAGER, INFECT, PAYOFF, COMPLETE Thermodynamic cycle Citizen <code>agents/town/polynomial.py</code> IDLE, SOCIALIZING, WORKING, REFLECTING, RESTING Right to Rest pattern"},{"location":"skills/polynomial-agent/#case-study-citizenpolynomial","title":"Case Study: CitizenPolynomial","text":"<p>The <code>CitizenPolynomial</code> demonstrates the polynomial functor in Agent Town simulation.</p>"},{"location":"skills/polynomial-agent/#positions-5-phases","title":"Positions (5 Phases)","text":"<pre><code>class CitizenPhase(Enum):\n    IDLE = auto()        # Ready for new interactions\n    SOCIALIZING = auto() # Engaged in social activity\n    WORKING = auto()     # Performing solo work\n    REFLECTING = auto()  # Internal contemplation\n    RESTING = auto()     # Mandatory rest (Right to Rest)\n</code></pre>"},{"location":"skills/polynomial-agent/#directions-mode-dependent-inputs","title":"Directions (Mode-Dependent Inputs)","text":"<pre><code>def citizen_directions(phase: CitizenPhase) -&gt; FrozenSet[Any]:\n    match phase:\n        case CitizenPhase.IDLE:\n            # Can do anything except wake\n            return frozenset({SocializeInput, WorkInput, ReflectInput, RestInput})\n        case CitizenPhase.RESTING:\n            # RIGHT TO REST: Only wake is valid\n            return frozenset({WakeInput})\n        case _:\n            # Contextual options\n            ...\n</code></pre>"},{"location":"skills/polynomial-agent/#the-right-to-rest-pattern","title":"The Right to Rest Pattern","text":"<p>A key design insight: citizens in RESTING phase cannot be disturbed:</p> <pre><code>case CitizenPhase.RESTING:\n    if isinstance(input, WakeInput):\n        return CitizenPhase.IDLE, CitizenOutput(success=True, message=\"Woke from rest\")\n    else:\n        # Reject ALL other inputs\n        return CitizenPhase.RESTING, CitizenOutput(\n            success=False,\n            message=\"Cannot be disturbed while resting (Right to Rest)\",\n        )\n</code></pre> <p>This is enforced by: 1. Directions: Only <code>WakeInput</code> is valid during RESTING 2. Transition: All other inputs return failure without state change</p>"},{"location":"skills/polynomial-agent/#usage","title":"Usage","text":"<pre><code>from agents.town.polynomial import CITIZEN_POLYNOMIAL, CitizenInput, CitizenPhase\n\n# Start idle\nphase = CitizenPhase.IDLE\n\n# Transition to socializing\nphase, output = CITIZEN_POLYNOMIAL.invoke(phase, CitizenInput.greet(\"alice\"))\n# \u2192 (SOCIALIZING, CitizenOutput(success=True, ...))\n\n# Transition to resting\nphase, output = CITIZEN_POLYNOMIAL.invoke(phase, CitizenInput.rest())\n# \u2192 (RESTING, CitizenOutput(success=True, ...))\n\n# Try to interrupt (fails)\nphase, output = CITIZEN_POLYNOMIAL.invoke(phase, CitizenInput.greet(\"bob\"))\n# \u2192 (RESTING, CitizenOutput(success=False, message=\"Cannot be disturbed...\"))\n\n# Wake up\nphase, output = CITIZEN_POLYNOMIAL.invoke(phase, CitizenInput.wake())\n# \u2192 (IDLE, CitizenOutput(success=True, ...))\n</code></pre>"},{"location":"skills/polynomial-agent/#key-insight-barads-agential-realism","title":"Key Insight: Barad's Agential Realism","text":"<p>From the docstring:</p> <p>\"Positions are not states but interpretive frames. The citizen does not 'change state'\u2014the observer makes a different agential cut. Each transition reconfigures the phenomenon, not the entity.\"</p> <p>This philosophical framing helps understand why polynomial agents are powerful: they model mode-dependent behavior as observation-dependent morphisms, not internal state changes</p>"},{"location":"skills/polynomial-agent/#common-mistakes","title":"Common Mistakes","text":"Mistake Problem Solution Global state Instances share memory Use MemoryStore pattern with factory Missing validation Crashes on None/empty Validate all inputs in transition Extreme confidence 0.0 or 1.0 breaks math Use Bayesian smoothing Skipping isolation tests Bugs in production Always test instance isolation Violating category laws Composition breaks Write property-based tests"},{"location":"skills/polynomial-agent/#cross-references","title":"Cross-References","text":"<ul> <li>Spec: <code>spec/architecture/polyfunctor.md</code></li> <li>Impl: <code>impl/claude/agents/poly/</code></li> <li>Tests: <code>impl/claude/agents/*/test_polynomial.py</code></li> <li>Plan: <code>docs/architecture/polyfunctor.md</code></li> <li>Theory: Niu &amp; Spivak, \"Polynomial Functors\"</li> </ul>"},{"location":"skills/projection-target/","title":"Skill: Custom Projection Targets","text":"<p>Register custom targets for the Projection Protocol.</p> <p>Difficulty: Easy Prerequisites: KgentsWidget basics Files: <code>agents/i/reactive/projection/registry.py</code>, <code>agents/i/reactive/projection/targets.py</code> References: <code>spec/protocols/projection.md</code></p>"},{"location":"skills/projection-target/#overview","title":"Overview","text":"<p>The Projection Protocol renders widgets to multiple surfaces (CLI, TUI, Web, etc.). Custom targets let you extend this to new surfaces without modifying widget code.</p> <p>Key insight: Projectors are registered once, then any widget can use them.</p>"},{"location":"skills/projection-target/#quick-start","title":"Quick Start","text":"<pre><code>from agents.i.reactive.projection import ProjectionRegistry\n\n@ProjectionRegistry.register(\"webgl\", fidelity=0.9)\ndef webgl_projector(widget):\n    \"\"\"Convert widget state to Three.js scene data.\"\"\"\n    return {\n        \"type\": \"scene\",\n        \"objects\": [{\"mesh\": \"box\", \"value\": widget.state.value}],\n    }\n\n# Use it\nresult = ProjectionRegistry.project(my_widget, \"webgl\")\n</code></pre>"},{"location":"skills/projection-target/#registration-api","title":"Registration API","text":""},{"location":"skills/projection-target/#decorator-syntax","title":"Decorator Syntax","text":"<pre><code>@ProjectionRegistry.register(\n    name: str,                # Target name (e.g., \"webgl\", \"audio\")\n    *,\n    fidelity: float = 0.5,    # Information preservation (0.0-1.0)\n    description: str = \"\",    # Human-readable description\n)\ndef projector(widget: KgentsWidget) -&gt; Any:\n    ...\n</code></pre>"},{"location":"skills/projection-target/#registration-at-import-time","title":"Registration at Import Time","text":"<p>Register projectors at module import for thread safety:</p> <pre><code># my_projectors.py\nfrom agents.i.reactive.projection import ProjectionRegistry\n\n@ProjectionRegistry.register(\"vr\", fidelity=0.95, description=\"VR headset rendering\")\ndef vr_projector(widget):\n    return widget.to_json()  # Placeholder until VR impl exists\n</code></pre> <p>Then import the module to activate:</p> <pre><code>import my_projectors  # Registers \"vr\" target\n</code></pre>"},{"location":"skills/projection-target/#fidelity-levels","title":"Fidelity Levels","text":"<p>Fidelity indicates information preservation (0.0 = maximum loss, 1.0 = lossless):</p> Level Range Examples LOSSLESS 1.0 JSON (full state) MAXIMUM 0.9-1.0 WebGL, WebXR (rich visualization) HIGH 0.7-0.9 marimo, TUI (interactive but constrained) MEDIUM 0.4-0.7 SSE (streaming, some loss) LOW 0.0-0.4 CLI (text only)"},{"location":"skills/projection-target/#querying-by-fidelity","title":"Querying by Fidelity","text":"<pre><code>from agents.i.reactive.projection import ProjectionRegistry, FidelityLevel\n\n# Get all high-fidelity targets\nhigh_fidelity = ProjectionRegistry.by_fidelity(FidelityLevel.HIGH)\nfor p in high_fidelity:\n    print(f\"{p.name}: {p.fidelity}\")\n</code></pre>"},{"location":"skills/projection-target/#choosing-fidelity-for-your-target","title":"Choosing Fidelity for Your Target","text":"<ul> <li>0.9+: Full visual/interactive capability (3D, VR, rich editors)</li> <li>0.7-0.9: Interactive but 2D (notebooks, TUIs)</li> <li>0.5-0.7: Streaming or constrained (SSE, mobile)</li> <li>0.2-0.5: Text-based (CLI, logs, email)</li> <li>&lt;0.2: Minimal (notifications, badges)</li> </ul>"},{"location":"skills/projection-target/#graceful-degradation","title":"Graceful Degradation","text":"<p>Unknown targets automatically fall back to JSON:</p> <pre><code># \"unknown_target\" not registered -&gt; falls back to JSON\nresult = ProjectionRegistry.project(widget, \"unknown_target\")\n\n# Custom fallback\nresult = ProjectionRegistry.project(widget, \"unknown\", fallback=\"cli\")\n</code></pre>"},{"location":"skills/projection-target/#implementing-fallback-in-projectors","title":"Implementing Fallback in Projectors","text":"<pre><code>@ProjectionRegistry.register(\"audio\", fidelity=0.4)\ndef audio_projector(widget):\n    # Check if widget has audio-specific method\n    if hasattr(widget, \"to_audio\"):\n        return widget.to_audio()\n\n    # Fallback: sonify the value\n    value = widget.state.value if hasattr(widget.state, \"value\") else 0.5\n    return {\"frequency\": 220 + value * 440, \"duration\": 0.5}\n</code></pre>"},{"location":"skills/projection-target/#patterns","title":"Patterns","text":""},{"location":"skills/projection-target/#pattern-1-wrap-existing-method","title":"Pattern 1: Wrap Existing Method","text":"<p>When widgets already have the capability:</p> <pre><code>@ProjectionRegistry.register(\"sse\", fidelity=0.6)\ndef sse_projector(widget):\n    if hasattr(widget, \"to_sse\"):\n        return widget.to_sse()\n    # Fallback: wrap JSON\n    import json\n    return f\"data: {json.dumps(widget.to_json())}\\n\\n\"\n</code></pre>"},{"location":"skills/projection-target/#pattern-2-transform-state","title":"Pattern 2: Transform State","text":"<p>When you need to reshape widget state:</p> <pre><code>@ProjectionRegistry.register(\"prometheus\", fidelity=0.3)\ndef prometheus_projector(widget):\n    \"\"\"Export widget state as Prometheus metrics.\"\"\"\n    state = widget.state\n    metrics = []\n\n    if hasattr(state, \"value\"):\n        metrics.append(f\"kgents_value{{widget=\\\"{type(widget).__name__}\\\"}} {state.value}\")\n    if hasattr(state, \"entropy\"):\n        metrics.append(f\"kgents_entropy{{widget=\\\"{type(widget).__name__}\\\"}} {state.entropy}\")\n\n    return \"\\n\".join(metrics)\n</code></pre>"},{"location":"skills/projection-target/#pattern-3-composite-projection","title":"Pattern 3: Composite Projection","text":"<p>When projecting composed widgets:</p> <pre><code>@ProjectionRegistry.register(\"slack\", fidelity=0.4)\ndef slack_projector(widget):\n    \"\"\"Convert widget to Slack Block Kit format.\"\"\"\n    from agents.i.reactive.composable import HStack, VStack\n\n    if isinstance(widget, (HStack, VStack)):\n        # Recursively project children\n        children = [\n            ProjectionRegistry.project(child, \"slack\")\n            for child in widget.children\n        ]\n        return {\"type\": \"section\", \"fields\": children}\n\n    # Single widget\n    return {\"type\": \"mrkdwn\", \"text\": widget.project(RenderTarget.CLI)}\n</code></pre>"},{"location":"skills/projection-target/#testing-custom-targets","title":"Testing Custom Targets","text":"<pre><code>import pytest\nfrom agents.i.reactive.projection import ProjectionRegistry\n\n@pytest.fixture(autouse=True)\ndef reset_registry():\n    \"\"\"Ensure test isolation.\"\"\"\n    ProjectionRegistry.reset()\n    yield\n    ProjectionRegistry.reset()\n\ndef test_custom_target():\n    @ProjectionRegistry.register(\"test_target\", fidelity=0.5)\n    def test_projector(widget):\n        return {\"custom\": True, \"value\": widget.state.value}\n\n    widget = BarWidget(BarState(value=0.75))\n    result = ProjectionRegistry.project(widget, \"test_target\")\n\n    assert result == {\"custom\": True, \"value\": 0.75}\n\ndef test_graceful_degradation():\n    widget = GlyphWidget(GlyphState(phase=\"active\"))\n\n    # Unknown target falls back to JSON\n    result = ProjectionRegistry.project(widget, \"nonexistent\")\n    assert isinstance(result, dict)\n    assert result[\"phase\"] == \"active\"\n</code></pre>"},{"location":"skills/projection-target/#built-in-targets","title":"Built-in Targets","text":"<p>The registry ships with these targets:</p> Target Fidelity Method <code>cli</code> 0.2 <code>widget.project(RenderTarget.CLI)</code> <code>tui</code> 0.5 <code>widget.project(RenderTarget.TUI)</code> <code>marimo</code> 0.8 <code>widget.project(RenderTarget.MARIMO)</code> <code>json</code> 1.0 <code>widget.project(RenderTarget.JSON)</code> <code>sse</code> 0.6 <code>widget.to_sse()</code> or JSON fallback <p>Placeholder targets (not yet implemented): - <code>webgl</code> (0.9) - <code>webxr</code> (0.95) - <code>audio</code> (0.4)</p>"},{"location":"skills/projection-target/#registry-api-reference","title":"Registry API Reference","text":"<pre><code># Register a projector\n@ProjectionRegistry.register(\"name\", fidelity=0.5)\ndef projector(widget): ...\n\n# Project a widget\nresult = ProjectionRegistry.project(widget, \"target\")\nresult = ProjectionRegistry.project(widget, ExtendedTarget.CLI)\n\n# Query registry\nProjectionRegistry.supports(\"webgl\")           # -&gt; bool\nProjectionRegistry.all_targets()               # -&gt; [\"cli\", \"json\", ...]\nProjectionRegistry.get(\"cli\")                  # -&gt; Projector | None\nProjectionRegistry.by_fidelity(FidelityLevel.HIGH)  # -&gt; [Projector, ...]\n\n# Test isolation\nProjectionRegistry.reset()  # Clear custom registrations\n</code></pre>"},{"location":"skills/projection-target/#best-practices","title":"Best Practices","text":""},{"location":"skills/projection-target/#1-register-at-import-time","title":"1. Register at Import Time","text":"<pre><code># Good: deterministic registration order\n# my_targets.py\n@ProjectionRegistry.register(\"custom\")\ndef custom_projector(widget): ...\n\n# main.py\nimport my_targets  # Registration happens here\n</code></pre>"},{"location":"skills/projection-target/#2-choose-accurate-fidelity","title":"2. Choose Accurate Fidelity","text":"<p>Don't overstate fidelity. CLI projection loses color, interactivity, and spatial layout - it's honestly 0.2, not 0.5.</p>"},{"location":"skills/projection-target/#3-document-widget-requirements","title":"3. Document Widget Requirements","text":"<pre><code>@ProjectionRegistry.register(\"audio\", fidelity=0.4)\ndef audio_projector(widget):\n    \"\"\"\n    Project widget to audio representation.\n\n    Widget requirements:\n        - state.value (float 0.0-1.0) -&gt; frequency\n        - state.phase (str) -&gt; instrument selection\n\n    Falls back to 440Hz sine wave if requirements not met.\n    \"\"\"\n    ...\n</code></pre>"},{"location":"skills/projection-target/#4-handle-composition","title":"4. Handle Composition","text":"<p>Check for HStack/VStack and recurse:</p> <pre><code>from agents.i.reactive.composable import ComposableWidget\n\nif isinstance(widget, ComposableWidget):\n    return [ProjectionRegistry.project(c, target) for c in widget.children]\n</code></pre>"},{"location":"skills/projection-target/#related-skills","title":"Related Skills","text":"<ul> <li>projection-gallery - Building showcase galleries</li> <li>building-agent - Creating agents with projectable state</li> </ul>"},{"location":"skills/projection-target/#source-reference","title":"Source Reference","text":"<ul> <li><code>agents/i/reactive/projection/registry.py</code> - ProjectionRegistry</li> <li><code>agents/i/reactive/projection/targets.py</code> - ExtendedTarget, FidelityLevel</li> <li><code>agents/i/reactive/projection/laws.py</code> - Functor law verification</li> </ul> <p>Skill created: 2025-12-16 | Projection Protocol Phase</p>"},{"location":"skills/spec-hygiene/","title":"Skill: Spec Hygiene","text":"<p>\"Spec is compression. If you can't compress it, you don't understand it.\"</p>"},{"location":"skills/spec-hygiene/#overview","title":"Overview","text":"<p>This document codifies learnings from the 8-phase spec distillation exercise (December 2025), which reduced the spec corpus from ~91,000 to ~78,000 lines while increasing clarity and generativity.</p> <p>Related: <code>docs/skills/spec-template.md</code> (structure), <code>spec/principles.md</code> (philosophy)</p>"},{"location":"skills/spec-hygiene/#the-seven-bloat-patterns","title":"The Seven Bloat Patterns","text":"<p>These patterns were identified and removed during distillation. Watch for them in new specs.</p>"},{"location":"skills/spec-hygiene/#1-implementation-creep-most-common","title":"1. Implementation Creep (Most Common)","text":"<p>Symptom: Full function bodies in spec files (&gt;10 lines of code)</p> <p>Example (Bad): <pre><code># This was in spec/protocols/self-grow.md\nasync def recognize_gaps(self, context: GrowthContext) -&gt; list[GapSignal]:\n    existing = await self._load_current_holons()\n    requested = self._extract_requested_from_context(context)\n    gaps = []\n    for req in requested:\n        if not self._find_matching_holon(req, existing):\n            signal = GapSignal(\n                pattern=req.pattern,\n                frequency=req.mention_count,\n                source_contexts=[context.id],\n                confidence=self._estimate_confidence(req)\n            )\n            gaps.append(signal)\n    return sorted(gaps, key=lambda g: g.confidence, reverse=True)\n</code></pre></p> <p>Fixed (Good): <pre><code>async def recognize_gaps(context: GrowthContext) -&gt; list[GapSignal]:\n    \"\"\"Identify ontological gaps from usage patterns.\"\"\"\n    ...  # See impl/claude/protocols/agentese/contexts/self_grow/\n</code></pre></p> <p>Metric: self-grow.md was 80% implementation code (2,037 \u2192 442 lines)</p>"},{"location":"skills/spec-hygiene/#2-roadmap-drift","title":"2. Roadmap Drift","text":"<p>Symptom: Week-by-week plans, implementation timelines, checkbox lists</p> <p>Example (Bad): <pre><code>## Implementation Roadmap\n\n### Week 1-2: Core Types\n- [ ] Define Parser protocol\n- [ ] Implement StackBalancingParser\n- [ ] Add tests\n\n### Week 3-4: Advanced Strategies\n- [ ] ProbabilisticASTParser\n- [ ] EvolvingParser\n...\n</code></pre></p> <p>Fixed: Move to <code>plans/</code> directory. Specs are timeless; plans are temporal.</p> <p>Metric: p-gents/README.md had 200+ lines of roadmap</p>"},{"location":"skills/spec-hygiene/#3-framework-comparison-tables","title":"3. Framework Comparison Tables","text":"<p>Symptom: Decision matrices comparing kgents to other frameworks</p> <p>Example (Bad): <pre><code>| Feature | kgents | LangChain | AutoGPT |\n|---------|--------|-----------|---------|\n| Tool composition | Functorial | Imperative | ... |\n| Memory model | Sheaf | Vector DB | ... |\n...\n</code></pre></p> <p>Fixed: Move to <code>docs/</code> if valuable, otherwise delete. Spec defines WHAT, not WHY NOT OTHERS.</p>"},{"location":"skills/spec-hygiene/#4-gap-analyses","title":"4. Gap Analyses","text":"<p>Symptom: \"Current State vs Desired State\" sections</p> <p>Example (Bad): <pre><code>## Gap Analysis\n\n### Current Implementation\n- Only supports 3 of 14 functors\n- No streaming support\n- Memory limited to 10MB\n\n### Desired State\n- All 14 functors implemented\n- Full streaming support\n...\n</code></pre></p> <p>Fixed: Delete. These are temporal snapshots, not specifications. The spec defines the target; implementation tracks progress.</p>"},{"location":"skills/spec-hygiene/#5-ai-session-artifacts","title":"5. AI Session Artifacts","text":"<p>Symptom: Continuation prompts, agent instructions, session notes in specs</p> <p>Example (Bad): <pre><code>## Continuation Prompt\n\nWhen resuming this session:\n1. Read the context above\n2. Check git status\n3. Continue from Phase 3\n...\n</code></pre></p> <p>Fixed: Move to <code>plans/_continuations/</code>. Specs are not session logs.</p>"},{"location":"skills/spec-hygiene/#6-file-listings","title":"6. File Listings","text":"<p>Symptom: \"Files to Create\" sections with directory trees</p> <p>Example (Bad): <pre><code>## Files to Create\n\nimpl/claude/agents/p/\n\u251c\u2500\u2500 types.py              # All type definitions\n\u251c\u2500\u2500 stack_balancing.py    # StackBalancingParser implementation\n\u251c\u2500\u2500 anchor_based.py       # AnchorBasedParser implementation\n\u251c\u2500\u2500 probabilistic_ast.py  # ProbabilisticASTParser implementation\n\u251c\u2500\u2500 evolving.py           # EvolvingParser implementation\n\u251c\u2500\u2500 composition.py        # FallbackParser, FusionParser\n\u2514\u2500\u2500 graduated.py          # GraduatedPromptParser\n</code></pre></p> <p>Fixed: A single line suffices: <pre><code>**Implementation**: `impl/claude/agents/p/` (12 tests)\n</code></pre></p>"},{"location":"skills/spec-hygiene/#7-test-code-as-laws","title":"7. Test Code as Laws","text":"<p>Symptom: Full pytest functions in \"Laws\" section</p> <p>Example (Bad): <pre><code>## Laws\n\ndef test_functor_identity_law():\n    agent = create_agent()\n    assert agent.map(lambda x: x) == agent\n\ndef test_functor_composition_law():\n    agent = create_agent()\n    f = lambda x: x + 1\n    g = lambda x: x * 2\n    assert agent.map(f).map(g) == agent.map(lambda x: g(f(x)))\n</code></pre></p> <p>Fixed: Laws as equations: <pre><code>## Laws\n\n1. **Identity**: `F.map(id) = id`\n2. **Composition**: `F.map(g . f) = F.map(g) . F.map(f)`\n</code></pre></p>"},{"location":"skills/spec-hygiene/#the-five-compression-patterns","title":"The Five Compression Patterns","text":"<p>These patterns emerged as effective ways to compress specs while maintaining generativity.</p>"},{"location":"skills/spec-hygiene/#1-type-signatures-with-ellipsis","title":"1. Type Signatures with Ellipsis","text":"<p>Show the shape, hide the body:</p> <pre><code>@dataclass\nclass MemoryCrystal(Generic[T]):\n    \"\"\"Immutable, content-addressed memory artifact.\"\"\"\n    content: T\n    hash: str\n    created_at: datetime\n    lineage: list[str]\n\n    async def recall(self, query: Query) -&gt; Stream[T]:\n        ...  # Holographic retrieval\n\n    async def consolidate(self, other: \"MemoryCrystal[T]\") -&gt; \"MemoryCrystal[T]\":\n        ...  # Merge with lineage tracking\n</code></pre>"},{"location":"skills/spec-hygiene/#2-laws-as-algebraic-equations","title":"2. Laws as Algebraic Equations","text":"<p>Declarative, not procedural:</p> <pre><code>## Laws\n\n| Law | Statement |\n|-----|-----------|\n| Associativity | `(f &gt;&gt; g) &gt;&gt; h = f &gt;&gt; (g &gt;&gt; h)` |\n| Identity | `id &gt;&gt; f = f = f &gt;&gt; id` |\n| Naturality | `P(f . g) = P(f) . P(g)` for functor P |\n| Rashomon | `witness(e, O1) \u2260 witness(e, O2)` for distinct observers |\n</code></pre>"},{"location":"skills/spec-hygiene/#3-agentese-path-chains","title":"3. AGENTESE Path Chains","text":"<p>Composition in one line:</p> <pre><code>## Integration\n\n- **Recall**: `self.memory.crystallize` \u2192 `concept.association.emerge`\n- **Store**: `world.event.manifest` \u2192 `self.memory.absorb` \u2192 `void.gratitude.tithe`\n- **Narrate**: `self.memory.witness` \u2192 `concept.narrative.collapse` \u2192 `world.story.tell`\n</code></pre>"},{"location":"skills/spec-hygiene/#4-ascii-architecture-diagrams","title":"4. ASCII Architecture Diagrams","text":"<p>Worth 100 lines of prose:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    PROJECTION                        \u2502\n\u2502  State \u2500\u2500\u2192 Widget \u2500\u2500\u2192 Layout \u2500\u2500\u2192 Target             \u2502\n\u2502    \u2502         \u2502          \u2502          \u2502                 \u2502\n\u2502  [data]   [atomic]   [spatial]  [render]            \u2502\n\u2502            Signal     VBox       CLI/JSON/VR         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"skills/spec-hygiene/#5-summary-tables","title":"5. Summary Tables","text":"<p>Compress enumeration into scannable form:</p> <pre><code>## Functor Summary\n\n| Functor | Polynomial | Core Insight |\n|---------|------------|--------------|\n| Promise | `y^A` | Deferred computation |\n| Metered | `1 + y` | Resource-gated execution |\n| Spy | `y \u00d7 Log` | Observation without interference |\n| Lens | `y^(S\u00d7A)` | Bidirectional state access |\n</code></pre>"},{"location":"skills/spec-hygiene/#distillation-checklist","title":"Distillation Checklist","text":"<p>When reviewing or distilling a spec:</p> <pre><code>- [ ] **No function bodies &gt;10 lines** (extract to impl/)\n- [ ] **No roadmaps or timelines** (move to plans/)\n- [ ] **No framework comparisons** (move to docs/ or delete)\n- [ ] **No gap analyses** (delete - temporal, not conceptual)\n- [ ] **No session artifacts** (move to plans/_continuations/)\n- [ ] **No file listings** (one-line impl reference)\n- [ ] **Laws are equations, not test code**\n- [ ] **Type signatures use `...` for bodies**\n- [ ] **AGENTESE paths are chains, not paragraphs**\n- [ ] **Diagrams replace prose where possible**\n- [ ] **Spec &lt; Impl** (compression achieved)\n- [ ] **Spec is generative** (can regenerate impl from spec)\n</code></pre>"},{"location":"skills/spec-hygiene/#metrics-from-distillation-exercise","title":"Metrics from Distillation Exercise","text":""},{"location":"skills/spec-hygiene/#phase-results","title":"Phase Results","text":"Phase Target Before After Reduction 1 Deprecated files ~5,700 0 100% 2 self-grow.md 2,037 442 78% 3 p-gents/README.md 1,568 427 73% 4 u-gents/tool-use.md 1,381 518 62% 5 b-gents/banker.md 1,394 275 80% 6 AGENTESE consolidation 2,253 1,051 53% 7 Template creation - 133 (new) 8 6 HIGH/MEDIUM specs 5,952 2,917 51%"},{"location":"skills/spec-hygiene/#overall","title":"Overall","text":"Metric Before After Change Total spec lines ~91,000 ~78,000 -14% Specs &gt;1,000 lines 15+ 4 -73% Impl code in specs ~25,000 ~5,000 -80%"},{"location":"skills/spec-hygiene/#the-generative-test","title":"The Generative Test","text":"<p>A spec passes the generative test if:</p> <ol> <li>Compression: <code>lines(spec) &lt; lines(impl)</code></li> <li>Regeneration: An implementer can build the system from the spec alone</li> <li>Laws Hold: All stated invariants are mechanically verifiable</li> <li>No Orphans: Every type in spec has corresponding impl/</li> </ol> <pre><code>def is_generative(spec: Path, impl: Path) -&gt; bool:\n    \"\"\"The ultimate spec quality check.\"\"\"\n    spec_lines = count_lines(spec)\n    impl_lines = count_lines(impl)\n\n    # Compression achieved\n    if spec_lines &gt;= impl_lines:\n        return False\n\n    # All types have implementations\n    spec_types = extract_types(spec)\n    impl_types = extract_types(impl)\n    if not spec_types.issubset(impl_types):\n        return False\n\n    # Laws are testable\n    laws = extract_laws(spec)\n    for law in laws:\n        if not is_verifiable(law):\n            return False\n\n    return True\n</code></pre>"},{"location":"skills/spec-hygiene/#anti-patterns-summary","title":"Anti-Patterns Summary","text":"Anti-Pattern Signal Fix Implementation Creep Functions &gt;10 lines Extract to impl/ Roadmap Drift Week-by-week plans Move to plans/ Framework Comparison Decision matrices Move to docs/ Gap Analysis Current vs Desired Delete Session Artifacts Continuation prompts Move to plans/_continuations/ File Listings Directory trees One-line reference Test Code as Laws pytest functions Algebraic equations"},{"location":"skills/spec-hygiene/#cross-references","title":"Cross-References","text":"<ul> <li><code>docs/skills/spec-template.md</code> - Structure for new specs</li> <li><code>spec/principles.md</code> - \u00a77 Generative Principle</li> <li><code>plans/meta/spec-distillation.md</code> - Full distillation history</li> <li><code>docs/impl-guide.md</code> - Where implementations go</li> </ul> <p>\"The event is the stone. The story is the shadow. The spec is the light that casts them both.\"</p>"},{"location":"skills/spec-template/","title":"Skill: Writing Spec Files","text":"<p>\"Spec is compression. If you can't compress it, you don't understand it.\" \u2014 principles.md</p>"},{"location":"skills/spec-template/#the-generative-principle","title":"The Generative Principle","text":"<p>A well-formed spec is smaller than its implementation but contains enough information to regenerate it. The spec is the compression; the impl is the decompression.</p>"},{"location":"skills/spec-template/#spec-structure-200-400-lines-max","title":"Spec Structure (200-400 lines max)","text":""},{"location":"skills/spec-template/#required-sections","title":"Required Sections","text":"<pre><code># {Agent/Protocol Name}\n\n**Status:** {Proposal|Draft|Standard|Canonical}\n**Implementation:** `impl/claude/{path}/` ({N} tests)\n\n## Purpose\n{1 paragraph - why this exists}\n\n## Core Insight\n{1 sentence - the key idea that makes this work}\n\n## Type Signatures\n{Protocol definitions, dataclass signatures - NO method bodies}\n\n## Laws/Invariants\n{Algebraic laws that must hold - NOT test code}\n\n## Integration\n{AGENTESE paths, composition with other agents}\n\n## Anti-Patterns\n{3-5 bullets - what NOT to do}\n\n## Implementation Reference\nSee: `impl/claude/{path}/`\n</code></pre>"},{"location":"skills/spec-template/#optional-sections","title":"Optional Sections","text":"<ul> <li>Theoretical Foundation: Category theory, type theory references</li> <li>Biological Parallels: If applicable (B-gents especially)</li> <li>Design Decisions: Brief rationale for key choices</li> </ul>"},{"location":"skills/spec-template/#forbidden-in-specs","title":"Forbidden in Specs","text":"Don't Include Why Where It Goes Full function implementations Not compression <code>impl/</code> SQL queries Implementation detail <code>impl/</code> Implementation roadmaps Temporal, not conceptual <code>plans/</code> Week-by-week schedules Not specification <code>plans/</code> &gt;10 line code examples Show USAGE not IMPL Keep brief Framework comparisons Not spec content <code>docs/</code> Test code Tests belong with impl <code>impl/</code>"},{"location":"skills/spec-template/#code-example-rules","title":"Code Example Rules","text":""},{"location":"skills/spec-template/#good-type-signatures","title":"Good: Type Signatures","text":"<pre><code>@dataclass\nclass Tool(Generic[A, B]):\n    \"\"\"A morphism in the tool category.\"\"\"\n    meta: ToolMeta\n    # Methods defined in impl\n</code></pre>"},{"location":"skills/spec-template/#good-usage-not-implementation","title":"Good: Usage (Not Implementation)","text":"<pre><code># Composition (what), not implementation (how)\npipeline = parse_query &gt;&gt; search_tool &gt;&gt; format_results\n</code></pre>"},{"location":"skills/spec-template/#bad-full-implementation","title":"Bad: Full Implementation","text":"<pre><code># DON'T put this in specs\nasync def execute(self, input: A) -&gt; Result[B, ToolError]:\n    if not self._validate_schema(input):\n        return err(ToolError(...))\n    try:\n        raw = await self._invoke(input)\n        return ok(self._parse_output(raw))\n    except Exception as e:\n        return err(ToolError(...))\n</code></pre>"},{"location":"skills/spec-template/#distillation-checklist","title":"Distillation Checklist","text":"<p>When distilling an existing spec:</p> <ol> <li> Identify all code blocks &gt;10 lines</li> <li> For each: Is this USAGE or IMPLEMENTATION?</li> <li> Extract implementations to <code>impl/</code></li> <li> Replace with type signatures or brief usage</li> <li> Move roadmaps to <code>plans/</code></li> <li> Move comparisons to <code>docs/</code></li> <li> Verify spec &lt; impl (compression achieved)</li> <li> Verify spec is generative (can regenerate impl)</li> </ol>"},{"location":"skills/spec-template/#line-count-guidelines","title":"Line Count Guidelines","text":"Spec Type Target Lines Hard Limit Simple agent 100-200 300 Complex agent 200-300 400 Protocol 300-400 500 Core system 400-500 600 <p>If a spec exceeds these limits, it likely contains implementation.</p>"},{"location":"skills/spec-template/#the-compression-test","title":"The Compression Test","text":"<p>Ask yourself:</p> <ol> <li>Can I regenerate the impl from this spec? If yes, it's generative.</li> <li>Is the spec smaller than the impl? If yes, compression achieved.</li> <li>Does the spec contain WHAT not HOW? If yes, it's a spec.</li> </ol>"},{"location":"skills/spec-template/#cross-references","title":"Cross-References","text":"<ul> <li><code>spec/principles.md</code> \u00a77 (Generative Principle)</li> <li><code>docs/impl-guide.md</code> (Where impl goes)</li> <li><code>docs/skills/plan-file.md</code> (Where roadmaps go)</li> </ul> <p>\"The master's touch was always just compressed experience. Now we can share the compression.\"</p>"},{"location":"skills/test-patterns/","title":"Skill: Testing Patterns and Conventions","text":"<p>Write comprehensive agent tests using T-gent Types I-V taxonomy and testing infrastructure.</p> <p>Difficulty: Easy-Medium Prerequisites: pytest basics, Python async/await Files Touched: <code>*/_tests/test_*.py</code>, <code>impl/claude/testing/</code> References: <code>agents/t/</code>, <code>testing/__init__.py</code></p>"},{"location":"skills/test-patterns/#overview","title":"Overview","text":"<p>kgents uses a five-level test taxonomy (T-gent Types I-V) that progresses from contract verification to metamorphic testing. The <code>testing/</code> package provides infrastructure for each level.</p> <p>Tests are the executable specification\u2014they define agent behavior more precisely than prose.</p>"},{"location":"skills/test-patterns/#t-gent-types-i-v-taxonomy","title":"T-gent Types I-V Taxonomy","text":"Type Name Purpose Tools I Contracts Preconditions, postconditions, invariants <code>pytest</code>, <code>PredicateAgent</code> II Saboteurs Property-based testing, fuzzing <code>Hypothesis</code>, <code>NoiseAgent</code> III Spies Behavior verification, call tracking <code>SpyAgent</code>, <code>CounterAgent</code> IV Judges Semantic assertions, LLM validation <code>Oracle</code>, <code>JudgeAgent</code> V Witnesses Integration tests, round-trip verification <code>Topologist</code>, <code>Cortex</code>"},{"location":"skills/test-patterns/#conventions","title":"Conventions","text":"<ul> <li>Test directory: <code>_tests/</code> folders next to source files</li> <li>Test naming: <code>test_&lt;feature&gt;.py</code> files, <code>Test&lt;Class&gt;</code> classes, <code>test_&lt;behavior&gt;</code> methods</li> <li>Async tests: <code>@pytest.mark.asyncio</code> decorator</li> <li>Fixtures: Centralized in <code>conftest.py</code>, module-local for specifics</li> <li>Type-safe mocks: Use <code>testing.as_umwelt()</code> and <code>testing.as_agent()</code></li> <li>Custom markers: <code>@pytest.mark.law</code>, <code>@pytest.mark.slow</code>, <code>@pytest.mark.property</code></li> </ul>"},{"location":"skills/test-patterns/#t-gent-test-agents","title":"T-gent Test Agents","text":"<p>The <code>agents/t/</code> package provides composable test agents:</p> Agent Purpose Key Methods <code>MockAgent</code> Constant output <code>call_count</code> <code>FixtureAgent</code> Deterministic lookup <code>lookup_count</code> <code>FailingAgent</code> Controlled failures <code>reset()</code> <code>SpyAgent</code> Identity + observation <code>assert_captured()</code>, <code>history</code> <code>PredicateAgent</code> Validation gate <code>pass_count</code>, <code>fail_count</code> <code>NoiseAgent</code> Semantic perturbation <code>level</code>, <code>seed</code> <code>LatencyAgent</code> Temporal delay <code>delay</code>, <code>variance</code> <code>FlakyAgent</code> Probabilistic failure <code>probability</code> <code>CounterAgent</code> Call counting <code>count</code>, <code>assert_count()</code> <code>MetricsAgent</code> Timing metrics <code>metrics.avg_time</code>"},{"location":"skills/test-patterns/#usage-examples","title":"Usage Examples","text":"<pre><code>from agents.t import (\n    MockAgent, MockConfig,\n    SpyAgent, CounterAgent, MetricsAgent,\n    NoiseAgent, LatencyAgent, FlakyAgent,\n    PredicateAgent, not_empty,\n)\n\n# MockAgent: constant morphism\nmock = MockAgent[str, dict](MockConfig(output={\"status\": \"ok\"}))\nresult = await mock.invoke(\"anything\")  # Always {\"status\": \"ok\"}\nassert mock.call_count == 1\n\n# SpyAgent: identity + observation\nspy = SpyAgent[str](label=\"Pipeline\")\nawait pipeline_with_spy.invoke(\"input1\")\nspy.assert_captured(\"input1\")\nspy.assert_count(1)\n\n# PredicateAgent: validation gate\nvalidator = PredicateAgent[str](not_empty, name=\"NonEmpty\")\nawait validator.invoke(\"hello\")  # Passes\n# await validator.invoke(\"\")     # Raises ValueError\n\n# NoiseAgent: semantic perturbation (for fuzzing)\nnoise = NoiseAgent[str](level=0.5, seed=42)\nperturbed = await noise.invoke(\"Fix the bug\")  # \u2192 \"Fix te bug\"\n\n# CounterAgent: track invocations\ncounter = CounterAgent[str](label=\"Calls\")\nawait counter.invoke(\"a\")\nawait counter.invoke(\"b\")\ncounter.assert_count(2)\n\n# MetricsAgent: timing\nmetrics = MetricsAgent[str](label=\"Perf\")\nawait metrics.invoke(\"test\")\nprint(f\"Avg time: {metrics.metrics.avg_time:.6f}s\")\n</code></pre>"},{"location":"skills/test-patterns/#composition-in-tests","title":"Composition in Tests","text":"<pre><code># Pipeline: Counter &gt;&gt; Spy &gt;&gt; Agent Under Test\ncounter = CounterAgent[str](label=\"Calls\")\nspy = SpyAgent[str](label=\"Inputs\")\nagent = MyAgent()\n\npipeline = counter &gt;&gt; spy &gt;&gt; agent\n\nawait pipeline.invoke(\"test\")\n\ncounter.assert_count(1)\nspy.assert_captured(\"test\")\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-basic-test-file","title":"Step-by-Step: Basic Test File","text":""},{"location":"skills/test-patterns/#step-1-create-test-file","title":"Step 1: Create Test File","text":"<p>Location: <code>impl/claude/&lt;module&gt;/_tests/test_&lt;feature&gt;.py</code></p> <p>Template: <pre><code>\"\"\"\nTests for &lt;feature&gt;.\n\nTests verify:\n1. &lt;what is being tested&gt;\n2. &lt;another behavior&gt;\n3. &lt;edge cases&gt;\n\"\"\"\n\nfrom __future__ import annotations\n\nimport pytest\n\n\nclass TestFeatureBehavior:\n    \"\"\"Tests for &lt;specific behavior&gt;.\"\"\"\n\n    def test_basic_case(self) -&gt; None:\n        \"\"\"&lt;What this test verifies&gt;.\"\"\"\n        # Arrange\n        thing = MyClass()\n\n        # Act\n        result = thing.do_something()\n\n        # Assert\n        assert result == expected\n\n    def test_edge_case(self) -&gt; None:\n        \"\"\"&lt;Edge case description&gt;.\"\"\"\n        # Arrange\n        thing = MyClass()\n\n        # Act / Assert\n        with pytest.raises(ValueError):\n            thing.do_invalid()\n</code></pre></p>"},{"location":"skills/test-patterns/#step-2-import-from-sibling-module","title":"Step 2: Import from Sibling Module","text":"<p>Use relative imports for the module under test:</p> <pre><code># Relative import from parent\nfrom ..my_module import MyClass, my_function\n\n# Or absolute import\nfrom protocols.agentese.contexts.world import WorldNode\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-async-tests","title":"Step-by-Step: Async Tests","text":""},{"location":"skills/test-patterns/#step-1-mark-test-as-async","title":"Step 1: Mark Test as Async","text":"<pre><code>import pytest\n\nclass TestAsyncBehavior:\n    \"\"\"Tests for async methods.\"\"\"\n\n    @pytest.mark.asyncio\n    async def test_async_method(self) -&gt; None:\n        \"\"\"Test async invocation.\"\"\"\n        agent = MyAgent()\n\n        result = await agent.invoke(\"input\")\n\n        assert result == \"expected\"\n</code></pre>"},{"location":"skills/test-patterns/#step-2-async-fixtures","title":"Step 2: Async Fixtures","text":"<pre><code>@pytest.fixture\nasync def initialized_store() -&gt; Store:\n    \"\"\"Create and initialize a store.\"\"\"\n    store = Store()\n    await store.initialize()\n    yield store\n    await store.cleanup()  # Cleanup after test\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-using-mock-fixtures","title":"Step-by-Step: Using Mock Fixtures","text":""},{"location":"skills/test-patterns/#step-1-create-mockumwelt-common-pattern","title":"Step 1: Create MockUmwelt (Common Pattern)","text":"<pre><code>from typing import Any\n\nclass MockDNA:\n    \"\"\"Mock DNA for testing.\"\"\"\n\n    def __init__(\n        self,\n        name: str = \"test\",\n        archetype: str = \"default\",\n        capabilities: tuple[str, ...] = (),\n    ) -&gt; None:\n        self.name = name\n        self.archetype = archetype\n        self.capabilities = capabilities\n\n\nclass MockUmwelt:\n    \"\"\"Mock Umwelt for testing.\"\"\"\n\n    def __init__(\n        self,\n        archetype: str = \"default\",\n        name: str = \"test\",\n        capabilities: tuple[str, ...] = (),\n    ) -&gt; None:\n        self.dna = MockDNA(name=name, archetype=archetype, capabilities=capabilities)\n        self.gravity: tuple[Any, ...] = ()\n        self.context: dict[str, Any] = {}\n</code></pre>"},{"location":"skills/test-patterns/#step-2-use-type-safe-cast-helper","title":"Step 2: Use Type-Safe Cast Helper","text":"<p>The <code>testing</code> module provides <code>as_umwelt()</code> for type-safe casting:</p> <pre><code>from testing import as_umwelt\nfrom typing import Any\nfrom bootstrap.umwelt import Umwelt\n\n@pytest.fixture\ndef observer() -&gt; Umwelt[Any, Any]:\n    \"\"\"Default observer fixture.\"\"\"\n    return as_umwelt(MockUmwelt())\n\n@pytest.fixture\ndef admin_observer() -&gt; Umwelt[Any, Any]:\n    \"\"\"Admin observer fixture.\"\"\"\n    return as_umwelt(MockUmwelt(archetype=\"admin\"))\n</code></pre> <p>This avoids mypy errors when passing mock objects to functions expecting <code>Umwelt[A, B]</code>.</p>"},{"location":"skills/test-patterns/#step-3-use-in-tests","title":"Step 3: Use in Tests","text":"<pre><code>@pytest.mark.asyncio\nasync def test_manifest(observer: Umwelt[Any, Any]) -&gt; None:\n    \"\"\"Test manifest for default observer.\"\"\"\n    node = MyNode()\n\n    result = await node.manifest(observer)\n\n    assert result.summary == \"Expected\"\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-global-fixtures-conftestpy","title":"Step-by-Step: Global Fixtures (conftest.py)","text":""},{"location":"skills/test-patterns/#step-1-understand-fixture-hierarchy","title":"Step 1: Understand Fixture Hierarchy","text":"<pre><code>impl/claude/conftest.py         # Root fixtures (used by 3+ files)\nimpl/claude/agents/conftest.py  # Agent-specific fixtures\nimpl/claude/protocols/agentese/_tests/conftest.py  # Module fixtures\n</code></pre>"},{"location":"skills/test-patterns/#step-2-available-testing-utilities","title":"Step 2: Available Testing Utilities","text":"<p>From <code>impl/claude/testing/__init__.py</code>:</p> Utility Type Description <code>as_umwelt(obj)</code> <code>Umwelt[Any, Any]</code> Type-safe cast for mock Umwelts <code>as_agent(obj)</code> <code>Agent[A, B]</code> Type-safe cast for mock Agents <code>simple_agents()</code> Hypothesis strategy Generates deterministic test agents <code>agent_chains(min, max)</code> Hypothesis strategy Lists of composable agents <code>valid_dna()</code> Hypothesis strategy Valid DNA configurations <code>invalid_dna()</code> Hypothesis strategy Invalid DNA for constraint testing <code>type_names()</code> Hypothesis strategy Valid type name strings <p>Note: Root conftest.py focuses on test infrastructure (flinch logging, markers). Module-specific fixtures should be defined in local <code>_tests/conftest.py</code> files.</p>"},{"location":"skills/test-patterns/#step-3-create-local-fixtures","title":"Step 3: Create Local Fixtures","text":"<p>For module-specific fixtures, add to <code>_tests/conftest.py</code>:</p> <pre><code># impl/claude/agents/myagent/_tests/conftest.py\nimport pytest\nfrom ..agent import MyAgent\n\n@pytest.fixture\ndef my_agent() -&gt; MyAgent:\n    \"\"\"Pre-configured MyAgent for tests.\"\"\"\n    return MyAgent(config=MyConfig())\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-custom-markers","title":"Step-by-Step: Custom Markers","text":""},{"location":"skills/test-patterns/#step-1-available-markers","title":"Step 1: Available Markers","text":"Marker Purpose <code>@pytest.mark.law(name)</code> Category law verification <code>@pytest.mark.law_identity</code> Identity law: <code>Id &gt;&gt; f == f</code> <code>@pytest.mark.law_associativity</code> <code>(f &gt;&gt; g) &gt;&gt; h == f &gt;&gt; (g &gt;&gt; h)</code> <code>@pytest.mark.law_functor_identity</code> <code>fmap id == id</code> <code>@pytest.mark.law_functor_composition</code> <code>fmap (g.f) == fmap g . fmap f</code> <code>@pytest.mark.slow</code> Slow-running test <code>@pytest.mark.property</code> Property-based test <code>@pytest.mark.accursed_share</code> Exploratory/chaos test"},{"location":"skills/test-patterns/#step-2-use-markers","title":"Step 2: Use Markers","text":"<pre><code>import pytest\n\n@pytest.mark.law_identity\n@pytest.mark.asyncio\nasync def test_identity_law() -&gt; None:\n    \"\"\"Verify identity law: Id &gt;&gt; f == f == f &gt;&gt; Id.\"\"\"\n    from bootstrap import compose\n    from conftest import IdentityAgent\n\n    id_agent = IdentityAgent()\n    f = DoubleAgent()\n\n    input_val = 5\n    result1 = await compose(id_agent, f).invoke(input_val)\n    result2 = await f.invoke(input_val)\n    result3 = await compose(f, id_agent).invoke(input_val)\n\n    assert result1 == result2 == result3\n\n\n@pytest.mark.slow\ndef test_large_data_processing() -&gt; None:\n    \"\"\"Test with large dataset (takes &gt;5s).\"\"\"\n    ...\n</code></pre>"},{"location":"skills/test-patterns/#step-3-run-specific-markers","title":"Step 3: Run Specific Markers","text":"<pre><code># Run only law tests\nuv run pytest -m \"law\"\n\n# Exclude slow tests\nuv run pytest -m \"not slow\"\n\n# Run property-based tests\nuv run pytest -m \"property\"\n</code></pre>"},{"location":"skills/test-patterns/#step-by-step-property-based-testing-hypothesis","title":"Step-by-Step: Property-Based Testing (Hypothesis)","text":""},{"location":"skills/test-patterns/#step-1-import-strategies","title":"Step 1: Import Strategies","text":"<pre><code>from hypothesis import given, settings\nfrom testing import simple_agents, agent_chains, valid_dna\n</code></pre>"},{"location":"skills/test-patterns/#step-2-write-property-test","title":"Step 2: Write Property Test","text":"<pre><code>from hypothesis import given, settings\nfrom testing import simple_agents\n\n@pytest.mark.property\n@given(agent=simple_agents())\n@settings(max_examples=50)\n@pytest.mark.asyncio\nasync def test_agent_composition_associativity(agent) -&gt; None:\n    \"\"\"Composition is associative for all generated agents.\"\"\"\n    from conftest import IdentityAgent\n\n    id_agent = IdentityAgent()\n\n    # (id &gt;&gt; agent) == agent\n    composed = await compose(id_agent, agent).invoke(10)\n    direct = await agent.invoke(10)\n\n    assert composed == direct\n</code></pre>"},{"location":"skills/test-patterns/#step-3-available-strategies","title":"Step 3: Available Strategies","text":"<p>From <code>testing.strategies</code>:</p> Strategy Description <code>simple_agents()</code> Deterministic agents with offset <code>agent_chains(min_length, max_length)</code> Lists of composable agents <code>valid_dna()</code> Valid DNA configurations <code>invalid_dna()</code> Invalid DNA for constraint testing <code>type_names()</code> Valid type name strings <code>json_like_values()</code> JSON-compatible values <code>boundary_inputs()</code> Edge case inputs"},{"location":"skills/test-patterns/#step-by-step-mock-agent-pattern","title":"Step-by-Step: Mock Agent Pattern","text":""},{"location":"skills/test-patterns/#step-1-minimal-mock","title":"Step 1: Minimal Mock","text":"<pre><code>from dataclasses import dataclass\nfrom typing import Any\n\n@dataclass\nclass EchoAgent:\n    \"\"\"Returns input with prefix.\"\"\"\n    name: str = \"Echo\"\n\n    async def invoke(self, input: Any) -&gt; str:\n        return f\"Echo: {input}\"\n</code></pre>"},{"location":"skills/test-patterns/#step-2-composable-mock","title":"Step 2: Composable Mock","text":"<pre><code>from dataclasses import dataclass\nfrom typing import Any, cast\nfrom bootstrap.types import Agent\n\n@dataclass\nclass DoubleAgent:\n    \"\"\"Doubles numeric input.\"\"\"\n    name: str = \"Double\"\n\n    async def invoke(self, input: int) -&gt; int:\n        return input * 2\n\n    def __rshift__(self, other: Any) -&gt; Any:\n        from bootstrap import compose\n        return compose(cast(Agent[Any, Any], self), other)\n</code></pre>"},{"location":"skills/test-patterns/#step-3-configurable-mock","title":"Step 3: Configurable Mock","text":"<pre><code>@dataclass\nclass RecordingAgent:\n    \"\"\"Records all invocations for verification.\"\"\"\n    name: str = \"Recorder\"\n    calls: list[Any] = field(default_factory=list)\n\n    async def invoke(self, input: Any) -&gt; Any:\n        self.calls.append(input)\n        return input\n\n# In test:\ndef test_agent_called() -&gt; None:\n    recorder = RecordingAgent()\n    await my_function(recorder)\n    assert len(recorder.calls) == 3\n</code></pre>"},{"location":"skills/test-patterns/#verification","title":"Verification","text":""},{"location":"skills/test-patterns/#test-1-run-single-test-file","title":"Test 1: Run single test file","text":"<pre><code>cd impl/claude\nuv run pytest path/to/_tests/test_feature.py -v\n</code></pre>"},{"location":"skills/test-patterns/#test-2-run-with-coverage","title":"Test 2: Run with coverage","text":"<pre><code>uv run pytest path/to/_tests/ --cov=path/to --cov-report=term-missing\n</code></pre>"},{"location":"skills/test-patterns/#test-3-run-specific-test","title":"Test 3: Run specific test","text":"<pre><code>uv run pytest path/to/_tests/test_feature.py::TestClass::test_method -v\n</code></pre>"},{"location":"skills/test-patterns/#test-4-run-all-tests","title":"Test 4: Run all tests","text":"<pre><code>cd impl/claude\nuv run pytest\n</code></pre>"},{"location":"skills/test-patterns/#common-pitfalls","title":"Common Pitfalls","text":""},{"location":"skills/test-patterns/#1-missing-pytestmarkasyncio","title":"1. Missing <code>@pytest.mark.asyncio</code>","text":"<p>Symptom: <code>RuntimeWarning: coroutine 'test_foo' was never awaited</code></p> <p>Fix: Add the decorator: <pre><code>@pytest.mark.asyncio\nasync def test_async_method() -&gt; None:\n    ...\n</code></pre></p>"},{"location":"skills/test-patterns/#2-forgetting-to-cast-umwelt-mocks","title":"2. Forgetting to cast Umwelt mocks","text":"<p>Symptom: mypy errors about incompatible types</p> <p>Fix: Use <code>as_umwelt()</code>: <pre><code>from testing import as_umwelt\n\nobserver = as_umwelt(MockUmwelt())\n</code></pre></p>"},{"location":"skills/test-patterns/#3-not-awaiting-async-fixture","title":"3. Not awaiting async fixture","text":"<p>Symptom: Test passes but doesn't actually test anything</p> <p>Fix: Ensure async fixtures yield properly: <pre><code>@pytest.fixture\nasync def store() -&gt; AsyncIterator[Store]:\n    store = Store()\n    await store.initialize()\n    yield store\n    await store.cleanup()\n</code></pre></p>"},{"location":"skills/test-patterns/#4-import-path-issues","title":"4. Import path issues","text":"<p>Symptom: <code>ModuleNotFoundError</code></p> <p>Fix: Run tests from <code>impl/claude/</code> directory: <pre><code>cd impl/claude\nuv run pytest\n</code></pre></p>"},{"location":"skills/test-patterns/#5-test-isolation-failures","title":"5. Test isolation failures","text":"<p>Symptom: Tests pass individually but fail together</p> <p>Fix: Don't share mutable state between tests. Use fixtures with <code>function</code> scope (default): <pre><code>@pytest.fixture\ndef fresh_store() -&gt; Store:\n    return Store()  # New instance per test\n</code></pre></p>"},{"location":"skills/test-patterns/#5b-global-singletons-pytest-xdist-race-conditions","title":"5b. Global singletons + pytest-xdist race conditions","text":"<p>Symptom: Tests pass sequentially but fail with <code>pytest -n auto</code> (parallel)</p> <p>Context: Module-level singletons with factory injection (e.g., <code>_brain_logos</code>, <code>_brain_logos_factory</code>) work well for sequential tests but can race when parallel workers mutate the same globals.</p> <p>Options: 1. Document \u2014 Add warning in test docstring that parallel execution is unsafe 2. Isolate \u2014 Use <code>pytest.mark.no_parallel</code> or test grouping to run in single worker 3. Monkeypatch \u2014 Use <code>monkeypatch.setattr()</code> for per-test isolation (more verbose)</p> <pre><code># Option 1: Document in module docstring\n\"\"\"\nNote on test isolation:\n    Uses module-level globals. Safe for sequential runs, but pytest-xdist\n    parallel runs (-n auto) may cause race conditions.\n\"\"\"\n\n# Option 2: Marker (if you add custom marker)\n@pytest.mark.no_parallel\ndef test_with_global_singleton() -&gt; None:\n    ...\n</code></pre>"},{"location":"skills/test-patterns/#6-flaky-async-tests","title":"6. Flaky async tests","text":"<p>Symptom: Test intermittently fails</p> <p>Fix: - Use <code>asyncio.wait_for()</code> with timeout - Avoid <code>asyncio.sleep()</code> for synchronization - Use events/queues for coordination</p>"},{"location":"skills/test-patterns/#7-acceptable-uses-of-timesleep","title":"7. Acceptable uses of time.sleep()","text":"<p>While <code>time.sleep()</code> is generally an anti-pattern in tests, some cases require it:</p> <p>Valid uses: - Testing timing-sensitive behavior (debouncing, throttling, rate limiting) - Ensuring interleaving in concurrent/parallel tests - Waiting for background tasks that have no observable completion signal</p> <p>Guidelines: - Keep sleeps minimal (<code>&lt; 100ms</code> preferred) - Mark tests with <code>@pytest.mark.slow</code> if sleep exceeds 100ms - Add a comment explaining why the sleep is necessary - Consider if an event/queue pattern would work instead</p> <pre><code># Good: documented, minimal, marked\n@pytest.mark.slow\ndef test_debounce_fires_after_delay() -&gt; None:\n    \"\"\"Verify debounce waits the full delay before firing.\"\"\"\n    debouncer = Debouncer(delay_ms=50)\n    debouncer.trigger()\n    time.sleep(0.06)  # Wait for debounce window to close\n    assert debouncer.fired\n</code></pre>"},{"location":"skills/test-patterns/#test-organization-best-practices","title":"Test Organization Best Practices","text":"<ol> <li>One test class per behavior: Group related tests in classes</li> <li>Descriptive test names: <code>test_&lt;condition&gt;_&lt;expected_result&gt;</code></li> <li>Arrange-Act-Assert: Structure each test clearly</li> <li>Minimal fixtures: Only create what's needed</li> <li>Test one thing: Each test verifies one behavior</li> <li>Docstrings: Document what's being tested</li> </ol>"},{"location":"skills/test-patterns/#type-iv-judges-semantic-assertions","title":"Type IV: Judges (Semantic Assertions)","text":"<p>For LLM outputs where exact matching is impossible. Uses metamorphic relations.</p>"},{"location":"skills/test-patterns/#oracle-validation","title":"Oracle Validation","text":"<pre><code>from testing import Oracle, SubsetRelation, PermutationInvarianceRelation\n\nclass TestSemanticCorrectness:\n    \"\"\"Semantic validation for LLM outputs.\"\"\"\n\n    async def test_summary_contains_key_facts(self) -&gt; None:\n        \"\"\"Oracle validates semantic correctness.\"\"\"\n        oracle = Oracle()\n\n        relation = SubsetRelation(\n            base_extractor=extract_key_facts,\n            derived_extractor=extract_summary_facts,\n        )\n\n        document = \"...\"\n        summary = await summarizer.invoke(document)\n\n        result = await oracle.validate(\n            base_input=document,\n            derived_input=summary,\n            relation=relation,\n        )\n\n        assert result.passed, f\"Missing facts: {result.violations}\"\n</code></pre>"},{"location":"skills/test-patterns/#trustgate-for-agent-actions","title":"TrustGate for Agent Actions","text":"<pre><code>from agents.t import TrustGate, Proposal, create_trust_gate\n\ngate = create_trust_gate(\n    judgment_threshold=0.8,\n    risk_threshold=0.3,\n)\n\nproposal = Proposal(\n    agent=\"my-agent\",\n    action=\"modify database schema\",\n    diff=\"ALTER TABLE...\",\n    risk=0.4,\n)\n\ndecision = await gate.evaluate(proposal, agent=\"my-agent\")\n\nif decision.approved:\n    print(\"Approved\")\nelif decision.bypass_cost:\n    print(f\"Denied. Bypass cost: {decision.bypass_cost}\")\n</code></pre>"},{"location":"skills/test-patterns/#type-v-witnesses-integration","title":"Type V: Witnesses (Integration)","text":"<p>End-to-end tests verifying full system behavior.</p>"},{"location":"skills/test-patterns/#topologist-for-composition","title":"Topologist for Composition","text":"<pre><code>from testing import Topologist\n\nclass TestComposition:\n    async def test_associativity_under_noise(self) -&gt; None:\n        \"\"\"(f &gt;&gt; g) &gt;&gt; h == f &gt;&gt; (g &gt;&gt; h) even with noise.\"\"\"\n        topologist = Topologist()\n\n        report = await topologist.verify_associativity(\n            agents=[agent_a, agent_b, agent_c],\n            inputs=test_inputs,\n            noise_level=0.1,\n        )\n\n        assert report.passed\n</code></pre>"},{"location":"skills/test-patterns/#cortex-assurance-system","title":"Cortex Assurance System","text":"<pre><code>from testing import Cortex, create_enhanced_cortex\n\nclass TestSystem:\n    async def test_full_assurance(self) -&gt; None:\n        \"\"\"Full Cortex assurance system.\"\"\"\n        cortex = create_enhanced_cortex()\n\n        briefing = await cortex.run_briefing(\n            agents=[agent],\n            test_inputs=inputs,\n            budget_tier=\"quick\",\n        )\n\n        print(briefing.summary)\n        assert briefing.overall_health &gt;= 0.8\n</code></pre>"},{"location":"skills/test-patterns/#testing-module-exports","title":"Testing Module Exports","text":"<pre><code>from testing import (\n    # Fixtures\n    as_umwelt, as_agent,\n    # Strategies (Hypothesis)\n    simple_agents, agent_chains, valid_dna, invalid_dna, type_names,\n    # Oracle (Phase 8)\n    Oracle, MetamorphicRelation, SubsetRelation,\n    IdempotencyRelation, PermutationInvarianceRelation,\n    # Topologist\n    Topologist, TopologistReport, NoiseFunctor,\n    # Analyst\n    CausalAnalyst, WitnessStore, DeltaDebugResult,\n    # Market\n    TestMarket, BudgetManager, BudgetTier,\n    # Red Team\n    RedTeam, AdversarialInput, MutationScore,\n    # Cortex\n    Cortex, create_enhanced_cortex, BriefingReport,\n)\n</code></pre>"},{"location":"skills/test-patterns/#stress-testing-patterns","title":"Stress Testing Patterns","text":"<p>The Wave 1 stress tests demonstrate three key patterns for high-confidence reactive code.</p>"},{"location":"skills/test-patterns/#property-based-testing-hypothesis","title":"Property-Based Testing (Hypothesis)","text":"<p>Use Hypothesis to test invariants across many generated inputs:</p> <pre><code>from hypothesis import given, settings, strategies as st\nimport pytest\n\nfrom agents.i.reactive.signal import Signal, Snapshot\n\n@given(st.integers())\ndef test_snapshot_restore_roundtrip(value: int) -&gt; None:\n    \"\"\"Any value can be snapshot and restored.\"\"\"\n    sig = Signal.of(value)\n    snap = sig.snapshot()\n    sig.set(value + 1)\n    sig.restore(snap)\n    assert sig.value == value\n\n@given(st.lists(st.integers(min_value=-1000, max_value=1000), min_size=1, max_size=50))\ndef test_generation_monotonic(values: list[int]) -&gt; None:\n    \"\"\"Generation always increases on distinct value changes.\"\"\"\n    sig = Signal.of(values[0])\n    prev_gen = sig.generation\n    for v in values[1:]:\n        if v != sig.value:\n            sig.set(v)\n            assert sig.generation &gt; prev_gen\n            prev_gen = sig.generation\n\n@given(st.text(min_size=0, max_size=100))\ndef test_signal_text_values(text: str) -&gt; None:\n    \"\"\"Signal works with arbitrary text values.\"\"\"\n    sig = Signal.of(text)\n    snap = sig.snapshot()\n    sig.set(\"changed\")\n    sig.restore(snap)\n    assert sig.value == text\n</code></pre> <p>Key strategies: - <code>st.integers()</code> - arbitrary integers - <code>st.text()</code> - unicode strings - <code>st.floats(allow_nan=False)</code> - safe floats - <code>st.lists()</code> - lists of other strategies</p>"},{"location":"skills/test-patterns/#performance-baselines","title":"Performance Baselines","text":"<p>Set performance budgets that fail if violated:</p> <pre><code>import time\n\ndef test_signal_snapshot_performance() -&gt; None:\n    \"\"\"Signal snapshot/restore should be fast.\"\"\"\n    sig = Signal.of(0)\n\n    start = time.perf_counter()\n    for i in range(10000):\n        sig.set(i)\n        snap = sig.snapshot()\n        sig.restore(snap)\n    elapsed = time.perf_counter() - start\n\n    # Should complete 10000 cycles in under 1 second\n    assert elapsed &lt; 1.0, f\"Signal snapshot cycle too slow: {elapsed:.3f}s\"\n\ndef test_computed_recompute_performance() -&gt; None:\n    \"\"\"Computed recomputation should be fast.\"\"\"\n    sig = Signal.of(0)\n    computed = sig.map(lambda x: x * 2 + 1)\n\n    start = time.perf_counter()\n    for i in range(10000):\n        sig.set(i)\n        _ = computed.value\n    elapsed = time.perf_counter() - start\n\n    assert elapsed &lt; 1.0, f\"Computed recompute too slow: {elapsed:.3f}s\"\n\ndef test_subscriber_notification_performance() -&gt; None:\n    \"\"\"Subscriber notifications should be fast.\"\"\"\n    sig = Signal.of(-1)\n    count = [0]\n\n    for _ in range(10):\n        sig.subscribe(lambda v: count.__setitem__(0, count[0] + 1))\n\n    start = time.perf_counter()\n    for i in range(10000):\n        sig.set(i)\n    elapsed = time.perf_counter() - start\n\n    assert elapsed &lt; 1.0, f\"Subscriber notification too slow: {elapsed:.3f}s\"\n    assert count[0] == 100000  # 10 subscribers * 10000 updates\n</code></pre>"},{"location":"skills/test-patterns/#high-iteration-stress-tests","title":"High-Iteration Stress Tests","text":"<p>Test stability under load:</p> <pre><code>import random\n\ndef test_signal_1000_snapshots() -&gt; None:\n    \"\"\"Signal handles 1000 snapshots without degradation.\"\"\"\n    sig = Signal.of(0)\n    snapshots: list[Snapshot[int]] = []\n\n    for i in range(1000):\n        sig.set(i)\n        snapshots.append(sig.snapshot())\n\n    # Restore 100 random snapshots\n    sample = random.sample(snapshots, 100)\n    for snap in sample:\n        sig.restore(snap)\n        assert sig.value == snap.value\n\ndef test_signal_100_subscribers() -&gt; None:\n    \"\"\"Signal handles 100 concurrent subscribers.\"\"\"\n    sig = Signal.of(0)\n    results: list[list[int]] = [[] for _ in range(100)]\n\n    unsubs = []\n    for i in range(100):\n        idx = i\n        def callback(v: int, idx: int = idx) -&gt; None:\n            results[idx].append(v)\n        unsubs.append(sig.subscribe(callback))\n\n    for j in range(1, 51):\n        sig.set(j)\n\n    for r in results:\n        assert r == list(range(1, 51))\n\n    for unsub in unsubs:\n        unsub()\n\ndef test_modal_scope_deep_nesting() -&gt; None:\n    \"\"\"ModalScope handles 50-deep branch nesting.\"\"\"\n    from agents.d.modal_scope import ModalScope\n\n    root = ModalScope.create_root()\n    current = root\n\n    for i in range(50):\n        current = current.branch(f\"level-{i}\", budget=0.99)\n\n    assert current.depth == 50\n</code></pre>"},{"location":"skills/test-patterns/#boundary-value-tests","title":"Boundary Value Tests","text":"<p>Test edge cases explicitly:</p> <pre><code>@pytest.mark.parametrize(\"entropy\", [0.0, 0.5, 1.0, 0.001, 0.999])\ndef test_entropy_boundary_values(entropy: float) -&gt; None:\n    \"\"\"entropy_to_distortion handles boundary values.\"\"\"\n    from agents.i.reactive.entropy import entropy_to_distortion\n\n    distortion = entropy_to_distortion(entropy, seed=42, t=0.0)\n    assert isinstance(distortion.blur, float)\n    assert isinstance(distortion.skew, float)\n\ndef test_turn_empty_content() -&gt; None:\n    \"\"\"Turn handles empty content.\"\"\"\n    from protocols.api.turn import Turn\n\n    turn = Turn(speaker=\"test\", content=\"\", timestamp=0.0)\n    assert turn.to_cli() == \"[test]: \"\n\ndef test_turn_unicode_content() -&gt; None:\n    \"\"\"Turn handles unicode/emoji content.\"\"\"\n    from protocols.api.turn import Turn\n\n    turn = Turn(speaker=\"\ud83e\udd16\", content=\"Hello \u4e16\u754c! \ud83c\udf0d\", timestamp=0.0)\n    cli = turn.to_cli()\n    assert \"\ud83e\udd16\" in cli\n    assert \"\u4e16\u754c\" in cli\n</code></pre>"},{"location":"skills/test-patterns/#running-stress-tests","title":"Running Stress Tests","text":"<pre><code>cd impl/claude\n\n# Run all stress tests\nuv run pytest -k \"stress\" -v\n\n# Run property-based tests\nuv run pytest agents/i/reactive/_tests/test_wave1_stress.py -v\n\n# Run with verbose hypothesis output\nuv run pytest --hypothesis-show-statistics agents/i/reactive/_tests/test_wave1_stress.py\n</code></pre>"},{"location":"skills/test-patterns/#react-component-testing-chaos-performance","title":"React Component Testing: Chaos &amp; Performance","text":"<p>For React components (especially layout systems), we use specialized testing patterns to ensure stability under rapid state changes.</p>"},{"location":"skills/test-patterns/#chaos-testing-random-state-changes","title":"Chaos Testing (Random State Changes)","text":"<p>Test component stability under rapid, random mutations:</p> <pre><code>import { render, screen, act } from '@testing-library/react';\nimport { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';\nimport { useState, useEffect } from 'react';\n\ndescribe('Chaos Tests: Random Widget Show/Hide', () =&gt; {\n  beforeEach(() =&gt; {\n    vi.useFakeTimers({ shouldAdvanceTime: true });\n    // Mock ResizeObserver for layout components\n    const MockResizeObserver = vi.fn().mockImplementation((callback) =&gt; ({\n      observe: vi.fn(() =&gt; callback([{ contentRect: { width: 800, height: 600 } }])),\n      unobserve: vi.fn(),\n      disconnect: vi.fn(),\n    }));\n    window.ResizeObserver = MockResizeObserver as unknown as typeof ResizeObserver;\n  });\n\n  afterEach(() =&gt; {\n    vi.useRealTimers();\n    vi.restoreAllMocks();\n  });\n\n  it('should handle mixed add/remove at 10+ changes per second', async () =&gt; {\n    function RapidChaosWrapper() {\n      const [items, setItems] = useState&lt;string[]&gt;(['a', 'b', 'c']);\n\n      useEffect(() =&gt; {\n        const interval = setInterval(() =&gt; {\n          setItems((prev) =&gt; {\n            const action = Math.random();\n            if (action &lt; 0.4 &amp;&amp; prev.length &gt; 2) {\n              // Remove random\n              const idx = Math.floor(Math.random() * prev.length);\n              return prev.filter((_, i) =&gt; i !== idx);\n            } else if (action &lt; 0.8) {\n              // Add new\n              return [...prev, `new-${Date.now()}`];\n            }\n            return [...prev].sort(() =&gt; Math.random() - 0.5); // Shuffle\n          });\n        }, 50); // 20 changes per second\n        return () =&gt; clearInterval(interval);\n      }, []);\n\n      return &lt;MyComponent items={items} /&gt;;\n    }\n\n    render(&lt;RapidChaosWrapper /&gt;);\n\n    // Run for 3 seconds of simulated time (60 changes)\n    await act(async () =&gt; {\n      for (let i = 0; i &lt; 60; i++) {\n        vi.advanceTimersByTime(50);\n      }\n    });\n\n    // Component should still be functional\n    expect(screen.getByTestId('my-component')).toBeInTheDocument();\n  });\n});\n</code></pre> <p>Key Techniques: - Use <code>vi.useFakeTimers({ shouldAdvanceTime: true })</code> for controlled time - Mock <code>ResizeObserver</code> for layout-aware components - Test add/remove/shuffle combinations - Verify component doesn't crash after many mutations</p>"},{"location":"skills/test-patterns/#performance-baseline-testing","title":"Performance Baseline Testing","text":"<p>Set performance budgets that fail if violated:</p> <pre><code>function measureRenderTime(\n  renderFn: () =&gt; void\n): { duration: number } {\n  const start = performance.now();\n  renderFn();\n  return { duration: performance.now() - start };\n}\n\ndescribe('Performance: Initial Render', () =&gt; {\n  it('should render 100 items in &lt;500ms', () =&gt; {\n    const items = Array.from({ length: 100 }, (_, i) =&gt; ({ id: `item-${i}` }));\n\n    const { duration } = measureRenderTime(() =&gt;\n      render(\n        &lt;GridContainer&gt;\n          {items.map((item) =&gt; &lt;Card key={item.id} {...item} /&gt;)}\n        &lt;/GridContainer&gt;\n      )\n    );\n\n    console.log(`100 items initial render: ${duration.toFixed(2)}ms`);\n    expect(duration).toBeLessThan(5000); // jsdom is slower; real target is 500ms\n  });\n\n  it('should scale linearly with item count', () =&gt; {\n    const counts = [10, 25, 50, 100];\n    const durations: number[] = [];\n\n    counts.forEach((count) =&gt; {\n      const items = Array.from({ length: count }, (_, i) =&gt; ({ id: `item-${i}` }));\n      const { duration } = measureRenderTime(() =&gt;\n        render(&lt;GridContainer&gt;{items.map((item) =&gt; &lt;Card key={item.id} {...item} /&gt;)}&lt;/GridContainer&gt;)\n      );\n      durations.push(duration);\n    });\n\n    // Verify roughly linear scaling (100 items should be ~10x 10 items)\n    const ratio = durations[3] / durations[0];\n    expect(ratio).toBeLessThan(20); // Allow some overhead\n  });\n});\n</code></pre>"},{"location":"skills/test-patterns/#memory-leak-testing","title":"Memory Leak Testing","text":"<p>Verify cleanup on unmount:</p> <pre><code>it('should not leak event listeners during resize stress', async () =&gt; {\n  let resizeObserverCalls = 0;\n\n  function ResizeStressWrapper() {\n    const [width, setWidth] = useState(1280);\n\n    useEffect(() =&gt; {\n      const interval = setInterval(() =&gt; {\n        setWidth(400 + Math.floor(Math.random() * 800));\n        resizeObserverCalls++;\n      }, 50);\n      return () =&gt; clearInterval(interval);\n    }, []);\n\n    return &lt;ResponsiveComponent style={{ width }} /&gt;;\n  }\n\n  const { unmount } = render(&lt;ResizeStressWrapper /&gt;);\n\n  await act(async () =&gt; {\n    for (let i = 0; i &lt; 100; i++) {\n      vi.advanceTimersByTime(50);\n    }\n  });\n\n  unmount();\n  expect(resizeObserverCalls).toBeGreaterThan(90);\n});\n</code></pre>"},{"location":"skills/test-patterns/#visual-regression-testing-playwright","title":"Visual Regression Testing (Playwright)","text":"<p>Test responsive breakpoints with screenshots:</p> <pre><code>import { test, expect } from '@playwright/test';\n\nconst BREAKPOINTS = {\n  mobile_small: { width: 320, height: 568 },\n  mobile: { width: 640, height: 1136 },\n  tablet: { width: 768, height: 1024 },\n  desktop: { width: 1024, height: 768 },\n  desktop_large: { width: 1280, height: 800 },\n};\n\ntest.describe('Responsive Layout', () =&gt; {\n  test('should collapse at 768px threshold', async ({ page }) =&gt; {\n    await page.setViewportSize(BREAKPOINTS.desktop);\n    await page.goto('/my-page');\n\n    // Should be side-by-side\n    const splitContainer = page.locator('[data-direction=\"horizontal\"]');\n    await expect(splitContainer).toBeVisible();\n\n    // Resize below threshold\n    await page.setViewportSize({ width: 767, height: 1024 });\n    await page.waitForTimeout(100); // Allow resize observer\n\n    // Should be collapsed\n    const collapsed = page.locator('[data-collapsed=\"true\"]');\n    await expect(collapsed).toBeVisible();\n\n    await expect(page).toHaveScreenshot('collapsed-layout.png', {\n      maxDiffPixelRatio: 0.02,\n    });\n  });\n\n  test('should transition smoothly between breakpoints', async ({ page }) =&gt; {\n    await page.setViewportSize(BREAKPOINTS.desktop_large);\n    await page.goto('/my-page');\n\n    for (const size of [1024, 768, 640, 320]) {\n      await page.setViewportSize({ width: size, height: 800 });\n      await page.waitForTimeout(150);\n\n      // Verify no overflow\n      const overflows = await page.evaluate(() =&gt; {\n        const elements = document.querySelectorAll('[data-testid=\"card\"]');\n        let hasOverflow = false;\n        elements.forEach((el) =&gt; {\n          const rect = el.getBoundingClientRect();\n          if (rect.right &gt; window.innerWidth) hasOverflow = true;\n        });\n        return hasOverflow;\n      });\n\n      expect(overflows).toBe(false);\n    }\n  });\n});\n</code></pre>"},{"location":"skills/test-patterns/#running-react-tests","title":"Running React Tests","text":"<pre><code>cd impl/claude/web\n\n# Unit tests (vitest)\nnpm run test                          # All tests\nnpm run test -- --watch               # Watch mode\nnpm run test -- tests/unit/elastic/   # Specific directory\n\n# E2E tests (playwright)\nnpm run test:e2e                      # All E2E\nnpm run test:e2e -- --ui              # Interactive UI\nnpm run test:e2e -- e2e/elastic/      # Specific directory\nnpm run test:e2e -- --update-snapshots # Update screenshots\n</code></pre>"},{"location":"skills/test-patterns/#related-skills","title":"Related Skills","text":"<ul> <li>building-agent - Creating well-formed agents</li> <li>flux-agent - Testing async streaming agents</li> <li>handler-patterns - Testing CLI handlers</li> <li>agent-observability - Metrics and debugging</li> <li>reactive-primitives - Signal/Computed/Effect</li> <li>modal-scope-branching - Context branching</li> </ul>"},{"location":"skills/test-patterns/#changelog","title":"Changelog","text":"<ul> <li>2025-12-16: Added React chaos/performance testing patterns (vitest + playwright)</li> <li>2025-12-16: Added global singletons + pytest-xdist race condition pitfall</li> <li>2025-12-14: Added stress testing patterns (property-based, performance baselines, boundary tests)</li> <li>2025-12-12: Added T-gent Types I-V taxonomy, T-gent test agents, Oracle, Cortex patterns</li> <li>2025-12-12: Initial version based on conftest.py and testing patterns</li> </ul>"}]}