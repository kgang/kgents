# Compiled: Spec → Impl Scaffolding

> *"The Compile functor transforms SpecCat → ImplCat."*

This directory contains **generated implementation scaffolding** from YAML-frontmatter specifications.

---

## Discovery Mode (Recommended)

The **Discovery Mode** (Option C) is the recommended workflow. Instead of regenerating everything, it:
1. Discovers what SHOULD exist according to specs
2. Audits what DOES exist in impl
3. Generates stubs only for MISSING components

```python
from protocols.agentese.specgraph import (
    full_audit,
    generate_stubs,
    print_audit_report,
)
from pathlib import Path

# Audit spec vs impl alignment
spec_root = Path("spec/")
impl_root = Path("impl/claude/")
discovery, audit = full_audit(spec_root, impl_root)

# See what's missing
print(print_audit_report(audit))

# Generate stubs for gaps (dry_run=True to preview)
if audit.has_gaps:
    result = generate_stubs(audit.gaps, impl_root, dry_run=False)
    print(f"Generated {len(result.files_generated)} files")
```

The autopoietic invariant:
```
audit_impl(impl/, discover_from_spec(spec/)) = no_gaps
```

---

## Full Regeneration (Legacy)

For full regeneration of a spec (overwrites existing files):

```bash
# Generate compiled output for a spec
kg self.system.compile spec_path=spec/town/operad.md dry_run=false

# Or programmatically:
from protocols.agentese.specgraph import parse_spec_file, compile_spec
node = parse_spec_file(Path("spec/town/operad.md"))
result = compile_spec(node, Path("compiled/"), dry_run=False)
```

### Input Format (YAML Frontmatter)

```yaml
---
domain: world           # AGENTESE context: world, self, concept, void, time
holon: town             # Unique identifier within domain
polynomial:
  positions: [idle, working, resting]
  transition: town_transition
operad:
  operations:
    greet: { arity: 2, signature: "A × B → C" }
  laws:
    locality: "interact(a, b) implies same_region(a, b)"
agentese:
  path: world.town
  aspects: [manifest, witness]
---
```

### Output Structure

```
compiled/<domain>/<holon>/
├── polynomial.py    # PolyAgent state machine
├── operad.py        # Operad grammar with operations and laws
└── node.py          # AGENTESE @node with aspects
```

---

## How It's Maintained

### Regeneration

This directory is **regenerable** from specs. To regenerate all:

```bash
# Regenerate all compiled outputs
for spec in spec/**/*.md; do
  kg self.system.compile spec_path="$spec" dry_run=false
done
```

### Versioning

- **DO commit** generated files (they serve as reference implementations)
- **DO NOT** manually edit generated files (changes will be overwritten)
- **DO** update the source spec and regenerate

### CI Gate

The autopoietic CI gate verifies:
1. All specs with frontmatter have corresponding compiled outputs
2. Compiled outputs match regeneration (no drift)

---

## How It's Utilized

### 1. Bootstrap New Agents

Use compiled scaffolding as a starting point for new agent implementations:

```bash
# Generate scaffolding for new agent
kg self.system.compile spec_path=spec/new-agent/spec.md
cp -r compiled/world/new-agent/ impl/claude/agents/new-agent/
# Then customize the TODOs in the generated files
```

### 2. Verify Spec-Impl Alignment

Compare compiled vs actual impl to detect drift:

```bash
# Check if impl matches what spec would generate
diff -r compiled/world/town/ impl/claude/agents/town/
```

### 3. Reference Implementation

The compiled output serves as the "canonical" structure. When in doubt about how to structure an agent, check the compiled reference.

---

## Directory Structure

```
compiled/
├── README.md                 # This file
├── world/                    # world.* agents
│   ├── town/                 # Agent Town
│   │   ├── polynomial.py
│   │   ├── operad.py
│   │   └── node.py
│   ├── atelier/              # Atelier Experience
│   ├── park/                 # Punchdrunk Park
│   └── codebase/             # Gestalt (world.codebase)
├── self/                     # self.* agents
│   ├── memory/               # Brain (self.memory)
│   └── chat/                 # Flow (self.chat)
└── concept/                  # concept.* agents
    ├── gardener/             # Gardener
    └── design/               # Design Language System
```

---

## The Autopoiesis Invariant

A healthy system satisfies:

```
Reflect(impl/) ≅ spec/*.md ≅ Compile(spec/*.md)
```

If compiled output differs from impl:
- Either impl has drifted (update impl to match)
- Or spec is outdated (update spec and regenerate)

---

*Generated by SpecGraph Compile Functor | Reference: plans/autopoietic-architecture.md*
