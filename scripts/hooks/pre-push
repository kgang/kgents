#!/usr/bin/env bash
#
# kgents pre-push hook (HEAVY)
#
# Philosophy: Gate pushes with rigorous verification.
# This is the last line of defense before CI.
#
# Checks:
#   1. Ruff lint (strict, blocking)
#   2. Mypy (strict, blocking)
#   3. Unit tests (fast, blocking)
#   4. Category laws (blocking)
#   5. Integration tests (full suite, blocking)
#
# Optional (can skip with KGENTS_SKIP_HEAVY=1):
#   - Property tests
#   - Chaos tests (accursed share)
#

# Note: We intentionally don't use `set -e` because we handle exit codes manually
# with FAILED variable tracking. `set -e` would exit prematurely on non-blocking checks.

# Source library (resolve symlinks to find actual script location)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")" && pwd)"
source "$SCRIPT_DIR/lib.sh"

REPO_ROOT=$(get_repo_root)
cd "$REPO_ROOT"

# Parse push info
REMOTE="$1"
URL="$2"

echo -e "${BOLD}pre-push${NC} ${CYAN}(heavy verification before push to ${REMOTE})${NC}"
echo ""

# Check for skip flag
if [ "${KGENTS_SKIP_HEAVY:-0}" = "1" ]; then
    warn "KGENTS_SKIP_HEAVY=1 detected. Skipping heavy tests."
    warn "Use with caution - CI will still run these tests."
    exit 0
fi

# Check dependencies
require_uv

TOTAL_STEPS=5
FAILED=0

# =============================================================================
# Step 1: Lint (strict - non-blocking until codebase is clean)
# =============================================================================
section "Ruff lint (strict)" 1 $TOTAL_STEPS

cd "$REPO_ROOT/impl/claude"
LINT_OUTPUT=$(uv run ruff check agents/ bootstrap/ runtime/ protocols/ testing/ 2>&1)
LINT_EXIT=$?
if [ $LINT_EXIT -eq 0 ]; then
    success "Lint passed"
else
    # Count issues instead of showing all output
    LINT_COUNT=$(echo "$LINT_OUTPUT" | grep -c "^[A-Z][0-9]" || echo "0")
    warn "Lint: $LINT_COUNT issues (non-blocking, run 'ruff check' for details)"
fi
cd "$REPO_ROOT"
echo ""

# =============================================================================
# Step 2: Type check (strict)
# =============================================================================
section "Mypy (strict)" 2 $TOTAL_STEPS

cd "$REPO_ROOT/impl/claude"
MYPY_OUTPUT=$(uv run mypy --strict --explicit-package-bases agents/ bootstrap/ runtime/ 2>&1)
MYPY_EXIT=$?
if [ $MYPY_EXIT -eq 0 ]; then
    success "Type check passed"
else
    # Count errors instead of showing all output
    MYPY_COUNT=$(echo "$MYPY_OUTPUT" | grep -c ": error:" || echo "0")
    warn "Mypy: $MYPY_COUNT errors (non-blocking, run 'mypy' for details)"
fi
cd "$REPO_ROOT"
echo ""

# =============================================================================
# Step 3: Unit tests (fast)
# =============================================================================
section "Unit tests (not slow, not integration)" 3 $TOTAL_STEPS

cd "$REPO_ROOT/impl/claude"
TEST_OUTPUT=$(uv run pytest -m "not slow and not integration" --tb=no -q 2>&1)
TEST_EXIT=$?
if [ $TEST_EXIT -eq 0 ]; then
    # Extract summary line (e.g., "5765 passed in 12.34s")
    SUMMARY=$(echo "$TEST_OUTPUT" | tail -1)
    success "Unit tests: $SUMMARY"
else
    # Show last few lines on failure
    SUMMARY=$(echo "$TEST_OUTPUT" | tail -3)
    error "Unit tests failed:"
    echo "$SUMMARY"
    FAILED=1
fi
cd "$REPO_ROOT"
echo ""

# =============================================================================
# Step 4: Category laws
# =============================================================================
section "Category law verification" 4 $TOTAL_STEPS

cd "$REPO_ROOT/impl/claude"
LAW_OUTPUT=$(uv run pytest -m "law" --tb=no -q 2>&1)
LAW_EXIT=$?
if [ $LAW_EXIT -eq 0 ]; then
    SUMMARY=$(echo "$LAW_OUTPUT" | tail -1)
    success "Category laws: $SUMMARY"
elif [ $LAW_EXIT -eq 5 ]; then
    info "No law tests found"
else
    SUMMARY=$(echo "$LAW_OUTPUT" | tail -3)
    error "Category law violations:"
    echo "$SUMMARY"
    FAILED=1
fi
cd "$REPO_ROOT"
echo ""

# =============================================================================
# Step 5: Integration tests
# =============================================================================
section "Integration tests" 5 $TOTAL_STEPS

cd "$REPO_ROOT/impl/claude"
INT_OUTPUT=$(uv run pytest -m "integration" --tb=no -q 2>&1)
INT_EXIT=$?
if [ $INT_EXIT -eq 0 ]; then
    SUMMARY=$(echo "$INT_OUTPUT" | tail -1)
    success "Integration tests: $SUMMARY"
elif [ $INT_EXIT -eq 5 ]; then
    info "No integration tests found"
else
    SUMMARY=$(echo "$INT_OUTPUT" | tail -3)
    error "Integration tests failed:"
    echo "$SUMMARY"
    FAILED=1
fi
cd "$REPO_ROOT"
echo ""

# =============================================================================
# Optional: Property tests (if not skipped)
# =============================================================================
if [ "${KGENTS_SKIP_PROPERTY:-0}" != "1" ]; then
    info "Running property tests..."
    cd "$REPO_ROOT/impl/claude"
    PROP_OUTPUT=$(uv run pytest -m "property" --tb=no -q 2>&1)
    PROP_EXIT=$?
    if [ $PROP_EXIT -eq 0 ]; then
        SUMMARY=$(echo "$PROP_OUTPUT" | tail -1)
        success "Property tests: $SUMMARY"
    elif [ $PROP_EXIT -eq 5 ]; then
        info "No property tests found"
    else
        warn "Property tests failed (non-blocking)"
    fi
    cd "$REPO_ROOT"
    echo ""
fi

# =============================================================================
# Chaos tests (accursed share) - run by default, skip with KGENTS_SKIP_CHAOS=1
# =============================================================================
if [ "${KGENTS_SKIP_CHAOS:-0}" != "1" ]; then
    info "Running chaos tests (accursed share)..."
    cd "$REPO_ROOT/impl/claude"
    CHAOS_OUTPUT=$(uv run pytest -m "accursed_share" --tb=no -q 2>&1)
    CHAOS_EXIT=$?
    if [ $CHAOS_EXIT -eq 0 ]; then
        SUMMARY=$(echo "$CHAOS_OUTPUT" | tail -1)
        success "Chaos tests: $SUMMARY"
    elif [ $CHAOS_EXIT -eq 5 ]; then
        info "No chaos tests found"
    else
        info "Chaos tests discovered issues (expected, non-blocking)"
    fi
    cd "$REPO_ROOT"
    echo ""
fi

# =============================================================================
# Summary
# =============================================================================
hr
if [ $FAILED -eq 0 ]; then
    success "pre-push complete. All checks passed."
    hr
    exit 0
else
    error "pre-push FAILED. Fix issues before pushing."
    echo ""
    info "To bypass (not recommended):"
    info "  KGENTS_SKIP_HEAVY=1 git push"
    hr
    exit 1
fi
