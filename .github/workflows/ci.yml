name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# =============================================================================
# Meta-Bootstrap: CI emits semantic field signals
# Signals are written to .kgents/ghost/ci_signals.jsonl
# This closes the cross-session feedback loop
# =============================================================================

jobs:
  # ===========================================================================
  # Tier 1: Fast checks (< 1 min)
  # Mirrors pre-commit hook
  # ===========================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: cd impl/claude && uv sync --dev

      - name: Ruff format check
        run: cd impl/claude && uv run ruff format --check .

      - name: Ruff lint
        run: cd impl/claude && uv run ruff check .

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: cd impl/claude && uv sync --dev

      - name: Mypy (strict)
        run: |
          cd impl/claude
          uv run mypy --strict --explicit-package-bases agents/ bootstrap/ runtime/
        # Fully strict - zero tolerance for type errors!

  typecheck-frontend:
    name: Type Check (Frontend)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: impl/claude/web/package-lock.json

      - name: Install dependencies
        run: cd impl/claude/web && npm ci

      - name: TypeScript check
        run: cd impl/claude/web && npm run typecheck
        # Strict TypeScript - catches prop mismatches like currentPath vs currentRoute

  # ===========================================================================
  # Tier 1.5: Contract sync check (< 1 min)
  # Ensures BE/FE AGENTESE contracts stay in sync
  # ===========================================================================
  contract-sync:
    name: Contract Sync
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: impl/claude/web/package-lock.json

      - name: Install Python dependencies
        run: cd impl/claude && uv sync --dev

      - name: Install FE dependencies
        run: cd impl/claude/web && npm ci

      - name: Start backend
        run: |
          cd impl/claude
          uv run uvicorn protocols.api.app:create_app --factory --port 8000 &
          sleep 5  # Wait for server to start

      - name: Check contract sync
        run: |
          cd impl/claude/web
          npm run sync-types:check
        env:
          VITE_API_URL: http://localhost:8000

  # ===========================================================================
  # Tier 1.6: AGENTESE path alignment (< 1 min)
  # Ensures frontend AGENTESE paths match backend @node registry
  # ===========================================================================
  path-alignment:
    name: Path Alignment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: cd impl/claude && uv sync --dev

      - name: Validate AGENTESE path alignment
        run: cd impl/claude && uv run python scripts/validate_path_alignment.py

  # ===========================================================================
  # Tier 2: Unit tests (1-3 min)
  # Mirrors pre-push hook
  # ===========================================================================
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [lint]
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: cd impl/claude && uv sync --dev

      - name: Run unit tests
        run: |
          cd impl/claude
          uv run pytest -m "not slow and not integration" --tb=short -q

  # ===========================================================================
  # Tier 3: Law verification (1-2 min)
  # Category laws are non-negotiable
  # ===========================================================================
  laws:
    name: Category Laws
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: cd impl/claude && uv sync --dev

      - name: Verify category laws
        run: |
          cd impl/claude
          uv run pytest -m "law" --tb=short -q

      - name: Run BootstrapWitness
        run: |
          cd impl/claude
          uv run pytest --witness -m "law" --tb=short

  # ===========================================================================
  # Tier 4: Integration tests (3-5 min)
  # Cross-agent integration verification
  # ===========================================================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, laws]
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: cd impl/claude && uv sync --dev

      - name: Run integration tests
        run: |
          cd impl/claude
          uv run pytest -m "integration" --tb=short -q

  # ===========================================================================
  # Tier 5: Property tests (2-5 min)
  # Hypothesis-based property verification
  # ===========================================================================
  property:
    name: Property Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: cd impl/claude && uv sync --dev

      - name: Run property tests
        run: |
          cd impl/claude
          uv run pytest -m "property" --tb=short -q

  # ===========================================================================
  # Tier 6: Coverage (3-5 min)
  # Full test coverage report
  # ===========================================================================
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          cd impl/claude
          uv sync --dev
          uv pip install pytest-cov

      - name: Run tests with coverage
        run: |
          cd impl/claude
          uv run pytest --cov=agents --cov=bootstrap --cov=runtime \
            --cov-report=term-missing --cov-report=xml \
            -m "not slow"

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./impl/claude/coverage.xml
          fail_ci_if_error: false

  # ===========================================================================
  # Tier 7: Slow tests (5+ min, nightly or manual)
  # ===========================================================================
  slow:
    name: Slow Tests
    runs-on: ubuntu-latest
    needs: [integration]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: cd impl/claude && uv sync --dev

      - name: Run slow tests
        run: |
          cd impl/claude
          uv run pytest -m "slow" --tb=short -q

  # ===========================================================================
  # Tier 8: Chaos tests (exploratory, non-blocking)
  # ===========================================================================
  chaos:
    name: Chaos Tests (Accursed Share)
    runs-on: ubuntu-latest
    needs: [integration]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    continue-on-error: true  # Chaos tests may fail - that's discovery
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: cd impl/claude && uv sync --dev

      - name: Run chaos tests
        run: |
          cd impl/claude
          uv run pytest -m "accursed_share" --tb=short -q

  # ===========================================================================
  # Meta-Bootstrap: Emit CI signals
  # Runs after all tests to emit success/failure signals
  # ===========================================================================
  emit-signal:
    name: Emit CI Signal
    runs-on: ubuntu-latest
    needs: [unit-tests, laws, integration]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Emit success signal
        if: needs.unit-tests.result == 'success' && needs.laws.result == 'success'
        run: |
          mkdir -p .kgents/ghost
          echo "{\"ts\": $(date +%s), \"type\": \"CI_SUCCESS\", \"sha\": \"${{ github.sha }}\", \"ref\": \"${{ github.ref }}\", \"tests\": \"unit,laws,integration\"}" >> .kgents/ghost/ci_signals.jsonl
          echo "CI Signal: SUCCESS emitted"

      - name: Emit failure signal
        if: needs.unit-tests.result == 'failure' || needs.laws.result == 'failure' || needs.integration.result == 'failure'
        run: |
          mkdir -p .kgents/ghost
          FAILED=""
          [ "${{ needs.unit-tests.result }}" == "failure" ] && FAILED="${FAILED}unit,"
          [ "${{ needs.laws.result }}" == "failure" ] && FAILED="${FAILED}laws,"
          [ "${{ needs.integration.result }}" == "failure" ] && FAILED="${FAILED}integration,"
          echo "{\"ts\": $(date +%s), \"type\": \"CI_FAILURE\", \"sha\": \"${{ github.sha }}\", \"ref\": \"${{ github.ref }}\", \"failed\": \"${FAILED%,}\"}" >> .kgents/ghost/ci_signals.jsonl
          echo "CI Signal: FAILURE emitted (${FAILED%,})"

      - name: Upload signal artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-signals
          path: .kgents/ghost/ci_signals.jsonl
          retention-days: 30
